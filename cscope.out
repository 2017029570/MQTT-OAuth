cscope 15 $HOME/mosquitto -q 0000003963 0001239417
	@client/client_props.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 #i‚de‡
WIN32


25 
	~<uni°d.h
>

26 
	~<°rögs.h
>

28 
	~<¥o˚ss.h
>

29 
	~<wösock2.h
>

30 
	#¢¥ötf
 
•rötf_s


	)

31 
	#°∫ˇ£cmp
 
_°∫icmp


	)

34 
	~"mosquôto.h
"

35 
	~"mqâ_¥Ÿocﬁ.h
"

36 
	~"˛õ¡_sh¨ed.h
"

38 
	e¥›_ty≥


40 
	mPROP_TYPE_BYTE
,

41 
	mPROP_TYPE_INT16
,

42 
	mPROP_TYPE_INT32
,

43 
	mPROP_TYPE_BINARY
,

44 
	mPROP_TYPE_STRING
,

45 
	mPROP_TYPE_STRING_PAIR


61 
	$cfg_∑r£_¥›îty
(
mosq_c⁄fig
 *
cfg
, 
¨gc
, *
¨gv
[], *
idx
)

63 *
cmd«me
 = 
NULL
, *
¥›«me
 = NULL;

64 *
key
 = 
NULL
, *
vÆue
 = NULL;

65 
cmd
, 
idítifõr
, 
ty≥
;

66 
mosquôto_¥›îty
 **
¥›li°
;

67 
rc
;

70 if((*
idx
)+2 > 
¨gc
-1){

72 
	`Ârötf
(
°dîr
, "Error: --propertyárgument given butÇotÉnoughárguments specified.\n\n");

73  
MOSQ_ERR_INVAL
;

76 
cmd«me
 = 
¨gv
[*
idx
];

77 if(
	`mosquôto_°rög_to_comm™d
(
cmd«me
, &
cmd
)){

78 
	`Ârötf
(
°dîr
, "Error: Invalid command given in --propertyárgument.\n\n");

79  
MOSQ_ERR_INVAL
;

82 
¥›«me
 = 
¨gv
[(*
idx
)+1];

83 if(
	`mosquôto_°rög_to_¥›îty_öfo
(
¥›«me
, &
idítifõr
, &
ty≥
)){

84 
	`Ârötf
(
°dîr
, "Error: InvalidÖropertyÇame given in --propertyárgument.\n\n");

85  
MOSQ_ERR_INVAL
;

88 if(
	`mosquôto_¥›îty_check_comm™d
(
cmd
, 
idítifõr
)){

89 
	`Ârötf
(
°dîr
, "Eº‹: %†¥›îtyÇŸáŒow f‹ %†ö --¥›îtyárgumít.\n\n", 
¥›«me
, 
cmd«me
);

90  
MOSQ_ERR_INVAL
;

93 if(
idítifõr
 =
MQTT_PROP_USER_PROPERTY
){

94 if((*
idx
)+3 > 
¨gc
-1){

96 
	`Ârötf
(
°dîr
, "Error: --propertyárgument given butÇotÉnoughárguments specified.\n\n");

97  
MOSQ_ERR_INVAL
;

100 
key
 = 
¨gv
[(*
idx
)+2];

101 
vÆue
 = 
¨gv
[(*
idx
)+3];

102 (*
idx
) += 3;

104 
vÆue
 = 
¨gv
[(*
idx
)+2];

105 (*
idx
) += 2;

109 
cmd
){

110 
CMD_CONNECT
:

111 
¥›li°
 = &
cfg
->
c⁄√˘_¥›s
;

114 
CMD_PUBLISH
:

115 if(
idítifõr
 =
MQTT_PROP_TOPIC_ALIAS
){

116 
cfg
->
have_t›ic_Æüs
 = 
åue
;

118 if(
idítifõr
 =
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
){

119 
	`Ârötf
(
°dîr
, "Eº‹: %†¥›îtyÇŸ suµ‹ãd f‹ %†ö --¥›îtyárgumít.\n\n", 
¥›«me
, 
cmd«me
);

120  
MOSQ_ERR_INVAL
;

122 
¥›li°
 = &
cfg
->
publish_¥›s
;

125 
CMD_SUBSCRIBE
:

126 if(
idítifõr
 !
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
 && idítifõ∏!
MQTT_PROP_USER_PROPERTY
){

127 
	`Ârötf
(
°dîr
, "Eº‹: %†¥›îtyÇŸ suµ‹ãd f‹ %†ö --¥›îtyárgumít.\n\n", 
¥›«me
, 
cmd«me
);

128  
MOSQ_ERR_NOT_SUPPORTED
;

130 
¥›li°
 = &
cfg
->
subs¸ibe_¥›s
;

133 
CMD_UNSUBSCRIBE
:

134 
¥›li°
 = &
cfg
->
unsubs¸ibe_¥›s
;

137 
CMD_DISCONNECT
:

138 
¥›li°
 = &
cfg
->
disc⁄√˘_¥›s
;

141 
CMD_AUTH
:

142 
	`Ârötf
(
°dîr
, "Eº‹: %†¥›îtyÇŸ suµ‹ãd f‹ %†ö --¥›îtyárgumít.\n\n", 
¥›«me
, 
cmd«me
);

143  
MOSQ_ERR_NOT_SUPPORTED
;

145 
CMD_WILL
:

146 
¥›li°
 = &
cfg
->
wûl_¥›s
;

149 
CMD_PUBACK
:

150 
CMD_PUBREC
:

151 
CMD_PUBREL
:

152 
CMD_PUBCOMP
:

153 
CMD_SUBACK
:

154 
CMD_UNSUBACK
:

155 
	`Ârötf
(
°dîr
, "Eº‹: %†¥›îtyÇŸ suµ‹ãd f‹ %†ö --¥›îtyárgumít.\n\n", 
¥›«me
, 
cmd«me
);

156  
MOSQ_ERR_NOT_SUPPORTED
;

159  
MOSQ_ERR_INVAL
;

162 
ty≥
){

163 
MQTT_PROP_TYPE_BYTE
:

164 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
idítifõr
, 
	`©oi
(
vÆue
));

166 
MQTT_PROP_TYPE_INT16
:

167 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
idítifõr
, 
	`©oi
(
vÆue
));

169 
MQTT_PROP_TYPE_INT32
:

170 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
idítifõr
, 
	`©oi
(
vÆue
));

172 
MQTT_PROP_TYPE_VARINT
:

173 
rc
 = 
	`mosquôto_¥›îty_add_v¨öt
(
¥›li°
, 
idítifõr
, 
	`©oi
(
vÆue
));

175 
MQTT_PROP_TYPE_BINARY
:

176 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(
¥›li°
, 
idítifõr
, 
vÆue
, 
	`°æí
(value));

178 
MQTT_PROP_TYPE_STRING
:

179 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
idítifõr
, 
vÆue
);

181 
MQTT_PROP_TYPE_STRING_PAIR
:

182 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(
¥›li°
, 
idítifõr
, 
key
, 
vÆue
);

185  
MOSQ_ERR_INVAL
;

187 if(
rc
){

188 
	`Ârötf
(
°dîr
, "Eº‹áddögÖr›îty %†%d\n", 
¥›«me
, 
ty≥
);

189  
rc
;

191  
MOSQ_ERR_SUCCESS
;

192 
	}
}

	@client/client_shared.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<°d¨g.h
>

22 
	~<°dio.h
>

23 
	~<°dlib.h
>

24 
	~<°rög.h
>

25 #i‚de‡
WIN32


26 
	~<uni°d.h
>

27 
	~<°rögs.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	#¢¥ötf
 
•rötf_s


	)

32 
	#°∫ˇ£cmp
 
_°∫icmp


	)

35 
	~<mosquôto.h
>

36 
	~<mqâ_¥Ÿocﬁ.h
>

37 
	~"˛õ¡_sh¨ed.h
"

39 #ifde‡
WITH_SOCKS


40 
mosquôto__∑r£_socks_uæ
(
mosq_c⁄fig
 *
cfg
, *
uæ
);

42 
˛õ¡_c⁄fig_löe_¥oc
(
mosq_c⁄fig
 *
cfg
, 
pub_‹_sub
, 
¨gc
, *
¨gv
[]);

45 
	$check_f‹m©
(c⁄° *
°r
)

47 
i
;

48 
Àn
;

50 
Àn
 = 
	`°æí
(
°r
);

51 
i
=0; i<
Àn
; i++){

52 if(
°r
[
i
] == '%'){

53 if(
i
 =
Àn
-1){

55 
	`Ârötf
(
°dîr
, "Error: Incomplete format specifier.\n");

58 if(
°r
[
i
+1] == '%'){

60 }if(
°r
[
i
+1] == 'I'){

62 }if(
°r
[
i
+1] == 'l'){

64 }if(
°r
[
i
+1] == 'm'){

66 }if(
°r
[
i
+1] == 'p'){

68 }if(
°r
[
i
+1] == 'q'){

70 }if(
°r
[
i
+1] == 'r'){

72 }if(
°r
[
i
+1] == 't'){

74 }if(
°r
[
i
+1] == 'j'){

76 }if(
°r
[
i
+1] == 'J'){

78 }if(
°r
[
i
+1] == 'U'){

80 }if(
°r
[
i
+1] == 'x' || str[i+1] == 'X'){

83 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid f‹m© s≥cifõ∏'%c'.\n", 
°r
[
i
+1]);

86 
i
++;

88 }if(
°r
[
i
] == '@'){

89 if(
i
 =
Àn
-1){

91 
	`Ârötf
(
°dîr
, "Error: Incomplete format specifier.\n");

94 
i
++;

95 }if(
°r
[
i
] == '\\'){

96 if(
i
 =
Àn
-1){

98 
	`Ârötf
(
°dîr
, "Error: IncompleteÉscape specifier.\n");

101 
°r
[
i
+1]){

113 
	`Ârötf
(
°dîr
, "Eº‹: InvÆidÉsˇ≥ s≥cifõ∏'%c'.\n", 
°r
[
i
+1]);

116 
i
++;

122 
	}
}

125 
	$öô_c⁄fig
(
mosq_c⁄fig
 *
cfg
, 
pub_‹_sub
)

127 
	`mem£t
(
cfg
, 0, (*cfg));

128 
cfg
->
p‹t
 = -1;

129 
cfg
->
max_öÊight
 = 20;

130 
cfg
->
kì∑live
 = 60;

131 
cfg
->
˛ón_£ssi⁄
 = 
åue
;

132 
cfg
->
eﬁ
 = 
åue
;

133 
cfg
->
ª≥©_cou¡
 = 1;

134 
cfg
->
ª≥©_dñay
.
tv_£c
 = 0;

135 
cfg
->
ª≥©_dñay
.
tv_u£c
 = 0;

136 if(
pub_‹_sub
 =
CLIENT_RR
){

137 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V5
;

138 
cfg
->
msg_cou¡
 = 1;

140 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V311
;

142 
	}
}

144 
	$˛õ¡_c⁄fig_˛ónup
(
mosq_c⁄fig
 *
cfg
)

146 
i
;

147 
	`‰ì
(
cfg
->
id
);

148 
	`‰ì
(
cfg
->
id_¥efix
);

149 
	`‰ì
(
cfg
->
ho°
);

150 
	`‰ì
(
cfg
->
fûe_öput
);

151 
	`‰ì
(
cfg
->
mesßge
);

152 
	`‰ì
(
cfg
->
t›ic
);

153 
	`‰ì
(
cfg
->
böd_addªss
);

154 
	`‰ì
(
cfg
->
u£∫ame
);

155 
	`‰ì
(
cfg
->
∑ssw‹d
);

156 
	`‰ì
(
cfg
->
wûl_t›ic
);

157 
	`‰ì
(
cfg
->
wûl_∑ylﬂd
);

158 
	`‰ì
(
cfg
->
f‹m©
);

159 
	`‰ì
(
cfg
->
ª•⁄£_t›ic
);

160 #ifde‡
WITH_TLS


161 
	`‰ì
(
cfg
->
ˇfûe
);

162 
	`‰ì
(
cfg
->
ˇ∑th
);

163 
	`‰ì
(
cfg
->
˚πfûe
);

164 
	`‰ì
(
cfg
->
keyfûe
);

165 
	`‰ì
(
cfg
->
cùhîs
);

166 
	`‰ì
(
cfg
->
és_Æ≤
);

167 
	`‰ì
(
cfg
->
és_vîsi⁄
);

168 
	`‰ì
(
cfg
->
és_ígöe
);

169 
	`‰ì
(
cfg
->
és_ígöe_k∑ss_sha1
);

170 
	`‰ì
(
cfg
->
keyf‹m
);

171 #ifde‡
FINAL_WITH_TLS_PSK


172 
	`‰ì
(
cfg
->
psk
);

173 
	`‰ì
(
cfg
->
psk_idítôy
);

176 if(
cfg
->
t›ics
){

177 
i
=0; i<
cfg
->
t›ic_cou¡
; i++){

178 
	`‰ì
(
cfg
->
t›ics
[
i
]);

180 
	`‰ì
(
cfg
->
t›ics
);

182 if(
cfg
->
fûãr_outs
){

183 
i
=0; i<
cfg
->
fûãr_out_cou¡
; i++){

184 
	`‰ì
(
cfg
->
fûãr_outs
[
i
]);

186 
	`‰ì
(
cfg
->
fûãr_outs
);

188 if(
cfg
->
unsub_t›ics
){

189 
i
=0; i<
cfg
->
unsub_t›ic_cou¡
; i++){

190 
	`‰ì
(
cfg
->
unsub_t›ics
[
i
]);

192 
	`‰ì
(
cfg
->
unsub_t›ics
);

194 #ifde‡
WITH_SOCKS


195 
	`‰ì
(
cfg
->
socks5_ho°
);

196 
	`‰ì
(
cfg
->
socks5_u£∫ame
);

197 
	`‰ì
(
cfg
->
socks5_∑ssw‹d
);

199 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
c⁄√˘_¥›s
);

200 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
publish_¥›s
);

201 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
subs¸ibe_¥›s
);

202 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
unsubs¸ibe_¥›s
);

203 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
disc⁄√˘_¥›s
);

204 
	`mosquôto_¥›îty_‰ì_Æl
(&
cfg
->
wûl_¥›s
);

205 
	}
}

207 
	$˛õ¡_c⁄fig_lﬂd
(
mosq_c⁄fig
 *
cfg
, 
pub_‹_sub
, 
¨gc
, *
¨gv
[])

209 
rc
;

210 
FILE
 *
Âå
;

211 
löe
[1024];

212 
cou¡
;

213 *
loc
 = 
NULL
;

214 
Àn
;

215 *
¨gs
[3];

217 #i‚de‡
WIN32


218 *
ív
;

220 
ív
[1024];

222 
¨gs
[0] = 
NULL
;

224 
	`öô_c⁄fig
(
cfg
, 
pub_‹_sub
);

227 #i‚de‡
WIN32


228 
ív
 = 
	`gëív
("XDG_CONFIG_HOME");

229 if(
ív
){

230 
Àn
 = 
	`°æí
(
ív
) + strlen("/mosquitto_pub") + 1;

231 
loc
 = 
	`mÆloc
(
Àn
);

232 if(!
loc
){

233 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

236 if(
pub_‹_sub
 =
CLIENT_PUB
){

237 
	`¢¥ötf
(
loc
, 
Àn
, "%s/mosquôto_pub", 
ív
);

238 }if(
pub_‹_sub
 =
CLIENT_SUB
){

239 
	`¢¥ötf
(
loc
, 
Àn
, "%s/mosquôto_sub", 
ív
);

241 
	`¢¥ötf
(
loc
, 
Àn
, "%s/mosquôto_º", 
ív
);

243 
loc
[
Àn
-1] = '\0';

245 
ív
 = 
	`gëív
("HOME");

246 if(
ív
){

247 
Àn
 = 
	`°æí
(
ív
) + strlen("/.config/mosquitto_pub") + 1;

248 
loc
 = 
	`mÆloc
(
Àn
);

249 if(!
loc
){

250 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

253 if(
pub_‹_sub
 =
CLIENT_PUB
){

254 
	`¢¥ötf
(
loc
, 
Àn
, "%s/.c⁄fig/mosquôto_pub", 
ív
);

255 }if(
pub_‹_sub
 =
CLIENT_SUB
){

256 
	`¢¥ötf
(
loc
, 
Àn
, "%s/.c⁄fig/mosquôto_sub", 
ív
);

258 
	`¢¥ötf
(
loc
, 
Àn
, "%s/.c⁄fig/mosquôto_º", 
ív
);

260 
loc
[
Àn
-1] = '\0';

265 
rc
 = 
	`GëEnvú⁄mítV¨übÀ
("USERPROFILE", 
ív
, 1024);

266 if(
rc
 > 0 &&Ñc < 1024){

267 
Àn
 = 
	`°æí
(
ív
) + strlen("\\mosquitto_pub.conf") + 1;

268 
loc
 = 
	`mÆloc
(
Àn
);

269 if(!
loc
){

270 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

273 if(
pub_‹_sub
 =
CLIENT_PUB
){

274 
	`¢¥ötf
(
loc
, 
Àn
, "%s\\mosquôto_pub.c⁄f", 
ív
);

275 }if(
pub_‹_sub
 =
CLIENT_SUB
){

276 
	`¢¥ötf
(
loc
, 
Àn
, "%s\\mosquôto_sub.c⁄f", 
ív
);

278 
	`¢¥ötf
(
loc
, 
Àn
, "%s\\mosquôto_º.c⁄f", 
ív
);

280 
loc
[
Àn
-1] = '\0';

284 if(
loc
){

285 
Âå
 = 
	`f›í
(
loc
, "rt");

286 if(
Âå
){

287 
	`fgës
(
löe
, 1024, 
Âå
)){

288 if(
löe
[0] == '#') ;

290 
löe
[
	`°æí
(line)-1] == 10 ||Üine[strlen(line)-1] == 13){

291 
löe
[
	`°æí
(line)-1] = 0;

295 
¨gs
[1] = 
	`°πok
(
löe
, " ");

296 if(
¨gs
[1]){

297 
¨gs
[2] = 
	`°πok
(
NULL
, " ");

298 if(
¨gs
[2]){

299 
cou¡
 = 3;

301 
cou¡
 = 2;

303 
rc
 = 
	`˛õ¡_c⁄fig_löe_¥oc
(
cfg
, 
pub_‹_sub
, 
cou¡
, 
¨gs
);

304 if(
rc
){

305 
	`f˛o£
(
Âå
);

306 
	`‰ì
(
loc
);

307  
rc
;

311 
	`f˛o£
(
Âå
);

313 
	`‰ì
(
loc
);

317 
rc
 = 
	`˛õ¡_c⁄fig_löe_¥oc
(
cfg
, 
pub_‹_sub
, 
¨gc
, 
¨gv
);

318 if(
rc
) Ñc;

320 if(
cfg
->
wûl_∑ylﬂd
 && !cfg->
wûl_t›ic
){

321 
	`Ârötf
(
°dîr
, "Error: WillÖayload given, butÇo willÅopic given.\n");

324 if(
cfg
->
wûl_ªèö
 && !cfg->
wûl_t›ic
){

325 
	`Ârötf
(
°dîr
, "Error: WillÑetain given, butÇo willÅopic given.\n");

328 #ifde‡
WITH_TLS


329 if((
cfg
->
˚πfûe
 && !cfg->
keyfûe
) || (cfg->keyfile && !cfg->certfile)){

330 
	`Ârötf
(
°dîr
, "Error: Both certfileánd keyfile must beÖrovided if one ofÅhem is set.\n");

333 if((
cfg
->
keyf‹m
 && !cfg->
keyfûe
)){

334 
	`Ârötf
(
°dîr
, "Error: If keyform is set, keyfile must beálso specified.\n");

337 if((
cfg
->
és_ígöe_k∑ss_sha1
 && (!cfg->
keyf‹m
 || !cfg->
és_ígöe
))){

338 
	`Ârötf
(
°dîr
, "Error: when usingÅls-engine-kpass-sha1, bothÅls-engineánd keyform mustálso beÖrovided.\n");

342 #ifde‡
FINAL_WITH_TLS_PSK


343 if((
cfg
->
ˇfûe
 || cfg->
ˇ∑th
Ë&& cfg->
psk
){

344 
	`Ârötf
(
°dîr
, "Error: Only one of --psk or --cafile/--capath may be usedát once.\n");

347 if(
cfg
->
psk
 && !cfg->
psk_idítôy
){

348 
	`Ârötf
(
°dîr
, "Error: --psk-identityÑequired if --psk used.\n");

353 if(
cfg
->
˛ón_£ssi⁄
 =
Ál£
 && (cfg->
id_¥efix
 || !cfg->
id
)){

354 
	`Ârötf
(
°dîr
, "Error: You mustÖrovideá client id if youáre usingÅhe -c option.\n");

358 if(
pub_‹_sub
 =
CLIENT_SUB
){

359 if(
cfg
->
t›ic_cou¡
 == 0){

360 
	`Ârötf
(
°dîr
, "Error: You must specifyáÅopicÅo subscribeÅo.\n");

365 if(!
cfg
->
ho°
){

366 
cfg
->
ho°
 = 
	`°rdup
("localhost");

367 if(!
cfg
->
ho°
){

368 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

373 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_CONNECT
, 
cfg
->
c⁄√˘_¥›s
);

374 if(
rc
){

375 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿CONNECTÖr›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

378 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_PUBLISH
, 
cfg
->
publish_¥›s
);

379 if(
rc
){

380 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿PUBLISHÖr›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

383 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_SUBSCRIBE
, 
cfg
->
subs¸ibe_¥›s
);

384 if(
rc
){

385 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿SUBSCRIBEÖr›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

388 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_UNSUBSCRIBE
, 
cfg
->
unsubs¸ibe_¥›s
);

389 if(
rc
){

390 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿UNSUBSCRIBEÖr›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

393 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_DISCONNECT
, 
cfg
->
disc⁄√˘_¥›s
);

394 if(
rc
){

395 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿DISCONNECTÖr›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

398 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_WILL
, 
cfg
->
wûl_¥›s
);

399 if(
rc
){

400 
	`îr_¥ötf
(
cfg
, "Eº‹ i¿Wû»¥›îtõs: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

404  
MOSQ_ERR_SUCCESS
;

405 
	}
}

407 
	$cfg_add_t›ic
(
mosq_c⁄fig
 *
cfg
, 
ty≥
, *
t›ic
, c⁄° *
¨g
)

409 if(
	`mosquôto_vÆid©e_utf8
(
t›ic
, 
	`°æí
(topic))){

410 
	`Ârötf
(
°dîr
, "Eº‹: MÆf‹med UTF-8 i¿%†¨gumít.\n\n", 
¨g
);

413 if(
ty≥
 =
CLIENT_PUB
 ||Åy≥ =
CLIENT_RR
){

414 if(
	`mosquôto_pub_t›ic_check
(
t›ic
Ë=
MOSQ_ERR_INVAL
){

415 
	`Ârötf
(
°dîr
, "Eº‹: InvÆidÖublishÅ›i¯'%s', d€†ô c⁄èö '+' o∏'#'?\n", 
t›ic
);

418 
cfg
->
t›ic
 = 
	`°rdup
(topic);

419 }if(
ty≥
 =
CLIENT_RESPONSE_TOPIC
){

420 if(
	`mosquôto_pub_t›ic_check
(
t›ic
Ë=
MOSQ_ERR_INVAL
){

421 
	`Ârötf
(
°dîr
, "Eº‹: InvÆidÑe•⁄£Å›i¯'%s', d€†ô c⁄èö '+' o∏'#'?\n", 
t›ic
);

424 
cfg
->
ª•⁄£_t›ic
 = 
	`°rdup
(
t›ic
);

426 if(
	`mosquôto_sub_t›ic_check
(
t›ic
Ë=
MOSQ_ERR_INVAL
){

427 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid subs¸ùti⁄Å›i¯'%s',áªáŒ '+'ánd '#' wûdˇrd†c‹ª˘?\n", 
t›ic
);

430 
cfg
->
t›ic_cou¡
++;

431 
cfg
->
t›ics
 = 
	`ªÆloc
(cfg->t›ics, cfg->
t›ic_cou¡
*(*));

432 if(!
cfg
->
t›ics
){

433 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

436 
cfg
->
t›ics
[cfg->
t›ic_cou¡
-1] = 
	`°rdup
(
t›ic
);

439 
	}
}

442 
	$˛õ¡_c⁄fig_löe_¥oc
(
mosq_c⁄fig
 *
cfg
, 
pub_‹_sub
, 
¨gc
, *
¨gv
[])

444 
i
;

445 
f
;

447 
i
=1; i<
¨gc
; i++){

448 if(!
	`°rcmp
(
¨gv
[
i
], "-A")){

449 if(
i
==
¨gc
-1){

450 
	`Ârötf
(
°dîr
, "Error: -Aárgument given butÇoáddress specified.\n\n");

453 
cfg
->
böd_addªss
 = 
	`°rdup
(
¨gv
[
i
+1]);

455 
i
++;

456 #ifde‡
WITH_TLS


457 }if(!
	`°rcmp
(
¨gv
[
i
], "--cafile")){

458 if(
i
==
¨gc
-1){

459 
	`Ârötf
(
°dîr
, "Error: --cafileárgument given butÇo file specified.\n\n");

462 
cfg
->
ˇfûe
 = 
	`°rdup
(
¨gv
[
i
+1]);

464 
i
++;

465 }if(!
	`°rcmp
(
¨gv
[
i
], "--capath")){

466 if(
i
==
¨gc
-1){

467 
	`Ârötf
(
°dîr
, "Error: --capathárgument given butÇo directory specified.\n\n");

470 
cfg
->
ˇ∑th
 = 
	`°rdup
(
¨gv
[
i
+1]);

472 
i
++;

473 }if(!
	`°rcmp
(
¨gv
[
i
], "--cert")){

474 if(
i
==
¨gc
-1){

475 
	`Ârötf
(
°dîr
, "Error: --certárgument given butÇo file specified.\n\n");

478 
cfg
->
˚πfûe
 = 
	`°rdup
(
¨gv
[
i
+1]);

480 
i
++;

481 }if(!
	`°rcmp
(
¨gv
[
i
], "--ciphers")){

482 if(
i
==
¨gc
-1){

483 
	`Ârötf
(
°dîr
, "Error: --ciphersárgument given butÇo ciphers specified.\n\n");

486 
cfg
->
cùhîs
 = 
	`°rdup
(
¨gv
[
i
+1]);

488 
i
++;

490 }if(!
	`°rcmp
(
¨gv
[
i
], "-C")){

491 if(
pub_‹_sub
 !
CLIENT_SUB
){

492 
unknown_›ti⁄
;

494 if(
i
==
¨gc
-1){

495 
	`Ârötf
(
°dîr
, "Error: -Cárgument given butÇo count specified.\n\n");

498 
cfg
->
msg_cou¡
 = 
	`©oi
(
¨gv
[
i
+1]);

499 if(
cfg
->
msg_cou¡
 < 1){

500 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid mesßgêcou¡ \"%d\".\n\n", 
cfg
->
msg_cou¡
);

504 
i
++;

506 }if(!
	`°rcmp
(
¨gv
[
i
], "-c") || !strcmp(argv[i], "--disable-clean-session")){

507 
cfg
->
˛ón_£ssi⁄
 = 
Ál£
;

508 }if(!
	`°rcmp
(
¨gv
[
i
], "-d") || !strcmp(argv[i], "--debug")){

509 
cfg
->
debug
 = 
åue
;

510 }if(!
	`°rcmp
(
¨gv
[
i
], "-D") || !strcmp(argv[i], "--property")){

511 
i
++;

512 if(
	`cfg_∑r£_¥›îty
(
cfg
, 
¨gc
, 
¨gv
, &
i
)){

515 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V5
;

516 }if(!
	`°rcmp
(
¨gv
[
i
], "-e")){

517 if(
pub_‹_sub
 !
CLIENT_RR
){

518 
unknown_›ti⁄
;

520 if(
i
==
¨gc
-1){

521 
	`Ârötf
(
°dîr
, "Error: -eárgument given butÇoÑesponseÅopic specified.\n\n");

524 if(
	`cfg_add_t›ic
(
cfg
, 
CLIENT_RESPONSE_TOPIC
, 
¨gv
[
i
+1], "-e")){

528 
i
++;

529 }if(!
	`°rcmp
(
¨gv
[
i
], "-E")){

530 if(
pub_‹_sub
 !
CLIENT_SUB
){

531 
unknown_›ti⁄
;

533 
cfg
->
exô_a·î_sub
 = 
åue
;

534 }if(!
	`°rcmp
(
¨gv
[
i
], "-f") || !strcmp(argv[i], "--file")){

535 if(
pub_‹_sub
 =
CLIENT_SUB
){

536 
unknown_›ti⁄
;

538 if(
cfg
->
pub_mode
 !
MSGMODE_NONE
){

539 
	`Ârötf
(
°dîr
, "Error: Only oneÅype of message can be sentát once.\n\n");

541 }if(
i
==
¨gc
-1){

542 
	`Ârötf
(
°dîr
, "Error: -fárgument given butÇo file specified.\n\n");

545 
cfg
->
pub_mode
 = 
MSGMODE_FILE
;

546 
cfg
->
fûe_öput
 = 
	`°rdup
(
¨gv
[
i
+1]);

547 if(!
cfg
->
fûe_öput
){

548 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

552 
i
++;

553 }if(!
	`°rcmp
(
¨gv
[
i
], "-F")){

554 if(
pub_‹_sub
 =
CLIENT_PUB
){

555 
unknown_›ti⁄
;

557 if(
i
==
¨gc
-1){

558 
	`Ârötf
(
°dîr
, "Error: -Fárgument given butÇo format specified.\n\n");

561 
cfg
->
f‹m©
 = 
	`°rdup
(
¨gv
[
i
+1]);

562 if(!
cfg
->
f‹m©
){

563 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

566 if(
	`check_f‹m©
(
cfg
->
f‹m©
)){

570 
i
++;

571 }if(!
	`°rcmp
(
¨gv
[
i
], "--help")){

573 }if(!
	`°rcmp
(
¨gv
[
i
], "-h") || !strcmp(argv[i], "--host")){

574 if(
i
==
¨gc
-1){

575 
	`Ârötf
(
°dîr
, "Error: -hárgument given butÇo host specified.\n\n");

578 
cfg
->
ho°
 = 
	`°rdup
(
¨gv
[
i
+1]);

580 
i
++;

581 #ifde‡
WITH_TLS


582 }if(!
	`°rcmp
(
¨gv
[
i
], "--insecure")){

583 
cfg
->
ö£cuª
 = 
åue
;

585 }if(!
	`°rcmp
(
¨gv
[
i
], "-i") || !strcmp(argv[i], "--id")){

586 if(
cfg
->
id_¥efix
){

587 
	`Ârötf
(
°dîr
, "Error: -iánd -Iárgument cannot be usedÅogether.\n\n");

590 if(
i
==
¨gc
-1){

591 
	`Ârötf
(
°dîr
, "Error: -iárgument given butÇo id specified.\n\n");

594 
cfg
->
id
 = 
	`°rdup
(
¨gv
[
i
+1]);

596 
i
++;

597 }if(!
	`°rcmp
(
¨gv
[
i
], "-I") || !strcmp(argv[i], "--id-prefix")){

598 if(
cfg
->
id
){

599 
	`Ârötf
(
°dîr
, "Error: -iánd -Iárgument cannot be usedÅogether.\n\n");

602 if(
i
==
¨gc
-1){

603 
	`Ârötf
(
°dîr
, "Error: -Iárgument given butÇo idÖrefix specified.\n\n");

606 
cfg
->
id_¥efix
 = 
	`°rdup
(
¨gv
[
i
+1]);

608 
i
++;

609 }if(!
	`°rcmp
(
¨gv
[
i
], "-k") || !strcmp(argv[i], "--keepalive")){

610 if(
i
==
¨gc
-1){

611 
	`Ârötf
(
°dîr
, "Error: -kárgument given butÇo keepalive specified.\n\n");

614 
cfg
->
kì∑live
 = 
	`©oi
(
¨gv
[
i
+1]);

615 if(
cfg
->
kì∑live
>65535){

616 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid kì∑livêgiví: %d\n", 
cfg
->
kì∑live
);

620 
i
++;

621 #ifde‡
WITH_TLS


622 }if(!
	`°rcmp
(
¨gv
[
i
], "--key")){

623 if(
i
==
¨gc
-1){

624 
	`Ârötf
(
°dîr
, "Error: --keyárgument given butÇo file specified.\n\n");

627 
cfg
->
keyfûe
 = 
	`°rdup
(
¨gv
[
i
+1]);

629 
i
++;

630 }if(!
	`°rcmp
(
¨gv
[
i
], "--keyform")){

631 if(
i
==
¨gc
-1){

632 
	`Ârötf
(
°dîr
, "Error: --keyformárgument given butÇo keyform specified.\n\n");

635 
cfg
->
keyf‹m
 = 
	`°rdup
(
¨gv
[
i
+1]);

637 
i
++;

639 }if(!
	`°rcmp
(
¨gv
[
i
], "-L") || !strcmp(argv[i], "--url")){

640 if(
i
==
¨gc
-1){

641 
	`Ârötf
(
°dîr
, "Error: -Lárgument given butÇo URL specified.\n\n");

644 *
uæ
 = 
¨gv
[
i
+1];

645 *
t›ic
;

646 *
tmp
;

648 if(!
	`°∫ˇ£cmp
(
uæ
, "mqtt://", 7)) {

649 
uæ
 += 7;

650 
cfg
->
p‹t
 = 1883;

651 } if(!
	`°∫ˇ£cmp
(
uæ
, "mqtts://", 8)) {

652 
uæ
 += 8;

653 
cfg
->
p‹t
 = 8883;

655 
	`Ârötf
(
°dîr
, "Error: unsupported URL scheme.\n\n");

658 
t›ic
 = 
	`°rchr
(
uæ
, '/');

659 if(!
t›ic
){

660 
	`Ârötf
(
°dîr
, "Error: Invalid URL for -Lárgument specified -Åopic missing.\n");

663 *
t›ic
++ = 0;

665 if(
	`cfg_add_t›ic
(
cfg
, 
pub_‹_sub
, 
t›ic
, "-LÅopic"))

668 
tmp
 = 
	`°rchr
(
uæ
, '@');

669 if(
tmp
) {

670 *
tmp
++ = 0;

671 *
cﬁ⁄
 = 
	`°rchr
(
uæ
, ':');

672 if(
cﬁ⁄
) {

673 *
cﬁ⁄
 = 0;

674 
cfg
->
∑ssw‹d
 = 
	`°rdup
(
cﬁ⁄
 + 1);

676 
cfg
->
u£∫ame
 = 
	`°rdup
(
uæ
);

677 
uæ
 = 
tmp
;

679 
cfg
->
ho°
 = 
uæ
;

681 
tmp
 = 
	`°rchr
(
uæ
, ':');

682 if(
tmp
) {

683 *
tmp
++ = 0;

684 
cfg
->
p‹t
 = 
	`©oi
(
tmp
);

687 
cfg
->
ho°
 = 
	`°rdup
(cfg->host);

689 
i
++;

690 }if(!
	`°rcmp
(
¨gv
[
i
], "-l") || !strcmp(argv[i], "--stdin-line")){

691 if(
pub_‹_sub
 !
CLIENT_PUB
){

692 
unknown_›ti⁄
;

694 if(
cfg
->
pub_mode
 !
MSGMODE_NONE
){

695 
	`Ârötf
(
°dîr
, "Error: Only oneÅype of message can be sentát once.\n\n");

698 
cfg
->
pub_mode
 = 
MSGMODE_STDIN_LINE
;

700 }if(!
	`°rcmp
(
¨gv
[
i
], "-m") || !strcmp(argv[i], "--message")){

701 if(
pub_‹_sub
 =
CLIENT_SUB
){

702 
unknown_›ti⁄
;

704 if(
cfg
->
pub_mode
 !
MSGMODE_NONE
){

705 
	`Ârötf
(
°dîr
, "Error: Only oneÅype of message can be sentát once.\n\n");

707 }if(
i
==
¨gc
-1){

708 
	`Ârötf
(
°dîr
, "Error: -márgument given butÇo message specified.\n\n");

711 
cfg
->
mesßge
 = 
	`°rdup
(
¨gv
[
i
+1]);

712 
cfg
->
msgÀn
 = 
	`°æí
(cfg->
mesßge
);

713 
cfg
->
pub_mode
 = 
MSGMODE_CMD
;

715 
i
++;

716 }if(!
	`°rcmp
(
¨gv
[
i
], "-M")){

717 if(
i
==
¨gc
-1){

718 
	`Ârötf
(
°dîr
, "Error: -Márgument given but max_inflightÇot specified.\n\n");

721 
cfg
->
max_öÊight
 = 
	`©oi
(
¨gv
[
i
+1]);

723 
i
++;

724 }if(!
	`°rcmp
(
¨gv
[
i
], "-n") || !strcmp(argv[i], "--null-message")){

725 if(
pub_‹_sub
 =
CLIENT_SUB
){

726 
unknown_›ti⁄
;

728 if(
cfg
->
pub_mode
 !
MSGMODE_NONE
){

729 
	`Ârötf
(
°dîr
, "Error: Only oneÅype of message can be sentát once.\n\n");

732 
cfg
->
pub_mode
 = 
MSGMODE_NULL
;

734 }if(!
	`°rcmp
(
¨gv
[
i
], "-N")){

735 if(
pub_‹_sub
 =
CLIENT_PUB
){

736 
unknown_›ti⁄
;

738 
cfg
->
eﬁ
 = 
Ál£
;

739 }if(!
	`°rcmp
(
¨gv
[
i
], "-p") || !strcmp(argv[i], "--port")){

740 if(
i
==
¨gc
-1){

741 
	`Ârötf
(
°dîr
, "Error: -párgument given butÇoÖort specified.\n\n");

744 
cfg
->
p‹t
 = 
	`©oi
(
¨gv
[
i
+1]);

745 if(
cfg
->
p‹t
<1 || cfg->port>65535){

746 
	`Ârötf
(
°dîr
, "Eº‹: InvÆidÖ‹àgiví: %d\n", 
cfg
->
p‹t
);

750 
i
++;

751 }if(!
	`°rcmp
(
¨gv
[
i
], "-P") || !strcmp(argv[i], "--pw")){

752 if(
i
==
¨gc
-1){

753 
	`Ârötf
(
°dîr
, "Error: -Párgument given butÇoÖassword specified.\n\n");

756 
cfg
->
∑ssw‹d
 = 
	`°rdup
(
¨gv
[
i
+1]);

758 
i
++;

759 #ifde‡
WITH_SOCKS


760 }if(!
	`°rcmp
(
¨gv
[
i
], "--proxy")){

761 if(
i
==
¨gc
-1){

762 
	`Ârötf
(
°dîr
, "Error: --proxyárgument given butÇoÖroxy url specified.\n\n");

765 if(
	`mosquôto__∑r£_socks_uæ
(
cfg
, 
¨gv
[
i
+1])){

768 
i
++;

771 #ifde‡
FINAL_WITH_TLS_PSK


772 }if(!
	`°rcmp
(
¨gv
[
i
], "--psk")){

773 if(
i
==
¨gc
-1){

774 
	`Ârötf
(
°dîr
, "Error: --pskárgument given butÇo key specified.\n\n");

777 
cfg
->
psk
 = 
	`°rdup
(
¨gv
[
i
+1]);

779 
i
++;

780 }if(!
	`°rcmp
(
¨gv
[
i
], "--psk-identity")){

781 if(
i
==
¨gc
-1){

782 
	`Ârötf
(
°dîr
, "Error: --psk-identityárgument given butÇo identity specified.\n\n");

785 
cfg
->
psk_idítôy
 = 
	`°rdup
(
¨gv
[
i
+1]);

787 
i
++;

789 }if(!
	`°rcmp
(
¨gv
[
i
], "-q") || !strcmp(argv[i], "--qos")){

790 if(
i
==
¨gc
-1){

791 
	`Ârötf
(
°dîr
, "Error: -qárgument given butÇo QoS specified.\n\n");

794 
cfg
->
qos
 = 
	`©oi
(
¨gv
[
i
+1]);

795 if(
cfg
->
qos
<0 || cfg->qos>2){

796 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid QoS giví: %d\n", 
cfg
->
qos
);

800 
i
++;

801 }if(!
	`°rcmp
(
¨gv
[
i
], "--quiet")){

802 
cfg
->
quõt
 = 
åue
;

803 }if(!
	`°rcmp
(
¨gv
[
i
], "-r") || !strcmp(argv[i], "--retain")){

804 if(
pub_‹_sub
 !
CLIENT_PUB
){

805 
unknown_›ti⁄
;

807 
cfg
->
ªèö
 = 1;

808 }if(!
	`°rcmp
(
¨gv
[
i
], "-R")){

809 if(
pub_‹_sub
 =
CLIENT_PUB
){

810 
unknown_›ti⁄
;

812 
cfg
->
no_ªèö
 = 
åue
;

813 
cfg
->
sub_›ts
 |
MQTT_SUB_OPT_SEND_RETAIN_NEVER
;

814 }if(!
	`°rcmp
(
¨gv
[
i
], "--remove-retained")){

815 if(
pub_‹_sub
 !
CLIENT_SUB
){

816 
unknown_›ti⁄
;

818 
cfg
->
ªmove_ªèöed
 = 
åue
;

819 }if(!
	`°rcmp
(
¨gv
[
i
], "--repeat")){

820 if(
pub_‹_sub
 !
CLIENT_PUB
){

821 
unknown_›ti⁄
;

823 if(
i
==
¨gc
-1){

824 
	`Ârötf
(
°dîr
, "Error: --repeatárgument given butÇo count specified.\n\n");

827 
cfg
->
ª≥©_cou¡
 = 
	`©oi
(
¨gv
[
i
+1]);

828 if(
cfg
->
ª≥©_cou¡
 < 1){

829 
	`Ârötf
(
°dîr
, "Error: --repeatárgument must be >0.\n\n");

833 
i
++;

834 }if(!
	`°rcmp
(
¨gv
[
i
], "--repeat-delay")){

835 if(
pub_‹_sub
 !
CLIENT_PUB
){

836 
unknown_›ti⁄
;

838 if(
i
==
¨gc
-1){

839 
	`Ârötf
(
°dîr
, "Error: --repeat-delayárgument given butÇoÅime specified.\n\n");

842 
f
 = 
	`©of
(
¨gv
[
i
+1]);

843 if(
f
 < 0.0f){

844 
	`Ârötf
(
°dîr
, "Error: --repeat-delayárgument must be >=0.0.\n\n");

847 
f
 *= 1.0e6;

848 
cfg
->
ª≥©_dñay
.
tv_£c
 = ()
f
/1e6;

849 
cfg
->
ª≥©_dñay
.
tv_u£c
 = ()
f
%1000000;

851 
i
++;

852 }if(!
	`°rcmp
(
¨gv
[
i
], "--retain-as-published")){

853 if(
pub_‹_sub
 =
CLIENT_PUB
){

854 
unknown_›ti⁄
;

856 
cfg
->
sub_›ts
 |
MQTT_SUB_OPT_RETAIN_AS_PUBLISHED
;

857 }if(!
	`°rcmp
(
¨gv
[
i
], "--retained-only")){

858 if(
pub_‹_sub
 !
CLIENT_SUB
){

859 
unknown_›ti⁄
;

861 
cfg
->
ªèöed_⁄ly
 = 
åue
;

862 }if(!
	`°rcmp
(
¨gv
[
i
], "-s") || !strcmp(argv[i], "--stdin-file")){

863 if(
pub_‹_sub
 =
CLIENT_SUB
){

864 
unknown_›ti⁄
;

866 if(
cfg
->
pub_mode
 !
MSGMODE_NONE
){

867 
	`Ârötf
(
°dîr
, "Error: Only oneÅype of message can be sentát once.\n\n");

870 
cfg
->
pub_mode
 = 
MSGMODE_STDIN_FILE
;

872 #ifde‡
WITH_SRV


873 }if(!
	`°rcmp
(
¨gv
[
i
], "-S")){

874 
cfg
->
u£_§v
 = 
åue
;

876 }if(!
	`°rcmp
(
¨gv
[
i
], "-t") || !strcmp(argv[i], "--topic")){

877 if(
i
==
¨gc
-1){

878 
	`Ârötf
(
°dîr
, "Error: -tárgument given butÇoÅopic specified.\n\n");

881 if(
	`cfg_add_t›ic
(
cfg
, 
pub_‹_sub
, 
¨gv
[
i
 + 1], "-t"))

883 
i
++;

885 }if(!
	`°rcmp
(
¨gv
[
i
], "-T") || !strcmp(argv[i], "--filter-out")){

886 if(
pub_‹_sub
 !
CLIENT_SUB
){

887 
unknown_›ti⁄
;

889 if(
i
==
¨gc
-1){

890 
	`Ârötf
(
°dîr
, "Error: -Tárgument given butÇoÅopic filter specified.\n\n");

893 if(
	`mosquôto_vÆid©e_utf8
(
¨gv
[
i
+1], 
	`°æí
(argv[i+1]))){

894 
	`Ârötf
(
°dîr
, "Error: Malformed UTF-8 in -Tárgument.\n\n");

897 if(
	`mosquôto_sub_t›ic_check
(
¨gv
[
i
+1]Ë=
MOSQ_ERR_INVAL
){

898 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid fûã∏t›i¯'%s',áªáŒ '+'ánd '#' wûdˇrd†c‹ª˘?\n", 
¨gv
[
i
+1]);

901 
cfg
->
fûãr_out_cou¡
++;

902 
cfg
->
fûãr_outs
 = 
	`ªÆloc
(cfg->fûãr_outs, cfg->
fûãr_out_cou¡
*(*));

903 if(!
cfg
->
fûãr_outs
){

904 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

907 
cfg
->
fûãr_outs
[cfg->
fûãr_out_cou¡
-1] = 
	`°rdup
(
¨gv
[
i
+1]);

909 
i
++;

910 #ifde‡
WITH_TLS


911 }if(!
	`°rcmp
(
¨gv
[
i
], "--tls-alpn")){

912 if(
i
==
¨gc
-1){

913 
	`Ârötf
(
°dîr
, "Error: --tls-alpnárgument given butÇoÖrotocol specified.\n\n");

916 
cfg
->
és_Æ≤
 = 
	`°rdup
(
¨gv
[
i
+1]);

918 
i
++;

919 }if(!
	`°rcmp
(
¨gv
[
i
], "--tls-engine")){

920 if(
i
==
¨gc
-1){

921 
	`Ârötf
(
°dîr
, "Error: --tls-engineárgument given butÇoÉngine_id specified.\n\n");

924 
cfg
->
és_ígöe
 = 
	`°rdup
(
¨gv
[
i
+1]);

926 
i
++;

927 }if(!
	`°rcmp
(
¨gv
[
i
], "--tls-engine-kpass-sha1")){

928 if(
i
==
¨gc
-1){

929 
	`Ârötf
(
°dîr
, "Error: --tls-engine-kpass-sha1árgument given butÇo kpass sha1 specified.\n\n");

932 
cfg
->
és_ígöe_k∑ss_sha1
 = 
	`°rdup
(
¨gv
[
i
+1]);

934 
i
++;

935 }if(!
	`°rcmp
(
¨gv
[
i
], "--tls-version")){

936 if(
i
==
¨gc
-1){

937 
	`Ârötf
(
°dîr
, "Error: --tls-versionárgument given butÇo version specified.\n\n");

940 
cfg
->
és_vîsi⁄
 = 
	`°rdup
(
¨gv
[
i
+1]);

942 
i
++;

944 }if(!
	`°rcmp
(
¨gv
[
i
], "-U") || !strcmp(argv[i], "--unsubscribe")){

945 if(
pub_‹_sub
 !
CLIENT_SUB
){

946 
unknown_›ti⁄
;

948 if(
i
==
¨gc
-1){

949 
	`Ârötf
(
°dîr
, "Error: -Uárgument given butÇo unsubscribeÅopic specified.\n\n");

952 if(
	`mosquôto_vÆid©e_utf8
(
¨gv
[
i
+1], 
	`°æí
(argv[i+1]))){

953 
	`Ârötf
(
°dîr
, "Error: Malformed UTF-8 in -Uárgument.\n\n");

956 if(
	`mosquôto_sub_t›ic_check
(
¨gv
[
i
+1]Ë=
MOSQ_ERR_INVAL
){

957 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid unsubs¸ibêt›i¯'%s',áªáŒ '+'ánd '#' wûdˇrd†c‹ª˘?\n", 
¨gv
[
i
+1]);

960 
cfg
->
unsub_t›ic_cou¡
++;

961 
cfg
->
unsub_t›ics
 = 
	`ªÆloc
(cfg->unsub_t›ics, cfg->
unsub_t›ic_cou¡
*(*));

962 if(!
cfg
->
unsub_t›ics
){

963 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

966 
cfg
->
unsub_t›ics
[cfg->
unsub_t›ic_cou¡
-1] = 
	`°rdup
(
¨gv
[
i
+1]);

968 
i
++;

969 }if(!
	`°rcmp
(
¨gv
[
i
], "-u") || !strcmp(argv[i], "--username")){

970 if(
i
==
¨gc
-1){

971 
	`Ârötf
(
°dîr
, "Error: -uárgument given butÇo username specified.\n\n");

974 
cfg
->
u£∫ame
 = 
	`°rdup
(
¨gv
[
i
+1]);

976 
i
++;

977 }if(!
	`°rcmp
(
¨gv
[
i
], "-V") || !strcmp(argv[i], "--protocol-version")){

978 if(
i
==
¨gc
-1){

979 
	`Ârötf
(
°dîr
, "Error: --protocol-versionárgument given butÇo version specified.\n\n");

982 if(!
	`°rcmp
(
¨gv
[
i
+1], "mqttv31") || !strcmp(argv[i+1], "31")){

983 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V31
;

984 }if(!
	`°rcmp
(
¨gv
[
i
+1], "mqttv311") || !strcmp(argv[i+1], "311")){

985 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V311
;

986 }if(!
	`°rcmp
(
¨gv
[
i
+1], "mqttv5") || !strcmp(argv[i+1], "5")){

987 
cfg
->
¥Ÿocﬁ_vîsi⁄
 = 
MQTT_PROTOCOL_V5
;

989 
	`Ârötf
(
°dîr
, "Error: InvalidÖrotocol versionárgument given.\n\n");

992 
i
++;

994 }if(!
	`°rcmp
(
¨gv
[
i
], "-v") || !strcmp(argv[i], "--verbose")){

995 if(
pub_‹_sub
 =
CLIENT_PUB
){

996 
unknown_›ti⁄
;

998 
cfg
->
vîbo£
 = 1;

999 }if(!
	`°rcmp
(
¨gv
[
i
], "-W")){

1000 if(
pub_‹_sub
 =
CLIENT_PUB
){

1001 
unknown_›ti⁄
;

1003 if(
i
==
¨gc
-1){

1004 
	`Ârötf
(
°dîr
, "Error: -Wárgument given butÇoÅimeout specified.\n\n");

1007 
cfg
->
timeout
 = 
	`©oi
(
¨gv
[
i
+1]);

1008 if(
cfg
->
timeout
 < 1){

1009 
	`Ârötf
(
°dîr
, "Eº‹: InvÆidÅimeouà\"%d\".\n\n", 
cfg
->
msg_cou¡
);

1013 
i
++;

1015 }if(!
	`°rcmp
(
¨gv
[
i
], "--will-payload")){

1016 if(
i
==
¨gc
-1){

1017 
	`Ârötf
(
°dîr
, "Error: --will-payloadárgument given butÇo willÖayload specified.\n\n");

1020 
cfg
->
wûl_∑ylﬂd
 = 
	`°rdup
(
¨gv
[
i
+1]);

1021 
cfg
->
wûl_∑ylﬂdÀn
 = 
	`°æí
(cfg->
wûl_∑ylﬂd
);

1023 
i
++;

1024 }if(!
	`°rcmp
(
¨gv
[
i
], "--will-qos")){

1025 if(
i
==
¨gc
-1){

1026 
	`Ârötf
(
°dîr
, "Error: --will-qosárgument given butÇo will QoS specified.\n\n");

1029 
cfg
->
wûl_qos
 = 
	`©oi
(
¨gv
[
i
+1]);

1030 if(
cfg
->
wûl_qos
 < 0 || cfg->will_qos > 2){

1031 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid wû»QoS %d.\n\n", 
cfg
->
wûl_qos
);

1035 
i
++;

1036 }if(!
	`°rcmp
(
¨gv
[
i
], "--will-retain")){

1037 
cfg
->
wûl_ªèö
 = 
åue
;

1038 }if(!
	`°rcmp
(
¨gv
[
i
], "--will-topic")){

1039 if(
i
==
¨gc
-1){

1040 
	`Ârötf
(
°dîr
, "Error: --will-topicárgument given butÇo willÅopic specified.\n\n");

1043 if(
	`mosquôto_vÆid©e_utf8
(
¨gv
[
i
+1], 
	`°æí
(argv[i+1]))){

1044 
	`Ârötf
(
°dîr
, "Error: Malformed UTF-8 in --will-topicárgument.\n\n");

1047 if(
	`mosquôto_pub_t›ic_check
(
¨gv
[
i
+1]Ë=
MOSQ_ERR_INVAL
){

1048 
	`Ârötf
(
°dîr
, "Eº‹: InvÆid wû»t›i¯'%s', d€†ô c⁄èö '+' o∏'#'?\n", 
¨gv
[
i
+1]);

1051 
cfg
->
wûl_t›ic
 = 
	`°rdup
(
¨gv
[
i
+1]);

1053 
i
++;

1055 
unknown_›ti⁄
;

1059  
MOSQ_ERR_SUCCESS
;

1061 
unknown_›ti⁄
:

1062 
	`Ârötf
(
°dîr
, "Eº‹: Unknow¿›ti⁄ '%s'.\n",
¨gv
[
i
]);

1064 
	}
}

1066 
	$˛õ¡_›ts_£t
(
mosquôto
 *
mosq
, 
mosq_c⁄fig
 *
cfg
)

1068 #i‡
	`deföed
(
WITH_TLS
Ë|| deföed(
WITH_SOCKS
)

1069 
rc
;

1072 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
cfg
->
¥Ÿocﬁ_vîsi⁄
);

1074 if(
cfg
->
wûl_t›ic
 && 
	`mosquôto_wûl_£t_v5
(
mosq
, cfg->will_topic,

1075 
cfg
->
wûl_∑ylﬂdÀn
, cfg->
wûl_∑ylﬂd
, cfg->
wûl_qos
,

1076 
cfg
->
wûl_ªèö
, cfg->
wûl_¥›s
)){

1078 
	`îr_¥ötf
(
cfg
, "Error: Problem setting will.\n");

1079 
	`mosquôto_lib_˛ónup
();

1082 
cfg
->
wûl_¥›s
 = 
NULL
;

1084 if((
cfg
->
u£∫ame
 || cfg->
∑ssw‹d
Ë&& 
	`mosquôto_u£∫ame_pw_£t
(
mosq
, cfg->username, cfg->password)){

1085 
	`îr_¥ötf
(
cfg
, "Error: Problem setting usernameánd/orÖassword.\n");

1086 
	`mosquôto_lib_˛ónup
();

1089 #ifde‡
WITH_TLS


1090 if(
cfg
->
ˇfûe
 || cfg->
ˇ∑th
){

1091 
rc
 = 
	`mosquôto_és_£t
(
mosq
, 
cfg
->
ˇfûe
, cfg->
ˇ∑th
, cfg->
˚πfûe
, cfg->
keyfûe
, 
NULL
);

1092 if(
rc
){

1093 if(
rc
 =
MOSQ_ERR_INVAL
){

1094 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLS options: FileÇot found.\n");

1096 
	`îr_¥ötf
(
cfg
, "Eº‹: ProbÀm sëtög TLS o±i⁄s: %s.\n", 
	`mosquôto_°ªº‹
(
rc
));

1098 
	`mosquôto_lib_˛ónup
();

1102 if(
cfg
->
ö£cuª
 && 
	`mosquôto_és_ö£cuª_£t
(
mosq
, 
åue
)){

1103 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLS insecure option.\n");

1104 
	`mosquôto_lib_˛ónup
();

1107 if(
cfg
->
és_ígöe
 && 
	`mosquôto_°rög_›ti⁄
(
mosq
, 
MOSQ_OPT_TLS_ENGINE
, cfg->tls_engine)){

1108 
	`îr_¥ötf
(
cfg
, "Eº‹: ProbÀm sëtög TLSÉngöe, i†%†®vÆidÉngöe?\n", cfg->
és_ígöe
);

1109 
	`mosquôto_lib_˛ónup
();

1112 if(
cfg
->
keyf‹m
 && 
	`mosquôto_°rög_›ti⁄
(
mosq
, 
MOSQ_OPT_TLS_KEYFORM
, cfg->keyform)){

1113 
	`îr_¥ötf
(
cfg
, "Error: Problem setting key form, it must be one of 'pem' or 'engine'.\n");

1114 
	`mosquôto_lib_˛ónup
();

1117 if(
cfg
->
és_ígöe_k∑ss_sha1
 && 
	`mosquôto_°rög_›ti⁄
(
mosq
, 
MOSQ_OPT_TLS_ENGINE_KPASS_SHA1
, cfg->tls_engine_kpass_sha1)){

1118 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLSÉngine keyÖass sha, is itá 40 character hex string?\n");

1119 
	`mosquôto_lib_˛ónup
();

1122 if(
cfg
->
és_Æ≤
 && 
	`mosquôto_°rög_›ti⁄
(
mosq
, 
MOSQ_OPT_TLS_ALPN
, cfg->tls_alpn)){

1123 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLS ALPNÖrotocol.\n");

1124 
	`mosquôto_lib_˛ónup
();

1127 #ifde‡
FINAL_WITH_TLS_PSK


1128 if(
cfg
->
psk
 && 
	`mosquôto_és_psk_£t
(
mosq
, cfg->psk, cfg->
psk_idítôy
, 
NULL
)){

1129 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLS-PSK options.\n");

1130 
	`mosquôto_lib_˛ónup
();

1134 if((
cfg
->
és_vîsi⁄
 || cfg->
cùhîs
Ë&& 
	`mosquôto_és_›ts_£t
(
mosq
, 1, cfg->tls_version, cfg->ciphers)){

1135 
	`îr_¥ötf
(
cfg
, "Error: Problem setting TLS options, checkÅhe optionsáre valid.\n");

1136 
	`mosquôto_lib_˛ónup
();

1140 
	`mosquôto_max_öÊight_mesßges_£t
(
mosq
, 
cfg
->
max_öÊight
);

1141 #ifde‡
WITH_SOCKS


1142 if(
cfg
->
socks5_ho°
){

1143 
rc
 = 
	`mosquôto_socks5_£t
(
mosq
, 
cfg
->
socks5_ho°
, cfg->
socks5_p‹t
, cfg->
socks5_u£∫ame
, cfg->
socks5_∑ssw‹d
);

1144 if(
rc
){

1145 
	`mosquôto_lib_˛ónup
();

1146  
rc
;

1150  
MOSQ_ERR_SUCCESS
;

1151 
	}
}

1153 
	$˛õ¡_id_gíî©e
(
mosq_c⁄fig
 *
cfg
)

1155 if(
cfg
->
id_¥efix
){

1156 
cfg
->
id
 = 
	`mÆloc
(
	`°æí
(cfg->
id_¥efix
)+10);

1157 if(!
cfg
->
id
){

1158 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1159 
	`mosquôto_lib_˛ónup
();

1162 
	`¢¥ötf
(
cfg
->
id
, 
	`°æí
(cfg->
id_¥efix
)+10, "%s%d", cfg->id_¥efix, 
	`gëpid
());

1164  
MOSQ_ERR_SUCCESS
;

1165 
	}
}

1167 
	$˛õ¡_c⁄√˘
(
mosquôto
 *
mosq
, 
mosq_c⁄fig
 *
cfg
)

1169 #i‚de‡
WIN32


1170 *
îr
;

1172 
îr
[1024];

1174 
rc
;

1175 
p‹t
;

1177 if(
cfg
->
p‹t
 < 0){

1178 #ifde‡
WITH_TLS


1179 if(
cfg
->
ˇfûe
 || cfg->
ˇ∑th


1180 #ifde‡
FINAL_WITH_TLS_PSK


1181 || 
cfg
->
psk


1184 
p‹t
 = 8883;

1188 
p‹t
 = 1883;

1191 
p‹t
 = 
cfg
->port;

1194 #ifde‡
WITH_SRV


1195 if(
cfg
->
u£_§v
){

1196 
rc
 = 
	`mosquôto_c⁄√˘_§v
(
mosq
, 
cfg
->
ho°
, cfg->
kì∑live
, cfg->
böd_addªss
);

1198 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, 
cfg
->
ho°
, 
p‹t
, cfg->
kì∑live
, cfg->
böd_addªss
, cfg->
c⁄√˘_¥›s
);

1201 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, 
cfg
->
ho°
, 
p‹t
, cfg->
kì∑live
, cfg->
böd_addªss
, cfg->
c⁄√˘_¥›s
);

1203 if(
rc
>0){

1204 if(
rc
 =
MOSQ_ERR_ERRNO
){

1205 #i‚de‡
WIN32


1206 
îr
 = 
	`°ªº‹
(
î∫o
);

1208 
	`F‹m©Mesßge
(
FORMAT_MESSAGE_FROM_SYSTEM
, 
NULL
, 
î∫o
, 0, (
LPTSTR
)&
îr
, 1024, NULL);

1210 
	`îr_¥ötf
(
cfg
, "Eº‹: %s\n", 
îr
);

1212 
	`îr_¥ötf
(
cfg
, "U«bÀÅÿc⁄√˘ (%s).\n", 
	`mosquôto_°ªº‹
(
rc
));

1214 
	`mosquôto_lib_˛ónup
();

1215  
rc
;

1217  
MOSQ_ERR_SUCCESS
;

1218 
	}
}

1220 #ifde‡
WITH_SOCKS


1222 
	$mosquôto__uædecode
(*
°r
)

1224 
i
, 
j
;

1225 
Àn
;

1226 if(!
°r
)  0;

1228 if(!
	`°rchr
(
°r
, '%'))  0;

1230 
Àn
 = 
	`°æí
(
°r
);

1231 
i
=0; i<
Àn
; i++){

1232 if(
°r
[
i
] == '%'){

1233 if(
i
+2 >
Àn
){

1236 if(
°r
[
i
+1] == '2' && str[i+2] == '5'){

1237 
°r
[
i
] = '%';

1238 
Àn
 -= 2;

1239 
j
=
i
+1; j<
Àn
; j++){

1240 
°r
[
j
] = str[j+2];

1242 
°r
[
j
] = '\0';

1243 }if(
°r
[
i
+1] == '3' && (str[i+2] == 'A' || str[i+2] == 'a')){

1244 
°r
[
i
] = ':';

1245 
Àn
 -= 2;

1246 
j
=
i
+1; j<
Àn
; j++){

1247 
°r
[
j
] = str[j+2];

1249 
°r
[
j
] = '\0';

1250 }if(
°r
[
i
+1] == '4' && str[i+2] == '0'){

1251 
°r
[
i
] = ':';

1252 
Àn
 -= 2;

1253 
j
=
i
+1; j<
Àn
; j++){

1254 
°r
[
j
] = str[j+2];

1256 
°r
[
j
] = '\0';

1263 
	}
}

1265 
	$mosquôto__∑r£_socks_uæ
(
mosq_c⁄fig
 *
cfg
, *
uæ
)

1267 *
°r
;

1268 
size_t
 
i
;

1269 *
u£∫ame
 = 
NULL
, *
∑ssw‹d
 = NULL, *
ho°
 = NULL, *
p‹t
 = NULL;

1270 *
u£∫ame_‹_ho°
 = 
NULL
;

1271 
size_t
 
°¨t
;

1272 
size_t
 
Àn
;

1273 
boﬁ
 
have_auth
 = 
Ál£
;

1274 
p‹t_öt
;

1276 if(!
	`°∫cmp
(
uæ
, "socks5h://", 
	`°æí
("socks5h://"))){

1277 
°r
 = 
uæ
 + 
	`°æí
("socks5h://");

1279 
	`îr_¥ötf
(
cfg
, "Eº‹: Unsuµ‹ãdÖroxyÖrŸocﬁ: %s\n", 
uæ
);

1290 
°¨t
 = 0;

1291 
i
=0; i<
	`°æí
(
°r
); i++){

1292 if(
°r
[
i
] == ':'){

1293 if(
i
 =
°¨t
){

1294 
˛ónup
;

1296 if(
have_auth
){

1299 if(
ho°
){

1301 
˛ónup
;

1303 
Àn
 = 
i
-
°¨t
;

1304 
ho°
 = 
	`mÆloc
(
Àn
 + 1);

1305 if(!
ho°
){

1306 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1307 
˛ónup
;

1309 
	`mem˝y
(
ho°
, &(
°r
[
°¨t
]), 
Àn
);

1310 
ho°
[
Àn
] = '\0';

1311 
°¨t
 = 
i
+1;

1312 }if(!
u£∫ame_‹_ho°
){

1316 
Àn
 = 
i
-
°¨t
;

1317 
u£∫ame_‹_ho°
 = 
	`mÆloc
(
Àn
 + 1);

1318 if(!
u£∫ame_‹_ho°
){

1319 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1320 
˛ónup
;

1322 
	`mem˝y
(
u£∫ame_‹_ho°
, &(
°r
[
°¨t
]), 
Àn
);

1323 
u£∫ame_‹_ho°
[
Àn
] = '\0';

1324 
°¨t
 = 
i
+1;

1326 }if(
°r
[
i
] == '@'){

1327 if(
i
 =
°¨t
){

1328 
˛ónup
;

1330 
have_auth
 = 
åue
;

1331 if(
u£∫ame_‹_ho°
){

1333 
u£∫ame
 = 
u£∫ame_‹_ho°
;

1334 
u£∫ame_‹_ho°
 = 
NULL
;

1336 
Àn
 = 
i
-
°¨t
;

1337 
∑ssw‹d
 = 
	`mÆloc
(
Àn
 + 1);

1338 if(!
∑ssw‹d
){

1339 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1340 
˛ónup
;

1342 
	`mem˝y
(
∑ssw‹d
, &(
°r
[
°¨t
]), 
Àn
);

1343 
∑ssw‹d
[
Àn
] = '\0';

1344 
°¨t
 = 
i
+1;

1348 if(
u£∫ame
){

1350 
˛ónup
;

1352 
Àn
 = 
i
-
°¨t
;

1353 
u£∫ame
 = 
	`mÆloc
(
Àn
 + 1);

1354 if(!
u£∫ame
){

1355 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1356 
˛ónup
;

1358 
	`mem˝y
(
u£∫ame
, &(
°r
[
°¨t
]), 
Àn
);

1359 
u£∫ame
[
Àn
] = '\0';

1360 
°¨t
 = 
i
+1;

1366 if(
i
 > 
°¨t
){

1367 
Àn
 = 
i
-
°¨t
;

1368 if(
ho°
){

1371 
p‹t
 = 
	`mÆloc
(
Àn
 + 1);

1372 if(!
p‹t
){

1373 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1374 
˛ónup
;

1376 
	`mem˝y
(
p‹t
, &(
°r
[
°¨t
]), 
Àn
);

1377 
p‹t
[
Àn
] = '\0';

1378 }if(
u£∫ame_‹_ho°
){

1381 
ho°
 = 
u£∫ame_‹_ho°
;

1382 
u£∫ame_‹_ho°
 = 
NULL
;

1383 
p‹t
 = 
	`mÆloc
(
Àn
 + 1);

1384 if(!
p‹t
){

1385 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1386 
˛ónup
;

1388 
	`mem˝y
(
p‹t
, &(
°r
[
°¨t
]), 
Àn
);

1389 
p‹t
[
Àn
] = '\0';

1391 
ho°
 = 
	`mÆloc
(
Àn
 + 1);

1392 if(!
ho°
){

1393 
	`îr_¥ötf
(
cfg
, "Error: Out of memory.\n");

1394 
˛ónup
;

1396 
	`mem˝y
(
ho°
, &(
°r
[
°¨t
]), 
Àn
);

1397 
ho°
[
Àn
] = '\0';

1401 if(!
ho°
){

1402 
	`îr_¥ötf
(
cfg
, "Error: InvalidÖroxy.\n");

1403 
˛ónup
;

1406 if(
	`mosquôto__uædecode
(
u£∫ame
)){

1407 
˛ónup
;

1409 if(
	`mosquôto__uædecode
(
∑ssw‹d
)){

1410 
˛ónup
;

1412 if(
p‹t
){

1413 
p‹t_öt
 = 
	`©oi
(
p‹t
);

1414 if(
p‹t_öt
 < 1 ||Öort_int > 65535){

1415 
	`îr_¥ötf
(
cfg
, "Eº‹: InvÆidÖroxyÖ‹à%d\n", 
p‹t_öt
);

1416 
˛ónup
;

1418 
	`‰ì
(
p‹t
);

1420 
p‹t_öt
 = 1080;

1423 
cfg
->
socks5_u£∫ame
 = 
u£∫ame
;

1424 
cfg
->
socks5_∑ssw‹d
 = 
∑ssw‹d
;

1425 
cfg
->
socks5_ho°
 = 
ho°
;

1426 
cfg
->
socks5_p‹t
 = 
p‹t_öt
;

1429 
˛ónup
:

1430 
	`‰ì
(
u£∫ame_‹_ho°
);

1431 
	`‰ì
(
u£∫ame
);

1432 
	`‰ì
(
∑ssw‹d
);

1433 
	`‰ì
(
ho°
);

1434 
	`‰ì
(
p‹t
);

1436 
	}
}

1439 
	$îr_¥ötf
(c⁄° 
mosq_c⁄fig
 *
cfg
, c⁄° *
fmt
, ...)

1441 
va_li°
 
va
;

1443 if(
cfg
->
quõt
) ;

1445 
	`va_°¨t
(
va
, 
fmt
);

1446 
	`vÂrötf
(
°dîr
, 
fmt
, 
va
);

1447 
	`va_íd
(
va
);

1448 
	}
}

	@client/client_shared.h

17 #i‚de‡
CLIENT_CONFIG_H


18 
	#CLIENT_CONFIG_H


	)

20 
	~<°dio.h
>

22 #ifde‡
WIN32


23 
	~<wösock2.h
>

25 
	~<sys/time.h
>

29 
	#MSGMODE_NONE
 0

	)

30 
	#MSGMODE_CMD
 1

	)

31 
	#MSGMODE_STDIN_LINE
 2

	)

32 
	#MSGMODE_STDIN_FILE
 3

	)

33 
	#MSGMODE_FILE
 4

	)

34 
	#MSGMODE_NULL
 5

	)

36 
	#CLIENT_PUB
 1

	)

37 
	#CLIENT_SUB
 2

	)

38 
	#CLIENT_RR
 3

	)

39 
	#CLIENT_RESPONSE_TOPIC
 4

	)

41 
	smosq_c⁄fig
 {

42 *
	mid
;

43 *
	mid_¥efix
;

44 
	m¥Ÿocﬁ_vîsi⁄
;

45 
	mkì∑live
;

46 *
	mho°
;

47 
	mp‹t
;

48 
	mqos
;

49 
boﬁ
 
	mªèö
;

50 
	mpub_mode
;

51 *
	mfûe_öput
;

52 *
	mmesßge
;

53 
	mmsgÀn
;

54 *
	mt›ic
;

55 *
	mböd_addªss
;

56 
	mª≥©_cou¡
;

57 
timevÆ
 
	mª≥©_dñay
;

58 #ifde‡
WITH_SRV


59 
boﬁ
 
	mu£_§v
;

61 
boﬁ
 
	mdebug
;

62 
boﬁ
 
	mquõt
;

63 
	mmax_öÊight
;

64 *
	mu£∫ame
;

65 *
	m∑ssw‹d
;

66 *
	mwûl_t›ic
;

67 *
	mwûl_∑ylﬂd
;

68 
	mwûl_∑ylﬂdÀn
;

69 
	mwûl_qos
;

70 
boﬁ
 
	mwûl_ªèö
;

71 #ifde‡
WITH_TLS


72 *
	mˇfûe
;

73 *
	mˇ∑th
;

74 *
	m˚πfûe
;

75 *
	mkeyfûe
;

76 *
	mcùhîs
;

77 
boﬁ
 
	mö£cuª
;

78 *
	més_Æ≤
;

79 *
	més_vîsi⁄
;

80 *
	més_ígöe
;

81 *
	més_ígöe_k∑ss_sha1
;

82 *
	mkeyf‹m
;

83 #ifde‡
FINAL_WITH_TLS_PSK


84 *
	mpsk
;

85 *
	mpsk_idítôy
;

88 
boﬁ
 
	m˛ón_£ssi⁄
;

89 **
	mt›ics
;

90 
	mt›ic_cou¡
;

91 
boﬁ
 
	mexô_a·î_sub
;

92 
boﬁ
 
	mno_ªèö
;

93 
boﬁ
 
	mªèöed_⁄ly
;

94 
boﬁ
 
	mªmove_ªèöed
;

95 **
	mfûãr_outs
;

96 
	mfûãr_out_cou¡
;

97 **
	munsub_t›ics
;

98 
	munsub_t›ic_cou¡
;

99 
boﬁ
 
	mvîbo£
;

100 
boﬁ
 
	meﬁ
;

101 
	mmsg_cou¡
;

102 *
	mf‹m©
;

103 
	mtimeout
;

104 
	msub_›ts
;

105 #ifde‡
WITH_SOCKS


106 *
	msocks5_ho°
;

107 
	msocks5_p‹t
;

108 *
	msocks5_u£∫ame
;

109 *
	msocks5_∑ssw‹d
;

111 
mosquôto_¥›îty
 *
	mc⁄√˘_¥›s
;

112 
mosquôto_¥›îty
 *
	mpublish_¥›s
;

113 
mosquôto_¥›îty
 *
	msubs¸ibe_¥›s
;

114 
mosquôto_¥›îty
 *
	munsubs¸ibe_¥›s
;

115 
mosquôto_¥›îty
 *
	mdisc⁄√˘_¥›s
;

116 
mosquôto_¥›îty
 *
	mwûl_¥›s
;

117 
boﬁ
 
	mhave_t›ic_Æüs
;

118 *
	mª•⁄£_t›ic
;

121 
˛õ¡_c⁄fig_lﬂd
(
mosq_c⁄fig
 *
c⁄fig
, 
pub_‹_sub
, 
¨gc
, *
¨gv
[]);

122 
˛õ¡_c⁄fig_˛ónup
(
mosq_c⁄fig
 *
cfg
);

123 
˛õ¡_›ts_£t
(
mosquôto
 *
mosq
, 
mosq_c⁄fig
 *
cfg
);

124 
˛õ¡_id_gíî©e
(
mosq_c⁄fig
 *
cfg
);

125 
˛õ¡_c⁄√˘
(
mosquôto
 *
mosq
, 
mosq_c⁄fig
 *
cfg
);

127 
cfg_∑r£_¥›îty
(
mosq_c⁄fig
 *
cfg
, 
¨gc
, *
¨gv
[], *
idx
);

129 
îr_¥ötf
(c⁄° 
mosq_c⁄fig
 *
cfg
, c⁄° *
fmt
, ...);

	@client/pub_client.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 #i‚de‡
WIN32


25 
	~<sys/time.h
>

26 
	~<time.h
>

28 
	~<¥o˚ss.h
>

29 
	~<wösock2.h
>

30 
	#¢¥ötf
 
•rötf_s


	)

33 
	~<mqâ_¥Ÿocﬁ.h
>

34 
	~<mosquôto.h
>

35 
	~"˛õ¡_sh¨ed.h
"

36 
	~"pub_sh¨ed.h
"

40 
boﬁ
 
	gfú°_publish
 = 
åue
;

41 
	gœ°_mid
 = -1;

42 
	gœ°_mid_£¡
 = -1;

43 *
	glöe_buf
 = 
NULL
;

44 
	glöe_buf_Àn
 = 1024;

45 
boﬁ
 
	gdisc⁄√˘_£¡
 = 
Ál£
;

46 
	gpublish_cou¡
 = 0;

47 
boﬁ
 
	gªady_f‹_ª≥©
 = 
Ál£
;

49 #ifde‡
WIN32


50 
uöt64_t
 
	g√xt_publish_tv
;

52 
	$£t_ª≥©_time
()

54 
uöt64_t
 
ticks
 = 
	`GëTickCou¡64
();

55 
√xt_publish_tv
 = 
ticks
 + 
cfg
.
ª≥©_dñay
.
tv_£c
*1000 + cfg.ª≥©_dñay.
tv_u£c
/1000;

56 
	}
}

58 
	$check_ª≥©_time
()

60 
uöt64_t
 
ticks
 = 
	`GëTickCou¡64
();

62 if(
ticks
 > 
√xt_publish_tv
){

67 
	}
}

70 
timevÆ
 
	g√xt_publish_tv
;

72 
	$£t_ª≥©_time
()

74 
	`gëtimeofday
(&
√xt_publish_tv
, 
NULL
);

75 
√xt_publish_tv
.
tv_£c
 +
cfg
.
ª≥©_dñay
.tv_sec;

76 
√xt_publish_tv
.
tv_u£c
 +
cfg
.
ª≥©_dñay
.tv_usec;

78 
√xt_publish_tv
.
tv_£c
 +√xt_publish_tv.
tv_u£c
/1e6;

79 
√xt_publish_tv
.
tv_u£c
 =Çext_publish_tv.tv_usec%1000000;

80 
	}
}

82 
	$check_ª≥©_time
()

84 
timevÆ
 
tv
;

86 
	`gëtimeofday
(&
tv
, 
NULL
);

88 if(
tv
.
tv_£c
 > 
√xt_publish_tv
.tv_sec){

90 }if(
tv
.
tv_£c
 =
√xt_publish_tv
.tv_sec

91 && 
tv
.
tv_u£c
 > 
√xt_publish_tv
.tv_usec){

96 
	}
}

99 
	$my_disc⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
rc
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

101 
	`UNUSED
(
mosq
);

102 
	`UNUSED
(
obj
);

103 
	`UNUSED
(
rc
);

104 
	`UNUSED
(
¥›îtõs
);

106 if(
rc
 == 0){

107 
°©us
 = 
STATUS_DISCONNECTED
;

109 
	}
}

111 
	$my_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

113 
ªady_f‹_ª≥©
 = 
Ál£
;

114 if(
cfg
.
¥Ÿocﬁ_vîsi⁄
 =
MQTT_PROTOCOL_V5
 && cfg.
have_t›ic_Æüs
 && 
fú°_publish
 =
Ál£
){

115  
	`mosquôto_publish_v5
(
mosq
, 
mid
, 
NULL
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
cfg
.
publish_¥›s
);

117 
fú°_publish
 = 
Ál£
;

118  
	`mosquôto_publish_v5
(
mosq
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
cfg
.
publish_¥›s
);

120 
	}
}

123 
	$my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

125 
rc
 = 
MOSQ_ERR_SUCCESS
;

127 
	`UNUSED
(
obj
);

128 
	`UNUSED
(
Êags
);

129 
	`UNUSED
(
¥›îtõs
);

131 if(!
ªsu…
){

132 
cfg
.
pub_mode
){

133 
MSGMODE_CMD
:

134 
MSGMODE_FILE
:

135 
MSGMODE_STDIN_FILE
:

136 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, cfg.
msgÀn
, cfg.
mesßge
, cfg.
qos
, cfg.
ªèö
);

138 
MSGMODE_NULL
:

139 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, 0, 
NULL
, cfg.
qos
, cfg.
ªèö
);

141 
MSGMODE_STDIN_LINE
:

142 
°©us
 = 
STATUS_CONNACK_RECVD
;

145 if(
rc
){

146 
rc
){

147 
MOSQ_ERR_INVAL
:

148 
	`îr_¥ötf
(&
cfg
, "Error: Invalid input. Does yourÅopic contain '+' or '#'?\n");

150 
MOSQ_ERR_NOMEM
:

151 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory whenÅryingÅoÖublish message.\n");

153 
MOSQ_ERR_NO_CONN
:

154 
	`îr_¥ötf
(&
cfg
, "Error: ClientÇot connected whenÅryingÅoÖublish.\n");

156 
MOSQ_ERR_PROTOCOL
:

157 
	`îr_¥ötf
(&
cfg
, "Error: ProtocolÉrror when communicating with broker.\n");

159 
MOSQ_ERR_PAYLOAD_SIZE
:

160 
	`îr_¥ötf
(&
cfg
, "Error: MessageÖayload isÅooÜarge.\n");

162 
MOSQ_ERR_QOS_NOT_SUPPORTED
:

163 
	`îr_¥ötf
(&
cfg
, "Error: Message QoSÇot supported on broker,ÅryáÜower QoS.\n");

166 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

169 if(
ªsu…
){

170 if(
cfg
.
¥Ÿocﬁ_vîsi⁄
 =
MQTT_PROTOCOL_V5
){

171 if(
ªsu…
 =
MQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
){

172 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s. Try c⁄√˘ögÅÿ™ MQTT v5 brokî, o∏u£ MQTT v3.x mode.\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

174 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

177 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s\n", 
	`mosquôto_c⁄«ck_°rög
(
ªsu…
));

179 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

182 
	}
}

185 
	$my_publish_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

187 
	`UNUSED
(
obj
);

188 
	`UNUSED
(
¥›îtõs
);

190 
œ°_mid_£¡
 = 
mid
;

191 if(
ªas⁄_code
 > 127){

192 
	`îr_¥ötf
(&
cfg
, "W¨nög: Publish %d faûed: %s.\n", 
mid
, 
	`mosquôto_ªas⁄_°rög
(
ªas⁄_code
));

194 
publish_cou¡
++;

196 if(
cfg
.
pub_mode
 =
MSGMODE_STDIN_LINE
){

197 if(
mid
 =
œ°_mid
){

198 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

199 
disc⁄√˘_£¡
 = 
åue
;

201 }if(
publish_cou¡
 < 
cfg
.
ª≥©_cou¡
){

202 
ªady_f‹_ª≥©
 = 
åue
;

203 
	`£t_ª≥©_time
();

204 }if(
disc⁄√˘_£¡
 =
Ál£
){

205 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

206 
disc⁄√˘_£¡
 = 
åue
;

208 
	}
}

211 
	$pub_sh¨ed_öô
()

213 
löe_buf
 = 
	`mÆloc
(
löe_buf_Àn
);

214 if(!
löe_buf
){

215 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

219 
	}
}

222 
	$pub_sh¨ed_lo›
(
mosquôto
 *
mosq
)

224 
ªad_Àn
;

225 
pos
;

226 
rc
, 
rc2
;

227 *
buf2
;

228 
buf_Àn_a˘uÆ
;

229 
mode
;

230 
lo›_dñay
 = 1000;

231 
boﬁ
 
°dö_föished
 = 
Ál£
;

233 if(
cfg
.
ª≥©_cou¡
 > 1 && (cfg.
ª≥©_dñay
.
tv_£c
 =0 || cfg.ª≥©_dñay.
tv_u£c
 != 0)){

234 
lo›_dñay
 = 
cfg
.
ª≥©_dñay
.
tv_u£c
 / 2000;

237 
mode
 = 
cfg
.
pub_mode
;

239 if(
mode
 =
MSGMODE_STDIN_LINE
){

240 
	`mosquôto_lo›_°¨t
(
mosq
);

241 
°dö_föished
 = 
Ál£
;

245 if(
mode
 =
MSGMODE_STDIN_LINE
){

246 if(
°©us
 =
STATUS_CONNACK_RECVD
){

247 
pos
 = 0;

248 
ªad_Àn
 = 
löe_buf_Àn
;

249 
°©us
 =
STATUS_CONNACK_RECVD
 && 
	`fgës
(&
löe_buf
[
pos
], 
ªad_Àn
, 
°dö
)){

250 
buf_Àn_a˘uÆ
 = 
	`°æí
(
löe_buf
);

251 if(
löe_buf
[
buf_Àn_a˘uÆ
-1] == '\n'){

252 
löe_buf
[
buf_Àn_a˘uÆ
-1] = '\0';

253 
rc2
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, 
buf_Àn_a˘uÆ
-1, 
löe_buf
, cfg.
qos
, cfg.
ªèö
);

254 if(
rc2
){

255 
	`îr_¥ötf
(&
cfg
, "Eº‹: PublishÑëu∫ed %d, disc⁄√˘ög.\n", 
rc2
);

256 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 
MQTT_RC_DISCONNECT_WITH_WILL_MSG
, 
cfg
.
disc⁄√˘_¥›s
);

260 
löe_buf_Àn
 += 1024;

261 
pos
 += 1023;

262 
ªad_Àn
 = 1024;

263 
buf2
 = 
	`ªÆloc
(
löe_buf
, 
löe_buf_Àn
);

264 if(!
buf2
){

265 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

266  
MOSQ_ERR_NOMEM
;

268 
löe_buf
 = 
buf2
;

271 if(
	`„of
(
°dö
)){

272 if(
mid_£¡
 == -1){

274 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

275 
disc⁄√˘_£¡
 = 
åue
;

276 
°©us
 = 
STATUS_DISCONNECTING
;

278 
œ°_mid
 = 
mid_£¡
;

279 
°©us
 = 
STATUS_WAITING
;

281 
°dö_föished
 = 
åue
;

282 }if(
°©us
 =
STATUS_DISCONNECTED
){

286 }if(
°©us
 =
STATUS_WAITING
){

287 if(
œ°_mid_£¡
 =
œ°_mid
 && 
disc⁄√˘_£¡
 =
Ál£
){

288 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

289 
disc⁄√˘_£¡
 = 
åue
;

291 #ifde‡
WIN32


292 
	`SÀï
(100);

294 
time•ec
 
ts
;

295 
ts
.
tv_£c
 = 0;

296 
ts
.
tv_n£c
 = 100000000;

297 
	`«no¶ìp
(&
ts
, 
NULL
);

300 
rc
 = 
MOSQ_ERR_SUCCESS
;

302 
rc
 = 
	`mosquôto_lo›
(
mosq
, 
lo›_dñay
, 1);

303 if(
ªady_f‹_ª≥©
 && 
	`check_ª≥©_time
()){

304 
rc
 = 0;

305 
cfg
.
pub_mode
){

306 
MSGMODE_CMD
:

307 
MSGMODE_FILE
:

308 
MSGMODE_STDIN_FILE
:

309 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, cfg.
msgÀn
, cfg.
mesßge
, cfg.
qos
, cfg.
ªèö
);

311 
MSGMODE_NULL
:

312 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, 0, 
NULL
, cfg.
qos
, cfg.
ªèö
);

314 
MSGMODE_STDIN_LINE
:

317 if(
rc
){

318 
	`îr_¥ötf
(&
cfg
, "Eº‹ sídögÑïóàpublish: %s", 
	`mosquôto_°ªº‹
(
rc
));

322 }
rc
 =
MOSQ_ERR_SUCCESS
 && 
°dö_föished
 =
Ál£
);

324 if(
mode
 =
MSGMODE_STDIN_LINE
){

325 
	`mosquôto_lo›_°›
(
mosq
, 
Ál£
);

327 if(
°©us
 =
STATUS_DISCONNECTED
){

328  
MOSQ_ERR_SUCCESS
;

330  
rc
;

332 
	}
}

335 
	$pub_sh¨ed_˛ónup
()

337 
	`‰ì
(
löe_buf
);

338 
	}
}

341 
	$¥öt_ußge
()

343 
maj‹
, 
mö‹
, 
ªvisi⁄
;

345 
	`mosquôto_lib_vîsi⁄
(&
maj‹
, &
mö‹
, &
ªvisi⁄
);

346 
	`¥ötf
("mosquitto_pub isá simple mqtt clientÅhat willÖublishá message oná singleÅopicándÉxit.\n");

347 
	`¥ötf
("mosquôto_pub vîsi⁄ %†ru¬ög o¿libmosquôtÿ%d.%d.%d.\n\n", 
VERSION
, 
maj‹
, 
mö‹
, 
ªvisi⁄
);

348 
	`¥ötf
("Usage: mosquitto_pub {[-h host] [-pÖort] [-u username] [-PÖassword] -tÅopic | -L URL}\n");

349 
	`¥ötf
(" {-f file | -l | -n | -m message}\n");

350 
	`¥ötf
(" [-c] [-k keepalive] [-q qos] [-r] [--repeat N] [--repeat-delayÅime]\n");

351 #ifde‡
WITH_SRV


352 
	`¥ötf
(" [-A bind_address] [-S]\n");

354 
	`¥ötf
(" [-A bind_address]\n");

356 
	`¥ötf
(" [-i id] [-I id_prefix]\n");

357 
	`¥ötf
(" [-d] [--quiet]\n");

358 
	`¥ötf
(" [-M max_inflight]\n");

359 
	`¥ötf
(" [-u username [-PÖassword]]\n");

360 
	`¥ötf
(" [--will-topic [--will-payloadÖayload] [--will-qos qos] [--will-retain]]\n");

361 #ifde‡
WITH_TLS


362 
	`¥ötf
(" [{--cafile file | --capath dir} [--cert file] [--key file]\n");

363 
	`¥ötf
(" [--ciphers ciphers] [--insecure]\n");

364 
	`¥ötf
(" [--tls-alpnÖrotocol]\n");

365 
	`¥ötf
(" [--tls-engineÉngine] [--keyform keyform] [--tls-engine-kpass-sha1]]\n");

366 #ifde‡
FINAL_WITH_TLS_PSK


367 
	`¥ötf
(" [--psk hex-key --psk-identity identity [--ciphers ciphers]]\n");

370 #ifde‡
WITH_SOCKS


371 
	`¥ötf
(" [--proxy socks-url]\n");

373 
	`¥ötf
(" [--property command identifier value]\n");

374 
	`¥ötf
(" [-D command identifier value]\n");

375 
	`¥ötf
(" mosquitto_pub --help\n\n");

376 
	`¥ötf
(" -A : bindÅhe outgoing socketÅoÅhis host/ipáddress. UseÅo control which interface\n");

377 
	`¥ötf
("Åhe client communicates over.\n");

378 
	`¥ötf
(" -d :Énable debug messages.\n");

379 
	`¥ötf
(" -D : Define MQTT v5Öroperties. SeeÅhe documentation for more details.\n");

380 
	`¥ötf
(" -f : sendÅhe contents ofá fileásÅhe message.\n");

381 
	`¥ötf
(" -h : mqtt hostÅo connectÅo. DefaultsÅoÜocalhost.\n");

382 
	`¥ötf
(" -i : idÅo use forÅhis client. DefaultsÅo mosquitto_pub_áppended withÅheÖrocess id.\n");

383 
	`¥ötf
(" -I : defineÅhe client idás id_prefixáppended withÅheÖrocess id. Useful for whenÅhe\n");

384 
	`¥ötf
(" broker is usingÅhe clientid_prefixes option.\n");

385 
	`¥ötf
(" -k : keepálive in seconds forÅhis client. DefaultsÅo 60.\n");

386 
	`¥ötf
(" -L : specify user,Öassword, hostname,ÖortándÅopicásá URL inÅhe form:\n");

387 
	`¥ötf
(" mqtt(s)://[username[:password]@]host[:port]/topic\n");

388 
	`¥ötf
(" -l :Ñead messages from stdin, sendingá separate message forÉachÜine.\n");

389 
	`¥ötf
(" -m : messageÖayloadÅo send.\n");

390 
	`¥ötf
(" -M :Åhe maximum inflight messages for QoS 1/2..\n");

391 
	`¥ötf
(" -n : sendáÇull (zeroÜength) message.\n");

392 
	`¥ötf
(" -p :ÇetworkÖortÅo connectÅo. DefaultsÅo 1883 forÖlain MQTTánd 8883 for MQTT over TLS.\n");

393 
	`¥ötf
(" -P :ÖrovideáÖassword\n");

394 
	`¥ötf
(" -q : quality of serviceÜevelÅo use foráll messages. DefaultsÅo 0.\n");

395 
	`¥ötf
(" -r : message should beÑetained.\n");

396 
	`¥ötf
(" -s :Ñead message from stdin, sendingÅheÉntire inputásá message.\n");

397 #ifde‡
WITH_SRV


398 
	`¥ötf
(" -S : use SRVÜookupsÅo determine which hostÅo connectÅo.\n");

400 
	`¥ötf
(" -t : mqttÅopicÅoÖublishÅo.\n");

401 
	`¥ötf
(" -u :Örovideá username\n");

402 
	`¥ötf
(" -V : specifyÅhe version ofÅhe MQTTÖrotocolÅo use when connecting.\n");

403 
	`¥ötf
(" Can be mqttv5, mqttv311 or mqttv31. DefaultsÅo mqttv311.\n");

404 
	`¥ötf
(" --help : displayÅhis message.\n");

405 
	`¥ötf
(" --repeat : ifÖublish mode is -f, -m, or -s,ÅhenÑepeatÅheÖublish NÅimes.\n");

406 
	`¥ötf
(" --repeat-delay : if using --repeat, waitÅime seconds betweenÖublishes. DefaultsÅo 0.\n");

407 
	`¥ötf
(" --quiet : don'tÖrintÉrror messages.\n");

408 
	`¥ötf
(" --will-payload :Öayload forÅhe client Will, which is sent byÅhe broker in case of\n");

409 
	`¥ötf
(" unexpected disconnection. IfÇot givenánd will-topic is set,á zero\n");

410 
	`¥ötf
("Üength message will be sent.\n");

411 
	`¥ötf
(" --will-qos : QoSÜevel forÅhe client Will.\n");

412 
	`¥ötf
(" --will-retain : if given, makeÅhe client WillÑetained.\n");

413 
	`¥ötf
(" --will-topic :ÅheÅopic on whichÅoÖublishÅhe client Will.\n");

414 #ifde‡
WITH_TLS


415 
	`¥ötf
(" --cafile :ÖathÅoá file containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

416 
	`¥ötf
(" communication.\n");

417 
	`¥ötf
(" --capath :ÖathÅoá directory containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

418 
	`¥ötf
(" communication.\n");

419 
	`¥ötf
(" --cert : client certificate foráuthentication, ifÑequired by server.\n");

420 
	`¥ötf
(" --key : clientÖrivate key foráuthentication, ifÑequired by server.\n");

421 
	`¥ötf
(" --keyform : keyfileÅype, can beÉither \"pem\" or \"engine\".\n");

422 
	`¥ötf
(" --ciphers : openssl compatibleÜist of TLS ciphersÅo support.\n");

423 
	`¥ötf
(" --tls-version : TLSÖrotocol version, can be one ofÅlsv1.3Ålsv1.2 orÅlsv1.1.\n");

424 
	`¥ötf
(" DefaultsÅoÅlsv1.2 ifávailable.\n");

425 
	`¥ötf
(" --insecure : doÇot checkÅhatÅhe server certificate hostname matchesÅheÑemote\n");

426 
	`¥ötf
(" hostname. UsingÅhis option meansÅhat you cannot be sureÅhatÅhe\n");

427 
	`¥ötf
("Ñemote host isÅhe server you wishÅo connectÅoánd so is insecure.\n");

428 
	`¥ötf
(" DoÇot useÅhis option ináÖroductionÉnvironment.\n");

429 
	`¥ötf
(" --tls-engine : If set,ÉnablesÅhe use ofá TLSÉngine device.\n");

430 
	`¥ötf
(" --tls-engine-kpass-sha1 : SHA1 ofÅhe keyÖasswordÅo be used withÅhe selected SSLÉngine.\n");

431 #ifde‡
FINAL_WITH_TLS_PSK


432 
	`¥ötf
(" --psk :Öre-shared-key in hexadecimal (noÜeading 0x)ÅoÉnable TLS-PSK mode.\n");

433 
	`¥ötf
(" --psk-identity : client identity string for TLS-PSK mode.\n");

436 #ifde‡
WITH_SOCKS


437 
	`¥ötf
(" --proxy : SOCKS5Öroxy URL ofÅhe form:\n");

438 
	`¥ötf
(" socks5h://[username[:password]@]hostname[:port]\n");

439 
	`¥ötf
(" Only \"none\"ánd \"username\"áuthentication is supported.\n");

441 
	`¥ötf
("\nSee https://mosquitto.org/ for more information.\n\n");

442 
	}
}

444 
	$maö
(
¨gc
, *
¨gv
[])

446 
mosquôto
 *
mosq
 = 
NULL
;

447 
rc
;

449 
	`mosquôto_lib_öô
();

451 if(
	`pub_sh¨ed_öô
())  1;

453 
rc
 = 
	`˛õ¡_c⁄fig_lﬂd
(&
cfg
, 
CLIENT_PUB
, 
¨gc
, 
¨gv
);

454 if(
rc
){

455 if(
rc
 == 2){

457 
	`¥öt_ußge
();

459 
	`Ârötf
(
°dîr
, "\nUse 'mosquitto_pub --help'Åo see usage.\n");

461 
˛ónup
;

464 #i‚de‡
WITH_THREADING


465 if(
cfg
.
pub_mode
 =
MSGMODE_STDIN_LINE
){

466 
	`Ârötf
(
°dîr
, "Error: '-l' modeÇotávailable,Åhreading support hasÇot been compiled in.\n");

467 
˛ónup
;

471 if(
cfg
.
pub_mode
 =
MSGMODE_STDIN_FILE
){

472 if(
	`lﬂd_°dö
()){

473 
	`îr_¥ötf
(&
cfg
, "ErrorÜoading input from stdin.\n");

474 
˛ónup
;

476 }if(
cfg
.
fûe_öput
){

477 if(
	`lﬂd_fûe
(
cfg
.
fûe_öput
)){

478 
	`îr_¥ötf
(&
cfg
, "Eº‹Üﬂdög i≈uàfûê\"%s\".\n", cfg.
fûe_öput
);

479 
˛ónup
;

483 if(!
cfg
.
t›ic
 || cfg.
pub_mode
 =
MSGMODE_NONE
){

484 
	`Ârötf
(
°dîr
, "Error: BothÅopicánd message must be supplied.\n");

485 
	`¥öt_ußge
();

486 
˛ónup
;

490 if(
	`˛õ¡_id_gíî©e
(&
cfg
)){

491 
˛ónup
;

494 
mosq
 = 
	`mosquôto_√w
(
cfg
.
id
, cfg.
˛ón_£ssi⁄
, 
NULL
);

495 if(!
mosq
){

496 
î∫o
){

497 
ENOMEM
:

498 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

500 
EINVAL
:

501 
	`îr_¥ötf
(&
cfg
, "Error: Invalid id.\n");

504 
˛ónup
;

506 if(
cfg
.
debug
){

507 
	`mosquôto_log_ˇŒback_£t
(
mosq
, 
my_log_ˇŒback
);

509 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
my_c⁄√˘_ˇŒback
);

510 
	`mosquôto_disc⁄√˘_v5_ˇŒback_£t
(
mosq
, 
my_disc⁄√˘_ˇŒback
);

511 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
my_publish_ˇŒback
);

513 if(
	`˛õ¡_›ts_£t
(
mosq
, &
cfg
)){

514 
˛ónup
;

517 
rc
 = 
	`˛õ¡_c⁄√˘
(
mosq
, &
cfg
);

518 if(
rc
){

519 
˛ónup
;

522 
rc
 = 
	`pub_sh¨ed_lo›
(
mosq
);

524 if(
cfg
.
mesßge
 && cfg.
pub_mode
 =
MSGMODE_FILE
){

525 
	`‰ì
(
cfg
.
mesßge
);

526 
cfg
.
mesßge
 = 
NULL
;

528 
	`mosquôto_de°roy
(
mosq
);

529 
	`mosquôto_lib_˛ónup
();

530 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

531 
	`pub_sh¨ed_˛ónup
();

533 if(
rc
){

534 
	`îr_¥ötf
(&
cfg
, "Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

536  
rc
;

538 
˛ónup
:

539 
	`mosquôto_lib_˛ónup
();

540 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

541 
	`pub_sh¨ed_˛ónup
();

543 
	}
}

	@client/pub_shared.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 #i‚de‡
WIN32


25 
	~<time.h
>

27 
	~<¥o˚ss.h
>

28 
	~<wösock2.h
>

29 
	#¢¥ötf
 
•rötf_s


	)

32 
	~<mosquôto.h
>

33 
	~<mqâ_¥Ÿocﬁ.h
>

34 
	~"˛õ¡_sh¨ed.h
"

35 
	~"pub_sh¨ed.h
"

39 
	gmid_£¡
 = -1;

40 
	g°©us
 = 
STATUS_CONNECTING
;

41 
mosq_c⁄fig
 
	gcfg
;

43 
	$my_log_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
Àvñ
, c⁄° *
°r
)

45 
	`UNUSED
(
mosq
);

46 
	`UNUSED
(
obj
);

47 
	`UNUSED
(
Àvñ
);

49 
	`¥ötf
("%s\n", 
°r
);

50 
	}
}

52 
	$lﬂd_°dö
()

54 
pos
 = 0, 
æí
;

55 
buf
[1024];

56 *
aux_mesßge
 = 
NULL
;

58 
cfg
.
pub_mode
 = 
MSGMODE_STDIN_FILE
;

60 !
	`„of
(
°dö
)){

61 
æí
 = 
	`‰ód
(
buf
, 1, 1024, 
°dö
);

62 
aux_mesßge
 = 
	`ªÆloc
(
cfg
.
mesßge
, 
pos
+
æí
);

63 if(!
aux_mesßge
){

64 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

65 
	`‰ì
(
cfg
.
mesßge
);

69 
cfg
.
mesßge
 = 
aux_mesßge
;

71 
	`mem˝y
(&(
cfg
.
mesßge
[
pos
]), 
buf
, 
æí
);

72 
pos
 +
æí
;

74 
cfg
.
msgÀn
 = 
pos
;

76 if(!
cfg
.
msgÀn
){

77 
	`îr_¥ötf
(&
cfg
, "Error: ZeroÜength input.\n");

82 
	}
}

84 
	$lﬂd_fûe
(c⁄° *
fûíame
)

86 
pos
, 
æí
;

87 
FILE
 *
Âå
 = 
NULL
;

89 
Âå
 = 
	`f›í
(
fûíame
, "rb");

90 if(!
Âå
){

91 
	`îr_¥ötf
(&
cfg
, "Eº‹: U«bÀÅÿ›í fûê\"%s\".\n", 
fûíame
);

94 
cfg
.
pub_mode
 = 
MSGMODE_FILE
;

95 
	`f£ek
(
Âå
, 0, 
SEEK_END
);

96 
cfg
.
msgÀn
 = 
	`·ñl
(
Âå
);

97 if(
cfg
.
msgÀn
 > 268435455){

98 
	`f˛o£
(
Âå
);

99 
	`îr_¥ötf
(&
cfg
, "Eº‹: Fûê\"%s\" i†toÿœrgê(>268,435,455 byãs).\n", 
fûíame
);

101 }if(
cfg
.
msgÀn
 == 0){

102 
	`f˛o£
(
Âå
);

103 
	`îr_¥ötf
(&
cfg
, "Eº‹: Fûê\"%s\" i†em±y.\n", 
fûíame
);

105 }if(
cfg
.
msgÀn
 < 0){

106 
	`f˛o£
(
Âå
);

107 
	`îr_¥ötf
(&
cfg
, "Eº‹: U«bÀÅÿdëîmöêsizêo‡fûê\"%s\".\n", 
fûíame
);

110 
	`f£ek
(
Âå
, 0, 
SEEK_SET
);

111 
cfg
.
mesßge
 = 
	`mÆloc
(cfg.
msgÀn
);

112 if(!
cfg
.
mesßge
){

113 
	`f˛o£
(
Âå
);

114 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

117 
pos
 = 0;

118 
pos
 < 
cfg
.
msgÀn
){

119 
æí
 = 
	`‰ód
(&(
cfg
.
mesßge
[
pos
]), (), cfg.
msgÀn
-pos, 
Âå
);

120 
pos
 +
æí
;

122 
	`f˛o£
(
Âå
);

124 
	}
}

	@client/pub_shared.h

16 #i‚de‡
PUB_SHARED_H


17 
	#PUB_SHARED_H


	)

19 
	#STATUS_CONNECTING
 0

	)

20 
	#STATUS_CONNACK_RECVD
 1

	)

21 
	#STATUS_WAITING
 2

	)

22 
	#STATUS_DISCONNECTING
 3

	)

23 
	#STATUS_DISCONNECTED
 4

	)

25 
mid_£¡
;

26 
°©us
;

27 
mosq_c⁄fig
 
cfg
;

30 
my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

31 
my_disc⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
rc
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

32 
my_publish_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

33 
my_log_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
Àvñ
, c⁄° *
°r
);

34 
lﬂd_°dö
();

35 
lﬂd_fûe
(c⁄° *
fûíame
);

37 
my_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
);

39 
pub_sh¨ed_öô
();

40 
pub_sh¨ed_lo›
(
mosquôto
 *
mosq
);

41 
pub_sh¨ed_˛ónup
();

	@client/rr_client.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<time.h
>

25 #i‚de‡
WIN32


26 
	~<uni°d.h
>

27 
	~<sig«l.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	#¢¥ötf
 
•rötf_s


	)

34 
	~<mosquôto.h
>

35 
	~<mqâ_¥Ÿocﬁ.h
>

36 
	~"˛õ¡_sh¨ed.h
"

37 
	~"pub_sh¨ed.h
"

39 
	eº__°©e
 {

40 
	mº_s_√w
,

41 
	mº_s_c⁄√˘ed
,

42 
	mº_s_subs¸ibed
,

43 
	mº_s_ªady_to_publish
,

44 
	mº_s_waô_f‹_ª•⁄£
,

45 
	mº_s_disc⁄√˘


48 
º__°©e
 
	g˛õ¡_°©e
 = 
º_s_√w
;

50 
mosq_c⁄fig
 
	gcfg
;

51 
boﬁ
 
	g¥o˚ss_mesßges
 = 
åue
;

52 
	gmsg_cou¡
 = 0;

53 
mosquôto
 *
	gmosq
 = 
NULL
;

55 #i‚de‡
WIN32


56 
	$my_sig«l_h™dÀr
(
signum
)

58 if(
signum
 =
SIGALRM
){

59 
¥o˚ss_mesßges
 = 
Ál£
;

60 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 
MQTT_RC_DISCONNECT_WITH_WILL_MSG
, 
cfg
.
disc⁄√˘_¥›s
);

62 
	}
}

65 
¥öt_mesßge
(
mosq_c⁄fig
 *
cfg
, c⁄° 
mosquôto_mesßge
 *
mesßge
);

68 
	$my_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

70  
	`mosquôto_publish_v5
(
mosq
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
cfg
.
publish_¥›s
);

71 
	}
}

74 
	$my_mesßge_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
mesßge
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

76 
	`¥öt_mesßge
(&
cfg
, 
mesßge
);

77 
cfg
.
pub_mode
){

78 
MSGMODE_CMD
:

79 
MSGMODE_FILE
:

80 
MSGMODE_STDIN_FILE
:

81 
MSGMODE_NULL
:

82 
˛õ¡_°©e
 = 
º_s_disc⁄√˘
;

84 
MSGMODE_STDIN_LINE
:

85 
˛õ¡_°©e
 = 
º_s_ªady_to_publish
;

115 
	}
}

117 
	$my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

119 if(!
ªsu…
){

120 
˛õ¡_°©e
 = 
º_s_c⁄√˘ed
;

121 
	`mosquôto_subs¸ibe_v5
(
mosq
, 
NULL
, 
cfg
.
ª•⁄£_t›ic
, cfg.
qos
, 0, cfg.
subs¸ibe_¥›s
);

123 
˛õ¡_°©e
 = 
º_s_disc⁄√˘
;

124 if(
ªsu…
){

125 if(
ªsu…
 =
MQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
){

126 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s. mosquôto_º o∆y suµ‹t†c⁄√˘ögÅÿ™ MQTT v5 brokî\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

128 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

131 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

133 
	}
}

136 
	$my_subs¸ibe_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

138 if(
gø¡ed_qos
[0] < 128){

139 
˛õ¡_°©e
 = 
º_s_ªady_to_publish
;

141 
˛õ¡_°©e
 = 
º_s_disc⁄√˘
;

142 
	`îr_¥ötf
(&
cfg
, "%s\n", 
	`mosquôto_ªas⁄_°rög
(
gø¡ed_qos
[0]));

143 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

145 
	}
}

148 
	$my_publish_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

150 
˛õ¡_°©e
 = 
º_s_waô_f‹_ª•⁄£
;

151 
	}
}

154 
	$¥öt_ußge
()

156 
maj‹
, 
mö‹
, 
ªvisi⁄
;

158 
	`mosquôto_lib_vîsi⁄
(&
maj‹
, &
mö‹
, &
ªvisi⁄
);

159 
	`¥ötf
("mosquitto_rr isán mqtt clientÅhat can be usedÅoÖublisháÑequest messageánd wait foráÑesponse.\n");

160 
	`¥ötf
(" DefaultsÅo MQTT v5, whereÅhe Request-Response feature will be used, but v3.1.1 canálso be used\n");

161 
	`¥ötf
(" with v3.1.1 brokers.\n");

162 
	`¥ötf
("mosquôto_º vîsi⁄ %†ru¬ög o¿libmosquôtÿ%d.%d.%d.\n\n", 
VERSION
, 
maj‹
, 
mö‹
, 
ªvisi⁄
);

163 
	`¥ötf
("Usage: mosquitto_rr {[-h host] [-pÖort] [-u username] [-PÖassword] -tÅopic | -L URL} -eÑesponse-topic\n");

164 
	`¥ötf
(" [-c] [-k keepalive] [-q qos] [-R]\n");

165 
	`¥ötf
(" [-F format]\n");

166 #i‚de‡
WIN32


167 
	`¥ötf
(" [-WÅimeout_secs]\n");

169 #ifde‡
WITH_SRV


170 
	`¥ötf
(" [-A bind_address] [-S]\n");

172 
	`¥ötf
(" [-A bind_address]\n");

174 
	`¥ötf
(" [-i id] [-I id_prefix]\n");

175 
	`¥ötf
(" [-d] [-N] [--quiet] [-v]\n");

176 
	`¥ötf
(" [--will-topic [--will-payloadÖayload] [--will-qos qos] [--will-retain]]\n");

177 #ifde‡
WITH_TLS


178 
	`¥ötf
(" [{--cafile file | --capath dir} [--cert file] [--key file]\n");

179 
	`¥ötf
(" [--ciphers ciphers] [--insecure]\n");

180 
	`¥ötf
(" [--tls-alpnÖrotocol]\n");

181 
	`¥ötf
(" [--tls-engineÉngine] [--keyform keyform] [--tls-engine-kpass-sha1]]\n");

182 #ifde‡
FINAL_WITH_TLS_PSK


183 
	`¥ötf
(" [--psk hex-key --psk-identity identity [--ciphers ciphers]]\n");

186 #ifde‡
WITH_SOCKS


187 
	`¥ötf
(" [--proxy socks-url]\n");

189 
	`¥ötf
(" [-D command identifier value]\n");

190 
	`¥ötf
(" mosquitto_rr --help\n\n");

191 
	`¥ötf
(" -A : bindÅhe outgoing socketÅoÅhis host/ipáddress. UseÅo control which interface\n");

192 
	`¥ötf
("Åhe client communicates over.\n");

193 
	`¥ötf
(" -c : disable 'clean session' (store subscriptionándÖending messages when client disconnects).\n");

194 
	`¥ötf
(" -d :Énable debug messages.\n");

195 
	`¥ötf
(" -D : Define MQTT v5Öroperties. SeeÅhe documentation for more details.\n");

196 
	`¥ötf
(" -F : output format.\n");

197 
	`¥ötf
(" -h : mqtt hostÅo connectÅo. DefaultsÅoÜocalhost.\n");

198 
	`¥ötf
(" -i : idÅo use forÅhis client. DefaultsÅo mosquitto_rr_áppended withÅheÖrocess id.\n");

199 
	`¥ötf
(" -k : keepálive in seconds forÅhis client. DefaultsÅo 60.\n");

200 
	`¥ötf
(" -L : specify user,Öassword, hostname,ÖortándÅopicásá URL inÅhe form:\n");

201 
	`¥ötf
(" mqtt(s)://[username[:password]@]host[:port]/topic\n");

202 
	`¥ötf
(" -N : doÇotáddánÉnd ofÜine character whenÖrintingÅheÖayload.\n");

203 
	`¥ötf
(" -p :ÇetworkÖortÅo connectÅo. DefaultsÅo 1883 forÖlain MQTTánd 8883 for MQTT over TLS.\n");

204 
	`¥ötf
(" -P :ÖrovideáÖassword\n");

205 
	`¥ötf
(" -q : quality of serviceÜevelÅo use for communications. DefaultsÅo 0.\n");

206 
	`¥ötf
(" -R : doÇotÖrint stale messages (those withÑetain set).\n");

207 #ifde‡
WITH_SRV


208 
	`¥ötf
(" -S : use SRVÜookupsÅo determine which hostÅo connectÅo.\n");

210 
	`¥ötf
(" -t : mqttÑesponseÅopicÅo subscribeÅo. May beÑepeated multipleÅimes.\n");

211 
	`¥ötf
(" -u :Örovideá username\n");

212 
	`¥ötf
(" -v :ÖrintÑeceived messages verbosely.\n");

213 
	`¥ötf
(" -V : specifyÅhe version ofÅhe MQTTÖrotocolÅo use when connecting.\n");

214 
	`¥ötf
(" DefaultsÅo 5.\n");

215 #i‚de‡
WIN32


216 
	`¥ötf
(" -W : SpecifiesáÅimeout in seconds howÜongÅo wait foráÑesponse.\n");

218 
	`¥ötf
(" --help : displayÅhis message.\n");

219 
	`¥ötf
(" --quiet : don'tÖrintÉrror messages.\n");

220 
	`¥ötf
(" --will-payload :Öayload forÅhe client Will, which is sent byÅhe broker in case of\n");

221 
	`¥ötf
(" unexpected disconnection. IfÇot givenánd will-topic is set,á zero\n");

222 
	`¥ötf
("Üength message will be sent.\n");

223 
	`¥ötf
(" --will-qos : QoSÜevel forÅhe client Will.\n");

224 
	`¥ötf
(" --will-retain : if given, makeÅhe client WillÑetained.\n");

225 
	`¥ötf
(" --will-topic :ÅheÅopic on whichÅoÖublishÅhe client Will.\n");

226 #ifde‡
WITH_TLS


227 
	`¥ötf
(" --cafile :ÖathÅoá file containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

228 
	`¥ötf
(" certificate based communication.\n");

229 
	`¥ötf
(" --capath :ÖathÅoá directory containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

230 
	`¥ötf
(" communication.\n");

231 
	`¥ötf
(" --cert : client certificate foráuthentication, ifÑequired by server.\n");

232 
	`¥ötf
(" --key : clientÖrivate key foráuthentication, ifÑequired by server.\n");

233 
	`¥ötf
(" --ciphers : openssl compatibleÜist of TLS ciphersÅo support.\n");

234 
	`¥ötf
(" --tls-version : TLSÖrotocol version, can be one ofÅlsv1.2Ålsv1.1 orÅlsv1.\n");

235 
	`¥ötf
(" DefaultsÅoÅlsv1.2 ifávailable.\n");

236 
	`¥ötf
(" --insecure : doÇot checkÅhatÅhe server certificate hostname matchesÅheÑemote\n");

237 
	`¥ötf
(" hostname. UsingÅhis option meansÅhat you cannot be sureÅhatÅhe\n");

238 
	`¥ötf
("Ñemote host isÅhe server you wishÅo connectÅoánd so is insecure.\n");

239 
	`¥ötf
(" DoÇot useÅhis option ináÖroductionÉnvironment.\n");

240 #ifde‡
WITH_TLS_PSK


241 
	`¥ötf
(" --psk :Öre-shared-key in hexadecimal (noÜeading 0x)ÅoÉnable TLS-PSK mode.\n");

242 
	`¥ötf
(" --psk-identity : client identity string for TLS-PSK mode.\n");

245 #ifde‡
WITH_SOCKS


246 
	`¥ötf
(" --proxy : SOCKS5Öroxy URL ofÅhe form:\n");

247 
	`¥ötf
(" socks5h://[username[:password]@]hostname[:port]\n");

248 
	`¥ötf
(" Only \"none\"ánd \"username\"áuthentication is supported.\n");

250 
	`¥ötf
("\nSee https://mosquitto.org/ for more information.\n\n");

251 
	}
}

253 
	$maö
(
¨gc
, *
¨gv
[])

255 
rc
;

256 #i‚de‡
WIN32


257 
siga˘i⁄
 
siga˘
;

260 
	`mosquôto_lib_öô
();

262 
rc
 = 
	`˛õ¡_c⁄fig_lﬂd
(&
cfg
, 
CLIENT_RR
, 
¨gc
, 
¨gv
);

263 if(
rc
){

264 if(
rc
 == 2){

266 
	`¥öt_ußge
();

268 
	`Ârötf
(
°dîr
, "\nUse 'mosquitto_rr --help'Åo see usage.\n");

270 
˛ónup
;

273 if(!
cfg
.
t›ic
 || cfg.
pub_mode
 =
MSGMODE_NONE
 || !cfg.
ª•⁄£_t›ic
){

274 
	`Ârötf
(
°dîr
, "Error: All ofÅopic, message,ándÑesponseÅopic must be supplied.\n");

275 
	`Ârötf
(
°dîr
, "\nUse 'mosquitto_rr --help'Åo see usage.\n");

276 
˛ónup
;

278 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
cfg
.
publish_¥›s
, 
MQTT_PROP_RESPONSE_TOPIC
, cfg.
ª•⁄£_t›ic
);

279 if(
rc
){

280 
	`Ârötf
(
°dîr
, "ErroráddingÖroperty RESPONSE_TOPIC.\n");

281 
˛ónup
;

283 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_PUBLISH
, 
cfg
.
publish_¥›s
);

284 if(
rc
){

285 
	`îr_¥ötf
(&
cfg
, "Error in PUBLISHÖroperties: DuplicateÑesponseÅopic.\n");

286 
˛ónup
;

289 if(
	`˛õ¡_id_gíî©e
(&
cfg
)){

290 
˛ónup
;

293 
mosq
 = 
	`mosquôto_√w
(
cfg
.
id
, cfg.
˛ón_£ssi⁄
, &cfg);

294 if(!
mosq
){

295 
î∫o
){

296 
ENOMEM
:

297 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

299 
EINVAL
:

300 
	`îr_¥ötf
(&
cfg
, "Error: Invalid idánd/or clean_session.\n");

303 
˛ónup
;

305 if(
	`˛õ¡_›ts_£t
(
mosq
, &
cfg
)){

306 
˛ónup
;

308 if(
cfg
.
debug
){

309 
	`mosquôto_log_ˇŒback_£t
(
mosq
, 
my_log_ˇŒback
);

311 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
my_c⁄√˘_ˇŒback
);

312 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
my_subs¸ibe_ˇŒback
);

313 
	`mosquôto_mesßge_v5_ˇŒback_£t
(
mosq
, 
my_mesßge_ˇŒback
);

315 
rc
 = 
	`˛õ¡_c⁄√˘
(
mosq
, &
cfg
);

316 if(
rc
){

317 
˛ónup
;

320 #i‚de‡
WIN32


321 
siga˘
.
ß_h™dÀr
 = 
my_sig«l_h™dÀr
;

322 
	`sigem±y£t
(&
siga˘
.
ß_mask
);

323 
siga˘
.
ß_Êags
 = 0;

325 if(
	`siga˘i⁄
(
SIGALRM
, &
siga˘
, 
NULL
) == -1){

326 
	`≥º‹
("sigaction");

327 
˛ónup
;

330 if(
cfg
.
timeout
){

331 
	`Æ¨m
(
cfg
.
timeout
);

336 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

337 if(
˛õ¡_°©e
 =
º_s_ªady_to_publish
){

338 
˛õ¡_°©e
 = 
º_s_waô_f‹_ª•⁄£
;

339 
cfg
.
pub_mode
){

340 
MSGMODE_CMD
:

341 
MSGMODE_FILE
:

342 
MSGMODE_STDIN_FILE
:

343 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, cfg.
msgÀn
, cfg.
mesßge
, cfg.
qos
, cfg.
ªèö
);

345 
MSGMODE_NULL
:

346 
rc
 = 
	`my_publish
(
mosq
, &
mid_£¡
, 
cfg
.
t›ic
, 0, 
NULL
, cfg.
qos
, cfg.
ªèö
);

348 
MSGMODE_STDIN_LINE
:

353 }
rc
 =
MOSQ_ERR_SUCCESS
 && 
˛õ¡_°©e
 !
º_s_disc⁄√˘
);

355 
	`mosquôto_de°roy
(
mosq
);

356 
	`mosquôto_lib_˛ónup
();

358 if(
cfg
.
msg_cou¡
>0 && 
rc
 =
MOSQ_ERR_NO_CONN
){

359 
rc
 = 0;

361 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

362 if(
rc
){

363 
	`îr_¥ötf
(&
cfg
, "Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

365  
rc
;

367 
˛ónup
:

368 
	`mosquôto_lib_˛ónup
();

369 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

371 
	}
}

	@client/sub_client.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<time.h
>

25 #i‚de‡
WIN32


26 
	~<uni°d.h
>

27 
	~<sig«l.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	#¢¥ötf
 
•rötf_s


	)

34 
	~<mosquôto.h
>

35 
	~<mqâ_¥Ÿocﬁ.h
>

36 
	~"˛õ¡_sh¨ed.h
"

38 
mosq_c⁄fig
 
	gcfg
;

39 
boﬁ
 
	g¥o˚ss_mesßges
 = 
åue
;

40 
	gmsg_cou¡
 = 0;

41 
mosquôto
 *
	gmosq
 = 
NULL
;

42 
	gœ°_mid
 = 0;

44 #i‚de‡
WIN32


45 
	$my_sig«l_h™dÀr
(
signum
)

47 if(
signum
 =
SIGALRM
){

48 
¥o˚ss_mesßges
 = 
Ál£
;

49 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 
MQTT_RC_DISCONNECT_WITH_WILL_MSG
, 
cfg
.
disc⁄√˘_¥›s
);

51 
	}
}

54 
¥öt_mesßge
(
mosq_c⁄fig
 *
cfg
, c⁄° 
mosquôto_mesßge
 *
mesßge
);

57 
	$my_publish_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

59 
	`UNUSED
(
obj
);

60 
	`UNUSED
(
ªas⁄_code
);

61 
	`UNUSED
(
¥›îtõs
);

63 if(
¥o˚ss_mesßges
 =
Ál£
 && (
mid
 =
œ°_mid
 ||Üast_mid == 0)){

64 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

66 
	}
}

69 
	$my_mesßge_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
mesßge
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

71 
i
;

72 
boﬁ
 
ªs
;

74 
	`UNUSED
(
obj
);

75 
	`UNUSED
(
¥›îtõs
);

77 if(
¥o˚ss_mesßges
 =
Ál£
) ;

79 if(
cfg
.
ªmove_ªèöed
 && 
mesßge
->
ªèö
){

80 
	`mosquôto_publish
(
mosq
, &
œ°_mid
, 
mesßge
->
t›ic
, 0, 
NULL
, 1, 
åue
);

83 if(
cfg
.
ªèöed_⁄ly
 && !
mesßge
->
ªèö
 && 
¥o˚ss_mesßges
){

84 
¥o˚ss_mesßges
 = 
Ál£
;

85 if(
œ°_mid
 == 0){

86 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

91 if(
mesßge
->
ªèö
 && 
cfg
.
no_ªèö
) ;

92 if(
cfg
.
fûãr_outs
){

93 
i
=0; i<
cfg
.
fûãr_out_cou¡
; i++){

94 
	`mosquôto_t›ic_m©ches_sub
(
cfg
.
fûãr_outs
[
i
], 
mesßge
->
t›ic
, &
ªs
);

95 if(
ªs
) ;

99 
	`¥öt_mesßge
(&
cfg
, 
mesßge
);

101 if(
cfg
.
msg_cou¡
>0){

102 
msg_cou¡
++;

103 if(
cfg
.
msg_cou¡
 == msg_count){

104 
¥o˚ss_mesßges
 = 
Ál£
;

105 if(
œ°_mid
 == 0){

106 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

110 
	}
}

112 
	$my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

114 
i
;

116 
	`UNUSED
(
obj
);

117 
	`UNUSED
(
Êags
);

118 
	`UNUSED
(
¥›îtõs
);

120 if(!
ªsu…
){

121 
	`mosquôto_subs¸ibe_mu…ùÀ
(
mosq
, 
NULL
, 
cfg
.
t›ic_cou¡
, cfg.
t›ics
, cfg.
qos
, cfg.
sub_›ts
, cfg.
subs¸ibe_¥›s
);

123 
i
=0; i<
cfg
.
unsub_t›ic_cou¡
; i++){

124 
	`mosquôto_unsubs¸ibe_v5
(
mosq
, 
NULL
, 
cfg
.
unsub_t›ics
[
i
], cfg.
unsubs¸ibe_¥›s
);

127 if(
ªsu…
){

128 if(
cfg
.
¥Ÿocﬁ_vîsi⁄
 =
MQTT_PROTOCOL_V5
){

129 if(
ªsu…
 =
MQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
){

130 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s. Try c⁄√˘ögÅÿ™ MQTT v5 brokî, o∏u£ MQTT v3.x mode.\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

132 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s\n", 
	`mosquôto_ªas⁄_°rög
(
ªsu…
));

135 
	`îr_¥ötf
(&
cfg
, "C⁄√˘i⁄Éº‹: %s\n", 
	`mosquôto_c⁄«ck_°rög
(
ªsu…
));

138 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

140 
	}
}

142 
	$my_subs¸ibe_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

144 
i
;

146 
	`UNUSED
(
obj
);

148 if(
cfg
.
debug
){

149 if(!
cfg
.
quõt
Ë
	`¥ötf
("Subs¸ibed (mid: %d): %d", 
mid
, 
gø¡ed_qos
[0]);

150 
i
=1; i<
qos_cou¡
; i++){

151 if(!
cfg
.
quõt
Ë
	`¥ötf
(", %d", 
gø¡ed_qos
[
i
]);

153 if(!
cfg
.
quõt
Ë
	`¥ötf
("\n");

156 if(
cfg
.
exô_a·î_sub
){

157 
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
cfg
.
disc⁄√˘_¥›s
);

159 
	}
}

161 
	$my_log_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
Àvñ
, c⁄° *
°r
)

163 
	`UNUSED
(
mosq
);

164 
	`UNUSED
(
obj
);

165 
	`UNUSED
(
Àvñ
);

167 
	`¥ötf
("%s\n", 
°r
);

168 
	}
}

170 
	$¥öt_ußge
()

172 
maj‹
, 
mö‹
, 
ªvisi⁄
;

174 
	`mosquôto_lib_vîsi⁄
(&
maj‹
, &
mö‹
, &
ªvisi⁄
);

175 
	`¥ötf
("mosquitto_sub isá simple mqtt clientÅhat will subscribeÅoá set ofÅopicsándÖrintáll messages itÑeceives.\n");

176 
	`¥ötf
("mosquôto_sub vîsi⁄ %†ru¬ög o¿libmosquôtÿ%d.%d.%d.\n\n", 
VERSION
, 
maj‹
, 
mö‹
, 
ªvisi⁄
);

177 
	`¥ötf
("Usage: mosquitto_sub {[-h host] [-pÖort] [-u username] [-PÖassword] -tÅopic | -L URL [-tÅopic]}\n");

178 
	`¥ötf
(" [-c] [-k keepalive] [-q qos]\n");

179 
	`¥ötf
(" [-C msg_count] [-E] [-R] [--retained-only] [--remove-retained] [-T filter_out] [-UÅopic ...]\n");

180 
	`¥ötf
(" [-F format]\n");

181 #i‚de‡
WIN32


182 
	`¥ötf
(" [-WÅimeout_secs]\n");

184 #ifde‡
WITH_SRV


185 
	`¥ötf
(" [-A bind_address] [-S]\n");

187 
	`¥ötf
(" [-A bind_address]\n");

189 
	`¥ötf
(" [-i id] [-I id_prefix]\n");

190 
	`¥ötf
(" [-d] [-N] [--quiet] [-v]\n");

191 
	`¥ötf
(" [--will-topic [--will-payloadÖayload] [--will-qos qos] [--will-retain]]\n");

192 #ifde‡
WITH_TLS


193 
	`¥ötf
(" [{--cafile file | --capath dir} [--cert file] [--key file]\n");

194 
	`¥ötf
(" [--ciphers ciphers] [--insecure]\n");

195 
	`¥ötf
(" [--tls-alpnÖrotocol]\n");

196 
	`¥ötf
(" [--tls-engineÉngine] [--keyform keyform] [--tls-engine-kpass-sha1]]\n");

197 #ifde‡
FINAL_WITH_TLS_PSK


198 
	`¥ötf
(" [--psk hex-key --psk-identity identity [--ciphers ciphers]]\n");

201 #ifde‡
WITH_SOCKS


202 
	`¥ötf
(" [--proxy socks-url]\n");

204 
	`¥ötf
(" [-D command identifier value]\n");

205 
	`¥ötf
(" mosquitto_sub --help\n\n");

206 
	`¥ötf
(" -A : bindÅhe outgoing socketÅoÅhis host/ipáddress. UseÅo control which interface\n");

207 
	`¥ötf
("Åhe client communicates over.\n");

208 
	`¥ötf
(" -c : disable 'clean session' (store subscriptionándÖending messages when client disconnects).\n");

209 
	`¥ötf
(" -C : disconnectándÉxitáfterÑeceivingÅhe 'msg_count' messages.\n");

210 
	`¥ötf
(" -d :Énable debug messages.\n");

211 
	`¥ötf
(" -D : Define MQTT v5Öroperties. SeeÅhe documentation for more details.\n");

212 
	`¥ötf
(" -E : Exit onceáll subscriptions have beenácknowledged byÅhe broker.\n");

213 
	`¥ötf
(" -F : output format.\n");

214 
	`¥ötf
(" -h : mqtt hostÅo connectÅo. DefaultsÅoÜocalhost.\n");

215 
	`¥ötf
(" -i : idÅo use forÅhis client. DefaultsÅo mosquitto_sub_áppended withÅheÖrocess id.\n");

216 
	`¥ötf
(" -I : defineÅhe client idás id_prefixáppended withÅheÖrocess id. Useful for whenÅhe\n");

217 
	`¥ötf
(" broker is usingÅhe clientid_prefixes option.\n");

218 
	`¥ötf
(" -k : keepálive in seconds forÅhis client. DefaultsÅo 60.\n");

219 
	`¥ötf
(" -L : specify user,Öassword, hostname,ÖortándÅopicásá URL inÅhe form:\n");

220 
	`¥ötf
(" mqtt(s)://[username[:password]@]host[:port]/topic\n");

221 
	`¥ötf
(" -N : doÇotáddánÉnd ofÜine character whenÖrintingÅheÖayload.\n");

222 
	`¥ötf
(" -p :ÇetworkÖortÅo connectÅo. DefaultsÅo 1883 forÖlain MQTTánd 8883 for MQTT over TLS.\n");

223 
	`¥ötf
(" -P :ÖrovideáÖassword\n");

224 
	`¥ötf
(" -q : quality of serviceÜevelÅo use forÅhe subscription. DefaultsÅo 0.\n");

225 
	`¥ötf
(" -R : doÇotÖrint stale messages (those withÑetain set).\n");

226 #ifde‡
WITH_SRV


227 
	`¥ötf
(" -S : use SRVÜookupsÅo determine which hostÅo connectÅo.\n");

229 
	`¥ötf
(" -t : mqttÅopicÅo subscribeÅo. May beÑepeated multipleÅimes.\n");

230 
	`¥ötf
(" -T :Åopic stringÅo filter out ofÑesults. May beÑepeated.\n");

231 
	`¥ötf
(" -u :Örovideá username\n");

232 
	`¥ötf
(" -U : unsubscribe fromáÅopic. May beÑepeated.\n");

233 
	`¥ötf
(" -v :ÖrintÖublished messages verbosely.\n");

234 
	`¥ötf
(" -V : specifyÅhe version ofÅhe MQTTÖrotocolÅo use when connecting.\n");

235 
	`¥ötf
(" Can be mqttv5, mqttv311 or mqttv31. DefaultsÅo mqttv311.\n");

236 #i‚de‡
WIN32


237 
	`¥ötf
(" -W : SpecifiesáÅimeout in seconds howÜongÅoÖrocess incoming MQTT messages.\n");

239 
	`¥ötf
(" --help : displayÅhis message.\n");

240 
	`¥ötf
(" --quiet : don'tÖrintÉrror messages.\n");

241 
	`¥ötf
(" --retained-only : only handle messages withÅheÑetained flag set,ándÉxit whenÅhe\n");

242 
	`¥ötf
(" firstÇon-retained message isÑeceived.\n");

243 
	`¥ötf
(" --remove-retained : sendá messageÅoÅhe serverÅo clearányÑeceivedÑetained messages\n");

244 
	`¥ötf
(" Use -TÅo filter out messages you doÇot wantÅo be cleared.\n");

245 
	`¥ötf
(" --will-payload :Öayload forÅhe client Will, which is sent byÅhe broker in case of\n");

246 
	`¥ötf
(" unexpected disconnection. IfÇot givenánd will-topic is set,á zero\n");

247 
	`¥ötf
("Üength message will be sent.\n");

248 
	`¥ötf
(" --will-qos : QoSÜevel forÅhe client Will.\n");

249 
	`¥ötf
(" --will-retain : if given, makeÅhe client WillÑetained.\n");

250 
	`¥ötf
(" --will-topic :ÅheÅopic on whichÅoÖublishÅhe client Will.\n");

251 #ifde‡
WITH_TLS


252 
	`¥ötf
(" --cafile :ÖathÅoá file containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

253 
	`¥ötf
(" certificate based communication.\n");

254 
	`¥ötf
(" --capath :ÖathÅoá directory containingÅrusted CA certificatesÅoÉnableÉncrypted\n");

255 
	`¥ötf
(" communication.\n");

256 
	`¥ötf
(" --cert : client certificate foráuthentication, ifÑequired by server.\n");

257 
	`¥ötf
(" --key : clientÖrivate key foráuthentication, ifÑequired by server.\n");

258 
	`¥ötf
(" --keyform : keyfileÅype, can beÉither \"pem\" or \"engine\".\n");

259 
	`¥ötf
(" --ciphers : openssl compatibleÜist of TLS ciphersÅo support.\n");

260 
	`¥ötf
(" --tls-version : TLSÖrotocol version, can be one ofÅlsv1.3Ålsv1.2 orÅlsv1.1.\n");

261 
	`¥ötf
(" DefaultsÅoÅlsv1.2 ifávailable.\n");

262 
	`¥ötf
(" --insecure : doÇot checkÅhatÅhe server certificate hostname matchesÅheÑemote\n");

263 
	`¥ötf
(" hostname. UsingÅhis option meansÅhat you cannot be sureÅhatÅhe\n");

264 
	`¥ötf
("Ñemote host isÅhe server you wishÅo connectÅoánd so is insecure.\n");

265 
	`¥ötf
(" DoÇot useÅhis option ináÖroductionÉnvironment.\n");

266 
	`¥ötf
(" --tls-engine : If set,ÉnablesÅhe use ofá SSLÉngine device.\n");

267 
	`¥ötf
(" --tls-engine-kpass-sha1 : SHA1 ofÅhe keyÖasswordÅo be used withÅhe selected SSLÉngine.\n");

268 #ifde‡
FINAL_WITH_TLS_PSK


269 
	`¥ötf
(" --psk :Öre-shared-key in hexadecimal (noÜeading 0x)ÅoÉnable TLS-PSK mode.\n");

270 
	`¥ötf
(" --psk-identity : client identity string for TLS-PSK mode.\n");

273 #ifde‡
WITH_SOCKS


274 
	`¥ötf
(" --proxy : SOCKS5Öroxy URL ofÅhe form:\n");

275 
	`¥ötf
(" socks5h://[username[:password]@]hostname[:port]\n");

276 
	`¥ötf
(" Only \"none\"ánd \"username\"áuthentication is supported.\n");

278 
	`¥ötf
("\nSee https://mosquitto.org/ for more information.\n\n");

279 
	}
}

281 
	$maö
(
¨gc
, *
¨gv
[])

283 
rc
;

284 #i‚de‡
WIN32


285 
siga˘i⁄
 
siga˘
;

288 
	`mosquôto_lib_öô
();

290 
rc
 = 
	`˛õ¡_c⁄fig_lﬂd
(&
cfg
, 
CLIENT_SUB
, 
¨gc
, 
¨gv
);

291 if(
rc
){

292 if(
rc
 == 2){

294 
	`¥öt_ußge
();

296 
	`Ârötf
(
°dîr
, "\nUse 'mosquitto_sub --help'Åo see usage.\n");

298 
˛ónup
;

301 if(
cfg
.
no_ªèö
 && cfg.
ªèöed_⁄ly
){

302 
	`Ârötf
(
°dîr
, "\nError: Combining '-R'ánd '--retained-only' makesÇo sense.\n");

303 
˛ónup
;

306 if(
	`˛õ¡_id_gíî©e
(&
cfg
)){

307 
˛ónup
;

310 
mosq
 = 
	`mosquôto_√w
(
cfg
.
id
, cfg.
˛ón_£ssi⁄
, &cfg);

311 if(!
mosq
){

312 
î∫o
){

313 
ENOMEM
:

314 
	`îr_¥ötf
(&
cfg
, "Error: Out of memory.\n");

316 
EINVAL
:

317 
	`îr_¥ötf
(&
cfg
, "Error: Invalid idánd/or clean_session.\n");

320 
˛ónup
;

322 if(
	`˛õ¡_›ts_£t
(
mosq
, &
cfg
)){

323 
˛ónup
;

325 if(
cfg
.
debug
){

326 
	`mosquôto_log_ˇŒback_£t
(
mosq
, 
my_log_ˇŒback
);

328 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
my_subs¸ibe_ˇŒback
);

329 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
my_c⁄√˘_ˇŒback
);

330 
	`mosquôto_mesßge_v5_ˇŒback_£t
(
mosq
, 
my_mesßge_ˇŒback
);

332 
rc
 = 
	`˛õ¡_c⁄√˘
(
mosq
, &
cfg
);

333 if(
rc
){

334 
˛ónup
;

337 #i‚de‡
WIN32


338 
siga˘
.
ß_h™dÀr
 = 
my_sig«l_h™dÀr
;

339 
	`sigem±y£t
(&
siga˘
.
ß_mask
);

340 
siga˘
.
ß_Êags
 = 0;

342 if(
	`siga˘i⁄
(
SIGALRM
, &
siga˘
, 
NULL
) == -1){

343 
	`≥º‹
("sigaction");

344 
˛ónup
;

347 if(
cfg
.
timeout
){

348 
	`Æ¨m
(
cfg
.
timeout
);

352 
rc
 = 
	`mosquôto_lo›_f‹evî
(
mosq
, -1, 1);

354 
	`mosquôto_de°roy
(
mosq
);

355 
	`mosquôto_lib_˛ónup
();

357 if(
cfg
.
msg_cou¡
>0 && 
rc
 =
MOSQ_ERR_NO_CONN
){

358 
rc
 = 0;

360 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

361 if(
rc
){

362 
	`îr_¥ötf
(&
cfg
, "Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

364  
rc
;

366 
˛ónup
:

367 
	`mosquôto_lib_˛ónup
();

368 
	`˛õ¡_c⁄fig_˛ónup
(&
cfg
);

370 
	}
}

	@client/sub_client_output.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<time.h
>

25 #i‚de‡
WIN32


26 
	~<uni°d.h
>

28 
	~<¥o˚ss.h
>

29 
	~<wösock2.h
>

30 
	#¢¥ötf
 
•rötf_s


	)

33 #ifde‡
__APPLE__


34 
	~<sys/time.h
>

37 
	~<mosquôto.h
>

38 
	~"˛õ¡_sh¨ed.h
"

40 
mosq_c⁄fig
 
cfg
;

42 
	$gë_time
(
tm
 **
ti
, *
ns
)

44 #ifde‡
WIN32


45 
SYSTEMTIME
 
°
;

46 #ñi‡
	`deföed
(
__APPLE__
)

47 
timevÆ
 
tv
;

49 
time•ec
 
ts
;

51 
time_t
 
s
;

53 #ifde‡
WIN32


54 
s
 = 
	`time
(
NULL
);

56 
	`GëLoˇlTime
(&
°
);

57 *
ns
 = 
°
.
wMûli£c⁄ds
*1000000L;

58 #ñi‡
	`deföed
(
__APPLE__
)

59 
	`gëtimeofday
(&
tv
, 
NULL
);

60 
s
 = 
tv
.
tv_£c
;

61 *
ns
 = 
tv
.
tv_u£c
*1000;

63 if(
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
ts
) != 0){

64 
	`îr_¥ötf
(&
cfg
, "Error obtaining systemÅime.\n");

67 
s
 = 
ts
.
tv_£c
;

68 *
ns
 = 
ts
.
tv_n£c
;

71 *
ti
 = 
	`loˇ…ime
(&
s
);

72 if(!(*
ti
)){

73 
	`îr_¥ötf
(&
cfg
, "Error obtaining systemÅime.\n");

78 
	}
}

81 
	$wrôe_∑ylﬂd
(c⁄° *
∑ylﬂd
, 
∑ylﬂdÀn
, 
hex
)

83 
i
;

85 if(
hex
 == 0){

86 ()
	`fwrôe
(
∑ylﬂd
, 1, 
∑ylﬂdÀn
, 
°dout
);

87 }if(
hex
 == 1){

88 
i
=0; i<
∑ylﬂdÀn
; i++){

89 
	`Ârötf
(
°dout
, "%02x", 
∑ylﬂd
[
i
]);

91 }if(
hex
 == 2){

92 
i
=0; i<
∑ylﬂdÀn
; i++){

93 
	`Ârötf
(
°dout
, "%02X", 
∑ylﬂd
[
i
]);

96 
	}
}

99 
	$wrôe_js⁄_∑ylﬂd
(c⁄° *
∑ylﬂd
, 
∑ylﬂdÀn
)

101 
i
;

103 
i
=0; i<
∑ylﬂdÀn
; i++){

104 if(
∑ylﬂd
[
i
] == '"' ||Öayload[i] == '\\' || (payload[i] >=0 &&Öayload[i] < 32)){

105 
	`¥ötf
("\\u%04x", 
∑ylﬂd
[
i
]);

107 
	`Âutc
(
∑ylﬂd
[
i
], 
°dout
);

110 
	}
}

113 
	$js⁄_¥öt
(c⁄° 
mosquôto_mesßge
 *
mesßge
, c⁄° 
tm
 *
ti
, 
boﬁ
 
esˇ≥d
)

115 
buf
[100];

117 
	`°r·ime
(
buf
, 100, "%s", 
ti
);

118 
	`¥ötf
("{\"t°\":%s,\"t›ic\":\"%s\",\"qos\":%d,\"ªèö\":%d,\"∑ylﬂdÀn\":%d,", 
buf
, 
mesßge
->
t›ic
, mesßge->
qos
, mesßge->
ªèö
, mesßge->
∑ylﬂdÀn
);

119 if(
mesßge
->
qos
 > 0){

120 
	`¥ötf
("\"mid\":%d,", 
mesßge
->
mid
);

122 if(
esˇ≥d
){

123 
	`Âuts
("\"∑ylﬂd\":\"", 
°dout
);

124 
	`wrôe_js⁄_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
);

125 
	`Âuts
("\"}", 
°dout
);

127 
	`Âuts
("\"∑ylﬂd\":", 
°dout
);

128 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 0);

129 
	`Âuts
("}", 
°dout
);

131 
	}
}

134 
	$f‹m©ãd_¥öt
(c⁄° 
mosq_c⁄fig
 *
lcfg
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

136 
Àn
;

137 
i
;

138 
tm
 *
ti
 = 
NULL
;

139 
ns
;

140 
°rf
[3];

141 
buf
[100];

143 
Àn
 = 
	`°æí
(
lcfg
->
f‹m©
);

145 
i
=0; i<
Àn
; i++){

146 if(
lcfg
->
f‹m©
[
i
] == '%'){

147 if(
i
 < 
Àn
-1){

148 
i
++;

149 
lcfg
->
f‹m©
[
i
]){

151 
	`Âutc
('%', 
°dout
);

155 if(!
ti
){

156 if(
	`gë_time
(&
ti
, &
ns
)){

157 
	`îr_¥ötf
(
lcfg
, "Error obtaining systemÅime.\n");

161 if(
	`°r·ime
(
buf
, 100, "%FT%T%z", 
ti
) != 0){

162 
	`Âuts
(
buf
, 
°dout
);

167 if(!
ti
){

168 if(
	`gë_time
(&
ti
, &
ns
)){

169 
	`îr_¥ötf
(
lcfg
, "Error obtaining systemÅime.\n");

173 
	`js⁄_¥öt
(
mesßge
, 
ti
, 
åue
);

177 if(!
ti
){

178 if(
	`gë_time
(&
ti
, &
ns
)){

179 
	`îr_¥ötf
(
lcfg
, "Error obtaining systemÅime.\n");

183 
	`js⁄_¥öt
(
mesßge
, 
ti
, 
Ál£
);

187 
	`¥ötf
("%d", 
mesßge
->
∑ylﬂdÀn
);

191 
	`¥ötf
("%d", 
mesßge
->
mid
);

195 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 0);

199 
	`Âutc
(
mesßge
->
qos
 + 48, 
°dout
);

203 if(
mesßge
->
ªèö
){

204 
	`Âutc
('1', 
°dout
);

206 
	`Âutc
('0', 
°dout
);

211 
	`Âuts
(
mesßge
->
t›ic
, 
°dout
);

215 if(!
ti
){

216 if(
	`gë_time
(&
ti
, &
ns
)){

217 
	`îr_¥ötf
(
lcfg
, "Error obtaining systemÅime.\n");

221 if(
	`°r·ime
(
buf
, 100, "%s", 
ti
) != 0){

222 
	`¥ötf
("%s.%09ld", 
buf
, 
ns
);

227 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 1);

231 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 2);

235 }if(
lcfg
->
f‹m©
[
i
] == '@'){

236 if(
i
 < 
Àn
-1){

237 
i
++;

238 if(
lcfg
->
f‹m©
[
i
] == '@'){

239 
	`Âutc
('@', 
°dout
);

241 if(!
ti
){

242 if(
	`gë_time
(&
ti
, &
ns
)){

243 
	`îr_¥ötf
(
lcfg
, "Error obtaining systemÅime.\n");

248 
°rf
[0] = '%';

249 
°rf
[1] = 
lcfg
->
f‹m©
[
i
];

250 
°rf
[2] = 0;

252 if(
lcfg
->
f‹m©
[
i
] == 'N'){

253 
	`¥ötf
("%09ld", 
ns
);

255 if(
	`°r·ime
(
buf
, 100, 
°rf
, 
ti
) != 0){

256 
	`Âuts
(
buf
, 
°dout
);

261 }if(
lcfg
->
f‹m©
[
i
] == '\\'){

262 if(
i
 < 
Àn
-1){

263 
i
++;

264 
lcfg
->
f‹m©
[
i
]){

266 
	`Âutc
('\\', 
°dout
);

270 
	`Âutc
('\0', 
°dout
);

274 
	`Âutc
('\a', 
°dout
);

278 
	`Âutc
('\033', 
°dout
);

282 
	`Âutc
('\n', 
°dout
);

286 
	`Âutc
('\r', 
°dout
);

290 
	`Âutc
('\t', 
°dout
);

294 
	`Âutc
('\v', 
°dout
);

299 
	`Âutc
(
lcfg
->
f‹m©
[
i
], 
°dout
);

302 if(
lcfg
->
eﬁ
){

303 
	`Âutc
('\n', 
°dout
);

305 
	`fÊush
(
°dout
);

306 
	}
}

309 
	$¥öt_mesßge
(
mosq_c⁄fig
 *
cfg
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

311 if(
cfg
->
f‹m©
){

312 
	`f‹m©ãd_¥öt
(
cfg
, 
mesßge
);

313 }if(
cfg
->
vîbo£
){

314 if(
mesßge
->
∑ylﬂdÀn
){

315 
	`¥ötf
("%†", 
mesßge
->
t›ic
);

316 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 
Ál£
);

317 if(
cfg
->
eﬁ
){

318 
	`¥ötf
("\n");

321 if(
cfg
->
eﬁ
){

322 
	`¥ötf
("%†“uŒ)\n", 
mesßge
->
t›ic
);

325 
	`fÊush
(
°dout
);

327 if(
mesßge
->
∑ylﬂdÀn
){

328 
	`wrôe_∑ylﬂd
(
mesßge
->
∑ylﬂd
, mesßge->
∑ylﬂdÀn
, 
Ál£
);

329 if(
cfg
->
eﬁ
){

330 
	`¥ötf
("\n");

332 
	`fÊush
(
°dout
);

335 
	}
}

	@config.h

1 #i‚de‡
CONFIG_H


2 
	#CONFIG_H


	)

7 #ifde‡
__APPLE__


8 
	#__DARWIN_C_SOURCE


	)

9 #ñi‡
deföed
(
__FªeBSD__
Ë|| deföed(
__NëBSD__
Ë|| deföed(
__SYMBIAN32__
Ë|| deföed(
__QNX__
)

10 
	#_XOPEN_SOURCE
 700

	)

11 
	#__BSD_VISIBLE
 1

	)

12 
	#HAVE_NETINET_IN_H


	)

14 
	#_XOPEN_SOURCE
 700

	)

15 
	#_DEFAULT_SOURCE
 1

	)

16 
	#_POSIX_C_SOURCE
 200809L

	)

20 #i‚de‡
_GNU_SOURCE


21 
	#_GNU_SOURCE


	)

24 
	#OPENSSL_LOAD_CONF


	)

29 #i‡
deföed
(
_MSC_VER
) && _MSC_VER < 1900

30 
	#¢¥ötf
 
•rötf_s


	)

31 
	#EPROTO
 
ECONNABORTED


	)

34 #ifde‡
WIN32


35 #i‚de‡
°rˇ£cmp


36 
	#°rˇ£cmp
 
°rcmpi


	)

38 
	#°πok_r
 
°πok_s


	)

39 
	#°ªº‹_r
(
e
, 
b
, 
l
Ë
	`°ªº‹_s
(b,Ü,É)

	)

43 
	#uthash_mÆloc
(
sz
Ë
	`mosquôto__mÆloc
(sz)

	)

44 
	#uthash_‰ì
(
±r
,
sz
Ë
	`mosquôto__‰ì
’å)

	)

47 #ifde‡
WITH_TLS


48 
	~<›ís¶/›ís¶c⁄f.h
>

49 #i‡
deföed
(
WITH_TLS_PSK
Ë&& !deföed(
OPENSSL_NO_PSK
)

50 
	#FINAL_WITH_TLS_PSK


	)

55 #ifde‡
__COVERITY__


56 
	~<°döt.h
>

58 
	#_Flﬂt32
 
uöt32_t


	)

59 
	#_Flﬂt32x
 
uöt32_t


	)

60 
	#_Flﬂt64
 
uöt64_t


	)

61 
	#_Flﬂt64x
 
uöt64_t


	)

62 
	#_Flﬂt128
 
uöt64_t


	)

65 
	#UNUSED
(
A
Ë()(A)

	)

68 #i‚de‡
ANDROID


69 
	#HAVE_PTHREAD_CANCEL


	)

	@examples/mysql_log/mysql_log.c

1 
	~<sig«l.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

5 #i‚de‡
WIN32


6 
	~<uni°d.h
>

8 
	~<¥o˚ss.h
>

9 
	#¢¥ötf
 
•rötf_s


	)

12 
	~<mosquôto.h
>

13 
	~<mysql/mysql.h
>

15 
	#db_ho°
 "loˇlho°"

	)

16 
	#db_u£∫ame
 "mqâ_log"

	)

17 
	#db_∑ssw‹d
 "∑ssw‹d"

	)

18 
	#db_d©aba£
 "mqâ_log"

	)

19 
	#db_p‹t
 3306

	)

21 
	#db_quîy
 "INSERT INTO mqâ_log (t›ic,ÖaylﬂdËVALUES (?,?)"

	)

23 
	#mqâ_ho°
 "loˇlho°"

	)

24 
	#mqâ_p‹t
 1883

	)

26 
	grun
 = 1;

27 
MYSQL_STMT
 *
	g°mt
 = 
NULL
;

29 
	$h™dÀ_sig«l
(
s
)

31 
run
 = 0;

32 
	}
}

34 
	$c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
)

36 
	}
}

38 
	$mesßge_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

40 
MYSQL_BIND
 
böd
[2];

42 
	`mem£t
(
böd
, 0, (bind));

44 
böd
[0].
buf„r_ty≥
 = 
MYSQL_TYPE_STRING
;

45 
böd
[0].
buf„r
 = 
mesßge
->
t›ic
;

46 
böd
[0].
buf„r_Àngth
 = 
	`°æí
(
mesßge
->
t›ic
);

50 
böd
[1].
buf„r_ty≥
 = 
MYSQL_TYPE_STRING
;

51 
böd
[1].
buf„r
 = 
mesßge
->
∑ylﬂd
;

52 
böd
[1].
buf„r_Àngth
 = 
mesßge
->
∑ylﬂdÀn
;

54 
	`mysql_°mt_böd_∑øm
(
°mt
, 
böd
);

55 
	`mysql_°mt_execuã
(
°mt
);

56 
	}
}

58 
	$maö
(
¨gc
, *
¨gv
[])

60 
MYSQL
 *
c⁄√˘i⁄
;

61 
my_boﬁ
 
ªc⁄√˘
 = 
åue
;

62 
˛õ¡id
[24];

63 
mosquôto
 *
mosq
;

64 
rc
 = 0;

66 
	`sig«l
(
SIGINT
, 
h™dÀ_sig«l
);

67 
	`sig«l
(
SIGTERM
, 
h™dÀ_sig«l
);

69 
	`mysql_libøry_öô
(0, 
NULL
, NULL);

70 
	`mosquôto_lib_öô
();

72 
c⁄√˘i⁄
 = 
	`mysql_öô
(
NULL
);

74 if(
c⁄√˘i⁄
){

75 
	`mysql_›ti⁄s
(
c⁄√˘i⁄
, 
MYSQL_OPT_RECONNECT
, &
ªc⁄√˘
);

77 
c⁄√˘i⁄
 = 
	`mysql_ªÆ_c⁄√˘
(c⁄√˘i⁄, 
db_ho°
, 
db_u£∫ame
, 
db_∑ssw‹d
, 
db_d©aba£
, 
db_p‹t
, 
NULL
, 0);

79 if(
c⁄√˘i⁄
){

80 
°mt
 = 
	`mysql_°mt_öô
(
c⁄√˘i⁄
);

82 
	`mysql_°mt_¥ï¨e
(
°mt
, 
db_quîy
, 
	`°æí
(db_query));

84 
	`mem£t
(
˛õ¡id
, 0, 24);

85 
	`¢¥ötf
(
˛õ¡id
, 23, "mysql_log_%d", 
	`gëpid
());

86 
mosq
 = 
	`mosquôto_√w
(
˛õ¡id
, 
åue
, 
c⁄√˘i⁄
);

87 if(
mosq
){

88 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
c⁄√˘_ˇŒback
);

89 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
mesßge_ˇŒback
);

92 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, 
mqâ_ho°
, 
mqâ_p‹t
, 60);

94 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "#", 0);

96 
run
){

97 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

98 if(
run
 && 
rc
){

99 
	`¶ìp
(20);

100 
	`mosquôto_ªc⁄√˘
(
mosq
);

103 
	`mosquôto_de°roy
(
mosq
);

105 
	`mysql_°mt_˛o£
(
°mt
);

107 
	`mysql_˛o£
(
c⁄√˘i⁄
);

109 
	`Ârötf
(
°dîr
, "Error: UnableÅo connectÅo database.\n");

110 
	`¥ötf
("%s\n", 
	`mysql_îr‹
(
c⁄√˘i⁄
));

111 
rc
 = 1;

114 
	`Ârötf
(
°dîr
, "Error: UnableÅo start mysql.\n");

115 
rc
 = 1;

118 
	`mysql_libøry_íd
();

119 
	`mosquôto_lib_˛ónup
();

121  
rc
;

122 
	}
}

	@examples/subscribe_simple/callback.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~"mosquôto.h
"

5 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
u£rd©a
, c⁄° 
mosquôto_mesßge
 *
msg
)

7 
	`¥ötf
("%†%†(%d)\n", 
msg
->
t›ic
, (c⁄° *)msg->
∑ylﬂd
, msg->
∑ylﬂdÀn
);

9 
	}
}

12 
	$maö
(
¨gc
, *
¨gv
[])

14 
rc
;

16 
	`mosquôto_lib_öô
();

18 
rc
 = 
	`mosquôto_subs¸ibe_ˇŒback
(

19 
⁄_mesßge
, 
NULL
,

22 
NULL
, 60, 
åue
,

23 
NULL
, NULL,

24 
NULL
, NULL);

26 if(
rc
){

27 
	`¥ötf
("Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

30 
	`mosquôto_lib_˛ónup
();

32  
rc
;

33 
	}
}

	@examples/subscribe_simple/multiple.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~"mosquôto.h
"

5 
	#COUNT
 3

	)

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
rc
;

10 
i
;

11 
mosquôto_mesßge
 *
msg
;

13 
	`mosquôto_lib_öô
();

15 
rc
 = 
	`mosquôto_subs¸ibe_sim∂e
(

16 &
msg
, 
COUNT
, 
åue
,

19 
NULL
, 60, 
åue
,

20 
NULL
, NULL,

21 
NULL
, NULL);

23 if(
rc
){

24 
	`¥ötf
("Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

25 
	`mosquôto_lib_˛ónup
();

26  
rc
;

29 
i
=0; i<
COUNT
; i++){

30 
	`¥ötf
("%†%s\n", 
msg
[
i
].
t›ic
, (*)msg[i].
∑ylﬂd
);

31 
	`mosquôto_mesßge_‰ì_c⁄ã¡s
(&
msg
[
i
]);

33 
	`‰ì
(
msg
);

35 
	`mosquôto_lib_˛ónup
();

38 
	}
}

	@examples/subscribe_simple/single.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~"mosquôto.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
rc
;

8 
mosquôto_mesßge
 *
msg
;

10 
	`mosquôto_lib_öô
();

12 
rc
 = 
	`mosquôto_subs¸ibe_sim∂e
(

13 &
msg
, 1, 
åue
,

16 
NULL
, 60, 
åue
,

17 
NULL
, NULL,

18 
NULL
, NULL);

20 if(
rc
){

21 
	`¥ötf
("Eº‹: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

22 
	`mosquôto_lib_˛ónup
();

23  
rc
;

26 
	`¥ötf
("%†%s\n", 
msg
->
t›ic
, (*)msg->
∑ylﬂd
);

27 
	`mosquôto_mesßge_‰ì
(&
msg
);

29 
	`mosquôto_lib_˛ónup
();

32 
	}
}

	@examples/temperature_conversion/main.cpp

1 
	~"ãm≥øtuª_c⁄vîsi⁄.h
"

3 
	$maö
(
¨gc
, *
¨gv
[])

5 
˛ass
 
mqâ_ãmpc⁄v
 *
ãmpc⁄v
;

6 
rc
;

8 
mosqµ
::
	`lib_öô
();

10 
ãmpc⁄v
 = 
√w
 
	`mqâ_ãmpc⁄v
("tempconv", "localhost", 1883);

11 
ãmpc⁄v
->
	`lo›_f‹evî
();

13 
mosqµ
::
	`lib_˛ónup
();

16 
	}
}

	@examples/temperature_conversion/temperature_conversion.cpp

1 
	~<c°dio
>

2 
	~<c°rög
>

4 
	~"ãm≥øtuª_c⁄vîsi⁄.h
"

5 
	~<mosquôt›p.h
>

7 
	gmqâ_ãmpc⁄v
::
	$mqâ_ãmpc⁄v
(c⁄° *
id
, c⁄° *
ho°
, 
p‹t
Ë: 
	$mosquôt›p
(
id
)

9 
kì∑live
 = 60;

13 
	`c⁄√˘
(
ho°
, 
p‹t
, 
kì∑live
);

14 
	}
};

16 
	gmqâ_ãmpc⁄v
::~
	$mqâ_ãmpc⁄v
()

18 
	}
}

20 
mqâ_ãmpc⁄v
::
	$⁄_c⁄√˘
(
rc
)

22 
	`¥ötf
("C⁄√˘ed wôh codê%d.\n", 
rc
);

23 if(
rc
 == 0){

25 
	`subs¸ibe
(
NULL
, "temperature/celsius");

27 
	}
}

29 
	gmqâ_ãmpc⁄v
::
	$⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
mesßge
)

31 
ãmp_˚lsius
, 
ãmp_Áªnheô
;

32 
buf
[51];

34 if(!
	`°rcmp
(
mesßge
->
t›ic
, "temperature/celsius")){

35 
	`mem£t
(
buf
, 0, 51*());

37 
	`mem˝y
(
buf
, 
mesßge
->
∑ylﬂd
, 50*());

38 
ãmp_˚lsius
 = 
	`©of
(
buf
);

39 
ãmp_Áªnheô
 = 
ãmp_˚lsius
*9.0/5.0 + 32.0;

40 
	`¢¥ötf
(
buf
, 50, "%f", 
ãmp_Áªnheô
);

41 
	`publish
(
NULL
, "ãm≥øtuª/Áªnheô", 
	`°æí
(
buf
), buf);

43 
	}
}

45 
	gmqâ_ãmpc⁄v
::
	$⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

47 
	`¥ötf
("Subscription succeeded.\n");

48 
	}
}

	@examples/temperature_conversion/temperature_conversion.h

1 #i‚de‡
TEMPERATURE_CONVERSION_H


2 
	#TEMPERATURE_CONVERSION_H


	)

4 
	~<mosquôt›p.h
>

6 ˛as†
	cmqâ_ãmpc⁄v
 : 
public
 
mosqµ
::
mosquôt›p


8 
public
:

9 
mqâ_ãmpc⁄v
(c⁄° *
id
, c⁄° *
ho°
, 
p‹t
);

10 ~
mqâ_ãmpc⁄v
();

12 
⁄_c⁄√˘
(
rc
);

13 
⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
mesßge
);

14 
⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
);

	@lib/actions.c

17 
	~"c⁄fig.h
"

19 
	~<°rög.h
>

21 
	~"mosquôto.h
"

22 
	~"mosquôto_öã∫Æ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mesßges_mosq.h
"

25 
	~"mqâ_¥Ÿocﬁ.h
"

26 
	~"√t_mosq.h
"

27 
	~"∑ckë_mosq.h
"

28 
	~"£nd_mosq.h
"

29 
	~"utû_mosq.h
"

32 
	$mosquôto_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

34  
	`mosquôto_publish_v5
(
mosq
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
NULL
);

35 
	}
}

37 
	$mosquôto_publish_v5
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

39 
mosquôto_mesßge_Æl
 *
mesßge
;

40 
uöt16_t
 
loˇl_mid
;

41 c⁄° 
mosquôto_¥›îty
 *
p
;

42 c⁄° 
mosquôto_¥›îty
 *
outgoög_¥›îtõs
 = 
NULL
;

43 
mosquôto_¥›îty
 *
¥›îtõs_c›y
 = 
NULL
;

44 
mosquôto_¥›îty
 
loˇl_¥›îty
;

45 
boﬁ
 
have_t›ic_Æüs
;

46 
rc
;

47 
éí
 = 0;

48 
uöt32_t
 
ªmaöög_Àngth
;

50 if(!
mosq
 || 
qos
<0 || qos>2Ë 
MOSQ_ERR_INVAL
;

51 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 && 
¥›îtõs
Ë 
MOSQ_ERR_NOT_SUPPORTED
;

52 if(
qos
 > 
mosq
->
maximum_qos
Ë 
MOSQ_ERR_QOS_NOT_SUPPORTED
;

54 if(
¥›îtõs
){

55 if(
¥›îtõs
->
˛õ¡_gíî©ed
){

56 
outgoög_¥›îtõs
 = 
¥›îtõs
;

58 
	`mem˝y
(&
loˇl_¥›îty
, 
¥›îtõs
, (
mosquôto_¥›îty
));

59 
loˇl_¥›îty
.
˛õ¡_gíî©ed
 = 
åue
;

60 
loˇl_¥›îty
.
√xt
 = 
NULL
;

61 
outgoög_¥›îtõs
 = &
loˇl_¥›îty
;

63 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_PUBLISH
, 
outgoög_¥›îtõs
);

64 if(
rc
) Ñc;

67 if(!
t›ic
 || 
	`STREMPTY
(topic)){

68 if(
t›ic
Ët›i¯
NULL
;

70 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

71 
p
 = 
outgoög_¥›îtõs
;

72 
have_t›ic_Æüs
 = 
Ál£
;

73 
p
){

74 if(
p
->
idítifõr
 =
MQTT_PROP_TOPIC_ALIAS
){

75 
have_t›ic_Æüs
 = 
åue
;

78 
p
 =Ö->
√xt
;

80 if(
have_t›ic_Æüs
 =
Ál£
){

81  
MOSQ_ERR_INVAL
;

84  
MOSQ_ERR_INVAL
;

87 
éí
 = 
	`°æí
(
t›ic
);

88 if(
	`mosquôto_vÆid©e_utf8
(
t›ic
, 
éí
)Ë 
MOSQ_ERR_MALFORMED_UTF8
;

89 if(
∑ylﬂdÀn
 < 0 ||ÖaylﬂdÀ¿> 
MQTT_MAX_PAYLOAD
Ë 
MOSQ_ERR_PAYLOAD_SIZE
;

90 if(
	`mosquôto_pub_t›ic_check
(
t›ic
Ë!
MOSQ_ERR_SUCCESS
){

91  
MOSQ_ERR_INVAL
;

95 if(
mosq
->
maximum_∑ckë_size
 > 0){

96 
ªmaöög_Àngth
 = 1 + 2+
éí
 + 
∑ylﬂdÀn
 + 
	`¥›îty__gë_Àngth_Æl
(
outgoög_¥›îtõs
);

97 if(
qos
 > 0){

98 
ªmaöög_Àngth
++;

100 if(
	`∑ckë__check_ovîsize
(
mosq
, 
ªmaöög_Àngth
)){

101  
MOSQ_ERR_OVERSIZE_PACKET
;

105 
loˇl_mid
 = 
	`mosquôto__mid_gíî©e
(
mosq
);

106 if(
mid
){

107 *
mid
 = 
loˇl_mid
;

110 if(
qos
 == 0){

111  
	`£nd__publish
(
mosq
, 
loˇl_mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
Ál£
, 
outgoög_¥›îtõs
, 
NULL
, 0);

113 if(
outgoög_¥›îtõs
){

114 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›îtõs_c›y
, 
outgoög_¥›îtõs
);

115 if(
rc
) Ñc;

117 
mesßge
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_mesßge_Æl
));

118 if(!
mesßge
){

119 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs_c›y
);

120  
MOSQ_ERR_NOMEM
;

123 
mesßge
->
√xt
 = 
NULL
;

124 
mesßge
->
time°amp
 = 
	`mosquôto_time
();

125 
mesßge
->
msg
.
mid
 = 
loˇl_mid
;

126 if(
t›ic
){

127 
mesßge
->
msg
.
t›ic
 = 
	`mosquôto__°rdup
(topic);

128 if(!
mesßge
->
msg
.
t›ic
){

129 
	`mesßge__˛ónup
(&
mesßge
);

130 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs_c›y
);

131  
MOSQ_ERR_NOMEM
;

134 if(
∑ylﬂdÀn
){

135 
mesßge
->
msg
.
∑ylﬂdÀn
 =Öayloadlen;

136 
mesßge
->
msg
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(
∑ylﬂdÀn
*(
uöt8_t
));

137 if(!
mesßge
->
msg
.
∑ylﬂd
){

138 
	`mesßge__˛ónup
(&
mesßge
);

139 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs_c›y
);

140  
MOSQ_ERR_NOMEM
;

142 
	`mem˝y
(
mesßge
->
msg
.
∑ylﬂd
,Öaylﬂd, 
∑ylﬂdÀn
*(
uöt8_t
));

144 
mesßge
->
msg
.
∑ylﬂdÀn
 = 0;

145 
mesßge
->
msg
.
∑ylﬂd
 = 
NULL
;

147 
mesßge
->
msg
.
qos
 = qos;

148 
mesßge
->
msg
.
ªèö
 =Ñetain;

149 
mesßge
->
dup
 = 
Ál£
;

150 
mesßge
->
¥›îtõs
 = 
¥›îtõs_c›y
;

152 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

153 
mesßge
->
°©e
 = 
mosq_ms_övÆid
;

154 
	`mesßge__queue
(
mosq
, 
mesßge
, 
mosq_md_out
);

155 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

156  
MOSQ_ERR_SUCCESS
;

158 
	}
}

161 
	$mosquôto_subs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, 
qos
)

163  
	`mosquôto_subs¸ibe_mu…ùÀ
(
mosq
, 
mid
, 1, (*c⁄° *c⁄°)&
sub
, 
qos
, 0, 
NULL
);

164 
	}
}

167 
	$mosquôto_subs¸ibe_v5
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, 
qos
, 
›ti⁄s
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

169  
	`mosquôto_subs¸ibe_mu…ùÀ
(
mosq
, 
mid
, 1, (*c⁄° *c⁄°)&
sub
, 
qos
, 
›ti⁄s
, 
¥›îtõs
);

170 
	}
}

173 
	$mosquôto_subs¸ibe_mu…ùÀ
(
mosquôto
 *
mosq
, *
mid
, 
sub_cou¡
, *c⁄° *c⁄° 
sub
, 
qos
, 
›ti⁄s
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

175 c⁄° 
mosquôto_¥›îty
 *
outgoög_¥›îtõs
 = 
NULL
;

176 
mosquôto_¥›îty
 
loˇl_¥›îty
;

177 
i
;

178 
rc
;

179 
uöt32_t
 
ªmaöög_Àngth
 = 0;

180 
¶í
;

182 if(!
mosq
 || !
sub_cou¡
 || !
sub
Ë 
MOSQ_ERR_INVAL
;

183 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 && 
¥›îtõs
Ë 
MOSQ_ERR_NOT_SUPPORTED
;

184 if(
qos
 < 0 || qo†> 2Ë 
MOSQ_ERR_INVAL
;

185 if((
›ti⁄s
 & 0x30Ë=0x30 || (›ti⁄†& 0xC0Ë!0Ë 
MOSQ_ERR_INVAL
;

186 if(
mosq
->
sock
 =
INVALID_SOCKET
Ë 
MOSQ_ERR_NO_CONN
;

188 if(
¥›îtõs
){

189 if(
¥›îtõs
->
˛õ¡_gíî©ed
){

190 
outgoög_¥›îtõs
 = 
¥›îtõs
;

192 
	`mem˝y
(&
loˇl_¥›îty
, 
¥›îtõs
, (
mosquôto_¥›îty
));

193 
loˇl_¥›îty
.
˛õ¡_gíî©ed
 = 
åue
;

194 
loˇl_¥›îty
.
√xt
 = 
NULL
;

195 
outgoög_¥›îtõs
 = &
loˇl_¥›îty
;

197 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_SUBSCRIBE
, 
outgoög_¥›îtõs
);

198 if(
rc
) Ñc;

201 
i
=0; i<
sub_cou¡
; i++){

202 if(
	`mosquôto_sub_t›ic_check
(
sub
[
i
])Ë 
MOSQ_ERR_INVAL
;

203 
¶í
 = 
	`°æí
(
sub
[
i
]);

204 if(
	`mosquôto_vÆid©e_utf8
(
sub
[
i
], 
¶í
)Ë 
MOSQ_ERR_MALFORMED_UTF8
;

205 
ªmaöög_Àngth
 +2+
¶í
 + 1;

208 if(
mosq
->
maximum_∑ckë_size
 > 0){

209 
ªmaöög_Àngth
 +2 + 
	`¥›îty__gë_Àngth_Æl
(
outgoög_¥›îtõs
);

210 if(
	`∑ckë__check_ovîsize
(
mosq
, 
ªmaöög_Àngth
)){

211  
MOSQ_ERR_OVERSIZE_PACKET
;

214 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || mosq->¥Ÿocﬁ =
mosq_p_mqâ31
){

215 
›ti⁄s
 = 0;

218  
	`£nd__subs¸ibe
(
mosq
, 
mid
, 
sub_cou¡
, 
sub
, 
qos
|
›ti⁄s
, 
outgoög_¥›îtõs
);

219 
	}
}

222 
	$mosquôto_unsubs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
)

224  
	`mosquôto_unsubs¸ibe_mu…ùÀ
(
mosq
, 
mid
, 1, (*c⁄° *c⁄°)&
sub
, 
NULL
);

225 
	}
}

227 
	$mosquôto_unsubs¸ibe_v5
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

229  
	`mosquôto_unsubs¸ibe_mu…ùÀ
(
mosq
, 
mid
, 1, (*c⁄° *c⁄°)&
sub
, 
¥›îtõs
);

230 
	}
}

232 
	$mosquôto_unsubs¸ibe_mu…ùÀ
(
mosquôto
 *
mosq
, *
mid
, 
sub_cou¡
, *c⁄° *c⁄° 
sub
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

234 c⁄° 
mosquôto_¥›îty
 *
outgoög_¥›îtõs
 = 
NULL
;

235 
mosquôto_¥›îty
 
loˇl_¥›îty
;

236 
rc
;

237 
i
;

238 
uöt32_t
 
ªmaöög_Àngth
 = 0;

239 
¶í
;

241 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

242 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 && 
¥›îtõs
Ë 
MOSQ_ERR_NOT_SUPPORTED
;

243 if(
mosq
->
sock
 =
INVALID_SOCKET
Ë 
MOSQ_ERR_NO_CONN
;

245 if(
¥›îtõs
){

246 if(
¥›îtõs
->
˛õ¡_gíî©ed
){

247 
outgoög_¥›îtõs
 = 
¥›îtõs
;

249 
	`mem˝y
(&
loˇl_¥›îty
, 
¥›îtõs
, (
mosquôto_¥›îty
));

250 
loˇl_¥›îty
.
˛õ¡_gíî©ed
 = 
åue
;

251 
loˇl_¥›îty
.
√xt
 = 
NULL
;

252 
outgoög_¥›îtõs
 = &
loˇl_¥›îty
;

254 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_UNSUBSCRIBE
, 
outgoög_¥›îtõs
);

255 if(
rc
) Ñc;

258 
i
=0; i<
sub_cou¡
; i++){

259 if(
	`mosquôto_sub_t›ic_check
(
sub
[
i
])Ë 
MOSQ_ERR_INVAL
;

260 
¶í
 = 
	`°æí
(
sub
[
i
]);

261 if(
	`mosquôto_vÆid©e_utf8
(
sub
[
i
], 
¶í
)Ë 
MOSQ_ERR_MALFORMED_UTF8
;

262 
ªmaöög_Àngth
 +2+
¶í
;

265 if(
mosq
->
maximum_∑ckë_size
 > 0){

266 
ªmaöög_Àngth
 +2 + 
	`¥›îty__gë_Àngth_Æl
(
outgoög_¥›îtõs
);

267 if(
	`∑ckë__check_ovîsize
(
mosq
, 
ªmaöög_Àngth
)){

268  
MOSQ_ERR_OVERSIZE_PACKET
;

272  
	`£nd__unsubs¸ibe
(
mosq
, 
mid
, 
sub_cou¡
, 
sub
, 
outgoög_¥›îtõs
);

273 
	}
}

	@lib/alias_mosq.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto.h
"

20 
	~"Æüs_mosq.h
"

21 
	~"mem‹y_mosq.h
"

23 
	$Æüs__add
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
Æüs
)

25 
i
;

26 
mosquôto__Æüs
 *
Æü£s
;

28 
i
=0; i<
mosq
->
Æüs_cou¡
; i++){

29 if(
mosq
->
Æü£s
[
i
].
Æüs
 ==álias){

30 
	`mosquôto__‰ì
(
mosq
->
Æü£s
[
i
].
t›ic
);

31 
mosq
->
Æü£s
[
i
].
t›ic
 = 
	`mosquôto__°rdup
(topic);

32 if(
mosq
->
Æü£s
[
i
].
t›ic
){

33  
MOSQ_ERR_SUCCESS
;

36  
MOSQ_ERR_NOMEM
;

42 
Æü£s
 = 
	`mosquôto__ªÆloc
(
mosq
->Æü£s, (
mosquôto__Æüs
)*(mosq->
Æüs_cou¡
+1));

43 if(!
Æü£s
Ë 
MOSQ_ERR_NOMEM
;

45 
mosq
->
Æü£s
 =áliases;

46 
mosq
->
Æü£s
[mosq->
Æüs_cou¡
].
Æüs
 =álias;

47 
mosq
->
Æü£s
[mosq->
Æüs_cou¡
].
t›ic
 = 
	`mosquôto__°rdup
(topic);

48 if(!
mosq
->
Æü£s
[mosq->
Æüs_cou¡
].
t›ic
){

49  
MOSQ_ERR_NOMEM
;

51 
mosq
->
Æüs_cou¡
++;

53  
MOSQ_ERR_SUCCESS
;

54 
	}
}

57 
	$Æüs__föd
(
mosquôto
 *
mosq
, **
t›ic
, 
Æüs
)

59 
i
;

61 
i
=0; i<
mosq
->
Æüs_cou¡
; i++){

62 if(
mosq
->
Æü£s
[
i
].
Æüs
 ==álias){

63 *
t›ic
 = 
	`mosquôto__°rdup
(
mosq
->
Æü£s
[
i
].topic);

64 if(*
t›ic
){

65  
MOSQ_ERR_SUCCESS
;

67  
MOSQ_ERR_NOMEM
;

71  
MOSQ_ERR_INVAL
;

72 
	}
}

75 
	$Æüs__‰ì_Æl
(
mosquôto
 *
mosq
)

77 
i
;

79 
i
=0; i<
mosq
->
Æüs_cou¡
; i++){

80 
	`mosquôto__‰ì
(
mosq
->
Æü£s
[
i
].
t›ic
);

82 
	`mosquôto__‰ì
(
mosq
->
Æü£s
);

83 
mosq
->
Æü£s
 = 
NULL
;

84 
mosq
->
Æüs_cou¡
 = 0;

85 
	}
}

	@lib/alias_mosq.h

17 #i‚de‡
ALIAS_MOSQ_H


18 
	#ALIAS_MOSQ_H


	)

20 
	~"mosquôto_öã∫Æ.h
"

22 
Æüs__add
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
Æüs
);

23 
Æüs__föd
(
mosquôto
 *
mosq
, **
t›ic
, 
Æüs
);

24 
Æüs__‰ì_Æl
(
mosquôto
 *
mosq
);

	@lib/callbacks.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto.h
"

20 
	~"mosquôto_öã∫Æ.h
"

23 
	$mosquôto_c⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquitto *, *, ))

25 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

26 
mosq
->
⁄_c⁄√˘
 = on_connect;

27 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

28 
	}
}

30 
	$mosquôto_c⁄√˘_wôh_Êags_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquitto *, *, , ))

32 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

33 
mosq
->
⁄_c⁄√˘_wôh_Êags
 = 
⁄_c⁄√˘
;

34 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

35 
	}
}

37 
	$mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquôtÿ*, *, , , c⁄° 
mosquôto_¥›îty
 *))

39 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

40 
mosq
->
⁄_c⁄√˘_v5
 = 
⁄_c⁄√˘
;

41 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

42 
	}
}

44 
	$mosquôto_disc⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_disc⁄√˘
)(mosquitto *, *, ))

46 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

47 
mosq
->
⁄_disc⁄√˘
 = on_disconnect;

48 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

49 
	}
}

51 
	$mosquôto_disc⁄√˘_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_disc⁄√˘
)(mosquôtÿ*, *, , c⁄° 
mosquôto_¥›îty
 *))

53 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

54 
mosq
->
⁄_disc⁄√˘_v5
 = 
⁄_disc⁄√˘
;

55 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

56 
	}
}

58 
	$mosquôto_publish_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_publish
)(mosquitto *, *, ))

60 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

61 
mosq
->
⁄_publish
 = on_publish;

62 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

63 
	}
}

65 
	$mosquôto_publish_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_publish
)(mosquôtÿ*, *, , , c⁄° 
mosquôto_¥›îty
 *
¥›s
))

67 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

68 
mosq
->
⁄_publish_v5
 = 
⁄_publish
;

69 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

70 
	}
}

72 
	$mosquôto_mesßge_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_mesßge
)(mosquôtÿ*, *, c⁄° 
mosquôto_mesßge
 *))

74 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

75 
mosq
->
⁄_mesßge
 = on_message;

76 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

77 
	}
}

79 
	$mosquôto_mesßge_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_mesßge
)(mosquôtÿ*, *, c⁄° 
mosquôto_mesßge
 *, c⁄° 
mosquôto_¥›îty
 *
¥›s
))

81 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

82 
mosq
->
⁄_mesßge_v5
 = 
⁄_mesßge
;

83 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

84 
	}
}

86 
	$mosquôto_subs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_subs¸ibe
)(mosquitto *, *, , , const *))

88 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

89 
mosq
->
⁄_subs¸ibe
 = on_subscribe;

90 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

91 
	}
}

93 
	$mosquôto_subs¸ibe_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_subs¸ibe
)(mosquôtÿ*, *, , , c⁄° *, c⁄° 
mosquôto_¥›îty
 *
¥›s
))

95 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

96 
mosq
->
⁄_subs¸ibe_v5
 = 
⁄_subs¸ibe
;

97 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

98 
	}
}

100 
	$mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_unsubs¸ibe
)(mosquitto *, *, ))

102 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

103 
mosq
->
⁄_unsubs¸ibe
 = on_unsubscribe;

104 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

105 
	}
}

107 
	$mosquôto_unsubs¸ibe_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_unsubs¸ibe
)(mosquôtÿ*, *, , c⁄° 
mosquôto_¥›îty
 *
¥›s
))

109 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

110 
mosq
->
⁄_unsubs¸ibe_v5
 = 
⁄_unsubs¸ibe
;

111 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

112 
	}
}

114 
	$mosquôto_log_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_log
)(mosquitto *, *, , const *))

116 
	`±hªad_muãx_lock
(&
mosq
->
log_ˇŒback_muãx
);

117 
mosq
->
⁄_log
 = on_log;

118 
	`±hªad_muãx_u∆ock
(&
mosq
->
log_ˇŒback_muãx
);

119 
	}
}

	@lib/connect.c

17 
	~"c⁄fig.h
"

19 
	~<°rög.h
>

21 
	~"mosquôto.h
"

22 
	~"mosquôto_öã∫Æ.h
"

23 
	~"loggög_mosq.h
"

24 
	~"mesßges_mosq.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"∑ckë_mosq.h
"

27 
	~"mqâ_¥Ÿocﬁ.h
"

28 
	~"√t_mosq.h
"

29 
	~"£nd_mosq.h
"

30 
	~"socks_mosq.h
"

31 
	~"utû_mosq.h
"

33 
	gÆph™um
[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

35 
mosquôto__ªc⁄√˘
(
mosquôto
 *
mosq
, 
boﬁ
 
blockög
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

36 
mosquôto__c⁄√˘_öô
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

39 
	$mosquôto__c⁄√˘_öô
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
)

41 
i
;

42 
rc
;

44 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

45 if(!
ho°
 || 
p‹t
 <0Ë 
MOSQ_ERR_INVAL
;

47 if(
mosq
->
id
 =
NULL
 && (mosq->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 || mosq->¥Ÿocﬁ =
mosq_p_mqâ311
)){

48 
mosq
->
id
 = (*)
	`mosquôto__ˇŒoc
(24, ());

49 if(!
mosq
->
id
){

50  
MOSQ_ERR_NOMEM
;

52 
mosq
->
id
[0] = 'm';

53 
mosq
->
id
[1] = 'o';

54 
mosq
->
id
[2] = 's';

55 
mosq
->
id
[3] = 'q';

56 
mosq
->
id
[4] = '-';

58 
rc
 = 
	`utû__øndom_byãs
(&
mosq
->
id
[5], 18);

59 if(
rc
) Ñc;

61 
i
=5; i<23; i++){

62 
mosq
->
id
[
i
] = 
Æph™um
[(mosq->id[i]&0x7F)%((alphanum)-1)];

66 
	`mosquôto__‰ì
(
mosq
->
ho°
);

67 
mosq
->
ho°
 = 
	`mosquôto__°rdup
(host);

68 if(!
mosq
->
ho°
Ë 
MOSQ_ERR_NOMEM
;

69 
mosq
->
p‹t
 =Öort;

71 
	`mosquôto__‰ì
(
mosq
->
böd_addªss
);

72 if(
böd_addªss
){

73 
mosq
->
böd_addªss
 = 
	`mosquôto__°rdup
(bind_address);

74 if(!
mosq
->
böd_addªss
Ë 
MOSQ_ERR_NOMEM
;

77 
mosq
->
kì∑live
 = keepalive;

78 
mosq
->
msgs_ö
.
öÊight_quŸa
 = mosq->msgs_ö.
öÊight_maximum
;

79 
mosq
->
msgs_out
.
öÊight_quŸa
 = mosq->msgs_out.
öÊight_maximum
;

81 if(
mosq
->
sock∑úR
 !
INVALID_SOCKET
){

82 
	`COMPAT_CLOSE
(
mosq
->
sock∑úR
);

83 
mosq
->
sock∑úR
 = 
INVALID_SOCKET
;

85 if(
mosq
->
sock∑úW
 !
INVALID_SOCKET
){

86 
	`COMPAT_CLOSE
(
mosq
->
sock∑úW
);

87 
mosq
->
sock∑úW
 = 
INVALID_SOCKET
;

90 if(
	`√t__sockë∑ú
(&
mosq
->
sock∑úR
, &mosq->
sock∑úW
)){

91 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_WARNING
,

95  
MOSQ_ERR_SUCCESS
;

96 
	}
}

99 
	$mosquôto_c⁄√˘
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
)

101  
	`mosquôto_c⁄√˘_böd
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
NULL
);

102 
	}
}

105 
	$mosquôto_c⁄√˘_böd
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
)

107  
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
böd_addªss
, 
NULL
);

108 
	}
}

110 
	$mosquôto_c⁄√˘_böd_v5
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

112 
rc
;

114 if(
¥›îtõs
){

115 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_CONNECT
, 
¥›îtõs
);

116 if(
rc
) Ñc;

119 
rc
 = 
	`mosquôto__c⁄√˘_öô
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
böd_addªss
);

120 if(
rc
) Ñc;

122 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_√w
);

124  
	`mosquôto__ªc⁄√˘
(
mosq
, 
åue
, 
¥›îtõs
);

125 
	}
}

128 
	$mosquôto_c⁄√˘_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
)

130  
	`mosquôto_c⁄√˘_böd_async
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
NULL
);

131 
	}
}

134 
	$mosquôto_c⁄√˘_böd_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
)

136 
rc
 = 
	`mosquôto__c⁄√˘_öô
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
böd_addªss
);

137 if(
rc
) Ñc;

139  
	`mosquôto__ªc⁄√˘
(
mosq
, 
Ál£
, 
NULL
);

140 
	}
}

143 
	$mosquôto_ªc⁄√˘_async
(
mosquôto
 *
mosq
)

145  
	`mosquôto__ªc⁄√˘
(
mosq
, 
Ál£
, 
NULL
);

146 
	}
}

149 
	$mosquôto_ªc⁄√˘
(
mosquôto
 *
mosq
)

151  
	`mosquôto__ªc⁄√˘
(
mosq
, 
åue
, 
NULL
);

152 
	}
}

155 
	$mosquôto__ªc⁄√˘
(
mosquôto
 *
mosq
, 
boﬁ
 
blockög
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

157 c⁄° 
mosquôto_¥›îty
 *
outgoög_¥›îtõs
 = 
NULL
;

158 
mosquôto_¥›îty
 
loˇl_¥›îty
;

159 
rc
;

161 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

162 if(!
mosq
->
ho°
 || mosq->
p‹t
 <0Ë 
MOSQ_ERR_INVAL
;

163 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 && 
¥›îtõs
Ë 
MOSQ_ERR_NOT_SUPPORTED
;

165 if(
¥›îtõs
){

166 if(
¥›îtõs
->
˛õ¡_gíî©ed
){

167 
outgoög_¥›îtõs
 = 
¥›îtõs
;

169 
	`mem˝y
(&
loˇl_¥›îty
, 
¥›îtõs
, (
mosquôto_¥›îty
));

170 
loˇl_¥›îty
.
˛õ¡_gíî©ed
 = 
åue
;

171 
loˇl_¥›îty
.
√xt
 = 
NULL
;

172 
outgoög_¥›îtõs
 = &
loˇl_¥›îty
;

174 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_CONNECT
, 
outgoög_¥›îtõs
);

175 if(
rc
) Ñc;

178 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

179 
mosq
->
œ°_msg_ö
 = 
	`mosquôto_time
();

180 
mosq
->
√xt_msg_out
 = mosq->
œ°_msg_ö
 + mosq->
kì∑live
;

181 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

183 
mosq
->
pög_t
 = 0;

185 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

187 
	`∑ckë__˛ónup_Æl
(
mosq
);

189 
	`mesßge__ªc⁄√˘_ª£t
(
mosq
);

191 if(
mosq
->
sock
 !
INVALID_SOCKET
){

192 
	`√t__sockë_˛o£
(
mosq
);

195 #ifde‡
WITH_SOCKS


196 if(
mosq
->
socks5_ho°
){

197 
rc
 = 
	`√t__sockë_c⁄√˘
(
mosq
, mosq->
socks5_ho°
, mosq->
socks5_p‹t
, mosq->
böd_addªss
, 
blockög
);

201 
rc
 = 
	`√t__sockë_c⁄√˘
(
mosq
, mosq->
ho°
, mosq->
p‹t
, mosq->
böd_addªss
, 
blockög
);

203 if(
rc
>0){

204 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_c⁄√˘_≥ndög
);

205  
rc
;

208 #ifde‡
WITH_SOCKS


209 if(
mosq
->
socks5_ho°
){

210 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_√w
);

211  
	`socks5__£nd
(
mosq
);

215 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_c⁄√˘ed
);

216 
rc
 = 
	`£nd__c⁄√˘
(
mosq
, mosq->
kì∑live
, mosq->
˛ón_°¨t
, 
outgoög_¥›îtõs
);

217 if(
rc
){

218 
	`∑ckë__˛ónup_Æl
(
mosq
);

219 
	`√t__sockë_˛o£
(
mosq
);

220 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_√w
);

222  
rc
;

224 
	}
}

227 
	$mosquôto_disc⁄√˘
(
mosquôto
 *
mosq
)

229  
	`mosquôto_disc⁄√˘_v5
(
mosq
, 0, 
NULL
);

230 
	}
}

232 
	$mosquôto_disc⁄√˘_v5
(
mosquôto
 *
mosq
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

234 c⁄° 
mosquôto_¥›îty
 *
outgoög_¥›îtõs
 = 
NULL
;

235 
mosquôto_¥›îty
 
loˇl_¥›îty
;

236 
rc
;

237 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

238 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 && 
¥›îtõs
Ë 
MOSQ_ERR_NOT_SUPPORTED
;

240 if(
¥›îtõs
){

241 if(
¥›îtõs
->
˛õ¡_gíî©ed
){

242 
outgoög_¥›îtõs
 = 
¥›îtõs
;

244 
	`mem˝y
(&
loˇl_¥›îty
, 
¥›îtõs
, (
mosquôto_¥›îty
));

245 
loˇl_¥›îty
.
˛õ¡_gíî©ed
 = 
åue
;

246 
loˇl_¥›îty
.
√xt
 = 
NULL
;

247 
outgoög_¥›îtõs
 = &
loˇl_¥›îty
;

249 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_DISCONNECT
, 
outgoög_¥›îtõs
);

250 if(
rc
) Ñc;

253 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_disc⁄√˘ed
);

254 if(
mosq
->
sock
 =
INVALID_SOCKET
){

255  
MOSQ_ERR_NO_CONN
;

257  
	`£nd__disc⁄√˘
(
mosq
, 
ªas⁄_code
, 
outgoög_¥›îtõs
);

259 
	}
}

262 
	$do_˛õ¡_disc⁄√˘
(
mosquôto
 *
mosq
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

264 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_disc⁄√˘ed
);

265 
	`√t__sockë_˛o£
(
mosq
);

268 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

269 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

270 if(
mosq
->
out_∑ckë
){

271 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

272 if(!
mosq
->
out_∑ckë
){

273 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

276 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

278 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

279 
mosq
->
√xt_msg_out
 = 
	`mosquôto_time
(Ë+ mosq->
kì∑live
;

280 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

282 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

283 if(
mosq
->
⁄_disc⁄√˘
){

284 
mosq
->
ö_ˇŒback
 = 
åue
;

285 
mosq
->
	`⁄_disc⁄√˘
(mosq, mosq->
u£rd©a
, 
ªas⁄_code
);

286 
mosq
->
ö_ˇŒback
 = 
Ál£
;

288 if(
mosq
->
⁄_disc⁄√˘_v5
){

289 
mosq
->
ö_ˇŒback
 = 
åue
;

290 
mosq
->
	`⁄_disc⁄√˘_v5
(mosq, mosq->
u£rd©a
, 
ªas⁄_code
, 
¥›îtõs
);

291 
mosq
->
ö_ˇŒback
 = 
Ál£
;

293 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

294 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

295 
	}
}

	@lib/cpp/mosquittopp.cpp

17 
	~<c°dlib
>

18 
	~<mosquôto.h
>

19 
	~<mosquôt›p.h
>

21 
	#UNUSED
(
A
Ë()(A)

	)

23 
«me•a˚
 
	gmosqµ
 {

25 
⁄_c⁄√˘_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
rc
)

27 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

29 
UNUSED
(
mosq
);

31 
	gm
->
⁄_c⁄√˘
(
rc
);

34 
⁄_c⁄√˘_wôh_Êags_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
rc
, 
Êags
)

36 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

37 
UNUSED
(
mosq
);

38 
	gm
->
⁄_c⁄√˘_wôh_Êags
(
rc
, 
Êags
);

41 
⁄_disc⁄√˘_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
rc
)

43 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

44 
UNUSED
(
mosq
);

45 
	gm
->
⁄_disc⁄√˘
(
rc
);

48 
⁄_publish_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
mid
)

50 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

51 
UNUSED
(
mosq
);

52 
	gm
->
⁄_publish
(
mid
);

55 
⁄_mesßge_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

57 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

58 
UNUSED
(
mosq
);

59 
	gm
->
⁄_mesßge
(
mesßge
);

62 
⁄_subs¸ibe_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

64 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

65 
UNUSED
(
mosq
);

66 
	gm
->
⁄_subs¸ibe
(
mid
, 
qos_cou¡
, 
gø¡ed_qos
);

69 
⁄_unsubs¸ibe_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
mid
)

71 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

72 
UNUSED
(
mosq
);

73 
	gm
->
⁄_unsubs¸ibe
(
mid
);

77 
⁄_log_wøµî
(
mosquôto
 *
mosq
, *
u£rd©a
, 
Àvñ
, c⁄° *
°r
)

79 
˛ass
 
mosquôt›p
 *
	gm
 = (˛as†mosquôt›∞*)
u£rd©a
;

80 
UNUSED
(
mosq
);

81 
	gm
->
⁄_log
(
Àvñ
, 
°r
);

84 
lib_vîsi⁄
(*
maj‹
, *
mö‹
, *
ªvisi⁄
)

86 if(
	gmaj‹
Ë*maj‹ = 
LIBMOSQUITTO_MAJOR
;

87 if(
	gmö‹
Ë*mö‹ = 
LIBMOSQUITTO_MINOR
;

88 if(
	gªvisi⁄
Ë*ªvisi⁄ = 
LIBMOSQUITTO_REVISION
;

89  
	gLIBMOSQUITTO_VERSION_NUMBER
;

92 
lib_öô
()

94  
mosquôto_lib_öô
();

97 
lib_˛ónup
()

99  
mosquôto_lib_˛ónup
();

102 c⁄° * 
°ªº‹
(
mosq_î∫o
)

104  
mosquôto_°ªº‹
(
mosq_î∫o
);

107 c⁄° * 
c⁄«ck_°rög
(
c⁄«ck_code
)

109  
mosquôto_c⁄«ck_°rög
(
c⁄«ck_code
);

112 
sub_t›ic_tokíi£
(c⁄° *
subt›ic
, ***
t›ics
, *
cou¡
)

114  
mosquôto_sub_t›ic_tokíi£
(
subt›ic
, 
t›ics
, 
cou¡
);

117 
sub_t›ic_tokís_‰ì
(***
t›ics
, 
cou¡
)

119  
mosquôto_sub_t›ic_tokís_‰ì
(
t›ics
, 
cou¡
);

122 
t›ic_m©ches_sub
(c⁄° *
sub
, c⁄° *
t›ic
, 
boﬁ
 *
ªsu…
)

124  
mosquôto_t›ic_m©ches_sub
(
sub
, 
t›ic
, 
ªsu…
);

127 
vÆid©e_utf8
(c⁄° *
°r
, 
Àn
)

129  
mosquôto_vÆid©e_utf8
(
°r
, 
Àn
);

132 
subs¸ibe_sim∂e
(

133 
mosquôto_mesßge
 **
mesßges
,

134 
msg_cou¡
,

135 
boﬁ
 
ªèöed
,

136 c⁄° *
t›ic
,

137 
qos
,

138 c⁄° *
ho°
,

139 
p‹t
,

140 c⁄° *
˛õ¡_id
,

141 
kì∑live
,

142 
boﬁ
 
˛ón_£ssi⁄
,

143 c⁄° *
u£∫ame
,

144 c⁄° *
∑ssw‹d
,

145 c⁄° 
libmosquôto_wûl
 *
wûl
,

146 c⁄° 
libmosquôto_és
 *
és
)

148  
mosquôto_subs¸ibe_sim∂e
(

149 
mesßges
, 
msg_cou¡
, 
ªèöed
,

150 
t›ic
, 
qos
,

151 
ho°
, 
p‹t
, 
˛õ¡_id
, 
kì∑live
, 
˛ón_£ssi⁄
,

152 
u£∫ame
, 
∑ssw‹d
,

153 
wûl
, 
és
);

156 
mosqµ_EXPORT
 
subs¸ibe_ˇŒback
(

157 (*
ˇŒback
)(
mosquôto
 *, *, c⁄° 
mosquôto_mesßge
 *),

158 *
u£rd©a
,

159 c⁄° *
t›ic
,

160 
qos
,

161 c⁄° *
ho°
,

162 
p‹t
,

163 c⁄° *
˛õ¡_id
,

164 
kì∑live
,

165 
boﬁ
 
˛ón_£ssi⁄
,

166 c⁄° *
u£∫ame
,

167 c⁄° *
∑ssw‹d
,

168 c⁄° 
libmosquôto_wûl
 *
wûl
,

169 c⁄° 
libmosquôto_és
 *
és
)

171  
mosquôto_subs¸ibe_ˇŒback
(

172 
ˇŒback
, 
u£rd©a
,

173 
t›ic
, 
qos
,

174 
ho°
, 
p‹t
, 
˛õ¡_id
, 
kì∑live
, 
˛ón_£ssi⁄
,

175 
u£∫ame
, 
∑ssw‹d
,

176 
wûl
, 
és
);

180 
	gmosquôt›p
::
mosquôt›p
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
)

182 
	gm_mosq
 = 
mosquôto_√w
(
id
, 
˛ón_£ssi⁄
, 
this
);

183 
mosquôto_c⁄√˘_ˇŒback_£t
(
m_mosq
, 
⁄_c⁄√˘_wøµî
);

184 
mosquôto_c⁄√˘_wôh_Êags_ˇŒback_£t
(
m_mosq
, 
⁄_c⁄√˘_wôh_Êags_wøµî
);

185 
mosquôto_disc⁄√˘_ˇŒback_£t
(
m_mosq
, 
⁄_disc⁄√˘_wøµî
);

186 
mosquôto_publish_ˇŒback_£t
(
m_mosq
, 
⁄_publish_wøµî
);

187 
mosquôto_mesßge_ˇŒback_£t
(
m_mosq
, 
⁄_mesßge_wøµî
);

188 
mosquôto_subs¸ibe_ˇŒback_£t
(
m_mosq
, 
⁄_subs¸ibe_wøµî
);

189 
mosquôto_unsubs¸ibe_ˇŒback_£t
(
m_mosq
, 
⁄_unsubs¸ibe_wøµî
);

190 
mosquôto_log_ˇŒback_£t
(
m_mosq
, 
⁄_log_wøµî
);

193 
	gmosquôt›p
::~
mosquôt›p
()

195 
mosquôto_de°roy
(
m_mosq
);

198 
	gmosquôt›p
::
ªöôüli£
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
)

200 
	grc
;

201 
	grc
 = 
mosquôto_ªöôüli£
(
m_mosq
, 
id
, 
˛ón_£ssi⁄
, 
this
);

202 if(
	grc
 =
MOSQ_ERR_SUCCESS
){

203 
mosquôto_c⁄√˘_ˇŒback_£t
(
m_mosq
, 
⁄_c⁄√˘_wøµî
);

204 
mosquôto_c⁄√˘_wôh_Êags_ˇŒback_£t
(
m_mosq
, 
⁄_c⁄√˘_wôh_Êags_wøµî
);

205 
mosquôto_disc⁄√˘_ˇŒback_£t
(
m_mosq
, 
⁄_disc⁄√˘_wøµî
);

206 
mosquôto_publish_ˇŒback_£t
(
m_mosq
, 
⁄_publish_wøµî
);

207 
mosquôto_mesßge_ˇŒback_£t
(
m_mosq
, 
⁄_mesßge_wøµî
);

208 
mosquôto_subs¸ibe_ˇŒback_£t
(
m_mosq
, 
⁄_subs¸ibe_wøµî
);

209 
mosquôto_unsubs¸ibe_ˇŒback_£t
(
m_mosq
, 
⁄_unsubs¸ibe_wøµî
);

210 
mosquôto_log_ˇŒback_£t
(
m_mosq
, 
⁄_log_wøµî
);

212  
	grc
;

215 
	gmosquôt›p
::
c⁄√˘
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
)

217  
mosquôto_c⁄√˘
(
m_mosq
, 
ho°
, 
p‹t
, 
kì∑live
);

220 
	gmosquôt›p
::
c⁄√˘
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
)

222  
mosquôto_c⁄√˘_böd
(
m_mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
böd_addªss
);

225 
	gmosquôt›p
::
c⁄√˘_async
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
)

227  
mosquôto_c⁄√˘_async
(
m_mosq
, 
ho°
, 
p‹t
, 
kì∑live
);

230 
	gmosquôt›p
::
c⁄√˘_async
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
)

232  
mosquôto_c⁄√˘_böd_async
(
m_mosq
, 
ho°
, 
p‹t
, 
kì∑live
, 
böd_addªss
);

235 
	gmosquôt›p
::
ªc⁄√˘
()

237  
mosquôto_ªc⁄√˘
(
m_mosq
);

240 
	gmosquôt›p
::
ªc⁄√˘_async
()

242  
mosquôto_ªc⁄√˘_async
(
m_mosq
);

245 
	gmosquôt›p
::
disc⁄√˘
()

247  
mosquôto_disc⁄√˘
(
m_mosq
);

250 
	gmosquôt›p
::
sockë
()

252  
mosquôto_sockë
(
m_mosq
);

255 
	gmosquôt›p
::
wûl_£t
(c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

257  
mosquôto_wûl_£t
(
m_mosq
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
);

260 
	gmosquôt›p
::
wûl_˛ór
()

262  
mosquôto_wûl_˛ór
(
m_mosq
);

265 
	gmosquôt›p
::
u£∫ame_pw_£t
(c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

267  
mosquôto_u£∫ame_pw_£t
(
m_mosq
, 
u£∫ame
, 
∑ssw‹d
);

270 
	gmosquôt›p
::
publish
(*
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

272  
mosquôto_publish
(
m_mosq
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
);

275 
	gmosquôt›p
::
ªc⁄√˘_dñay_£t
(
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
)

277 
mosquôto_ªc⁄√˘_dñay_£t
(
m_mosq
, 
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
ªc⁄√˘_exp⁄ítül_backoff
);

280 
	gmosquôt›p
::
max_öÊight_mesßges_£t
(
max_öÊight_mesßges
)

282  
mosquôto_max_öÊight_mesßges_£t
(
m_mosq
, 
max_öÊight_mesßges
);

285 
	gmosquôt›p
::
mesßge_ªåy_£t
(
mesßge_ªåy
)

287 
mosquôto_mesßge_ªåy_£t
(
m_mosq
, 
mesßge_ªåy
);

290 
	gmosquôt›p
::
subs¸ibe
(*
mid
, c⁄° *
sub
, 
qos
)

292  
mosquôto_subs¸ibe
(
m_mosq
, 
mid
, 
sub
, 
qos
);

295 
	gmosquôt›p
::
unsubs¸ibe
(*
mid
, c⁄° *
sub
)

297  
mosquôto_unsubs¸ibe
(
m_mosq
, 
mid
, 
sub
);

300 
	gmosquôt›p
::
lo›
(
timeout
, 
max_∑ckës
)

302  
mosquôto_lo›
(
m_mosq
, 
timeout
, 
max_∑ckës
);

305 
	gmosquôt›p
::
lo›_misc
()

307  
mosquôto_lo›_misc
(
m_mosq
);

310 
	gmosquôt›p
::
lo›_ªad
(
max_∑ckës
)

312  
mosquôto_lo›_ªad
(
m_mosq
, 
max_∑ckës
);

315 
	gmosquôt›p
::
lo›_wrôe
(
max_∑ckës
)

317  
mosquôto_lo›_wrôe
(
m_mosq
, 
max_∑ckës
);

320 
	gmosquôt›p
::
lo›_f‹evî
(
timeout
, 
max_∑ckës
)

322  
mosquôto_lo›_f‹evî
(
m_mosq
, 
timeout
, 
max_∑ckës
);

325 
	gmosquôt›p
::
lo›_°¨t
()

327  
mosquôto_lo›_°¨t
(
m_mosq
);

330 
	gmosquôt›p
::
lo›_°›
(
boﬁ
 
f‹˚
)

332  
mosquôto_lo›_°›
(
m_mosq
, 
f‹˚
);

335 
boﬁ
 
	gmosquôt›p
::
w™t_wrôe
()

337  
mosquôto_w™t_wrôe
(
m_mosq
);

340 
	gmosquôt›p
::
›ts_£t
(
mosq_›t_t
 
›ti⁄
, *
vÆue
)

342  
mosquôto_›ts_£t
(
m_mosq
, 
›ti⁄
, 
vÆue
);

345 
	gmosquôt›p
::
thªaded_£t
(
boﬁ
 
thªaded
)

347  
mosquôto_thªaded_£t
(
m_mosq
, 
thªaded
);

350 
	gmosquôt›p
::
u£r_d©a_£t
(*
u£rd©a
)

352 
mosquôto_u£r_d©a_£t
(
m_mosq
, 
u£rd©a
);

355 
	gmosquôt›p
::
socks5_£t
(c⁄° *
ho°
, 
p‹t
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

357  
mosquôto_socks5_£t
(
m_mosq
, 
ho°
, 
p‹t
, 
u£∫ame
, 
∑ssw‹d
);

361 
	gmosquôt›p
::
és_£t
(c⁄° *
ˇfûe
, c⁄° *
ˇ∑th
, c⁄° *
˚πfûe
, c⁄° *
keyfûe
, (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
))

363  
mosquôto_és_£t
(
m_mosq
, 
ˇfûe
, 
ˇ∑th
, 
˚πfûe
, 
keyfûe
, 
pw_ˇŒback
);

366 
	gmosquôt›p
::
és_›ts_£t
(
˚π_ªqs
, c⁄° *
és_vîsi⁄
, c⁄° *
cùhîs
)

368  
mosquôto_és_›ts_£t
(
m_mosq
, 
˚π_ªqs
, 
és_vîsi⁄
, 
cùhîs
);

371 
	gmosquôt›p
::
és_ö£cuª_£t
(
boﬁ
 
vÆue
)

373  
mosquôto_és_ö£cuª_£t
(
m_mosq
, 
vÆue
);

376 
	gmosquôt›p
::
és_psk_£t
(c⁄° *
psk
, c⁄° *
idítôy
, c⁄° *
cùhîs
)

378  
mosquôto_és_psk_£t
(
m_mosq
, 
psk
, 
idítôy
, 
cùhîs
);

	@lib/cpp/mosquittopp.h

17 #i‚de‡
MOSQUITTOPP_H


18 
	#MOSQUITTOPP_H


	)

20 #i‡
deföed
(
_WIN32
Ë&& !deföed(
LIBMOSQUITTO_STATIC
)

21 #ifde‡
mosquôt›p_EXPORTS


22 
	#mosqµ_EXPORT
 
	`__de˛•ec
(
dŒexp‹t
)

	)

24 
	#mosqµ_EXPORT
 
	`__de˛•ec
(
dŒimp‹t
)

	)

27 
	#mosqµ_EXPORT


	)

30 #i‡
deföed
(
__GNUC__
Ë|| deföed(
__˛™g__
)

31 
	#DEPRECATED
 
	`__©åibuã__
 ((
dïªˇãd
))

	)

33 
	#DEPRECATED


	)

36 
	~<c°dlib
>

37 
	~<mosquôto.h
>

38 
	~<time.h
>

40 
«me•a˚
 
	gmosqµ
 {

43 
mosqµ_EXPORT
 c⁄° * 
DEPRECATED
 
°ªº‹
(
mosq_î∫o
);

44 
mosqµ_EXPORT
 c⁄° * 
DEPRECATED
 
c⁄«ck_°rög
(
c⁄«ck_code
);

45 
mosqµ_EXPORT
 
DEPRECATED
 
sub_t›ic_tokíi£
(c⁄° *
subt›ic
, ***
t›ics
, *
cou¡
);

46 
mosqµ_EXPORT
 
DEPRECATED
 
sub_t›ic_tokís_‰ì
(***
t›ics
, 
cou¡
);

47 
mosqµ_EXPORT
 
DEPRECATED
 
lib_vîsi⁄
(*
maj‹
, *
mö‹
, *
ªvisi⁄
);

48 
mosqµ_EXPORT
 
DEPRECATED
 
lib_öô
();

49 
mosqµ_EXPORT
 
DEPRECATED
 
lib_˛ónup
();

50 
mosqµ_EXPORT
 
DEPRECATED
 
t›ic_m©ches_sub
(c⁄° *
sub
, c⁄° *
t›ic
, 
boﬁ
 *
ªsu…
);

51 
mosqµ_EXPORT
 
DEPRECATED
 
vÆid©e_utf8
(c⁄° *
°r
, 
Àn
);

52 
mosqµ_EXPORT
 
DEPRECATED
 
subs¸ibe_sim∂e
(

53 
mosquôto_mesßge
 **
mesßges
,

54 
msg_cou¡
,

55 
boﬁ
 
ªèöed
,

56 c⁄° *
t›ic
,

57 
qos
=0,

58 c⁄° *
ho°
="localhost",

59 
p‹t
=1883,

60 c⁄° *
˛õ¡_id
=
NULL
,

61 
kì∑live
=60,

62 
boﬁ
 
˛ón_£ssi⁄
=
åue
,

63 c⁄° *
u£∫ame
=
NULL
,

64 c⁄° *
∑ssw‹d
=
NULL
,

65 c⁄° 
libmosquôto_wûl
 *
wûl
=
NULL
,

66 c⁄° 
libmosquôto_és
 *
és
=
NULL
);

68 
mosqµ_EXPORT
 
DEPRECATED
 
subs¸ibe_ˇŒback
(

69 (*
ˇŒback
)(
mosquôto
 *, *, c⁄° 
mosquôto_mesßge
 *),

70 *
u£rd©a
,

71 c⁄° *
t›ic
,

72 
qos
=0,

73 
boﬁ
 
ªèöed
=
åue
,

74 c⁄° *
ho°
="localhost",

75 
p‹t
=1883,

76 c⁄° *
˛õ¡_id
=
NULL
,

77 
kì∑live
=60,

78 
boﬁ
 
˛ón_£ssi⁄
=
åue
,

79 c⁄° *
u£∫ame
=
NULL
,

80 c⁄° *
∑ssw‹d
=
NULL
,

81 c⁄° 
libmosquôto_wûl
 *
wûl
=
NULL
,

82 c⁄° 
libmosquôto_és
 *
és
=
NULL
);

90 ˛as†
	cmosqµ_EXPORT
 
DEPRECATED
 
	gmosquôt›p
 {

91 
	g¥iv©e
:

92 
mosquôto
 *
m_mosq
;

93 
	gpublic
:

94 
DEPRECATED
 
mosquôt›p
(c⁄° *
id
=
NULL
, 
boﬁ
 
˛ón_£ssi⁄
=
åue
);

95 
	gvútuÆ
 ~
mosquôt›p
();

97 
DEPRECATED
 
ªöôüli£
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
);

98 
DEPRECATED
 
sockë
();

99 
DEPRECATED
 
wûl_£t
(c⁄° *
t›ic
, 
∑ylﬂdÀn
=0, c⁄° *
∑ylﬂd
=
NULL
, 
qos
=0, 
boﬁ
 
ªèö
=
Ál£
);

100 
DEPRECATED
 
wûl_˛ór
();

101 
DEPRECATED
 
u£∫ame_pw_£t
(c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
=
NULL
);

102 
DEPRECATED
 
c⁄√˘
(c⁄° *
ho°
, 
p‹t
=1883, 
kì∑live
=60);

103 
DEPRECATED
 
c⁄√˘_async
(c⁄° *
ho°
, 
p‹t
=1883, 
kì∑live
=60);

104 
DEPRECATED
 
c⁄√˘
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

105 
DEPRECATED
 
c⁄√˘_async
(c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

106 
DEPRECATED
 
ªc⁄√˘
();

107 
DEPRECATED
 
ªc⁄√˘_async
();

108 
DEPRECATED
 
disc⁄√˘
();

109 
DEPRECATED
 
publish
(*
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
=0, c⁄° *
∑ylﬂd
=
NULL
, 
qos
=0, 
boﬁ
 
ªèö
=
Ál£
);

110 
DEPRECATED
 
subs¸ibe
(*
mid
, c⁄° *
sub
, 
qos
=0);

111 
DEPRECATED
 
unsubs¸ibe
(*
mid
, c⁄° *
sub
);

112 
DEPRECATED
 
ªc⁄√˘_dñay_£t
(
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
);

113 
DEPRECATED
 
max_öÊight_mesßges_£t
(
max_öÊight_mesßges
);

114 
DEPRECATED
 
mesßge_ªåy_£t
(
mesßge_ªåy
);

115 
DEPRECATED
 
u£r_d©a_£t
(*
u£rd©a
);

116 
DEPRECATED
 
és_£t
(c⁄° *
ˇfûe
, c⁄° *
ˇ∑th
=
NULL
, c⁄° *
˚πfûe
=NULL, c⁄° *
keyfûe
=NULL, (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
)=NULL);

117 
DEPRECATED
 
és_›ts_£t
(
˚π_ªqs
, c⁄° *
és_vîsi⁄
=
NULL
, c⁄° *
cùhîs
=NULL);

118 
DEPRECATED
 
és_ö£cuª_£t
(
boﬁ
 
vÆue
);

119 
DEPRECATED
 
és_psk_£t
(c⁄° *
psk
, c⁄° *
idítôy
, c⁄° *
cùhîs
=
NULL
);

120 
DEPRECATED
 
›ts_£t
(
mosq_›t_t
 
›ti⁄
, *
vÆue
);

122 
DEPRECATED
 
lo›
(
timeout
=-1, 
max_∑ckës
=1);

123 
DEPRECATED
 
lo›_misc
();

124 
DEPRECATED
 
lo›_ªad
(
max_∑ckës
=1);

125 
DEPRECATED
 
lo›_wrôe
(
max_∑ckës
=1);

126 
DEPRECATED
 
lo›_f‹evî
(
timeout
=-1, 
max_∑ckës
=1);

127 
DEPRECATED
 
lo›_°¨t
();

128 
DEPRECATED
 
lo›_°›
(
boﬁ
 
f‹˚
=
Ál£
);

129 
boﬁ
 
DEPRECATED
 
w™t_wrôe
();

130 
DEPRECATED
 
thªaded_£t
(
boﬁ
 
thªaded
=
åue
);

131 
DEPRECATED
 
socks5_£t
(c⁄° *
ho°
, 
p‹t
=1080, c⁄° *
u£∫ame
=
NULL
, c⁄° *
∑ssw‹d
=NULL);

134 
vútuÆ
 
⁄_c⁄√˘
() {;}

135 
vútuÆ
 
⁄_c⁄√˘_wôh_Êags
(, ) {;}

136 
vútuÆ
 
⁄_disc⁄√˘
() {;}

137 
vútuÆ
 
⁄_publish
() {;}

138 
vútuÆ
 
⁄_mesßge
(c⁄° 
mosquôto_mesßge
 * ) {;}

139 
vútuÆ
 
⁄_subs¸ibe
(, , const * ) {;}

140 
vútuÆ
 
⁄_unsubs¸ibe
() {;}

141 
vútuÆ
 
⁄_log
(, const * ) {;}

142 
vútuÆ
 
⁄_îr‹
() {;}

	@lib/dummypthread.h

1 #i‚de‡
DUMMYPTHREAD_H


2 
	#DUMMYPTHREAD_H


	)

4 
	#±hªad_¸óã
(
A
, 
B
, 
C
, 
D
)

	)

5 
	#±hªad_joö
(
A
, 
B
)

	)

6 
	#±hªad_ˇn˚l
(
A
)

	)

8 
	#±hªad_muãx_öô
(
A
, 
B
)

	)

9 
	#±hªad_muãx_de°roy
(
A
)

	)

10 
	#±hªad_muãx_lock
(
A
)

	)

11 
	#±hªad_muãx_u∆ock
(
A
)

	)

	@lib/handle_auth.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"loggög_mosq.h
"

23 
	~"mosquôto_öã∫Æ.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"¥›îty_mosq.h
"

29 
	$h™dÀ__auth
(
mosquôto
 *
mosq
)

31 
rc
 = 0;

32 
uöt8_t
 
ªas⁄_code
;

33 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

35 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

36 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived AUTH", mosq->
id
);

38 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

39  
MOSQ_ERR_PROTOCOL
;

42 if(
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
))  1;

44 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_AUTH
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

45 if(
rc
) Ñc;

46 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

48  
MOSQ_ERR_SUCCESS
;

49 
	}
}

	@lib/handle_connack.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

21 
	~"mosquôto.h
"

22 
	~"loggög_mosq.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mesßges_mosq.h
"

25 
	~"mqâ_¥Ÿocﬁ.h
"

26 
	~"√t_mosq.h
"

27 
	~"∑ckë_mosq.h
"

28 
	~"¥›îty_mosq.h
"

29 
	~"ªad_h™dÀ.h
"

31 
	$c⁄«ck_ˇŒback
(
mosquôto
 *
mosq
, 
uöt8_t
 
ªas⁄_code
, uöt8_à
c⁄√˘_Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

33 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived CONNACK (%d)", mosq->
id
, 
ªas⁄_code
);

34 if(
ªas⁄_code
 =
MQTT_RC_SUCCESS
){

35 
mosq
->
ªc⁄√˘s
 = 0;

37 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

38 if(
mosq
->
⁄_c⁄√˘
){

39 
mosq
->
ö_ˇŒback
 = 
åue
;

40 
mosq
->
	`⁄_c⁄√˘
(mosq, mosq->
u£rd©a
, 
ªas⁄_code
);

41 
mosq
->
ö_ˇŒback
 = 
Ál£
;

43 if(
mosq
->
⁄_c⁄√˘_wôh_Êags
){

44 
mosq
->
ö_ˇŒback
 = 
åue
;

45 
mosq
->
	`⁄_c⁄√˘_wôh_Êags
(mosq, mosq->
u£rd©a
, 
ªas⁄_code
, 
c⁄√˘_Êags
);

46 
mosq
->
ö_ˇŒback
 = 
Ál£
;

48 if(
mosq
->
⁄_c⁄√˘_v5
){

49 
mosq
->
ö_ˇŒback
 = 
åue
;

50 
mosq
->
	`⁄_c⁄√˘_v5
(mosq, mosq->
u£rd©a
, 
ªas⁄_code
, 
c⁄√˘_Êags
, 
¥›îtõs
);

51 
mosq
->
ö_ˇŒback
 = 
Ál£
;

53 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

54 
	}
}

57 
	$h™dÀ__c⁄«ck
(
mosquôto
 *
mosq
)

59 
uöt8_t
 
c⁄√˘_Êags
;

60 
uöt8_t
 
ªas⁄_code
;

61 
rc
;

62 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

63 *
˛õ¡id
 = 
NULL
;

65 
	`as£π
(
mosq
);

66 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
c⁄√˘_Êags
);

67 if(
rc
) Ñc;

68 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
);

69 if(
rc
) Ñc;

71 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

72 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNACK
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

74 if(
rc
 =
MOSQ_ERR_PROTOCOL
 && 
ªas⁄_code
 =
CONNACK_REFUSED_PROTOCOL_VERSION
){

79 
	`c⁄«ck_ˇŒback
(
mosq
, 
MQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
, 
c⁄√˘_Êags
, 
NULL
);

80  
rc
;

81 }if(
rc
){

82  
rc
;

86 
	`mosquôto_¥›îty_ªad_°rög
(
¥›îtõs
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, &
˛õ¡id
, 
Ál£
);

87 if(
˛õ¡id
){

88 if(
mosq
->
id
){

91 
	`‰ì
(
˛õ¡id
);

92 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

93  
MOSQ_ERR_PROTOCOL
;

95 
mosq
->
id
 = 
˛õ¡id
;

96 
˛õ¡id
 = 
NULL
;

100 
	`mosquôto_¥›îty_ªad_byã
(
¥›îtõs
, 
MQTT_PROP_MAXIMUM_QOS
, &
mosq
->
maximum_qos
, 
Ál£
);

101 
	`mosquôto_¥›îty_ªad_öt16
(
¥›îtõs
, 
MQTT_PROP_RECEIVE_MAXIMUM
, &
mosq
->
msgs_out
.
öÊight_maximum
, 
Ál£
);

102 
	`mosquôto_¥›îty_ªad_öt16
(
¥›îtõs
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, &
mosq
->
kì∑live
, 
Ál£
);

103 
	`mosquôto_¥›îty_ªad_öt32
(
¥›îtõs
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, &
mosq
->
maximum_∑ckë_size
, 
Ál£
);

105 
mosq
->
msgs_out
.
öÊight_quŸa
 = mosq->msgs_out.
öÊight_maximum
;

107 
	`c⁄«ck_ˇŒback
(
mosq
, 
ªas⁄_code
, 
c⁄√˘_Êags
, 
¥›îtõs
);

108 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

110 
ªas⁄_code
){

112 
	`±hªad_muãx_lock
(&
mosq
->
°©e_muãx
);

113 if(
mosq
->
°©e
 !
mosq_cs_disc⁄√˘ög
){

114 
mosq
->
°©e
 = 
mosq_cs_a˘ive
;

116 
	`±hªad_muãx_u∆ock
(&
mosq
->
°©e_muãx
);

117 
	`mesßge__ªåy_check
(
mosq
);

118  
MOSQ_ERR_SUCCESS
;

124  
MOSQ_ERR_CONN_REFUSED
;

126  
MOSQ_ERR_PROTOCOL
;

128 
	}
}

	@lib/handle_disconnect.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"loggög_mosq.h
"

23 
	~"mqâ_¥Ÿocﬁ.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"√t_mosq.h
"

26 
	~"∑ckë_mosq.h
"

27 
	~"¥›îty_mosq.h
"

28 
	~"£nd_mosq.h
"

29 
	~"utû_mosq.h
"

31 
	$h™dÀ__disc⁄√˘
(
mosquôto
 *
mosq
)

33 
rc
;

34 
uöt8_t
 
ªas⁄_code
;

35 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

37 if(!
mosq
){

38  
MOSQ_ERR_INVAL
;

41 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

42  
MOSQ_ERR_PROTOCOL
;

45 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
);

46 if(
rc
) Ñc;

48 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 2){

49 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_DISCONNECT
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

50 if(
rc
) Ñc;

51 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

54 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Re˚ived DISCONNECT (%d)", 
ªas⁄_code
);

56 
	`do_˛õ¡_disc⁄√˘
(
mosq
, 
ªas⁄_code
, 
¥›îtõs
);

58 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

60  
MOSQ_ERR_SUCCESS
;

61 
	}
}

	@lib/handle_ping.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

27 
	~"mosquôto.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"ªad_h™dÀ.h
"

35 
	~"£nd_mosq.h
"

36 
	~"utû_mosq.h
"

38 
	$h™dÀ__pögªq
(
mosquôto
 *
mosq
)

40 
°©e
;

42 
	`as£π
(
mosq
);

44 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

45 if(
°©e
 !
mosq_cs_a˘ive
){

46  
MOSQ_ERR_PROTOCOL
;

49 #ifde‡
WITH_BROKER


50 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PINGREQ from %s", 
mosq
->
id
);

52 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived PINGREQ", mosq->
id
);

54  
	`£nd__pögª•
(
mosq
);

55 
	}
}

57 
	$h™dÀ__pögª•
(
mosquôto
 *
mosq
)

59 
°©e
;

61 
	`as£π
(
mosq
);

63 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

64 if(
°©e
 !
mosq_cs_a˘ive
){

65  
MOSQ_ERR_PROTOCOL
;

68 
mosq
->
pög_t
 = 0;

69 #ifde‡
WITH_BROKER


70 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PINGRESP from %s", 
mosq
->
id
);

72 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived PINGRESP", mosq->
id
);

74  
MOSQ_ERR_SUCCESS
;

75 
	}
}

	@lib/handle_pubackcomp.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

27 
	~"mosquôto.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"ªad_h™dÀ.h
"

35 
	~"£nd_mosq.h
"

36 
	~"utû_mosq.h
"

39 #ifde‡
WITH_BROKER


40 
	$h™dÀ__pubackcomp
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
, c⁄° *
ty≥
)

42 
	$h™dÀ__pubackcomp
(
mosquôto
 *
mosq
, c⁄° *
ty≥
)

45 
uöt8_t
 
ªas⁄_code
 = 0;

46 
uöt16_t
 
mid
;

47 
rc
;

48 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

49 
qos
;

50 
°©e
;

52 
	`as£π
(
mosq
);

54 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

55 if(
°©e
 !
mosq_cs_a˘ive
){

56  
MOSQ_ERR_PROTOCOL
;

59 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

60 
	`utû__ö¸emít_£nd_quŸa
(
mosq
);

61 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

63 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

64 if(
rc
) Ñc;

65 
qos
 = 
ty≥
[3] == 'A'?1:2;

66 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

68 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && mosq->
ö_∑ckë
.
ªmaöög_Àngth
 > 2){

69 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
);

70 if(
rc
) Ñc;

72 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 3){

73 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBACK
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

74 if(
rc
) Ñc;

78 #ifde‡
WITH_BROKER


79 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived %†‰om %†(Mid: %d, RC:%d)", 
ty≥
, 
mosq
->
id
, 
mid
, 
ªas⁄_code
);

82 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

84 
rc
 = 
	`db__mesßge_dñëe_outgoög
(
db
, 
mosq
, 
mid
, 
mosq_ms_waô_f‹_pubcomp
, 
qos
);

85 if(
rc
 =
MOSQ_ERR_NOT_FOUND
){

86 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_WARNING
, "W¨nög: Re˚ived %†‰om %†f‹á¿unknow¿∑ckë idítifõ∏%d.", 
ty≥
, mosq->
id
, 
mid
);

87  
MOSQ_ERR_SUCCESS
;

89  
rc
;

92 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived %†(Mid: %d, RC:%d)", mosq->
id
, 
ty≥
, 
mid
, 
ªas⁄_code
);

94 
rc
 = 
	`mesßge__dñëe
(
mosq
, 
mid
, 
mosq_md_out
, 
qos
);

95 if(
rc
){

96  
rc
;

99 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

100 if(
mosq
->
⁄_publish
){

101 
mosq
->
ö_ˇŒback
 = 
åue
;

102 
mosq
->
	`⁄_publish
(mosq, mosq->
u£rd©a
, 
mid
);

103 
mosq
->
ö_ˇŒback
 = 
Ál£
;

105 if(
mosq
->
⁄_publish_v5
){

106 
mosq
->
ö_ˇŒback
 = 
åue
;

107 
mosq
->
	`⁄_publish_v5
(mosq, mosq->
u£rd©a
, 
mid
, 
ªas⁄_code
, 
¥›îtõs
);

108 
mosq
->
ö_ˇŒback
 = 
Ál£
;

110 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

111 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

113 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

114 
	`mesßge__ªÀa£_to_öÊight
(
mosq
, 
mosq_md_out
);

115 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

117  
MOSQ_ERR_SUCCESS
;

119 
	}
}

	@lib/handle_publish.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto.h
"

23 
	~"mosquôto_öã∫Æ.h
"

24 
	~"loggög_mosq.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"mqâ_¥Ÿocﬁ.h
"

27 
	~"mesßges_mosq.h
"

28 
	~"∑ckë_mosq.h
"

29 
	~"¥›îty_mosq.h
"

30 
	~"£nd_mosq.h
"

31 
	~"time_mosq.h
"

32 
	~"utû_mosq.h
"

35 
	$h™dÀ__publish
(
mosquôto
 *
mosq
)

37 
uöt8_t
 
hódî
;

38 
mosquôto_mesßge_Æl
 *
mesßge
;

39 
rc
 = 0;

40 
uöt16_t
 
mid
;

41 
¶í
;

42 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

43 
°©e
;

45 
	`as£π
(
mosq
);

47 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

48 if(
°©e
 !
mosq_cs_a˘ive
){

49  
MOSQ_ERR_PROTOCOL
;

52 
mesßge
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_mesßge_Æl
));

53 if(!
mesßge
Ë 
MOSQ_ERR_NOMEM
;

55 
hódî
 = 
mosq
->
ö_∑ckë
.
comm™d
;

57 
mesßge
->
dup
 = (
hódî
 & 0x08)>>3;

58 
mesßge
->
msg
.
qos
 = (
hódî
 & 0x06)>>1;

59 
mesßge
->
msg
.
ªèö
 = (
hódî
 & 0x01);

61 
rc
 = 
	`∑ckë__ªad_°rög
(&
mosq
->
ö_∑ckë
, &
mesßge
->
msg
.
t›ic
, &
¶í
);

62 if(
rc
){

63 
	`mesßge__˛ónup
(&
mesßge
);

64  
rc
;

66 if(!
¶í
){

67 
	`mesßge__˛ónup
(&
mesßge
);

68  
MOSQ_ERR_PROTOCOL
;

71 if(
mesßge
->
msg
.
qos
 > 0){

72 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

73 if(
mosq
->
msgs_ö
.
öÊight_quŸa
 == 0){

74 
	`mesßge__˛ónup
(&
mesßge
);

76  
MOSQ_ERR_PROTOCOL
;

80 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

81 if(
rc
){

82 
	`mesßge__˛ónup
(&
mesßge
);

83  
rc
;

85 if(
mid
 == 0){

86 
	`mesßge__˛ónup
(&
mesßge
);

87  
MOSQ_ERR_PROTOCOL
;

89 
mesßge
->
msg
.
mid
 = ()mid;

92 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

93 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

94 if(
rc
) Ñc;

97 
mesßge
->
msg
.
∑ylﬂdÀn
 = 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 - mosq->ö_∑ckë.
pos
;

98 if(
mesßge
->
msg
.
∑ylﬂdÀn
){

99 
mesßge
->
msg
.
∑ylﬂd
 = 
	`mosquôto__ˇŒoc
(mesßge->msg.
∑ylﬂdÀn
+1, (
uöt8_t
));

100 if(!
mesßge
->
msg
.
∑ylﬂd
){

101 
	`mesßge__˛ónup
(&
mesßge
);

102 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

103  
MOSQ_ERR_NOMEM
;

105 
rc
 = 
	`∑ckë__ªad_byãs
(&
mosq
->
ö_∑ckë
, 
mesßge
->
msg
.
∑ylﬂd
, mesßge->msg.
∑ylﬂdÀn
);

106 if(
rc
){

107 
	`mesßge__˛ónup
(&
mesßge
);

108 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

109  
rc
;

112 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
,

114 
mosq
->
id
, 
mesßge
->
dup
, mesßge->
msg
.
qos
, mesßge->msg.
ªèö
,

115 
mesßge
->
msg
.
mid
, mesßge->msg.
t›ic
,

116 ()
mesßge
->
msg
.
∑ylﬂdÀn
);

118 
mesßge
->
time°amp
 = 
	`mosquôto_time
();

119 
mesßge
->
msg
.
qos
){

121 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

122 if(
mosq
->
⁄_mesßge
){

123 
mosq
->
ö_ˇŒback
 = 
åue
;

124 
mosq
->
	`⁄_mesßge
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
);

125 
mosq
->
ö_ˇŒback
 = 
Ál£
;

127 if(
mosq
->
⁄_mesßge_v5
){

128 
mosq
->
ö_ˇŒback
 = 
åue
;

129 
mosq
->
	`⁄_mesßge_v5
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
, 
¥›îtõs
);

130 
mosq
->
ö_ˇŒback
 = 
Ál£
;

132 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

133 
	`mesßge__˛ónup
(&
mesßge
);

134 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

135  
MOSQ_ERR_SUCCESS
;

137 
	`utû__de¸emít_ª˚ive_quŸa
(
mosq
);

138 
rc
 = 
	`£nd__puback
(
mosq
, 
mesßge
->
msg
.
mid
, 0);

139 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

140 if(
mosq
->
⁄_mesßge
){

141 
mosq
->
ö_ˇŒback
 = 
åue
;

142 
mosq
->
	`⁄_mesßge
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
);

143 
mosq
->
ö_ˇŒback
 = 
Ál£
;

145 if(
mosq
->
⁄_mesßge_v5
){

146 
mosq
->
ö_ˇŒback
 = 
åue
;

147 
mosq
->
	`⁄_mesßge_v5
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
, 
¥›îtõs
);

148 
mosq
->
ö_ˇŒback
 = 
Ál£
;

150 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

151 
	`mesßge__˛ónup
(&
mesßge
);

152 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

153  
rc
;

155 
	`utû__de¸emít_ª˚ive_quŸa
(
mosq
);

156 
rc
 = 
	`£nd__pubªc
(
mosq
, 
mesßge
->
msg
.
mid
, 0);

157 
	`±hªad_muãx_lock
(&
mosq
->
msgs_ö
.
muãx
);

158 
mesßge
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

159 
	`mesßge__queue
(
mosq
, 
mesßge
, 
mosq_md_ö
);

160 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

161 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

162  
rc
;

164 
	`mesßge__˛ónup
(&
mesßge
);

165 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

166  
MOSQ_ERR_PROTOCOL
;

168 
	}
}

	@lib/handle_pubrec.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

27 
	~"mosquôto.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"ªad_h™dÀ.h
"

35 
	~"£nd_mosq.h
"

36 
	~"utû_mosq.h
"

38 
	$h™dÀ__pubªc
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

40 
uöt8_t
 
ªas⁄_code
 = 0;

41 
uöt16_t
 
mid
;

42 
rc
;

43 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

44 
°©e
;

46 
	`as£π
(
mosq
);

48 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

49 if(
°©e
 !
mosq_cs_a˘ive
){

50  
MOSQ_ERR_PROTOCOL
;

53 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

54 if(
rc
) Ñc;

55 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

57 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && mosq->
ö_∑ckë
.
ªmaöög_Àngth
 > 2){

58 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
);

59 if(
rc
) Ñc;

61 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 3){

62 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBREC
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

63 if(
rc
) Ñc;

65 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

69 #ifde‡
WITH_BROKER


70 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PUBREC from %†(Mid: %d)", 
mosq
->
id
, 
mid
);

72 if(
ªas⁄_code
 < 0x80){

73 
rc
 = 
	`db__mesßge_upd©e_outgoög
(
mosq
, 
mid
, 
mosq_ms_waô_f‹_pubcomp
, 2);

75  
	`db__mesßge_dñëe_outgoög
(
db
, 
mosq
, 
mid
, 
mosq_ms_waô_f‹_pubªc
, 2);

78 
	`UNUSED
(
db
);

80 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived PUBREC (Mid: %d)", mosq->
id
, 
mid
);

82 if(
ªas⁄_code
 < 0x80 || 
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

83 
rc
 = 
	`mesßge__out_upd©e
(
mosq
, 
mid
, 
mosq_ms_waô_f‹_pubcomp
, 2);

85 if(!
	`mesßge__dñëe
(
mosq
, 
mid
, 
mosq_md_out
, 2)){

87 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

88 if(
mosq
->
⁄_publish_v5
){

89 
mosq
->
ö_ˇŒback
 = 
åue
;

90 
mosq
->
	`⁄_publish_v5
(mosq, mosq->
u£rd©a
, 
mid
, 
ªas⁄_code
, 
¥›îtõs
);

91 
mosq
->
ö_ˇŒback
 = 
Ál£
;

93 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

95 
	`utû__ö¸emít_£nd_quŸa
(
mosq
);

96 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

97 
	`mesßge__ªÀa£_to_öÊight
(
mosq
, 
mosq_md_out
);

98 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

99  
MOSQ_ERR_SUCCESS
;

102 if(
rc
 =
MOSQ_ERR_NOT_FOUND
){

103 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_WARNING
, "W¨nög: Re˚ived PUBREC from %†f‹á¿unknow¿∑ckë idítifõ∏%d.", mosq->
id
, 
mid
);

104 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

105  
rc
;

107 
rc
 = 
	`£nd__pubªl
(
mosq
, 
mid
);

108 if(
rc
) Ñc;

110  
MOSQ_ERR_SUCCESS
;

111 
	}
}

	@lib/handle_pubrel.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

27 
	~"mosquôto.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"ªad_h™dÀ.h
"

35 
	~"£nd_mosq.h
"

36 
	~"utû_mosq.h
"

39 
	$h™dÀ__pubªl
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

41 
uöt8_t
 
ªas⁄_code
;

42 
uöt16_t
 
mid
;

43 #i‚de‡
WITH_BROKER


44 
mosquôto_mesßge_Æl
 *
mesßge
 = 
NULL
;

46 
rc
;

47 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

48 
°©e
;

50 
	`as£π
(
mosq
);

52 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

53 if(
°©e
 !
mosq_cs_a˘ive
){

54  
MOSQ_ERR_PROTOCOL
;

57 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ31
){

58 if((
mosq
->
ö_∑ckë
.
comm™d
&0x0F) != 0x02){

59  
MOSQ_ERR_PROTOCOL
;

62 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

63 if(
rc
) Ñc;

64 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

66 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && mosq->
ö_∑ckë
.
ªmaöög_Àngth
 > 2){

67 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
ªas⁄_code
);

68 if(
rc
) Ñc;

70 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 3){

71 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBREL
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

72 if(
rc
) Ñc;

76 #ifde‡
WITH_BROKER


77 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PUBREL from %†(Mid: %d)", 
mosq
->
id
, 
mid
);

80 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

82 
rc
 = 
	`db__mesßge_ªÀa£_öcomög
(
db
, 
mosq
, 
mid
);

83 if(
rc
 =
MOSQ_ERR_NOT_FOUND
){

86 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

87  
rc
;

90 
rc
 = 
	`£nd__pubcomp
(
mosq
, 
mid
);

91 if(
rc
) Ñc;

93 
	`UNUSED
(
db
);

95 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived PUBREL (Mid: %d)", mosq->
id
, 
mid
);

97 
rc
 = 
	`£nd__pubcomp
(
mosq
, 
mid
);

98 if(
rc
){

99 
	`mesßge__ªmove
(
mosq
, 
mid
, 
mosq_md_ö
, &
mesßge
, 2);

100  
rc
;

103 
rc
 = 
	`mesßge__ªmove
(
mosq
, 
mid
, 
mosq_md_ö
, &
mesßge
, 2);

104 if(
rc
){

105  
rc
;

109 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

110 if(
mosq
->
⁄_mesßge
){

111 
mosq
->
ö_ˇŒback
 = 
åue
;

112 
mosq
->
	`⁄_mesßge
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
);

113 
mosq
->
ö_ˇŒback
 = 
Ál£
;

115 if(
mosq
->
⁄_mesßge_v5
){

116 
mosq
->
ö_ˇŒback
 = 
åue
;

117 
mosq
->
	`⁄_mesßge_v5
(mosq, mosq->
u£rd©a
, &
mesßge
->
msg
, 
¥›îtõs
);

118 
mosq
->
ö_ˇŒback
 = 
Ál£
;

120 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

121 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

122 
	`mesßge__˛ónup
(&
mesßge
);

126  
MOSQ_ERR_SUCCESS
;

127 
	}
}

	@lib/handle_suback.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

21 #ifde‡
WITH_BROKER


22 
	~"mosquôto_brokî_öã∫Æ.h
"

25 
	~"mosquôto.h
"

26 
	~"mosquôto_öã∫Æ.h
"

27 
	~"loggög_mosq.h
"

28 
	~"mem‹y_mosq.h
"

29 
	~"mqâ_¥Ÿocﬁ.h
"

30 
	~"∑ckë_mosq.h
"

31 
	~"¥›îty_mosq.h
"

32 
	~"utû_mosq.h
"

35 
	$h™dÀ__suback
(
mosquôto
 *
mosq
)

37 
uöt16_t
 
mid
;

38 
uöt8_t
 
qos
;

39 *
gø¡ed_qos
;

40 
qos_cou¡
;

41 
i
 = 0;

42 
rc
;

43 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

44 
°©e
;

46 
	`as£π
(
mosq
);

48 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

49 if(
°©e
 !
mosq_cs_a˘ive
){

50  
MOSQ_ERR_PROTOCOL
;

53 #ifde‡
WITH_BROKER


54 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived SUBACK from %s", 
mosq
->
id
);

56 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived SUBACK", mosq->
id
);

58 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

59 if(
rc
) Ñc;

60 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

62 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

63 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_SUBACK
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

64 if(
rc
) Ñc;

67 
qos_cou¡
 = 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 - mosq->ö_∑ckë.
pos
;

68 
gø¡ed_qos
 = 
	`mosquôto__mÆloc
(
qos_cou¡
*());

69 if(!
gø¡ed_qos
Ë 
MOSQ_ERR_NOMEM
;

70 
mosq
->
ö_∑ckë
.
pos
 < mosq->ö_∑ckë.
ªmaöög_Àngth
){

71 
rc
 = 
	`∑ckë__ªad_byã
(&
mosq
->
ö_∑ckë
, &
qos
);

72 if(
rc
){

73 
	`mosquôto__‰ì
(
gø¡ed_qos
);

74  
rc
;

76 
gø¡ed_qos
[
i
] = ()
qos
;

77 
i
++;

79 #ifde‡
WITH_BROKER


81 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

83 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

84 if(
mosq
->
⁄_subs¸ibe
){

85 
mosq
->
ö_ˇŒback
 = 
åue
;

86 
mosq
->
	`⁄_subs¸ibe
(mosq, mosq->
u£rd©a
, 
mid
, 
qos_cou¡
, 
gø¡ed_qos
);

87 
mosq
->
ö_ˇŒback
 = 
Ál£
;

89 if(
mosq
->
⁄_subs¸ibe_v5
){

90 
mosq
->
ö_ˇŒback
 = 
åue
;

91 
mosq
->
	`⁄_subs¸ibe_v5
(mosq, mosq->
u£rd©a
, 
mid
, 
qos_cou¡
, 
gø¡ed_qos
, 
¥›îtõs
);

92 
mosq
->
ö_ˇŒback
 = 
Ál£
;

94 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

95 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

97 
	`mosquôto__‰ì
(
gø¡ed_qos
);

99  
MOSQ_ERR_SUCCESS
;

100 
	}
}

	@lib/handle_unsuback.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

27 
	~"mosquôto.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"¥›îty_mosq.h
"

35 
	~"ªad_h™dÀ.h
"

36 
	~"£nd_mosq.h
"

37 
	~"utû_mosq.h
"

40 
	$h™dÀ__unsuback
(
mosquôto
 *
mosq
)

42 
uöt16_t
 
mid
;

43 
rc
;

44 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

45 
°©e
;

47 
	`as£π
(
mosq
);

49 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

50 if(
°©e
 !
mosq_cs_a˘ive
){

51  
MOSQ_ERR_PROTOCOL
;

54 #ifde‡
WITH_BROKER


55 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived UNSUBACK from %s", 
mosq
->
id
);

57 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†ª˚ived UNSUBACK", mosq->
id
);

59 
rc
 = 
	`∑ckë__ªad_uöt16
(&
mosq
->
ö_∑ckë
, &
mid
);

60 if(
rc
) Ñc;

61 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

63 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

64 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_UNSUBACK
, &
mosq
->
ö_∑ckë
, &
¥›îtõs
);

65 if(
rc
) Ñc;

68 #ifde‡
WITH_BROKER


70 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

72 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

73 if(
mosq
->
⁄_unsubs¸ibe
){

74 
mosq
->
ö_ˇŒback
 = 
åue
;

75 
mosq
->
	`⁄_unsubs¸ibe
(mosq, mosq->
u£rd©a
, 
mid
);

76 
mosq
->
ö_ˇŒback
 = 
Ál£
;

78 if(
mosq
->
⁄_unsubs¸ibe_v5
){

79 
mosq
->
ö_ˇŒback
 = 
åue
;

80 
mosq
->
	`⁄_unsubs¸ibe_v5
(mosq, mosq->
u£rd©a
, 
mid
, 
¥›îtõs
);

81 
mosq
->
ö_ˇŒback
 = 
Ál£
;

83 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

84 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

87  
MOSQ_ERR_SUCCESS
;

88 
	}
}

	@lib/helpers.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<°dboﬁ.h
>

22 
	~"mosquôto.h
"

23 
	~"mosquôto_öã∫Æ.h
"

25 
	su£rd©a__ˇŒback
 {

26 c⁄° *
	mt›ic
;

27 (*
	mˇŒback
)(
	mmosquôto
 *, *, c⁄° 
	mmosquôto_mesßge
 *);

28 *
	mu£rd©a
;

29 
	mqos
;

30 
	mrc
;

33 
	su£rd©a__sim∂e
 {

34 
mosquôto_mesßge
 *
	mmesßges
;

35 
	mmax_msg_cou¡
;

36 
	mmesßge_cou¡
;

37 
boﬁ
 
	mw™t_ªèöed
;

41 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

43 
u£rd©a__ˇŒback
 *
u£rd©a
 = 
obj
;

45 
	`UNUSED
(
rc
);

47 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, 
u£rd©a
->
t›ic
, u£rd©a->
qos
);

48 
	}
}

51 
	$⁄_mesßge_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

53 
rc
;

54 
u£rd©a__ˇŒback
 *
u£rd©a
 = 
obj
;

56 
rc
 = 
u£rd©a
->
	`ˇŒback
(
mosq
, u£rd©a->u£rd©a, 
mesßge
);

57 if(
rc
){

58 
	`mosquôto_disc⁄√˘
(
mosq
);

60 
	}
}

62 
	$⁄_mesßge_sim∂e
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
mesßge
)

64 
u£rd©a__sim∂e
 *
u£rd©a
 = 
obj
;

65 
rc
;

67 if(
u£rd©a
->
max_msg_cou¡
 == 0){

72 if(!
u£rd©a
->
w™t_ªèöed
 && 
mesßge
->
ªèö
){

76 
u£rd©a
->
max_msg_cou¡
--;

78 
rc
 = 
	`mosquôto_mesßge_c›y
(&
u£rd©a
->
mesßges
[u£rd©a->
mesßge_cou¡
], 
mesßge
);

79 if(
rc
){

80  
rc
;

82 
u£rd©a
->
mesßge_cou¡
++;

83 if(
u£rd©a
->
max_msg_cou¡
 == 0){

84 
	`mosquôto_disc⁄√˘
(
mosq
);

87 
	}
}

90 
libmosq_EXPORT
 
	$mosquôto_subs¸ibe_sim∂e
(

91 
mosquôto_mesßge
 **
mesßges
,

92 
msg_cou¡
,

93 
boﬁ
 
w™t_ªèöed
,

94 c⁄° *
t›ic
,

95 
qos
,

96 c⁄° *
ho°
,

97 
p‹t
,

98 c⁄° *
˛õ¡_id
,

99 
kì∑live
,

100 
boﬁ
 
˛ón_£ssi⁄
,

101 c⁄° *
u£∫ame
,

102 c⁄° *
∑ssw‹d
,

103 c⁄° 
libmosquôto_wûl
 *
wûl
,

104 c⁄° 
libmosquôto_és
 *
és
)

106 
u£rd©a__sim∂e
 
u£rd©a
;

107 
rc
;

108 
i
;

110 if(!
t›ic
 || 
msg_cou¡
 < 1 || !
mesßges
){

111  
MOSQ_ERR_INVAL
;

114 *
mesßges
 = 
NULL
;

116 
u£rd©a
.
mesßges
 = 
	`ˇŒoc
((
mosquôto_mesßge
), 
msg_cou¡
);

117 if(!
u£rd©a
.
mesßges
){

118  
MOSQ_ERR_NOMEM
;

120 
u£rd©a
.
mesßge_cou¡
 = 0;

121 
u£rd©a
.
max_msg_cou¡
 = 
msg_cou¡
;

122 
u£rd©a
.
w™t_ªèöed
 = want_retained;

124 
rc
 = 
	`mosquôto_subs¸ibe_ˇŒback
(

125 
⁄_mesßge_sim∂e
, &
u£rd©a
,

126 
t›ic
, 
qos
,

127 
ho°
, 
p‹t
,

128 
˛õ¡_id
, 
kì∑live
, 
˛ón_£ssi⁄
,

129 
u£∫ame
, 
∑ssw‹d
,

130 
wûl
, 
és
);

132 if(!
rc
 && 
u£rd©a
.
max_msg_cou¡
 == 0){

133 *
mesßges
 = 
u£rd©a
.messages;

134  
MOSQ_ERR_SUCCESS
;

136 
i
=0; i<
msg_cou¡
; i++){

137 
	`mosquôto_mesßge_‰ì_c⁄ã¡s
(&
u£rd©a
.
mesßges
[
i
]);

139 
	`‰ì
(
u£rd©a
.
mesßges
);

140 
u£rd©a
.
mesßges
 = 
NULL
;

141  
rc
;

143 
	}
}

146 
libmosq_EXPORT
 
	$mosquôto_subs¸ibe_ˇŒback
(

147 (*
ˇŒback
)(
mosquôto
 *, *, c⁄° 
mosquôto_mesßge
 *),

148 *
u£rd©a
,

149 c⁄° *
t›ic
,

150 
qos
,

151 c⁄° *
ho°
,

152 
p‹t
,

153 c⁄° *
˛õ¡_id
,

154 
kì∑live
,

155 
boﬁ
 
˛ón_£ssi⁄
,

156 c⁄° *
u£∫ame
,

157 c⁄° *
∑ssw‹d
,

158 c⁄° 
libmosquôto_wûl
 *
wûl
,

159 c⁄° 
libmosquôto_és
 *
és
)

161 
mosquôto
 *
mosq
;

162 
u£rd©a__ˇŒback
 
cb_u£rd©a
;

163 
rc
;

165 if(!
ˇŒback
 || !
t›ic
){

166  
MOSQ_ERR_INVAL
;

169 
cb_u£rd©a
.
t›ic
 =Åopic;

170 
cb_u£rd©a
.
qos
 = qos;

171 
cb_u£rd©a
.
rc
 = 0;

172 
cb_u£rd©a
.
u£rd©a
 = userdata;

173 
cb_u£rd©a
.
ˇŒback
 = callback;

175 
mosq
 = 
	`mosquôto_√w
(
˛õ¡_id
, 
˛ón_£ssi⁄
, &
cb_u£rd©a
);

176 if(!
mosq
){

177  
MOSQ_ERR_NOMEM
;

180 if(
wûl
){

181 
rc
 = 
	`mosquôto_wûl_£t
(
mosq
, 
wûl
->
t›ic
, wûl->
∑ylﬂdÀn
, wûl->
∑ylﬂd
, wûl->
qos
, wûl->
ªèö
);

182 if(
rc
){

183 
	`mosquôto_de°roy
(
mosq
);

184  
rc
;

187 if(
u£∫ame
){

188 
rc
 = 
	`mosquôto_u£∫ame_pw_£t
(
mosq
, 
u£∫ame
, 
∑ssw‹d
);

189 if(
rc
){

190 
	`mosquôto_de°roy
(
mosq
);

191  
rc
;

194 if(
és
){

195 
rc
 = 
	`mosquôto_és_£t
(
mosq
, 
és
->
ˇfûe
,Åls->
ˇ∑th
,Åls->
˚πfûe
,Åls->
keyfûe
,Åls->
pw_ˇŒback
);

196 if(
rc
){

197 
	`mosquôto_de°roy
(
mosq
);

198  
rc
;

200 
rc
 = 
	`mosquôto_és_›ts_£t
(
mosq
, 
és
->
˚π_ªqs
,Åls->
és_vîsi⁄
,Åls->
cùhîs
);

201 if(
rc
){

202 
	`mosquôto_de°roy
(
mosq
);

203  
rc
;

207 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

208 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge_ˇŒback
);

210 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, 
ho°
, 
p‹t
, 
kì∑live
);

211 if(
rc
){

212 
	`mosquôto_de°roy
(
mosq
);

213  
rc
;

215 
rc
 = 
	`mosquôto_lo›_f‹evî
(
mosq
, -1, 1);

216 
	`mosquôto_de°roy
(
mosq
);

217 if(
cb_u£rd©a
.
rc
){

218 
rc
 = 
cb_u£rd©a
.rc;

225  
MOSQ_ERR_SUCCESS
;

226 
	}
}

	@lib/logging_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°d¨g.h
>

21 
	~<°dio.h
>

22 
	~<°rög.h
>

24 
	~"mosquôto_öã∫Æ.h
"

25 
	~"mosquôto.h
"

26 
	~"mem‹y_mosq.h
"

28 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

30 
va_li°
 
va
;

31 *
s
;

32 
Àn
;

34 
	`as£π
(
mosq
);

35 
	`as£π
(
fmt
);

37 
	`±hªad_muãx_lock
(&
mosq
->
log_ˇŒback_muãx
);

38 if(
mosq
->
⁄_log
){

39 
Àn
 = 
	`°æí
(
fmt
) + 500;

40 
s
 = 
	`mosquôto__mÆloc
(
Àn
*());

41 if(!
s
){

42 
	`±hªad_muãx_u∆ock
(&
mosq
->
log_ˇŒback_muãx
);

43  
MOSQ_ERR_NOMEM
;

46 
	`va_°¨t
(
va
, 
fmt
);

47 
	`v¢¥ötf
(
s
, 
Àn
, 
fmt
, 
va
);

48 
	`va_íd
(
va
);

49 
s
[
Àn
-1] = '\0';

51 
mosq
->
	`⁄_log
(mosq, mosq->
u£rd©a
, 
¥i‹ôy
, 
s
);

53 
	`mosquôto__‰ì
(
s
);

55 
	`±hªad_muãx_u∆ock
(&
mosq
->
log_ˇŒback_muãx
);

57  
MOSQ_ERR_SUCCESS
;

58 
	}
}

	@lib/logging_mosq.h

16 #i‚de‡
LOGGING_MOSQ_H


17 
	#LOGGING_MOSQ_H


	)

19 
	~"mosquôto.h
"

21 
log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...);

	@lib/loop.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 #i‚de‡
WIN32


21 
	~<sys/£À˘.h
>

22 
	~<time.h
>

25 
	~"mosquôto.h
"

26 
	~"mosquôto_öã∫Æ.h
"

27 
	~"√t_mosq.h
"

28 
	~"∑ckë_mosq.h
"

29 
	~"socks_mosq.h
"

30 
	~"és_mosq.h
"

31 
	~"utû_mosq.h
"

33 #i‡!
deföed
(
WIN32
Ë&& !deföed(
__SYMBIAN32__
)

34 
	#HAVE_PSELECT


	)

37 
	$mosquôto_lo›
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
)

39 #ifde‡
HAVE_PSELECT


40 
time•ec
 
loˇl_timeout
;

42 
timevÆ
 
loˇl_timeout
;

44 
fd_£t
 
ªadfds
, 
wrôefds
;

45 
fdcou¡
;

46 
rc
;

47 
∑úbuf
;

48 
maxfd
 = 0;

49 
time_t
 
now
;

50 #ifde‡
WITH_SRV


51 
°©e
;

54 if(!
mosq
 || 
max_∑ckës
 < 1Ë 
MOSQ_ERR_INVAL
;

55 #i‚de‡
WIN32


56 if(
mosq
->
sock
 >
FD_SETSIZE
 || mosq->
sock∑úR
 >= FD_SETSIZE){

57  
MOSQ_ERR_INVAL
;

61 
	`FD_ZERO
(&
ªadfds
);

62 
	`FD_ZERO
(&
wrôefds
);

63 if(
mosq
->
sock
 !
INVALID_SOCKET
){

64 
maxfd
 = 
mosq
->
sock
;

65 
	`FD_SET
(
mosq
->
sock
, &
ªadfds
);

66 
	`±hªad_muãx_lock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

67 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

68 if(
mosq
->
out_∑ckë
 || mosq->
cuºít_out_∑ckë
){

69 
	`FD_SET
(
mosq
->
sock
, &
wrôefds
);

71 #ifde‡
WITH_TLS


72 if(
mosq
->
s¶
){

73 if(
mosq
->
w™t_wrôe
){

74 
	`FD_SET
(
mosq
->
sock
, &
wrôefds
);

75 }if(
mosq
->
w™t_c⁄√˘
){

80 
	`FD_CLR
(
mosq
->
sock
, &
wrôefds
);

84 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

85 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

87 #ifde‡
WITH_SRV


88 if(
mosq
->
ach™
){

89 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

90 if(
°©e
 =
mosq_cs_c⁄√˘_§v
){

91 
rc
 = 
	`¨es_fds
(
mosq
->
ach™
, &
ªadfds
, &
wrôefds
);

92 if(
rc
 > 
maxfd
){

93 
maxfd
 = 
rc
;

96  
MOSQ_ERR_NO_CONN
;

100  
MOSQ_ERR_NO_CONN
;

103 if(
mosq
->
sock∑úR
 !
INVALID_SOCKET
){

106 
	`FD_SET
(
mosq
->
sock∑úR
, &
ªadfds
);

107 if(
mosq
->
sock∑úR
 > 
maxfd
){

108 
maxfd
 = 
mosq
->
sock∑úR
;

112 if(
timeout
 < 0){

113 
timeout
 = 1000;

116 
now
 = 
	`mosquôto_time
();

117 if(
mosq
->
√xt_msg_out
 && 
now
 + 
timeout
/1000 > mosq->next_msg_out){

118 
timeout
 = (
mosq
->
√xt_msg_out
 - 
now
)*1000;

121 if(
timeout
 < 0){

124 
timeout
 = 0;

127 
loˇl_timeout
.
tv_£c
 = 
timeout
/1000;

128 #ifde‡
HAVE_PSELECT


129 
loˇl_timeout
.
tv_n£c
 = (
timeout
-loˇl_timeout.
tv_£c
*1000)*1e6;

131 
loˇl_timeout
.
tv_u£c
 = (
timeout
-loˇl_timeout.
tv_£c
*1000)*1000;

134 #ifde‡
HAVE_PSELECT


135 
fdcou¡
 = 
	`p£À˘
(
maxfd
+1, &
ªadfds
, &
wrôefds
, 
NULL
, &
loˇl_timeout
, NULL);

137 
fdcou¡
 = 
	`£À˘
(
maxfd
+1, &
ªadfds
, &
wrôefds
, 
NULL
, &
loˇl_timeout
);

139 if(
fdcou¡
 == -1){

140 #ifde‡
WIN32


141 
î∫o
 = 
	`WSAGëLa°Eº‹
();

143 if(
î∫o
 =
EINTR
){

144  
MOSQ_ERR_SUCCESS
;

146  
MOSQ_ERR_ERRNO
;

149 if(
mosq
->
sock
 !
INVALID_SOCKET
){

150 if(
	`FD_ISSET
(
mosq
->
sock
, &
ªadfds
)){

151 
rc
 = 
	`mosquôto_lo›_ªad
(
mosq
, 
max_∑ckës
);

152 if(
rc
 || 
mosq
->
sock
 =
INVALID_SOCKET
){

153  
rc
;

156 if(
mosq
->
sock∑úR
 !
INVALID_SOCKET
 && 
	`FD_ISSET
(mosq->sock∑úR, &
ªadfds
)){

157 #i‚de‡
WIN32


158 if(
	`ªad
(
mosq
->
sock∑úR
, &
∑úbuf
, 1) == 0){

161 
	`ªcv
(
mosq
->
sock∑úR
, &
∑úbuf
, 1, 0);

166 if(
mosq
->
sock
 !
INVALID_SOCKET
)

167 
	`FD_SET
(
mosq
->
sock
, &
wrôefds
);

169 if(
mosq
->
sock
 !
INVALID_SOCKET
 && 
	`FD_ISSET
(mosq->sock, &
wrôefds
)){

170 #ifde‡
WITH_TLS


171 if(
mosq
->
w™t_c⁄√˘
){

172 
rc
 = 
	`√t__sockë_c⁄√˘_és
(
mosq
);

173 if(
rc
) Ñc;

177 
rc
 = 
	`mosquôto_lo›_wrôe
(
mosq
, 
max_∑ckës
);

178 if(
rc
 || 
mosq
->
sock
 =
INVALID_SOCKET
){

179  
rc
;

184 #ifde‡
WITH_SRV


185 if(
mosq
->
ach™
){

186 
	`¨es_¥o˚ss
(
mosq
->
ach™
, &
ªadfds
, &
wrôefds
);

190  
	`mosquôto_lo›_misc
(
mosq
);

191 
	}
}

194 
	$mosquôto_lo›_f‹evî
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
)

196 
run
 = 1;

197 
rc
;

198 
ªc⁄√˘_dñay
;

199 #i‚de‡
WIN32


200 
time•ec
 
ªq
, 
ªm
;

202 
°©e
;

204 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

206 
mosq
->
ªc⁄√˘s
 = 0;

208 
run
){

210 
rc
 = 
	`mosquôto_lo›
(
mosq
, 
timeout
, 
max_∑ckës
);

211 }
run
 && 
rc
 =
MOSQ_ERR_SUCCESS
);

213 
rc
){

214 
MOSQ_ERR_NOMEM
:

215 
MOSQ_ERR_PROTOCOL
:

216 
MOSQ_ERR_INVAL
:

217 
MOSQ_ERR_NOT_FOUND
:

218 
MOSQ_ERR_TLS
:

219 
MOSQ_ERR_PAYLOAD_SIZE
:

220 
MOSQ_ERR_NOT_SUPPORTED
:

221 
MOSQ_ERR_AUTH
:

222 
MOSQ_ERR_ACL_DENIED
:

223 
MOSQ_ERR_UNKNOWN
:

224 
MOSQ_ERR_EAI
:

225 
MOSQ_ERR_PROXY
:

226  
rc
;

227 
MOSQ_ERR_ERRNO
:

230 if(
î∫o
 =
EPROTO
){

231  
rc
;

234 
rc
 = 
MOSQ_ERR_SUCCESS
;

235 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

236 if(
°©e
 =
mosq_cs_disc⁄√˘ög
 || sèã =
mosq_cs_disc⁄√˘ed
){

237 
run
 = 0;

239 if(
mosq
->
ªc⁄√˘_dñay_max
 > mosq->
ªc⁄√˘_dñay
){

240 if(
mosq
->
ªc⁄√˘_exp⁄ítül_backoff
){

241 
ªc⁄√˘_dñay
 = 
mosq
->ªc⁄√˘_dñay*(mosq->
ªc⁄√˘s
+1)*(mosq->reconnects+1);

243 
ªc⁄√˘_dñay
 = 
mosq
->ªc⁄√˘_dñay*(mosq->
ªc⁄√˘s
+1);

246 
ªc⁄√˘_dñay
 = 
mosq
->reconnect_delay;

249 if(
ªc⁄√˘_dñay
 > 
mosq
->
ªc⁄√˘_dñay_max
){

250 
ªc⁄√˘_dñay
 = 
mosq
->
ªc⁄√˘_dñay_max
;

252 
mosq
->
ªc⁄√˘s
++;

255 #ifde‡
WIN32


256 
	`SÀï
(
ªc⁄√˘_dñay
*1000);

258 
ªq
.
tv_£c
 = 
ªc⁄√˘_dñay
;

259 
ªq
.
tv_n£c
 = 0;

260 
	`«no¶ìp
(&
ªq
, &
ªm
Ë=-1 && 
î∫o
 =
EINTR
){

261 
ªq
 = 
ªm
;

265 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

266 if(
°©e
 =
mosq_cs_disc⁄√˘ög
 || sèã =
mosq_cs_disc⁄√˘ed
){

267 
run
 = 0;

269 
rc
 = 
	`mosquôto_ªc⁄√˘
(
mosq
);

272 }
run
 && 
rc
 !
MOSQ_ERR_SUCCESS
);

274  
rc
;

275 
	}
}

278 
	$mosquôto_lo›_misc
(
mosquôto
 *
mosq
)

280 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

281 if(
mosq
->
sock
 =
INVALID_SOCKET
Ë 
MOSQ_ERR_NO_CONN
;

283  
	`mosquôto__check_kì∑live
(
mosq
);

284 
	}
}

287 
	$mosquôto__lo›_rc_h™dÀ
(
mosquôto
 *
mosq
, 
rc
)

289 
°©e
;

291 if(
rc
){

292 
	`√t__sockë_˛o£
(
mosq
);

293 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

294 if(
°©e
 =
mosq_cs_disc⁄√˘ög
 || sèã =
mosq_cs_disc⁄√˘ed
){

295 
rc
 = 
MOSQ_ERR_SUCCESS
;

297 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

298 if(
mosq
->
⁄_disc⁄√˘
){

299 
mosq
->
ö_ˇŒback
 = 
åue
;

300 
mosq
->
	`⁄_disc⁄√˘
(mosq, mosq->
u£rd©a
, 
rc
);

301 
mosq
->
ö_ˇŒback
 = 
Ál£
;

303 if(
mosq
->
⁄_disc⁄√˘_v5
){

304 
mosq
->
ö_ˇŒback
 = 
åue
;

305 
mosq
->
	`⁄_disc⁄√˘_v5
(mosq, mosq->
u£rd©a
, 
rc
, 
NULL
);

306 
mosq
->
ö_ˇŒback
 = 
Ál£
;

308 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

310  
rc
;

311 
	}
}

314 
	$mosquôto_lo›_ªad
(
mosquôto
 *
mosq
, 
max_∑ckës
)

316 
rc
;

317 
i
;

318 if(
max_∑ckës
 < 1Ë 
MOSQ_ERR_INVAL
;

320 #ifde‡
WITH_TLS


321 if(
mosq
->
w™t_c⁄√˘
){

322  
	`√t__sockë_c⁄√˘_és
(
mosq
);

326 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

327 
max_∑ckës
 = 
mosq
->
msgs_out
.
queue_Àn
;

328 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

330 
	`±hªad_muãx_lock
(&
mosq
->
msgs_ö
.
muãx
);

331 
max_∑ckës
 +
mosq
->
msgs_ö
.
queue_Àn
;

332 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

334 if(
max_∑ckës
 < 1) max_packets = 1;

338 
i
=0; i<
max_∑ckës
 || 
	`SSL_DATA_PENDING
(
mosq
); i++){

339 #ifde‡
WITH_SOCKS


340 if(
mosq
->
socks5_ho°
){

341 
rc
 = 
	`socks5__ªad
(
mosq
);

345 
rc
 = 
	`∑ckë__ªad
(
mosq
);

347 if(
rc
 || 
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

348  
	`mosquôto__lo›_rc_h™dÀ
(
mosq
, 
rc
);

351  
rc
;

352 
	}
}

355 
	$mosquôto_lo›_wrôe
(
mosquôto
 *
mosq
, 
max_∑ckës
)

357 
rc
;

358 
i
;

359 if(
max_∑ckës
 < 1Ë 
MOSQ_ERR_INVAL
;

361 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

362 
max_∑ckës
 = 
mosq
->
msgs_out
.
queue_Àn
;

363 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

365 
	`±hªad_muãx_lock
(&
mosq
->
msgs_ö
.
muãx
);

366 
max_∑ckës
 +
mosq
->
msgs_ö
.
queue_Àn
;

367 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

369 if(
max_∑ckës
 < 1) max_packets = 1;

373 
i
=0; i<
max_∑ckës
; i++){

374 
rc
 = 
	`∑ckë__wrôe
(
mosq
);

375 if(
rc
 || 
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

376  
	`mosquôto__lo›_rc_h™dÀ
(
mosq
, 
rc
);

379  
rc
;

380 
	}
}

	@lib/memory_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<°dlib.h
>

20 
	~<°rög.h
>

22 
	~"mem‹y_mosq.h
"

24 #ifde‡
REAL_WITH_MEMORY_TRACKING


25 #i‡
deföed
(
__APPLE__
)

26 
	~<mÆloc/mÆloc.h
>

27 
	#mÆloc_ußbÀ_size
 
mÆloc_size


	)

28 #ñi‡
deföed
(
__FªeBSD__
)

29 
	~<mÆloc_≈.h
>

31 
	~<mÆloc.h
>

35 #ifde‡
REAL_WITH_MEMORY_TRACKING


36 
	gmemcou¡
 = 0;

37 
	gmax_memcou¡
 = 0;

40 #ifde‡
WITH_BROKER


41 
size_t
 
	gmem_limô
 = 0;

42 
	$mem‹y__£t_limô
(
size_t
 
lim
)

44 
mem_limô
 = 
lim
;

45 
	}
}

48 *
	$mosquôto__ˇŒoc
(
size_t
 
nmemb
, size_à
size
)

50 #ifde‡
REAL_WITH_MEMORY_TRACKING


51 if(
mem_limô
 && 
memcou¡
 + 
size
 > mem_limit){

52  
NULL
;

55 *
mem
 = 
	`ˇŒoc
(
nmemb
, 
size
);

57 #ifde‡
REAL_WITH_MEMORY_TRACKING


58 if(
mem
){

59 
memcou¡
 +
	`mÆloc_ußbÀ_size
(
mem
);

60 if(
memcou¡
 > 
max_memcou¡
){

61 
max_memcou¡
 = 
memcou¡
;

66  
mem
;

67 
	}
}

69 
	$mosquôto__‰ì
(*
mem
)

71 #ifde‡
REAL_WITH_MEMORY_TRACKING


72 if(!
mem
){

75 
memcou¡
 -
	`mÆloc_ußbÀ_size
(
mem
);

77 
	`‰ì
(
mem
);

78 
	}
}

80 *
	$mosquôto__mÆloc
(
size_t
 
size
)

82 #ifde‡
REAL_WITH_MEMORY_TRACKING


83 if(
mem_limô
 && 
memcou¡
 + 
size
 > mem_limit){

84  
NULL
;

87 *
mem
 = 
	`mÆloc
(
size
);

89 #ifde‡
REAL_WITH_MEMORY_TRACKING


90 if(
mem
){

91 
memcou¡
 +
	`mÆloc_ußbÀ_size
(
mem
);

92 if(
memcou¡
 > 
max_memcou¡
){

93 
max_memcou¡
 = 
memcou¡
;

98  
mem
;

99 
	}
}

101 #ifde‡
REAL_WITH_MEMORY_TRACKING


102 
	$mosquôto__mem‹y_u£d
()

104  
memcou¡
;

105 
	}
}

107 
	$mosquôto__max_mem‹y_u£d
()

109  
max_memcou¡
;

110 
	}
}

113 *
	$mosquôto__ªÆloc
(*
±r
, 
size_t
 
size
)

115 #ifde‡
REAL_WITH_MEMORY_TRACKING


116 if(
mem_limô
 && 
memcou¡
 + 
size
 > mem_limit){

117  
NULL
;

120 *
mem
;

121 #ifde‡
REAL_WITH_MEMORY_TRACKING


122 if(
±r
){

123 
memcou¡
 -
	`mÆloc_ußbÀ_size
(
±r
);

126 
mem
 = 
	`ªÆloc
(
±r
, 
size
);

128 #ifde‡
REAL_WITH_MEMORY_TRACKING


129 if(
mem
){

130 
memcou¡
 +
	`mÆloc_ußbÀ_size
(
mem
);

131 if(
memcou¡
 > 
max_memcou¡
){

132 
max_memcou¡
 = 
memcou¡
;

137  
mem
;

138 
	}
}

140 *
	$mosquôto__°rdup
(c⁄° *
s
)

142 #ifde‡
REAL_WITH_MEMORY_TRACKING


143 if(
mem_limô
 && 
memcou¡
 + 
	`°æí
(
s
) > mem_limit){

144  
NULL
;

147 *
°r
 = 
	`°rdup
(
s
);

149 #ifde‡
REAL_WITH_MEMORY_TRACKING


150 if(
°r
){

151 
memcou¡
 +
	`mÆloc_ußbÀ_size
(
°r
);

152 if(
memcou¡
 > 
max_memcou¡
){

153 
max_memcou¡
 = 
memcou¡
;

158  
°r
;

159 
	}
}

	@lib/memory_mosq.h

17 #i‚de‡
MEMORY_MOSQ_H


18 
	#MEMORY_MOSQ_H


	)

20 
	~<°dio.h
>

21 
	~<sys/ty≥s.h
>

23 #i‡
deföed
(
WITH_MEMORY_TRACKING
Ë&& deföed(
WITH_BROKER
Ë&& deföed(
__GLIBC__
)

24 
	#REAL_WITH_MEMORY_TRACKING


	)

27 *
mosquôto__ˇŒoc
(
size_t
 
nmemb
, size_à
size
);

28 
mosquôto__‰ì
(*
mem
);

29 *
mosquôto__mÆloc
(
size_t
 
size
);

30 #ifde‡
REAL_WITH_MEMORY_TRACKING


31 
mosquôto__mem‹y_u£d
();

32 
mosquôto__max_mem‹y_u£d
();

34 *
mosquôto__ªÆloc
(*
±r
, 
size_t
 
size
);

35 *
mosquôto__°rdup
(c⁄° *
s
);

37 #ifde‡
WITH_BROKER


38 
mem‹y__£t_limô
(
size_t
 
lim
);

	@lib/messages_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dlib.h
>

21 
	~<°rög.h
>

22 
	~<uéi°.h
>

24 
	~"mosquôto_öã∫Æ.h
"

25 
	~"mosquôto.h
"

26 
	~"mem‹y_mosq.h
"

27 
	~"mesßges_mosq.h
"

28 
	~"£nd_mosq.h
"

29 
	~"time_mosq.h
"

30 
	~"utû_mosq.h
"

32 
	$mesßge__˛ónup
(
mosquôto_mesßge_Æl
 **
mesßge
)

34 
mosquôto_mesßge_Æl
 *
msg
;

36 if(!
mesßge
 || !*message) ;

38 
msg
 = *
mesßge
;

40 
	`mosquôto__‰ì
(
msg
->msg.
t›ic
);

41 
	`mosquôto__‰ì
(
msg
->msg.
∑ylﬂd
);

42 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg
->
¥›îtõs
);

43 
	`mosquôto__‰ì
(
msg
);

44 
	}
}

46 
	$mesßge__˛ónup_Æl
(
mosquôto
 *
mosq
)

48 
mosquôto_mesßge_Æl
 *
èû
, *
tmp
;

50 
	`as£π
(
mosq
);

52 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_ö
.
öÊight
, 
èû
, 
tmp
){

53 
	`DL_DELETE
(
mosq
->
msgs_ö
.
öÊight
, 
èû
);

54 
	`mesßge__˛ónup
(&
èû
);

56 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_out
.
öÊight
, 
èû
, 
tmp
){

57 
	`DL_DELETE
(
mosq
->
msgs_out
.
öÊight
, 
èû
);

58 
	`mesßge__˛ónup
(&
èû
);

60 
	}
}

62 
	$mosquôto_mesßge_c›y
(
mosquôto_mesßge
 *
d°
, c⁄° mosquôto_mesßgê*
§c
)

64 if(!
d°
 || !
§c
Ë 
MOSQ_ERR_INVAL
;

66 
d°
->
mid
 = 
§c
->mid;

67 
d°
->
t›ic
 = 
	`mosquôto__°rdup
(
§c
->topic);

68 if(!
d°
->
t›ic
Ë 
MOSQ_ERR_NOMEM
;

69 
d°
->
qos
 = 
§c
->qos;

70 
d°
->
ªèö
 = 
§c
->retain;

71 if(
§c
->
∑ylﬂdÀn
){

72 
d°
->
∑ylﬂd
 = 
	`mosquôto__ˇŒoc
(
§c
->
∑ylﬂdÀn
+1, (
uöt8_t
));

73 if(!
d°
->
∑ylﬂd
){

74 
	`mosquôto__‰ì
(
d°
->
t›ic
);

75  
MOSQ_ERR_NOMEM
;

77 
	`mem˝y
(
d°
->
∑ylﬂd
, 
§c
->∑ylﬂd, src->
∑ylﬂdÀn
);

78 
d°
->
∑ylﬂdÀn
 = 
§c
->payloadlen;

80 
d°
->
∑ylﬂdÀn
 = 0;

81 
d°
->
∑ylﬂd
 = 
NULL
;

83  
MOSQ_ERR_SUCCESS
;

84 
	}
}

86 
	$mesßge__dñëe
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
)

88 
mosquôto_mesßge_Æl
 *
mesßge
;

89 
rc
;

90 
	`as£π
(
mosq
);

92 
rc
 = 
	`mesßge__ªmove
(
mosq
, 
mid
, 
dú
, &
mesßge
, 
qos
);

93 if(
rc
 =
MOSQ_ERR_SUCCESS
){

94 
	`mesßge__˛ónup
(&
mesßge
);

96  
rc
;

97 
	}
}

99 
	$mosquôto_mesßge_‰ì
(
mosquôto_mesßge
 **
mesßge
)

101 
mosquôto_mesßge
 *
msg
;

103 if(!
mesßge
 || !*message) ;

105 
msg
 = *
mesßge
;

107 
	`mosquôto__‰ì
(
msg
->
t›ic
);

108 
	`mosquôto__‰ì
(
msg
->
∑ylﬂd
);

109 
	`mosquôto__‰ì
(
msg
);

110 
	}
}

112 
	$mosquôto_mesßge_‰ì_c⁄ã¡s
(
mosquôto_mesßge
 *
mesßge
)

114 if(!
mesßge
) ;

116 
	`mosquôto__‰ì
(
mesßge
->
t›ic
);

117 
	`mosquôto__‰ì
(
mesßge
->
∑ylﬂd
);

118 
	}
}

120 
	$mesßge__queue
(
mosquôto
 *
mosq
, 
mosquôto_mesßge_Æl
 *
mesßge
, 
mosquôto_msg_dúe˘i⁄
 
dú
)

123 
	`as£π
(
mosq
);

124 
	`as£π
(
mesßge
);

125 
	`as£π
(
mesßge
->
msg
.
qos
 != 0);

127 if(
dú
 =
mosq_md_out
){

128 
	`DL_APPEND
(
mosq
->
msgs_out
.
öÊight
, 
mesßge
);

129 
mosq
->
msgs_out
.
queue_Àn
++;

131 
	`DL_APPEND
(
mosq
->
msgs_ö
.
öÊight
, 
mesßge
);

132 
mosq
->
msgs_ö
.
queue_Àn
++;

135  
	`mesßge__ªÀa£_to_öÊight
(
mosq
, 
dú
);

136 
	}
}

138 
	$mesßge__ªc⁄√˘_ª£t
(
mosquôto
 *
mosq
)

140 
mosquôto_mesßge_Æl
 *
mesßge
, *
tmp
;

141 
	`as£π
(
mosq
);

143 
	`±hªad_muãx_lock
(&
mosq
->
msgs_ö
.
muãx
);

144 
mosq
->
msgs_ö
.
öÊight_quŸa
 = mosq->msgs_ö.
öÊight_maximum
;

145 
mosq
->
msgs_ö
.
queue_Àn
 = 0;

146 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_ö
.
öÊight
, 
mesßge
, 
tmp
){

147 
mosq
->
msgs_ö
.
queue_Àn
++;

148 
mesßge
->
time°amp
 = 0;

149 if(
mesßge
->
msg
.
qos
 != 2){

150 
	`DL_DELETE
(
mosq
->
msgs_ö
.
öÊight
, 
mesßge
);

151 
	`mesßge__˛ónup
(&
mesßge
);

155 
	`utû__de¸emít_ª˚ive_quŸa
(
mosq
);

158 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

161 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

162 
mosq
->
msgs_out
.
öÊight_quŸa
 = mosq->msgs_out.
öÊight_maximum
;

163 
mosq
->
msgs_out
.
queue_Àn
 = 0;

164 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_out
.
öÊight
, 
mesßge
, 
tmp
){

165 
mosq
->
msgs_out
.
queue_Àn
++;

167 
mesßge
->
time°amp
 = 0;

168 if(
mosq
->
msgs_out
.
öÊight_quŸa
 != 0){

169 
	`utû__de¸emít_£nd_quŸa
(
mosq
);

170 if(
mesßge
->
msg
.
qos
 == 1){

171 
mesßge
->
°©e
 = 
mosq_ms_publish_qos1
;

172 }if(
mesßge
->
msg
.
qos
 == 2){

173 if(
mesßge
->
°©e
 =
mosq_ms_waô_f‹_pubªc
){

174 
mesßge
->
°©e
 = 
mosq_ms_publish_qos2
;

175 }if(
mesßge
->
°©e
 =
mosq_ms_waô_f‹_pubcomp
){

176 
mesßge
->
°©e
 = 
mosq_ms_ª£nd_pubªl
;

181 
mesßge
->
°©e
 = 
mosq_ms_övÆid
;

184 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

185 
	}
}

188 
	$mesßge__ªÀa£_to_öÊight
(
mosquôto
 *
mosq
, 
mosquôto_msg_dúe˘i⁄
 
dú
)

191 
mosquôto_mesßge_Æl
 *
cur
, *
tmp
;

192 
rc
 = 
MOSQ_ERR_SUCCESS
;

194 if(
dú
 =
mosq_md_out
){

195 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_out
.
öÊight
, 
cur
, 
tmp
){

196 if(
mosq
->
msgs_out
.
öÊight_quŸa
 > 0){

197 if(
cur
->
msg
.
qos
 > 0 && cur->
°©e
 =
mosq_ms_övÆid
){

198 if(
cur
->
msg
.
qos
 == 1){

199 
cur
->
°©e
 = 
mosq_ms_waô_f‹_puback
;

200 }if(
cur
->
msg
.
qos
 == 2){

201 
cur
->
°©e
 = 
mosq_ms_waô_f‹_pubªc
;

203 
rc
 = 
	`£nd__publish
(
mosq
, 
cur
->
msg
.
mid
, cur->msg.
t›ic
, cur->msg.
∑ylﬂdÀn
, cur->msg.
∑ylﬂd
, cur->msg.
qos
, cur->msg.
ªèö
, cur->
dup
, cur->
¥›îtõs
, 
NULL
, 0);

204 if(
rc
){

205  
rc
;

207 
	`utû__de¸emít_£nd_quŸa
(
mosq
);

210  
MOSQ_ERR_SUCCESS
;

215  
rc
;

216 
	}
}

219 
	$mesßge__ªmove
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
mosquôto_mesßge_Æl
 **
mesßge
, 
qos
)

221 
mosquôto_mesßge_Æl
 *
cur
, *
tmp
;

222 
boﬁ
 
found
 = 
Ál£
;

223 
	`as£π
(
mosq
);

224 
	`as£π
(
mesßge
);

226 if(
dú
 =
mosq_md_out
){

227 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

229 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_out
.
öÊight
, 
cur
, 
tmp
){

230 if(
found
 =
Ál£
 && 
cur
->
msg
.
mid
 == mid){

231 if(
cur
->
msg
.
qos
 != qos){

232 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

233  
MOSQ_ERR_PROTOCOL
;

235 
	`DL_DELETE
(
mosq
->
msgs_out
.
öÊight
, 
cur
);

237 *
mesßge
 = 
cur
;

238 
mosq
->
msgs_out
.
queue_Àn
--;

239 
found
 = 
åue
;

243 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

244 if(
found
){

245  
MOSQ_ERR_SUCCESS
;

247  
MOSQ_ERR_NOT_FOUND
;

250 
	`±hªad_muãx_lock
(&
mosq
->
msgs_ö
.
muãx
);

251 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_ö
.
öÊight
, 
cur
, 
tmp
){

252 if(
cur
->
msg
.
mid
 == mid){

253 if(
cur
->
msg
.
qos
 != qos){

254 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

255  
MOSQ_ERR_PROTOCOL
;

257 
	`DL_DELETE
(
mosq
->
msgs_ö
.
öÊight
, 
cur
);

258 *
mesßge
 = 
cur
;

259 
mosq
->
msgs_ö
.
queue_Àn
--;

260 
found
 = 
åue
;

265 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_ö
.
muãx
);

266 if(
found
){

267  
MOSQ_ERR_SUCCESS
;

269  
MOSQ_ERR_NOT_FOUND
;

272 
	}
}

274 
	$mesßge__ªåy_check
(
mosquôto
 *
mosq
)

276 
mosquôto_mesßge_Æl
 *
msg
;

277 
time_t
 
now
 = 
	`mosquôto_time
();

278 
	`as£π
(
mosq
);

280 #ifde‡
WITH_THREADING


281 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

284 
	`DL_FOREACH
(
mosq
->
msgs_out
.
öÊight
, 
msg
){

285 
msg
->
°©e
){

286 
mosq_ms_publish_qos1
:

287 
mosq_ms_publish_qos2
:

288 
msg
->
time°amp
 = 
now
;

289 
msg
->
dup
 = 
åue
;

290 
	`£nd__publish
(
mosq
, 
msg
->msg.
mid
, msg->msg.
t›ic
, msg->msg.
∑ylﬂdÀn
, msg->msg.
∑ylﬂd
, msg->msg.
qos
, msg->msg.
ªèö
, msg->
dup
, msg->
¥›îtõs
, 
NULL
, 0);

292 
mosq_ms_waô_f‹_pubªl
:

293 
msg
->
time°amp
 = 
now
;

294 
msg
->
dup
 = 
åue
;

295 
	`£nd__pubªc
(
mosq
, 
msg
->msg.
mid
, 0);

297 
mosq_ms_ª£nd_pubªl
:

298 
mosq_ms_waô_f‹_pubcomp
:

299 
msg
->
time°amp
 = 
now
;

300 
msg
->
dup
 = 
åue
;

301 
	`£nd__pubªl
(
mosq
, 
msg
->msg.
mid
);

307 #ifde‡
WITH_THREADING


308 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

310 
	}
}

313 
	$mosquôto_mesßge_ªåy_£t
(
mosquôto
 *
mosq
, 
mesßge_ªåy
)

315 
	`UNUSED
(
mosq
);

316 
	`UNUSED
(
mesßge_ªåy
);

317 
	}
}

319 
	$mesßge__out_upd©e
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
°©e
, 
qos
)

321 
mosquôto_mesßge_Æl
 *
mesßge
, *
tmp
;

322 
	`as£π
(
mosq
);

324 
	`±hªad_muãx_lock
(&
mosq
->
msgs_out
.
muãx
);

325 
	`DL_FOREACH_SAFE
(
mosq
->
msgs_out
.
öÊight
, 
mesßge
, 
tmp
){

326 if(
mesßge
->
msg
.
mid
 == mid){

327 if(
mesßge
->
msg
.
qos
 != qos){

328 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

329  
MOSQ_ERR_PROTOCOL
;

331 
mesßge
->
°©e
 = state;

332 
mesßge
->
time°amp
 = 
	`mosquôto_time
();

333 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

334  
MOSQ_ERR_SUCCESS
;

337 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgs_out
.
muãx
);

338  
MOSQ_ERR_NOT_FOUND
;

339 
	}
}

341 
	$mosquôto_max_öÊight_mesßges_£t
(
mosquôto
 *
mosq
, 
max_öÊight_mesßges
)

343  
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_SEND_MAXIMUM
, 
max_öÊight_mesßges
);

344 
	}
}

	@lib/messages_mosq.h

16 #i‚de‡
MESSAGES_MOSQ_H


17 
	#MESSAGES_MOSQ_H


	)

19 
	~"mosquôto_öã∫Æ.h
"

20 
	~"mosquôto.h
"

22 
mesßge__˛ónup_Æl
(
mosquôto
 *
mosq
);

23 
mesßge__˛ónup
(
mosquôto_mesßge_Æl
 **
mesßge
);

24 
mesßge__dñëe
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
);

25 
mesßge__queue
(
mosquôto
 *
mosq
, 
mosquôto_mesßge_Æl
 *
mesßge
, 
mosquôto_msg_dúe˘i⁄
 
dú
);

26 
mesßge__ªc⁄√˘_ª£t
(
mosquôto
 *
mosq
);

27 
mesßge__ªÀa£_to_öÊight
(
mosquôto
 *
mosq
, 
mosquôto_msg_dúe˘i⁄
 
dú
);

28 
mesßge__ªmove
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
mosquôto_mesßge_Æl
 **
mesßge
, 
qos
);

29 
mesßge__ªåy_check
(
mosquôto
 *
mosq
);

30 
mesßge__out_upd©e
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
°©e
, 
qos
);

	@lib/mosquitto.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<sig«l.h
>

21 
	~<°rög.h
>

22 #i‚de‡
WIN32


23 
	~<sys/time.h
>

24 
	~<°rögs.h
>

27 
	~"mosquôto.h
"

28 
	~"mosquôto_öã∫Æ.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mesßges_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"∑ckë_mosq.h
"

34 
	~"wûl_mosq.h
"

37 
mosquôto__de°roy
(
mosquôto
 *
mosq
);

39 
	$mosquôto_lib_vîsi⁄
(*
maj‹
, *
mö‹
, *
ªvisi⁄
)

41 if(
maj‹
Ë*maj‹ = 
LIBMOSQUITTO_MAJOR
;

42 if(
mö‹
Ë*mö‹ = 
LIBMOSQUITTO_MINOR
;

43 if(
ªvisi⁄
Ë*ªvisi⁄ = 
LIBMOSQUITTO_REVISION
;

44  
LIBMOSQUITTO_VERSION_NUMBER
;

45 
	}
}

47 
	$mosquôto_lib_öô
()

49 #ifde‡
WIN32


50 
	`§™d
(
	`GëTickCou¡64
());

51 #ñi‡
_POSIX_TIMERS
>0 && 
	`deföed
(
_POSIX_MONOTONIC_CLOCK
)

52 
time•ec
 
ç
;

54 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ç
);

55 
	`§™d
(
ç
.
tv_n£c
);

56 #ñi‡
	`deföed
(
__APPLE__
)

57 
uöt64_t
 
ticks
;

59 
ticks
 = 
	`mach_absﬁuã_time
();

60 
	`§™d
(()
ticks
);

62 
timevÆ
 
tv
;

64 
	`gëtimeofday
(&
tv
, 
NULL
);

65 
	`§™d
(
tv
.
tv_£c
*1000 +Åv.
tv_u£c
/1000);

68  
	`√t__öô
();

69 
	}
}

71 
	$mosquôto_lib_˛ónup
()

73 
	`√t__˛ónup
();

75  
MOSQ_ERR_SUCCESS
;

76 
	}
}

78 
mosquôto
 *
	$mosquôto_√w
(c⁄° *
id
, 
boﬁ
 
˛ón_°¨t
, *
u£rd©a
)

80 
mosquôto
 *
mosq
 = 
NULL
;

81 
rc
;

83 if(
˛ón_°¨t
 =
Ál£
 && 
id
 =
NULL
){

84 
î∫o
 = 
EINVAL
;

85  
NULL
;

88 #i‚de‡
WIN32


89 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

92 
mosq
 = (
mosquôto
 *)
	`mosquôto__ˇŒoc
(1, (mosquitto));

93 if(
mosq
){

94 
mosq
->
sock
 = 
INVALID_SOCKET
;

95 
mosq
->
sock∑úR
 = 
INVALID_SOCKET
;

96 
mosq
->
sock∑úW
 = 
INVALID_SOCKET
;

97 #ifde‡
WITH_THREADING


98 
mosq
->
thªad_id
 = 
	`±hªad_£lf
();

100 
rc
 = 
	`mosquôto_ªöôüli£
(
mosq
, 
id
, 
˛ón_°¨t
, 
u£rd©a
);

101 if(
rc
){

102 
	`mosquôto_de°roy
(
mosq
);

103 if(
rc
 =
MOSQ_ERR_INVAL
){

104 
î∫o
 = 
EINVAL
;

105 }if(
rc
 =
MOSQ_ERR_NOMEM
){

106 
î∫o
 = 
ENOMEM
;

108  
NULL
;

111 
î∫o
 = 
ENOMEM
;

113  
mosq
;

114 
	}
}

116 
	$mosquôto_ªöôüli£
(
mosquôto
 *
mosq
, c⁄° *
id
, 
boﬁ
 
˛ón_°¨t
, *
u£rd©a
)

118 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

120 if(
˛ón_°¨t
 =
Ál£
 && 
id
 =
NULL
){

121  
MOSQ_ERR_INVAL
;

124 
	`mosquôto__de°roy
(
mosq
);

125 
	`mem£t
(
mosq
, 0, (
mosquôto
));

127 if(
u£rd©a
){

128 
mosq
->
u£rd©a
 = userdata;

130 
mosq
->
u£rd©a
 = mosq;

132 
mosq
->
¥Ÿocﬁ
 = 
mosq_p_mqâ311
;

133 
mosq
->
sock
 = 
INVALID_SOCKET
;

134 
mosq
->
sock∑úR
 = 
INVALID_SOCKET
;

135 
mosq
->
sock∑úW
 = 
INVALID_SOCKET
;

136 
mosq
->
kì∑live
 = 60;

137 
mosq
->
˛ón_°¨t
 = clean_start;

138 if(
id
){

139 if(
	`STREMPTY
(
id
)){

140  
MOSQ_ERR_INVAL
;

142 if(
	`mosquôto_vÆid©e_utf8
(
id
, 
	`°æí
(id))){

143  
MOSQ_ERR_MALFORMED_UTF8
;

145 
mosq
->
id
 = 
	`mosquôto__°rdup
(id);

147 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

148 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

149 
mosq
->
out_∑ckë
 = 
NULL
;

150 
mosq
->
cuºít_out_∑ckë
 = 
NULL
;

151 
mosq
->
œ°_msg_ö
 = 
	`mosquôto_time
();

152 
mosq
->
√xt_msg_out
 = 
	`mosquôto_time
(Ë+ mosq->
kì∑live
;

153 
mosq
->
pög_t
 = 0;

154 
mosq
->
œ°_mid
 = 0;

155 
mosq
->
°©e
 = 
mosq_cs_√w
;

156 
mosq
->
maximum_qos
 = 2;

157 
mosq
->
msgs_ö
.
öÊight_maximum
 = 20;

158 
mosq
->
msgs_out
.
öÊight_maximum
 = 20;

159 
mosq
->
msgs_ö
.
öÊight_quŸa
 = 20;

160 
mosq
->
msgs_out
.
öÊight_quŸa
 = 20;

161 
mosq
->
wûl
 = 
NULL
;

162 
mosq
->
⁄_c⁄√˘
 = 
NULL
;

163 
mosq
->
⁄_publish
 = 
NULL
;

164 
mosq
->
⁄_mesßge
 = 
NULL
;

165 
mosq
->
⁄_subs¸ibe
 = 
NULL
;

166 
mosq
->
⁄_unsubs¸ibe
 = 
NULL
;

167 
mosq
->
ho°
 = 
NULL
;

168 
mosq
->
p‹t
 = 1883;

169 
mosq
->
ö_ˇŒback
 = 
Ál£
;

170 
mosq
->
ªc⁄√˘_dñay
 = 1;

171 
mosq
->
ªc⁄√˘_dñay_max
 = 1;

172 
mosq
->
ªc⁄√˘_exp⁄ítül_backoff
 = 
Ál£
;

173 
mosq
->
thªaded
 = 
mosq_ts_n⁄e
;

174 #ifde‡
WITH_TLS


175 
mosq
->
s¶
 = 
NULL
;

176 
mosq
->
s¶_˘x
 = 
NULL
;

177 
mosq
->
és_˚π_ªqs
 = 
SSL_VERIFY_PEER
;

178 
mosq
->
és_ö£cuª
 = 
Ál£
;

179 
mosq
->
w™t_wrôe
 = 
Ál£
;

180 
mosq
->
és_oc•_ªquúed
 = 
Ál£
;

182 #ifde‡
WITH_THREADING


183 
	`±hªad_muãx_öô
(&
mosq
->
ˇŒback_muãx
, 
NULL
);

184 
	`±hªad_muãx_öô
(&
mosq
->
log_ˇŒback_muãx
, 
NULL
);

185 
	`±hªad_muãx_öô
(&
mosq
->
°©e_muãx
, 
NULL
);

186 
	`±hªad_muãx_öô
(&
mosq
->
out_∑ckë_muãx
, 
NULL
);

187 
	`±hªad_muãx_öô
(&
mosq
->
cuºít_out_∑ckë_muãx
, 
NULL
);

188 
	`±hªad_muãx_öô
(&
mosq
->
msgtime_muãx
, 
NULL
);

189 
	`±hªad_muãx_öô
(&
mosq
->
msgs_ö
.
muãx
, 
NULL
);

190 
	`±hªad_muãx_öô
(&
mosq
->
msgs_out
.
muãx
, 
NULL
);

191 
	`±hªad_muãx_öô
(&
mosq
->
mid_muãx
, 
NULL
);

192 
mosq
->
thªad_id
 = 
	`±hªad_£lf
();

195  
MOSQ_ERR_SUCCESS
;

196 
	}
}

199 
	$mosquôto__de°roy
(
mosquôto
 *
mosq
)

201 
mosquôto__∑ckë
 *
∑ckë
;

202 if(!
mosq
) ;

204 #ifde‡
WITH_THREADING


205 #ifde‡
HAVE_PTHREAD_CANCEL


206 if(
mosq
->
thªaded
 =
mosq_ts_£lf
 && !
	`±hªad_equÆ
(mosq->
thªad_id
, 
	`±hªad_£lf
())){

207 
	`±hªad_ˇn˚l
(
mosq
->
thªad_id
);

208 
	`±hªad_joö
(
mosq
->
thªad_id
, 
NULL
);

209 
mosq
->
thªaded
 = 
mosq_ts_n⁄e
;

213 if(
mosq
->
id
){

217 
	`±hªad_muãx_de°roy
(&
mosq
->
ˇŒback_muãx
);

218 
	`±hªad_muãx_de°roy
(&
mosq
->
log_ˇŒback_muãx
);

219 
	`±hªad_muãx_de°roy
(&
mosq
->
°©e_muãx
);

220 
	`±hªad_muãx_de°roy
(&
mosq
->
out_∑ckë_muãx
);

221 
	`±hªad_muãx_de°roy
(&
mosq
->
cuºít_out_∑ckë_muãx
);

222 
	`±hªad_muãx_de°roy
(&
mosq
->
msgtime_muãx
);

223 
	`±hªad_muãx_de°roy
(&
mosq
->
msgs_ö
.
muãx
);

224 
	`±hªad_muãx_de°roy
(&
mosq
->
msgs_out
.
muãx
);

225 
	`±hªad_muãx_de°roy
(&
mosq
->
mid_muãx
);

228 if(
mosq
->
sock
 !
INVALID_SOCKET
){

229 
	`√t__sockë_˛o£
(
mosq
);

231 
	`mesßge__˛ónup_Æl
(
mosq
);

232 
	`wûl__˛ór
(
mosq
);

233 #ifde‡
WITH_TLS


234 if(
mosq
->
s¶
){

235 
	`SSL_‰ì
(
mosq
->
s¶
);

237 if(
mosq
->
s¶_˘x
){

238 
	`SSL_CTX_‰ì
(
mosq
->
s¶_˘x
);

240 
	`mosquôto__‰ì
(
mosq
->
és_ˇfûe
);

241 
	`mosquôto__‰ì
(
mosq
->
és_ˇ∑th
);

242 
	`mosquôto__‰ì
(
mosq
->
és_˚πfûe
);

243 
	`mosquôto__‰ì
(
mosq
->
és_keyfûe
);

244 if(
mosq
->
és_pw_ˇŒback
Ëmosq->és_pw_ˇŒback = 
NULL
;

245 
	`mosquôto__‰ì
(
mosq
->
és_vîsi⁄
);

246 
	`mosquôto__‰ì
(
mosq
->
és_cùhîs
);

247 
	`mosquôto__‰ì
(
mosq
->
és_psk
);

248 
	`mosquôto__‰ì
(
mosq
->
és_psk_idítôy
);

249 
	`mosquôto__‰ì
(
mosq
->
és_Æ≤
);

252 
	`mosquôto__‰ì
(
mosq
->
addªss
);

253 
mosq
->
addªss
 = 
NULL
;

255 
	`mosquôto__‰ì
(
mosq
->
id
);

256 
mosq
->
id
 = 
NULL
;

258 
	`mosquôto__‰ì
(
mosq
->
u£∫ame
);

259 
mosq
->
u£∫ame
 = 
NULL
;

261 
	`mosquôto__‰ì
(
mosq
->
∑ssw‹d
);

262 
mosq
->
∑ssw‹d
 = 
NULL
;

264 
	`mosquôto__‰ì
(
mosq
->
ho°
);

265 
mosq
->
ho°
 = 
NULL
;

267 
	`mosquôto__‰ì
(
mosq
->
böd_addªss
);

268 
mosq
->
böd_addªss
 = 
NULL
;

271 if(
mosq
->
out_∑ckë
 && !mosq->
cuºít_out_∑ckë
){

272 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

273 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

275 
mosq
->
cuºít_out_∑ckë
){

276 
∑ckë
 = 
mosq
->
cuºít_out_∑ckë
;

278 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

279 if(
mosq
->
out_∑ckë
){

280 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

283 
	`∑ckë__˛ónup
(
∑ckë
);

284 
	`mosquôto__‰ì
(
∑ckë
);

287 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

288 if(
mosq
->
sock∑úR
 !
INVALID_SOCKET
){

289 
	`COMPAT_CLOSE
(
mosq
->
sock∑úR
);

290 
mosq
->
sock∑úR
 = 
INVALID_SOCKET
;

292 if(
mosq
->
sock∑úW
 !
INVALID_SOCKET
){

293 
	`COMPAT_CLOSE
(
mosq
->
sock∑úW
);

294 
mosq
->
sock∑úW
 = 
INVALID_SOCKET
;

296 
	}
}

298 
	$mosquôto_de°roy
(
mosquôto
 *
mosq
)

300 if(!
mosq
) ;

302 
	`mosquôto__de°roy
(
mosq
);

303 
	`mosquôto__‰ì
(
mosq
);

304 
	}
}

306 
	$mosquôto_sockë
(
mosquôto
 *
mosq
)

308 if(!
mosq
Ë 
INVALID_SOCKET
;

309  
mosq
->
sock
;

310 
	}
}

313 
boﬁ
 
	$mosquôto_w™t_wrôe
(
mosquôto
 *
mosq
)

315 
boﬁ
 
ªsu…
 = 
Ál£
;

316 if(
mosq
->
out_∑ckë
 || mosq->
cuºít_out_∑ckë
){

317 
ªsu…
 = 
åue
;

319 #ifde‡
WITH_TLS


320 if(
mosq
->
s¶
){

321 i‡(
mosq
->
w™t_wrôe
) {

322 
ªsu…
 = 
åue
;

323 }if(
mosq
->
w™t_c⁄√˘
){

324 
ªsu…
 = 
Ál£
;

328  
ªsu…
;

329 
	}
}

332 c⁄° *
	$mosquôto_°ªº‹
(
mosq_î∫o
)

334 
mosq_î∫o
){

335 
MOSQ_ERR_AUTH_CONTINUE
:

337 
MOSQ_ERR_NO_SUBSCRIBERS
:

339 
MOSQ_ERR_SUB_EXISTS
:

341 
MOSQ_ERR_CONN_PENDING
:

343 
MOSQ_ERR_SUCCESS
:

345 
MOSQ_ERR_NOMEM
:

347 
MOSQ_ERR_PROTOCOL
:

349 
MOSQ_ERR_INVAL
:

351 
MOSQ_ERR_NO_CONN
:

353 
MOSQ_ERR_CONN_REFUSED
:

355 
MOSQ_ERR_NOT_FOUND
:

357 
MOSQ_ERR_CONN_LOST
:

359 
MOSQ_ERR_TLS
:

361 
MOSQ_ERR_PAYLOAD_SIZE
:

363 
MOSQ_ERR_NOT_SUPPORTED
:

365 
MOSQ_ERR_AUTH
:

367 
MOSQ_ERR_ACL_DENIED
:

369 
MOSQ_ERR_UNKNOWN
:

371 
MOSQ_ERR_ERRNO
:

372  
	`°ªº‹
(
î∫o
);

373 
MOSQ_ERR_EAI
:

375 
MOSQ_ERR_PROXY
:

377 
MOSQ_ERR_MALFORMED_UTF8
:

379 
MOSQ_ERR_DUPLICATE_PROPERTY
:

381 
MOSQ_ERR_TLS_HANDSHAKE
:

383 
MOSQ_ERR_QOS_NOT_SUPPORTED
:

385 
MOSQ_ERR_OVERSIZE_PACKET
:

387 
MOSQ_ERR_OCSP
:

392 
	}
}

394 c⁄° *
	$mosquôto_c⁄«ck_°rög
(
c⁄«ck_code
)

396 
c⁄«ck_code
){

412 
	}
}

414 c⁄° *
	$mosquôto_ªas⁄_°rög
(
ªas⁄_code
)

416 
ªas⁄_code
){

417 
MQTT_RC_SUCCESS
:

419 
MQTT_RC_GRANTED_QOS1
:

421 
MQTT_RC_GRANTED_QOS2
:

423 
MQTT_RC_DISCONNECT_WITH_WILL_MSG
:

425 
MQTT_RC_NO_MATCHING_SUBSCRIBERS
:

427 
MQTT_RC_NO_SUBSCRIPTION_EXISTED
:

429 
MQTT_RC_CONTINUE_AUTHENTICATION
:

431 
MQTT_RC_REAUTHENTICATE
:

434 
MQTT_RC_UNSPECIFIED
:

436 
MQTT_RC_MALFORMED_PACKET
:

438 
MQTT_RC_PROTOCOL_ERROR
:

440 
MQTT_RC_IMPLEMENTATION_SPECIFIC
:

442 
MQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
:

444 
MQTT_RC_CLIENTID_NOT_VALID
:

446 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
:

448 
MQTT_RC_NOT_AUTHORIZED
:

450 
MQTT_RC_SERVER_UNAVAILABLE
:

452 
MQTT_RC_SERVER_BUSY
:

454 
MQTT_RC_BANNED
:

456 
MQTT_RC_SERVER_SHUTTING_DOWN
:

458 
MQTT_RC_BAD_AUTHENTICATION_METHOD
:

460 
MQTT_RC_KEEP_ALIVE_TIMEOUT
:

462 
MQTT_RC_SESSION_TAKEN_OVER
:

464 
MQTT_RC_TOPIC_FILTER_INVALID
:

466 
MQTT_RC_TOPIC_NAME_INVALID
:

468 
MQTT_RC_PACKET_ID_IN_USE
:

470 
MQTT_RC_PACKET_ID_NOT_FOUND
:

472 
MQTT_RC_RECEIVE_MAXIMUM_EXCEEDED
:

474 
MQTT_RC_TOPIC_ALIAS_INVALID
:

476 
MQTT_RC_PACKET_TOO_LARGE
:

478 
MQTT_RC_MESSAGE_RATE_TOO_HIGH
:

480 
MQTT_RC_QUOTA_EXCEEDED
:

482 
MQTT_RC_ADMINISTRATIVE_ACTION
:

484 
MQTT_RC_PAYLOAD_FORMAT_INVALID
:

486 
MQTT_RC_RETAIN_NOT_SUPPORTED
:

488 
MQTT_RC_QOS_NOT_SUPPORTED
:

490 
MQTT_RC_USE_ANOTHER_SERVER
:

492 
MQTT_RC_SERVER_MOVED
:

494 
MQTT_RC_SHARED_SUBS_NOT_SUPPORTED
:

496 
MQTT_RC_CONNECTION_RATE_EXCEEDED
:

498 
MQTT_RC_MAXIMUM_CONNECT_TIME
:

500 
MQTT_RC_SUBSCRIPTION_IDS_NOT_SUPPORTED
:

502 
MQTT_RC_WILDCARD_SUBS_NOT_SUPPORTED
:

507 
	}
}

510 
	$mosquôto_°rög_to_comm™d
(c⁄° *
°r
, *
cmd
)

512 if(!
	`°rˇ£cmp
(
°r
, "connect")){

513 *
cmd
 = 
CMD_CONNECT
;

514 }if(!
	`°rˇ£cmp
(
°r
, "connack")){

515 *
cmd
 = 
CMD_CONNACK
;

516 }if(!
	`°rˇ£cmp
(
°r
, "publish")){

517 *
cmd
 = 
CMD_PUBLISH
;

518 }if(!
	`°rˇ£cmp
(
°r
, "puback")){

519 *
cmd
 = 
CMD_PUBACK
;

520 }if(!
	`°rˇ£cmp
(
°r
, "pubrec")){

521 *
cmd
 = 
CMD_PUBREC
;

522 }if(!
	`°rˇ£cmp
(
°r
, "pubrel")){

523 *
cmd
 = 
CMD_PUBREL
;

524 }if(!
	`°rˇ£cmp
(
°r
, "pubcomp")){

525 *
cmd
 = 
CMD_PUBCOMP
;

526 }if(!
	`°rˇ£cmp
(
°r
, "subscribe")){

527 *
cmd
 = 
CMD_SUBSCRIBE
;

528 }if(!
	`°rˇ£cmp
(
°r
, "unsubscribe")){

529 *
cmd
 = 
CMD_UNSUBSCRIBE
;

530 }if(!
	`°rˇ£cmp
(
°r
, "disconnect")){

531 *
cmd
 = 
CMD_DISCONNECT
;

532 }if(!
	`°rˇ£cmp
(
°r
, "auth")){

533 *
cmd
 = 
CMD_AUTH
;

534 }if(!
	`°rˇ£cmp
(
°r
, "will")){

535 *
cmd
 = 
CMD_WILL
;

537  
MOSQ_ERR_INVAL
;

539  
MOSQ_ERR_SUCCESS
;

540 
	}
}

543 
	$mosquôto_sub_t›ic_tokíi£
(c⁄° *
subt›ic
, ***
t›ics
, *
cou¡
)

545 
Àn
;

546 
hõr_cou¡
 = 1;

547 
°¨t
, 
°›
;

548 
hõr
;

549 
éí
;

550 
i
, 
j
;

552 if(!
subt›ic
 || !
t›ics
 || !
cou¡
Ë 
MOSQ_ERR_INVAL
;

554 
Àn
 = 
	`°æí
(
subt›ic
);

556 
i
=0; i<
Àn
; i++){

557 if(
subt›ic
[
i
] == '/'){

558 if(
i
 > 
Àn
-1){

561 
hõr_cou¡
++;

566 (*
t›ics
Ë
	`mosquôto__ˇŒoc
(
hõr_cou¡
, (*));

567 if(!(*
t›ics
)Ë 
MOSQ_ERR_NOMEM
;

569 
°¨t
 = 0;

570 
°›
 = 0;

571 
hõr
 = 0;

573 
i
=0; i<
Àn
+1; i++){

574 if(
subt›ic
[
i
] == '/' || subtopic[i] == '\0'){

575 
°›
 = 
i
;

576 if(
°¨t
 !
°›
){

577 
éí
 = 
°›
-
°¨t
 + 1;

578 (*
t›ics
)[
hõr
] = 
	`mosquôto__ˇŒoc
(
éí
, ());

579 if(!(*
t›ics
)[
hõr
]){

580 
j
=0; j<
hõr
; j++){

581 
	`mosquôto__‰ì
((*
t›ics
)[
j
]);

583 
	`mosquôto__‰ì
((*
t›ics
));

584  
MOSQ_ERR_NOMEM
;

586 
j
=
°¨t
; j<
°›
; j++){

587 (*
t›ics
)[
hõr
][
j
-
°¨t
] = 
subt›ic
[j];

590 
°¨t
 = 
i
+1;

591 
hõr
++;

595 *
cou¡
 = 
hõr_cou¡
;

597  
MOSQ_ERR_SUCCESS
;

598 
	}
}

600 
	$mosquôto_sub_t›ic_tokís_‰ì
(***
t›ics
, 
cou¡
)

602 
i
;

604 if(!
t›ics
 || !(*t›icsË|| 
cou¡
<1Ë 
MOSQ_ERR_INVAL
;

606 
i
=0; i<
cou¡
; i++){

607 
	`mosquôto__‰ì
((*
t›ics
)[
i
]);

609 
	`mosquôto__‰ì
(*
t›ics
);

611  
MOSQ_ERR_SUCCESS
;

612 
	}
}

	@lib/mosquitto.h

17 #i‚de‡
MOSQUITTO_H


18 
	#MOSQUITTO_H


	)

20 #ifde‡
__˝lu•lus


24 #i‡
deföed
(
WIN32
Ë&& !deföed(
WITH_BROKER
Ë&& !deföed(
LIBMOSQUITTO_STATIC
)

25 #ifde‡
libmosquôto_EXPORTS


26 
	#libmosq_EXPORT
 
	`__de˛•ec
(
dŒexp‹t
)

	)

28 
	#libmosq_EXPORT
 
	`__de˛•ec
(
dŒimp‹t
)

	)

31 
	#libmosq_EXPORT


	)

34 #i‡
deföed
(
_MSC_VER
) && _MSC_VER < 1900

35 #i‚de‡
__˝lu•lus


36 
	#boﬁ
 

	)

37 
	#åue
 1

	)

38 
	#Ál£
 0

	)

41 #i‚de‡
__˝lu•lus


42 
	~<°dboﬁ.h
>

46 
	~<°ddef.h
>

47 
	~<°döt.h
>

49 
	#LIBMOSQUITTO_MAJOR
 1

	)

50 
	#LIBMOSQUITTO_MINOR
 6

	)

51 
	#LIBMOSQUITTO_REVISION
 7

	)

53 
	#LIBMOSQUITTO_VERSION_NUMBER
 (
LIBMOSQUITTO_MAJOR
*1000000+
LIBMOSQUITTO_MINOR
*1000+
LIBMOSQUITTO_REVISION
)

	)

56 
	#MOSQ_LOG_NONE
 0

	)

57 
	#MOSQ_LOG_INFO
 (1<<0)

	)

58 
	#MOSQ_LOG_NOTICE
 (1<<1)

	)

59 
	#MOSQ_LOG_WARNING
 (1<<2)

	)

60 
	#MOSQ_LOG_ERR
 (1<<3)

	)

61 
	#MOSQ_LOG_DEBUG
 (1<<4)

	)

62 
	#MOSQ_LOG_SUBSCRIBE
 (1<<5)

	)

63 
	#MOSQ_LOG_UNSUBSCRIBE
 (1<<6)

	)

64 
	#MOSQ_LOG_WEBSOCKETS
 (1<<7)

	)

65 
	#MOSQ_LOG_INTERNAL
 0x80000000

	)

66 
	#MOSQ_LOG_ALL
 0x7FFFFFFF

	)

69 
	emosq_îr_t
 {

70 
MOSQ_ERR_AUTH_CONTINUE
 = -4,

71 
MOSQ_ERR_NO_SUBSCRIBERS
 = -3,

72 
MOSQ_ERR_SUB_EXISTS
 = -2,

73 
MOSQ_ERR_CONN_PENDING
 = -1,

74 
MOSQ_ERR_SUCCESS
 = 0,

75 
MOSQ_ERR_NOMEM
 = 1,

76 
MOSQ_ERR_PROTOCOL
 = 2,

77 
MOSQ_ERR_INVAL
 = 3,

78 
MOSQ_ERR_NO_CONN
 = 4,

79 
MOSQ_ERR_CONN_REFUSED
 = 5,

80 
MOSQ_ERR_NOT_FOUND
 = 6,

81 
MOSQ_ERR_CONN_LOST
 = 7,

82 
MOSQ_ERR_TLS
 = 8,

83 
MOSQ_ERR_PAYLOAD_SIZE
 = 9,

84 
MOSQ_ERR_NOT_SUPPORTED
 = 10,

85 
MOSQ_ERR_AUTH
 = 11,

86 
MOSQ_ERR_ACL_DENIED
 = 12,

87 
MOSQ_ERR_UNKNOWN
 = 13,

88 
MOSQ_ERR_ERRNO
 = 14,

89 
MOSQ_ERR_EAI
 = 15,

90 
MOSQ_ERR_PROXY
 = 16,

91 
MOSQ_ERR_PLUGIN_DEFER
 = 17,

92 
MOSQ_ERR_MALFORMED_UTF8
 = 18,

93 
MOSQ_ERR_KEEPALIVE
 = 19,

94 
MOSQ_ERR_LOOKUP
 = 20,

95 
MOSQ_ERR_MALFORMED_PACKET
 = 21,

96 
MOSQ_ERR_DUPLICATE_PROPERTY
 = 22,

97 
MOSQ_ERR_TLS_HANDSHAKE
 = 23,

98 
MOSQ_ERR_QOS_NOT_SUPPORTED
 = 24,

99 
MOSQ_ERR_OVERSIZE_PACKET
 = 25,

100 
MOSQ_ERR_OCSP
 = 26,

104 
	emosq_›t_t
 {

105 
MOSQ_OPT_PROTOCOL_VERSION
 = 1,

106 
MOSQ_OPT_SSL_CTX
 = 2,

107 
MOSQ_OPT_SSL_CTX_WITH_DEFAULTS
 = 3,

108 
MOSQ_OPT_RECEIVE_MAXIMUM
 = 4,

109 
MOSQ_OPT_SEND_MAXIMUM
 = 5,

110 
MOSQ_OPT_TLS_KEYFORM
 = 6,

111 
MOSQ_OPT_TLS_ENGINE
 = 7,

112 
MOSQ_OPT_TLS_ENGINE_KPASS_SHA1
 = 8,

113 
MOSQ_OPT_TLS_OCSP_REQUIRED
 = 9,

114 
MOSQ_OPT_TLS_ALPN
 = 10,

119 
	#MOSQ_MQTT_ID_MAX_LENGTH
 23

	)

121 
	#MQTT_PROTOCOL_V31
 3

	)

122 
	#MQTT_PROTOCOL_V311
 4

	)

123 
	#MQTT_PROTOCOL_V5
 5

	)

125 
	smosquôto_mesßge
{

126 
mid
;

127 *
t›ic
;

128 *
∑ylﬂd
;

129 
∑ylﬂdÀn
;

130 
qos
;

131 
boﬁ
 
ªèö
;

134 
mosquôto
;

135 
mqâ5__¥›îty
 
	tmosquôto_¥›îty
;

195 
libmosq_EXPORT
 
mosquôto_lib_vîsi⁄
(*
maj‹
, *
mö‹
, *
ªvisi⁄
);

210 
libmosq_EXPORT
 
mosquôto_lib_öô
();

223 
libmosq_EXPORT
 
mosquôto_lib_˛ónup
();

260 
libmosq_EXPORT
 
mosquôto
 *
mosquôto_√w
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
, *
obj
);

273 
libmosq_EXPORT
 
mosquôto_de°roy
(
mosquôto
 *
mosq
);

302 
libmosq_EXPORT
 
mosquôto_ªöôüli£
(
mosquôto
 *
mosq
, c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
, *
obj
);

334 
libmosq_EXPORT
 
mosquôto_wûl_£t
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
);

369 
libmosq_EXPORT
 
mosquôto_wûl_£t_v5
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_¥›îty
 *
¥›îtõs
);

384 
libmosq_EXPORT
 
mosquôto_wûl_˛ór
(
mosquôto
 *
mosq
);

415 
libmosq_EXPORT
 
mosquôto_u£∫ame_pw_£t
(
mosquôto
 *
mosq
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

447 
libmosq_EXPORT
 
mosquôto_c⁄√˘
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
);

477 
libmosq_EXPORT
 
mosquôto_c⁄√˘_böd
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

510 
libmosq_EXPORT
 
mosquôto_c⁄√˘_böd_v5
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

541 
libmosq_EXPORT
 
mosquôto_c⁄√˘_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
);

578 
libmosq_EXPORT
 
mosquôto_c⁄√˘_böd_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

614 
libmosq_EXPORT
 
mosquôto_c⁄√˘_§v
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
kì∑live
, c⁄° *
böd_addªss
);

645 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘
(
mosquôto
 *
mosq
);

676 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘_async
(
mosquôto
 *
mosq
);

691 
libmosq_EXPORT
 
mosquôto_disc⁄√˘
(
mosquôto
 *
mosq
);

714 
libmosq_EXPORT
 
mosquôto_disc⁄√˘_v5
(
mosquôto
 *
mosq
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

762 
libmosq_EXPORT
 
mosquôto_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
);

811 
libmosq_EXPORT
 
mosquôto_publish_v5
(

812 
mosquôto
 *
mosq
,

813 *
mid
,

814 c⁄° *
t›ic
,

815 
∑ylﬂdÀn
,

816 c⁄° *
∑ylﬂd
,

817 
qos
,

818 
boﬁ
 
ªèö
,

819 c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

845 
libmosq_EXPORT
 
mosquôto_subs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, 
qos
);

904 
libmosq_EXPORT
 
mosquôto_subs¸ibe_v5
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, 
qos
, 
›ti⁄s
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

961 
libmosq_EXPORT
 
mosquôto_subs¸ibe_mu…ùÀ
(
mosquôto
 *
mosq
, *
mid
, 
sub_cou¡
, *c⁄° *c⁄° 
sub
, 
qos
, 
›ti⁄s
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

985 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
);

1013 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe_v5
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

1044 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe_mu…ùÀ
(
mosquôto
 *
mosq
, *
mid
, 
sub_cou¡
, *c⁄° *c⁄° 
sub
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

1070 
libmosq_EXPORT
 
mosquôto_mesßge_c›y
(
mosquôto_mesßge
 *
d°
, c⁄° mosquôto_mesßgê*
§c
);

1083 
libmosq_EXPORT
 
mosquôto_mesßge_‰ì
(
mosquôto_mesßge
 **
mesßge
);

1096 
libmosq_EXPORT
 
mosquôto_mesßge_‰ì_c⁄ã¡s
(
mosquôto_mesßge
 *
mesßge
);

1148 
libmosq_EXPORT
 
mosquôto_lo›
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
);

1184 
libmosq_EXPORT
 
mosquôto_lo›_f‹evî
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
);

1204 
libmosq_EXPORT
 
mosquôto_lo›_°¨t
(
mosquôto
 *
mosq
);

1228 
libmosq_EXPORT
 
mosquôto_lo›_°›
(
mosquôto
 *
mosq
, 
boﬁ
 
f‹˚
);

1264 
libmosq_EXPORT
 
mosquôto_lo›_ªad
(
mosquôto
 *
mosq
, 
max_∑ckës
);

1294 
libmosq_EXPORT
 
mosquôto_lo›_wrôe
(
mosquôto
 *
mosq
, 
max_∑ckës
);

1317 
libmosq_EXPORT
 
mosquôto_lo›_misc
(
mosquôto
 *
mosq
);

1337 
libmosq_EXPORT
 
mosquôto_sockë
(
mosquôto
 *
mosq
);

1350 
libmosq_EXPORT
 
boﬁ
 
mosquôto_w™t_wrôe
(
mosquôto
 *
mosq
);

1367 
libmosq_EXPORT
 
mosquôto_thªaded_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
thªaded
);

1413 
libmosq_EXPORT
 
mosquôto_›ts_£t
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, *
vÆue
);

1463 
libmosq_EXPORT
 
mosquôto_öt_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, 
vÆue
);

1486 
libmosq_EXPORT
 
mosquôto_void_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, *
vÆue
);

1524 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘_dñay_£t
(
mosquôto
 *
mosq
, 
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
);

1552 
libmosq_EXPORT
 
mosquôto_max_öÊight_mesßges_£t
(
mosquôto
 *
mosq
, 
max_öÊight_mesßges
);

1559 
libmosq_EXPORT
 
mosquôto_mesßge_ªåy_£t
(
mosquôto
 *
mosq
, 
mesßge_ªåy
);

1575 
libmosq_EXPORT
 
mosquôto_u£r_d©a_£t
(
mosquôto
 *
mosq
, *
obj
);

1587 
libmosq_EXPORT
 *
mosquôto_u£rd©a
(
mosquôto
 *
mosq
);

1643 
libmosq_EXPORT
 
mosquôto_és_£t
(
mosquôto
 *
mosq
,

1644 c⁄° *
ˇfûe
, c⁄° *
ˇ∑th
,

1645 c⁄° *
˚πfûe
, c⁄° *
keyfûe
,

1646 (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
));

1673 
libmosq_EXPORT
 
mosquôto_és_ö£cuª_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
vÆue
);

1707 
libmosq_EXPORT
 
mosquôto_és_›ts_£t
(
mosquôto
 *
mosq
, 
˚π_ªqs
, c⁄° *
és_vîsi⁄
, c⁄° *
cùhîs
);

1734 
libmosq_EXPORT
 
mosquôto_és_psk_£t
(
mosquôto
 *
mosq
, c⁄° *
psk
, c⁄° *
idítôy
, c⁄° *
cùhîs
);

1764 
libmosq_EXPORT
 
mosquôto_c⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquitto *, *, ));

1789 
libmosq_EXPORT
 
mosquôto_c⁄√˘_wôh_Êags_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquitto *, *, , ));

1815 
libmosq_EXPORT
 
mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquôtÿ*, *, , , c⁄° 
mosquôto_¥›îty
 *
¥›s
));

1835 
libmosq_EXPORT
 
mosquôto_disc⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_disc⁄√˘
)(mosquitto *, *, ));

1856 
libmosq_EXPORT
 
mosquôto_disc⁄√˘_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_disc⁄√˘
)(mosquôtÿ*, *, , c⁄° 
mosquôto_¥›îty
 *));

1874 
libmosq_EXPORT
 
mosquôto_publish_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_publish
)(mosquitto *, *, ));

1896 
libmosq_EXPORT
 
mosquôto_publish_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_publish
)(mosquôtÿ*, *, , , c⁄° 
mosquôto_¥›îty
 *));

1919 
libmosq_EXPORT
 
mosquôto_mesßge_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_mesßge
)(mosquôtÿ*, *, c⁄° 
mosquôto_mesßge
 *));

1943 
libmosq_EXPORT
 
mosquôto_mesßge_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_mesßge
)(mosquôtÿ*, *, c⁄° 
mosquôto_mesßge
 *, c⁄° 
mosquôto_¥›îty
 *));

1964 
libmosq_EXPORT
 
mosquôto_subs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_subs¸ibe
)(mosquitto *, *, , , const *));

1986 
libmosq_EXPORT
 
mosquôto_subs¸ibe_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_subs¸ibe
)(mosquôtÿ*, *, , , c⁄° *, c⁄° 
mosquôto_¥›îty
 *));

2004 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_unsubs¸ibe
)(mosquitto *, *, ));

2023 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe_v5_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_unsubs¸ibe
)(mosquôtÿ*, *, , c⁄° 
mosquôto_¥›îty
 *));

2046 
libmosq_EXPORT
 
mosquôto_log_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_log
)(mosquitto *, *, , const *));

2079 
libmosq_EXPORT
 
mosquôto_°rög_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, c⁄° *
vÆue
);

2117 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘_dñay_£t
(
mosquôto
 *
mosq
, 
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
);

2142 
libmosq_EXPORT
 
mosquôto_socks5_£t
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

2163 
libmosq_EXPORT
 c⁄° *
mosquôto_°ªº‹
(
mosq_î∫o
);

2176 
libmosq_EXPORT
 c⁄° *
mosquôto_c⁄«ck_°rög
(
c⁄«ck_code
);

2189 
libmosq_EXPORT
 c⁄° *
mosquôto_ªas⁄_°rög
(
ªas⁄_code
);

2208 
libmosq_EXPORT
 
mosquôto_°rög_to_comm™d
(c⁄° *
°r
, *
cmd
);

2264 
libmosq_EXPORT
 
mosquôto_sub_t›ic_tokíi£
(c⁄° *
subt›ic
, ***
t›ics
, *
cou¡
);

2282 
libmosq_EXPORT
 
mosquôto_sub_t›ic_tokís_‰ì
(***
t›ics
, 
cou¡
);

2308 
libmosq_EXPORT
 
mosquôto_t›ic_m©ches_sub
(c⁄° *
sub
, c⁄° *
t›ic
, 
boﬁ
 *
ªsu…
);

2309 
libmosq_EXPORT
 
mosquôto_t›ic_m©ches_sub2
(c⁄° *
sub
, 
size_t
 
subÀn
, c⁄° *
t›ic
, size_à
t›i˛í
, 
boﬁ
 *
ªsu…
);

2335 
libmosq_EXPORT
 
mosquôto_pub_t›ic_check
(c⁄° *
t›ic
);

2336 
libmosq_EXPORT
 
mosquôto_pub_t›ic_check2
(c⁄° *
t›ic
, 
size_t
 
t›i˛í
);

2365 
libmosq_EXPORT
 
mosquôto_sub_t›ic_check
(c⁄° *
t›ic
);

2366 
libmosq_EXPORT
 
mosquôto_sub_t›ic_check2
(c⁄° *
t›ic
, 
size_t
 
t›i˛í
);

2369 
	slibmosquôto_wûl
 {

2370 *
t›ic
;

2371 *
∑ylﬂd
;

2372 
∑ylﬂdÀn
;

2373 
qos
;

2374 
boﬁ
 
ªèö
;

2377 
	slibmosquôto_auth
 {

2378 *
u£∫ame
;

2379 *
∑ssw‹d
;

2382 
	slibmosquôto_és
 {

2383 *
ˇfûe
;

2384 *
ˇ∑th
;

2385 *
˚πfûe
;

2386 *
keyfûe
;

2387 *
cùhîs
;

2388 *
és_vîsi⁄
;

2389 (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
);

2390 
˚π_ªqs
;

2430 
libmosq_EXPORT
 
mosquôto_subs¸ibe_sim∂e
(

2431 
mosquôto_mesßge
 **
mesßges
,

2432 
msg_cou¡
,

2433 
boﬁ
 
w™t_ªèöed
,

2434 c⁄° *
t›ic
,

2435 
qos
,

2436 c⁄° *
ho°
,

2437 
p‹t
,

2438 c⁄° *
˛õ¡_id
,

2439 
kì∑live
,

2440 
boﬁ
 
˛ón_£ssi⁄
,

2441 c⁄° *
u£∫ame
,

2442 c⁄° *
∑ssw‹d
,

2443 c⁄° 
libmosquôto_wûl
 *
wûl
,

2444 c⁄° 
libmosquôto_és
 *
és
);

2483 
libmosq_EXPORT
 
mosquôto_subs¸ibe_ˇŒback
(

2484 (*
ˇŒback
)(
mosquôto
 *, *, c⁄° 
mosquôto_mesßge
 *),

2485 *
u£rd©a
,

2486 c⁄° *
t›ic
,

2487 
qos
,

2488 c⁄° *
ho°
,

2489 
p‹t
,

2490 c⁄° *
˛õ¡_id
,

2491 
kì∑live
,

2492 
boﬁ
 
˛ón_£ssi⁄
,

2493 c⁄° *
u£∫ame
,

2494 c⁄° *
∑ssw‹d
,

2495 c⁄° 
libmosquôto_wûl
 *
wûl
,

2496 c⁄° 
libmosquôto_és
 *
és
);

2514 
libmosq_EXPORT
 
mosquôto_vÆid©e_utf8
(c⁄° *
°r
, 
Àn
);

2547 
libmosq_EXPORT
 
mosquôto_¥›îty_add_byã
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt8_t
 
vÆue
);

2571 
libmosq_EXPORT
 
mosquôto_¥›îty_add_öt16
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt16_t
 
vÆue
);

2595 
libmosq_EXPORT
 
mosquôto_¥›îty_add_öt32
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt32_t
 
vÆue
);

2619 
libmosq_EXPORT
 
mosquôto_¥›îty_add_v¨öt
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt32_t
 
vÆue
);

2644 
libmosq_EXPORT
 
mosquôto_¥›îty_add_bö¨y
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
vÆue
, 
uöt16_t
 
Àn
);

2669 
libmosq_EXPORT
 
mosquôto_¥›îty_add_°rög
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
vÆue
);

2695 
libmosq_EXPORT
 
mosquôto_¥›îty_add_°rög_∑ú
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
«me
, c⁄° *
vÆue
);

2732 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_byã
(

2733 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2734 
idítifõr
,

2735 
uöt8_t
 *
vÆue
,

2736 
boﬁ
 
skù_fú°
);

2757 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_öt16
(

2758 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2759 
idítifõr
,

2760 
uöt16_t
 *
vÆue
,

2761 
boﬁ
 
skù_fú°
);

2782 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_öt32
(

2783 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2784 
idítifõr
,

2785 
uöt32_t
 *
vÆue
,

2786 
boﬁ
 
skù_fú°
);

2807 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_v¨öt
(

2808 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2809 
idítifõr
,

2810 
uöt32_t
 *
vÆue
,

2811 
boﬁ
 
skù_fú°
);

2834 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_bö¨y
(

2835 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2836 
idítifõr
,

2837 **
vÆue
,

2838 
uöt16_t
 *
Àn
,

2839 
boﬁ
 
skù_fú°
);

2863 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_°rög
(

2864 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2865 
idítifõr
,

2866 **
vÆue
,

2867 
boﬁ
 
skù_fú°
);

2893 
libmosq_EXPORT
 c⁄° 
mosquôto_¥›îty
 *
mosquôto_¥›îty_ªad_°rög_∑ú
(

2894 c⁄° 
mosquôto_¥›îty
 *
¥›li°
,

2895 
idítifõr
,

2896 **
«me
,

2897 **
vÆue
,

2898 
boﬁ
 
skù_fú°
);

2913 
libmosq_EXPORT
 
mosquôto_¥›îty_‰ì_Æl
(
mosquôto_¥›îty
 **
¥›îtõs
);

2927 
libmosq_EXPORT
 
mosquôto_¥›îty_c›y_Æl
(
mosquôto_¥›îty
 **
de°
, c⁄° mosquôto_¥›îty *
§c
);

2942 
libmosq_EXPORT
 
mosquôto_¥›îty_check_comm™d
(
comm™d
, 
idítifõr
);

2965 
libmosq_EXPORT
 
mosquôto_¥›îty_check_Æl
(
comm™d
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

2987 
libmosq_EXPORT
 
mosquôto_°rög_to_¥›îty_öfo
(c⁄° *
¥›«me
, *
idítifõr
, *
ty≥
);

2990 #ifde‡
__˝lu•lus


	@lib/mosquitto_internal.h

18 #i‚de‡
MOSQUITTO_INTERNAL_H


19 
	#MOSQUITTO_INTERNAL_H


	)

21 
	~"c⁄fig.h
"

23 #ifde‡
WIN32


24 
	~<wösock2.h
>

27 #ifde‡
WITH_TLS


28 
	~<›ís¶/s¶.h
>

30 
	~<time.h
>

32 
	~<°dlib.h
>

34 #i‡
deföed
(
WITH_THREADING
Ë&& !deföed(
WITH_BROKER
)

35 
	~<±hªad.h
>

37 
	~<dummy±hªad.h
>

40 #ifde‡
WITH_SRV


41 
	~<¨es.h
>

44 #ifde‡
WIN32


45 #i‡
_MSC_VER
 < 1600

46 
	tuöt8_t
;

47 
	tuöt16_t
;

48 
	tuöt32_t
;

49 
	tuöt64_t
;

51 
	~<°döt.h
>

54 
	~<°döt.h
>

57 
	~"mosquôto.h
"

58 
	~"time_mosq.h
"

59 #ifde‡
WITH_BROKER


60 #ifde‡
__löux__


61 
	~<√tdb.h
>

63 
	~"uthash.h
"

64 
	gmosquôto_˛õ¡_msg
;

67 #ifde‡
WIN32


68 
SOCKET
 
	tmosq_sock_t
;

70 
	tmosq_sock_t
;

73 
	emosquôto_msg_dúe˘i⁄
 {

74 
	mmosq_md_ö
 = 0,

75 
	mmosq_md_out
 = 1

78 
	emosquôto_msg_°©e
 {

79 
	mmosq_ms_övÆid
 = 0,

80 
	mmosq_ms_publish_qos0
 = 1,

81 
	mmosq_ms_publish_qos1
 = 2,

82 
	mmosq_ms_waô_f‹_puback
 = 3,

83 
	mmosq_ms_publish_qos2
 = 4,

84 
	mmosq_ms_waô_f‹_pubªc
 = 5,

85 
	mmosq_ms_ª£nd_pubªl
 = 6,

86 
	mmosq_ms_waô_f‹_pubªl
 = 7,

87 
	mmosq_ms_ª£nd_pubcomp
 = 8,

88 
	mmosq_ms_waô_f‹_pubcomp
 = 9,

89 
	mmosq_ms_£nd_pubªc
 = 10,

90 
	mmosq_ms_queued
 = 11

93 
	emosquôto_˛õ¡_°©e
 {

94 
	mmosq_cs_√w
 = 0,

95 
	mmosq_cs_c⁄√˘ed
 = 1,

96 
	mmosq_cs_disc⁄√˘ög
 = 2,

97 
	mmosq_cs_a˘ive
 = 3,

98 
	mmosq_cs_c⁄√˘_≥ndög
 = 4,

99 
	mmosq_cs_c⁄√˘_§v
 = 5,

100 
	mmosq_cs_disc⁄√˘_ws
 = 6,

101 
	mmosq_cs_disc⁄√˘ed
 = 7,

102 
	mmosq_cs_socks5_√w
 = 8,

103 
	mmosq_cs_socks5_°¨t
 = 9,

104 
	mmosq_cs_socks5_ªque°
 = 10,

105 
	mmosq_cs_socks5_ª∂y
 = 11,

106 
	mmosq_cs_socks5_auth_ok
 = 12,

107 
	mmosq_cs_socks5_u£Ωass_ª∂y
 = 13,

108 
	mmosq_cs_socks5_£nd_u£Ωass
 = 14,

109 
	mmosq_cs_expúög
 = 15,

110 
	mmosq_cs_du∂iˇã
 = 17,

111 
	mmosq_cs_disc⁄√˘_wôh_wûl
 = 18,

112 
	mmosq_cs_disu£d
 = 19,

113 
	mmosq_cs_authítiˇtög
 = 20,

114 
	mmosq_cs_ªauthítiˇtög
 = 21,

117 
	emosquôto__¥Ÿocﬁ
 {

118 
	mmosq_p_övÆid
 = 0,

119 
	mmosq_p_mqâ31
 = 1,

120 
	mmosq_p_mqâ311
 = 2,

121 
	mmosq_p_mqâs
 = 3,

122 
	mmosq_p_mqâ5
 = 5,

125 
	emosquôto__thªaded_°©e
 {

126 
	mmosq_ts_n⁄e
,

127 
	mmosq_ts_£lf
,

128 
	mmosq_ts_exã∫Æ


131 
	emosquôto__å™•‹t
 {

132 
	mmosq_t_övÆid
 = 0,

133 
	mmosq_t_t˝
 = 1,

134 
	mmosq_t_ws
 = 2,

135 
	mmosq_t_s˘p
 = 3

139 
	smosquôto__Æüs
{

140 *
	mt›ic
;

141 
uöt16_t
 
	mÆüs
;

144 
	s£ssi⁄_expúy_li°
 {

145 
mosquôto
 *
	mc⁄ãxt
;

146 
£ssi⁄_expúy_li°
 *
	m¥ev
;

147 
£ssi⁄_expúy_li°
 *
	m√xt
;

150 
	smosquôto__∑ckë
{

151 
uöt8_t
 *
	m∑ylﬂd
;

152 
mosquôto__∑ckë
 *
	m√xt
;

153 
uöt32_t
 
	mªmaöög_mu…
;

154 
uöt32_t
 
	mªmaöög_Àngth
;

155 
uöt32_t
 
	m∑ckë_Àngth
;

156 
uöt32_t
 
	mto_¥o˚ss
;

157 
uöt32_t
 
	mpos
;

158 
uöt16_t
 
	mmid
;

159 
uöt8_t
 
	mcomm™d
;

160 
öt8_t
 
	mªmaöög_cou¡
;

163 
	smosquôto_mesßge_Æl
{

164 
mosquôto_mesßge_Æl
 *
	m√xt
;

165 
mosquôto_mesßge_Æl
 *
	m¥ev
;

166 
mosquôto_¥›îty
 *
	m¥›îtõs
;

167 
time_t
 
	mtime°amp
;

169 
mosquôto_msg_°©e
 
	m°©e
;

170 
boﬁ
 
	mdup
;

171 
mosquôto_mesßge
 
	mmsg
;

172 
uöt32_t
 
	mexpúy_öãrvÆ
;

175 #ifde‡
WITH_TLS


176 
	emosquôto__keyf‹m
 {

177 
	mmosq_k_≥m
 = 0,

178 
	mmosq_k_ígöe
 = 1,

182 
	swûl_dñay_li°
 {

183 
mosquôto
 *
	mc⁄ãxt
;

184 
wûl_dñay_li°
 *
	m¥ev
;

185 
wûl_dñay_li°
 *
	m√xt
;

188 
	smosquôto_msg_d©a
{

189 #ifde‡
WITH_BROKER


190 
mosquôto_˛õ¡_msg
 *
	möÊight
;

191 
mosquôto_˛õ¡_msg
 *
	mqueued
;

192 
	mmsg_byãs
;

193 
	mmsg_byãs12
;

194 
	mmsg_cou¡
;

195 
	mmsg_cou¡12
;

197 
mosquôto_mesßge_Æl
 *
	möÊight
;

198 
	mqueue_Àn
;

199 #ifde‡
WITH_THREADING


200 
±hªad_muãx_t
 
	mmuãx
;

203 
	möÊight_quŸa
;

204 
uöt16_t
 
	möÊight_maximum
;

208 
	smosquôto
 {

209 
mosq_sock_t
 
	msock
;

210 #i‚de‡
WITH_BROKER


211 
mosq_sock_t
 
	msock∑úR
, 
	msock∑úW
;

213 #i‡
deföed
(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

214 
gaicb
 *
	madns
;

216 
mosquôto__¥Ÿocﬁ
 
	m¥Ÿocﬁ
;

217 *
	maddªss
;

218 *
	mid
;

219 *
	mu£∫ame
;

220 *
	m∑ssw‹d
;

221 
uöt16_t
 
	mkì∑live
;

222 
uöt16_t
 
	mœ°_mid
;

223 
mosquôto_˛õ¡_°©e
 
	m°©e
;

224 
time_t
 
	mœ°_msg_ö
;

225 
time_t
 
	m√xt_msg_out
;

226 
time_t
 
	mpög_t
;

227 
mosquôto__∑ckë
 
	mö_∑ckë
;

228 
mosquôto__∑ckë
 *
	mcuºít_out_∑ckë
;

229 
mosquôto__∑ckë
 *
	mout_∑ckë
;

230 
mosquôto_mesßge_Æl
 *
	mwûl
;

231 
mosquôto__Æüs
 *
	mÆü£s
;

232 
wûl_dñay_li°
 *
	mwûl_dñay_íåy
;

233 
uöt32_t
 
	mmaximum_∑ckë_size
;

234 
	mÆüs_cou¡
;

235 
uöt32_t
 
	mwûl_dñay_öãrvÆ
;

236 
time_t
 
	mwûl_dñay_time
;

237 #ifde‡
WITH_TLS


238 
SSL
 *
	ms¶
;

239 
SSL_CTX
 *
	ms¶_˘x
;

240 *
	més_ˇfûe
;

241 *
	més_ˇ∑th
;

242 *
	més_˚πfûe
;

243 *
	més_keyfûe
;

244 (*
	més_pw_ˇŒback
)(*
	mbuf
, 
	msize
, 
	mrwÊag
, *
	mu£rd©a
);

245 *
	més_vîsi⁄
;

246 *
	més_cùhîs
;

247 *
	més_psk
;

248 *
	més_psk_idítôy
;

249 
	més_˚π_ªqs
;

250 
boﬁ
 
	més_ö£cuª
;

251 
boﬁ
 
	ms¶_˘x_deÁu…s
;

252 
boﬁ
 
	més_oc•_ªquúed
;

253 *
	més_ígöe
;

254 *
	més_ígöe_k∑ss_sha1
;

255 
mosquôto__keyf‹m
 
	més_keyf‹m
;

256 *
	més_Æ≤
;

258 
boﬁ
 
	mw™t_wrôe
;

259 
boﬁ
 
	mw™t_c⁄√˘
;

260 #i‡
deföed
(
WITH_THREADING
Ë&& !deföed(
WITH_BROKER
)

261 
±hªad_muãx_t
 
	mˇŒback_muãx
;

262 
±hªad_muãx_t
 
	mlog_ˇŒback_muãx
;

263 
±hªad_muãx_t
 
	mmsgtime_muãx
;

264 
±hªad_muãx_t
 
	mout_∑ckë_muãx
;

265 
±hªad_muãx_t
 
	mcuºít_out_∑ckë_muãx
;

266 
±hªad_muãx_t
 
	m°©e_muãx
;

267 
±hªad_muãx_t
 
	mmid_muãx
;

268 
±hªad_t
 
	mthªad_id
;

270 
boﬁ
 
	m˛ón_°¨t
;

271 
uöt32_t
 
	m£ssi⁄_expúy_öãrvÆ
;

272 
time_t
 
	m£ssi⁄_expúy_time
;

273 #ifde‡
WITH_BROKER


274 
boﬁ
 
	mªmoved_‰om_by_id
;

275 
boﬁ
 
	mis_dr›pög
;

276 
boﬁ
 
	mis_bridge
;

277 
mosquôto__bridge
 *
	mbridge
;

278 
mosquôto_msg_d©a
 
	mmsgs_ö
;

279 
mosquôto_msg_d©a
 
	mmsgs_out
;

280 
mosquôto__a˛_u£r
 *
	ma˛_li°
;

281 
mosquôto__li°íî
 *
	mli°íî
;

282 
mosquôto__∑ckë
 *
	mout_∑ckë_œ°
;

283 
mosquôto__subhõr
 **
	msubs
;

284 
mosquôto__subsh¨ed_ªf
 **
	msh¨ed_subs
;

285 *
	mauth_mëhod
;

286 
	msub_cou¡
;

287 
	msh¨ed_sub_cou¡
;

288 
	mpﬁlfd_ödex
;

289 #ifde‡
WITH_WEBSOCKETS


290 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

291 
lws
 *
	mwsi
;

293 
libwebsockë_c⁄ãxt
 *
	mws_c⁄ãxt
;

294 
libwebsockë
 *
	mwsi
;

297 
boﬁ
 
	mws_w™t_wrôe
;

298 
boﬁ
 
	massig√d_id
;

300 #ifde‡
WITH_SOCKS


301 *
	msocks5_ho°
;

302 
	msocks5_p‹t
;

303 *
	msocks5_u£∫ame
;

304 *
	msocks5_∑ssw‹d
;

306 *
	mu£rd©a
;

307 
boﬁ
 
	mö_ˇŒback
;

308 
mosquôto_msg_d©a
 
	mmsgs_ö
;

309 
mosquôto_msg_d©a
 
	mmsgs_out
;

310 (*
	m⁄_c⁄√˘
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
);

311 (*
	m⁄_c⁄√˘_wôh_Êags
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
, 
	mÊags
);

312 (*
	m⁄_c⁄√˘_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
, 
	mÊags
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

313 (*
	m⁄_disc⁄√˘
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
);

314 (*
	m⁄_disc⁄√˘_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

315 (*
	m⁄_publish
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
);

316 (*
	m⁄_publish_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
, 
	mªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

317 (*
	m⁄_mesßge
)(
	mmosquôto
 *, *
	mu£rd©a
, c⁄° 
mosquôto_mesßge
 *
	mmesßge
);

318 (*
	m⁄_mesßge_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, c⁄° 
mosquôto_mesßge
 *
	mmesßge
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

319 (*
	m⁄_subs¸ibe
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
, 
	mqos_cou¡
, c⁄° *
	mgø¡ed_qos
);

320 (*
	m⁄_subs¸ibe_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
, 
	mqos_cou¡
, c⁄° *
	mgø¡ed_qos
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

321 (*
	m⁄_unsubs¸ibe
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
);

322 (*
	m⁄_unsubs¸ibe_v5
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
, c⁄° 
mosquôto_¥›îty
 *
	m¥›s
);

323 (*
	m⁄_log
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mÀvñ
, c⁄° *
	m°r
);

325 *
	mho°
;

326 
	mp‹t
;

327 *
	mböd_addªss
;

328 
	mªc⁄√˘s
;

329 
	mªc⁄√˘_dñay
;

330 
	mªc⁄√˘_dñay_max
;

331 
boﬁ
 
	mªc⁄√˘_exp⁄ítül_backoff
;

332 
	mthªaded
;

333 
mosquôto__∑ckë
 *
	mout_∑ckë_œ°
;

334 #ifde‡
WITH_SRV


335 
¨es_ch™√l
 
	mach™
;

338 
uöt8_t
 
	mmaximum_qos
;

340 #ifde‡
WITH_BROKER


341 
UT_hash_h™dÀ
 
	mhh_id
;

342 
UT_hash_h™dÀ
 
	mhh_sock
;

343 
mosquôto
 *
	mf‹_‰ì_√xt
;

344 
£ssi⁄_expúy_li°
 *
	mexpúy_li°_ôem
;

346 #ifde‡
WITH_EPOLL


347 
uöt32_t
 
	mevíts
;

351 
	#STREMPTY
(
°r
Ë(°r[0] ='\0')

	)

353 
do_˛õ¡_disc⁄√˘
(
mosquôto
 *
mosq
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

	@lib/mqtt_protocol.h

17 #i‚de‡
MQTT_PROTOCOL_H


18 
	#MQTT_PROTOCOL_H


	)

20 
	#PROTOCOL_NAME_v31
 "MQIsdp"

	)

21 
	#PROTOCOL_VERSION_v31
 3

	)

23 
	#PROTOCOL_NAME
 "MQTT"

	)

25 
	#PROTOCOL_VERSION_v311
 4

	)

26 
	#PROTOCOL_VERSION_v5
 5

	)

30 
	#CMD_CONNECT
 0x10

	)

31 
	#CMD_CONNACK
 0x20

	)

32 
	#CMD_PUBLISH
 0x30

	)

33 
	#CMD_PUBACK
 0x40

	)

34 
	#CMD_PUBREC
 0x50

	)

35 
	#CMD_PUBREL
 0x60

	)

36 
	#CMD_PUBCOMP
 0x70

	)

37 
	#CMD_SUBSCRIBE
 0x80

	)

38 
	#CMD_SUBACK
 0x90

	)

39 
	#CMD_UNSUBSCRIBE
 0xA0

	)

40 
	#CMD_UNSUBACK
 0xB0

	)

41 
	#CMD_PINGREQ
 0xC0

	)

42 
	#CMD_PINGRESP
 0xD0

	)

43 
	#CMD_DISCONNECT
 0xE0

	)

44 
	#CMD_AUTH
 0xF0

	)

47 
	#CMD_WILL
 0x100

	)

49 
	emqâ311_c⁄«ck_codes
 {

50 
	mCONNACK_ACCEPTED
 = 0,

51 
	mCONNACK_REFUSED_PROTOCOL_VERSION
 = 1,

52 
	mCONNACK_REFUSED_IDENTIFIER_REJECTED
 = 2,

53 
	mCONNACK_REFUSED_SERVER_UNAVAILABLE
 = 3,

54 
	mCONNACK_REFUSED_BAD_USERNAME_PASSWORD
 = 4,

55 
	mCONNACK_REFUSED_NOT_AUTHORIZED
 = 5,

59 
	emqâ5_ªtu∫_codes
 {

60 
	mMQTT_RC_SUCCESS
 = 0,

61 
	mMQTT_RC_NORMAL_DISCONNECTION
 = 0,

62 
	mMQTT_RC_GRANTED_QOS0
 = 0,

63 
	mMQTT_RC_GRANTED_QOS1
 = 1,

64 
	mMQTT_RC_GRANTED_QOS2
 = 2,

65 
	mMQTT_RC_DISCONNECT_WITH_WILL_MSG
 = 4,

66 
	mMQTT_RC_NO_MATCHING_SUBSCRIBERS
 = 16,

67 
	mMQTT_RC_NO_SUBSCRIPTION_EXISTED
 = 17,

68 
	mMQTT_RC_CONTINUE_AUTHENTICATION
 = 24,

69 
	mMQTT_RC_REAUTHENTICATE
 = 25,

71 
	mMQTT_RC_UNSPECIFIED
 = 128,

72 
	mMQTT_RC_MALFORMED_PACKET
 = 129,

73 
	mMQTT_RC_PROTOCOL_ERROR
 = 130,

74 
	mMQTT_RC_IMPLEMENTATION_SPECIFIC
 = 131,

75 
	mMQTT_RC_UNSUPPORTED_PROTOCOL_VERSION
 = 132,

76 
	mMQTT_RC_CLIENTID_NOT_VALID
 = 133,

77 
	mMQTT_RC_BAD_USERNAME_OR_PASSWORD
 = 134,

78 
	mMQTT_RC_NOT_AUTHORIZED
 = 135,

79 
	mMQTT_RC_SERVER_UNAVAILABLE
 = 136,

80 
	mMQTT_RC_SERVER_BUSY
 = 137,

81 
	mMQTT_RC_BANNED
 = 138,

82 
	mMQTT_RC_SERVER_SHUTTING_DOWN
 = 139,

83 
	mMQTT_RC_BAD_AUTHENTICATION_METHOD
 = 140,

84 
	mMQTT_RC_KEEP_ALIVE_TIMEOUT
 = 141,

85 
	mMQTT_RC_SESSION_TAKEN_OVER
 = 142,

86 
	mMQTT_RC_TOPIC_FILTER_INVALID
 = 143,

87 
	mMQTT_RC_TOPIC_NAME_INVALID
 = 144,

88 
	mMQTT_RC_PACKET_ID_IN_USE
 = 145,

89 
	mMQTT_RC_PACKET_ID_NOT_FOUND
 = 146,

90 
	mMQTT_RC_RECEIVE_MAXIMUM_EXCEEDED
 = 147,

91 
	mMQTT_RC_TOPIC_ALIAS_INVALID
 = 148,

92 
	mMQTT_RC_PACKET_TOO_LARGE
 = 149,

93 
	mMQTT_RC_MESSAGE_RATE_TOO_HIGH
 = 150,

94 
	mMQTT_RC_QUOTA_EXCEEDED
 = 151,

95 
	mMQTT_RC_ADMINISTRATIVE_ACTION
 = 152,

96 
	mMQTT_RC_PAYLOAD_FORMAT_INVALID
 = 153,

97 
	mMQTT_RC_RETAIN_NOT_SUPPORTED
 = 154,

98 
	mMQTT_RC_QOS_NOT_SUPPORTED
 = 155,

99 
	mMQTT_RC_USE_ANOTHER_SERVER
 = 156,

100 
	mMQTT_RC_SERVER_MOVED
 = 157,

101 
	mMQTT_RC_SHARED_SUBS_NOT_SUPPORTED
 = 158,

102 
	mMQTT_RC_CONNECTION_RATE_EXCEEDED
 = 159,

103 
	mMQTT_RC_MAXIMUM_CONNECT_TIME
 = 160,

104 
	mMQTT_RC_SUBSCRIPTION_IDS_NOT_SUPPORTED
 = 161,

105 
	mMQTT_RC_WILDCARD_SUBS_NOT_SUPPORTED
 = 162,

108 
	emqâ5_¥›îty
 {

109 
	mMQTT_PROP_PAYLOAD_FORMAT_INDICATOR
 = 1,

110 
	mMQTT_PROP_MESSAGE_EXPIRY_INTERVAL
 = 2,

111 
	mMQTT_PROP_CONTENT_TYPE
 = 3,

112 
	mMQTT_PROP_RESPONSE_TOPIC
 = 8,

113 
	mMQTT_PROP_CORRELATION_DATA
 = 9,

114 
	mMQTT_PROP_SUBSCRIPTION_IDENTIFIER
 = 11,

115 
	mMQTT_PROP_SESSION_EXPIRY_INTERVAL
 = 17,

116 
	mMQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
 = 18,

117 
	mMQTT_PROP_SERVER_KEEP_ALIVE
 = 19,

118 
	mMQTT_PROP_AUTHENTICATION_METHOD
 = 21,

119 
	mMQTT_PROP_AUTHENTICATION_DATA
 = 22,

120 
	mMQTT_PROP_REQUEST_PROBLEM_INFORMATION
 = 23,

121 
	mMQTT_PROP_WILL_DELAY_INTERVAL
 = 24,

122 
	mMQTT_PROP_REQUEST_RESPONSE_INFORMATION
 = 25,

123 
	mMQTT_PROP_RESPONSE_INFORMATION
 = 26,

124 
	mMQTT_PROP_SERVER_REFERENCE
 = 28,

125 
	mMQTT_PROP_REASON_STRING
 = 31,

126 
	mMQTT_PROP_RECEIVE_MAXIMUM
 = 33,

127 
	mMQTT_PROP_TOPIC_ALIAS_MAXIMUM
 = 34,

128 
	mMQTT_PROP_TOPIC_ALIAS
 = 35,

129 
	mMQTT_PROP_MAXIMUM_QOS
 = 36,

130 
	mMQTT_PROP_RETAIN_AVAILABLE
 = 37,

131 
	mMQTT_PROP_USER_PROPERTY
 = 38,

132 
	mMQTT_PROP_MAXIMUM_PACKET_SIZE
 = 39,

133 
	mMQTT_PROP_WILDCARD_SUB_AVAILABLE
 = 40,

134 
	mMQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
 = 41,

135 
	mMQTT_PROP_SHARED_SUB_AVAILABLE
 = 42,

138 
	emqâ5_¥›îty_ty≥
 {

139 
	mMQTT_PROP_TYPE_BYTE
 = 1,

140 
	mMQTT_PROP_TYPE_INT16
 = 2,

141 
	mMQTT_PROP_TYPE_INT32
 = 3,

142 
	mMQTT_PROP_TYPE_VARINT
 = 4,

143 
	mMQTT_PROP_TYPE_BINARY
 = 5,

144 
	mMQTT_PROP_TYPE_STRING
 = 6,

145 
	mMQTT_PROP_TYPE_STRING_PAIR
 = 7

148 
	emqâ5_sub_›ti⁄s
 {

149 
	mMQTT_SUB_OPT_NO_LOCAL
 = 0x04,

150 
	mMQTT_SUB_OPT_RETAIN_AS_PUBLISHED
 = 0x08,

151 
	mMQTT_SUB_OPT_SEND_RETAIN_ALWAYS
 = 0x00,

152 
	mMQTT_SUB_OPT_SEND_RETAIN_NEW
 = 0x10,

153 
	mMQTT_SUB_OPT_SEND_RETAIN_NEVER
 = 0x20,

156 
	#MQTT_MAX_PAYLOAD
 268435455

	)

	@lib/net_mosq.c

17 
	#_GNU_SOURCE


	)

18 
	~"c⁄fig.h
"

20 
	~<as£π.h
>

21 
	~<î∫o.h
>

22 
	~<f˙é.h
>

23 
	~<°dio.h
>

24 
	~<°rög.h
>

25 #i‚de‡
WIN32


26 
	#_GNU_SOURCE


	)

27 
	~<√tdb.h
>

28 
	~<sys/sockë.h
>

29 
	~<uni°d.h
>

31 
	~<wösock2.h
>

32 
	~<ws2t˝ù.h
>

35 #ifde‡
__ANDROID__


36 
	~<löux/ö.h
>

37 
	~<löux/ö6.h
>

38 
	~<sys/ídün.h
>

41 #ifde‡
HAVE_NETINET_IN_H


42 
	~<√töë/ö.h
>

45 #ifde‡
__QNX__


46 
	~<√t/√tbyã.h
>

49 #ifde‡
WITH_TLS


50 
	~<›ís¶/c⁄f.h
>

51 
	~<›ís¶/ígöe.h
>

52 
	~<›ís¶/îr.h
>

53 
	~<›ís¶/ui.h
>

54 
	~<és_mosq.h
>

57 #ifde‡
WITH_BROKER


58 
	~"mosquôto_brokî_öã∫Æ.h
"

59 #ifde‡
WITH_WEBSOCKETS


60 
	~<libwebsockës.h
>

63 
	~"ªad_h™dÀ.h
"

66 
	~"loggög_mosq.h
"

67 
	~"mem‹y_mosq.h
"

68 
	~"mqâ_¥Ÿocﬁ.h
"

69 
	~"√t_mosq.h
"

70 
	~"time_mosq.h
"

71 
	~"utû_mosq.h
"

73 #ifde‡
WITH_TLS


74 
	gés_ex_ödex_mosq
 = -1;

75 
UI_METHOD
 *
	g_ui_mëhod
 = 
NULL
;

78 
	$ui_›í
(
UI
 *
ui
)

80  
	`UI_mëhod_gë_›íî
(
	`UI_O≥nSSL
())(
ui
);

81 
	}
}

83 
	$ui_ªad
(
UI
 *
ui
, 
UI_STRING
 *
uis
)

85  
	`UI_mëhod_gë_ªadî
(
	`UI_O≥nSSL
())(
ui
, 
uis
);

86 
	}
}

88 
	$ui_wrôe
(
UI
 *
ui
, 
UI_STRING
 *
uis
)

90  
	`UI_mëhod_gë_wrôî
(
	`UI_O≥nSSL
())(
ui
, 
uis
);

91 
	}
}

93 
	$ui_˛o£
(
UI
 *
ui
)

95  
	`UI_mëhod_gë_˛o£r
(
	`UI_O≥nSSL
())(
ui
);

96 
	}
}

98 
	$£tup_ui_mëhod
()

100 
_ui_mëhod
 = 
	`UI_¸óã_mëhod
("OpenSSLápplication user interface");

101 
	`UI_mëhod_£t_›íî
(
_ui_mëhod
, 
ui_›í
);

102 
	`UI_mëhod_£t_ªadî
(
_ui_mëhod
, 
ui_ªad
);

103 
	`UI_mëhod_£t_wrôî
(
_ui_mëhod
, 
ui_wrôe
);

104 
	`UI_mëhod_£t_˛o£r
(
_ui_mëhod
, 
ui_˛o£
);

105 
	}
}

107 
	$˛ónup_ui_mëhod
()

109 if(
_ui_mëhod
){

110 
	`UI_de°roy_mëhod
(
_ui_mëhod
);

111 
_ui_mëhod
 = 
NULL
;

113 
	}
}

115 
UI_METHOD
 *
	$√t__gë_ui_mëhod
()

117  
_ui_mëhod
;

118 
	}
}

121 
	$√t__öô
()

123 #ifde‡
WIN32


124 
WSADATA
 
wßD©a
;

125 if(
	`WSASèπup
(
	`MAKEWORD
(2,2), &
wßD©a
) != 0){

126  
MOSQ_ERR_UNKNOWN
;

130 #ifde‡
WITH_SRV


131 
	`¨es_libøry_öô
(
ARES_LIB_INIT_ALL
);

134 #ifde‡
WITH_TLS


135 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

136 
	`SSL_lﬂd_îr‹_°rögs
();

137 
	`SSL_libøry_öô
();

138 
	`O≥nSSL_add_Æl_Æg‹ôhms
();

140 
	`OPENSSL_öô_¸y±o
(
OPENSSL_INIT_ADD_ALL_CIPHERS
 \

141 | 
OPENSSL_INIT_ADD_ALL_DIGESTS
 \

142 | 
OPENSSL_INIT_LOAD_CONFIG
, 
NULL
);

144 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

145 
	`ENGINE_lﬂd_buûtö_ígöes
();

147 
	`£tup_ui_mëhod
();

148 if(
és_ex_ödex_mosq
 == -1){

149 
és_ex_ödex_mosq
 = 
	`SSL_gë_ex_√w_ödex
(0, "˛õ¡ c⁄ãxt", 
NULL
, NULL, NULL);

152  
MOSQ_ERR_SUCCESS
;

153 
	}
}

155 
	$√t__˛ónup
()

157 #ifde‡
WITH_TLS


158 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

159 
	`CRYPTO_˛ónup_Æl_ex_d©a
();

160 
	`ERR_‰ì_°rögs
();

161 
	`ERR_ªmove_thªad_°©e
(
NULL
);

162 
	`EVP_˛ónup
();

164 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

165 
	`ENGINE_˛ónup
();

169 
	`CONF_moduÀs_u∆ﬂd
(1);

170 
	`˛ónup_ui_mëhod
();

173 #ifde‡
WITH_SRV


174 
	`¨es_libøry_˛ónup
();

177 #ifde‡
WIN32


178 
	`WSACÀ™up
();

180 
	}
}

187 #ifde‡
WITH_BROKER


188 
	$√t__sockë_˛o£
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

190 
	$√t__sockë_˛o£
(
mosquôto
 *
mosq
)

193 
rc
 = 0;

195 
	`as£π
(
mosq
);

196 #ifde‡
WITH_TLS


197 #ifde‡
WITH_WEBSOCKETS


198 if(!
mosq
->
wsi
)

201 if(
mosq
->
s¶
){

202 
	`SSL_shutdown
(
mosq
->
s¶
);

203 
	`SSL_‰ì
(
mosq
->
s¶
);

204 
mosq
->
s¶
 = 
NULL
;

209 #ifde‡
WITH_WEBSOCKETS


210 if(
mosq
->
wsi
)

212 if(
mosq
->
°©e
 !
mosq_cs_disc⁄√˘ög
){

213 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_disc⁄√˘_ws
);

215 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

219 if(
mosq
->
sock
 !
INVALID_SOCKET
){

220 #ifde‡
WITH_BROKER


221 
	`HASH_DELETE
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
mosq
);

223 
rc
 = 
	`COMPAT_CLOSE
(
mosq
->
sock
);

224 
mosq
->
sock
 = 
INVALID_SOCKET
;

228 #ifde‡
WITH_BROKER


229 if(
mosq
->
li°íî
){

230 
mosq
->
li°íî
->
˛õ¡_cou¡
--;

234  
rc
;

235 
	}
}

238 #ifde‡
FINAL_WITH_TLS_PSK


239 
	$psk_˛õ¡_ˇŒback
(
SSL
 *
s¶
, c⁄° *
höt
,

240 *
idítôy
, 
max_idítôy_Àn
,

241 *
psk
, 
max_psk_Àn
)

243 
mosquôto
 *
mosq
;

244 
Àn
;

246 
	`UNUSED
(
höt
);

248 
mosq
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_mosq
);

249 if(!
mosq
)  0;

251 
	`¢¥ötf
(
idítôy
, 
max_idítôy_Àn
, "%s", 
mosq
->
és_psk_idítôy
);

253 
Àn
 = 
	`mosquôto__hex2bö
(
mosq
->
és_psk
, 
psk
, 
max_psk_Àn
);

254 i‡(
Àn
 < 0)  0;

255  
Àn
;

256 
	}
}

259 #i‡
deföed
(
WITH_BROKER
Ë&& deföed(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

261 
	$√t__åy_c⁄√˘_°ï1
(
mosquôto
 *
mosq
, c⁄° *
ho°
)

263 
s
;

264 *
£vp
 = 
NULL
;

265 
addröfo
 *
höts
;

267 if(
mosq
->
adns
){

268 
	`gai_ˇn˚l
(
mosq
->
adns
);

269 
	`mosquôto__‰ì
((
addröfo
 *)
mosq
->
adns
->
¨_ªque°
);

270 
	`mosquôto__‰ì
(
mosq
->
adns
);

272 
mosq
->
adns
 = 
	`mosquôto__ˇŒoc
(1, (
gaicb
));

273 if(!
mosq
->
adns
){

274  
MOSQ_ERR_NOMEM
;

277 
höts
 = 
	`mosquôto__ˇŒoc
(1, (
addröfo
));

278 if(!
höts
){

279 
	`mosquôto__‰ì
(
mosq
->
adns
);

280 
mosq
->
adns
 = 
NULL
;

281  
MOSQ_ERR_NOMEM
;

284 
höts
->
ai_Ámûy
 = 
AF_UNSPEC
;

285 
höts
->
ai_sockty≥
 = 
SOCK_STREAM
;

287 
mosq
->
adns
->
¨_«me
 = 
ho°
;

288 
mosq
->
adns
->
¨_ªque°
 = 
höts
;

290 
s
 = 
	`gëaddröfo_a
(
GAI_NOWAIT
, &
mosq
->
adns
, 1, 
£vp
);

291 if(
s
){

292 
î∫o
 = 
s
;

293 if(
mosq
->
adns
){

294 
	`mosquôto__‰ì
((
addröfo
 *)
mosq
->
adns
->
¨_ªque°
);

295 
	`mosquôto__‰ì
(
mosq
->
adns
);

296 
mosq
->
adns
 = 
NULL
;

298  
MOSQ_ERR_EAI
;

301  
MOSQ_ERR_SUCCESS
;

302 
	}
}

305 
	$√t__åy_c⁄√˘_°ï2
(
mosquôto
 *
mosq
, 
uöt16_t
 
p‹t
, 
mosq_sock_t
 *
sock
)

307 
addröfo
 *
aöfo
, *
Ω
;

308 
rc
;

310 
aöfo
 = 
mosq
->
adns
->
¨_ªsu…
;

312 
Ω
 = 
aöfo
;Ñ∞!
NULL
;Ñ∞Ω->
ai_√xt
){

313 *
sock
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

314 if(*
sock
 =
INVALID_SOCKET
) ;

316 if(
Ω
->
ai_Ámûy
 =
AF_INET
){

317 ((
sockaddr_ö
 *)
Ω
->
ai_addr
)->
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

318 }if(
Ω
->
ai_Ámûy
 =
AF_INET6
){

319 ((
sockaddr_ö6
 *)
Ω
->
ai_addr
)->
sö6_p‹t
 = 
	`ht⁄s
(
p‹t
);

321 
	`COMPAT_CLOSE
(*
sock
);

322 *
sock
 = 
INVALID_SOCKET
;

327 if(
	`√t__sockë_n⁄block
(
sock
)){

331 
rc
 = 
	`c⁄√˘
(*
sock
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
);

332 #ifde‡
WIN32


333 
î∫o
 = 
	`WSAGëLa°Eº‹
();

335 if(
rc
 =0 || 
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

336 if(
rc
 < 0 && (
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
)){

337 
rc
 = 
MOSQ_ERR_CONN_PENDING
;

341 if(
	`√t__sockë_n⁄block
(
sock
)){

347 
	`COMPAT_CLOSE
(*
sock
);

348 *
sock
 = 
INVALID_SOCKET
;

350 
	`‰ìaddröfo
(
mosq
->
adns
->
¨_ªsu…
);

351 
mosq
->
adns
->
¨_ªsu…
 = 
NULL
;

353 
	`mosquôto__‰ì
((
addröfo
 *)
mosq
->
adns
->
¨_ªque°
);

354 
	`mosquôto__‰ì
(
mosq
->
adns
);

355 
mosq
->
adns
 = 
NULL
;

357 if(!
Ω
){

358  
MOSQ_ERR_ERRNO
;

361  
rc
;

362 
	}
}

367 
	$√t__åy_c⁄√˘
(c⁄° *
ho°
, 
uöt16_t
 
p‹t
, 
mosq_sock_t
 *
sock
, c⁄° *
böd_addªss
, 
boﬁ
 
blockög
)

369 
addröfo
 
höts
;

370 
addröfo
 *
aöfo
, *
Ω
;

371 
addröfo
 *
aöfo_böd
, *
Ω_böd
;

372 
s
;

373 
rc
 = 
MOSQ_ERR_SUCCESS
;

374 #ifde‡
WIN32


375 
uöt32_t
 
vÆ
 = 1;

378 *
sock
 = 
INVALID_SOCKET
;

379 
	`mem£t
(&
höts
, 0, (
addröfo
));

380 
höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

381 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

383 
s
 = 
	`gëaddröfo
(
ho°
, 
NULL
, &
höts
, &
aöfo
);

384 if(
s
){

385 
î∫o
 = 
s
;

386  
MOSQ_ERR_EAI
;

389 if(
böd_addªss
){

390 
s
 = 
	`gëaddröfo
(
böd_addªss
, 
NULL
, &
höts
, &
aöfo_böd
);

391 if(
s
){

392 
	`‰ìaddröfo
(
aöfo
);

393 
î∫o
 = 
s
;

394  
MOSQ_ERR_EAI
;

398 
Ω
 = 
aöfo
;Ñ∞!
NULL
;Ñ∞Ω->
ai_√xt
){

399 *
sock
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

400 if(*
sock
 =
INVALID_SOCKET
) ;

402 if(
Ω
->
ai_Ámûy
 =
AF_INET
){

403 ((
sockaddr_ö
 *)
Ω
->
ai_addr
)->
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

404 }if(
Ω
->
ai_Ámûy
 =
AF_INET6
){

405 ((
sockaddr_ö6
 *)
Ω
->
ai_addr
)->
sö6_p‹t
 = 
	`ht⁄s
(
p‹t
);

407 
	`COMPAT_CLOSE
(*
sock
);

408 *
sock
 = 
INVALID_SOCKET
;

412 if(
böd_addªss
){

413 
Ω_böd
 = 
aöfo_böd
;Ñp_böd !
NULL
;Ñp_böd =Ñp_böd->
ai_√xt
){

414 if(
	`böd
(*
sock
, 
Ω_böd
->
ai_addr
,Ñp_böd->
ai_addæí
) == 0){

418 if(!
Ω_böd
){

419 
	`COMPAT_CLOSE
(*
sock
);

420 *
sock
 = 
INVALID_SOCKET
;

425 if(!
blockög
){

427 if(
	`√t__sockë_n⁄block
(
sock
)){

432 
rc
 = 
	`c⁄√˘
(*
sock
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
);

433 #ifde‡
WIN32


434 
î∫o
 = 
	`WSAGëLa°Eº‹
();

436 if(
rc
 =0 || 
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

437 if(
rc
 < 0 && (
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
)){

438 
rc
 = 
MOSQ_ERR_CONN_PENDING
;

441 if(
blockög
){

443 if(
	`√t__sockë_n⁄block
(
sock
)){

450 
	`COMPAT_CLOSE
(*
sock
);

451 *
sock
 = 
INVALID_SOCKET
;

453 
	`‰ìaddröfo
(
aöfo
);

454 if(
böd_addªss
){

455 
	`‰ìaddröfo
(
aöfo_böd
);

457 if(!
Ω
){

458  
MOSQ_ERR_ERRNO
;

460  
rc
;

461 
	}
}

464 #ifde‡
WITH_TLS


465 
	$√t__¥öt_s¶_îr‹
(
mosquôto
 *
mosq
)

467 
ebuf
[256];

468 
e
;

470 
e
 = 
	`ERR_gë_îr‹
();

471 
e
){

472 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "O≥nSSL Eº‹: %s", 
	`ERR_îr‹_°rög
(
e
, 
ebuf
));

473 
e
 = 
	`ERR_gë_îr‹
();

475 
	}
}

478 
	$√t__sockë_c⁄√˘_és
(
mosquôto
 *
mosq
)

480 
ªt
, 
îr
;

482 
	`ERR_˛ór_îr‹
();

483 
ªs
;

484 i‡(
mosq
->
és_oc•_ªquúed
) {

486 i‡((
ªs
=
	`SSL_£t_é£xt_°©us_ty≥
(
mosq
->
s¶
, 
TLSEXT_STATUSTYPE_oc•
)) != 1) {

487 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "CouldÇŸá˘iv©êOCSP (îr‹: %ld)", 
ªs
);

488  
MOSQ_ERR_OCSP
;

490 i‡((
ªs
=
	`SSL_CTX_£t_é£xt_°©us_cb
(
mosq
->
s¶_˘x
, 
mosquôto__vîify_oc•_°©us_cb
)) != 1) {

491 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "CouldÇŸá˘iv©êOCSP (îr‹: %ld)", 
ªs
);

492  
MOSQ_ERR_OCSP
;

494 i‡((
ªs
=
	`SSL_CTX_£t_é£xt_°©us_¨g
(
mosq
->
s¶_˘x
, mosq)) != 1) {

495 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "CouldÇŸá˘iv©êOCSP (îr‹: %ld)", 
ªs
);

496  
MOSQ_ERR_OCSP
;

500 
ªt
 = 
	`SSL_c⁄√˘
(
mosq
->
s¶
);

501 if(
ªt
 != 1) {

502 
îr
 = 
	`SSL_gë_îr‹
(
mosq
->
s¶
, 
ªt
);

503 i‡(
îr
 =
SSL_ERROR_SYSCALL
) {

504 
mosq
->
w™t_c⁄√˘
 = 
åue
;

505  
MOSQ_ERR_SUCCESS
;

507 if(
îr
 =
SSL_ERROR_WANT_READ
){

508 
mosq
->
w™t_c⁄√˘
 = 
åue
;

510 }if(
îr
 =
SSL_ERROR_WANT_WRITE
){

511 
mosq
->
w™t_wrôe
 = 
åue
;

512 
mosq
->
w™t_c⁄√˘
 = 
åue
;

514 
	`√t__¥öt_s¶_îr‹
(
mosq
);

516 
	`COMPAT_CLOSE
(
mosq
->
sock
);

517 
mosq
->
sock
 = 
INVALID_SOCKET
;

518 
	`√t__¥öt_s¶_îr‹
(
mosq
);

519  
MOSQ_ERR_TLS
;

522 
mosq
->
w™t_c⁄√˘
 = 
Ál£
;

524  
MOSQ_ERR_SUCCESS
;

525 
	}
}

529 #ifde‡
WITH_TLS


530 
	$√t__öô_s¶_˘x
(
mosquôto
 *
mosq
)

532 
ªt
;

533 
ENGINE
 *
ígöe
 = 
NULL
;

534 
uöt8_t
 
és_Æ≤_wúe
[256];

535 
uöt8_t
 
és_Æ≤_Àn
;

537 if(
mosq
->
s¶_˘x
){

538 if(!
mosq
->
s¶_˘x_deÁu…s
){

539  
MOSQ_ERR_SUCCESS
;

540 }if(!
mosq
->
és_ˇfûe
 && !mosq->
és_ˇ∑th
 && !mosq->
és_psk
){

541 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: MOSQ_OPT_SSL_CTX_WITH_DEFAULTS used without specifying cafile, capath orÖsk.");

542  
MOSQ_ERR_INVAL
;

549 if(
mosq
->
és_ˇfûe
 || mosq->
és_ˇ∑th
 || mosq->
és_psk
){

550 if(!
mosq
->
s¶_˘x
){

551 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

552 
mosq
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`SSLv23_˛õ¡_mëhod
());

554 
mosq
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`TLS_˛õ¡_mëhod
());

557 if(!
mosq
->
s¶_˘x
){

558 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: UnableÅo create TLS context.");

559 
	`COMPAT_CLOSE
(
mosq
->
sock
);

560 
mosq
->
sock
 = 
INVALID_SOCKET
;

561 
	`√t__¥öt_s¶_îr‹
(
mosq
);

562  
MOSQ_ERR_TLS
;

566 if(!
mosq
->
és_vîsi⁄
){

567 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
);

568 #ifde‡
SSL_OP_NO_TLSv1_3


569 }if(!
	`°rcmp
(
mosq
->
és_vîsi⁄
, "tlsv1.3")){

570 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
 | 
SSL_OP_NO_TLSv1_2
);

571 }if(!
	`°rcmp
(
mosq
->
és_vîsi⁄
, "tlsv1.2")){

572 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
 | 
SSL_OP_NO_TLSv1_3
);

573 }if(!
	`°rcmp
(
mosq
->
és_vîsi⁄
, "tlsv1.1")){

574 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_2
 | 
SSL_OP_NO_TLSv1_3
);

576 }if(!
	`°rcmp
(
mosq
->
és_vîsi⁄
, "tlsv1.2")){

577 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
);

578 }if(!
	`°rcmp
(
mosq
->
és_vîsi⁄
, "tlsv1.1")){

579 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_2
);

582 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: PrŸocﬁ %†nŸ suµ‹ãd.", mosq->
és_vîsi⁄
);

583 
	`COMPAT_CLOSE
(
mosq
->
sock
);

584 
mosq
->
sock
 = 
INVALID_SOCKET
;

585  
MOSQ_ERR_INVAL
;

589 
	`SSL_CTX_£t_›ti⁄s
(
mosq
->
s¶_˘x
, 
SSL_OP_NO_COMPRESSION
);

592 if(
mosq
->
és_Æ≤
) {

593 
és_Æ≤_Àn
 = (
uöt8_t
Ë
	`°∫Àn
(
mosq
->
és_Æ≤
, 254);

594 
és_Æ≤_wúe
[0] = 
és_Æ≤_Àn
;

595 
	`mem˝y
(
és_Æ≤_wúe
 + 1, 
mosq
->
és_Æ≤
, 
és_Æ≤_Àn
);

596 
	`SSL_CTX_£t_Æ≤_¥Ÿos
(
mosq
->
s¶_˘x
, 
és_Æ≤_wúe
, 
és_Æ≤_Àn
 + 1);

599 #ifde‡
SSL_MODE_RELEASE_BUFFERS


601 
	`SSL_CTX_£t_mode
(
mosq
->
s¶_˘x
, 
SSL_MODE_RELEASE_BUFFERS
);

604 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

605 if(
mosq
->
és_ígöe
){

606 
ígöe
 = 
	`ENGINE_by_id
(
mosq
->
és_ígöe
);

607 if(!
ígöe
){

608 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹Üﬂdög %†ígöe\n", mosq->
és_ígöe
);

609 
	`COMPAT_CLOSE
(
mosq
->
sock
);

610 
mosq
->
sock
 = 
INVALID_SOCKET
;

611  
MOSQ_ERR_TLS
;

613 if(!
	`ENGINE_öô
(
ígöe
)){

614 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "FailedÉngine initialisation\n");

615 
	`ENGINE_‰ì
(
ígöe
);

616 
	`COMPAT_CLOSE
(
mosq
->
sock
);

617 
mosq
->
sock
 = 
INVALID_SOCKET
;

618  
MOSQ_ERR_TLS
;

620 
	`ENGINE_£t_deÁu…
(
ígöe
, 
ENGINE_METHOD_ALL
);

621 
	`ENGINE_‰ì
(
ígöe
);

625 if(
mosq
->
és_cùhîs
){

626 
ªt
 = 
	`SSL_CTX_£t_cùhî_li°
(
mosq
->
s¶_˘x
, mosq->
és_cùhîs
);

627 if(
ªt
 == 0){

628 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ£àTLS cùhîs. Check cùhîÜi° \"%s\".", mosq->
és_cùhîs
);

629 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

630 
	`ENGINE_FINISH
(
ígöe
);

632 
	`COMPAT_CLOSE
(
mosq
->
sock
);

633 
mosq
->
sock
 = 
INVALID_SOCKET
;

634 
	`√t__¥öt_s¶_îr‹
(
mosq
);

635  
MOSQ_ERR_TLS
;

638 if(
mosq
->
és_ˇfûe
 || mosq->
és_ˇ∑th
){

639 
ªt
 = 
	`SSL_CTX_lﬂd_vîify_loˇti⁄s
(
mosq
->
s¶_˘x
, mosq->
és_ˇfûe
, mosq->
és_ˇ∑th
);

640 if(
ªt
 == 0){

641 #ifde‡
WITH_BROKER


642 if(
mosq
->
és_ˇfûe
 && mosq->
és_ˇ∑th
){

643 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check bridge_ˇfûê\"%s\"ánd bridge_ˇ∑th \"%s\".", mosq->
és_ˇfûe
, mosq->
és_ˇ∑th
);

644 }if(
mosq
->
és_ˇfûe
){

645 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check bridge_ˇfûê\"%s\".", mosq->
és_ˇfûe
);

647 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check bridge_ˇ∑th \"%s\".", mosq->
és_ˇ∑th
);

650 if(
mosq
->
és_ˇfûe
 && mosq->
és_ˇ∑th
){

651 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check cafûê\"%s\"ánd c≠©h \"%s\".", mosq->
és_ˇfûe
, mosq->
és_ˇ∑th
);

652 }if(
mosq
->
és_ˇfûe
){

653 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check cafûê\"%s\".", mosq->
és_ˇfûe
);

655 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs, check c≠©h \"%s\".", mosq->
és_ˇ∑th
);

658 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

659 
	`ENGINE_FINISH
(
ígöe
);

661 
	`COMPAT_CLOSE
(
mosq
->
sock
);

662 
mosq
->
sock
 = 
INVALID_SOCKET
;

663 
	`√t__¥öt_s¶_îr‹
(
mosq
);

664  
MOSQ_ERR_TLS
;

666 if(
mosq
->
és_˚π_ªqs
 == 0){

667 
	`SSL_CTX_£t_vîify
(
mosq
->
s¶_˘x
, 
SSL_VERIFY_NONE
, 
NULL
);

669 
	`SSL_CTX_£t_vîify
(
mosq
->
s¶_˘x
, 
SSL_VERIFY_PEER
, 
mosquôto__£rvî_˚πifiˇã_vîify
);

672 if(
mosq
->
és_pw_ˇŒback
){

673 
	`SSL_CTX_£t_deÁu…_∑sswd_cb
(
mosq
->
s¶_˘x
, mosq->
és_pw_ˇŒback
);

674 
	`SSL_CTX_£t_deÁu…_∑sswd_cb_u£rd©a
(
mosq
->
s¶_˘x
, mosq);

677 if(
mosq
->
és_˚πfûe
){

678 
ªt
 = 
	`SSL_CTX_u£_˚πifiˇã_chaö_fûe
(
mosq
->
s¶_˘x
, mosq->
és_˚πfûe
);

679 if(
ªt
 != 1){

680 #ifde‡
WITH_BROKER


681 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd clõ¡ cîtifiˇã, check bridge_˚πfûê\"%s\".", mosq->
és_˚πfûe
);

683 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd clõ¡ cîtifiˇã \"%s\".", mosq->
és_˚πfûe
);

685 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

686 
	`ENGINE_FINISH
(
ígöe
);

688 
	`COMPAT_CLOSE
(
mosq
->
sock
);

689 
mosq
->
sock
 = 
INVALID_SOCKET
;

690 
	`√t__¥öt_s¶_îr‹
(
mosq
);

691  
MOSQ_ERR_TLS
;

694 if(
mosq
->
és_keyfûe
){

695 if(
mosq
->
és_keyf‹m
 =
mosq_k_ígöe
){

696 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

697 
UI_METHOD
 *
ui_mëhod
 = 
	`√t__gë_ui_mëhod
();

698 if(
mosq
->
és_ígöe_k∑ss_sha1
){

699 if(!
	`ENGINE_˘æ_cmd
(
ígöe
, 
ENGINE_SECRET_MODE
, 
ENGINE_SECRET_MODE_SHA
, 
NULL
, NULL, 0)){

700 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: UnableÅo setÉngine secret mode sha1");

701 
	`ENGINE_FINISH
(
ígöe
);

702 
	`COMPAT_CLOSE
(
mosq
->
sock
);

703 
mosq
->
sock
 = 
INVALID_SOCKET
;

704 
	`√t__¥öt_s¶_îr‹
(
mosq
);

705  
MOSQ_ERR_TLS
;

707 if(!
	`ENGINE_˘æ_cmd
(
ígöe
, 
ENGINE_PIN
, 0, 
mosq
->
és_ígöe_k∑ss_sha1
, 
NULL
, 0)){

708 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: UnableÅo setÉngineÖin");

709 
	`ENGINE_FINISH
(
ígöe
);

710 
	`COMPAT_CLOSE
(
mosq
->
sock
);

711 
mosq
->
sock
 = 
INVALID_SOCKET
;

712 
	`√t__¥öt_s¶_îr‹
(
mosq
);

713  
MOSQ_ERR_TLS
;

715 
ui_mëhod
 = 
NULL
;

717 
EVP_PKEY
 *
pkey
 = 
	`ENGINE_lﬂd_¥iv©e_key
(
ígöe
, 
mosq
->
és_keyfûe
, 
ui_mëhod
, 
NULL
);

718 if(!
pkey
){

719 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂdÉngöê¥iv©êkey fûê\"%s\".", mosq->
és_keyfûe
);

720 
	`ENGINE_FINISH
(
ígöe
);

721 
	`COMPAT_CLOSE
(
mosq
->
sock
);

722 
mosq
->
sock
 = 
INVALID_SOCKET
;

723 
	`√t__¥öt_s¶_îr‹
(
mosq
);

724  
MOSQ_ERR_TLS
;

726 if(
	`SSL_CTX_u£_Priv©eKey
(
mosq
->
s¶_˘x
, 
pkey
) <= 0){

727 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿu£Éngöê¥iv©êkey fûê\"%s\".", mosq->
és_keyfûe
);

728 
	`ENGINE_FINISH
(
ígöe
);

729 
	`COMPAT_CLOSE
(
mosq
->
sock
);

730 
mosq
->
sock
 = 
INVALID_SOCKET
;

731 
	`√t__¥öt_s¶_îr‹
(
mosq
);

732  
MOSQ_ERR_TLS
;

736 
ªt
 = 
	`SSL_CTX_u£_Priv©eKey_fûe
(
mosq
->
s¶_˘x
, mosq->
és_keyfûe
, 
SSL_FILETYPE_PEM
);

737 if(
ªt
 != 1){

738 #ifde‡
WITH_BROKER


739 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd clõ¡ key fûe, check bridge_keyfûê\"%s\".", mosq->
és_keyfûe
);

741 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd clõ¡ key fûê\"%s\".", mosq->
és_keyfûe
);

743 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

744 
	`ENGINE_FINISH
(
ígöe
);

746 
	`COMPAT_CLOSE
(
mosq
->
sock
);

747 
mosq
->
sock
 = 
INVALID_SOCKET
;

748 
	`√t__¥öt_s¶_îr‹
(
mosq
);

749  
MOSQ_ERR_TLS
;

752 
ªt
 = 
	`SSL_CTX_check_¥iv©e_key
(
mosq
->
s¶_˘x
);

753 if(
ªt
 != 1){

754 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: Client certificate/keyáre inconsistent.");

755 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

756 
	`ENGINE_FINISH
(
ígöe
);

758 
	`COMPAT_CLOSE
(
mosq
->
sock
);

759 
mosq
->
sock
 = 
INVALID_SOCKET
;

760 
	`√t__¥öt_s¶_îr‹
(
mosq
);

761  
MOSQ_ERR_TLS
;

764 #ifde‡
FINAL_WITH_TLS_PSK


765 }if(
mosq
->
és_psk
){

766 
	`SSL_CTX_£t_psk_˛õ¡_ˇŒback
(
mosq
->
s¶_˘x
, 
psk_˛õ¡_ˇŒback
);

771  
MOSQ_ERR_SUCCESS
;

772 
	}
}

776 
	$√t__sockë_c⁄√˘_°ï3
(
mosquôto
 *
mosq
, c⁄° *
ho°
)

778 #ifde‡
WITH_TLS


779 
BIO
 *
bio
;

781 
rc
 = 
	`√t__öô_s¶_˘x
(
mosq
);

782 if(
rc
) Ñc;

784 if(
mosq
->
s¶_˘x
){

785 if(
mosq
->
s¶
){

786 
	`SSL_‰ì
(
mosq
->
s¶
);

788 
mosq
->
s¶
 = 
	`SSL_√w
(mosq->
s¶_˘x
);

789 if(!
mosq
->
s¶
){

790 
	`COMPAT_CLOSE
(
mosq
->
sock
);

791 
mosq
->
sock
 = 
INVALID_SOCKET
;

792 
	`√t__¥öt_s¶_îr‹
(
mosq
);

793  
MOSQ_ERR_TLS
;

796 
	`SSL_£t_ex_d©a
(
mosq
->
s¶
, 
és_ex_ödex_mosq
, mosq);

797 
bio
 = 
	`BIO_√w_sockë
(
mosq
->
sock
, 
BIO_NOCLOSE
);

798 if(!
bio
){

799 
	`COMPAT_CLOSE
(
mosq
->
sock
);

800 
mosq
->
sock
 = 
INVALID_SOCKET
;

801 
	`√t__¥öt_s¶_îr‹
(
mosq
);

802  
MOSQ_ERR_TLS
;

804 
	`SSL_£t_bio
(
mosq
->
s¶
, 
bio
, bio);

809 if(
	`SSL_£t_é£xt_ho°_«me
(
mosq
->
s¶
, 
ho°
) != 1) {

810 
	`COMPAT_CLOSE
(
mosq
->
sock
);

811 
mosq
->
sock
 = 
INVALID_SOCKET
;

812  
MOSQ_ERR_TLS
;

815 if(
	`√t__sockë_c⁄√˘_és
(
mosq
)){

816  
MOSQ_ERR_TLS
;

821  
MOSQ_ERR_SUCCESS
;

822 
	}
}

825 
	$√t__sockë_c⁄√˘
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
uöt16_t
 
p‹t
, c⁄° *
böd_addªss
, 
boﬁ
 
blockög
)

827 
mosq_sock_t
 
sock
 = 
INVALID_SOCKET
;

828 
rc
, 
rc2
;

830 if(!
mosq
 || !
ho°
 || !
p‹t
Ë 
MOSQ_ERR_INVAL
;

832 
rc
 = 
	`√t__åy_c⁄√˘
(
ho°
, 
p‹t
, &
sock
, 
böd_addªss
, 
blockög
);

833 if(
rc
 > 0) Ñc;

835 
mosq
->
sock
 = sock;

837 #i‡
	`deföed
(
WITH_SOCKS
Ë&& !deföed(
WITH_BROKER
)

838 if(!
mosq
->
socks5_ho°
)

841 
rc2
 = 
	`√t__sockë_c⁄√˘_°ï3
(
mosq
, 
ho°
);

842 if(
rc2
) Ñc2;

845  
MOSQ_ERR_SUCCESS
;

846 
	}
}

849 
ssize_t
 
	$√t__ªad
(
mosquôto
 *
mosq
, *
buf
, 
size_t
 
cou¡
)

851 #ifde‡
WITH_TLS


852 
ªt
;

853 
îr
;

855 
	`as£π
(
mosq
);

856 
î∫o
 = 0;

857 #ifde‡
WITH_TLS


858 if(
mosq
->
s¶
){

859 
	`ERR_˛ór_îr‹
();

860 
ªt
 = 
	`SSL_ªad
(
mosq
->
s¶
, 
buf
, 
cou¡
);

861 if(
ªt
 <= 0){

862 
îr
 = 
	`SSL_gë_îr‹
(
mosq
->
s¶
, 
ªt
);

863 if(
îr
 =
SSL_ERROR_WANT_READ
){

864 
ªt
 = -1;

865 
î∫o
 = 
EAGAIN
;

866 }if(
îr
 =
SSL_ERROR_WANT_WRITE
){

867 
ªt
 = -1;

868 
mosq
->
w™t_wrôe
 = 
åue
;

869 
î∫o
 = 
EAGAIN
;

871 
	`√t__¥öt_s¶_îr‹
(
mosq
);

872 
î∫o
 = 
EPROTO
;

874 #ifde‡
WIN32


875 
	`WSASëLa°Eº‹
(
î∫o
);

878  (
ssize_t
 )
ªt
;

884 #i‚de‡
WIN32


885  
	`ªad
(
mosq
->
sock
, 
buf
, 
cou¡
);

887  
	`ªcv
(
mosq
->
sock
, 
buf
, 
cou¡
, 0);

890 #ifde‡
WITH_TLS


893 
	}
}

895 
ssize_t
 
	$√t__wrôe
(
mosquôto
 *
mosq
, *
buf
, 
size_t
 
cou¡
)

897 #ifde‡
WITH_TLS


898 
ªt
;

899 
îr
;

901 
	`as£π
(
mosq
);

903 
î∫o
 = 0;

904 #ifde‡
WITH_TLS


905 if(
mosq
->
s¶
){

906 
mosq
->
w™t_wrôe
 = 
Ál£
;

907 
	`ERR_˛ór_îr‹
();

908 
ªt
 = 
	`SSL_wrôe
(
mosq
->
s¶
, 
buf
, 
cou¡
);

909 if(
ªt
 < 0){

910 
îr
 = 
	`SSL_gë_îr‹
(
mosq
->
s¶
, 
ªt
);

911 if(
îr
 =
SSL_ERROR_WANT_READ
){

912 
ªt
 = -1;

913 
î∫o
 = 
EAGAIN
;

914 }if(
îr
 =
SSL_ERROR_WANT_WRITE
){

915 
ªt
 = -1;

916 
mosq
->
w™t_wrôe
 = 
åue
;

917 
î∫o
 = 
EAGAIN
;

919 
	`√t__¥öt_s¶_îr‹
(
mosq
);

920 
î∫o
 = 
EPROTO
;

922 #ifde‡
WIN32


923 
	`WSASëLa°Eº‹
(
î∫o
);

926  (
ssize_t
 )
ªt
;

931 #i‚de‡
WIN32


932  
	`wrôe
(
mosq
->
sock
, 
buf
, 
cou¡
);

934  
	`£nd
(
mosq
->
sock
, 
buf
, 
cou¡
, 0);

937 #ifde‡
WITH_TLS


940 
	}
}

943 
	$√t__sockë_n⁄block
(
mosq_sock_t
 *
sock
)

945 #i‚de‡
WIN32


946 
›t
;

948 
›t
 = 
	`f˙é
(*
sock
, 
F_GETFL
, 0);

949 if(
›t
 == -1){

950 
	`COMPAT_CLOSE
(*
sock
);

951 *
sock
 = 
INVALID_SOCKET
;

952  
MOSQ_ERR_ERRNO
;

954 if(
	`f˙é
(*
sock
, 
F_SETFL
, 
›t
 | 
O_NONBLOCK
) == -1){

956 
	`COMPAT_CLOSE
(*
sock
);

957 *
sock
 = 
INVALID_SOCKET
;

958  
MOSQ_ERR_ERRNO
;

961 
›t
 = 1;

962 if(
	`io˘lsockë
(*
sock
, 
FIONBIO
, &
›t
)){

963 
	`COMPAT_CLOSE
(*
sock
);

964 *
sock
 = 
INVALID_SOCKET
;

965  
MOSQ_ERR_ERRNO
;

968  
MOSQ_ERR_SUCCESS
;

969 
	}
}

972 #i‚de‡
WITH_BROKER


973 
	$√t__sockë∑ú
(
mosq_sock_t
 *
∑úR
, mosq_sock_à*
∑úW
)

975 #ifde‡
WIN32


976 
Ámûy
[2] = {
AF_INET
, 
AF_INET6
};

977 
i
;

978 
sockaddr_°‹age
 
ss
;

979 
sockaddr_ö
 *
ß
 = (sockaddr_ö *)&
ss
;

980 
sockaddr_ö6
 *
ß6
 = (sockaddr_ö6 *)&
ss
;

981 
sockÀn_t
 
ss_Àn
;

982 
mosq_sock_t
 
•R
, 
•W
;

984 
mosq_sock_t
 
li°ísock
;

986 *
∑úR
 = 
INVALID_SOCKET
;

987 *
∑úW
 = 
INVALID_SOCKET
;

989 
i
=0; i<2; i++){

990 
	`mem£t
(&
ss
, 0, (ss));

991 if(
Ámûy
[
i
] =
AF_INET
){

992 
ß
->
sö_Ámûy
 = 
Ámûy
[
i
];

993 
ß
->
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
);

994 
ß
->
sö_p‹t
 = 0;

995 
ss_Àn
 = (
sockaddr_ö
);

996 }if(
Ámûy
[
i
] =
AF_INET6
){

997 
ß6
->
sö6_Ámûy
 = 
Ámûy
[
i
];

998 
ß6
->
sö6_addr
 = 
ö6addr_lo›back
;

999 
ß6
->
sö6_p‹t
 = 0;

1000 
ss_Àn
 = (
sockaddr_ö6
);

1002  
MOSQ_ERR_INVAL
;

1005 
li°ísock
 = 
	`sockë
(
Ámûy
[
i
], 
SOCK_STREAM
, 
IPPROTO_TCP
);

1006 if(
li°ísock
 == -1){

1010 if(
	`böd
(
li°ísock
, (
sockaddr
 *)&
ss
, 
ss_Àn
) == -1){

1011 
	`COMPAT_CLOSE
(
li°ísock
);

1015 if(
	`li°í
(
li°ísock
, 1) == -1){

1016 
	`COMPAT_CLOSE
(
li°ísock
);

1019 
	`mem£t
(&
ss
, 0, (ss));

1020 
ss_Àn
 = (
ss
);

1021 if(
	`gësock«me
(
li°ísock
, (
sockaddr
 *)&
ss
, &
ss_Àn
) < 0){

1022 
	`COMPAT_CLOSE
(
li°ísock
);

1026 if(
Ámûy
[
i
] =
AF_INET
){

1027 
ß
->
sö_Ámûy
 = 
Ámûy
[
i
];

1028 
ß
->
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
);

1029 
ss_Àn
 = (
sockaddr_ö
);

1030 }if(
Ámûy
[
i
] =
AF_INET6
){

1031 
ß6
->
sö6_Ámûy
 = 
Ámûy
[
i
];

1032 
ß6
->
sö6_addr
 = 
ö6addr_lo›back
;

1033 
ss_Àn
 = (
sockaddr_ö6
);

1036 
•R
 = 
	`sockë
(
Ámûy
[
i
], 
SOCK_STREAM
, 
IPPROTO_TCP
);

1037 if(
•R
 == -1){

1038 
	`COMPAT_CLOSE
(
li°ísock
);

1041 if(
	`√t__sockë_n⁄block
(&
•R
)){

1042 
	`COMPAT_CLOSE
(
li°ísock
);

1045 if(
	`c⁄√˘
(
•R
, (
sockaddr
 *)&
ss
, 
ss_Àn
) < 0){

1046 #ifde‡
WIN32


1047 
î∫o
 = 
	`WSAGëLa°Eº‹
();

1049 if(
î∫o
 !
EINPROGRESS
 &&Éºnÿ!
COMPAT_EWOULDBLOCK
){

1050 
	`COMPAT_CLOSE
(
•R
);

1051 
	`COMPAT_CLOSE
(
li°ísock
);

1055 
•W
 = 
	`ac˚±
(
li°ísock
, 
NULL
, 0);

1056 if(
•W
 == -1){

1057 #ifde‡
WIN32


1058 
î∫o
 = 
	`WSAGëLa°Eº‹
();

1060 if(
î∫o
 !
EINPROGRESS
 &&Éºnÿ!
COMPAT_EWOULDBLOCK
){

1061 
	`COMPAT_CLOSE
(
•R
);

1062 
	`COMPAT_CLOSE
(
li°ísock
);

1067 if(
	`√t__sockë_n⁄block
(&
•W
)){

1068 
	`COMPAT_CLOSE
(
•R
);

1069 
	`COMPAT_CLOSE
(
li°ísock
);

1072 
	`COMPAT_CLOSE
(
li°ísock
);

1074 *
∑úR
 = 
•R
;

1075 *
∑úW
 = 
•W
;

1076  
MOSQ_ERR_SUCCESS
;

1078  
MOSQ_ERR_UNKNOWN
;

1080 
sv
[2];

1082 if(
	`sockë∑ú
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
sv
) == -1){

1083  
MOSQ_ERR_ERRNO
;

1085 if(
	`√t__sockë_n⁄block
(&
sv
[0])){

1086 
	`COMPAT_CLOSE
(
sv
[1]);

1087  
MOSQ_ERR_ERRNO
;

1089 if(
	`√t__sockë_n⁄block
(&
sv
[1])){

1090 
	`COMPAT_CLOSE
(
sv
[0]);

1091  
MOSQ_ERR_ERRNO
;

1093 *
∑úR
 = 
sv
[0];

1094 *
∑úW
 = 
sv
[1];

1095  
MOSQ_ERR_SUCCESS
;

1097 
	}
}

	@lib/net_mosq.h

16 #i‚de‡
NET_MOSQ_H


17 
	#NET_MOSQ_H


	)

19 #i‚de‡
WIN32


20 
	~<uni°d.h
>

22 
	~<wösock2.h
>

23 #i‚de‡
_SSIZE_T_DEFINED


24 
SSIZE_T
 
	tssize_t
;

25 
	#_SSIZE_T_DEFINED


	)

29 
	~"mosquôto_öã∫Æ.h
"

30 
	~"mosquôto.h
"

32 #ifde‡
WITH_BROKER


33 
	gmosquôto_db
;

36 #ifde‡
WIN32


37 
	#COMPAT_CLOSE
(
a
Ë
	`˛o£sockë
◊)

	)

38 
	#COMPAT_ECONNRESET
 
WSAECONNRESET


	)

39 
	#COMPAT_EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

41 
	#COMPAT_CLOSE
(
a
Ë
	`˛o£
◊)

	)

42 
	#COMPAT_ECONNRESET
 
ECONNRESET


	)

43 
	#COMPAT_EWOULDBLOCK
 
EWOULDBLOCK


	)

47 #i‚de‡
INVALID_SOCKET


48 
	#INVALID_SOCKET
 -1

	)

52 
	#MOSQ_MSB
(
A
Ë(
uöt8_t
)((A & 0xFF00Ë>> 8)

	)

53 
	#MOSQ_LSB
(
A
Ë(
uöt8_t
)(A & 0x00FF)

	)

55 
√t__öô
();

56 
√t__˛ónup
();

58 
√t__sockë_c⁄√˘
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
uöt16_t
 
p‹t
, c⁄° *
böd_addªss
, 
boﬁ
 
blockög
);

59 #ifde‡
WITH_BROKER


60 
√t__sockë_˛o£
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

62 
√t__sockë_˛o£
(
mosquôto
 *
mosq
);

64 
√t__åy_c⁄√˘
(c⁄° *
ho°
, 
uöt16_t
 
p‹t
, 
mosq_sock_t
 *
sock
, c⁄° *
böd_addªss
, 
boﬁ
 
blockög
);

65 
√t__åy_c⁄√˘_°ï1
(
mosquôto
 *
mosq
, c⁄° *
ho°
);

66 
√t__åy_c⁄√˘_°ï2
(
mosquôto
 *
mosq
, 
uöt16_t
 
p‹t
, 
mosq_sock_t
 *
sock
);

67 
√t__sockë_c⁄√˘_°ï3
(
mosquôto
 *
mosq
, c⁄° *
ho°
);

68 
√t__sockë_n⁄block
(
mosq_sock_t
 *
sock
);

69 
√t__sockë∑ú
(
mosq_sock_t
 *
•1
, mosq_sock_à*
•2
);

71 
ssize_t
 
√t__ªad
(
mosquôto
 *
mosq
, *
buf
, 
size_t
 
cou¡
);

72 
ssize_t
 
√t__wrôe
(
mosquôto
 *
mosq
, *
buf
, 
size_t
 
cou¡
);

74 #ifde‡
WITH_TLS


75 
√t__sockë_≠∂y_és
(
mosquôto
 *
mosq
);

76 
√t__sockë_c⁄√˘_és
(
mosquôto
 *
mosq
);

77 
mosquôto__vîify_oc•_°©us_cb
(
SSL
 * 
s¶
, *
¨g
);

78 
UI_METHOD
 *
√t__gë_ui_mëhod
();

79 
	#ENGINE_FINISH
(
e
Ëif”Ë
	`ENGINE_föish
”)

	)

80 
	#ENGINE_SECRET_MODE
 "SECRET_MODE"

	)

81 
	#ENGINE_SECRET_MODE_SHA
 0x1000

	)

82 
	#ENGINE_PIN
 "PIN"

	)

	@lib/net_mosq_ocsp.c

43 #ifde‡
WITH_TLS


44 
	~<loggög_mosq.h
>

45 
	~<mosquôto_öã∫Æ.h
>

46 
	~<√t_mosq.h
>

48 
	~<›ís¶/ß„°ack.h
>

49 
	~<›ís¶/és1.h
>

50 
	~<›ís¶/s¶.h
>

51 
	~<›ís¶/oc•.h
>

53 
	$mosquôto__vîify_oc•_°©us_cb
(
SSL
 * 
s¶
, *
¨g
)

55 
mosquôto
 *
mosq
 = (mosquôtÿ*)
¨g
;

56 
oc•_°©us
, 
ªsu…2
, 
i
;

57 *
p
;

58 c⁄° *
˝
;

59 
OCSP_RESPONSE
 *
r•
 = 
NULL
;

60 
OCSP_BASICRESP
 *
br
 = 
NULL
;

61 
X509_STORE
 *
°
 = 
NULL
;

62 
	`STACK_OF
(
X509
Ë*
ch
 = 
NULL
;

64 
Àn
 = 
	`SSL_gë_é£xt_°©us_oc•_ª•
(
mosq
->
s¶
, &
p
);

65 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: SSL_gë_é£xt_°©us_oc•_ª•Ñëu∫ed %ld byãs", 
Àn
);

68 
˝
 = (c⁄° *)
p
;

70 i‡(!
˝
 || 
Àn
 <= 0) {

71 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP:ÇoÑesponse");

72 
íd
;

76 
r•
 = 
	`d2i_OCSP_RESPONSE
(
NULL
, &
˝
, 
Àn
);

77 i‡(
r•
==
NULL
) {

78 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: invalidÑesponse");

79 
íd
;

82 
oc•_°©us
 = 
	`OCSP_ª•⁄£_°©us
(
r•
);

83 if(
oc•_°©us
 !
OCSP_RESPONSE_STATUS_SUCCESSFUL
) {

84 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: invalid status: %s (%d)",

85 
	`OCSP_ª•⁄£_°©us_°r
(
oc•_°©us
), ocsp_status);

86 
íd
;

89 
br
 = 
	`OCSP_ª•⁄£_gë1_basic
(
r•
);

90 i‡(!
br
) {

91 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: invalidÑesponse");

92 
íd
;

95 
ch
 = 
	`SSL_gë_≥î_˚π_chaö
(
mosq
->
s¶
);

96 i‡(
	`sk_X509_num
(
ch
) <= 0) {

97 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "OCSP: wêdidÇŸÑe˚ivê˚πifiˇã†o‡thê£rvî (num: %d)", 
	`sk_X509_num
(
ch
));

98 
íd
;

101 
°
 = 
	`SSL_CTX_gë_˚π_°‹e
(
mosq
->
s¶_˘x
);

107 i‡((
ªsu…2
=
	`OCSP_basic_vîify
(
br
, 
ch
, 
°
, 0)) <= 0) {

108 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP:Ñe•⁄£ vîifiˇti⁄ faûed (îr‹: %d)", 
ªsu…2
);

109 
íd
;

112 
i
 = 0; i < 
	`OCSP_ª•_cou¡
(
br
); i++) {

113 
˚π_°©us
, 
¸l_ªas⁄
;

114 
OCSP_SINGLERESP
 *
sögÀ
 = 
NULL
;

116 
ASN1_GENERALIZEDTIME
 *
ªv
, *
thisupd
, *
√xtupd
;

118 
sögÀ
 = 
	`OCSP_ª•_gë0
(
br
, 
i
);

119 if(!
sögÀ
)

122 
˚π_°©us
 = 
	`OCSP_sögÀ_gë0_°©us
(
sögÀ
, &
¸l_ªas⁄
, &
ªv
, &
thisupd
, &
√xtupd
);

124 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: SSL certificate status: %s (%d)",

125 
	`OCSP_˚π_°©us_°r
(
˚π_°©us
), cert_status);

127 
˚π_°©us
) {

128 
V_OCSP_CERTSTATUS_GOOD
:

130 if(!
	`OCSP_check_vÆidôy
(
thisupd
, 
√xtupd
, 300L, -1L)) {

131 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: OCSPÑesponse hasÉxpired");

132 
íd
;

136 
V_OCSP_CERTSTATUS_REVOKED
:

137 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: SSL certificateÑevocationÑeason: %s (%d)",

138 
	`OCSP_¸l_ªas⁄_°r
(
¸l_ªas⁄
), crl_reason);

139 
íd
;

141 
V_OCSP_CERTSTATUS_UNKNOWN
:

142 
íd
;

145 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "OCSP: SSL certificateÑevocation status unknown");

146 
íd
;

150 i‡(
br
!=
NULL
Ë
	`OCSP_BASICRESP_‰ì
(br);

151 i‡(
r•
!=
NULL
Ë
	`OCSP_RESPONSE_‰ì
(rsp);

154 
íd
:

155 i‡(
br
!=
NULL
Ë
	`OCSP_BASICRESP_‰ì
(br);

156 i‡(
r•
!=
NULL
Ë
	`OCSP_RESPONSE_‰ì
(rsp);

158 
	}
}

	@lib/options.c

17 
	~"c⁄fig.h
"

19 #i‚de‡
WIN32


20 
	~<°rögs.h
>

23 
	~<°rög.h
>

25 #ifde‡
WITH_TLS


26 #ifde‡
WIN32


27 
	~<wösock2.h
>

29 
	~<›ís¶/ígöe.h
>

32 
	~"mosquôto.h
"

33 
	~"mosquôto_öã∫Æ.h
"

34 
	~"mem‹y_mosq.h
"

35 
	~"mqâ_¥Ÿocﬁ.h
"

36 
	~"utû_mosq.h
"

37 
	~"wûl_mosq.h
"

40 
	$mosquôto_wûl_£t
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
)

42  
	`mosquôto_wûl_£t_v5
(
mosq
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
NULL
);

43 
	}
}

46 
	$mosquôto_wûl_£t_v5
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_¥›îty
 *
¥›îtõs
)

48 
rc
;

50 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

52 if(
¥›îtõs
){

53 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
CMD_WILL
, 
¥›îtõs
);

54 if(
rc
) Ñc;

57  
	`wûl__£t
(
mosq
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
¥›îtõs
);

58 
	}
}

61 
	$mosquôto_wûl_˛ór
(
mosquôto
 *
mosq
)

63 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

64  
	`wûl__˛ór
(
mosq
);

65 
	}
}

68 
	$mosquôto_u£∫ame_pw_£t
(
mosquôto
 *
mosq
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

70 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

72 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || mosq->¥Ÿocﬁ =
mosq_p_mqâ31
){

73 if(
∑ssw‹d
 !
NULL
 && 
u£∫ame
 == NULL){

74  
MOSQ_ERR_INVAL
;

78 
	`mosquôto__‰ì
(
mosq
->
u£∫ame
);

79 
mosq
->
u£∫ame
 = 
NULL
;

81 
	`mosquôto__‰ì
(
mosq
->
∑ssw‹d
);

82 
mosq
->
∑ssw‹d
 = 
NULL
;

84 if(
u£∫ame
){

85 if(
	`mosquôto_vÆid©e_utf8
(
u£∫ame
, 
	`°æí
(username))){

86  
MOSQ_ERR_MALFORMED_UTF8
;

88 
mosq
->
u£∫ame
 = 
	`mosquôto__°rdup
(username);

89 if(!
mosq
->
u£∫ame
Ë 
MOSQ_ERR_NOMEM
;

92 if(
∑ssw‹d
){

93 
mosq
->
∑ssw‹d
 = 
	`mosquôto__°rdup
(password);

94 if(!
mosq
->
∑ssw‹d
){

95 
	`mosquôto__‰ì
(
mosq
->
u£∫ame
);

96 
mosq
->
u£∫ame
 = 
NULL
;

97  
MOSQ_ERR_NOMEM
;

100  
MOSQ_ERR_SUCCESS
;

101 
	}
}

104 
	$mosquôto_ªc⁄√˘_dñay_£t
(
mosquôto
 *
mosq
, 
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
)

106 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

108 if(
ªc⁄√˘_dñay
 == 0)Ñeconnect_delay = 1;

110 
mosq
->
ªc⁄√˘_dñay
 =Ñeconnect_delay;

111 
mosq
->
ªc⁄√˘_dñay_max
 =Ñeconnect_delay_max;

112 
mosq
->
ªc⁄√˘_exp⁄ítül_backoff
 =Ñeconnect_exponential_backoff;

114  
MOSQ_ERR_SUCCESS
;

116 
	}
}

119 
	$mosquôto_és_£t
(
mosquôto
 *
mosq
, c⁄° *
ˇfûe
, c⁄° *
ˇ∑th
, c⁄° *
˚πfûe
, c⁄° *
keyfûe
, (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
))

121 #ifde‡
WITH_TLS


122 
FILE
 *
Âå
;

124 if(!
mosq
 || (!
ˇfûe
 && !
ˇ∑th
Ë|| (
˚πfûe
 && !
keyfûe
Ë|| (!˚πfûê&& keyfûe)Ë 
MOSQ_ERR_INVAL
;

126 
	`mosquôto__‰ì
(
mosq
->
és_ˇfûe
);

127 
mosq
->
és_ˇfûe
 = 
NULL
;

128 if(
ˇfûe
){

129 
Âå
 = 
	`mosquôto__f›í
(
ˇfûe
, "π", 
Ál£
);

130 if(
Âå
){

131 
	`f˛o£
(
Âå
);

133  
MOSQ_ERR_INVAL
;

135 
mosq
->
és_ˇfûe
 = 
	`mosquôto__°rdup
(
ˇfûe
);

137 if(!
mosq
->
és_ˇfûe
){

138  
MOSQ_ERR_NOMEM
;

142 
	`mosquôto__‰ì
(
mosq
->
és_ˇ∑th
);

143 
mosq
->
és_ˇ∑th
 = 
NULL
;

144 if(
ˇ∑th
){

145 
mosq
->
és_ˇ∑th
 = 
	`mosquôto__°rdup
(
ˇ∑th
);

146 if(!
mosq
->
és_ˇ∑th
){

147  
MOSQ_ERR_NOMEM
;

151 
	`mosquôto__‰ì
(
mosq
->
és_˚πfûe
);

152 
mosq
->
és_˚πfûe
 = 
NULL
;

153 if(
˚πfûe
){

154 
Âå
 = 
	`mosquôto__f›í
(
˚πfûe
, "π", 
Ál£
);

155 if(
Âå
){

156 
	`f˛o£
(
Âå
);

158 
	`mosquôto__‰ì
(
mosq
->
és_ˇfûe
);

159 
mosq
->
és_ˇfûe
 = 
NULL
;

161 
	`mosquôto__‰ì
(
mosq
->
és_ˇ∑th
);

162 
mosq
->
és_ˇ∑th
 = 
NULL
;

163  
MOSQ_ERR_INVAL
;

165 
mosq
->
és_˚πfûe
 = 
	`mosquôto__°rdup
(
˚πfûe
);

166 if(!
mosq
->
és_˚πfûe
){

167  
MOSQ_ERR_NOMEM
;

171 
	`mosquôto__‰ì
(
mosq
->
és_keyfûe
);

172 
mosq
->
és_keyfûe
 = 
NULL
;

173 if(
keyfûe
){

174 
Âå
 = 
	`mosquôto__f›í
(
keyfûe
, "π", 
Ál£
);

175 if(
Âå
){

176 
	`f˛o£
(
Âå
);

178 
	`mosquôto__‰ì
(
mosq
->
és_ˇfûe
);

179 
mosq
->
és_ˇfûe
 = 
NULL
;

181 
	`mosquôto__‰ì
(
mosq
->
és_ˇ∑th
);

182 
mosq
->
és_ˇ∑th
 = 
NULL
;

184 
	`mosquôto__‰ì
(
mosq
->
és_˚πfûe
);

185 
mosq
->
és_˚πfûe
 = 
NULL
;

186  
MOSQ_ERR_INVAL
;

188 
mosq
->
és_keyfûe
 = 
	`mosquôto__°rdup
(
keyfûe
);

189 if(!
mosq
->
és_keyfûe
){

190  
MOSQ_ERR_NOMEM
;

194 
mosq
->
és_pw_ˇŒback
 = 
pw_ˇŒback
;

197  
MOSQ_ERR_SUCCESS
;

199  
MOSQ_ERR_NOT_SUPPORTED
;

202 
	}
}

205 
	$mosquôto_és_›ts_£t
(
mosquôto
 *
mosq
, 
˚π_ªqs
, c⁄° *
és_vîsi⁄
, c⁄° *
cùhîs
)

207 #ifde‡
WITH_TLS


208 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

210 
mosq
->
és_˚π_ªqs
 = 
˚π_ªqs
;

211 if(
és_vîsi⁄
){

212 if(!
	`°rˇ£cmp
(
és_vîsi⁄
, "tlsv1.3")

213 || !
	`°rˇ£cmp
(
és_vîsi⁄
, "tlsv1.2")

214 || !
	`°rˇ£cmp
(
és_vîsi⁄
, "tlsv1.1")){

216 
mosq
->
és_vîsi⁄
 = 
	`mosquôto__°rdup
(tls_version);

217 if(!
mosq
->
és_vîsi⁄
Ë 
MOSQ_ERR_NOMEM
;

219  
MOSQ_ERR_INVAL
;

222 
mosq
->
és_vîsi⁄
 = 
	`mosquôto__°rdup
("tlsv1.2");

223 if(!
mosq
->
és_vîsi⁄
Ë 
MOSQ_ERR_NOMEM
;

225 if(
cùhîs
){

226 
mosq
->
és_cùhîs
 = 
	`mosquôto__°rdup
(
cùhîs
);

227 if(!
mosq
->
és_cùhîs
Ë 
MOSQ_ERR_NOMEM
;

229 
mosq
->
és_cùhîs
 = 
NULL
;

233  
MOSQ_ERR_SUCCESS
;

235  
MOSQ_ERR_NOT_SUPPORTED
;

238 
	}
}

241 
	$mosquôto_és_ö£cuª_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
vÆue
)

243 #ifde‡
WITH_TLS


244 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

245 
mosq
->
és_ö£cuª
 = 
vÆue
;

246  
MOSQ_ERR_SUCCESS
;

248  
MOSQ_ERR_NOT_SUPPORTED
;

250 
	}
}

253 
	$mosquôto_°rög_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, c⁄° *
vÆue
)

255 #ifde‡
WITH_TLS


256 
ENGINE
 *
íg
;

257 *
°r
;

260 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

262 
›ti⁄
){

263 
MOSQ_OPT_TLS_ENGINE
:

264 #ifde‡
WITH_TLS


265 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

266 
íg
 = 
	`ENGINE_by_id
(
vÆue
);

267 if(!
íg
){

268  
MOSQ_ERR_INVAL
;

270 
	`ENGINE_‰ì
(
íg
);

271 
mosq
->
és_ígöe
 = 
	`mosquôto__°rdup
(
vÆue
);

272 if(!
mosq
->
és_ígöe
){

273  
MOSQ_ERR_NOMEM
;

275  
MOSQ_ERR_SUCCESS
;

278  
MOSQ_ERR_NOT_SUPPORTED
;

282 
MOSQ_OPT_TLS_KEYFORM
:

283 #ifde‡
WITH_TLS


284 if(!
vÆue
Ë 
MOSQ_ERR_INVAL
;

285 if(!
	`°rˇ£cmp
(
vÆue
, "pem")){

286 
mosq
->
és_keyf‹m
 = 
mosq_k_≥m
;

287 }i‡(!
	`°rˇ£cmp
(
vÆue
, "engine")){

288 
mosq
->
és_keyf‹m
 = 
mosq_k_ígöe
;

290  
MOSQ_ERR_INVAL
;

292  
MOSQ_ERR_SUCCESS
;

294  
MOSQ_ERR_NOT_SUPPORTED
;

299 
MOSQ_OPT_TLS_ENGINE_KPASS_SHA1
:

300 #ifde‡
WITH_TLS


301 if(
	`mosquôto__hex2bö_sha1
(
vÆue
, (**)&
°r
Ë!
MOSQ_ERR_SUCCESS
){

302  
MOSQ_ERR_INVAL
;

304 
mosq
->
és_ígöe_k∑ss_sha1
 = 
°r
;

305  
MOSQ_ERR_SUCCESS
;

307  
MOSQ_ERR_NOT_SUPPORTED
;

311 
MOSQ_OPT_TLS_ALPN
:

312 #ifde‡
WITH_TLS


313 
mosq
->
és_Æ≤
 = 
	`mosquôto__°rdup
(
vÆue
);

314 if(!
mosq
->
és_Æ≤
){

315  
MOSQ_ERR_NOMEM
;

317  
MOSQ_ERR_SUCCESS
;

319  
MOSQ_ERR_NOT_SUPPORTED
;

324  
MOSQ_ERR_INVAL
;

326 
	}
}

329 
	$mosquôto_és_psk_£t
(
mosquôto
 *
mosq
, c⁄° *
psk
, c⁄° *
idítôy
, c⁄° *
cùhîs
)

331 #ifde‡
FINAL_WITH_TLS_PSK


332 if(!
mosq
 || !
psk
 || !
idítôy
Ë 
MOSQ_ERR_INVAL
;

335 if(
	`°r•n
(
psk
, "0123456789abcdefABCDEF"Ë< 
	`°æí
(psk)){

336  
MOSQ_ERR_INVAL
;

338 
mosq
->
és_psk
 = 
	`mosquôto__°rdup
(
psk
);

339 if(!
mosq
->
és_psk
Ë 
MOSQ_ERR_NOMEM
;

341 
mosq
->
és_psk_idítôy
 = 
	`mosquôto__°rdup
(
idítôy
);

342 if(!
mosq
->
és_psk_idítôy
){

343 
	`mosquôto__‰ì
(
mosq
->
és_psk
);

344  
MOSQ_ERR_NOMEM
;

346 if(
cùhîs
){

347 
mosq
->
és_cùhîs
 = 
	`mosquôto__°rdup
(
cùhîs
);

348 if(!
mosq
->
és_cùhîs
Ë 
MOSQ_ERR_NOMEM
;

350 
mosq
->
és_cùhîs
 = 
NULL
;

353  
MOSQ_ERR_SUCCESS
;

355  
MOSQ_ERR_NOT_SUPPORTED
;

357 
	}
}

360 
	$mosquôto_›ts_£t
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, *
vÆue
)

362 
ivÆ
;

364 if(!
mosq
 || !
vÆue
Ë 
MOSQ_ERR_INVAL
;

366 
›ti⁄
){

367 
MOSQ_OPT_PROTOCOL_VERSION
:

368 
ivÆ
 = *((*)
vÆue
);

369  
	`mosquôto_öt_›ti⁄
(
mosq
, 
›ti⁄
, 
ivÆ
);

370 
MOSQ_OPT_SSL_CTX
:

371 #ifde‡
WITH_TLS


372 
mosq
->
s¶_˘x
 = (
SSL_CTX
 *)
vÆue
;

373 if(
mosq
->
s¶_˘x
){

374 #i‡(
OPENSSL_VERSION_NUMBER
 >0x10100000LË&& !
	`deföed
(
LIBRESSL_VERSION_NUMBER
)

375 
	`SSL_CTX_up_ªf
(
mosq
->
s¶_˘x
);

377 
	`CRYPTO_add
(&(
mosq
->
s¶_˘x
)->
ª„ªn˚s
, 1, 
CRYPTO_LOCK_SSL_CTX
);

382  
MOSQ_ERR_NOT_SUPPORTED
;

385  
MOSQ_ERR_INVAL
;

387  
MOSQ_ERR_SUCCESS
;

388 
	}
}

391 
	$mosquôto_öt_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, 
vÆue
)

393 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

395 
›ti⁄
){

396 
MOSQ_OPT_PROTOCOL_VERSION
:

397 if(
vÆue
 =
MQTT_PROTOCOL_V31
){

398 
mosq
->
¥Ÿocﬁ
 = 
mosq_p_mqâ31
;

399 }if(
vÆue
 =
MQTT_PROTOCOL_V311
){

400 
mosq
->
¥Ÿocﬁ
 = 
mosq_p_mqâ311
;

401 }if(
vÆue
 =
MQTT_PROTOCOL_V5
){

402 
mosq
->
¥Ÿocﬁ
 = 
mosq_p_mqâ5
;

404  
MOSQ_ERR_INVAL
;

408 
MOSQ_OPT_RECEIVE_MAXIMUM
:

409 if(
vÆue
 < 0 || value > 65535){

410  
MOSQ_ERR_INVAL
;

412 if(
vÆue
 == 0){

413 
mosq
->
msgs_ö
.
öÊight_maximum
 = 65535;

415 
mosq
->
msgs_ö
.
öÊight_maximum
 = 
vÆue
;

419 
MOSQ_OPT_SEND_MAXIMUM
:

420 if(
vÆue
 < 0 || value > 65535){

421  
MOSQ_ERR_INVAL
;

423 if(
vÆue
 == 0){

424 
mosq
->
msgs_out
.
öÊight_maximum
 = 65535;

426 
mosq
->
msgs_out
.
öÊight_maximum
 = 
vÆue
;

430 
MOSQ_OPT_SSL_CTX_WITH_DEFAULTS
:

431 #i‡
	`deföed
(
WITH_TLS
Ë&& 
OPENSSL_VERSION_NUMBER
 >= 0x10100000L

432 if(
vÆue
){

433 
mosq
->
s¶_˘x_deÁu…s
 = 
åue
;

435 
mosq
->
s¶_˘x_deÁu…s
 = 
Ál£
;

439  
MOSQ_ERR_NOT_SUPPORTED
;

442 
MOSQ_OPT_TLS_OCSP_REQUIRED
:

443 #ifde‡
WITH_TLS


444 
mosq
->
és_oc•_ªquúed
 = (
boﬁ
)
vÆue
;

446  
MOSQ_ERR_NOT_SUPPORTED
;

451  
MOSQ_ERR_INVAL
;

453  
MOSQ_ERR_SUCCESS
;

454 
	}
}

457 
	$mosquôto_void_›ti⁄
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, *
vÆue
)

459 if(!
mosq
 || !
vÆue
Ë 
MOSQ_ERR_INVAL
;

461 
›ti⁄
){

462 
MOSQ_OPT_SSL_CTX
:

463 #ifde‡
WITH_TLS


464 
mosq
->
s¶_˘x
 = (
SSL_CTX
 *)
vÆue
;

465 if(
mosq
->
s¶_˘x
){

466 #i‡(
OPENSSL_VERSION_NUMBER
 >0x10100000LË&& !
	`deföed
(
LIBRESSL_VERSION_NUMBER
)

467 
	`SSL_CTX_up_ªf
(
mosq
->
s¶_˘x
);

469 
	`CRYPTO_add
(&(
mosq
->
s¶_˘x
)->
ª„ªn˚s
, 1, 
CRYPTO_LOCK_SSL_CTX
);

474  
MOSQ_ERR_NOT_SUPPORTED
;

477  
MOSQ_ERR_INVAL
;

479  
MOSQ_ERR_SUCCESS
;

480 
	}
}

483 
	$mosquôto_u£r_d©a_£t
(
mosquôto
 *
mosq
, *
u£rd©a
)

485 if(
mosq
){

486 
mosq
->
u£rd©a
 = userdata;

488 
	}
}

490 *
	$mosquôto_u£rd©a
(
mosquôto
 *
mosq
)

492  
mosq
->
u£rd©a
;

493 
	}
}

	@lib/packet_datatypes.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

25 #ifde‡
WITH_WEBSOCKETS


26 
	~<libwebsockës.h
>

29 
	~"ªad_h™dÀ.h
"

32 
	~"mem‹y_mosq.h
"

33 
	~"mqâ_¥Ÿocﬁ.h
"

34 
	~"√t_mosq.h
"

35 
	~"∑ckë_mosq.h
"

36 
	~"ªad_h™dÀ.h
"

37 #ifde‡
WITH_BROKER


38 
	~"sys_åì.h
"

40 
	#G_BYTES_RECEIVED_INC
(
A
)

	)

41 
	#G_BYTES_SENT_INC
(
A
)

	)

42 
	#G_MSGS_SENT_INC
(
A
)

	)

43 
	#G_PUB_MSGS_SENT_INC
(
A
)

	)

47 
	$∑ckë__ªad_byã
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 *
byã
)

49 
	`as£π
(
∑ckë
);

50 if(
∑ckë
->
pos
+1 >Öackë->
ªmaöög_Àngth
Ë 
MOSQ_ERR_PROTOCOL
;

52 *
byã
 = 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
];

53 
∑ckë
->
pos
++;

55  
MOSQ_ERR_SUCCESS
;

56 
	}
}

59 
	$∑ckë__wrôe_byã
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 
byã
)

61 
	`as£π
(
∑ckë
);

62 
	`as£π
(
∑ckë
->
pos
+1 <∑ckë->
∑ckë_Àngth
);

64 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
] = 
byã
;

65 
∑ckë
->
pos
++;

66 
	}
}

69 
	$∑ckë__ªad_byãs
(
mosquôto__∑ckë
 *
∑ckë
, *
byãs
, 
uöt32_t
 
cou¡
)

71 
	`as£π
(
∑ckë
);

72 if(
∑ckë
->
pos
+
cou¡
 >Öackë->
ªmaöög_Àngth
Ë 
MOSQ_ERR_PROTOCOL
;

74 
	`mem˝y
(
byãs
, &(
∑ckë
->
∑ylﬂd
[∑ckë->
pos
]), 
cou¡
);

75 
∑ckë
->
pos
 +
cou¡
;

77  
MOSQ_ERR_SUCCESS
;

78 
	}
}

81 
	$∑ckë__wrôe_byãs
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° *
byãs
, 
uöt32_t
 
cou¡
)

83 
	`as£π
(
∑ckë
);

84 
	`as£π
(
∑ckë
->
pos
+
cou¡
 <∑ckë->
∑ckë_Àngth
);

86 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[∑ckë->
pos
]), 
byãs
, 
cou¡
);

87 
∑ckë
->
pos
 +
cou¡
;

88 
	}
}

91 
	$∑ckë__ªad_bö¨y
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 **
d©a
, *
Àngth
)

93 
uöt16_t
 
¶í
;

94 
rc
;

96 
	`as£π
(
∑ckë
);

97 
rc
 = 
	`∑ckë__ªad_uöt16
(
∑ckë
, &
¶í
);

98 if(
rc
) Ñc;

100 if(
¶í
 == 0){

101 *
d©a
 = 
NULL
;

102 *
Àngth
 = 0;

103  
MOSQ_ERR_SUCCESS
;

106 if(
∑ckë
->
pos
+
¶í
 >Öackë->
ªmaöög_Àngth
Ë 
MOSQ_ERR_PROTOCOL
;

108 *
d©a
 = 
	`mosquôto__mÆloc
(
¶í
+1);

109 if(*
d©a
){

110 
	`mem˝y
(*
d©a
, &(
∑ckë
->
∑ylﬂd
[∑ckë->
pos
]), 
¶í
);

111 ((
uöt8_t
 *)(*
d©a
))[
¶í
] = '\0';

112 
∑ckë
->
pos
 +
¶í
;

114  
MOSQ_ERR_NOMEM
;

117 *
Àngth
 = 
¶í
;

118  
MOSQ_ERR_SUCCESS
;

119 
	}
}

122 
	$∑ckë__ªad_°rög
(
mosquôto__∑ckë
 *
∑ckë
, **
°r
, *
Àngth
)

124 
rc
;

126 
rc
 = 
	`∑ckë__ªad_bö¨y
(
∑ckë
, (
uöt8_t
 **)
°r
, 
Àngth
);

127 if(
rc
) Ñc;

128 if(*
Àngth
 =0Ë 
MOSQ_ERR_SUCCESS
;

130 if(
	`mosquôto_vÆid©e_utf8
(*
°r
, *
Àngth
)){

131 
	`mosquôto__‰ì
(*
°r
);

132 *
°r
 = 
NULL
;

133 *
Àngth
 = -1;

134  
MOSQ_ERR_MALFORMED_UTF8
;

137  
MOSQ_ERR_SUCCESS
;

138 
	}
}

141 
	$∑ckë__wrôe_°rög
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° *
°r
, 
uöt16_t
 
Àngth
)

143 
	`as£π
(
∑ckë
);

144 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
Àngth
);

145 
	`∑ckë__wrôe_byãs
(
∑ckë
, 
°r
, 
Àngth
);

146 
	}
}

149 
	$∑ckë__ªad_uöt16
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt16_t
 *
w‹d
)

151 
uöt8_t
 
msb
, 
lsb
;

153 
	`as£π
(
∑ckë
);

154 if(
∑ckë
->
pos
+2 >Öackë->
ªmaöög_Àngth
Ë 
MOSQ_ERR_PROTOCOL
;

156 
msb
 = 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
];

157 
∑ckë
->
pos
++;

158 
lsb
 = 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
];

159 
∑ckë
->
pos
++;

161 *
w‹d
 = (
msb
<<8Ë+ 
lsb
;

163  
MOSQ_ERR_SUCCESS
;

164 
	}
}

167 
	$∑ckë__wrôe_uöt16
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt16_t
 
w‹d
)

169 
	`∑ckë__wrôe_byã
(
∑ckë
, 
	`MOSQ_MSB
(
w‹d
));

170 
	`∑ckë__wrôe_byã
(
∑ckë
, 
	`MOSQ_LSB
(
w‹d
));

171 
	}
}

174 
	$∑ckë__ªad_uöt32
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt32_t
 *
w‹d
)

176 
uöt32_t
 
vÆ
 = 0;

177 
i
;

179 
	`as£π
(
∑ckë
);

180 if(
∑ckë
->
pos
+4 >Öackë->
ªmaöög_Àngth
Ë 
MOSQ_ERR_PROTOCOL
;

182 
i
=0; i<4; i++){

183 
vÆ
 = (vÆ << 8Ë+ 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
];

184 
∑ckë
->
pos
++;

187 *
w‹d
 = 
vÆ
;

189  
MOSQ_ERR_SUCCESS
;

190 
	}
}

193 
	$∑ckë__wrôe_uöt32
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt32_t
 
w‹d
)

195 
	`∑ckë__wrôe_byã
(
∑ckë
, (
w‹d
 & 0xFF000000) >> 24);

196 
	`∑ckë__wrôe_byã
(
∑ckë
, (
w‹d
 & 0x00FF0000) >> 16);

197 
	`∑ckë__wrôe_byã
(
∑ckë
, (
w‹d
 & 0x0000FF00) >> 8);

198 
	`∑ckë__wrôe_byã
(
∑ckë
, (
w‹d
 & 0x000000FF));

199 
	}
}

202 
	$∑ckë__ªad_v¨öt
(
mosquôto__∑ckë
 *
∑ckë
, 
öt32_t
 *
w‹d
, 
öt8_t
 *
byãs
)

204 
i
;

205 
uöt8_t
 
byã
;

206 
ªmaöög_mu…
 = 1;

207 
öt32_t
 
lw‹d
 = 0;

208 
uöt8_t
 
lbyãs
 = 0;

210 
i
=0; i<4; i++){

211 if(
∑ckë
->
pos
 <Öackë->
ªmaöög_Àngth
){

212 
lbyãs
++;

213 
byã
 = 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
];

214 
lw‹d
 +(
byã
 & 127Ë* 
ªmaöög_mu…
;

215 
ªmaöög_mu…
 *= 128;

216 
∑ckë
->
pos
++;

217 if((
byã
 & 128) == 0){

218 if(
lbyãs
 > 1 && 
byã
 == 0){

220  
MOSQ_ERR_PROTOCOL
;

222 *
w‹d
 = 
lw‹d
;

223 if(
byãs
Ë(*byãsË
lbyãs
;

224  
MOSQ_ERR_SUCCESS
;

228  
MOSQ_ERR_PROTOCOL
;

231  
MOSQ_ERR_PROTOCOL
;

232 
	}
}

235 
	$∑ckë__wrôe_v¨öt
(
mosquôto__∑ckë
 *
∑ckë
, 
öt32_t
 
w‹d
)

237 
uöt8_t
 
byã
;

238 
cou¡
 = 0;

241 
byã
 = 
w‹d
 % 128;

242 
w‹d
 = word / 128;

244 if(
w‹d
 > 0){

245 
byã
 = byte | 0x80;

247 
	`∑ckë__wrôe_byã
(
∑ckë
, 
byã
);

248 
cou¡
++;

249 }
w‹d
 > 0 && 
cou¡
 < 5);

251 if(
cou¡
 == 5){

252  
MOSQ_ERR_PROTOCOL
;

254  
MOSQ_ERR_SUCCESS
;

255 
	}
}

258 
	$∑ckë__v¨öt_byãs
(
öt32_t
 
w‹d
)

260 if(
w‹d
 < 128){

262 }if(
w‹d
 < 16384){

264 }if(
w‹d
 < 2097152){

266 }if(
w‹d
 < 268435456){

271 
	}
}

	@lib/packet_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

25 #ifde‡
WITH_WEBSOCKETS


26 
	~<libwebsockës.h
>

29 
	~"ªad_h™dÀ.h
"

32 
	~"mem‹y_mosq.h
"

33 
	~"mqâ_¥Ÿocﬁ.h
"

34 
	~"√t_mosq.h
"

35 
	~"∑ckë_mosq.h
"

36 
	~"ªad_h™dÀ.h
"

37 
	~"utû_mosq.h
"

38 #ifde‡
WITH_BROKER


39 
	~"sys_åì.h
"

40 
	~"£nd_mosq.h
"

42 
	#G_BYTES_RECEIVED_INC
(
A
)

	)

43 
	#G_BYTES_SENT_INC
(
A
)

	)

44 
	#G_MSGS_SENT_INC
(
A
)

	)

45 
	#G_PUB_MSGS_SENT_INC
(
A
)

	)

48 
	$∑ckë__Æloc
(
mosquôto__∑ckë
 *
∑ckë
)

50 
uöt8_t
 
ªmaöög_byãs
[5], 
byã
;

51 
uöt32_t
 
ªmaöög_Àngth
;

52 
i
;

54 
	`as£π
(
∑ckë
);

56 
ªmaöög_Àngth
 = 
∑ckë
->remaining_length;

57 
∑ckë
->
∑ylﬂd
 = 
NULL
;

58 
∑ckë
->
ªmaöög_cou¡
 = 0;

60 
byã
 = 
ªmaöög_Àngth
 % 128;

61 
ªmaöög_Àngth
 =Ñemaining_length / 128;

63 if(
ªmaöög_Àngth
 > 0){

64 
byã
 = byte | 0x80;

66 
ªmaöög_byãs
[
∑ckë
->
ªmaöög_cou¡
] = 
byã
;

67 
∑ckë
->
ªmaöög_cou¡
++;

68 }
ªmaöög_Àngth
 > 0 && 
∑ckë
->
ªmaöög_cou¡
 < 5);

69 if(
∑ckë
->
ªmaöög_cou¡
 =5Ë 
MOSQ_ERR_PAYLOAD_SIZE
;

70 
∑ckë
->
∑ckë_Àngth
 =Öackë->
ªmaöög_Àngth
 + 1 +Öackë->
ªmaöög_cou¡
;

71 #ifde‡
WITH_WEBSOCKETS


72 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
 + 
LWS_SEND_BUFFER_PRE_PADDING
 + 
LWS_SEND_BUFFER_POST_PADDING
);

74 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

76 if(!
∑ckë
->
∑ylﬂd
Ë 
MOSQ_ERR_NOMEM
;

78 
∑ckë
->
∑ylﬂd
[0] =Öackë->
comm™d
;

79 
i
=0; i<
∑ckë
->
ªmaöög_cou¡
; i++){

80 
∑ckë
->
∑ylﬂd
[
i
+1] = 
ªmaöög_byãs
[i];

82 
∑ckë
->
pos
 = 1 +Öackë->
ªmaöög_cou¡
;

84  
MOSQ_ERR_SUCCESS
;

85 
	}
}

87 
	$∑ckë__˛ónup
(
mosquôto__∑ckë
 *
∑ckë
)

89 if(!
∑ckë
) ;

92 
∑ckë
->
comm™d
 = 0;

93 
∑ckë
->
ªmaöög_cou¡
 = 0;

94 
∑ckë
->
ªmaöög_mu…
 = 1;

95 
∑ckë
->
ªmaöög_Àngth
 = 0;

96 
	`mosquôto__‰ì
(
∑ckë
->
∑ylﬂd
);

97 
∑ckë
->
∑ylﬂd
 = 
NULL
;

98 
∑ckë
->
to_¥o˚ss
 = 0;

99 
∑ckë
->
pos
 = 0;

100 
	}
}

103 
	$∑ckë__˛ónup_Æl
(
mosquôto
 *
mosq
)

105 
mosquôto__∑ckë
 *
∑ckë
;

107 
	`±hªad_muãx_lock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

108 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

111 if(
mosq
->
out_∑ckë
 && !mosq->
cuºít_out_∑ckë
){

112 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

113 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

115 
mosq
->
cuºít_out_∑ckë
){

116 
∑ckë
 = 
mosq
->
cuºít_out_∑ckë
;

118 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

119 if(
mosq
->
out_∑ckë
){

120 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

123 
	`∑ckë__˛ónup
(
∑ckë
);

124 
	`mosquôto__‰ì
(
∑ckë
);

127 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

129 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

130 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

131 
	}
}

134 
	$∑ckë__queue
(
mosquôto
 *
mosq
, 
mosquôto__∑ckë
 *
∑ckë
)

136 #i‚de‡
WITH_BROKER


137 
sock∑ú_d©a
 = 0;

139 
	`as£π
(
mosq
);

140 
	`as£π
(
∑ckë
);

142 
∑ckë
->
pos
 = 0;

143 
∑ckë
->
to_¥o˚ss
 =Öackë->
∑ckë_Àngth
;

145 
∑ckë
->
√xt
 = 
NULL
;

146 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

147 if(
mosq
->
out_∑ckë
){

148 
mosq
->
out_∑ckë_œ°
->
√xt
 = 
∑ckë
;

150 
mosq
->
out_∑ckë
 = 
∑ckë
;

152 
mosq
->
out_∑ckë_œ°
 = 
∑ckë
;

153 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

154 #ifde‡
WITH_BROKER


155 #ifde‡
WITH_WEBSOCKETS


156 if(
mosq
->
wsi
){

157 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

158  
MOSQ_ERR_SUCCESS
;

160  
	`∑ckë__wrôe
(
mosq
);

163  
	`∑ckë__wrôe
(
mosq
);

169 if(
mosq
->
sock∑úW
 !
INVALID_SOCKET
){

170 #i‚de‡
WIN32


171 if(
	`wrôe
(
mosq
->
sock∑úW
, &
sock∑ú_d©a
, 1)){

174 
	`£nd
(
mosq
->
sock∑úW
, &
sock∑ú_d©a
, 1, 0);

178 if(
mosq
->
ö_ˇŒback
 =
Ál£
 && mosq->
thªaded
 =
mosq_ts_n⁄e
){

179  
	`∑ckë__wrôe
(
mosq
);

181  
MOSQ_ERR_SUCCESS
;

184 
	}
}

187 
	$∑ckë__check_ovîsize
(
mosquôto
 *
mosq
, 
uöt32_t
 
ªmaöög_Àngth
)

189 
uöt32_t
 
Àn
;

191 if(
mosq
->
maximum_∑ckë_size
 =0Ë 
MOSQ_ERR_SUCCESS
;

193 
Àn
 = 
ªmaöög_Àngth
 + 
	`∑ckë__v¨öt_byãs
(remaining_length);

194 if(
Àn
 > 
mosq
->
maximum_∑ckë_size
){

195  
MOSQ_ERR_OVERSIZE_PACKET
;

197  
MOSQ_ERR_SUCCESS
;

199 
	}
}

202 
	$∑ckë__wrôe
(
mosquôto
 *
mosq
)

204 
ssize_t
 
wrôe_Àngth
;

205 
mosquôto__∑ckë
 *
∑ckë
;

206 
°©e
;

208 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

209 if(
mosq
->
sock
 =
INVALID_SOCKET
Ë 
MOSQ_ERR_NO_CONN
;

211 
	`±hªad_muãx_lock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

212 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

213 if(
mosq
->
out_∑ckë
 && !mosq->
cuºít_out_∑ckë
){

214 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

215 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

216 if(!
mosq
->
out_∑ckë
){

217 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

220 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

222 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

223 #i‡
	`deföed
(
WITH_TLS
Ë&& !deföed(
WITH_BROKER
)

224 if((
°©e
 =
mosq_cs_c⁄√˘_≥ndög
Ë|| 
mosq
->
w™t_c⁄√˘
){

226 if(
°©e
 =
mosq_cs_c⁄√˘_≥ndög
){

228 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

229  
MOSQ_ERR_SUCCESS
;

232 
mosq
->
cuºít_out_∑ckë
){

233 
∑ckë
 = 
mosq
->
cuºít_out_∑ckë
;

235 
∑ckë
->
to_¥o˚ss
 > 0){

236 
wrôe_Àngth
 = 
	`√t__wrôe
(
mosq
, &(
∑ckë
->
∑ylﬂd
[∑ckë->
pos
]),Öackë->
to_¥o˚ss
);

237 if(
wrôe_Àngth
 > 0){

238 
	`G_BYTES_SENT_INC
(
wrôe_Àngth
);

239 
∑ckë
->
to_¥o˚ss
 -
wrôe_Àngth
;

240 
∑ckë
->
pos
 +
wrôe_Àngth
;

242 #ifde‡
WIN32


243 
î∫o
 = 
	`WSAGëLa°Eº‹
();

245 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK


246 #ifde‡
WIN32


247 || 
î∫o
 =
WSAENOTCONN


250 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

251  
MOSQ_ERR_SUCCESS
;

253 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

254 
î∫o
){

255 
COMPAT_ECONNRESET
:

256  
MOSQ_ERR_CONN_LOST
;

258  
MOSQ_ERR_ERRNO
;

264 
	`G_MSGS_SENT_INC
(1);

265 if(((
∑ckë
->
comm™d
)&0xF6Ë=
CMD_PUBLISH
){

266 
	`G_PUB_MSGS_SENT_INC
(1);

267 #i‚de‡
WITH_BROKER


268 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

269 if(
mosq
->
⁄_publish
){

271 
mosq
->
ö_ˇŒback
 = 
åue
;

272 
mosq
->
	`⁄_publish
(mosq, mosq->
u£rd©a
, 
∑ckë
->
mid
);

273 
mosq
->
ö_ˇŒback
 = 
Ál£
;

275 if(
mosq
->
⁄_publish_v5
){

277 
mosq
->
ö_ˇŒback
 = 
åue
;

278 
mosq
->
	`⁄_publish_v5
(mosq, mosq->
u£rd©a
, 
∑ckë
->
mid
, 0, 
NULL
);

279 
mosq
->
ö_ˇŒback
 = 
Ál£
;

281 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

282 }if(((
∑ckë
->
comm™d
)&0xF0Ë=
CMD_DISCONNECT
){

283 
	`do_˛õ¡_disc⁄√˘
(
mosq
, 
MOSQ_ERR_SUCCESS
, 
NULL
);

284 
	`∑ckë__˛ónup
(
∑ckë
);

285 
	`mosquôto__‰ì
(
∑ckë
);

286  
MOSQ_ERR_SUCCESS
;

291 
	`±hªad_muãx_lock
(&
mosq
->
out_∑ckë_muãx
);

292 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

293 if(
mosq
->
out_∑ckë
){

294 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

295 if(!
mosq
->
out_∑ckë
){

296 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

299 
	`±hªad_muãx_u∆ock
(&
mosq
->
out_∑ckë_muãx
);

301 
	`∑ckë__˛ónup
(
∑ckë
);

302 
	`mosquôto__‰ì
(
∑ckë
);

304 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

305 
mosq
->
√xt_msg_out
 = 
	`mosquôto_time
(Ë+ mosq->
kì∑live
;

306 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

308 
	`±hªad_muãx_u∆ock
(&
mosq
->
cuºít_out_∑ckë_muãx
);

309  
MOSQ_ERR_SUCCESS
;

310 
	}
}

313 #ifde‡
WITH_BROKER


314 
	$∑ckë__ªad
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

316 
	$∑ckë__ªad
(
mosquôto
 *
mosq
)

319 
uöt8_t
 
byã
;

320 
ssize_t
 
ªad_Àngth
;

321 
rc
 = 0;

322 
°©e
;

324 if(!
mosq
){

325  
MOSQ_ERR_INVAL
;

327 if(
mosq
->
sock
 =
INVALID_SOCKET
){

328  
MOSQ_ERR_NO_CONN
;

331 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

332 if(
°©e
 =
mosq_cs_c⁄√˘_≥ndög
){

333  
MOSQ_ERR_SUCCESS
;

350 if(!
mosq
->
ö_∑ckë
.
comm™d
){

351 
ªad_Àngth
 = 
	`√t__ªad
(
mosq
, &
byã
, 1);

352 if(
ªad_Àngth
 == 1){

353 
mosq
->
ö_∑ckë
.
comm™d
 = 
byã
;

354 #ifde‡
WITH_BROKER


355 
	`G_BYTES_RECEIVED_INC
(1);

357 if(!(
mosq
->
bridge
Ë&& mosq->
°©e
 =
mosq_cs_c⁄√˘ed
 && (
byã
&0xF0Ë!
CMD_CONNECT
){

358  
MOSQ_ERR_PROTOCOL
;

362 if(
ªad_Àngth
 == 0){

363  
MOSQ_ERR_CONN_LOST
;

365 #ifde‡
WIN32


366 
î∫o
 = 
	`WSAGëLa°Eº‹
();

368 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

369  
MOSQ_ERR_SUCCESS
;

371 
î∫o
){

372 
COMPAT_ECONNRESET
:

373  
MOSQ_ERR_CONN_LOST
;

375  
MOSQ_ERR_ERRNO
;

389 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 <= 0){

391 
ªad_Àngth
 = 
	`√t__ªad
(
mosq
, &
byã
, 1);

392 if(
ªad_Àngth
 == 1){

393 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
--;

397 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 < -4){

398  
MOSQ_ERR_PROTOCOL
;

401 
	`G_BYTES_RECEIVED_INC
(1);

402 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 +(
byã
 & 127Ë* mosq->ö_∑ckë.
ªmaöög_mu…
;

403 
mosq
->
ö_∑ckë
.
ªmaöög_mu…
 *= 128;

405 if(
ªad_Àngth
 == 0){

406  
MOSQ_ERR_CONN_LOST
;

408 #ifde‡
WIN32


409 
î∫o
 = 
	`WSAGëLa°Eº‹
();

411 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

412  
MOSQ_ERR_SUCCESS
;

414 
î∫o
){

415 
COMPAT_ECONNRESET
:

416  
MOSQ_ERR_CONN_LOST
;

418  
MOSQ_ERR_ERRNO
;

422 }(
byã
 & 128) != 0);

425 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 *= -1;

427 #ifde‡
WITH_BROKER


428 if(
db
->
c⁄fig
->
max_∑ckë_size
 > 0 && 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
+1 > db->config->max_packet_size){

429 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Clõ¡ %†£¡Åoÿœrgê∑ckë %d, disc⁄√˘ög.", 
mosq
->
id
, mosq->
ö_∑ckë
.
ªmaöög_Àngth
+1);

430 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

431 
	`£nd__disc⁄√˘
(
mosq
, 
MQTT_RC_PACKET_TOO_LARGE
, 
NULL
);

433  
MOSQ_ERR_OVERSIZE_PACKET
;

438 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 0){

439 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(mosq->ö_∑ckë.
ªmaöög_Àngth
*(
uöt8_t
));

440 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

441  
MOSQ_ERR_NOMEM
;

443 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = mosq->ö_∑ckë.
ªmaöög_Àngth
;

446 
mosq
->
ö_∑ckë
.
to_¥o˚ss
>0){

447 
ªad_Àngth
 = 
	`√t__ªad
(
mosq
, &(mosq->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
]), mosq->ö_∑ckë.
to_¥o˚ss
);

448 if(
ªad_Àngth
 > 0){

449 
	`G_BYTES_RECEIVED_INC
(
ªad_Àngth
);

450 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
ªad_Àngth
;

451 
mosq
->
ö_∑ckë
.
pos
 +
ªad_Àngth
;

453 #ifde‡
WIN32


454 
î∫o
 = 
	`WSAGëLa°Eº‹
();

456 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

457 if(
mosq
->
ö_∑ckë
.
to_¥o˚ss
 > 1000){

463 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

464 
mosq
->
œ°_msg_ö
 = 
	`mosquôto_time
();

465 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

467  
MOSQ_ERR_SUCCESS
;

469 
î∫o
){

470 
COMPAT_ECONNRESET
:

471  
MOSQ_ERR_CONN_LOST
;

473  
MOSQ_ERR_ERRNO
;

480 
mosq
->
ö_∑ckë
.
pos
 = 0;

481 #ifde‡
WITH_BROKER


482 
	`G_MSGS_RECEIVED_INC
(1);

483 if(((
mosq
->
ö_∑ckë
.
comm™d
)&0xF5Ë=
CMD_PUBLISH
){

484 
	`G_PUB_MSGS_RECEIVED_INC
(1);

486 
rc
 = 
	`h™dÀ__∑ckë
(
db
, 
mosq
);

488 
rc
 = 
	`h™dÀ__∑ckë
(
mosq
);

492 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

494 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

495 
mosq
->
œ°_msg_ö
 = 
	`mosquôto_time
();

496 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

497  
rc
;

498 
	}
}

	@lib/packet_mosq.h

16 #i‚de‡
PACKET_MOSQ_H


17 
	#PACKET_MOSQ_H


	)

19 
	~"mosquôto_öã∫Æ.h
"

20 
	~"mosquôto.h
"

22 #ifde‡
WITH_BROKER


23 
	gmosquôto_db
;

26 
∑ckë__Æloc
(
mosquôto__∑ckë
 *
∑ckë
);

27 
∑ckë__˛ónup
(
mosquôto__∑ckë
 *
∑ckë
);

28 
∑ckë__˛ónup_Æl
(
mosquôto
 *
mosq
);

29 
∑ckë__queue
(
mosquôto
 *
mosq
, 
mosquôto__∑ckë
 *
∑ckë
);

31 
∑ckë__check_ovîsize
(
mosquôto
 *
mosq
, 
uöt32_t
 
ªmaöög_Àngth
);

33 
∑ckë__ªad_byã
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 *
byã
);

34 
∑ckë__ªad_byãs
(
mosquôto__∑ckë
 *
∑ckë
, *
byãs
, 
uöt32_t
 
cou¡
);

35 
∑ckë__ªad_bö¨y
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 **
d©a
, *
Àngth
);

36 
∑ckë__ªad_°rög
(
mosquôto__∑ckë
 *
∑ckë
, **
°r
, *
Àngth
);

37 
∑ckë__ªad_uöt16
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt16_t
 *
w‹d
);

38 
∑ckë__ªad_uöt32
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt32_t
 *
w‹d
);

39 
∑ckë__ªad_v¨öt
(
mosquôto__∑ckë
 *
∑ckë
, 
öt32_t
 *
w‹d
, 
öt8_t
 *
byãs
);

41 
∑ckë__wrôe_byã
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt8_t
 
byã
);

42 
∑ckë__wrôe_byãs
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° *
byãs
, 
uöt32_t
 
cou¡
);

43 
∑ckë__wrôe_°rög
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° *
°r
, 
uöt16_t
 
Àngth
);

44 
∑ckë__wrôe_uöt16
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt16_t
 
w‹d
);

45 
∑ckë__wrôe_uöt32
(
mosquôto__∑ckë
 *
∑ckë
, 
uöt32_t
 
w‹d
);

46 
∑ckë__wrôe_v¨öt
(
mosquôto__∑ckë
 *
∑ckë
, 
öt32_t
 
w‹d
);

48 
∑ckë__v¨öt_byãs
(
öt32_t
 
w‹d
);

50 
∑ckë__wrôe
(
mosquôto
 *
mosq
);

51 #ifde‡
WITH_BROKER


52 
∑ckë__ªad
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

54 
∑ckë__ªad
(
mosquôto
 *
mosq
);

	@lib/property_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°rög.h
>

23 #i‚de‡
WIN32


24 
	~<°rögs.h
>

27 
	~"loggög_mosq.h
"

28 
	~"mem‹y_mosq.h
"

29 
	~"mqâ_¥Ÿocﬁ.h
"

30 
	~"∑ckë_mosq.h
"

31 
	~"¥›îty_mosq.h
"

34 
	$¥›îty__ªad
(
mosquôto__∑ckë
 *
∑ckë
, 
öt32_t
 *
Àn
, 
mosquôto_¥›îty
 *
¥›îty
)

36 
rc
;

37 
öt32_t
 
¥›îty_idítifõr
;

38 
uöt8_t
 
byã
;

39 
öt8_t
 
byã_cou¡
;

40 
uöt16_t
 
uöt16
;

41 
uöt32_t
 
uöt32
;

42 
öt32_t
 
v¨öt
;

43 *
°r1
, *
°r2
;

44 
¶í1
, 
¶í2
;

46 if(!
¥›îty
Ë 
MOSQ_ERR_INVAL
;

48 
rc
 = 
	`∑ckë__ªad_v¨öt
(
∑ckë
, &
¥›îty_idítifõr
, 
NULL
);

49 if(
rc
) Ñc;

50 *
Àn
 -= 1;

52 
	`mem£t
(
¥›îty
, 0, (
mosquôto_¥›îty
));

54 
¥›îty
->
idítifõr
 = 
¥›îty_idítifõr
;

56 
¥›îty_idítifõr
){

57 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

58 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

59 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

60 
MQTT_PROP_MAXIMUM_QOS
:

61 
MQTT_PROP_RETAIN_AVAILABLE
:

62 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

63 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

64 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

65 
rc
 = 
	`∑ckë__ªad_byã
(
∑ckë
, &
byã
);

66 if(
rc
) Ñc;

67 *
Àn
 -= 1;

68 
¥›îty
->
vÆue
.
i8
 = 
byã
;

71 
MQTT_PROP_SERVER_KEEP_ALIVE
:

72 
MQTT_PROP_RECEIVE_MAXIMUM
:

73 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

74 
MQTT_PROP_TOPIC_ALIAS
:

75 
rc
 = 
	`∑ckë__ªad_uöt16
(
∑ckë
, &
uöt16
);

76 if(
rc
) Ñc;

77 *
Àn
 -= 2;

78 
¥›îty
->
vÆue
.
i16
 = 
uöt16
;

81 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

82 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

83 
MQTT_PROP_WILL_DELAY_INTERVAL
:

84 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

85 
rc
 = 
	`∑ckë__ªad_uöt32
(
∑ckë
, &
uöt32
);

86 if(
rc
) Ñc;

87 *
Àn
 -= 4;

88 
¥›îty
->
vÆue
.
i32
 = 
uöt32
;

91 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

92 
rc
 = 
	`∑ckë__ªad_v¨öt
(
∑ckë
, &
v¨öt
, &
byã_cou¡
);

93 if(
rc
) Ñc;

94 *
Àn
 -
byã_cou¡
;

95 
¥›îty
->
vÆue
.
v¨öt
 = varint;

98 
MQTT_PROP_CONTENT_TYPE
:

99 
MQTT_PROP_RESPONSE_TOPIC
:

100 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

101 
MQTT_PROP_AUTHENTICATION_METHOD
:

102 
MQTT_PROP_RESPONSE_INFORMATION
:

103 
MQTT_PROP_SERVER_REFERENCE
:

104 
MQTT_PROP_REASON_STRING
:

105 
rc
 = 
	`∑ckë__ªad_°rög
(
∑ckë
, &
°r1
, &
¶í1
);

106 if(
rc
) Ñc;

107 *
Àn
 = (*ÀnË- 2 - 
¶í1
;

108 
¥›îty
->
vÆue
.
s
.
v
 = 
°r1
;

109 
¥›îty
->
vÆue
.
s
.
Àn
 = 
¶í1
;

112 
MQTT_PROP_AUTHENTICATION_DATA
:

113 
MQTT_PROP_CORRELATION_DATA
:

114 
rc
 = 
	`∑ckë__ªad_bö¨y
(
∑ckë
, (
uöt8_t
 **)&
°r1
, &
¶í1
);

115 if(
rc
) Ñc;

116 *
Àn
 = (*ÀnË- 2 - 
¶í1
;

117 
¥›îty
->
vÆue
.
bö
.
v
 = 
°r1
;

118 
¥›îty
->
vÆue
.
bö
.
Àn
 = 
¶í1
;

121 
MQTT_PROP_USER_PROPERTY
:

122 
rc
 = 
	`∑ckë__ªad_°rög
(
∑ckë
, &
°r1
, &
¶í1
);

123 if(
rc
) Ñc;

124 *
Àn
 = (*ÀnË- 2 - 
¶í1
;

126 
rc
 = 
	`∑ckë__ªad_°rög
(
∑ckë
, &
°r2
, &
¶í2
);

127 if(
rc
){

128 
	`mosquôto__‰ì
(
°r1
);

129  
rc
;

131 *
Àn
 = (*ÀnË- 2 - 
¶í2
;

133 
¥›îty
->
«me
.
v
 = 
°r1
;

134 
¥›îty
->
«me
.
Àn
 = 
¶í1
;

135 
¥›îty
->
vÆue
.
s
.
v
 = 
°r2
;

136 
¥›îty
->
vÆue
.
s
.
Àn
 = 
¶í2
;

140 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Unsuµ‹ãdÖr›îtyÅy≥: %d", 
¥›îty_idítifõr
);

141  
MOSQ_ERR_MALFORMED_PACKET
;

144  
MOSQ_ERR_SUCCESS
;

145 
	}
}

148 
	$¥›îty__ªad_Æl
(
comm™d
, 
mosquôto__∑ckë
 *
∑ckë
, 
mosquôto_¥›îty
 **
¥›îtõs
)

150 
rc
;

151 
öt32_t
 
¥›Àn
;

152 
mosquôto_¥›îty
 *
p
, *
èû
 = 
NULL
;

154 
rc
 = 
	`∑ckë__ªad_v¨öt
(
∑ckë
, &
¥›Àn
, 
NULL
);

155 if(
rc
) Ñc;

157 *
¥›îtõs
 = 
NULL
;

161 
¥›Àn
 > 0){

162 
p
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

163 if(!
p
){

164 
	`mosquôto_¥›îty_‰ì_Æl
(
¥›îtõs
);

165  
MOSQ_ERR_NOMEM
;

168 
rc
 = 
	`¥›îty__ªad
(
∑ckë
, &
¥›Àn
, 
p
);

169 if(
rc
){

170 
	`mosquôto__‰ì
(
p
);

171 
	`mosquôto_¥›îty_‰ì_Æl
(
¥›îtõs
);

172  
rc
;

175 if(!(*
¥›îtõs
)){

176 *
¥›îtõs
 = 
p
;

178 
èû
->
√xt
 = 
p
;

180 
èû
 = 
p
;

184 
rc
 = 
	`mosquôto_¥›îty_check_Æl
(
comm™d
, *
¥›îtõs
);

185 if(
rc
){

186 
	`mosquôto_¥›îty_‰ì_Æl
(
¥›îtõs
);

187  
rc
;

189  
MOSQ_ERR_SUCCESS
;

190 
	}
}

193 
	$¥›îty__‰ì
(
mosquôto_¥›îty
 **
¥›îty
)

195 if(!
¥›îty
 || !(*property)) ;

197 (*
¥›îty
)->
idítifõr
){

198 
MQTT_PROP_CONTENT_TYPE
:

199 
MQTT_PROP_RESPONSE_TOPIC
:

200 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

201 
MQTT_PROP_AUTHENTICATION_METHOD
:

202 
MQTT_PROP_RESPONSE_INFORMATION
:

203 
MQTT_PROP_SERVER_REFERENCE
:

204 
MQTT_PROP_REASON_STRING
:

205 
	`mosquôto__‰ì
((*
¥›îty
)->
vÆue
.
s
.
v
);

208 
MQTT_PROP_AUTHENTICATION_DATA
:

209 
MQTT_PROP_CORRELATION_DATA
:

210 
	`mosquôto__‰ì
((*
¥›îty
)->
vÆue
.
bö
.
v
);

213 
MQTT_PROP_USER_PROPERTY
:

214 
	`mosquôto__‰ì
((*
¥›îty
)->
«me
.
v
);

215 
	`mosquôto__‰ì
((*
¥›îty
)->
vÆue
.
s
.
v
);

218 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

219 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

220 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

221 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

222 
MQTT_PROP_SERVER_KEEP_ALIVE
:

223 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

224 
MQTT_PROP_WILL_DELAY_INTERVAL
:

225 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

226 
MQTT_PROP_RECEIVE_MAXIMUM
:

227 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

228 
MQTT_PROP_TOPIC_ALIAS
:

229 
MQTT_PROP_MAXIMUM_QOS
:

230 
MQTT_PROP_RETAIN_AVAILABLE
:

231 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

232 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

233 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

234 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

239 
	`‰ì
(*
¥›îty
);

240 *
¥›îty
 = 
NULL
;

241 
	}
}

244 
	$mosquôto_¥›îty_‰ì_Æl
(
mosquôto_¥›îty
 **
¥›îty
)

246 
mosquôto_¥›îty
 *
p
, *
√xt
;

248 if(!
¥›îty
) ;

250 
p
 = *
¥›îty
;

251 
p
){

252 
√xt
 = 
p
->next;

253 
	`¥›îty__‰ì
(&
p
);

254 
p
 = 
√xt
;

256 *
¥›îty
 = 
NULL
;

257 
	}
}

260 
	$¥›îty__gë_Àngth
(c⁄° 
mosquôto_¥›îty
 *
¥›îty
)

262 if(!
¥›îty
)  0;

264 
¥›îty
->
idítifõr
){

266 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

267 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

268 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

269 
MQTT_PROP_MAXIMUM_QOS
:

270 
MQTT_PROP_RETAIN_AVAILABLE
:

271 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

272 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

273 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

277 
MQTT_PROP_SERVER_KEEP_ALIVE
:

278 
MQTT_PROP_RECEIVE_MAXIMUM
:

279 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

280 
MQTT_PROP_TOPIC_ALIAS
:

284 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

285 
MQTT_PROP_WILL_DELAY_INTERVAL
:

286 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

287 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

291 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

292 if(
¥›îty
->
vÆue
.
v¨öt
 < 128){

294 }if(
¥›îty
->
vÆue
.
v¨öt
 < 16384){

296 }if(
¥›îty
->
vÆue
.
v¨öt
 < 2097152){

298 }if(
¥›îty
->
vÆue
.
v¨öt
 < 268435456){

305 
MQTT_PROP_CORRELATION_DATA
:

306 
MQTT_PROP_AUTHENTICATION_DATA
:

307  3 + 
¥›îty
->
vÆue
.
bö
.
Àn
;

310 
MQTT_PROP_CONTENT_TYPE
:

311 
MQTT_PROP_RESPONSE_TOPIC
:

312 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

313 
MQTT_PROP_AUTHENTICATION_METHOD
:

314 
MQTT_PROP_RESPONSE_INFORMATION
:

315 
MQTT_PROP_SERVER_REFERENCE
:

316 
MQTT_PROP_REASON_STRING
:

317  3 + 
¥›îty
->
vÆue
.
s
.
Àn
;

320 
MQTT_PROP_USER_PROPERTY
:

321  5 + 
¥›îty
->
vÆue
.
s
.
Àn
 +Ör›îty->
«me
.len;

327 
	}
}

330 
	$¥›îty__gë_Àngth_Æl
(c⁄° 
mosquôto_¥›îty
 *
¥›îty
)

332 c⁄° 
mosquôto_¥›îty
 *
p
;

333 
Àn
 = 0;

335 
p
 = 
¥›îty
;

336 
p
){

337 
Àn
 +
	`¥›îty__gë_Àngth
(
p
);

338 
p
 =Ö->
√xt
;

340  
Àn
;

341 
	}
}

344 
	$¥›îty__wrôe
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° 
mosquôto_¥›îty
 *
¥›îty
)

346 
rc
;

348 
rc
 = 
	`∑ckë__wrôe_v¨öt
(
∑ckë
, 
¥›îty
->
idítifõr
);

349 if(
rc
) Ñc;

351 
¥›îty
->
idítifõr
){

352 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

353 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

354 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

355 
MQTT_PROP_MAXIMUM_QOS
:

356 
MQTT_PROP_RETAIN_AVAILABLE
:

357 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

358 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

359 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

360 
	`∑ckë__wrôe_byã
(
∑ckë
, 
¥›îty
->
vÆue
.
i8
);

363 
MQTT_PROP_SERVER_KEEP_ALIVE
:

364 
MQTT_PROP_RECEIVE_MAXIMUM
:

365 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

366 
MQTT_PROP_TOPIC_ALIAS
:

367 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
¥›îty
->
vÆue
.
i16
);

370 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

371 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

372 
MQTT_PROP_WILL_DELAY_INTERVAL
:

373 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

374 
	`∑ckë__wrôe_uöt32
(
∑ckë
, 
¥›îty
->
vÆue
.
i32
);

377 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

378  
	`∑ckë__wrôe_v¨öt
(
∑ckë
, 
¥›îty
->
vÆue
.
v¨öt
);

380 
MQTT_PROP_CONTENT_TYPE
:

381 
MQTT_PROP_RESPONSE_TOPIC
:

382 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

383 
MQTT_PROP_AUTHENTICATION_METHOD
:

384 
MQTT_PROP_RESPONSE_INFORMATION
:

385 
MQTT_PROP_SERVER_REFERENCE
:

386 
MQTT_PROP_REASON_STRING
:

387 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
¥›îty
->
vÆue
.
s
.
v
,Ör›îty->vÆue.s.
Àn
);

390 
MQTT_PROP_AUTHENTICATION_DATA
:

391 
MQTT_PROP_CORRELATION_DATA
:

392 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
¥›îty
->
vÆue
.
bö
.
Àn
);

393 
	`∑ckë__wrôe_byãs
(
∑ckë
, 
¥›îty
->
vÆue
.
bö
.
v
,Ör›îty->vÆue.bö.
Àn
);

396 
MQTT_PROP_USER_PROPERTY
:

397 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
¥›îty
->
«me
.
v
,Ör›îty->«me.
Àn
);

398 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
¥›îty
->
vÆue
.
s
.
v
,Ör›îty->vÆue.s.
Àn
);

402 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Unsuµ‹ãdÖr›îtyÅy≥: %d", 
¥›îty
->
idítifõr
);

403  
MOSQ_ERR_INVAL
;

406  
MOSQ_ERR_SUCCESS
;

407 
	}
}

410 
	$¥›îty__wrôe_Æl
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
, 
boﬁ
 
wrôe_Àn
)

412 
rc
;

413 c⁄° 
mosquôto_¥›îty
 *
p
;

415 if(
wrôe_Àn
){

416 
rc
 = 
	`∑ckë__wrôe_v¨öt
(
∑ckë
, 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
));

417 if(
rc
) Ñc;

420 
p
 = 
¥›îtõs
;

421 
p
){

422 
rc
 = 
	`¥›îty__wrôe
(
∑ckë
, 
p
);

423 if(
rc
) Ñc;

424 
p
 =Ö->
√xt
;

427  
MOSQ_ERR_SUCCESS
;

428 
	}
}

431 
	$mosquôto_¥›îty_check_comm™d
(
comm™d
, 
idítifõr
)

433 
idítifõr
){

434 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

435 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

436 
MQTT_PROP_CONTENT_TYPE
:

437 
MQTT_PROP_RESPONSE_TOPIC
:

438 
MQTT_PROP_CORRELATION_DATA
:

439 if(
comm™d
 !
CMD_PUBLISH
 && comm™d !
CMD_WILL
){

440  
MOSQ_ERR_PROTOCOL
;

444 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

445 if(
comm™d
 !
CMD_PUBLISH
 && comm™d !
CMD_SUBSCRIBE
){

446  
MOSQ_ERR_PROTOCOL
;

450 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

451 if(
comm™d
 !
CMD_CONNECT
 && comm™d !
CMD_CONNACK
 && comm™d !
CMD_DISCONNECT
){

452  
MOSQ_ERR_PROTOCOL
;

456 
MQTT_PROP_AUTHENTICATION_METHOD
:

457 
MQTT_PROP_AUTHENTICATION_DATA
:

458 if(
comm™d
 !
CMD_CONNECT
 && comm™d !
CMD_CONNACK
 && comm™d !
CMD_AUTH
){

459  
MOSQ_ERR_PROTOCOL
;

463 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

464 
MQTT_PROP_SERVER_KEEP_ALIVE
:

465 
MQTT_PROP_RESPONSE_INFORMATION
:

466 
MQTT_PROP_MAXIMUM_QOS
:

467 
MQTT_PROP_RETAIN_AVAILABLE
:

468 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

469 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

470 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

471 if(
comm™d
 !
CMD_CONNACK
){

472  
MOSQ_ERR_PROTOCOL
;

476 
MQTT_PROP_WILL_DELAY_INTERVAL
:

477 if(
comm™d
 !
CMD_WILL
){

478  
MOSQ_ERR_PROTOCOL
;

482 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

483 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

484 if(
comm™d
 !
CMD_CONNECT
){

485  
MOSQ_ERR_PROTOCOL
;

489 
MQTT_PROP_SERVER_REFERENCE
:

490 if(
comm™d
 !
CMD_CONNACK
 && comm™d !
CMD_DISCONNECT
){

491  
MOSQ_ERR_PROTOCOL
;

495 
MQTT_PROP_REASON_STRING
:

496 if(
comm™d
 =
CMD_CONNECT
 || comm™d =
CMD_PUBLISH
 || comm™d =
CMD_SUBSCRIBE
 || comm™d =
CMD_UNSUBSCRIBE
){

497  
MOSQ_ERR_PROTOCOL
;

501 
MQTT_PROP_RECEIVE_MAXIMUM
:

502 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

503 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

504 if(
comm™d
 !
CMD_CONNECT
 && comm™d !
CMD_CONNACK
){

505  
MOSQ_ERR_PROTOCOL
;

509 
MQTT_PROP_TOPIC_ALIAS
:

510 if(
comm™d
 !
CMD_PUBLISH
){

511  
MOSQ_ERR_PROTOCOL
;

515 
MQTT_PROP_USER_PROPERTY
:

519  
MOSQ_ERR_PROTOCOL
;

521  
MOSQ_ERR_SUCCESS
;

522 
	}
}

525 
	$mosquôto_°rög_to_¥›îty_öfo
(c⁄° *
¥›«me
, *
idítifõr
, *
ty≥
)

527 if(!
¥›«me
Ë 
MOSQ_ERR_INVAL
;

529 if(!
	`°rˇ£cmp
(
¥›«me
, "payload-format-indicator")){

530 *
idítifõr
 = 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
;

531 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

532 }if(!
	`°rˇ£cmp
(
¥›«me
, "message-expiry-interval")){

533 *
idítifõr
 = 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
;

534 *
ty≥
 = 
MQTT_PROP_TYPE_INT32
;

535 }if(!
	`°rˇ£cmp
(
¥›«me
, "content-type")){

536 *
idítifõr
 = 
MQTT_PROP_CONTENT_TYPE
;

537 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

538 }if(!
	`°rˇ£cmp
(
¥›«me
, "response-topic")){

539 *
idítifõr
 = 
MQTT_PROP_RESPONSE_TOPIC
;

540 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

541 }if(!
	`°rˇ£cmp
(
¥›«me
, "correlation-data")){

542 *
idítifõr
 = 
MQTT_PROP_CORRELATION_DATA
;

543 *
ty≥
 = 
MQTT_PROP_TYPE_BINARY
;

544 }if(!
	`°rˇ£cmp
(
¥›«me
, "subscription-identifier")){

545 *
idítifõr
 = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

546 *
ty≥
 = 
MQTT_PROP_TYPE_VARINT
;

547 }if(!
	`°rˇ£cmp
(
¥›«me
, "session-expiry-interval")){

548 *
idítifõr
 = 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
;

549 *
ty≥
 = 
MQTT_PROP_TYPE_INT32
;

550 }if(!
	`°rˇ£cmp
(
¥›«me
, "assigned-client-identifier")){

551 *
idítifõr
 = 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
;

552 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

553 }if(!
	`°rˇ£cmp
(
¥›«me
, "server-keep-alive")){

554 *
idítifõr
 = 
MQTT_PROP_SERVER_KEEP_ALIVE
;

555 *
ty≥
 = 
MQTT_PROP_TYPE_INT16
;

556 }if(!
	`°rˇ£cmp
(
¥›«me
, "authentication-method")){

557 *
idítifõr
 = 
MQTT_PROP_AUTHENTICATION_METHOD
;

558 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

559 }if(!
	`°rˇ£cmp
(
¥›«me
, "authentication-data")){

560 *
idítifõr
 = 
MQTT_PROP_AUTHENTICATION_DATA
;

561 *
ty≥
 = 
MQTT_PROP_TYPE_BINARY
;

562 }if(!
	`°rˇ£cmp
(
¥›«me
, "request-problem-information")){

563 *
idítifõr
 = 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
;

564 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

565 }if(!
	`°rˇ£cmp
(
¥›«me
, "will-delay-interval")){

566 *
idítifõr
 = 
MQTT_PROP_WILL_DELAY_INTERVAL
;

567 *
ty≥
 = 
MQTT_PROP_TYPE_INT32
;

568 }if(!
	`°rˇ£cmp
(
¥›«me
, "request-response-information")){

569 *
idítifõr
 = 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
;

570 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

571 }if(!
	`°rˇ£cmp
(
¥›«me
, "response-information")){

572 *
idítifõr
 = 
MQTT_PROP_RESPONSE_INFORMATION
;

573 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

574 }if(!
	`°rˇ£cmp
(
¥›«me
, "server-reference")){

575 *
idítifõr
 = 
MQTT_PROP_SERVER_REFERENCE
;

576 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

577 }if(!
	`°rˇ£cmp
(
¥›«me
, "reason-string")){

578 *
idítifõr
 = 
MQTT_PROP_REASON_STRING
;

579 *
ty≥
 = 
MQTT_PROP_TYPE_STRING
;

580 }if(!
	`°rˇ£cmp
(
¥›«me
, "receive-maximum")){

581 *
idítifõr
 = 
MQTT_PROP_RECEIVE_MAXIMUM
;

582 *
ty≥
 = 
MQTT_PROP_TYPE_INT16
;

583 }if(!
	`°rˇ£cmp
(
¥›«me
, "topic-alias-maximum")){

584 *
idítifõr
 = 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
;

585 *
ty≥
 = 
MQTT_PROP_TYPE_INT16
;

586 }if(!
	`°rˇ£cmp
(
¥›«me
, "topic-alias")){

587 *
idítifõr
 = 
MQTT_PROP_TOPIC_ALIAS
;

588 *
ty≥
 = 
MQTT_PROP_TYPE_INT16
;

589 }if(!
	`°rˇ£cmp
(
¥›«me
, "maximum-qos")){

590 *
idítifõr
 = 
MQTT_PROP_MAXIMUM_QOS
;

591 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

592 }if(!
	`°rˇ£cmp
(
¥›«me
, "retain-available")){

593 *
idítifõr
 = 
MQTT_PROP_RETAIN_AVAILABLE
;

594 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

595 }if(!
	`°rˇ£cmp
(
¥›«me
, "user-property")){

596 *
idítifõr
 = 
MQTT_PROP_USER_PROPERTY
;

597 *
ty≥
 = 
MQTT_PROP_TYPE_STRING_PAIR
;

598 }if(!
	`°rˇ£cmp
(
¥›«me
, "maximum-packet-size")){

599 *
idítifõr
 = 
MQTT_PROP_MAXIMUM_PACKET_SIZE
;

600 *
ty≥
 = 
MQTT_PROP_TYPE_INT32
;

601 }if(!
	`°rˇ£cmp
(
¥›«me
, "wildcard-subscription-available")){

602 *
idítifõr
 = 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
;

603 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

604 }if(!
	`°rˇ£cmp
(
¥›«me
, "subscription-identifier-available")){

605 *
idítifõr
 = 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
;

606 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

607 }if(!
	`°rˇ£cmp
(
¥›«me
, "shared-subscription-available")){

608 *
idítifõr
 = 
MQTT_PROP_SHARED_SUB_AVAILABLE
;

609 *
ty≥
 = 
MQTT_PROP_TYPE_BYTE
;

611  
MOSQ_ERR_INVAL
;

613  
MOSQ_ERR_SUCCESS
;

614 
	}
}

617 
	$¥›îty__add
(
mosquôto_¥›îty
 **
¥›li°
, 
mqâ5__¥›îty
 *
¥›
)

619 
mosquôto_¥›îty
 *
p
;

621 if(!(*
¥›li°
)){

622 *
¥›li°
 = 
¥›
;

625 
p
 = *
¥›li°
;

626 
p
->
√xt
){

627 
p
 =Ö->
√xt
;

629 
p
->
√xt
 = 
¥›
;

630 
¥›
->
√xt
 = 
NULL
;

631 
	}
}

634 
	$mosquôto_¥›îty_add_byã
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt8_t
 
vÆue
)

636 
mosquôto_¥›îty
 *
¥›
;

638 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

639 if(
idítifõr
 !
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR


640 && 
idítifõr
 !
MQTT_PROP_REQUEST_PROBLEM_INFORMATION


641 && 
idítifõr
 !
MQTT_PROP_REQUEST_RESPONSE_INFORMATION


642 && 
idítifõr
 !
MQTT_PROP_MAXIMUM_QOS


643 && 
idítifõr
 !
MQTT_PROP_RETAIN_AVAILABLE


644 && 
idítifõr
 !
MQTT_PROP_WILDCARD_SUB_AVAILABLE


645 && 
idítifõr
 !
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE


646 && 
idítifõr
 !
MQTT_PROP_SHARED_SUB_AVAILABLE
){

647  
MOSQ_ERR_INVAL
;

650 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

651 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

653 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

654 
¥›
->
idítifõr
 = identifier;

655 
¥›
->
vÆue
.
i8
 = value;

657 
	`¥›îty__add
(
¥›li°
, 
¥›
);

658  
MOSQ_ERR_SUCCESS
;

659 
	}
}

662 
	$mosquôto_¥›îty_add_öt16
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt16_t
 
vÆue
)

664 
mosquôto_¥›îty
 *
¥›
;

666 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

667 if(
idítifõr
 !
MQTT_PROP_SERVER_KEEP_ALIVE


668 && 
idítifõr
 !
MQTT_PROP_RECEIVE_MAXIMUM


669 && 
idítifõr
 !
MQTT_PROP_TOPIC_ALIAS_MAXIMUM


670 && 
idítifõr
 !
MQTT_PROP_TOPIC_ALIAS
){

671  
MOSQ_ERR_INVAL
;

674 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

675 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

677 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

678 
¥›
->
idítifõr
 = identifier;

679 
¥›
->
vÆue
.
i16
 = value;

681 
	`¥›îty__add
(
¥›li°
, 
¥›
);

682  
MOSQ_ERR_SUCCESS
;

683 
	}
}

686 
	$mosquôto_¥›îty_add_öt32
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt32_t
 
vÆue
)

688 
mosquôto_¥›îty
 *
¥›
;

690 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

691 if(
idítifõr
 !
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL


692 && 
idítifõr
 !
MQTT_PROP_SESSION_EXPIRY_INTERVAL


693 && 
idítifõr
 !
MQTT_PROP_WILL_DELAY_INTERVAL


694 && 
idítifõr
 !
MQTT_PROP_MAXIMUM_PACKET_SIZE
){

696  
MOSQ_ERR_INVAL
;

699 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

700 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

702 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

703 
¥›
->
idítifõr
 = identifier;

704 
¥›
->
vÆue
.
i32
 = value;

706 
	`¥›îty__add
(
¥›li°
, 
¥›
);

707  
MOSQ_ERR_SUCCESS
;

708 
	}
}

711 
	$mosquôto_¥›îty_add_v¨öt
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, 
uöt32_t
 
vÆue
)

713 
mosquôto_¥›îty
 *
¥›
;

715 if(!
¥›li°
 || 
vÆue
 > 268435455Ë 
MOSQ_ERR_INVAL
;

716 if(
idítifõr
 !
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
Ë 
MOSQ_ERR_INVAL
;

718 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

719 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

721 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

722 
¥›
->
idítifõr
 = identifier;

723 
¥›
->
vÆue
.
v¨öt
 = value;

725 
	`¥›îty__add
(
¥›li°
, 
¥›
);

726  
MOSQ_ERR_SUCCESS
;

727 
	}
}

730 
	$mosquôto_¥›îty_add_bö¨y
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
vÆue
, 
uöt16_t
 
Àn
)

732 
mosquôto_¥›îty
 *
¥›
;

734 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

735 if(
idítifõr
 !
MQTT_PROP_CORRELATION_DATA


736 && 
idítifõr
 !
MQTT_PROP_AUTHENTICATION_DATA
){

738  
MOSQ_ERR_INVAL
;

741 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

742 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

744 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

745 
¥›
->
idítifõr
 = identifier;

747 if(
Àn
){

748 
¥›
->
vÆue
.
bö
.
v
 = 
	`mosquôto__mÆloc
(
Àn
);

749 if(!
¥›
->
vÆue
.
bö
.
v
){

750 
	`mosquôto__‰ì
(
¥›
);

751  
MOSQ_ERR_NOMEM
;

754 
	`mem˝y
(
¥›
->
vÆue
.
bö
.
v
, vÆue, 
Àn
);

755 
¥›
->
vÆue
.
bö
.
Àn
 =Üen;

758 
	`¥›îty__add
(
¥›li°
, 
¥›
);

759  
MOSQ_ERR_SUCCESS
;

760 
	}
}

763 
	$mosquôto_¥›îty_add_°rög
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
vÆue
)

765 
mosquôto_¥›îty
 *
¥›
;

767 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

768 if(
vÆue
){

769 if(
	`mosquôto_vÆid©e_utf8
(
vÆue
, 
	`°æí
(vÆue))Ë 
MOSQ_ERR_MALFORMED_UTF8
;

772 if(
idítifõr
 !
MQTT_PROP_CONTENT_TYPE


773 && 
idítifõr
 !
MQTT_PROP_RESPONSE_TOPIC


774 && 
idítifõr
 !
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER


775 && 
idítifõr
 !
MQTT_PROP_AUTHENTICATION_METHOD


776 && 
idítifõr
 !
MQTT_PROP_RESPONSE_INFORMATION


777 && 
idítifõr
 !
MQTT_PROP_SERVER_REFERENCE


778 && 
idítifõr
 !
MQTT_PROP_REASON_STRING
){

780  
MOSQ_ERR_INVAL
;

783 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

784 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

786 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

787 
¥›
->
idítifõr
 = identifier;

788 if(
vÆue
 && 
	`°æí
(value)){

789 
¥›
->
vÆue
.
s
.
v
 = 
	`mosquôto__°rdup
(value);

790 if(!
¥›
->
vÆue
.
s
.
v
){

791 
	`mosquôto__‰ì
(
¥›
);

792  
MOSQ_ERR_NOMEM
;

794 
¥›
->
vÆue
.
s
.
Àn
 = 
	`°æí
(value);

797 
	`¥›îty__add
(
¥›li°
, 
¥›
);

798  
MOSQ_ERR_SUCCESS
;

799 
	}
}

802 
	$mosquôto_¥›îty_add_°rög_∑ú
(
mosquôto_¥›îty
 **
¥›li°
, 
idítifõr
, c⁄° *
«me
, c⁄° *
vÆue
)

804 
mosquôto_¥›îty
 *
¥›
;

806 if(!
¥›li°
Ë 
MOSQ_ERR_INVAL
;

807 if(
idítifõr
 !
MQTT_PROP_USER_PROPERTY
Ë 
MOSQ_ERR_INVAL
;

808 if(
«me
){

809 if(
	`mosquôto_vÆid©e_utf8
(
«me
, 
	`°æí
“ame))Ë 
MOSQ_ERR_MALFORMED_UTF8
;

811 if(
vÆue
){

812 if(
	`mosquôto_vÆid©e_utf8
(
vÆue
, 
	`°æí
(vÆue))Ë 
MOSQ_ERR_MALFORMED_UTF8
;

815 
¥›
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_¥›îty
));

816 if(!
¥›
Ë 
MOSQ_ERR_NOMEM
;

818 
¥›
->
˛õ¡_gíî©ed
 = 
åue
;

819 
¥›
->
idítifõr
 = identifier;

821 if(
«me
 && 
	`°æí
(name)){

822 
¥›
->
«me
.
v
 = 
	`mosquôto__°rdup
(name);

823 if(!
¥›
->
«me
.
v
){

824 
	`mosquôto__‰ì
(
¥›
);

825  
MOSQ_ERR_NOMEM
;

827 
¥›
->
«me
.
Àn
 = 
	`°æí
(name);

830 if(
vÆue
 && 
	`°æí
(value)){

831 
¥›
->
vÆue
.
s
.
v
 = 
	`mosquôto__°rdup
(value);

832 if(!
¥›
->
vÆue
.
s
.
v
){

833 
	`mosquôto__‰ì
(
¥›
->
«me
.
v
);

834 
	`mosquôto__‰ì
(
¥›
);

835  
MOSQ_ERR_NOMEM
;

837 
¥›
->
vÆue
.
s
.
Àn
 = 
	`°æí
(value);

840 
	`¥›îty__add
(
¥›li°
, 
¥›
);

841  
MOSQ_ERR_SUCCESS
;

842 
	}
}

844 
	$mosquôto_¥›îty_check_Æl
(
comm™d
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

846 c⁄° 
mosquôto_¥›îty
 *
p
, *
èû
;

847 
rc
;

849 
p
 = 
¥›îtõs
;

851 
p
){

853 if(
p
->
idítifõr
 =
MQTT_PROP_REQUEST_PROBLEM_INFORMATION


854 || 
p
->
idítifõr
 =
MQTT_PROP_REQUEST_RESPONSE_INFORMATION


855 || 
p
->
idítifõr
 =
MQTT_PROP_MAXIMUM_QOS


856 || 
p
->
idítifõr
 =
MQTT_PROP_RETAIN_AVAILABLE


857 || 
p
->
idítifõr
 =
MQTT_PROP_WILDCARD_SUB_AVAILABLE


858 || 
p
->
idítifõr
 =
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE


859 || 
p
->
idítifõr
 =
MQTT_PROP_SHARED_SUB_AVAILABLE
){

861 if(
p
->
vÆue
.
i8
 > 1){

862  
MOSQ_ERR_PROTOCOL
;

864 }if(
p
->
idítifõr
 =
MQTT_PROP_MAXIMUM_PACKET_SIZE
){

865 if–
p
->
vÆue
.
i32
 == 0){

866  
MOSQ_ERR_PROTOCOL
;

868 }if(
p
->
idítifõr
 =
MQTT_PROP_RECEIVE_MAXIMUM


869 || 
p
->
idítifõr
 =
MQTT_PROP_TOPIC_ALIAS
){

871 if(
p
->
vÆue
.
i16
 == 0){

872  
MOSQ_ERR_PROTOCOL
;

877 
rc
 = 
	`mosquôto_¥›îty_check_comm™d
(
comm™d
, 
p
->
idítifõr
);

878 if(
rc
) Ñc;

881 
èû
 = 
p
->
√xt
;

882 
èû
){

883 if(
p
->
idítifõr
 =
èû
->identifier

884 && 
p
->
idítifõr
 !
MQTT_PROP_USER_PROPERTY
){

886  
MOSQ_ERR_DUPLICATE_PROPERTY
;

888 
èû
 =Åaû->
√xt
;

891 
p
 =Ö->
√xt
;

894  
MOSQ_ERR_SUCCESS
;

895 
	}
}

897 c⁄° 
mosquôto_¥›îty
 *
	$¥›îty__gë_¥›îty
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
boﬁ
 
skù_fú°
)

899 c⁄° 
mosquôto_¥›îty
 *
p
;

900 
boﬁ
 
is_fú°
 = 
åue
;

902 
p
 = 
¥›li°
;

904 
p
){

905 if(
p
->
idítifõr
 == identifier){

906 if(!
is_fú°
 || !
skù_fú°
){

907  
p
;

909 
is_fú°
 = 
Ál£
;

911 
p
 =Ö->
√xt
;

913  
NULL
;

914 
	}
}

917 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_byã
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt8_t
 *
vÆue
, 
boﬁ
 
skù_fú°
)

919 c⁄° 
mosquôto_¥›îty
 *
p
;

920 if(!
¥›li°
Ë 
NULL
;

922 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

923 if(!
p
Ë 
NULL
;

924 if(
p
->
idítifõr
 !
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR


925 && 
p
->
idítifõr
 !
MQTT_PROP_REQUEST_PROBLEM_INFORMATION


926 && 
p
->
idítifõr
 !
MQTT_PROP_REQUEST_RESPONSE_INFORMATION


927 && 
p
->
idítifõr
 !
MQTT_PROP_MAXIMUM_QOS


928 && 
p
->
idítifõr
 !
MQTT_PROP_RETAIN_AVAILABLE


929 && 
p
->
idítifõr
 !
MQTT_PROP_WILDCARD_SUB_AVAILABLE


930 && 
p
->
idítifõr
 !
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE


931 && 
p
->
idítifõr
 !
MQTT_PROP_SHARED_SUB_AVAILABLE
){

932  
NULL
;

935 if(
vÆue
Ë*vÆuê
p
->vÆue.
i8
;

937  
p
;

938 
	}
}

941 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_öt16
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt16_t
 *
vÆue
, 
boﬁ
 
skù_fú°
)

943 c⁄° 
mosquôto_¥›îty
 *
p
;

944 if(!
¥›li°
Ë 
NULL
;

946 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

947 if(!
p
Ë 
NULL
;

948 if(
p
->
idítifõr
 !
MQTT_PROP_SERVER_KEEP_ALIVE


949 && 
p
->
idítifõr
 !
MQTT_PROP_RECEIVE_MAXIMUM


950 && 
p
->
idítifõr
 !
MQTT_PROP_TOPIC_ALIAS_MAXIMUM


951 && 
p
->
idítifõr
 !
MQTT_PROP_TOPIC_ALIAS
){

952  
NULL
;

955 if(
vÆue
Ë*vÆuê
p
->vÆue.
i16
;

957  
p
;

958 
	}
}

961 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_öt32
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt32_t
 *
vÆue
, 
boﬁ
 
skù_fú°
)

963 c⁄° 
mosquôto_¥›îty
 *
p
;

964 if(!
¥›li°
Ë 
NULL
;

966 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

967 if(!
p
Ë 
NULL
;

968 if(
p
->
idítifõr
 !
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL


969 && 
p
->
idítifõr
 !
MQTT_PROP_SESSION_EXPIRY_INTERVAL


970 && 
p
->
idítifõr
 !
MQTT_PROP_WILL_DELAY_INTERVAL


971 && 
p
->
idítifõr
 !
MQTT_PROP_MAXIMUM_PACKET_SIZE
){

973  
NULL
;

976 if(
vÆue
Ë*vÆuê
p
->vÆue.
i32
;

978  
p
;

979 
	}
}

982 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_v¨öt
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt32_t
 *
vÆue
, 
boﬁ
 
skù_fú°
)

984 c⁄° 
mosquôto_¥›îty
 *
p
;

985 if(!
¥›li°
Ë 
NULL
;

987 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

988 if(!
p
Ë 
NULL
;

989 if(
p
->
idítifõr
 !
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
){

990  
NULL
;

993 if(
vÆue
Ë*vÆuê
p
->vÆue.
v¨öt
;

995  
p
;

996 
	}
}

999 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_bö¨y
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, **
vÆue
, 
uöt16_t
 *
Àn
, 
boﬁ
 
skù_fú°
)

1001 c⁄° 
mosquôto_¥›îty
 *
p
;

1002 if(!
¥›li°
 || (
vÆue
 && !
Àn
Ë|| (!vÆuê&&Üí)Ë 
NULL
;

1004 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

1005 if(!
p
Ë 
NULL
;

1006 if(
p
->
idítifõr
 !
MQTT_PROP_CORRELATION_DATA


1007 && 
p
->
idítifõr
 !
MQTT_PROP_AUTHENTICATION_DATA
){

1009  
NULL
;

1012 if(
vÆue
){

1013 *
Àn
 = 
p
->
vÆue
.
bö
.len;

1014 *
vÆue
 = 
	`mÆloc
(*
Àn
);

1015 if(!(*
vÆue
)Ë 
NULL
;

1017 
	`mem˝y
(*
vÆue
, 
p
->vÆue.
bö
.
v
, *
Àn
);

1020  
p
;

1021 
	}
}

1024 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_°rög
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, **
vÆue
, 
boﬁ
 
skù_fú°
)

1026 c⁄° 
mosquôto_¥›îty
 *
p
;

1027 if(!
¥›li°
Ë 
NULL
;

1029 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

1030 if(!
p
Ë 
NULL
;

1031 if(
p
->
idítifõr
 !
MQTT_PROP_CONTENT_TYPE


1032 && 
p
->
idítifõr
 !
MQTT_PROP_RESPONSE_TOPIC


1033 && 
p
->
idítifõr
 !
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER


1034 && 
p
->
idítifõr
 !
MQTT_PROP_AUTHENTICATION_METHOD


1035 && 
p
->
idítifõr
 !
MQTT_PROP_RESPONSE_INFORMATION


1036 && 
p
->
idítifõr
 !
MQTT_PROP_SERVER_REFERENCE


1037 && 
p
->
idítifõr
 !
MQTT_PROP_REASON_STRING
){

1039  
NULL
;

1042 if(
vÆue
){

1043 *
vÆue
 = 
	`ˇŒoc
(1, 
p
->vÆue.
s
.
Àn
+1);

1044 if(!(*
vÆue
)Ë 
NULL
;

1046 
	`mem˝y
(*
vÆue
, 
p
->vÆue.
s
.
v
,Ö->vÆue.s.
Àn
);

1049  
p
;

1050 
	}
}

1053 c⁄° 
mosquôto_¥›îty
 *
	$mosquôto_¥›îty_ªad_°rög_∑ú
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, **
«me
, **
vÆue
, 
boﬁ
 
skù_fú°
)

1055 c⁄° 
mosquôto_¥›îty
 *
p
;

1056 if(!
¥›li°
Ë 
NULL
;

1058 
p
 = 
	`¥›îty__gë_¥›îty
(
¥›li°
, 
idítifõr
, 
skù_fú°
);

1059 if(!
p
Ë 
NULL
;

1060 if(
p
->
idítifõr
 !
MQTT_PROP_USER_PROPERTY
Ë 
NULL
;

1062 if(
«me
){

1063 *
«me
 = 
	`ˇŒoc
(1, 
p
->«me.
Àn
+1);

1064 if(!(*
«me
)Ë 
NULL
;

1065 
	`mem˝y
(*
«me
, 
p
->«me.
v
,Ö->«me.
Àn
);

1068 if(
vÆue
){

1069 *
vÆue
 = 
	`ˇŒoc
(1, 
p
->vÆue.
s
.
Àn
+1);

1070 if(!(*
vÆue
)){

1071 if(
«me
){

1072 
	`‰ì
(*
«me
);

1073 *
«me
 = 
NULL
;

1075  
NULL
;

1077 
	`mem˝y
(*
vÆue
, 
p
->vÆue.
s
.
v
,Ö->vÆue.s.
Àn
);

1080  
p
;

1081 
	}
}

1084 
	$mosquôto_¥›îty_c›y_Æl
(
mosquôto_¥›îty
 **
de°
, c⁄° mosquôto_¥›îty *
§c
)

1086 
mosquôto_¥›îty
 *
≤ew
, *
∂a°
 = 
NULL
;

1088 if(!
§c
Ë 
MOSQ_ERR_SUCCESS
;

1089 if(!
de°
Ë 
MOSQ_ERR_INVAL
;

1091 *
de°
 = 
NULL
;

1093 
§c
){

1094 
≤ew
 = 
	`ˇŒoc
(1, (
mosquôto_¥›îty
));

1095 if(!
≤ew
){

1096 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1097  
MOSQ_ERR_NOMEM
;

1099 if(
∂a°
){

1100 
∂a°
->
√xt
 = 
≤ew
;

1102 *
de°
 = 
≤ew
;

1104 
∂a°
 = 
≤ew
;

1106 
≤ew
->
idítifõr
 = 
§c
->identifier;

1107 
≤ew
->
idítifõr
){

1108 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

1109 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
:

1110 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
:

1111 
MQTT_PROP_MAXIMUM_QOS
:

1112 
MQTT_PROP_RETAIN_AVAILABLE
:

1113 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
:

1114 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
:

1115 
MQTT_PROP_SHARED_SUB_AVAILABLE
:

1116 
≤ew
->
vÆue
.
i8
 = 
§c
->value.i8;

1119 
MQTT_PROP_SERVER_KEEP_ALIVE
:

1120 
MQTT_PROP_RECEIVE_MAXIMUM
:

1121 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
:

1122 
MQTT_PROP_TOPIC_ALIAS
:

1123 
≤ew
->
vÆue
.
i16
 = 
§c
->value.i16;

1126 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

1127 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
:

1128 
MQTT_PROP_WILL_DELAY_INTERVAL
:

1129 
MQTT_PROP_MAXIMUM_PACKET_SIZE
:

1130 
≤ew
->
vÆue
.
i32
 = 
§c
->value.i32;

1133 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

1134 
≤ew
->
vÆue
.
v¨öt
 = 
§c
->value.varint;

1137 
MQTT_PROP_CONTENT_TYPE
:

1138 
MQTT_PROP_RESPONSE_TOPIC
:

1139 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
:

1140 
MQTT_PROP_AUTHENTICATION_METHOD
:

1141 
MQTT_PROP_RESPONSE_INFORMATION
:

1142 
MQTT_PROP_SERVER_REFERENCE
:

1143 
MQTT_PROP_REASON_STRING
:

1144 
≤ew
->
vÆue
.
s
.
Àn
 = 
§c
->value.s.len;

1145 
≤ew
->
vÆue
.
s
.
v
 = 
	`°rdup
(
§c
->value.s.v);

1146 if(!
≤ew
->
vÆue
.
s
.
v
){

1147 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1148  
MOSQ_ERR_NOMEM
;

1152 
MQTT_PROP_AUTHENTICATION_DATA
:

1153 
MQTT_PROP_CORRELATION_DATA
:

1154 
≤ew
->
vÆue
.
bö
.
Àn
 = 
§c
->value.bin.len;

1155 
≤ew
->
vÆue
.
bö
.
v
 = 
	`mÆloc
’√w->vÆue.bö.
Àn
);

1156 if(!
≤ew
->
vÆue
.
bö
.
v
){

1157 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1158  
MOSQ_ERR_NOMEM
;

1160 
	`mem˝y
(
≤ew
->
vÆue
.
bö
.
v
, 
§c
->vÆue.bö.v,Ö√w->vÆue.bö.
Àn
);

1163 
MQTT_PROP_USER_PROPERTY
:

1164 
≤ew
->
vÆue
.
s
.
Àn
 = 
§c
->value.s.len;

1165 
≤ew
->
vÆue
.
s
.
v
 = 
	`°rdup
(
§c
->value.s.v);

1166 if(!
≤ew
->
vÆue
.
s
.
v
){

1167 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1168  
MOSQ_ERR_NOMEM
;

1171 
≤ew
->
«me
.
Àn
 = 
§c
->name.len;

1172 
≤ew
->
«me
.
v
 = 
	`°rdup
(
§c
->name.v);

1173 if(!
≤ew
->
«me
.
v
){

1174 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1175  
MOSQ_ERR_NOMEM
;

1180 
	`mosquôto_¥›îty_‰ì_Æl
(
de°
);

1181  
MOSQ_ERR_INVAL
;

1184 
§c
 = src->
√xt
;

1187  
MOSQ_ERR_SUCCESS
;

1188 
	}
}

	@lib/property_mosq.h

16 #i‚de‡
PROPERTY_MOSQ_H


17 
	#PROPERTY_MOSQ_H


	)

19 
	~"mosquôto_öã∫Æ.h
"

20 
	~"mosquôto.h
"

22 
	smqâ__°rög
 {

23 *
	mv
;

24 
	mÀn
;

27 
	smqâ5__¥›îty
 {

28 
mqâ5__¥›îty
 *
	m√xt
;

30 
uöt8_t
 
	mi8
;

31 
uöt16_t
 
	mi16
;

32 
uöt32_t
 
	mi32
;

33 
uöt32_t
 
	mv¨öt
;

34 
mqâ__°rög
 
	mbö
;

35 
mqâ__°rög
 
	ms
;

36 } 
	mvÆue
;

37 
mqâ__°rög
 
	m«me
;

38 
öt32_t
 
	midítifõr
;

39 
boﬁ
 
	m˛õ¡_gíî©ed
;

43 
¥›îty__ªad_Æl
(
comm™d
, 
mosquôto__∑ckë
 *
∑ckë
, 
mosquôto_¥›îty
 **
¥›îty
);

44 
¥›îty__wrôe_Æl
(
mosquôto__∑ckë
 *
∑ckë
, c⁄° 
mosquôto_¥›îty
 *
¥›îty
, 
boﬁ
 
wrôe_Àn
);

45 
¥›îty__‰ì
(
mosquôto_¥›îty
 **
¥›îty
);

47 
¥›îty__gë_Àngth
(c⁄° 
mosquôto_¥›îty
 *
¥›îty
);

48 
¥›îty__gë_Àngth_Æl
(c⁄° 
mosquôto_¥›îty
 *
¥›îty
);

	@lib/read_handle.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 
	~"mosquôto.h
"

24 
	~"loggög_mosq.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"mesßges_mosq.h
"

27 
	~"mqâ_¥Ÿocﬁ.h
"

28 
	~"√t_mosq.h
"

29 
	~"∑ckë_mosq.h
"

30 
	~"ªad_h™dÀ.h
"

31 
	~"£nd_mosq.h
"

32 
	~"time_mosq.h
"

33 
	~"utû_mosq.h
"

35 
	$h™dÀ__∑ckë
(
mosquôto
 *
mosq
)

37 
	`as£π
(
mosq
);

39 (
mosq
->
ö_∑ckë
.
comm™d
)&0xF0){

40 
CMD_PINGREQ
:

41  
	`h™dÀ__pögªq
(
mosq
);

42 
CMD_PINGRESP
:

43  
	`h™dÀ__pögª•
(
mosq
);

44 
CMD_PUBACK
:

45  
	`h™dÀ__pubackcomp
(
mosq
, "PUBACK");

46 
CMD_PUBCOMP
:

47  
	`h™dÀ__pubackcomp
(
mosq
, "PUBCOMP");

48 
CMD_PUBLISH
:

49  
	`h™dÀ__publish
(
mosq
);

50 
CMD_PUBREC
:

51  
	`h™dÀ__pubªc
(
NULL
, 
mosq
);

52 
CMD_PUBREL
:

53  
	`h™dÀ__pubªl
(
NULL
, 
mosq
);

54 
CMD_CONNACK
:

55  
	`h™dÀ__c⁄«ck
(
mosq
);

56 
CMD_SUBACK
:

57  
	`h™dÀ__suback
(
mosq
);

58 
CMD_UNSUBACK
:

59  
	`h™dÀ__unsuback
(
mosq
);

60 
CMD_DISCONNECT
:

61  
	`h™dÀ__disc⁄√˘
(
mosq
);

62 
CMD_AUTH
:

63  
	`h™dÀ__auth
(
mosq
);

66 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: Uƒecogni£d comm™d %d\n", (mosq->
ö_∑ckë
.
comm™d
)&0xF0);

67  
MOSQ_ERR_PROTOCOL
;

69 
	}
}

	@lib/read_handle.h

16 #i‚de‡
READ_HANDLE_H


17 
	#READ_HANDLE_H


	)

19 
	~"mosquôto.h
"

20 
	gmosquôto_db
;

22 
h™dÀ__pögªq
(
mosquôto
 *
mosq
);

23 
h™dÀ__pögª•
(
mosquôto
 *
mosq
);

24 #ifde‡
WITH_BROKER


25 
h™dÀ__pubackcomp
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
, c⁄° *
ty≥
);

27 
h™dÀ__∑ckë
(
mosquôto
 *
mosq
);

28 
h™dÀ__c⁄«ck
(
mosquôto
 *
mosq
);

29 
h™dÀ__disc⁄√˘
(
mosquôto
 *
mosq
);

30 
h™dÀ__pubackcomp
(
mosquôto
 *
mosq
, c⁄° *
ty≥
);

31 
h™dÀ__publish
(
mosquôto
 *
mosq
);

32 
h™dÀ__auth
(
mosquôto
 *
mosq
);

34 
h™dÀ__pubªc
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

35 
h™dÀ__pubªl
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

36 
h™dÀ__suback
(
mosquôto
 *
mosq
);

37 
h™dÀ__unsuback
(
mosquôto
 *
mosq
);

	@lib/send_connect.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WITH_BROKER


23 
	~"mosquôto_brokî_öã∫Æ.h
"

26 
	~"loggög_mosq.h
"

27 
	~"mem‹y_mosq.h
"

28 
	~"mosquôto.h
"

29 
	~"mosquôto_öã∫Æ.h
"

30 
	~"mqâ_¥Ÿocﬁ.h
"

31 
	~"∑ckë_mosq.h
"

32 
	~"¥›îty_mosq.h
"

34 
	$£nd__c⁄√˘
(
mosquôto
 *
mosq
, 
uöt16_t
 
kì∑live
, 
boﬁ
 
˛ón_£ssi⁄
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

36 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

37 
∑ylﬂdÀn
;

38 
uöt8_t
 
wûl
 = 0;

39 
uöt8_t
 
byã
;

40 
rc
;

41 
uöt8_t
 
vîsi⁄
;

42 *
˛õ¡id
, *
u£∫ame
, *
∑ssw‹d
;

43 
hódîÀn
;

44 
¥›Àn
 = 0, 
wûl_¥›Àn
, 
v¨byãs
;

45 
mosquôto_¥›îty
 *
loˇl_¥›s
 = 
NULL
;

46 
uöt16_t
 
ª˚ive_maximum
;

48 
	`as£π
(
mosq
);

50 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 && !mosq->
id
Ë 
MOSQ_ERR_PROTOCOL
;

52 #i‡
	`deföed
(
WITH_BROKER
Ë&& deföed(
WITH_BRIDGE
)

53 if(
mosq
->
bridge
){

54 
˛õ¡id
 = 
mosq
->
bridge
->
ªmŸe_˛õ¡id
;

55 
u£∫ame
 = 
mosq
->
bridge
->
ªmŸe_u£∫ame
;

56 
∑ssw‹d
 = 
mosq
->
bridge
->
ªmŸe_∑ssw‹d
;

58 
˛õ¡id
 = 
mosq
->
id
;

59 
u£∫ame
 = 
mosq
->username;

60 
∑ssw‹d
 = 
mosq
->password;

63 
˛õ¡id
 = 
mosq
->
id
;

64 
u£∫ame
 = 
mosq
->username;

65 
∑ssw‹d
 = 
mosq
->password;

68 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

70 if(!
	`mosquôto_¥›îty_ªad_öt16
(
¥›îtõs
, 
MQTT_PROP_RECEIVE_MAXIMUM
, &
ª˚ive_maximum
, 
Ál£
)){

71 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
loˇl_¥›s
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 
mosq
->
msgs_ö
.
öÊight_maximum
);

72 if(
rc
) Ñc;

74 
mosq
->
msgs_ö
.
öÊight_maximum
 = 
ª˚ive_maximum
;

75 
mosq
->
msgs_ö
.
öÊight_quŸa
 = 
ª˚ive_maximum
;

78 
vîsi⁄
 = 
MQTT_PROTOCOL_V5
;

79 
hódîÀn
 = 10;

80 
¥›Àn
 = 0;

81 
¥›Àn
 +
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

82 
¥›Àn
 +
	`¥›îty__gë_Àngth_Æl
(
loˇl_¥›s
);

83 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

84 
hódîÀn
 +
¥›Àn
 + 
v¨byãs
;

85 }if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

86 
vîsi⁄
 = 
MQTT_PROTOCOL_V311
;

87 
hódîÀn
 = 10;

88 }if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

89 
vîsi⁄
 = 
MQTT_PROTOCOL_V31
;

90 
hódîÀn
 = 12;

92  
MOSQ_ERR_INVAL
;

95 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

96 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

98 if(
˛õ¡id
){

99 
∑ylﬂdÀn
 = 2+
	`°æí
(
˛õ¡id
);

101 
∑ylﬂdÀn
 = 2;

103 if(
mosq
->
wûl
){

104 
wûl
 = 1;

105 
	`as£π
(
mosq
->
wûl
->
msg
.
t›ic
);

107 
∑ylﬂdÀn
 +2+
	`°æí
(
mosq
->
wûl
->
msg
.
t›ic
) + 2+mosq->will->msg.payloadlen;

108 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

109 
wûl_¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
mosq
->
wûl
->
¥›îtõs
);

110 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
wûl_¥›Àn
);

111 
∑ylﬂdÀn
 +
wûl_¥›Àn
 + 
v¨byãs
;

118 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 || mosq->¥Ÿocﬁ =
mosq_p_mqâ311
){

119 if(
∑ssw‹d
 !
NULL
 && 
u£∫ame
 == NULL){

120  
MOSQ_ERR_INVAL
;

124 if(
u£∫ame
){

125 
∑ylﬂdÀn
 +2+
	`°æí
(
u£∫ame
);

127 if(
∑ssw‹d
){

128 
∑ylﬂdÀn
 +2+
	`°æí
(
∑ssw‹d
);

131 
∑ckë
->
comm™d
 = 
CMD_CONNECT
;

132 
∑ckë
->
ªmaöög_Àngth
 = 
hódîÀn
 + 
∑ylﬂdÀn
;

133 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

134 if(
rc
){

135 
	`mosquôto__‰ì
(
∑ckë
);

136  
rc
;

140 if(
vîsi⁄
 =
MQTT_PROTOCOL_V31
){

141 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
PROTOCOL_NAME_v31
, 
	`°æí
(PROTOCOL_NAME_v31));

143 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
PROTOCOL_NAME
, 
	`°æí
(PROTOCOL_NAME));

145 #i‡
	`deföed
(
WITH_BROKER
Ë&& deföed(
WITH_BRIDGE
)

146 if(
mosq
->
bridge
 && mosq->bridge->
åy_¥iv©e
 && mosq->bridge->
åy_¥iv©e_ac˚±ed
){

147 
vîsi⁄
 |= 0x80;

151 
	`∑ckë__wrôe_byã
(
∑ckë
, 
vîsi⁄
);

152 
byã
 = (
˛ón_£ssi⁄
&0x1)<<1;

153 if(
wûl
){

154 
byã
 = byã | ((
mosq
->
wûl
->
msg
.
ªèö
&0x1)<<5Ë| ((mosq->wûl->msg.
qos
&0x3)<<3) | ((will&0x1)<<2);

156 if(
u£∫ame
){

157 
byã
 = byte | 0x1<<7;

159 if(
mosq
->
∑ssw‹d
){

160 
byã
 = byte | 0x1<<6;

162 
	`∑ckë__wrôe_byã
(
∑ckë
, 
byã
);

163 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
kì∑live
);

165 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

167 
	`∑ckë__wrôe_v¨öt
(
∑ckë
, 
¥›Àn
);

168 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
Ál£
);

169 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
loˇl_¥›s
, 
Ál£
);

171 
	`mosquôto_¥›îty_‰ì_Æl
(&
loˇl_¥›s
);

174 if(
˛õ¡id
){

175 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
˛õ¡id
, 
	`°æí
(clientid));

177 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 0);

179 if(
wûl
){

180 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

182 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
mosq
->
wûl
->
¥›îtõs
, 
åue
);

184 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
mosq
->
wûl
->
msg
.
t›ic
, 
	`°æí
(mosq->will->msg.topic));

185 
	`∑ckë__wrôe_°rög
(
∑ckë
, (c⁄° *)
mosq
->
wûl
->
msg
.
∑ylﬂd
, mosq->wûl->msg.
∑ylﬂdÀn
);

188 if(
u£∫ame
){

189 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
u£∫ame
, 
	`°æí
(username));

191 if(
∑ssw‹d
){

192 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
∑ssw‹d
, 
	`°æí
(password));

195 
mosq
->
kì∑live
 = keepalive;

196 #ifde‡
WITH_BROKER


197 #ifde‡
WITH_BRIDGE


198 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Bridgê%†£ndög CONNECT", 
˛õ¡id
);

201 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög CONNECT", 
˛õ¡id
);

203  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

204 
	}
}

	@lib/send_disconnect.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

21 #ifde‡
WITH_BROKER


22 
	~"mosquôto_brokî_öã∫Æ.h
"

25 
	~"mosquôto.h
"

26 
	~"mosquôto_öã∫Æ.h
"

27 
	~"loggög_mosq.h
"

28 
	~"mem‹y_mosq.h
"

29 
	~"mqâ_¥Ÿocﬁ.h
"

30 
	~"∑ckë_mosq.h
"

31 
	~"¥›îty_mosq.h
"

32 
	~"£nd_mosq.h
"

35 
	$£nd__disc⁄√˘
(
mosquôto
 *
mosq
, 
uöt8_t
 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

37 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

38 
rc
;

39 
¥›Àn
, 
v¨byãs
;

41 
	`as£π
(
mosq
);

42 #ifde‡
WITH_BROKER


43 #ifde‡
WITH_BRIDGE


44 if(
mosq
->
bridge
){

45 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Bridgê%†£ndög DISCONNECT", mosq->
id
);

49 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Sídög DISCONNECTÅÿ%†‘c%d)", mosq->
id
, 
ªas⁄_code
);

53 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög DISCONNECT", mosq->
id
);

55 
	`as£π
(
mosq
);

56 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

57 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

59 
∑ckë
->
comm™d
 = 
CMD_DISCONNECT
;

60 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && (
ªas⁄_code
 !0 || 
¥›îtõs
)){

61 
∑ckë
->
ªmaöög_Àngth
 = 1;

62 if(
¥›îtõs
){

63 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

64 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

65 
∑ckë
->
ªmaöög_Àngth
 +
¥›Àn
 + 
v¨byãs
;

68 
∑ckë
->
ªmaöög_Àngth
 = 0;

71 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

72 if(
rc
){

73 
	`mosquôto__‰ì
(
∑ckë
);

74  
rc
;

76 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && (
ªas⁄_code
 !0 || 
¥›îtõs
)){

77 
	`∑ckë__wrôe_byã
(
∑ckë
, 
ªas⁄_code
);

78 if(
¥›îtõs
){

79 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

83  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

84 
	}
}

	@lib/send_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 #ifde‡
WITH_BROKER


24 
	~"mosquôto_brokî_öã∫Æ.h
"

25 
	~"sys_åì.h
"

27 
	#G_PUB_BYTES_SENT_INC
(
A
)

	)

30 
	~"mosquôto.h
"

31 
	~"mosquôto_öã∫Æ.h
"

32 
	~"loggög_mosq.h
"

33 
	~"mqâ_¥Ÿocﬁ.h
"

34 
	~"mem‹y_mosq.h
"

35 
	~"√t_mosq.h
"

36 
	~"∑ckë_mosq.h
"

37 
	~"¥›îty_mosq.h
"

38 
	~"£nd_mosq.h
"

39 
	~"time_mosq.h
"

40 
	~"utû_mosq.h
"

42 
	$£nd__pögªq
(
mosquôto
 *
mosq
)

44 
rc
;

45 
	`as£π
(
mosq
);

46 #ifde‡
WITH_BROKER


47 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PINGREQÅÿ%s", 
mosq
->
id
);

49 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PINGREQ", mosq->
id
);

51 
rc
 = 
	`£nd__sim∂e_comm™d
(
mosq
, 
CMD_PINGREQ
);

52 if(
rc
 =
MOSQ_ERR_SUCCESS
){

53 
mosq
->
pög_t
 = 
	`mosquôto_time
();

55  
rc
;

56 
	}
}

58 
	$£nd__pögª•
(
mosquôto
 *
mosq
)

60 #ifde‡
WITH_BROKER


61 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PINGRESPÅÿ%s", 
mosq
->
id
);

63 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PINGRESP", mosq->
id
);

65  
	`£nd__sim∂e_comm™d
(
mosq
, 
CMD_PINGRESP
);

66 
	}
}

68 
	$£nd__puback
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
uöt8_t
 
ªas⁄_code
)

70 #ifde‡
WITH_BROKER


71 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBACKÅÿ%†(m%d,Ñc%d)", 
mosq
->
id
, 
mid
, 
ªas⁄_code
);

73 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PUBACK (m%d,Ñc%d)", mosq->
id
, 
mid
, 
ªas⁄_code
);

75 
	`utû__ö¸emít_ª˚ive_quŸa
(
mosq
);

77  
	`£nd__comm™d_wôh_mid
(
mosq
, 
CMD_PUBACK
, 
mid
, 
Ál£
, 
ªas⁄_code
, 
NULL
);

78 
	}
}

80 
	$£nd__pubcomp
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
)

82 #ifde‡
WITH_BROKER


83 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBCOMPÅÿ%†(m%d)", 
mosq
->
id
, 
mid
);

85 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PUBCOMP (m%d)", mosq->
id
, 
mid
);

87 
	`utû__ö¸emít_ª˚ive_quŸa
(
mosq
);

89  
	`£nd__comm™d_wôh_mid
(
mosq
, 
CMD_PUBCOMP
, 
mid
, 
Ál£
, 0, 
NULL
);

90 
	}
}

93 
	$£nd__pubªc
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
uöt8_t
 
ªas⁄_code
)

95 #ifde‡
WITH_BROKER


96 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBRECÅÿ%†(m%d,Ñc%d)", 
mosq
->
id
, 
mid
, 
ªas⁄_code
);

98 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PUBREC (m%d,Ñc%d)", mosq->
id
, 
mid
, 
ªas⁄_code
);

100 if(
ªas⁄_code
 >0x80 && 
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

101 
	`utû__ö¸emít_ª˚ive_quŸa
(
mosq
);

104  
	`£nd__comm™d_wôh_mid
(
mosq
, 
CMD_PUBREC
, 
mid
, 
Ál£
, 
ªas⁄_code
, 
NULL
);

105 
	}
}

107 
	$£nd__pubªl
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
)

109 #ifde‡
WITH_BROKER


110 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBRELÅÿ%†(m%d)", 
mosq
->
id
, 
mid
);

112 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PUBREL (m%d)", mosq->
id
, 
mid
);

115  
	`£nd__comm™d_wôh_mid
(
mosq
, 
CMD_PUBREL
|2, 
mid
, 
Ál£
, 0, 
NULL
);

116 
	}
}

119 
	$£nd__comm™d_wôh_mid
(
mosquôto
 *
mosq
, 
uöt8_t
 
comm™d
, 
uöt16_t
 
mid
, 
boﬁ
 
dup
, uöt8_à
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

121 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

122 
rc
;

123 
¥›Àn
, 
v¨byãs
;

125 
	`as£π
(
mosq
);

126 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

127 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

129 
∑ckë
->
comm™d
 = command;

130 if(
dup
){

131 
∑ckë
->
comm™d
 |= 8;

133 
∑ckë
->
ªmaöög_Àngth
 = 2;

135 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

136 if(
ªas⁄_code
 !0 || 
¥›îtõs
){

137 
∑ckë
->
ªmaöög_Àngth
 += 1;

140 if(
¥›îtõs
){

141 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

142 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

143 
∑ckë
->
ªmaöög_Àngth
 +
v¨byãs
 + 
¥›Àn
;

147 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

148 if(
rc
){

149 
	`mosquôto__‰ì
(
∑ckë
);

150  
rc
;

153 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
mid
);

155 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

156 if(
ªas⁄_code
 !0 || 
¥›îtõs
){

157 
	`∑ckë__wrôe_byã
(
∑ckë
, 
ªas⁄_code
);

159 if(
¥›îtõs
){

160 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

164  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

165 
	}
}

168 
	$£nd__sim∂e_comm™d
(
mosquôto
 *
mosq
, 
uöt8_t
 
comm™d
)

170 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

171 
rc
;

173 
	`as£π
(
mosq
);

174 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

175 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

177 
∑ckë
->
comm™d
 = command;

178 
∑ckë
->
ªmaöög_Àngth
 = 0;

180 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

181 if(
rc
){

182 
	`mosquôto__‰ì
(
∑ckë
);

183  
rc
;

186  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

187 
	}
}

	@lib/send_mosq.h

16 #i‚de‡
SEND_MOSQ_H


17 
	#SEND_MOSQ_H


	)

19 
	~"mosquôto.h
"

20 
	~"¥›îty_mosq.h
"

22 
£nd__sim∂e_comm™d
(
mosquôto
 *
mosq
, 
uöt8_t
 
comm™d
);

23 
£nd__comm™d_wôh_mid
(
mosquôto
 *
mosq
, 
uöt8_t
 
comm™d
, 
uöt16_t
 
mid
, 
boﬁ
 
dup
, uöt8_à
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

24 
£nd__ªÆ_publish
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, c⁄° *
t›ic
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, boﬁ 
dup
, c⁄° 
mosquôto_¥›îty
 *
cmsg_¥›s
, c⁄° mosquôto_¥›îty *
°‹e_¥›s
, uöt32_à
expúy_öãrvÆ
);

26 
£nd__c⁄√˘
(
mosquôto
 *
mosq
, 
uöt16_t
 
kì∑live
, 
boﬁ
 
˛ón_£ssi⁄
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

27 
£nd__disc⁄√˘
(
mosquôto
 *
mosq
, 
uöt8_t
 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

28 
£nd__pögªq
(
mosquôto
 *
mosq
);

29 
£nd__pögª•
(
mosquôto
 *
mosq
);

30 
£nd__puback
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
uöt8_t
 
ªas⁄_code
);

31 
£nd__pubcomp
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
);

32 
£nd__publish
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, c⁄° *
t›ic
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, boﬁ 
dup
, c⁄° 
mosquôto_¥›îty
 *
cmsg_¥›s
, c⁄° mosquôto_¥›îty *
°‹e_¥›s
, uöt32_à
expúy_öãrvÆ
);

33 
£nd__pubªc
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
uöt8_t
 
ªas⁄_code
);

34 
£nd__pubªl
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
);

35 
£nd__subs¸ibe
(
mosquôto
 *
mosq
, *
mid
, 
t›ic_cou¡
, *c⁄° *c⁄° 
t›ic
, 
t›ic_qos
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

36 
£nd__unsubs¸ibe
(
mosquôto
 *
mosq
, *
mid
, 
t›ic_cou¡
, *c⁄° *c⁄° 
t›ic
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

	@lib/send_publish.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WITH_BROKER


23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"sys_åì.h
"

26 
	#G_PUB_BYTES_SENT_INC
(
A
)

	)

29 
	~"mosquôto.h
"

30 
	~"mosquôto_öã∫Æ.h
"

31 
	~"loggög_mosq.h
"

32 
	~"mqâ_¥Ÿocﬁ.h
"

33 
	~"mem‹y_mosq.h
"

34 
	~"√t_mosq.h
"

35 
	~"∑ckë_mosq.h
"

36 
	~"¥›îty_mosq.h
"

37 
	~"£nd_mosq.h
"

40 
	$£nd__publish
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, c⁄° *
t›ic
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, boﬁ 
dup
, c⁄° 
mosquôto_¥›îty
 *
cmsg_¥›s
, c⁄° mosquôto_¥›îty *
°‹e_¥›s
, uöt32_à
expúy_öãrvÆ
)

42 #ifde‡
WITH_BROKER


43 
size_t
 
Àn
;

44 #ifde‡
WITH_BRIDGE


45 
i
;

46 
mosquôto__bridge_t›ic
 *
cur_t›ic
;

47 
boﬁ
 
m©ch
;

48 
rc
;

49 *
m≠≥d_t›ic
 = 
NULL
;

50 *
t›ic_ãmp
 = 
NULL
;

53 
	`as£π
(
mosq
);

55 #i‡
	`deföed
(
WITH_BROKER
Ë&& deföed(
WITH_WEBSOCKETS
)

56 if(
mosq
->
sock
 =
INVALID_SOCKET
 && !mosq->
wsi
Ë 
MOSQ_ERR_NO_CONN
;

58 if(
mosq
->
sock
 =
INVALID_SOCKET
Ë 
MOSQ_ERR_NO_CONN
;

61 #ifde‡
WITH_BROKER


62 if(
mosq
->
li°íî
 && mosq->li°íî->
mou¡_poöt
){

63 
Àn
 = 
	`°æí
(
mosq
->
li°íî
->
mou¡_poöt
);

64 if(
Àn
 < 
	`°æí
(
t›ic
)){

65 
t›ic
 +
Àn
;

68  
MOSQ_ERR_SUCCESS
;

71 #ifde‡
WITH_BRIDGE


72 if(
mosq
->
bridge
 && mosq->bridge->
t›ics
 && mosq->bridge->
t›ic_ªm≠pög
){

73 
i
=0; i<
mosq
->
bridge
->
t›ic_cou¡
; i++){

74 
cur_t›ic
 = &
mosq
->
bridge
->
t›ics
[
i
];

75 if((
cur_t›ic
->
dúe˘i⁄
 =
bd_bŸh
 || cur_t›ic->dúe˘i⁄ =
bd_out
)

76 && (
cur_t›ic
->
ªmŸe_¥efix
 || cur_t›ic->
loˇl_¥efix
)){

79 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
cur_t›ic
->
loˇl_t›ic
, 
t›ic
, &
m©ch
);

80 if(
rc
){

81  
rc
;

83 if(
m©ch
){

84 
m≠≥d_t›ic
 = 
	`mosquôto__°rdup
(
t›ic
);

85 if(!
m≠≥d_t›ic
Ë 
MOSQ_ERR_NOMEM
;

86 if(
cur_t›ic
->
loˇl_¥efix
){

88 if(!
	`°∫cmp
(
cur_t›ic
->
loˇl_¥efix
, 
m≠≥d_t›ic
, 
	`°æí
(cur_topic->local_prefix))){

89 
t›ic_ãmp
 = 
	`mosquôto__°rdup
(
m≠≥d_t›ic
+
	`°æí
(
cur_t›ic
->
loˇl_¥efix
));

90 
	`mosquôto__‰ì
(
m≠≥d_t›ic
);

91 if(!
t›ic_ãmp
){

92  
MOSQ_ERR_NOMEM
;

94 
m≠≥d_t›ic
 = 
t›ic_ãmp
;

98 if(
cur_t›ic
->
ªmŸe_¥efix
){

100 
Àn
 = 
	`°æí
(
m≠≥d_t›ic
Ë+ såÀn(
cur_t›ic
->
ªmŸe_¥efix
)+1;

101 
t›ic_ãmp
 = 
	`mosquôto__mÆloc
(
Àn
+1);

102 if(!
t›ic_ãmp
){

103 
	`mosquôto__‰ì
(
m≠≥d_t›ic
);

104  
MOSQ_ERR_NOMEM
;

106 
	`¢¥ötf
(
t›ic_ãmp
, 
Àn
, "%s%s", 
cur_t›ic
->
ªmŸe_¥efix
, 
m≠≥d_t›ic
);

107 
t›ic_ãmp
[
Àn
] = '\0';

108 
	`mosquôto__‰ì
(
m≠≥d_t›ic
);

109 
m≠≥d_t›ic
 = 
t›ic_ãmp
;

111 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBLISHÅÿ%†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
mosq
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
m≠≥d_t›ic
, ()
∑ylﬂdÀn
);

112 
	`G_PUB_BYTES_SENT_INC
(
∑ylﬂdÀn
);

113 
rc
 = 
	`£nd__ªÆ_publish
(
mosq
, 
mid
, 
m≠≥d_t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
dup
, 
cmsg_¥›s
, 
°‹e_¥›s
, 
expúy_öãrvÆ
);

114 
	`mosquôto__‰ì
(
m≠≥d_t›ic
);

115  
rc
;

121 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög PUBLISHÅÿ%†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
mosq
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

122 
	`G_PUB_BYTES_SENT_INC
(
∑ylﬂdÀn
);

124 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög PUBLISH (d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", mosq->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

127  
	`£nd__ªÆ_publish
(
mosq
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
dup
, 
cmsg_¥›s
, 
°‹e_¥›s
, 
expúy_öãrvÆ
);

128 
	}
}

131 
	$£nd__ªÆ_publish
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, c⁄° *
t›ic
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, boﬁ 
dup
, c⁄° 
mosquôto_¥›îty
 *
cmsg_¥›s
, c⁄° mosquôto_¥›îty *
°‹e_¥›s
, uöt32_à
expúy_öãrvÆ
)

133 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

134 
∑ckëÀn
;

135 
¥›Àn
 = 0, 
v¨byãs
;

136 
rc
;

137 
mosquôto_¥›îty
 
expúy_¥›
;

139 
	`as£π
(
mosq
);

141 if(
t›ic
){

142 
∑ckëÀn
 = 2+
	`°æí
(
t›ic
Ë+ 
∑ylﬂdÀn
;

144 
∑ckëÀn
 = 2 + 
∑ylﬂdÀn
;

146 if(
qos
 > 0Ë
∑ckëÀn
 += 2;

147 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

148 
¥›Àn
 = 0;

149 
¥›Àn
 +
	`¥›îty__gë_Àngth_Æl
(
cmsg_¥›s
);

150 
¥›Àn
 +
	`¥›îty__gë_Àngth_Æl
(
°‹e_¥›s
);

151 if(
expúy_öãrvÆ
 > 0){

152 
expúy_¥›
.
√xt
 = 
NULL
;

153 
expúy_¥›
.
vÆue
.
i32
 = 
expúy_öãrvÆ
;

154 
expúy_¥›
.
idítifõr
 = 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
;

155 
expúy_¥›
.
˛õ¡_gíî©ed
 = 
Ál£
;

157 
¥›Àn
 +
	`¥›îty__gë_Àngth_Æl
(&
expúy_¥›
);

160 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

161 if(
v¨byãs
 > 4){

163 
cmsg_¥›s
 = 
NULL
;

164 
°‹e_¥›s
 = 
NULL
;

165 
expúy_öãrvÆ
 = 0;

167 
∑ckëÀn
 +
¥›Àn
 + 
v¨byãs
;

170 if(
	`∑ckë__check_ovîsize
(
mosq
, 
∑ckëÀn
)){

171 #ifde‡
WITH_BROKER


172 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Dr›pögÅoÿœrgêoutgoög PUBLISH f‹ %†(%d byãs)", 
mosq
->
id
, 
∑ckëÀn
);

174 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Dr›pögÅoÿœrgêoutgoög PUBLISH (%d byãs)", 
∑ckëÀn
);

176  
MOSQ_ERR_OVERSIZE_PACKET
;

179 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

180 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

182 
∑ckë
->
mid
 = mid;

183 
∑ckë
->
comm™d
 = 
CMD_PUBLISH
 | ((
dup
&0x1)<<3Ë| (
qos
<<1Ë| 
ªèö
;

184 
∑ckë
->
ªmaöög_Àngth
 = 
∑ckëÀn
;

185 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

186 if(
rc
){

187 
	`mosquôto__‰ì
(
∑ckë
);

188  
rc
;

191 if(
t›ic
){

192 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
t›ic
, 
	`°æí
(topic));

194 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 0);

196 if(
qos
 > 0){

197 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
mid
);

200 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

201 
	`∑ckë__wrôe_v¨öt
(
∑ckë
, 
¥›Àn
);

202 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
cmsg_¥›s
, 
Ál£
);

203 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
°‹e_¥›s
, 
Ál£
);

204 if(
expúy_öãrvÆ
 > 0){

205 
	`¥›îty__wrôe_Æl
(
∑ckë
, &
expúy_¥›
, 
Ál£
);

210 if(
∑ylﬂdÀn
){

211 
	`∑ckë__wrôe_byãs
(
∑ckë
, 
∑ylﬂd
, 
∑ylﬂdÀn
);

214  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

215 
	}
}

	@lib/send_subscribe.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WITH_BROKER


23 
	~"mosquôto_brokî_öã∫Æ.h
"

26 
	~"mosquôto.h
"

27 
	~"mosquôto_öã∫Æ.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mem‹y_mosq.h
"

30 
	~"mqâ_¥Ÿocﬁ.h
"

31 
	~"∑ckë_mosq.h
"

32 
	~"¥›îty_mosq.h
"

33 
	~"utû_mosq.h
"

36 
	$£nd__subs¸ibe
(
mosquôto
 *
mosq
, *
mid
, 
t›ic_cou¡
, c⁄° **
t›ic
, 
t›ic_qos
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

38 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

39 
uöt32_t
 
∑ckëÀn
;

40 
uöt16_t
 
loˇl_mid
;

41 
rc
;

42 
i
;

43 
¥›Àn
, 
v¨byãs
;

45 
	`as£π
(
mosq
);

46 
	`as£π
(
t›ic
);

48 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

49 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

51 
∑ckëÀn
 = 2;

52 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

53 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

54 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

55 
∑ckëÀn
 +
¥›Àn
 + 
v¨byãs
;

57 
i
=0; i<
t›ic_cou¡
; i++){

58 
∑ckëÀn
 +2+
	`°æí
(
t›ic
[
i
]) + 1;

61 
∑ckë
->
comm™d
 = 
CMD_SUBSCRIBE
 | (1<<1);

62 
∑ckë
->
ªmaöög_Àngth
 = 
∑ckëÀn
;

63 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

64 if(
rc
){

65 
	`mosquôto__‰ì
(
∑ckë
);

66  
rc
;

70 
loˇl_mid
 = 
	`mosquôto__mid_gíî©e
(
mosq
);

71 if(
mid
Ë*mid = ()
loˇl_mid
;

72 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
loˇl_mid
);

74 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

75 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

79 
i
=0; i<
t›ic_cou¡
; i++){

80 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
t›ic
[
i
], 
	`°æí
(topic[i]));

81 
	`∑ckë__wrôe_byã
(
∑ckë
, 
t›ic_qos
);

84 #ifde‡
WITH_BROKER


85 #ifde‡
WITH_BRIDGE


86 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Bridgê%†£ndög SUBSCRIBE (Mid: %d, T›ic: %s, QoS: %d, O±i⁄s: 0x%02x)", mosq->
id
, 
loˇl_mid
, 
t›ic
[0], 
t›ic_qos
&0x03,Åopic_qos&0xFC);

89 
i
=0; i<
t›ic_cou¡
; i++){

90 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög SUBSCRIBE (Mid: %d, T›ic: %s, QoS: %d, O±i⁄s: 0x%02x)", mosq->
id
, 
loˇl_mid
, 
t›ic
[
i
], 
t›ic_qos
&0x03,Åopic_qos&0xFC);

94  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

95 
	}
}

	@lib/send_unsubscribe.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WITH_BROKER


23 
	~"mosquôto_brokî_öã∫Æ.h
"

26 
	~"mosquôto.h
"

27 
	~"loggög_mosq.h
"

28 
	~"mem‹y_mosq.h
"

29 
	~"mqâ_¥Ÿocﬁ.h
"

30 
	~"∑ckë_mosq.h
"

31 
	~"¥›îty_mosq.h
"

32 
	~"£nd_mosq.h
"

33 
	~"utû_mosq.h
"

36 
	$£nd__unsubs¸ibe
(
mosquôto
 *
mosq
, *
mid
, 
t›ic_cou¡
, *c⁄° *c⁄° 
t›ic
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

39 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

40 
uöt32_t
 
∑ckëÀn
;

41 
uöt16_t
 
loˇl_mid
;

42 
rc
;

43 
¥›Àn
, 
v¨byãs
;

44 
i
;

46 
	`as£π
(
mosq
);

47 
	`as£π
(
t›ic
);

49 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

50 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

52 
∑ckëÀn
 = 2;

54 
i
=0; i<
t›ic_cou¡
; i++){

55 
∑ckëÀn
 +2+
	`°æí
(
t›ic
[
i
]);

57 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

58 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

59 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

60 
∑ckëÀn
 +
¥›Àn
 + 
v¨byãs
;

63 
∑ckë
->
comm™d
 = 
CMD_UNSUBSCRIBE
 | (1<<1);

64 
∑ckë
->
ªmaöög_Àngth
 = 
∑ckëÀn
;

65 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

66 if(
rc
){

67 
	`mosquôto__‰ì
(
∑ckë
);

68  
rc
;

72 
loˇl_mid
 = 
	`mosquôto__mid_gíî©e
(
mosq
);

73 if(
mid
Ë*mid = ()
loˇl_mid
;

74 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
loˇl_mid
);

76 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

78 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

82 
i
=0; i<
t›ic_cou¡
; i++){

83 
	`∑ckë__wrôe_°rög
(
∑ckë
, 
t›ic
[
i
], 
	`°æí
(topic[i]));

86 #ifde‡
WITH_BROKER


87 #ifde‡
WITH_BRIDGE


88 
i
=0; i<
t›ic_cou¡
; i++){

89 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Bridgê%†£ndög UNSUBSCRIBE (Mid: %d, T›ic: %s)", mosq->
id
, 
loˇl_mid
, 
t›ic
[
i
]);

93 
i
=0; i<
t›ic_cou¡
; i++){

94 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_DEBUG
, "Clõ¡ %†£ndög UNSUBSCRIBE (Mid: %d, T›ic: %s)", mosq->
id
, 
loˇl_mid
, 
t›ic
[
i
]);

97  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

98 
	}
}

	@lib/socks_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<°rög.h
>

21 
	~<limôs.h
>

22 #ifde‡
WIN32


23 
	~<ws2t˝ù.h
>

24 #ñi‡
__QNX__


25 
	~<sys/sockë.h
>

26 
	~<√töë/ö.h
>

28 
	~<¨∑/öë.h
>

30 #ifde‡
__FªeBSD__


31 
	~<sys/sockë.h
>

32 
	~<√töë/ö.h
>

35 
	~"mosquôto_öã∫Æ.h
"

36 
	~"mem‹y_mosq.h
"

37 
	~"√t_mosq.h
"

38 
	~"∑ckë_mosq.h
"

39 
	~"£nd_mosq.h
"

40 
	~"utû_mosq.h
"

42 
	#SOCKS_AUTH_NONE
 0x00

	)

43 
	#SOCKS_AUTH_GSS
 0x01

	)

44 
	#SOCKS_AUTH_USERPASS
 0x02

	)

45 
	#SOCKS_AUTH_NO_ACCEPTABLE
 0xFF

	)

47 
	#SOCKS_ATYPE_IP_V4
 1

	)

48 
	#SOCKS_ATYPE_DOMAINNAME
 3

	)

49 
	#SOCKS_ATYPE_IP_V6
 4

	)

51 
	#SOCKS_REPLY_SUCCEEDED
 0x00

	)

52 
	#SOCKS_REPLY_GENERAL_FAILURE
 0x01

	)

53 
	#SOCKS_REPLY_CONNECTION_NOT_ALLOWED
 0x02

	)

54 
	#SOCKS_REPLY_NETWORK_UNREACHABLE
 0x03

	)

55 
	#SOCKS_REPLY_HOST_UNREACHABLE
 0x04

	)

56 
	#SOCKS_REPLY_CONNECTION_REFUSED
 0x05

	)

57 
	#SOCKS_REPLY_TTL_EXPIRED
 0x06

	)

58 
	#SOCKS_REPLY_COMMAND_NOT_SUPPORTED
 0x07

	)

59 
	#SOCKS_REPLY_ADDRESS_TYPE_NOT_SUPPORTED
 0x08

	)

61 
	$mosquôto_socks5_£t
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

63 #ifde‡
WITH_SOCKS


64 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

65 if(!
ho°
 || 
	`°æí
(ho°Ë> 256Ë 
MOSQ_ERR_INVAL
;

66 if(
p‹t
 < 1 ||Ö‹à> 65535Ë 
MOSQ_ERR_INVAL
;

68 
	`mosquôto__‰ì
(
mosq
->
socks5_ho°
);

69 
mosq
->
socks5_ho°
 = 
NULL
;

71 
mosq
->
socks5_ho°
 = 
	`mosquôto__°rdup
(
ho°
);

72 if(!
mosq
->
socks5_ho°
){

73  
MOSQ_ERR_NOMEM
;

76 
mosq
->
socks5_p‹t
 = 
p‹t
;

78 
	`mosquôto__‰ì
(
mosq
->
socks5_u£∫ame
);

79 
mosq
->
socks5_u£∫ame
 = 
NULL
;

81 
	`mosquôto__‰ì
(
mosq
->
socks5_∑ssw‹d
);

82 
mosq
->
socks5_∑ssw‹d
 = 
NULL
;

84 if(
u£∫ame
){

85 
mosq
->
socks5_u£∫ame
 = 
	`mosquôto__°rdup
(
u£∫ame
);

86 if(!
mosq
->
socks5_u£∫ame
){

87  
MOSQ_ERR_NOMEM
;

90 if(
∑ssw‹d
){

91 
mosq
->
socks5_∑ssw‹d
 = 
	`mosquôto__°rdup
(
∑ssw‹d
);

92 if(!
mosq
->
socks5_∑ssw‹d
){

93 
	`mosquôto__‰ì
(
mosq
->
socks5_u£∫ame
);

94  
MOSQ_ERR_NOMEM
;

99  
MOSQ_ERR_SUCCESS
;

101  
MOSQ_ERR_NOT_SUPPORTED
;

103 
	}
}

105 #ifde‡
WITH_SOCKS


106 
	$socks5__£nd
(
mosquôto
 *
mosq
)

108 
mosquôto__∑ckë
 *
∑ckë
;

109 
¶í
;

110 
uÀn
, 
∂í
;

112 
ö_addr
 
addr_ùv4
;

113 
ö6_addr
 
addr_ùv6
;

114 
ùv4_±⁄_ªsu…
;

115 
ùv6_±⁄_ªsu…
;

116 
°©e
;

118 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

120 if(
°©e
 =
mosq_cs_socks5_√w
){

121 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

122 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

124 if(
mosq
->
socks5_u£∫ame
){

125 
∑ckë
->
∑ckë_Àngth
 = 4;

127 
∑ckë
->
∑ckë_Àngth
 = 3;

129 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

131 
∑ckë
->
∑ylﬂd
[0] = 0x05;

132 if(
mosq
->
socks5_u£∫ame
){

133 
∑ckë
->
∑ylﬂd
[1] = 2;

134 
∑ckë
->
∑ylﬂd
[2] = 
SOCKS_AUTH_NONE
;

135 
∑ckë
->
∑ylﬂd
[3] = 
SOCKS_AUTH_USERPASS
;

137 
∑ckë
->
∑ylﬂd
[1] = 1;

138 
∑ckë
->
∑ylﬂd
[2] = 
SOCKS_AUTH_NONE
;

141 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_°¨t
);

143 
mosq
->
ö_∑ckë
.
pos
 = 0;

144 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 = 2;

145 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = 2;

146 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*2);

147 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

148 
	`mosquôto__‰ì
(
∑ckë
->
∑ylﬂd
);

149 
	`mosquôto__‰ì
(
∑ckë
);

150  
MOSQ_ERR_NOMEM
;

153  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

154 }if(
°©e
 =
mosq_cs_socks5_auth_ok
){

155 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

156 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

158 
ùv4_±⁄_ªsu…
 = 
	`öë_±⁄
(
AF_INET
, 
mosq
->
ho°
, &
addr_ùv4
);

159 
ùv6_±⁄_ªsu…
 = 
	`öë_±⁄
(
AF_INET6
, 
mosq
->
ho°
, &
addr_ùv6
);

161 if(
ùv4_±⁄_ªsu…
 == 1){

162 
∑ckë
->
∑ckë_Àngth
 = 10;

163 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

164 if(!
∑ckë
->
∑ylﬂd
){

165 
	`mosquôto__‰ì
(
∑ckë
);

166  
MOSQ_ERR_NOMEM
;

168 
∑ckë
->
∑ylﬂd
[3] = 
SOCKS_ATYPE_IP_V4
;

169 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[4]), (c⁄° *)&
addr_ùv4
, 4);

170 
∑ckë
->
∑ylﬂd
[4+4] = 
	`MOSQ_MSB
(
mosq
->
p‹t
);

171 
∑ckë
->
∑ylﬂd
[4+4+1] = 
	`MOSQ_LSB
(
mosq
->
p‹t
);

173 }if(
ùv6_±⁄_ªsu…
 == 1){

174 
∑ckë
->
∑ckë_Àngth
 = 22;

175 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

176 if(!
∑ckë
->
∑ylﬂd
){

177 
	`mosquôto__‰ì
(
∑ckë
);

178  
MOSQ_ERR_NOMEM
;

180 
∑ckë
->
∑ylﬂd
[3] = 
SOCKS_ATYPE_IP_V6
;

181 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[4]), (c⁄° *)&
addr_ùv6
, 16);

182 
∑ckë
->
∑ylﬂd
[4+16] = 
	`MOSQ_MSB
(
mosq
->
p‹t
);

183 
∑ckë
->
∑ylﬂd
[4+16+1] = 
	`MOSQ_LSB
(
mosq
->
p‹t
);

186 
¶í
 = 
	`°æí
(
mosq
->
ho°
);

187 if(
¶í
 > 
UCHAR_MAX
){

188  
MOSQ_ERR_NOMEM
;

190 
∑ckë
->
∑ckë_Àngth
 = 7 + 
¶í
;

191 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

192 if(!
∑ckë
->
∑ylﬂd
){

193 
	`mosquôto__‰ì
(
∑ckë
);

194  
MOSQ_ERR_NOMEM
;

196 
∑ckë
->
∑ylﬂd
[3] = 
SOCKS_ATYPE_DOMAINNAME
;

197 
∑ckë
->
∑ylﬂd
[4] = (
uöt8_t
)
¶í
;

198 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[5]), 
mosq
->
ho°
, 
¶í
);

199 
∑ckë
->
∑ylﬂd
[5+
¶í
] = 
	`MOSQ_MSB
(
mosq
->
p‹t
);

200 
∑ckë
->
∑ylﬂd
[6+
¶í
] = 
	`MOSQ_LSB
(
mosq
->
p‹t
);

202 
∑ckë
->
∑ylﬂd
[0] = 0x05;

203 
∑ckë
->
∑ylﬂd
[1] = 0x01;

204 
∑ckë
->
∑ylﬂd
[2] = 0x00;

206 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_ªque°
);

208 
mosq
->
ö_∑ckë
.
pos
 = 0;

209 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 = 5;

210 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = 5;

211 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*5);

212 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

213 
	`mosquôto__‰ì
(
∑ckë
->
∑ylﬂd
);

214 
	`mosquôto__‰ì
(
∑ckë
);

215  
MOSQ_ERR_NOMEM
;

218  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

219 }if(
°©e
 =
mosq_cs_socks5_£nd_u£Ωass
){

220 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

221 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

223 
uÀn
 = 
	`°æí
(
mosq
->
socks5_u£∫ame
);

224 
∂í
 = 
	`°æí
(
mosq
->
socks5_∑ssw‹d
);

225 
∑ckë
->
∑ckë_Àngth
 = 3 + 
uÀn
 + 
∂í
;

226 
∑ckë
->
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*∑ckë->
∑ckë_Àngth
);

229 
∑ckë
->
∑ylﬂd
[0] = 0x01;

230 
∑ckë
->
∑ylﬂd
[1] = 
uÀn
;

231 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[2]), 
mosq
->
socks5_u£∫ame
, 
uÀn
);

232 
∑ckë
->
∑ylﬂd
[2+
uÀn
] = 
∂í
;

233 
	`mem˝y
(&(
∑ckë
->
∑ylﬂd
[3+
uÀn
]), 
mosq
->
socks5_∑ssw‹d
, 
∂í
);

235 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_u£Ωass_ª∂y
);

237 
mosq
->
ö_∑ckë
.
pos
 = 0;

238 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 = 2;

239 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = 2;

240 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
((
uöt8_t
)*2);

241 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

242 
	`mosquôto__‰ì
(
∑ckë
->
∑ylﬂd
);

243 
	`mosquôto__‰ì
(
∑ckë
);

244  
MOSQ_ERR_NOMEM
;

247  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

249  
MOSQ_ERR_SUCCESS
;

250 
	}
}

252 
	$socks5__ªad
(
mosquôto
 *
mosq
)

254 
ssize_t
 
Àn
;

255 
uöt8_t
 *
∑ylﬂd
;

256 
uöt8_t
 
i
;

257 
°©e
;

259 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

260 if(
°©e
 =
mosq_cs_socks5_°¨t
){

261 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 > 0){

262 
Àn
 = 
	`√t__ªad
(
mosq
, &(mosq->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
]), mosq->ö_∑ckë.
to_¥o˚ss
);

263 if(
Àn
 > 0){

264 
mosq
->
ö_∑ckë
.
pos
 +
Àn
;

265 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
Àn
;

267 #ifde‡
WIN32


268 
î∫o
 = 
	`WSAGëLa°Eº‹
();

270 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

271  
MOSQ_ERR_SUCCESS
;

273 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

274 
î∫o
){

276  
MOSQ_ERR_PROXY
;

277 
COMPAT_ECONNRESET
:

278  
MOSQ_ERR_CONN_LOST
;

280  
MOSQ_ERR_ERRNO
;

285 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[0] != 5){

286 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

287  
MOSQ_ERR_PROXY
;

289 
mosq
->
ö_∑ckë
.
∑ylﬂd
[1]){

290 
SOCKS_AUTH_NONE
:

291 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

292 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_auth_ok
);

293  
	`socks5__£nd
(
mosq
);

294 
SOCKS_AUTH_USERPASS
:

295 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

296 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_£nd_u£Ωass
);

297  
	`socks5__£nd
(
mosq
);

299 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

300  
MOSQ_ERR_AUTH
;

302 }if(
°©e
 =
mosq_cs_socks5_u£Ωass_ª∂y
){

303 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 > 0){

304 
Àn
 = 
	`√t__ªad
(
mosq
, &(mosq->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
]), mosq->ö_∑ckë.
to_¥o˚ss
);

305 if(
Àn
 > 0){

306 
mosq
->
ö_∑ckë
.
pos
 +
Àn
;

307 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
Àn
;

309 #ifde‡
WIN32


310 
î∫o
 = 
	`WSAGëLa°Eº‹
();

312 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

313  
MOSQ_ERR_SUCCESS
;

315 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

316 
î∫o
){

318  
MOSQ_ERR_PROXY
;

319 
COMPAT_ECONNRESET
:

320  
MOSQ_ERR_CONN_LOST
;

322  
MOSQ_ERR_ERRNO
;

327 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[0] != 1){

328 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

329  
MOSQ_ERR_PROXY
;

331 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[1] == 0){

332 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

333 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_auth_ok
);

334  
	`socks5__£nd
(
mosq
);

336 
i
 = 
mosq
->
ö_∑ckë
.
∑ylﬂd
[1];

337 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

338 
i
){

339 
SOCKS_REPLY_CONNECTION_NOT_ALLOWED
:

340  
MOSQ_ERR_AUTH
;

342 
SOCKS_REPLY_NETWORK_UNREACHABLE
:

343 
SOCKS_REPLY_HOST_UNREACHABLE
:

344 
SOCKS_REPLY_CONNECTION_REFUSED
:

345  
MOSQ_ERR_NO_CONN
;

347 
SOCKS_REPLY_GENERAL_FAILURE
:

348 
SOCKS_REPLY_TTL_EXPIRED
:

349 
SOCKS_REPLY_COMMAND_NOT_SUPPORTED
:

350 
SOCKS_REPLY_ADDRESS_TYPE_NOT_SUPPORTED
:

351  
MOSQ_ERR_PROXY
;

354  
MOSQ_ERR_INVAL
;

356  
MOSQ_ERR_PROXY
;

358 }if(
°©e
 =
mosq_cs_socks5_ªque°
){

359 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 > 0){

360 
Àn
 = 
	`√t__ªad
(
mosq
, &(mosq->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
]), mosq->ö_∑ckë.
to_¥o˚ss
);

361 if(
Àn
 > 0){

362 
mosq
->
ö_∑ckë
.
pos
 +
Àn
;

363 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
Àn
;

365 #ifde‡
WIN32


366 
î∫o
 = 
	`WSAGëLa°Eº‹
();

368 if(
î∫o
 =
EAGAIN
 ||Éºnÿ=
COMPAT_EWOULDBLOCK
){

369  
MOSQ_ERR_SUCCESS
;

371 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

372 
î∫o
){

374  
MOSQ_ERR_PROXY
;

375 
COMPAT_ECONNRESET
:

376  
MOSQ_ERR_CONN_LOST
;

378  
MOSQ_ERR_ERRNO
;

384 if(
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 == 5){

386 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[3] =
SOCKS_ATYPE_IP_V4
){

387 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 += 4+2-1;

388 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 += 4+2-1;

389 }if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[3] =
SOCKS_ATYPE_IP_V6
){

390 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 += 16+2-1;

391 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 += 16+2-1;

392 }if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[3] =
SOCKS_ATYPE_DOMAINNAME
){

393 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[4] > 0){

394 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 +mosq->ö_∑ckë.
∑ylﬂd
[4];

395 
mosq
->
ö_∑ckë
.
∑ckë_Àngth
 +mosq->ö_∑ckë.
∑ylﬂd
[4];

398 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

399  
MOSQ_ERR_PROTOCOL
;

401 
∑ylﬂd
 = 
	`mosquôto__ªÆloc
(
mosq
->
ö_∑ckë
.∑ylﬂd, mosq->ö_∑ckë.
∑ckë_Àngth
);

402 if(
∑ylﬂd
){

403 
mosq
->
ö_∑ckë
.
∑ylﬂd
 =Öayload;

405 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

406  
MOSQ_ERR_NOMEM
;

408 
∑ylﬂd
 = 
	`mosquôto__ªÆloc
(
mosq
->
ö_∑ckë
.∑ylﬂd, mosq->ö_∑ckë.
∑ckë_Àngth
);

409 if(
∑ylﬂd
){

410 
mosq
->
ö_∑ckë
.
∑ylﬂd
 =Öayload;

412 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

413  
MOSQ_ERR_NOMEM
;

415  
MOSQ_ERR_SUCCESS
;

419 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[0] != 5){

420 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

421  
MOSQ_ERR_PROXY
;

423 if(
mosq
->
ö_∑ckë
.
∑ylﬂd
[1] == 0){

425 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

426 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_√w
);

427 if(
mosq
->
socks5_ho°
){

428 
rc
 = 
	`√t__sockë_c⁄√˘_°ï3
(
mosq
, mosq->
ho°
);

429 if(
rc
) Ñc;

431  
	`£nd__c⁄√˘
(
mosq
, mosq->
kì∑live
, mosq->
˛ón_°¨t
, 
NULL
);

433 
i
 = 
mosq
->
ö_∑ckë
.
∑ylﬂd
[1];

434 
	`∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

435 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_socks5_√w
);

436 
i
){

437 
SOCKS_REPLY_CONNECTION_NOT_ALLOWED
:

438  
MOSQ_ERR_AUTH
;

440 
SOCKS_REPLY_NETWORK_UNREACHABLE
:

441 
SOCKS_REPLY_HOST_UNREACHABLE
:

442 
SOCKS_REPLY_CONNECTION_REFUSED
:

443  
MOSQ_ERR_NO_CONN
;

445 
SOCKS_REPLY_GENERAL_FAILURE
:

446 
SOCKS_REPLY_TTL_EXPIRED
:

447 
SOCKS_REPLY_COMMAND_NOT_SUPPORTED
:

448 
SOCKS_REPLY_ADDRESS_TYPE_NOT_SUPPORTED
:

449  
MOSQ_ERR_PROXY
;

452  
MOSQ_ERR_INVAL
;

456  
	`∑ckë__ªad
(
mosq
);

458  
MOSQ_ERR_SUCCESS
;

459 
	}
}

	@lib/socks_mosq.h

17 #i‚de‡
SOCKS_MOSQ_H


18 
	#SOCKS_MOSQ_H


	)

20 
socks5__£nd
(
mosquôto
 *
mosq
);

21 
socks5__ªad
(
mosquôto
 *
mosq
);

	@lib/srv_mosq.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_SRV


20 
	~<¨es.h
>

22 
	~<¨∑/«me£r.h
>

23 
	~<°dio.h
>

24 
	~<°rög.h
>

27 
	~"loggög_mosq.h
"

28 
	~"mem‹y_mosq.h
"

29 
	~"mosquôto_öã∫Æ.h
"

30 
	~"mosquôto.h
"

31 
	~"utû_mosq.h
"

33 #ifde‡
WITH_SRV


34 
	$§v_ˇŒback
(*
¨g
, 
°©us
, 
timeouts
, *
abuf
, 
Æí
)

36 
mosquôto
 *
mosq
 = 
¨g
;

37 
¨es_§v_ª∂y
 *
ª∂y
 = 
NULL
;

38 if(
°©us
 =
ARES_SUCCESS
){

39 
°©us
 = 
	`¨es_∑r£_§v_ª∂y
(
abuf
, 
Æí
, &
ª∂y
);

40 if(
°©us
 =
ARES_SUCCESS
){

42 
	`mosquôto_c⁄√˘
(
mosq
, 
ª∂y
->
ho°
,Ñïly->
p‹t
, mosq->
kì∑live
);

45 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Eº‹: SRVÜooku∞Áûed (%d).", 
°©us
);

47 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

48 if(
mosq
->
⁄_disc⁄√˘
){

49 
mosq
->
ö_ˇŒback
 = 
åue
;

50 
mosq
->
	`⁄_disc⁄√˘
(mosq, mosq->
u£rd©a
, 
MOSQ_ERR_LOOKUP
);

51 
mosq
->
ö_ˇŒback
 = 
Ál£
;

53 if(
mosq
->
⁄_disc⁄√˘_v5
){

54 
mosq
->
ö_ˇŒback
 = 
åue
;

55 
mosq
->
	`⁄_disc⁄√˘_v5
(mosq, mosq->
u£rd©a
, 
MOSQ_ERR_LOOKUP
, 
NULL
);

56 
mosq
->
ö_ˇŒback
 = 
Ál£
;

58 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

60 
	}
}

63 
	$mosquôto_c⁄√˘_§v
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
kì∑live
, c⁄° *
böd_addªss
)

65 #ifde‡
WITH_SRV


66 *
h
;

67 
rc
;

68 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

70 
rc
 = 
	`¨es_öô
(&
mosq
->
ach™
);

71 if(
rc
 !
ARES_SUCCESS
){

72  
MOSQ_ERR_UNKNOWN
;

75 if(!
ho°
){

78 #ifde‡
WITH_TLS


79 if(
mosq
->
és_ˇfûe
 || mosq->
és_ˇ∑th
 || mosq->
és_psk
){

80 
h
 = 
	`mosquôto__mÆloc
(
	`°æí
(
ho°
) + strlen("_secure-mqtt._tcp.") + 1);

81 if(!
h
Ë 
MOSQ_ERR_NOMEM
;

82 
	`•rötf
(
h
, "_£cuª-mqâ._t˝.%s", 
ho°
);

85 
h
 = 
	`mosquôto__mÆloc
(
	`°æí
(
ho°
) + strlen("_mqtt._tcp.") + 1);

86 if(!
h
Ë 
MOSQ_ERR_NOMEM
;

87 
	`•rötf
(
h
, "_mqâ._t˝.%s", 
ho°
);

88 #ifde‡
WITH_TLS


91 
	`¨es_£¨ch
(
mosq
->
ach™
, 
h
, 
ns_c_ö
, 
ns_t_§v
, 
§v_ˇŒback
, mosq);

92 
	`mosquôto__‰ì
(
h
);

95 
	`mosquôto__£t_°©e
(
mosq
, 
mosq_cs_c⁄√˘_§v
);

97 
mosq
->
kì∑live
 = keepalive;

99  
MOSQ_ERR_SUCCESS
;

102 
	`UNUSED
(
mosq
);

103 
	`UNUSED
(
ho°
);

104 
	`UNUSED
(
kì∑live
);

105 
	`UNUSED
(
böd_addªss
);

107  
MOSQ_ERR_NOT_SUPPORTED
;

109 
	}
}

	@lib/thread_mosq.c

17 
	~"c⁄fig.h
"

19 #i‚de‡
WIN32


20 
	~<time.h
>

23 
	~"mosquôto_öã∫Æ.h
"

24 
	~"√t_mosq.h
"

25 
	~"utû_mosq.h
"

27 *
mosquôto__thªad_maö
(*
obj
);

29 
	$mosquôto_lo›_°¨t
(
mosquôto
 *
mosq
)

31 #i‡
	`deföed
(
WITH_THREADING
Ë&& deföed(
HAVE_PTHREAD_CANCEL
)

32 if(!
mosq
 || mosq->
thªaded
 !
mosq_ts_n⁄e
Ë 
MOSQ_ERR_INVAL
;

34 
mosq
->
thªaded
 = 
mosq_ts_£lf
;

35 if(!
	`±hªad_¸óã
(&
mosq
->
thªad_id
, 
NULL
, 
mosquôto__thªad_maö
, mosq)){

36  
MOSQ_ERR_SUCCESS
;

38  
MOSQ_ERR_ERRNO
;

41  
MOSQ_ERR_NOT_SUPPORTED
;

43 
	}
}

45 
	$mosquôto_lo›_°›
(
mosquôto
 *
mosq
, 
boﬁ
 
f‹˚
)

47 #i‡
	`deföed
(
WITH_THREADING
Ë&& deföed(
HAVE_PTHREAD_CANCEL
)

48 #i‚de‡
WITH_BROKER


49 
sock∑ú_d©a
 = 0;

52 if(!
mosq
 || mosq->
thªaded
 !
mosq_ts_£lf
Ë 
MOSQ_ERR_INVAL
;

57 if(
mosq
->
sock∑úW
 !
INVALID_SOCKET
){

58 #i‚de‡
WIN32


59 if(
	`wrôe
(
mosq
->
sock∑úW
, &
sock∑ú_d©a
, 1)){

62 
	`£nd
(
mosq
->
sock∑úW
, &
sock∑ú_d©a
, 1, 0);

66 if(
f‹˚
){

67 
	`±hªad_ˇn˚l
(
mosq
->
thªad_id
);

69 
	`±hªad_joö
(
mosq
->
thªad_id
, 
NULL
);

70 
mosq
->
thªad_id
 = 
	`±hªad_£lf
();

71 
mosq
->
thªaded
 = 
mosq_ts_n⁄e
;

73  
MOSQ_ERR_SUCCESS
;

75  
MOSQ_ERR_NOT_SUPPORTED
;

77 
	}
}

79 #ifde‡
WITH_THREADING


80 *
	$mosquôto__thªad_maö
(*
obj
)

82 
mosquôto
 *
mosq
 = 
obj
;

83 
°©e
;

84 #i‚de‡
WIN32


85 
time•ec
 
ts
;

86 
ts
.
tv_£c
 = 0;

87 
ts
.
tv_n£c
 = 10000000;

90 if(!
mosq
Ë 
NULL
;

93 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

94 if(
°©e
 =
mosq_cs_√w
){

95 #ifde‡
WIN32


96 
	`SÀï
(10);

98 
	`«no¶ìp
(&
ts
, 
NULL
);

105 if(!
mosq
->
kì∑live
){

107 
	`mosquôto_lo›_f‹evî
(
mosq
, 1000*86400, 1);

110 
	`mosquôto_lo›_f‹evî
(
mosq
, mosq->
kì∑live
*1000, 1);

113  
obj
;

114 
	}
}

117 
	$mosquôto_thªaded_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
thªaded
)

119 if(!
mosq
Ë 
MOSQ_ERR_INVAL
;

121 if(
thªaded
){

122 
mosq
->
thªaded
 = 
mosq_ts_exã∫Æ
;

124 
mosq
->
thªaded
 = 
mosq_ts_n⁄e
;

127  
MOSQ_ERR_SUCCESS
;

128 
	}
}

	@lib/time_mosq.c

17 
	~"c⁄fig.h
"

19 #ifde‡
__APPLE__


20 
	~<mach/mach.h
>

21 
	~<mach/mach_time.h
>

24 #ifde‡
WIN32


25 
	#_WIN32_WINNT
 
_WIN32_WINNT_VISTA


	)

26 
	~<wödows.h
>

28 
	~<uni°d.h
>

30 
	~<time.h
>

32 
	~"mosquôto.h
"

33 
	~"time_mosq.h
"

35 
time_t
 
	$mosquôto_time
()

37 #ifde‡
WIN32


38  
	`GëTickCou¡64
()/1000;

39 #ñi‡
_POSIX_TIMERS
>0 && 
	`deföed
(
_POSIX_MONOTONIC_CLOCK
)

40 
time•ec
 
ç
;

42 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ç
);

43  
ç
.
tv_£c
;

44 #ñi‡
	`deföed
(
__APPLE__
)

45 
mach_timeba£_öfo_d©a_t
 
tb
;

46 
uöt64_t
 
ticks
;

47 
uöt64_t
 
£c
;

49 
ticks
 = 
	`mach_absﬁuã_time
();

51 if(
tb
.
díom
 == 0){

52 
	`mach_timeba£_öfo
(&
tb
);

54 
£c
 = 
ticks
*
tb
.
numî
/tb.
díom
/1000000000;

56  (
time_t
)
£c
;

58  
	`time
(
NULL
);

60 
	}
}

	@lib/time_mosq.h

17 #i‚de‡
TIME_MOSQ_H


18 
	#TIME_MOSQ_H


	)

20 
time_t
 
mosquôto_time
();

	@lib/tls_mosq.c

17 #ifde‡
WITH_TLS


19 
	~"c⁄fig.h
"

21 #ifde‡
WIN32


22 
	~<wösock2.h
>

23 
	~<ws2t˝ù.h
>

25 
	~<¨∑/öë.h
>

26 
	~<sys/sockë.h
>

27 
	~<°rögs.h
>

30 
	~<°rög.h
>

31 
	~<›ís¶/c⁄f.h
>

32 
	~<›ís¶/x509v3.h
>

33 
	~<›ís¶/s¶.h
>

35 #ifde‡
WITH_BROKER


36 
	~"mosquôto_brokî_öã∫Æ.h
"

38 
	~"mosquôto_öã∫Æ.h
"

39 
	~"loggög_mosq.h
"

40 
	~"és_mosq.h
"

42 
és_ex_ödex_mosq
;

44 
	$mosquôto__£rvî_˚πifiˇã_vîify
(
¥evîify_ok
, 
X509_STORE_CTX
 *
˘x
)

48 
mosquôto
 *
mosq
;

49 
SSL
 *
s¶
;

50 
X509
 *
˚π
;

53 if(!
¥evîify_ok
)  0;

55 
s¶
 = 
	`X509_STORE_CTX_gë_ex_d©a
(
˘x
, 
	`SSL_gë_ex_d©a_X509_STORE_CTX_idx
());

56 
mosq
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_mosq
);

57 if(!
mosq
)  0;

59 if(
mosq
->
és_ö£cuª
 =
Ál£
){

60 if(
	`X509_STORE_CTX_gë_îr‹_dïth
(
˘x
) == 0){

62 
˚π
 = 
	`X509_STORE_CTX_gë_cuºít_˚π
(
˘x
);

64 #i‡
	`deföed
(
WITH_BROKER
)

65 
¥evîify_ok
 = 
	`mosquôto__vîify_˚πifiˇã_ho°«me
(
˚π
, 
mosq
->
bridge
->
addªs£s
[mosq->bridge->
cur_addªss
].
addªss
);

67 
¥evîify_ok
 = 
	`mosquôto__vîify_˚πifiˇã_ho°«me
(
˚π
, 
mosq
->
ho°
);

69 i‡(
¥evîify_ok
 != 1) {

70 
	`log__¥ötf
(
mosq
, 
MOSQ_LOG_ERR
, "Error: hostÇame verification failed.");

72  
¥evîify_ok
;

74  
¥evîify_ok
;

77  
¥evîify_ok
;

79 
	}
}

81 
	$mosquôto__cmp_ho°«me_wûdˇrd
(*
˚π«me
, c⁄° *
ho°«me
)

83 
i
;

84 
Àn
;

86 if(!
˚π«me
 || !
ho°«me
){

90 if(
˚π«me
[0] == '*'){

91 if(
˚π«me
[1] != '.'){

94 
˚π«me
 += 2;

95 
Àn
 = 
	`°æí
(
ho°«me
);

96 
i
=0; i<
Àn
-1; i++){

97 if(
ho°«me
[
i
] == '.'){

98 
ho°«me
 +
i
+1;

102  
	`°rˇ£cmp
(
˚π«me
, 
ho°«me
);

104  
	`°rˇ£cmp
(
˚π«me
, 
ho°«me
);

106 
	}
}

111 
	$mosquôto__vîify_˚πifiˇã_ho°«me
(
X509
 *
˚π
, c⁄° *
ho°«me
)

113 
i
;

114 
«me
[256];

115 
X509_NAME
 *
subj
;

116 
boﬁ
 
have_ßn_dns
 = 
Ál£
;

117 
	`STACK_OF
(
GENERAL_NAME
Ë*
ßn
;

118 c⁄° 
GENERAL_NAME
 *
nvÆ
;

119 c⁄° *
d©a
;

120 
ùv6_addr
[16];

121 
ùv4_addr
[4];

122 
ùv6_ok
;

123 
ùv4_ok
;

125 #ifde‡
WIN32


126 
ùv6_ok
 = 
	`I√tPt⁄
(
AF_INET6
, 
ho°«me
, &
ùv6_addr
);

127 
ùv4_ok
 = 
	`I√tPt⁄
(
AF_INET
, 
ho°«me
, &
ùv4_addr
);

129 
ùv6_ok
 = 
	`öë_±⁄
(
AF_INET6
, 
ho°«me
, &
ùv6_addr
);

130 
ùv4_ok
 = 
	`öë_±⁄
(
AF_INET
, 
ho°«me
, &
ùv4_addr
);

133 
ßn
 = 
	`X509_gë_ext_d2i
(
˚π
, 
NID_subje˘_Æt_«me
, 
NULL
, NULL);

134 if(
ßn
){

135 
i
=0; i<
	`sk_GENERAL_NAME_num
(
ßn
); i++){

136 
nvÆ
 = 
	`sk_GENERAL_NAME_vÆue
(
ßn
, 
i
);

137 if(
nvÆ
->
ty≥
 =
GEN_DNS
){

138 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

139 
d©a
 = 
	`ASN1_STRING_d©a
(
nvÆ
->
d
.
dNSName
);

141 
d©a
 = 
	`ASN1_STRING_gë0_d©a
(
nvÆ
->
d
.
dNSName
);

143 if(
d©a
 && !
	`mosquôto__cmp_ho°«me_wûdˇrd
((*)d©a, 
ho°«me
)){

144 
	`sk_GENERAL_NAME_p›_‰ì
(
ßn
, 
GENERAL_NAME_‰ì
);

147 
have_ßn_dns
 = 
åue
;

148 }if(
nvÆ
->
ty≥
 =
GEN_IPADD
){

149 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

150 
d©a
 = 
	`ASN1_STRING_d©a
(
nvÆ
->
d
.
iPAddªss
);

152 
d©a
 = 
	`ASN1_STRING_gë0_d©a
(
nvÆ
->
d
.
iPAddªss
);

154 if(
nvÆ
->
d
.
iPAddªss
->
Àngth
 =4 && 
ùv4_ok
){

155 if(!
	`memcmp
(
ùv4_addr
, 
d©a
, 4)){

156 
	`sk_GENERAL_NAME_p›_‰ì
(
ßn
, 
GENERAL_NAME_‰ì
);

159 }if(
nvÆ
->
d
.
iPAddªss
->
Àngth
 =16 && 
ùv6_ok
){

160 if(!
	`memcmp
(
ùv6_addr
, 
d©a
, 16)){

161 
	`sk_GENERAL_NAME_p›_‰ì
(
ßn
, 
GENERAL_NAME_‰ì
);

167 
	`sk_GENERAL_NAME_p›_‰ì
(
ßn
, 
GENERAL_NAME_‰ì
);

168 if(
have_ßn_dns
){

174 
subj
 = 
	`X509_gë_subje˘_«me
(
˚π
);

175 if(
	`X509_NAME_gë_ãxt_by_NID
(
subj
, 
NID_comm⁄Name
, 
«me
, (name)) > 0){

176 
«me
[(name) - 1] = '\0';

177 i‡(!
	`mosquôto__cmp_ho°«me_wûdˇrd
(
«me
, 
ho°«me
))  1;

180 
	}
}

	@lib/tls_mosq.h

17 #i‚de‡
TLS_MOSQ_H


18 
	#TLS_MOSQ_H


	)

20 #ifde‡
WITH_TLS


21 
	#SSL_DATA_PENDING
(
A
Ë((A)->
s¶
 && 
	`SSL_≥ndög
((A)->s¶))

	)

23 
	#SSL_DATA_PENDING
(
A
Ë0

	)

26 #ifde‡
WITH_TLS


28 
	~<›ís¶/s¶.h
>

29 
	~<›ís¶/ígöe.h
>

31 
mosquôto__£rvî_˚πifiˇã_vîify
(
¥evîify_ok
, 
X509_STORE_CTX
 *
˘x
);

32 
mosquôto__vîify_˚πifiˇã_ho°«me
(
X509
 *
˚π
, c⁄° *
ho°«me
);

	@lib/utf8_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~"mosquôto.h
"

22 
	$mosquôto_vÆid©e_utf8
(c⁄° *
°r
, 
Àn
)

24 
i
;

25 
j
;

26 
codñí
;

27 
codïoöt
;

28 c⁄° *
u°r
 = (c⁄° *)
°r
;

30 if(!
°r
Ë 
MOSQ_ERR_INVAL
;

31 if(
Àn
 < 0 ||Üí > 65536Ë 
MOSQ_ERR_INVAL
;

33 
i
=0; i<
Àn
; i++){

34 if(
u°r
[
i
] == 0){

35  
MOSQ_ERR_MALFORMED_UTF8
;

36 }if(
u°r
[
i
] <= 0x7f){

37 
codñí
 = 1;

38 
codïoöt
 = 
u°r
[
i
];

39 }if((
u°r
[
i
] & 0xE0) == 0xC0){

41 if(
u°r
[
i
] == 0xC0 || ustr[i] == 0xC1){

43  
MOSQ_ERR_MALFORMED_UTF8
;

45 
codñí
 = 2;

46 
codïoöt
 = (
u°r
[
i
] & 0x1F);

47 }if((
u°r
[
i
] & 0xF0) == 0xE0){

49 
codñí
 = 3;

50 
codïoöt
 = (
u°r
[
i
] & 0x0F);

51 }if((
u°r
[
i
] & 0xF8) == 0xF0){

53 if(
u°r
[
i
] > 0xF4){

55  
MOSQ_ERR_MALFORMED_UTF8
;

57 
codñí
 = 4;

58 
codïoöt
 = (
u°r
[
i
] & 0x07);

61  
MOSQ_ERR_MALFORMED_UTF8
;

65 if(
i
 =
Àn
-
codñí
+1){

67  
MOSQ_ERR_MALFORMED_UTF8
;

69 
j
=0; j<
codñí
-1; j++){

70 if((
u°r
[++
i
] & 0xC0) != 0x80){

72  
MOSQ_ERR_MALFORMED_UTF8
;

74 
codïoöt
 = (codïoöt<<6Ë| (
u°r
[
i
] & 0x3F);

78 if(
codïoöt
 >= 0xD800 && codepoint <= 0xDFFF){

79  
MOSQ_ERR_MALFORMED_UTF8
;

89 if(
codñí
 =3 && 
codïoöt
 < 0x0800){

90  
MOSQ_ERR_MALFORMED_UTF8
;

91 }if(
codñí
 =4 && (
codïoöt
 < 0x10000 || codepoint > 0x10FFFF)){

92  
MOSQ_ERR_MALFORMED_UTF8
;

96 if(
codïoöt
 >= 0xFDD0 && codepoint <= 0xFDEF){

97  
MOSQ_ERR_MALFORMED_UTF8
;

99 if((
codïoöt
 & 0xFFFF) == 0xFFFE || (codepoint & 0xFFFF) == 0xFFFF){

100  
MOSQ_ERR_MALFORMED_UTF8
;

103 if(
codïoöt
 <= 0x001F || (codepoint >= 0x007F && codepoint <= 0x009F)){

104  
MOSQ_ERR_MALFORMED_UTF8
;

107  
MOSQ_ERR_SUCCESS
;

108 
	}
}

	@lib/util_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WIN32


23 
	~<wösock2.h
>

24 
	~<a˛≠i.h
>

25 
	~<io.h
>

26 
	~<lmc⁄s.h
>

28 
	~<sys/°©.h
>

31 #i‡!
deföed
(
WITH_TLS
Ë&& deföed(
__löux__
Ë&& deföed(
__GLIBC__
)

32 #i‡
__GLIBC_PREREQ
(2, 25)

33 
	~<sys/øndom.h
>

34 
	#HAVE_GETRANDOM
 1

	)

38 #ifde‡
WITH_TLS


39 
	~<›ís¶/bn.h
>

40 
	~<›ís¶/ønd.h
>

43 #ifde‡
WITH_BROKER


44 
	~"mosquôto_brokî_öã∫Æ.h
"

47 
	~"mosquôto.h
"

48 
	~"mem‹y_mosq.h
"

49 
	~"√t_mosq.h
"

50 
	~"£nd_mosq.h
"

51 
	~"time_mosq.h
"

52 
	~"és_mosq.h
"

53 
	~"utû_mosq.h
"

55 #ifde‡
WITH_WEBSOCKETS


56 
	~<libwebsockës.h
>

59 #ifde‡
WITH_BROKER


60 
	$mosquôto__check_kì∑live
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

62 
	$mosquôto__check_kì∑live
(
mosquôto
 *
mosq
)

65 
time_t
 
√xt_msg_out
;

66 
time_t
 
œ°_msg_ö
;

67 
time_t
 
now
 = 
	`mosquôto_time
();

68 #i‚de‡
WITH_BROKER


69 
rc
;

71 
°©e
;

73 
	`as£π
(
mosq
);

74 #i‡
	`deföed
(
WITH_BROKER
Ë&& deföed(
WITH_BRIDGE
)

76 if(
mosq
->
bridge
 && mosq->bridge->
°¨t_ty≥
 =
b°_œzy


77 && 
mosq
->
sock
 !
INVALID_SOCKET


78 && 
now
 - 
mosq
->
√xt_msg_out
 - mosq->
kì∑live
 >mosq->
bridge
->
idÀ_timeout
){

80 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Bridgêc⁄√˘i⁄ %†ha†ex˚eded idÀÅimeout, disc⁄√˘ög.", 
mosq
->
id
);

81 
	`√t__sockë_˛o£
(
db
, 
mosq
);

82  
MOSQ_ERR_SUCCESS
;

85 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

86 
√xt_msg_out
 = 
mosq
->next_msg_out;

87 
œ°_msg_ö
 = 
mosq
->last_msg_in;

88 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

89 if(
mosq
->
kì∑live
 && mosq->
sock
 !
INVALID_SOCKET
 &&

90 (
now
 >
√xt_msg_out
 ||Çow - 
œ°_msg_ö
 >
mosq
->
kì∑live
)){

92 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

93 if(
°©e
 =
mosq_cs_a˘ive
 && 
mosq
->
pög_t
 == 0){

94 
	`£nd__pögªq
(
mosq
);

96 
	`±hªad_muãx_lock
(&
mosq
->
msgtime_muãx
);

97 
mosq
->
œ°_msg_ö
 = 
now
;

98 
mosq
->
√xt_msg_out
 = 
now
 + mosq->
kì∑live
;

99 
	`±hªad_muãx_u∆ock
(&
mosq
->
msgtime_muãx
);

101 #ifde‡
WITH_BROKER


102 
	`√t__sockë_˛o£
(
db
, 
mosq
);

104 
	`√t__sockë_˛o£
(
mosq
);

105 
°©e
 = 
	`mosquôto__gë_°©e
(
mosq
);

106 if(
°©e
 =
mosq_cs_disc⁄√˘ög
){

107 
rc
 = 
MOSQ_ERR_SUCCESS
;

109 
rc
 = 
MOSQ_ERR_KEEPALIVE
;

111 
	`±hªad_muãx_lock
(&
mosq
->
ˇŒback_muãx
);

112 if(
mosq
->
⁄_disc⁄√˘
){

113 
mosq
->
ö_ˇŒback
 = 
åue
;

114 
mosq
->
	`⁄_disc⁄√˘
(mosq, mosq->
u£rd©a
, 
rc
);

115 
mosq
->
ö_ˇŒback
 = 
Ál£
;

117 if(
mosq
->
⁄_disc⁄√˘_v5
){

118 
mosq
->
ö_ˇŒback
 = 
åue
;

119 
mosq
->
	`⁄_disc⁄√˘_v5
(mosq, mosq->
u£rd©a
, 
rc
, 
NULL
);

120 
mosq
->
ö_ˇŒback
 = 
Ál£
;

122 
	`±hªad_muãx_u∆ock
(&
mosq
->
ˇŒback_muãx
);

124  
rc
;

128  
MOSQ_ERR_SUCCESS
;

129 
	}
}

131 
uöt16_t
 
	$mosquôto__mid_gíî©e
(
mosquôto
 *
mosq
)

140 
uöt16_t
 
mid
;

141 
	`as£π
(
mosq
);

143 
	`±hªad_muãx_lock
(&
mosq
->
mid_muãx
);

144 
mosq
->
œ°_mid
++;

145 if(
mosq
->
œ°_mid
 == 0) mosq->last_mid++;

146 
mid
 = 
mosq
->
œ°_mid
;

147 
	`±hªad_muãx_u∆ock
(&
mosq
->
mid_muãx
);

149  
mid
;

150 
	}
}

153 #ifde‡
WITH_TLS


154 
	$mosquôto__hex2bö_sha1
(c⁄° *
hex
, **
bö
)

156 *
sha
, 
tmp
[
SHA_DIGEST_LENGTH
];

158 if(
	`mosquôto__hex2bö
(
hex
, 
tmp
, 
SHA_DIGEST_LENGTH
) != SHA_DIGEST_LENGTH){

159  
MOSQ_ERR_INVAL
;

162 
sha
 = 
	`mosquôto__mÆloc
(
SHA_DIGEST_LENGTH
);

163 
	`mem˝y
(
sha
, 
tmp
, 
SHA_DIGEST_LENGTH
);

164 *
bö
 = 
sha
;

165  
MOSQ_ERR_SUCCESS
;

166 
	}
}

168 
	$mosquôto__hex2bö
(c⁄° *
hex
, *
bö
, 
bö_max_Àn
)

170 
BIGNUM
 *
bn
 = 
NULL
;

171 
Àn
;

172 
Àadög_zîo
 = 0;

173 
°¨t
 = 0;

174 
size_t
 
i
 = 0;

177 
i
=0; i<
	`°æí
(
hex
); i=i+2) {

178 if(
	`°∫cmp
(
hex
 + 
i
, "00", 2) == 0) {

179 
Àadög_zîo
++;

181 
bö
[
°¨t
++] = 0;

187 if(
	`BN_hex2bn
(&
bn
, 
hex
) == 0){

188 if(
bn
Ë
	`BN_‰ì
(bn);

191 if(
	`BN_num_byãs
(
bn
Ë+ 
Àadög_zîo
 > 
bö_max_Àn
){

192 
	`BN_‰ì
(
bn
);

196 
Àn
 = 
	`BN_bn2bö
(
bn
, 
bö
 + 
Àadög_zîo
);

197 
	`BN_‰ì
(
bn
);

198  
Àn
 + 
Àadög_zîo
;

199 
	}
}

202 
FILE
 *
	$mosquôto__f›í
(c⁄° *
∑th
, c⁄° *
mode
, 
boﬁ
 
ª°ri˘_ªad
)

204 #ifde‡
WIN32


205 
buf
[4096];

206 
rc
;

207 
rc
 = 
	`Ex∑ndEnvú⁄mítSåögs
(
∑th
, 
buf
, 4096);

208 if(
rc
 == 0 ||Ñc > 4096){

209  
NULL
;

211 i‡(
ª°ri˘_ªad
) {

212 
HANDLE
 
hfûe
;

213 
SECURITY_ATTRIBUTES
 
£c
;

214 
EXPLICIT_ACCESS
 
ó
;

215 
PACL
 
∑˛
 = 
NULL
;

216 
u£∫ame
[
UNLEN
 + 1];

217 
uÀn
 = 
UNLEN
;

218 
SECURITY_DESCRIPTOR
 
sd
;

219 
DWORD
 
dwCª©i⁄Di•osôi⁄
;

221 
mode
[0]){

223 
dwCª©i⁄Di•osôi⁄
 = 
OPEN_ALWAYS
;

226 
dwCª©i⁄Di•osôi⁄
 = 
OPEN_EXISTING
;

229 
dwCª©i⁄Di•osôi⁄
 = 
CREATE_ALWAYS
;

232  
NULL
;

235 
	`GëU£rName
(
u£∫ame
, &
uÀn
);

236 i‡(!
	`InôülizeSecurôyDes¸ùt‹
(&
sd
, 
SECURITY_DESCRIPTOR_REVISION
)) {

237  
NULL
;

239 
	`BuûdEx∂icôAc˚ssWôhName
(&
ó
, 
u£∫ame
, 
GENERIC_ALL
, 
SET_ACCESS
, 
NO_INHERITANCE
);

240 i‡(
	`SëE¡rõsInA˛
(1, &
ó
, 
NULL
, &
∑˛
Ë!
ERROR_SUCCESS
) {

241  
NULL
;

243 i‡(!
	`SëSecurôyDes¸ùt‹Da˛
(&
sd
, 
TRUE
, 
∑˛
, 
FALSE
)) {

244 
	`LoˇlFªe
(
∑˛
);

245  
NULL
;

248 
£c
.
nLígth
 = (
SECURITY_ATTRIBUTES
);

249 
£c
.
bInhîôH™dÀ
 = 
FALSE
;

250 
£c
.
ÕSecurôyDes¸ùt‹
 = &
sd
;

252 
hfûe
 = 
	`Cª©eFûe
(
buf
, 
GENERIC_READ
 | 
GENERIC_WRITE
, 
FILE_SHARE_READ
,

253 &
£c
,

254 
dwCª©i⁄Di•osôi⁄
,

255 
FILE_ATTRIBUTE_NORMAL
,

256 
NULL
);

258 
	`LoˇlFªe
(
∑˛
);

260 
fd
 = 
	`_›í_osfh™dÀ
((
öçå_t
)
hfûe
, 0);

261 i‡(
fd
 < 0) {

262  
NULL
;

265 
FILE
 *
Âå
 = 
	`_fd›í
(
fd
, 
mode
);

266 i‡(!
Âå
) {

267 
	`_˛o£
(
fd
);

268  
NULL
;

270  
Âå
;

273  
	`f›í
(
buf
, 
mode
);

277 i‡(
ª°ri˘_ªad
) {

278 
FILE
 *
Âå
;

279 
mode_t
 
ﬁd_mask
;

281 
ﬁd_mask
 = 
	`umask
(0077);

282 
Âå
 = 
	`f›í
(
∑th
, 
mode
);

283 
	`umask
(
ﬁd_mask
);

285  
Âå
;

287  
	`f›í
(
∑th
, 
mode
);

290 
	}
}

292 
	$utû__ö¸emít_ª˚ive_quŸa
(
mosquôto
 *
mosq
)

294 if(
mosq
->
msgs_ö
.
öÊight_quŸa
 < mosq->msgs_ö.
öÊight_maximum
){

295 
mosq
->
msgs_ö
.
öÊight_quŸa
++;

297 
	}
}

299 
	$utû__ö¸emít_£nd_quŸa
(
mosquôto
 *
mosq
)

301 if(
mosq
->
msgs_out
.
öÊight_quŸa
 < mosq->msgs_out.
öÊight_maximum
){

302 
mosq
->
msgs_out
.
öÊight_quŸa
++;

304 
	}
}

307 
	$utû__de¸emít_ª˚ive_quŸa
(
mosquôto
 *
mosq
)

309 if(
mosq
->
msgs_ö
.
öÊight_quŸa
 > 0){

310 
mosq
->
msgs_ö
.
öÊight_quŸa
--;

312 
	}
}

314 
	$utû__de¸emít_£nd_quŸa
(
mosquôto
 *
mosq
)

316 if(
mosq
->
msgs_out
.
öÊight_quŸa
 > 0){

317 
mosq
->
msgs_out
.
öÊight_quŸa
--;

319 
	}
}

322 
	$utû__øndom_byãs
(*
byãs
, 
cou¡
)

324 
rc
 = 
MOSQ_ERR_UNKNOWN
;

326 #ifde‡
WITH_TLS


327 if(
	`RAND_byãs
(
byãs
, 
cou¡
) == 1){

328 
rc
 = 
MOSQ_ERR_SUCCESS
;

330 #ñi‡
	`deföed
(
HAVE_GETRANDOM
)

331 if(
	`gëøndom
(
byãs
, 
cou¡
, 0) == count){

332 
rc
 = 
MOSQ_ERR_SUCCESS
;

334 #ñi‡
	`deföed
(
WIN32
)

335 
HCRYPTPROV
 
¥ovidî
;

337 if(!
	`Cry±AcquúeC⁄ãxt
(&
¥ovidî
, 
NULL
, NULL, 
PROV_RSA_FULL
, 
CRYPT_VERIFYCONTEXT
)){

338  
MOSQ_ERR_UNKNOWN
;

341 if(
	`Cry±GíR™dom
(
¥ovidî
, 
cou¡
, 
byãs
)){

342 
rc
 = 
MOSQ_ERR_SUCCESS
;

345 
	`Cry±Rñó£C⁄ãxt
(
¥ovidî
, 0);

347 
i
;

349 
i
=0; i<
cou¡
; i++){

350 ((
uöt8_t
 *)
byãs
)[
i
] = (uöt8_à)(
	`øndom
()&0xFF);

352 
rc
 = 
MOSQ_ERR_SUCCESS
;

354  
rc
;

355 
	}
}

358 
	$mosquôto__£t_°©e
(
mosquôto
 *
mosq
, 
mosquôto_˛õ¡_°©e
 
°©e
)

360 
	`±hªad_muãx_lock
(&
mosq
->
°©e_muãx
);

361 #ifde‡
WITH_BROKER


362 if(
mosq
->
°©e
 !
mosq_cs_disu£d
)

365 
mosq
->
°©e
 = state;

367 
	`±hªad_muãx_u∆ock
(&
mosq
->
°©e_muãx
);

369  
MOSQ_ERR_SUCCESS
;

370 
	}
}

372 
mosquôto_˛õ¡_°©e
 
	$mosquôto__gë_°©e
(
mosquôto
 *
mosq
)

374 
mosquôto_˛õ¡_°©e
 
°©e
;

376 
	`±hªad_muãx_lock
(&
mosq
->
°©e_muãx
);

377 
°©e
 = 
mosq
->state;

378 
	`±hªad_muãx_u∆ock
(&
mosq
->
°©e_muãx
);

380  
°©e
;

381 
	}
}

	@lib/util_mosq.h

16 #i‚de‡
UTIL_MOSQ_H


17 
	#UTIL_MOSQ_H


	)

19 
	~<°dio.h
>

21 
	~"és_mosq.h
"

22 
	~"mosquôto.h
"

23 
	~"mosquôto_öã∫Æ.h
"

24 #ifde‡
WITH_BROKER


25 
	~"mosquôto_brokî_öã∫Æ.h
"

28 #ifde‡
WITH_BROKER


29 
mosquôto__check_kì∑live
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

31 
mosquôto__check_kì∑live
(
mosquôto
 *
mosq
);

33 
uöt16_t
 
mosquôto__mid_gíî©e
(
mosquôto
 *
mosq
);

34 
FILE
 *
mosquôto__f›í
(c⁄° *
∑th
, c⁄° *
mode
, 
boﬁ
 
ª°ri˘_ªad
);

36 
mosquôto__£t_°©e
(
mosquôto
 *
mosq
, 
mosquôto_˛õ¡_°©e
 
°©e
);

37 
mosquôto_˛õ¡_°©e
 
mosquôto__gë_°©e
(
mosquôto
 *
mosq
);

39 #ifde‡
WITH_TLS


40 
mosquôto__hex2bö_sha1
(c⁄° *
hex
, **
bö
);

41 
mosquôto__hex2bö
(c⁄° *
hex
, *
bö
, 
bö_max_Àn
);

44 
utû__øndom_byãs
(*
byãs
, 
cou¡
);

46 
utû__ö¸emít_ª˚ive_quŸa
(
mosquôto
 *
mosq
);

47 
utû__ö¸emít_£nd_quŸa
(
mosquôto
 *
mosq
);

48 
utû__de¸emít_ª˚ive_quŸa
(
mosquôto
 *
mosq
);

49 
utû__de¸emít_£nd_quŸa
(
mosquôto
 *
mosq
);

	@lib/util_topic.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°rög.h
>

22 #ifde‡
WIN32


23 
	~<wösock2.h
>

24 
	~<a˛≠i.h
>

25 
	~<io.h
>

26 
	~<lmc⁄s.h
>

28 
	~<sys/°©.h
>

32 #ifde‡
WITH_BROKER


33 
	~"mosquôto_brokî_öã∫Æ.h
"

36 
	~"mosquôto.h
"

37 
	~"mem‹y_mosq.h
"

38 
	~"√t_mosq.h
"

39 
	~"£nd_mosq.h
"

40 
	~"time_mosq.h
"

41 
	~"és_mosq.h
"

42 
	~"utû_mosq.h
"

49 
	$mosquôto_pub_t›ic_check
(c⁄° *
°r
)

51 
Àn
 = 0;

52 #ifde‡
WITH_BROKER


53 
hõr_cou¡
 = 0;

55 
°r
 && str[0]){

56 if(
°r
[0] == '+' || str[0] == '#'){

57  
MOSQ_ERR_INVAL
;

59 #ifde‡
WITH_BROKER


60 if(
°r
[0] == '/'){

61 
hõr_cou¡
++;

64 
Àn
++;

65 
°r
 = &str[1];

67 if(
Àn
 > 65535Ë 
MOSQ_ERR_INVAL
;

68 #ifde‡
WITH_BROKER


69 if(
hõr_cou¡
 > 
TOPIC_HIERARCHY_LIMIT
Ë 
MOSQ_ERR_INVAL
;

72  
MOSQ_ERR_SUCCESS
;

73 
	}
}

75 
	$mosquôto_pub_t›ic_check2
(c⁄° *
°r
, 
size_t
 
Àn
)

77 
size_t
 
i
;

78 #ifde‡
WITH_BROKER


79 
hõr_cou¡
 = 0;

82 if(
Àn
 > 65535Ë 
MOSQ_ERR_INVAL
;

84 
i
=0; i<
Àn
; i++){

85 if(
°r
[
i
] == '+' || str[i] == '#'){

86  
MOSQ_ERR_INVAL
;

88 #ifde‡
WITH_BROKER


89 if(
°r
[
i
] == '/'){

90 
hõr_cou¡
++;

94 #ifde‡
WITH_BROKER


95 if(
hõr_cou¡
 > 
TOPIC_HIERARCHY_LIMIT
Ë 
MOSQ_ERR_INVAL
;

98  
MOSQ_ERR_SUCCESS
;

99 
	}
}

108 
	$mosquôto_sub_t›ic_check
(c⁄° *
°r
)

110 
c
 = '\0';

111 
Àn
 = 0;

112 #ifde‡
WITH_BROKER


113 
hõr_cou¡
 = 0;

116 
°r
 && str[0]){

117 if(
°r
[0] == '+'){

118 if((
c
 !'\0' && c !'/'Ë|| (
°r
[1] != '\0' && str[1] != '/')){

119  
MOSQ_ERR_INVAL
;

121 }if(
°r
[0] == '#'){

122 if((
c
 !'\0' && c !'/'Ë|| 
°r
[1] != '\0'){

123  
MOSQ_ERR_INVAL
;

126 #ifde‡
WITH_BROKER


127 if(
°r
[0] == '/'){

128 
hõr_cou¡
++;

131 
Àn
++;

132 
c
 = 
°r
[0];

133 
°r
 = &str[1];

135 if(
Àn
 > 65535Ë 
MOSQ_ERR_INVAL
;

136 #ifde‡
WITH_BROKER


137 if(
hõr_cou¡
 > 
TOPIC_HIERARCHY_LIMIT
Ë 
MOSQ_ERR_INVAL
;

140  
MOSQ_ERR_SUCCESS
;

141 
	}
}

143 
	$mosquôto_sub_t›ic_check2
(c⁄° *
°r
, 
size_t
 
Àn
)

145 
c
 = '\0';

146 
size_t
 
i
;

147 #ifde‡
WITH_BROKER


148 
hõr_cou¡
 = 0;

151 if(
Àn
 > 65535Ë 
MOSQ_ERR_INVAL
;

153 
i
=0; i<
Àn
; i++){

154 if(
°r
[
i
] == '+'){

155 if((
c
 !'\0' && c !'/'Ë|| (
i
<
Àn
-1 && 
°r
[i+1] != '/')){

156  
MOSQ_ERR_INVAL
;

158 }if(
°r
[
i
] == '#'){

159 if((
c
 !'\0' && c !'/'Ë|| 
i
<
Àn
-1){

160  
MOSQ_ERR_INVAL
;

163 #ifde‡
WITH_BROKER


164 if(
°r
[
i
] == '/'){

165 
hõr_cou¡
++;

168 
c
 = 
°r
[
i
];

170 #ifde‡
WITH_BROKER


171 if(
hõr_cou¡
 > 
TOPIC_HIERARCHY_LIMIT
Ë 
MOSQ_ERR_INVAL
;

174  
MOSQ_ERR_SUCCESS
;

175 
	}
}

177 
	$mosquôto_t›ic_m©ches_sub
(c⁄° *
sub
, c⁄° *
t›ic
, 
boﬁ
 *
ªsu…
)

179  
	`mosquôto_t›ic_m©ches_sub2
(
sub
, 0, 
t›ic
, 0, 
ªsu…
);

180 
	}
}

183 
	$mosquôto_t›ic_m©ches_sub2
(c⁄° *
sub
, 
size_t
 
subÀn
, c⁄° *
t›ic
, size_à
t›i˛í
, 
boﬁ
 *
ªsu…
)

185 
size_t
 
•os
;

187 
	`UNUSED
(
subÀn
);

188 
	`UNUSED
(
t›i˛í
);

190 if(!
ªsu…
Ë 
MOSQ_ERR_INVAL
;

191 *
ªsu…
 = 
Ál£
;

193 if(!
sub
 || !
t›ic
 || sub[0] == 0 ||Åopic[0] == 0){

194  
MOSQ_ERR_INVAL
;

197 if((
sub
[0] ='$' && 
t›ic
[0] != '$')

198 || (
t›ic
[0] ='$' && 
sub
[0] != '$')){

200  
MOSQ_ERR_SUCCESS
;

203 
•os
 = 0;

205 
sub
[0] != 0){

206 if(
t›ic
[0] == '+' ||Åopic[0] == '#'){

207  
MOSQ_ERR_INVAL
;

209 if(
sub
[0] !
t›ic
[0] ||Åopic[0] == 0){

210 if(
sub
[0] == '+'){

212 if(
•os
 > 0 && 
sub
[-1] != '/'){

213  
MOSQ_ERR_INVAL
;

216 if(
sub
[1] != 0 && sub[1] != '/'){

217  
MOSQ_ERR_INVAL
;

219 
•os
++;

220 
sub
++;

221 
t›ic
[0] != 0 &&Åopic[0] != '/'){

222 
t›ic
++;

224 if(
t›ic
[0] =0 && 
sub
[0] == 0){

225 *
ªsu…
 = 
åue
;

226  
MOSQ_ERR_SUCCESS
;

228 }if(
sub
[0] == '#'){

230 if(
•os
 > 0 && 
sub
[-1] != '/'){

231  
MOSQ_ERR_INVAL
;

234 if(
sub
[1] != 0){

235  
MOSQ_ERR_INVAL
;

237 *
ªsu…
 = 
åue
;

238  
MOSQ_ERR_SUCCESS
;

242 if(
t›ic
[0] == 0

243 && 
•os
 > 0

244 && 
sub
[-1] == '+'

245 && 
sub
[0] == '/'

246 && 
sub
[1] == '#')

248 *
ªsu…
 = 
åue
;

249  
MOSQ_ERR_SUCCESS
;

253 
sub
[0] != 0){

254 if(
sub
[0] == '#' && sub[1] != 0){

255  
MOSQ_ERR_INVAL
;

257 
•os
++;

258 
sub
++;

262  
MOSQ_ERR_SUCCESS
;

266 if(
t›ic
[1] == 0){

268 if(
sub
[1] == '/'

269 && 
sub
[2] == '#'

270 && 
sub
[3] == 0){

271 *
ªsu…
 = 
åue
;

272  
MOSQ_ERR_SUCCESS
;

275 
•os
++;

276 
sub
++;

277 
t›ic
++;

278 if(
sub
[0] =0 && 
t›ic
[0] == 0){

279 *
ªsu…
 = 
åue
;

280  
MOSQ_ERR_SUCCESS
;

281 }if(
t›ic
[0] =0 && 
sub
[0] == '+' && sub[1] == 0){

282 if(
•os
 > 0 && 
sub
[-1] != '/'){

283  
MOSQ_ERR_INVAL
;

285 
•os
++;

286 
sub
++;

287 *
ªsu…
 = 
åue
;

288  
MOSQ_ERR_SUCCESS
;

292 if((
t›ic
[0] !0 || 
sub
[0] != 0)){

293 *
ªsu…
 = 
Ál£
;

296  
MOSQ_ERR_SUCCESS
;

297 
	}
}

	@lib/will_mosq.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 #ifde‡
WITH_BROKER


23 
	~"mosquôto_brokî_öã∫Æ.h
"

26 
	~"mosquôto.h
"

27 
	~"mosquôto_öã∫Æ.h
"

28 
	~"loggög_mosq.h
"

29 
	~"mesßges_mosq.h
"

30 
	~"mem‹y_mosq.h
"

31 
	~"mqâ_¥Ÿocﬁ.h
"

32 
	~"√t_mosq.h
"

33 
	~"ªad_h™dÀ.h
"

34 
	~"£nd_mosq.h
"

35 
	~"utû_mosq.h
"

36 
	~"wûl_mosq.h
"

38 
	$wûl__£t
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_¥›îty
 *
¥›îtõs
)

40 
rc
 = 
MOSQ_ERR_SUCCESS
;

41 
mosquôto_¥›îty
 *
p
;

43 if(!
mosq
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

44 if(
∑ylﬂdÀn
 < 0 ||ÖaylﬂdÀ¿> 
MQTT_MAX_PAYLOAD
Ë 
MOSQ_ERR_PAYLOAD_SIZE
;

45 if(
∑ylﬂdÀn
 > 0 && !
∑ylﬂd
Ë 
MOSQ_ERR_INVAL
;

47 if(
	`mosquôto_pub_t›ic_check
(
t›ic
)Ë 
MOSQ_ERR_INVAL
;

48 if(
	`mosquôto_vÆid©e_utf8
(
t›ic
, 
	`°æí
—›ic))Ë 
MOSQ_ERR_MALFORMED_UTF8
;

50 if(
¥›îtõs
){

51 if(
mosq
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

52  
MOSQ_ERR_NOT_SUPPORTED
;

54 
p
 = 
¥›îtõs
;

55 
p
){

56 
rc
 = 
	`mosquôto_¥›îty_check_comm™d
(
CMD_WILL
, 
p
->
idítifõr
);

57 if(
rc
) Ñc;

58 
p
 =Ö->
√xt
;

62 if(
mosq
->
wûl
){

63 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
t›ic
);

64 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
∑ylﬂd
);

65 
	`mosquôto_¥›îty_‰ì_Æl
(&
mosq
->
wûl
->
¥›îtõs
);

66 
	`mosquôto__‰ì
(
mosq
->
wûl
);

69 
mosq
->
wûl
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_mesßge_Æl
));

70 if(!
mosq
->
wûl
Ë 
MOSQ_ERR_NOMEM
;

71 
mosq
->
wûl
->
msg
.
t›ic
 = 
	`mosquôto__°rdup
(topic);

72 if(!
mosq
->
wûl
->
msg
.
t›ic
){

73 
rc
 = 
MOSQ_ERR_NOMEM
;

74 
˛ónup
;

76 
mosq
->
wûl
->
msg
.
∑ylﬂdÀn
 =Öayloadlen;

77 if(
mosq
->
wûl
->
msg
.
∑ylﬂdÀn
 > 0){

78 if(!
∑ylﬂd
){

79 
rc
 = 
MOSQ_ERR_INVAL
;

80 
˛ónup
;

82 
mosq
->
wûl
->
msg
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(()*mosq->wûl->msg.
∑ylﬂdÀn
);

83 if(!
mosq
->
wûl
->
msg
.
∑ylﬂd
){

84 
rc
 = 
MOSQ_ERR_NOMEM
;

85 
˛ónup
;

88 
	`mem˝y
(
mosq
->
wûl
->
msg
.
∑ylﬂd
,Öaylﬂd, 
∑ylﬂdÀn
);

90 
mosq
->
wûl
->
msg
.
qos
 = qos;

91 
mosq
->
wûl
->
msg
.
ªèö
 =Ñetain;

93 
mosq
->
wûl
->
¥›îtõs
 =Öroperties;

95  
MOSQ_ERR_SUCCESS
;

97 
˛ónup
:

98 if(
mosq
->
wûl
){

99 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
t›ic
);

100 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
∑ylﬂd
);

102 
	`mosquôto__‰ì
(
mosq
->
wûl
);

103 
mosq
->
wûl
 = 
NULL
;

106  
rc
;

107 
	}
}

109 
	$wûl__˛ór
(
mosquôto
 *
mosq
)

111 if(!
mosq
->
wûl
Ë 
MOSQ_ERR_SUCCESS
;

113 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
t›ic
);

114 
mosq
->
wûl
->
msg
.
t›ic
 = 
NULL
;

116 
	`mosquôto__‰ì
(
mosq
->
wûl
->
msg
.
∑ylﬂd
);

117 
mosq
->
wûl
->
msg
.
∑ylﬂd
 = 
NULL
;

119 
	`mosquôto_¥›îty_‰ì_Æl
(&
mosq
->
wûl
->
¥›îtõs
);

121 
	`mosquôto__‰ì
(
mosq
->
wûl
);

122 
mosq
->
wûl
 = 
NULL
;

124  
MOSQ_ERR_SUCCESS
;

125 
	}
}

	@lib/will_mosq.h

17 #i‚de‡
WILL_MOSQ_H


18 
	#WILL_MOSQ_H


	)

20 
	~"mosquôto.h
"

21 
	~"mosquôto_öã∫Æ.h
"

23 
wûl__£t
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_¥›îty
 *
¥›îtõs
);

24 
wûl__˛ór
(
mosquôto
 *
mosq
);

	@src/bridge.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<î∫o.h
>

21 
	~<°dio.h
>

22 
	~<°rög.h
>

24 #i‚de‡
WIN32


25 
	~<√tdb.h
>

26 
	~<sys/sockë.h
>

28 
	~<wösock2.h
>

29 
	~<ws2t˝ù.h
>

32 
	~"mqâ_¥Ÿocﬁ.h
"

33 
	~"mosquôto.h
"

34 
	~"mosquôto_brokî_öã∫Æ.h
"

35 
	~"mosquôto_öã∫Æ.h
"

36 
	~"√t_mosq.h
"

37 
	~"mem‹y_mosq.h
"

38 
	~"∑ckë_mosq.h
"

39 
	~"£nd_mosq.h
"

40 
	~"time_mosq.h
"

41 
	~"és_mosq.h
"

42 
	~"utû_mosq.h
"

43 
	~"wûl_mosq.h
"

45 #ifde‡
WITH_BRIDGE


47 
bridge__backoff_°ï
(
mosquôto
 *
c⁄ãxt
);

48 
bridge__backoff_ª£t
(
mosquôto
 *
c⁄ãxt
);

50 
	$bridge__√w
(
mosquôto_db
 *
db
, 
mosquôto__bridge
 *
bridge
)

52 
mosquôto
 *
√w_c⁄ãxt
 = 
NULL
;

53 
mosquôto
 **
bridges
;

54 *
loˇl_id
;

56 
	`as£π
(
db
);

57 
	`as£π
(
bridge
);

59 
loˇl_id
 = 
	`mosquôto__°rdup
(
bridge
->
loˇl_˛õ¡id
);

61 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
loˇl_id
, 
	`°æí
÷oˇl_id), 
√w_c⁄ãxt
);

62 if(
√w_c⁄ãxt
){

64 
	`mosquôto__‰ì
(
loˇl_id
);

67 
√w_c⁄ãxt
 = 
	`c⁄ãxt__öô
(
db
, -1);

68 if(!
√w_c⁄ãxt
){

69 
	`mosquôto__‰ì
(
loˇl_id
);

70  
MOSQ_ERR_NOMEM
;

72 
√w_c⁄ãxt
->
id
 = 
loˇl_id
;

73 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
√w_c⁄ãxt
->
id
, 
	`°æí
(new_context->id),Çew_context);

75 
√w_c⁄ãxt
->
bridge
 = bridge;

76 
√w_c⁄ãxt
->
is_bridge
 = 
åue
;

78 
√w_c⁄ãxt
->
u£∫ame
 =Çew_c⁄ãxt->
bridge
->
ªmŸe_u£∫ame
;

79 
√w_c⁄ãxt
->
∑ssw‹d
 =Çew_c⁄ãxt->
bridge
->
ªmŸe_∑ssw‹d
;

81 #ifde‡
WITH_TLS


82 
√w_c⁄ãxt
->
és_ˇfûe
 =Çew_c⁄ãxt->
bridge
->tls_cafile;

83 
√w_c⁄ãxt
->
és_ˇ∑th
 =Çew_c⁄ãxt->
bridge
->tls_capath;

84 
√w_c⁄ãxt
->
és_˚πfûe
 =Çew_c⁄ãxt->
bridge
->tls_certfile;

85 
√w_c⁄ãxt
->
és_keyfûe
 =Çew_c⁄ãxt->
bridge
->tls_keyfile;

86 
√w_c⁄ãxt
->
és_˚π_ªqs
 = 
SSL_VERIFY_PEER
;

87 
√w_c⁄ãxt
->
és_oc•_ªquúed
 =Çew_c⁄ãxt->
bridge
->tls_ocsp_required;

88 
√w_c⁄ãxt
->
és_vîsi⁄
 =Çew_c⁄ãxt->
bridge
->tls_version;

89 
√w_c⁄ãxt
->
és_ö£cuª
 =Çew_c⁄ãxt->
bridge
->tls_insecure;

90 
√w_c⁄ãxt
->
és_Æ≤
 =Çew_c⁄ãxt->
bridge
->tls_alpn;

91 
√w_c⁄ãxt
->
és_ígöe
 = 
db
->
c⁄fig
->
deÁu…_li°íî
.tls_engine;

92 
√w_c⁄ãxt
->
és_keyf‹m
 = 
db
->
c⁄fig
->
deÁu…_li°íî
.tls_keyform;

93 #ifde‡
FINAL_WITH_TLS_PSK


94 
√w_c⁄ãxt
->
és_psk_idítôy
 =Çew_c⁄ãxt->
bridge
->tls_psk_identity;

95 
√w_c⁄ãxt
->
és_psk
 =Çew_c⁄ãxt->
bridge
->tls_psk;

99 
bridge
->
åy_¥iv©e_ac˚±ed
 = 
åue
;

100 
√w_c⁄ãxt
->
¥Ÿocﬁ
 = 
bridge
->
¥Ÿocﬁ_vîsi⁄
;

102 
bridges
 = 
	`mosquôto__ªÆloc
(
db
->bridges, (db->
bridge_cou¡
+1)*(
mosquôto
 *));

103 if(
bridges
){

104 
db
->
bridges
 = bridges;

105 
db
->
bridge_cou¡
++;

106 
db
->
bridges
[db->
bridge_cou¡
-1] = 
√w_c⁄ãxt
;

108  
MOSQ_ERR_NOMEM
;

111 #i‡
	`deföed
(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

112 
√w_c⁄ãxt
->
bridge
->
ª°¨t_t
 = 1;

113  
	`bridge__c⁄√˘_°ï1
(
db
, 
√w_c⁄ãxt
);

115  
	`bridge__c⁄√˘
(
db
, 
√w_c⁄ãxt
);

117 
	}
}

119 #i‡
deföed
(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

120 
	$bridge__c⁄√˘_°ï1
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

122 
rc
;

123 *
nŸifiˇti⁄_t›ic
;

124 
nŸifiˇti⁄_t›ic_Àn
;

125 
uöt8_t
 
nŸifiˇti⁄_∑ylﬂd
;

126 
i
;

128 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
Ë 
MOSQ_ERR_INVAL
;

130 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_√w
);

131 
c⁄ãxt
->
sock
 = 
INVALID_SOCKET
;

132 
c⁄ãxt
->
œ°_msg_ö
 = 
	`mosquôto_time
();

133 
c⁄ãxt
->
√xt_msg_out
 = 
	`mosquôto_time
(Ë+ c⁄ãxt->
bridge
->
kì∑live
;

134 
c⁄ãxt
->
kì∑live
 = c⁄ãxt->
bridge
->keepalive;

135 
c⁄ãxt
->
˛ón_°¨t
 = c⁄ãxt->
bridge
->clean_start;

136 
c⁄ãxt
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

137 
c⁄ãxt
->
pög_t
 = 0;

138 
c⁄ãxt
->
bridge
->
œzy_ªc⁄√˘
 = 
Ál£
;

139 
	`bridge__∑ckë_˛ónup
(
c⁄ãxt
);

140 
	`db__mesßge_ªc⁄√˘_ª£t
(
db
, 
c⁄ãxt
);

142 if(
c⁄ãxt
->
˛ón_°¨t
){

143 
	`db__mesßges_dñëe
(
db
, 
c⁄ãxt
);

150 
	`sub__˛ón_£ssi⁄
(
db
, 
c⁄ãxt
);

152 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

153 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_out
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

154 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Bridgê%†doögÜoˇ»SUBSCRIBE o¿t›i¯%s", 
c⁄ãxt
->
id
, c⁄ãxt->
bridge
->
t›ics
[
i
].
loˇl_t›ic
);

155 if(
	`sub__add
(
db
,

156 
c⁄ãxt
,

157 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
loˇl_t›ic
,

158 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
qos
,

160 
MQTT_SUB_OPT_NO_LOCAL
 | 
MQTT_SUB_OPT_RETAIN_AS_PUBLISHED
,

161 &
db
->
subs
) > 0){

164 
	`sub__ªèö_queue
(
db
, 
c⁄ãxt
,

165 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
loˇl_t›ic
,

166 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
qos
, 0);

171 
	`bridge__backoff_°ï
(
c⁄ãxt
);

173 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s
){

174 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
){

175 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

176 
nŸifiˇti⁄_∑ylﬂd
 = '0';

177 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

178 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

180 
nŸifiˇti⁄_∑ylﬂd
 = '0';

181 
rc
 = 
	`wûl__£t
(
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 
NULL
);

182 if(
rc
 !
MOSQ_ERR_SUCCESS
){

183  
rc
;

186 
nŸifiˇti⁄_t›ic_Àn
 = 
	`°æí
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
)+strlen("$SYS/broker/connection//state");

187 
nŸifiˇti⁄_t›ic
 = 
	`mosquôto__mÆloc
(()*(
nŸifiˇti⁄_t›ic_Àn
+1));

188 if(!
nŸifiˇti⁄_t›ic
Ë 
MOSQ_ERR_NOMEM
;

190 
	`¢¥ötf
(
nŸifiˇti⁄_t›ic
, 
nŸifiˇti⁄_t›ic_Àn
+1, "$SYS/brokî/c⁄√˘i⁄/%s/°©e", 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

192 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

193 
nŸifiˇti⁄_∑ylﬂd
 = '0';

194 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

195 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

198 
nŸifiˇti⁄_∑ylﬂd
 = '0';

199 
rc
 = 
	`wûl__£t
(
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 
NULL
);

200 
	`mosquôto__‰ì
(
nŸifiˇti⁄_t›ic
);

201 if(
rc
 !
MOSQ_ERR_SUCCESS
){

202  
rc
;

207 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "C⁄√˘ög bridgê(°ï 1Ë%†(%s:%d)", 
c⁄ãxt
->
bridge
->
«me
, c⁄ãxt->bridge->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
);

208 
rc
 = 
	`√t__åy_c⁄√˘_°ï1
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
);

209 if(
rc
 > 0 ){

210 if(
rc
 =
MOSQ_ERR_TLS
){

211 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

212  
rc
;

213 }if(
rc
 =
MOSQ_ERR_ERRNO
){

214 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

215 }if(
rc
 =
MOSQ_ERR_EAI
){

216 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

219  
rc
;

222  
MOSQ_ERR_SUCCESS
;

223 
	}
}

226 
	$bridge__c⁄√˘_°ï2
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

228 
rc
;

230 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
Ë 
MOSQ_ERR_INVAL
;

232 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "C⁄√˘ög bridgê(°ï 2Ë%†(%s:%d)", 
c⁄ãxt
->
bridge
->
«me
, c⁄ãxt->bridge->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
);

233 
rc
 = 
	`√t__åy_c⁄√˘_°ï2
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
p‹t
, &c⁄ãxt->
sock
);

234 if(
rc
 > 0){

235 if(
rc
 =
MOSQ_ERR_TLS
){

236 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

237  
rc
;

238 }if(
rc
 =
MOSQ_ERR_ERRNO
){

239 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

240 }if(
rc
 =
MOSQ_ERR_EAI
){

241 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

244  
rc
;

247 
	`HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
c⁄ãxt
->sock), context);

249 if(
rc
 =
MOSQ_ERR_CONN_PENDING
){

250 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_c⁄√˘_≥ndög
);

252  
rc
;

253 
	}
}

256 
	$bridge__c⁄√˘_°ï3
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

258 
rc
;

260 
rc
 = 
	`√t__sockë_c⁄√˘_°ï3
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
);

261 if(
rc
 > 0){

262 if(
rc
 =
MOSQ_ERR_TLS
){

263 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

264  
rc
;

265 }if(
rc
 =
MOSQ_ERR_ERRNO
){

266 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

267 }if(
rc
 =
MOSQ_ERR_EAI
){

268 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

271  
rc
;

274 if(
c⁄ãxt
->
bridge
->
round_robö
 =
Ál£
 && c⁄ãxt->bridge->
cur_addªss
 != 0){

275 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 
	`mosquôto_time
() + 5;

278 
rc
 = 
	`£nd__c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
kì∑live
, c⁄ãxt->
˛ón_°¨t
, 
NULL
);

279 if(
rc
 =
MOSQ_ERR_SUCCESS
){

280 
	`bridge__backoff_ª£t
(
c⁄ãxt
);

281  
MOSQ_ERR_SUCCESS
;

282 }if(
rc
 =
MOSQ_ERR_ERRNO
 && 
î∫o
 =
ENOTCONN
){

283 
	`bridge__backoff_ª£t
(
c⁄ãxt
);

284  
MOSQ_ERR_SUCCESS
;

286 if(
rc
 =
MOSQ_ERR_TLS
){

287  
rc
;

288 }if(
rc
 =
MOSQ_ERR_ERRNO
){

289 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

290 }if(
rc
 =
MOSQ_ERR_EAI
){

291 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

293 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

294  
rc
;

296 
	}
}

299 
	$bridge__c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

301 
rc
, 
rc2
;

302 
i
;

303 *
nŸifiˇti⁄_t›ic
;

304 
nŸifiˇti⁄_t›ic_Àn
;

305 
uöt8_t
 
nŸifiˇti⁄_∑ylﬂd
;

307 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
Ë 
MOSQ_ERR_INVAL
;

309 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_√w
);

310 
c⁄ãxt
->
sock
 = 
INVALID_SOCKET
;

311 
c⁄ãxt
->
œ°_msg_ö
 = 
	`mosquôto_time
();

312 
c⁄ãxt
->
√xt_msg_out
 = 
	`mosquôto_time
(Ë+ c⁄ãxt->
bridge
->
kì∑live
;

313 
c⁄ãxt
->
kì∑live
 = c⁄ãxt->
bridge
->keepalive;

314 
c⁄ãxt
->
˛ón_°¨t
 = c⁄ãxt->
bridge
->clean_start;

315 
c⁄ãxt
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

316 
c⁄ãxt
->
pög_t
 = 0;

317 
c⁄ãxt
->
bridge
->
œzy_ªc⁄√˘
 = 
Ál£
;

318 
	`bridge__∑ckë_˛ónup
(
c⁄ãxt
);

319 
	`db__mesßge_ªc⁄√˘_ª£t
(
db
, 
c⁄ãxt
);

321 if(
c⁄ãxt
->
˛ón_°¨t
){

322 
	`db__mesßges_dñëe
(
db
, 
c⁄ãxt
);

329 
	`sub__˛ón_£ssi⁄
(
db
, 
c⁄ãxt
);

331 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

332 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_out
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

333 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Bridgê%†doögÜoˇ»SUBSCRIBE o¿t›i¯%s", 
c⁄ãxt
->
id
, c⁄ãxt->
bridge
->
t›ics
[
i
].
loˇl_t›ic
);

334 if(
	`sub__add
(
db
,

335 
c⁄ãxt
,

336 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
loˇl_t›ic
,

337 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
qos
,

339 
MQTT_SUB_OPT_NO_LOCAL
 | 
MQTT_SUB_OPT_RETAIN_AS_PUBLISHED
,

340 &
db
->
subs
) > 0){

348 
	`bridge__backoff_°ï
(
c⁄ãxt
);

350 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s
){

351 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
){

352 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

353 
nŸifiˇti⁄_∑ylﬂd
 = '0';

354 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

355 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

358 i‡(!
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
) {

359 
nŸifiˇti⁄_∑ylﬂd
 = '0';

360 
rc
 = 
	`wûl__£t
(
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 
NULL
);

361 if(
rc
 !
MOSQ_ERR_SUCCESS
){

362  
rc
;

366 
nŸifiˇti⁄_t›ic_Àn
 = 
	`°æí
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
)+strlen("$SYS/broker/connection//state");

367 
nŸifiˇti⁄_t›ic
 = 
	`mosquôto__mÆloc
(()*(
nŸifiˇti⁄_t›ic_Àn
+1));

368 if(!
nŸifiˇti⁄_t›ic
Ë 
MOSQ_ERR_NOMEM
;

370 
	`¢¥ötf
(
nŸifiˇti⁄_t›ic
, 
nŸifiˇti⁄_t›ic_Àn
+1, "$SYS/brokî/c⁄√˘i⁄/%s/°©e", 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

372 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

373 
nŸifiˇti⁄_∑ylﬂd
 = '0';

374 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

375 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

378 i‡(!
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
) {

379 
nŸifiˇti⁄_∑ylﬂd
 = '0';

380 
rc
 = 
	`wûl__£t
(
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 
NULL
);

381 
	`mosquôto__‰ì
(
nŸifiˇti⁄_t›ic
);

382 if(
rc
 !
MOSQ_ERR_SUCCESS
){

383  
rc
;

389 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "C⁄√˘ög bridgê%†(%s:%d)", 
c⁄ãxt
->
bridge
->
«me
, c⁄ãxt->bridge->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
);

390 
rc
 = 
	`√t__sockë_c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
, 
NULL
, 
Ál£
);

391 if(
rc
 > 0){

392 if(
rc
 =
MOSQ_ERR_TLS
){

393 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

394  
rc
;

395 }if(
rc
 =
MOSQ_ERR_ERRNO
){

396 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

397 }if(
rc
 =
MOSQ_ERR_EAI
){

398 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

401  
rc
;

402 }if(
rc
 =
MOSQ_ERR_CONN_PENDING
){

403 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_c⁄√˘_≥ndög
);

406 
	`HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
c⁄ãxt
->sock), context);

408 
rc2
 = 
	`£nd__c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
kì∑live
, c⁄ãxt->
˛ón_°¨t
, 
NULL
);

409 if(
rc2
 =
MOSQ_ERR_SUCCESS
){

410 
	`bridge__backoff_ª£t
(
c⁄ãxt
);

411  
rc
;

412 }if(
rc2
 =
MOSQ_ERR_ERRNO
 && 
î∫o
 =
ENOTCONN
){

413 
	`bridge__backoff_ª£t
(
c⁄ãxt
);

414  
MOSQ_ERR_SUCCESS
;

416 if(
rc2
 =
MOSQ_ERR_TLS
){

417  
rc2
;

418 }if(
rc2
 =
MOSQ_ERR_ERRNO
){

419 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

420 }if(
rc2
 =
MOSQ_ERR_EAI
){

421 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

423 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

424  
rc2
;

426 
	}
}

430 
	$bridge__∑ckë_˛ónup
(
mosquôto
 *
c⁄ãxt
)

432 
mosquôto__∑ckë
 *
∑ckë
;

433 if(!
c⁄ãxt
) ;

435 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

436 
	`∑ckë__˛ónup
(
c⁄ãxt
->
cuºít_out_∑ckë
);

437 
	`mosquôto__‰ì
(
c⁄ãxt
->
cuºít_out_∑ckë
);

438 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

440 
c⁄ãxt
->
out_∑ckë
){

441 
	`∑ckë__˛ónup
(
c⁄ãxt
->
out_∑ckë
);

442 
∑ckë
 = 
c⁄ãxt
->
out_∑ckë
;

443 
c⁄ãxt
->
out_∑ckë
 = c⁄ãxt->out_∑ckë->
√xt
;

444 
	`mosquôto__‰ì
(
∑ckë
);

446 
c⁄ãxt
->
out_∑ckë
 = 
NULL
;

447 
c⁄ãxt
->
out_∑ckë_œ°
 = 
NULL
;

449 
	`∑ckë__˛ónup
(&(
c⁄ãxt
->
ö_∑ckë
));

450 
	}
}

452 
	$ønd_bëwìn
(
ba£
, 
ˇp
)

454 
r
;

455 
	`utû__øndom_byãs
(&
r
, ());

456  (
r
 % (
ˇp
 - 
ba£
)) + base;

457 
	}
}

459 
	$bridge__backoff_°ï
(
mosquôto
 *
c⁄ãxt
)

461 
mosquôto__bridge
 *
bridge
;

462 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
) ;

464 
bridge
 = 
c⁄ãxt
->bridge;

467 if(
bridge
->
backoff_ˇp
){

471 
bridge
->
ª°¨t_timeout
 = 
	`ønd_bëwìn
(bridge->
backoff_ba£
, bridge->restart_timeout * 3);

472 if(
bridge
->
ª°¨t_timeout
 > bridge->
backoff_ˇp
){

473 
bridge
->
ª°¨t_timeout
 = bridge->
backoff_ˇp
;

476 
	}
}

478 
	$bridge__backoff_ª£t
(
mosquôto
 *
c⁄ãxt
)

480 
mosquôto__bridge
 *
bridge
;

481 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
) ;

483 
bridge
 = 
c⁄ãxt
->bridge;

486 if(
bridge
->
backoff_ˇp
){

487 
bridge
->
ª°¨t_timeout
 = bridge->
backoff_ba£
;

489 
	}
}

	@src/conf.c

17 
	~"c⁄fig.h
"

19 
	~<limôs.h
>

20 
	~<°dio.h
>

21 
	~<°dlib.h
>

22 
	~<°rög.h
>

23 
	~<î∫o.h
>

25 #ifde‡
WIN32


27 
	~<dúít.h
>

28 
	~<°rögs.h
>

31 #i‚de‡
WIN32


32 
	~<√tdb.h
>

33 
	~<sys/sockë.h
>

35 
	~<wösock2.h
>

36 
	~<ws2t˝ù.h
>

39 #i‡!
deföed
(
WIN32
Ë&& !deföed(
__CYGWIN__
)

40 
	~<sy¶og.h
>

43 
	~"mosquôto_brokî_öã∫Æ.h
"

44 
	~"mem‹y_mosq.h
"

45 
	~"és_mosq.h
"

46 
	~"utû_mosq.h
"

47 
	~"mqâ_¥Ÿocﬁ.h
"

49 
	sc⁄fig_ªcur£
 {

50 
	mlog_de°
;

51 
	mlog_de°_£t
;

52 
	mlog_ty≥
;

53 
	mlog_ty≥_£t
;

54 
	mmax_öÊight_byãs
;

55 
	mmax_queued_byãs
;

56 
	mmax_queued_mesßges
;

59 #i‡
deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

60 
	~<wödows.h
>

61 
SERVICE_STATUS_HANDLE
 
£rvi˚_h™dÀ
;

64 
mosquôto__£curôy_›ti⁄s
 *
	gcur_£curôy_›ti⁄s
 = 
NULL
;

66 
c⁄f__∑r£_boﬁ
(**
tokí
, c⁄° *
«me
, 
boﬁ
 *
vÆue
, *
ßvïå
);

67 
c⁄f__∑r£_öt
(**
tokí
, c⁄° *
«me
, *
vÆue
, *
ßvïå
);

68 
c⁄f__∑r£_ssize_t
(**
tokí
, c⁄° *
«me
, 
ssize_t
 *
vÆue
, *
ßvïå
);

69 
c⁄f__∑r£_°rög
(**
tokí
, c⁄° *
«me
, **
vÆue
, *
ßvïå
);

70 
c⁄fig__ªad_fûe
(
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, c⁄° *
fûe
, 
c⁄fig_ªcur£
 *
c⁄fig_tmp
, 
Àvñ
, *
löío
);

71 
c⁄fig__check
(
mosquôto__c⁄fig
 *
c⁄fig
);

72 
c⁄fig__˛ónup_∂ugös
(
mosquôto__c⁄fig
 *
c⁄fig
);

74 *
	$fgës_exãndög
(**
buf
, *
buÊí
, 
FILE
 *
°ªam
)

76 *
rc
;

77 
ídch¨
;

78 
off£t
 = 0;

79 *
√wbuf
;

82 
rc
 = 
	`fgës
(&((*
buf
)[
off£t
]), *
buÊí
-off£t, 
°ªam
);

83 if(
	`„of
(
°ªam
)){

84  
rc
;

87 
ídch¨
 = (*
buf
)[
	`°æí
(*buf)-1];

88 if(
ídch¨
 == '\n'){

89  
rc
;

92 
off£t
 = *
buÊí
-1;

93 *
buÊí
 += 1000;

94 
√wbuf
 = 
	`ªÆloc
(*
buf
, *
buÊí
);

95 if(!
√wbuf
){

96  
NULL
;

98 *
buf
 = 
√wbuf
;

100 
	}
}

103 
	$c⁄f__£t_cur_£curôy_›ti⁄s
(
mosquôto__c⁄fig
 *
c⁄fig
, 
mosquôto__li°íî
 *
cur_li°íî
, 
mosquôto__£curôy_›ti⁄s
 **
£curôy_›ti⁄s
)

105 if(
c⁄fig
->
≥r_li°íî_£âögs
){

106 (*
£curôy_›ti⁄s
Ë&
cur_li°íî
->security_options;

108 (*
£curôy_›ti⁄s
Ë&
c⁄fig
->security_options;

110 
	}
}

112 
	$c⁄f__©ãm±_ªsﬁve
(c⁄° *
ho°
, c⁄° *
ãxt
, 
log
, c⁄° *
msg
)

114 
addröfo
 
gai_höts
;

115 
addröfo
 *
gai_ªs
;

116 
rc
;

118 
	`mem£t
(&
gai_höts
, 0, (
addröfo
));

119 
gai_höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

120 
gai_höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

121 
gai_ªs
 = 
NULL
;

122 
rc
 = 
	`gëaddröfo
(
ho°
, 
NULL
, &
gai_höts
, &
gai_ªs
);

123 if(
gai_ªs
){

124 
	`‰ìaddröfo
(
gai_ªs
);

126 if(
rc
 != 0){

127 #i‚de‡
WIN32


128 if(
rc
 =
EAI_SYSTEM
){

129 if(
î∫o
 =
ENOENT
){

130 
	`log__¥ötf
(
NULL
, 
log
, "%s: U«bÀÅÿªsﬁvê%†%s.", 
msg
, 
ãxt
, 
ho°
);

132 
	`log__¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s: %s.", 
msg
, 
ãxt
, 
	`°ªº‹
(
î∫o
));

135 
	`log__¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s: %s.", 
msg
, 
ãxt
, 
	`gai_°ªº‹
(
rc
));

138 if(
rc
 =
WSAHOST_NOT_FOUND
){

139 
	`log__¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s.", 
msg
, 
ãxt
);

142  
MOSQ_ERR_INVAL
;

144  
MOSQ_ERR_SUCCESS
;

145 
	}
}

148 
	$c⁄fig__öô_ªlﬂd
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
)

150 
i
;

152 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

153 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
a˛_fûe
);

154 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
a˛_fûe
 = 
NULL
;

156 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
∑ssw‹d_fûe
);

157 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
∑ssw‹d_fûe
 = 
NULL
;

159 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
psk_fûe
);

160 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
psk_fûe
 = 
NULL
;

162 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = -1;

163 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_zîo_Àngth_˛õ¡id
 = 
åue
;

164 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix
 = 
NULL
;

165 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix_Àn
 = 0;

168 
c⁄fig
->
Ælow_du∂iˇã_mesßges
 = 
Ál£
;

170 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
a˛_fûe
);

171 
c⁄fig
->
£curôy_›ti⁄s
.
a˛_fûe
 = 
NULL
;

173 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = -1;

174 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_zîo_Àngth_˛õ¡id
 = 
åue
;

175 
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
 = 
NULL
;

176 
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix_Àn
 = 0;

178 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
);

179 
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
 = 
NULL
;

181 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
psk_fûe
);

182 
c⁄fig
->
£curôy_›ti⁄s
.
psk_fûe
 = 
NULL
;

184 
c⁄fig
->
autoßve_öãrvÆ
 = 1800;

185 
c⁄fig
->
autoßve_⁄_ch™ges
 = 
Ál£
;

186 
	`mosquôto__‰ì
(
c⁄fig
->
˛õ¡id_¥efixes
);

187 
c⁄fig
->
c⁄√˘i⁄_mesßges
 = 
åue
;

188 
c⁄fig
->
˛õ¡id_¥efixes
 = 
NULL
;

189 
c⁄fig
->
≥r_li°íî_£âögs
 = 
Ál£
;

190 if(
c⁄fig
->
log_Âå
){

191 
	`f˛o£
(
c⁄fig
->
log_Âå
);

192 
c⁄fig
->
log_Âå
 = 
NULL
;

194 
	`mosquôto__‰ì
(
c⁄fig
->
log_fûe
);

195 
c⁄fig
->
log_fûe
 = 
NULL
;

197 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

198 if(
£rvi˚_h™dÀ
){

202 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_NONE
;

204 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_STDERR
;

207 
c⁄fig
->
log_Ácûôy
 = 
LOG_DAEMON
;

208 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_STDERR
;

209 if(
db
->
vîbo£
){

210 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

212 
c⁄fig
->
log_ty≥
 = 
MOSQ_LOG_ERR
 | 
MOSQ_LOG_WARNING
 | 
MOSQ_LOG_NOTICE
 | 
MOSQ_LOG_INFO
;

215 
c⁄fig
->
log_time°amp
 = 
åue
;

216 
	`mosquôto__‰ì
(
c⁄fig
->
log_time°amp_f‹m©
);

217 
c⁄fig
->
log_time°amp_f‹m©
 = 
NULL
;

218 
c⁄fig
->
max_kì∑live
 = 65535;

219 
c⁄fig
->
max_∑ckë_size
 = 0;

220 
c⁄fig
->
max_öÊight_mesßges
 = 20;

221 
c⁄fig
->
≥rsi°í˚
 = 
Ál£
;

222 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_loˇti⁄
);

223 
c⁄fig
->
≥rsi°í˚_loˇti⁄
 = 
NULL
;

224 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_fûe
);

225 
c⁄fig
->
≥rsi°í˚_fûe
 = 
NULL
;

226 
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 = 0;

227 
c⁄fig
->
queue_qos0_mesßges
 = 
Ál£
;

228 
c⁄fig
->
ªèö_avaûabÀ
 = 
åue
;

229 
c⁄fig
->
£t_t˝_nodñay
 = 
Ál£
;

230 
c⁄fig
->
sys_öãrvÆ
 = 10;

231 
c⁄fig
->
upgøde_outgoög_qos
 = 
Ál£
;

233 
	`c⁄fig__˛ónup_∂ugös
(
c⁄fig
);

234 
	}
}

237 
	$c⁄fig__˛ónup_∂ugös
(
mosquôto__c⁄fig
 *
c⁄fig
)

239 
i
, 
j
;

240 
mosquôto__auth_∂ugö_c⁄fig
 *
∂ug
;

242 if(
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
){

243 
i
=0; i<
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄fig_cou¡
; i++){

244 
∂ug
 = &
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
[
i
];

245 
	`mosquôto__‰ì
(
∂ug
->
∑th
);

246 
∂ug
->
∑th
 = 
NULL
;

248 if(
∂ug
->
›ti⁄s
){

249 
j
=0; j<
∂ug
->
›ti⁄_cou¡
; j++){

250 
	`mosquôto__‰ì
(
∂ug
->
›ti⁄s
[
j
].
key
);

251 
	`mosquôto__‰ì
(
∂ug
->
›ti⁄s
[
j
].
vÆue
);

253 
	`mosquôto__‰ì
(
∂ug
->
›ti⁄s
);

254 
∂ug
->
›ti⁄s
 = 
NULL
;

255 
∂ug
->
›ti⁄_cou¡
 = 0;

258 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
);

259 
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
 = 
NULL
;

261 
	}
}

264 
	$c⁄fig__öô
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
)

266 
	`mem£t
(
c⁄fig
, 0, (
mosquôto__c⁄fig
));

267 
	`c⁄fig__öô_ªlﬂd
(
db
, 
c⁄fig
);

269 
c⁄fig
->
d´m⁄
 = 
Ál£
;

270 
	`mem£t
(&
c⁄fig
->
deÁu…_li°íî
, 0, (
mosquôto__li°íî
));

271 
c⁄fig
->
deÁu…_li°íî
.
max_c⁄√˘i⁄s
 = -1;

272 
c⁄fig
->
deÁu…_li°íî
.
¥Ÿocﬁ
 = 
mp_mqâ
;

273 
c⁄fig
->
deÁu…_li°íî
.
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = -1;

274 
c⁄fig
->
deÁu…_li°íî
.
maximum_qos
 = 2;

275 
c⁄fig
->
deÁu…_li°íî
.
max_t›ic_Æüs
 = 10;

276 
	}
}

278 
	$c⁄fig__˛ónup
(
mosquôto__c⁄fig
 *
c⁄fig
)

280 
i
;

281 #ifde‡
WITH_BRIDGE


282 
j
;

285 
	`mosquôto__‰ì
(
c⁄fig
->
˛õ¡id_¥efixes
);

286 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_loˇti⁄
);

287 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_fûe
);

288 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_fûï©h
);

289 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
);

290 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
a˛_fûe
);

291 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
);

292 
	`mosquôto__‰ì
(
c⁄fig
->
£curôy_›ti⁄s
.
psk_fûe
);

293 
	`mosquôto__‰ì
(
c⁄fig
->
pid_fûe
);

294 if(
c⁄fig
->
li°íîs
){

295 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

296 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
ho°
);

297 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
böd_öãrÁ˚
);

298 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
mou¡_poöt
);

299 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
socks
);

300 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix
);

301 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
a˛_fûe
);

302 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
∑ssw‹d_fûe
);

303 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
psk_fûe
);

304 #ifde‡
WITH_TLS


305 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
ˇfûe
);

306 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
ˇ∑th
);

307 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
˚πfûe
);

308 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
keyfûe
);

309 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
cùhîs
);

310 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
psk_höt
);

311 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
¸lfûe
);

312 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
dh∑ømfûe
);

313 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
és_vîsi⁄
);

314 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
és_ígöe
);

315 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
és_ígöe_k∑ss_sha1
);

316 #ifde‡
WITH_WEBSOCKETS


317 if(!
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
)

320 
	`SSL_CTX_‰ì
(
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
);

323 #ifde‡
WITH_WEBSOCKETS


324 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
[
i
].
hâp_dú
);

327 
	`mosquôto__‰ì
(
c⁄fig
->
li°íîs
);

329 #ifde‡
WITH_BRIDGE


330 if(
c⁄fig
->
bridges
){

331 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

332 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
«me
);

333 if(
c⁄fig
->
bridges
[
i
].
addªs£s
){

334 
j
=0; j<
c⁄fig
->
bridges
[
i
].
addªss_cou¡
; j++){

335 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
addªs£s
[
j
].
addªss
);

337 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
addªs£s
);

339 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
ªmŸe_˛õ¡id
);

340 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
ªmŸe_u£∫ame
);

341 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
ªmŸe_∑ssw‹d
);

342 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
loˇl_˛õ¡id
);

343 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
loˇl_u£∫ame
);

344 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
loˇl_∑ssw‹d
);

345 if(
c⁄fig
->
bridges
[
i
].
t›ics
){

346 
j
=0; j<
c⁄fig
->
bridges
[
i
].
t›ic_cou¡
; j++){

347 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
t›ic
);

348 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
loˇl_¥efix
);

349 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
ªmŸe_¥efix
);

350 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
loˇl_t›ic
);

351 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
ªmŸe_t›ic
);

353 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
);

355 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
nŸifiˇti⁄_t›ic
);

356 #ifde‡
WITH_TLS


357 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
és_vîsi⁄
);

358 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
és_ˇfûe
);

359 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
és_Æ≤
);

360 #ifde‡
FINAL_WITH_TLS_PSK


361 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
és_psk_idítôy
);

362 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
[
i
].
és_psk
);

366 
	`mosquôto__‰ì
(
c⁄fig
->
bridges
);

369 
	`c⁄fig__˛ónup_∂ugös
(
c⁄fig
);

371 if(
c⁄fig
->
log_Âå
){

372 
	`f˛o£
(
c⁄fig
->
log_Âå
);

373 
c⁄fig
->
log_Âå
 = 
NULL
;

375 if(
c⁄fig
->
log_fûe
){

376 
	`mosquôto__‰ì
(
c⁄fig
->
log_fûe
);

377 
c⁄fig
->
log_fûe
 = 
NULL
;

379 
	}
}

381 
	$¥öt_ußge
()

383 
	`¥ötf
("mosquôtÿvîsi⁄ %s\n\n", 
VERSION
);

384 
	`¥ötf
("mosquitto isán MQTT v3.1.1 broker.\n\n");

385 
	`¥ötf
("Usage: mosquitto [-c config_file] [-d] [-h] [-pÖort]\n\n");

386 
	`¥ötf
(" -c : specifyÅhe broker config file.\n");

387 
	`¥ötf
(" -d :ÖutÅhe broker intoÅhe backgroundáfter starting.\n");

388 
	`¥ötf
(" -h : displayÅhis help.\n");

389 
	`¥ötf
(" -p : startÅhe brokerÜistening onÅhe specifiedÖort.\n");

390 
	`¥ötf
(" NotÑecommended in conjunction withÅhe -c option.\n");

391 
	`¥ötf
(" -v : verbose mode -ÉnableállÜoggingÅypes. This overrides\n");

392 
	`¥ötf
("ányÜogging options given inÅhe config file.\n");

393 
	`¥ötf
("\nSee http://mosquitto.org/ for more information.\n\n");

394 
	}
}

396 
	$c⁄fig__∑r£_¨gs
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
, 
¨gc
, *
¨gv
[])

398 
i
;

399 
p‹t_tmp
;

401 
i
=1; i<
¨gc
; i++){

402 if(!
	`°rcmp
(
¨gv
[
i
], "-c") || !strcmp(argv[i], "--config-file")){

403 if(
i
<
¨gc
-1){

404 
db
->
c⁄fig_fûe
 = 
¨gv
[
i
+1];

406 if(
	`c⁄fig__ªad
(
db
, 
c⁄fig
, 
Ál£
)){

407  
MOSQ_ERR_INVAL
;

410 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: -cárgument given, butÇo config file specified.");

411  
MOSQ_ERR_INVAL
;

413 
i
++;

414 }if(!
	`°rcmp
(
¨gv
[
i
], "-d") || !strcmp(argv[i], "--daemon")){

415 
c⁄fig
->
d´m⁄
 = 
åue
;

416 }if(!
	`°rcmp
(
¨gv
[
i
], "-h") || !strcmp(argv[i], "--help")){

417 
	`¥öt_ußge
();

418  
MOSQ_ERR_INVAL
;

419 }if(!
	`°rcmp
(
¨gv
[
i
], "-p") || !strcmp(argv[i], "--port")){

420 if(
i
<
¨gc
-1){

421 
p‹t_tmp
 = 
	`©oi
(
¨gv
[
i
+1]);

422 if(
p‹t_tmp
<1 ||Öort_tmp>65535){

423 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹à•ecifõd (%d).", 
p‹t_tmp
);

424  
MOSQ_ERR_INVAL
;

426 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

427 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: DefaultÜistenerÖort specified multipleÅimes. OnlyÅheÜatest will be used.");

429 
c⁄fig
->
deÁu…_li°íî
.
p‹t
 = 
p‹t_tmp
;

432 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: -párgument given, butÇoÖort specified.");

433  
MOSQ_ERR_INVAL
;

435 
i
++;

436 }if(!
	`°rcmp
(
¨gv
[
i
], "-v") || !strcmp(argv[i], "--verbose")){

437 
db
->
vîbo£
 = 
åue
;

439 
	`Ârötf
(
°dîr
, "Eº‹: Unknow¿›ti⁄ '%s'.\n",
¨gv
[
i
]);

440 
	`¥öt_ußge
();

441  
MOSQ_ERR_INVAL
;

445 if(
c⁄fig
->
li°íî_cou¡
 == 0

446 #ifde‡
WITH_TLS


447 || 
c⁄fig
->
deÁu…_li°íî
.
ˇfûe


448 || 
c⁄fig
->
deÁu…_li°íî
.
ˇ∑th


449 || 
c⁄fig
->
deÁu…_li°íî
.
˚πfûe


450 || 
c⁄fig
->
deÁu…_li°íî
.
keyfûe


451 || 
c⁄fig
->
deÁu…_li°íî
.
és_ígöe


452 || 
c⁄fig
->
deÁu…_li°íî
.
és_keyf‹m
 !
mosq_k_≥m


453 || 
c⁄fig
->
deÁu…_li°íî
.
és_ígöe_k∑ss_sha1


454 || 
c⁄fig
->
deÁu…_li°íî
.
cùhîs


455 || 
c⁄fig
->
deÁu…_li°íî
.
dh∑ømfûe


456 || 
c⁄fig
->
deÁu…_li°íî
.
psk_höt


457 || 
c⁄fig
->
deÁu…_li°íî
.
ªquúe_˚πifiˇã


458 || 
c⁄fig
->
deÁu…_li°íî
.
¸lfûe


459 || 
c⁄fig
->
deÁu…_li°íî
.
u£_idítôy_as_u£∫ame


460 || 
c⁄fig
->
deÁu…_li°íî
.
u£_subje˘_as_u£∫ame


462 || 
c⁄fig
->
deÁu…_li°íî
.
u£_u£∫ame_as_˛õ¡id


463 || 
c⁄fig
->
deÁu…_li°íî
.
ho°


464 || 
c⁄fig
->
deÁu…_li°íî
.
p‹t


465 || 
c⁄fig
->
deÁu…_li°íî
.
max_c⁄√˘i⁄s
 != -1

466 || 
c⁄fig
->
deÁu…_li°íî
.
maximum_qos
 != 2

467 || 
c⁄fig
->
deÁu…_li°íî
.
mou¡_poöt


468 || 
c⁄fig
->
deÁu…_li°íî
.
¥Ÿocﬁ
 !
mp_mqâ


469 || 
c⁄fig
->
deÁu…_li°íî
.
sockë_domaö


470 || 
c⁄fig
->
deÁu…_li°íî
.
£curôy_›ti⁄s
.
∑ssw‹d_fûe


471 || 
c⁄fig
->
deÁu…_li°íî
.
£curôy_›ti⁄s
.
psk_fûe


472 || 
c⁄fig
->
deÁu…_li°íî
.
£curôy_›ti⁄s
.
auth_∂ugö_c⁄fig_cou¡


473 || 
c⁄fig
->
deÁu…_li°íî
.
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 != -1

476 
c⁄fig
->
li°íî_cou¡
++;

477 
c⁄fig
->
li°íîs
 = 
	`mosquôto__ªÆloc
(c⁄fig->li°íîs, (
mosquôto__li°íî
)*c⁄fig->
li°íî_cou¡
);

478 if(!
c⁄fig
->
li°íîs
){

479 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

480  
MOSQ_ERR_NOMEM
;

482 
	`mem£t
(&
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1], 0, (
mosquôto__li°íî
));

483 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

484 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
p‹t
 = c⁄fig->
deÁu…_li°íî
.port;

486 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
p‹t
 = 1883;

488 if(
c⁄fig
->
deÁu…_li°íî
.
ho°
){

489 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ho°
 = c⁄fig->
deÁu…_li°íî
.host;

491 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ho°
 = 
NULL
;

493 if(
c⁄fig
->
deÁu…_li°íî
.
mou¡_poöt
){

494 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
mou¡_poöt
 = c⁄fig->
deÁu…_li°íî
.mount_point;

496 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
mou¡_poöt
 = 
NULL
;

498 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
max_c⁄√˘i⁄s
 = c⁄fig->
deÁu…_li°íî
.max_connections;

499 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
¥Ÿocﬁ
 = c⁄fig->
deÁu…_li°íî
.protocol;

500 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
sockë_domaö
 = c⁄fig->
deÁu…_li°íî
.socket_domain;

501 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˛õ¡_cou¡
 = 0;

502 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
socks
 = 
NULL
;

503 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
sock_cou¡
 = 0;

504 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˛õ¡_cou¡
 = 0;

505 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
u£_u£∫ame_as_˛õ¡id
 = c⁄fig->
deÁu…_li°íî
.use_username_as_clientid;

506 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
maximum_qos
 = c⁄fig->
deÁu…_li°íî
.maximum_qos;

507 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
max_t›ic_Æüs
 = c⁄fig->
deÁu…_li°íî
.max_topic_alias;

508 #ifde‡
WITH_TLS


509 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
és_vîsi⁄
 = c⁄fig->
deÁu…_li°íî
.tls_version;

510 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
és_ígöe
 = c⁄fig->
deÁu…_li°íî
.tls_engine;

511 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
és_keyf‹m
 = c⁄fig->
deÁu…_li°íî
.tls_keyform;

512 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
és_ígöe_k∑ss_sha1
 = c⁄fig->
deÁu…_li°íî
.tls_engine_kpass_sha1;

513 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ˇfûe
 = c⁄fig->
deÁu…_li°íî
.cafile;

514 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ˇ∑th
 = c⁄fig->
deÁu…_li°íî
.capath;

515 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˚πfûe
 = c⁄fig->
deÁu…_li°íî
.certfile;

516 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
keyfûe
 = c⁄fig->
deÁu…_li°íî
.keyfile;

517 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
cùhîs
 = c⁄fig->
deÁu…_li°íî
.ciphers;

518 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
dh∑ømfûe
 = c⁄fig->
deÁu…_li°íî
.dhparamfile;

519 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
psk_höt
 = c⁄fig->
deÁu…_li°íî
.psk_hint;

520 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ªquúe_˚πifiˇã
 = c⁄fig->
deÁu…_li°íî
.require_certificate;

521 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
s¶_˘x
 = 
NULL
;

522 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
¸lfûe
 = c⁄fig->
deÁu…_li°íî
.crlfile;

523 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
u£_idítôy_as_u£∫ame
 = c⁄fig->
deÁu…_li°íî
.use_identity_as_username;

524 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
u£_subje˘_as_u£∫ame
 = c⁄fig->
deÁu…_li°íî
.use_subject_as_username;

526 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
a˛_fûe
 = c⁄fig->
deÁu…_li°íî
.security_options.acl_file;

527 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
∑ssw‹d_fûe
 = c⁄fig->
deÁu…_li°íî
.security_options.password_file;

528 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
psk_fûe
 = c⁄fig->
deÁu…_li°íî
.security_options.psk_file;

529 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
 = c⁄fig->
deÁu…_li°íî
.security_options.auth_plugin_configs;

530 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
auth_∂ugö_c⁄fig_cou¡
 = c⁄fig->
deÁu…_li°íî
.security_options.auth_plugin_config_count;

531 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = c⁄fig->
deÁu…_li°íî
.security_options.allow_anonymous;

535 if(!
c⁄fig
->
u£r
){

536 
c⁄fig
->
u£r
 = "mosquitto";

538 if(
db
->
vîbo£
){

539 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

541  
	`c⁄fig__check
(
c⁄fig
);

542 
	}
}

544 
	$c⁄fig__c›y
(
mosquôto__c⁄fig
 *
§c
, mosquôto__c⁄fig *
de°
)

546 
	`mosquôto__‰ì
(
de°
->
£curôy_›ti⁄s
.
a˛_fûe
);

547 
de°
->
£curôy_›ti⁄s
.
a˛_fûe
 = 
§c
->security_options.acl_file;

549 
de°
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
§c
->security_options.allow_anonymous;

550 
de°
->
£curôy_›ti⁄s
.
Ælow_zîo_Àngth_˛õ¡id
 = 
§c
->security_options.allow_zero_length_clientid;

552 
	`mosquôto__‰ì
(
de°
->
£curôy_›ti⁄s
.
auto_id_¥efix
);

553 
de°
->
£curôy_›ti⁄s
.
auto_id_¥efix
 = 
§c
->security_options.auto_id_prefix;

554 
de°
->
£curôy_›ti⁄s
.
auto_id_¥efix_Àn
 = 
§c
->security_options.auto_id_prefix_len;

556 
	`mosquôto__‰ì
(
de°
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
);

557 
de°
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
 = 
§c
->security_options.password_file;

559 
	`mosquôto__‰ì
(
de°
->
£curôy_›ti⁄s
.
psk_fûe
);

560 
de°
->
£curôy_›ti⁄s
.
psk_fûe
 = 
§c
->security_options.psk_file;

563 
de°
->
Ælow_du∂iˇã_mesßges
 = 
§c
->allow_duplicate_messages;

566 
de°
->
autoßve_öãrvÆ
 = 
§c
->autosave_interval;

567 
de°
->
autoßve_⁄_ch™ges
 = 
§c
->autosave_on_changes;

569 
	`mosquôto__‰ì
(
de°
->
˛õ¡id_¥efixes
);

570 
de°
->
˛õ¡id_¥efixes
 = 
§c
->clientid_prefixes;

572 
de°
->
c⁄√˘i⁄_mesßges
 = 
§c
->connection_messages;

573 
de°
->
log_de°
 = 
§c
->log_dest;

574 
de°
->
log_Ácûôy
 = 
§c
->log_facility;

575 
de°
->
log_ty≥
 = 
§c
->log_type;

576 
de°
->
log_time°amp
 = 
§c
->log_timestamp;

578 
	`mosquôto__‰ì
(
de°
->
log_time°amp_f‹m©
);

579 
de°
->
log_time°amp_f‹m©
 = 
§c
->log_timestamp_format;

581 
	`mosquôto__‰ì
(
de°
->
log_fûe
);

582 
de°
->
log_fûe
 = 
§c
->log_file;

584 
de°
->
mesßge_size_limô
 = 
§c
->message_size_limit;

586 
de°
->
≥rsi°í˚
 = 
§c
->persistence;

588 
	`mosquôto__‰ì
(
de°
->
≥rsi°í˚_loˇti⁄
);

589 
de°
->
≥rsi°í˚_loˇti⁄
 = 
§c
->persistence_location;

591 
	`mosquôto__‰ì
(
de°
->
≥rsi°í˚_fûe
);

592 
de°
->
≥rsi°í˚_fûe
 = 
§c
->persistence_file;

594 
	`mosquôto__‰ì
(
de°
->
≥rsi°í˚_fûï©h
);

595 
de°
->
≥rsi°í˚_fûï©h
 = 
§c
->persistence_filepath;

597 
de°
->
≥rsi°ít_˛õ¡_expú©i⁄
 = 
§c
->persistent_client_expiration;

600 
de°
->
queue_qos0_mesßges
 = 
§c
->queue_qos0_messages;

601 
de°
->
sys_öãrvÆ
 = 
§c
->sys_interval;

602 
de°
->
upgøde_outgoög_qos
 = 
§c
->upgrade_outgoing_qos;

604 #ifde‡
WITH_WEBSOCKETS


605 
de°
->
websockës_log_Àvñ
 = 
§c
->websockets_log_level;

607 
	}
}

610 
	$c⁄fig__ªad
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
)

612 
rc
 = 
MOSQ_ERR_SUCCESS
;

613 
c⁄fig_ªcur£
 
¸
;

614 
löío
 = 0;

615 #ifde‡
WITH_PERSISTENCE


616 
Àn
;

618 
mosquôto__c⁄fig
 
c⁄fig_ªlﬂd
;

619 
mosquôto__auth_∂ugö
 *
∂ugö
;

620 
i
, 
j
;

622 if(
ªlﬂd
){

623 
	`mem£t
(&
c⁄fig_ªlﬂd
, 0, (
mosquôto__c⁄fig
));

626 
¸
.
log_de°
 = 
MQTT3_LOG_NONE
;

627 
¸
.
log_de°_£t
 = 0;

628 
¸
.
log_ty≥
 = 
MOSQ_LOG_NONE
;

629 
¸
.
log_ty≥_£t
 = 0;

630 
¸
.
max_öÊight_byãs
 = 0;

631 
¸
.
max_queued_byãs
 = 0;

632 
¸
.
max_queued_mesßges
 = 100;

634 if(!
db
->
c⁄fig_fûe
)  0;

636 if(
ªlﬂd
){

638 
	`c⁄fig__öô_ªlﬂd
(
db
, &
c⁄fig_ªlﬂd
);

639 
c⁄fig_ªlﬂd
.
li°íîs
 = 
c⁄fig
->listeners;

640 
c⁄fig_ªlﬂd
.
li°íî_cou¡
 = 
c⁄fig
->listener_count;

641 
rc
 = 
	`c⁄fig__ªad_fûe
(&
c⁄fig_ªlﬂd
, 
ªlﬂd
, 
db
->
c⁄fig_fûe
, &
¸
, 0, &
löío
);

643 
rc
 = 
	`c⁄fig__ªad_fûe
(
c⁄fig
, 
ªlﬂd
, 
db
->
c⁄fig_fûe
, &
¸
, 0, &
löío
);

645 if(
rc
){

646 if(
löío
 > 0){

647 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ foundáà%s:%d.", 
db
->
c⁄fig_fûe
, 
löío
);

649  
rc
;

652 if(
ªlﬂd
){

653 
	`c⁄fig__c›y
(&
c⁄fig_ªlﬂd
, 
c⁄fig
);

657 if(
c⁄fig
->
≥r_li°íî_£âögs
){

658 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

659 if(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 == -1){

661 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
åue
;

663 if(
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
∑ssw‹d_fûe


664 || 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
psk_fûe
){

669 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

673 
j
=0; j<
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auth_∂ugö_c⁄fig_cou¡
; j++){

674 
∂ugö
 = &
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
[
j
].plugin;

676 if(
∂ugö
->
vîsi⁄
 == 3 ||Ölugin->version == 2){

678 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

682 if(
∂ugö
->
u≈wd_check_v4
 !
NULL
){

683 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

691 if(
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 == -1){

693 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
åue
;

695 if(
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe


696 || 
c⁄fig
->
£curôy_›ti⁄s
.
psk_fûe
){

701 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

705 
j
=0; j<
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄fig_cou¡
; j++){

706 
∂ugö
 = &
c⁄fig
->
£curôy_›ti⁄s
.
auth_∂ugö_c⁄figs
[
j
].plugin;

708 if(
∂ugö
->
vîsi⁄
 == 3 ||Ölugin->version == 2){

710 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

714 if(
∂ugö
->
u≈wd_check_v4
 !
NULL
){

715 
c⁄fig
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = 
Ál£
;

722 #ifde‡
WITH_PERSISTENCE


723 if(
c⁄fig
->
≥rsi°í˚
){

724 if(!
c⁄fig
->
≥rsi°í˚_fûe
){

725 
c⁄fig
->
≥rsi°í˚_fûe
 = 
	`mosquôto__°rdup
("mosquitto.db");

726 if(!
c⁄fig
->
≥rsi°í˚_fûe
Ë 
MOSQ_ERR_NOMEM
;

728 
	`mosquôto__‰ì
(
c⁄fig
->
≥rsi°í˚_fûï©h
);

729 if(
c⁄fig
->
≥rsi°í˚_loˇti⁄
 && 
	`°æí
(config->persistence_location)){

730 
Àn
 = 
	`°æí
(
c⁄fig
->
≥rsi°í˚_loˇti⁄
Ë+ såÀn(c⁄fig->
≥rsi°í˚_fûe
) + 1;

731 
c⁄fig
->
≥rsi°í˚_fûï©h
 = 
	`mosquôto__mÆloc
(
Àn
);

732 if(!
c⁄fig
->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_NOMEM
;

733 
	`¢¥ötf
(
c⁄fig
->
≥rsi°í˚_fûï©h
, 
Àn
, "%s%s", c⁄fig->
≥rsi°í˚_loˇti⁄
, c⁄fig->
≥rsi°í˚_fûe
);

735 
c⁄fig
->
≥rsi°í˚_fûï©h
 = 
	`mosquôto__°rdup
(c⁄fig->
≥rsi°í˚_fûe
);

736 if(!
c⁄fig
->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_NOMEM
;

743 if(!
c⁄fig
->
u£r
){

744 
c⁄fig
->
u£r
 = "mosquitto";

747 
	`db__limôs_£t
(
¸
.
max_öÊight_byãs
, cr.
max_queued_mesßges
, cr.
max_queued_byãs
);

749 #ifde‡
WITH_BRIDGE


750 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

751 if(!
c⁄fig
->
bridges
[
i
].
«me
 || !c⁄fig->bridges[i].
addªs£s
 || !c⁄fig->bridges[i].
t›ic_cou¡
){

752 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

753  
MOSQ_ERR_INVAL
;

755 #ifde‡
FINAL_WITH_TLS_PSK


756 if(
c⁄fig
->
bridges
[
i
].
és_psk
 && !c⁄fig->bridges[i].
és_psk_idítôy
){

757 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration: missing bridge_identity.");

758  
MOSQ_ERR_INVAL
;

760 if(
c⁄fig
->
bridges
[
i
].
és_psk_idítôy
 && !c⁄fig->bridges[i].
és_psk
){

761 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration: missing bridge_psk.");

762  
MOSQ_ERR_INVAL
;

768 if(
¸
.
log_de°_£t
){

769 
c⁄fig
->
log_de°
 = 
¸
.log_dest;

771 if(
db
->
vîbo£
){

772 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

773 }if(
¸
.
log_ty≥_£t
){

774 
c⁄fig
->
log_ty≥
 = 
¸
.log_type;

776  
MOSQ_ERR_SUCCESS
;

777 
	}
}

779 
	$c⁄fig__ªad_fûe_c‹e
(
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, 
c⁄fig_ªcur£
 *
¸
, 
Àvñ
, *
löío
, 
FILE
 *
Âå
, **
buf
, *
buÊí
)

781 
rc
;

782 *
tokí
;

783 
tmp_öt
;

784 *
ßvïå
 = 
NULL
;

785 #ifde‡
WITH_BRIDGE


786 *
tmp_ch¨
;

787 
mosquôto__bridge
 *
cur_bridge
 = 
NULL
;

788 
mosquôto__bridge_t›ic
 *
cur_t›ic
;

789 
Àn
;

791 
mosquôto__auth_∂ugö_c⁄fig
 *
cur_auth_∂ugö_c⁄fig
 = 
NULL
;

793 
time_t
 
expú©i⁄_mu…
;

794 *
key
;

795 
mosquôto__li°íî
 *
cur_li°íî
 = &
c⁄fig
->
deÁu…_li°íî
;

796 
i
;

797 
löío_ext
 = 0;

799 *
löío
 = 0;

801 
	`fgës_exãndög
(
buf
, 
buÊí
, 
Âå
)){

802 (*
löío
)++;

803 if((*
buf
)[0] != '#' && (*buf)[0] != 10 && (*buf)[0] != 13){

804 (*
buf
)[
	`°æí
((*buf))-1] == 10 || (*buf)[strlen((*buf))-1] == 13){

805 (*
buf
)[
	`°æí
((*buf))-1] = 0;

807 
tokí
 = 
	`°πok_r
((*
buf
), " ", &
ßvïå
);

808 if(
tokí
){

809 if(!
	`°rcmp
(
tokí
, "acl_file")){

810 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

811 if(
ªlﬂd
){

812 
	`mosquôto__‰ì
(
cur_£curôy_›ti⁄s
->
a˛_fûe
);

813 
cur_£curôy_›ti⁄s
->
a˛_fûe
 = 
NULL
;

815 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "a˛_fûe", &
cur_£curôy_›ti⁄s
->
a˛_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

816 }if(!
	`°rcmp
(
tokí
, "address") || !strcmp(token, "addresses")){

817 #ifde‡
WITH_BRIDGE


818 if(
ªlﬂd
) ;

819 if(!
cur_bridge
 || cur_bridge->
addªs£s
){

820 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

821  
MOSQ_ERR_INVAL
;

823 (
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
))){

824 i‡(
tokí
[0] == '#'){

827 
cur_bridge
->
addªss_cou¡
++;

828 
cur_bridge
->
addªs£s
 = 
	`mosquôto__ªÆloc
(cur_bridge->addªs£s, (
bridge_addªss
)*cur_bridge->
addªss_cou¡
);

829 if(!
cur_bridge
->
addªs£s
){

830 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

831  
MOSQ_ERR_NOMEM
;

833 
cur_bridge
->
addªs£s
[cur_bridge->
addªss_cou¡
-1].
addªss
 = 
tokí
;

835 
i
=0; i<
cur_bridge
->
addªss_cou¡
; i++){

840 
tmp_ch¨
 = 
	`°ºchr
(
cur_bridge
->
addªs£s
[
i
].
addªss
, ':');

841 if(
tmp_ch¨
){

844 
tmp_ch¨
[0] = '\0';

847 
tmp_öt
 = 
	`©oi
(&
tmp_ch¨
[1]);

848 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

849 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

850  
MOSQ_ERR_INVAL
;

852 
cur_bridge
->
addªs£s
[
i
].
p‹t
 = 
tmp_öt
;

854 
cur_bridge
->
addªs£s
[
i
].
p‹t
 = 1883;

861 
cur_bridge
->
addªs£s
[
i
].
addªss
 = 
	`mosquôto__°rdup
(cur_bridge->addresses[i].address);

862 
	`c⁄f__©ãm±_ªsﬁve
(
cur_bridge
->
addªs£s
[
i
].
addªss
, "bridgêaddªss", 
MOSQ_LOG_WARNING
, "Warning");

864 if(
cur_bridge
->
addªss_cou¡
 == 0){

865 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Emptyáddress value in configuration.");

866  
MOSQ_ERR_INVAL
;

869 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

871 }if(!
	`°rcmp
(
tokí
, "allow_anonymous")){

872 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

873 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "Ælow_™⁄ymous", (
boﬁ
 *)&
cur_£curôy_›ti⁄s
->
Ælow_™⁄ymous
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

874 }if(!
	`°rcmp
(
tokí
, "allow_duplicate_messages")){

875 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "Ælow_du∂iˇã_mesßges", &
c⁄fig
->
Ælow_du∂iˇã_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

876 }if(!
	`°rcmp
(
tokí
, "allow_zero_length_clientid")){

877 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

878 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "Ælow_zîo_Àngth_˛õ¡id", &
cur_£curôy_›ti⁄s
->
Ælow_zîo_Àngth_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

879 }if(!
	`°∫cmp
(
tokí
, "auth_opt_", 9)){

880 if(
ªlﬂd
) ;

881 if(!
cur_auth_∂ugö_c⁄fig
){

882 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Anáuth_opt_ optionÉxists inÅhe config file withoutánáuth_plugin.");

883  
MOSQ_ERR_INVAL
;

885 if(
	`°æí
(
tokí
) < 12){

887 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalidáuth_opt_ config option.");

888  
MOSQ_ERR_INVAL
;

890 
key
 = 
	`mosquôto__°rdup
(&
tokí
[9]);

891 if(!
key
){

892 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

893  
MOSQ_ERR_NOMEM
;

894 }if(
	`STREMPTY
(
key
)){

895 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalidáuth_opt_ config option.");

896 
	`mosquôto__‰ì
(
key
);

897  
MOSQ_ERR_INVAL
;

899 
tokí
 +9+
	`°æí
(
key
)+1;

900 
tokí
[0] == ' ' ||Åoken[0] == '\t'){

901 
tokí
++;

903 if(
tokí
[0]){

904 
cur_auth_∂ugö_c⁄fig
->
›ti⁄_cou¡
++;

905 
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
 = 
	`mosquôto__ªÆloc
(cur_auth_∂ugö_c⁄fig->›ti⁄s, cur_auth_∂ugö_c⁄fig->
›ti⁄_cou¡
*(
mosquôto_auth_›t
));

906 if(!
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
){

907 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

908 
	`mosquôto__‰ì
(
key
);

909  
MOSQ_ERR_NOMEM
;

911 
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
[cur_auth_∂ugö_c⁄fig->
›ti⁄_cou¡
-1].
key
 = key;

912 
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
[cur_auth_∂ugö_c⁄fig->
›ti⁄_cou¡
-1].
vÆue
 = 
	`mosquôto__°rdup
(
tokí
);

913 if(!
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
[cur_auth_∂ugö_c⁄fig->
›ti⁄_cou¡
-1].
vÆue
){

914 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

915  
MOSQ_ERR_NOMEM
;

918 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
key
);

919 
	`mosquôto__‰ì
(
key
);

920  
MOSQ_ERR_INVAL
;

922 }if(!
	`°rcmp
(
tokí
, "auth_plugin")){

923 if(
ªlﬂd
) ;

924 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

925 
cur_£curôy_›ti⁄s
->
auth_∂ugö_c⁄figs
 = 
	`mosquôto__ªÆloc
(cur_£curôy_›ti⁄s->auth_∂ugö_c⁄figs, (cur_£curôy_›ti⁄s->
auth_∂ugö_c⁄fig_cou¡
+1)*(
mosquôto__auth_∂ugö_c⁄fig
));

926 if(!
cur_£curôy_›ti⁄s
->
auth_∂ugö_c⁄figs
){

927 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

928  
MOSQ_ERR_NOMEM
;

930 
cur_auth_∂ugö_c⁄fig
 = &
cur_£curôy_›ti⁄s
->
auth_∂ugö_c⁄figs
[cur_£curôy_›ti⁄s->
auth_∂ugö_c⁄fig_cou¡
];

931 
	`mem£t
(
cur_auth_∂ugö_c⁄fig
, 0, (
mosquôto__auth_∂ugö_c⁄fig
));

932 
cur_auth_∂ugö_c⁄fig
->
∑th
 = 
NULL
;

933 
cur_auth_∂ugö_c⁄fig
->
›ti⁄s
 = 
NULL
;

934 
cur_auth_∂ugö_c⁄fig
->
›ti⁄_cou¡
 = 0;

935 
cur_auth_∂ugö_c⁄fig
->
díy_•ecül_ch¨s
 = 
åue
;

936 
cur_£curôy_›ti⁄s
->
auth_∂ugö_c⁄fig_cou¡
++;

937 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "auth_∂ugö", &
cur_auth_∂ugö_c⁄fig
->
∑th
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

938 }if(!
	`°rcmp
(
tokí
, "auth_plugin_deny_special_chars")){

939 if(
ªlﬂd
) ;

940 if(!
cur_auth_∂ugö_c⁄fig
){

941 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Anáuth_plugin_deny_special_chars optionÉxists inÅhe config file withoutánáuth_plugin.");

942  
MOSQ_ERR_INVAL
;

944 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "auth_∂ugö_díy_•ecül_ch¨s", &
cur_auth_∂ugö_c⁄fig
->
díy_•ecül_ch¨s
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

945 }if(!
	`°rcmp
(
tokí
, "auto_id_prefix")){

946 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

947 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "auto_id_¥efix", &
cur_£curôy_›ti⁄s
->
auto_id_¥efix
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

948 if(
cur_£curôy_›ti⁄s
->
auto_id_¥efix
){

949 
cur_£curôy_›ti⁄s
->
auto_id_¥efix_Àn
 = 
	`°æí
(cur_£curôy_›ti⁄s->
auto_id_¥efix
);

951 
cur_£curôy_›ti⁄s
->
auto_id_¥efix_Àn
 = 0;

953 }if(!
	`°rcmp
(
tokí
, "autosave_interval")){

954 if(
	`c⁄f__∑r£_öt
(&
tokí
, "autoßve_öãrvÆ", &
c⁄fig
->
autoßve_öãrvÆ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

955 if(
c⁄fig
->
autoßve_öãrvÆ
 < 0) config->autosave_interval = 0;

956 }if(!
	`°rcmp
(
tokí
, "autosave_on_changes")){

957 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "autoßve_⁄_ch™ges", &
c⁄fig
->
autoßve_⁄_ch™ges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

958 }if(!
	`°rcmp
(
tokí
, "bind_address")){

959 if(
ªlﬂd
) ;

960 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "deÁu…Üi°íî böd_addªss", &
c⁄fig
->
deÁu…_li°íî
.
ho°
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

961 if(
	`c⁄f__©ãm±_ªsﬁve
(
c⁄fig
->
deÁu…_li°íî
.
ho°
, "böd_addªss", 
MOSQ_LOG_ERR
, "Error")){

962  
MOSQ_ERR_INVAL
;

964 }if(!
	`°rcmp
(
tokí
, "bind_interface")){

965 #ifde‡
SO_BINDTODEVICE


966 if(
ªlﬂd
) ;

967 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "böd_öãrÁ˚", &
cur_li°íî
->
böd_öãrÁ˚
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

969 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: bind_interface specified but socket optionÇotávailable.");

970  
MOSQ_ERR_INVAL
;

972 }if(!
	`°rcmp
(
tokí
, "bridge_attempt_unsubscribe")){

973 #ifde‡
WITH_BRIDGE


974 if(
ªlﬂd
) ;

975 if(!
cur_bridge
){

976 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

977  
MOSQ_ERR_INVAL
;

979 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "bridge_©ãm±_unsubs¸ibe", &
cur_bridge
->
©ãm±_unsubs¸ibe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

981 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

983 }if(!
	`°rcmp
(
tokí
, "bridge_cafile")){

984 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

985 if(
ªlﬂd
) ;

986 if(!
cur_bridge
){

987 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

988  
MOSQ_ERR_INVAL
;

990 #ifde‡
FINAL_WITH_TLS_PSK


991 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

992 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

993  
MOSQ_ERR_INVAL
;

996 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_ˇfûe", &
cur_bridge
->
és_ˇfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

998 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1000 }if(!
	`°rcmp
(
tokí
, "bridge_alpn")){

1001 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1002 if(
ªlﬂd
) ;

1003 if(!
cur_bridge
){

1004 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1005  
MOSQ_ERR_INVAL
;

1007 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_Æ≤", &
cur_bridge
->
és_Æ≤
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1009 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1011 }if(!
	`°rcmp
(
tokí
, "bridge_capath")){

1012 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1013 if(
ªlﬂd
) ;

1014 if(!
cur_bridge
){

1015 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1016  
MOSQ_ERR_INVAL
;

1018 #ifde‡
FINAL_WITH_TLS_PSK


1019 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

1020 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

1021  
MOSQ_ERR_INVAL
;

1024 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_ˇ∑th", &
cur_bridge
->
és_ˇ∑th
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1026 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1028 }if(!
	`°rcmp
(
tokí
, "bridge_certfile")){

1029 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1030 if(
ªlﬂd
) ;

1031 if(!
cur_bridge
){

1032 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1033  
MOSQ_ERR_INVAL
;

1035 #ifde‡
FINAL_WITH_TLS_PSK


1036 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

1037 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

1038  
MOSQ_ERR_INVAL
;

1041 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_˚πfûe", &
cur_bridge
->
és_˚πfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1043 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1045 }if(!
	`°rcmp
(
tokí
, "bridge_identity")){

1046 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
FINAL_WITH_TLS_PSK
)

1047 if(
ªlﬂd
) ;

1048 if(!
cur_bridge
){

1049 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1050  
MOSQ_ERR_INVAL
;

1052 if(
cur_bridge
->
és_ˇfûe
 || cur_bridge->
és_ˇ∑th
 || cur_bridge->
és_˚πfûe
 || cur_bridge->
és_keyfûe
){

1053 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateánd identityÉncryption iná single bridge.");

1054  
MOSQ_ERR_INVAL
;

1056 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_idítôy", &
cur_bridge
->
és_psk_idítôy
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1058 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

1060 }if(!
	`°rcmp
(
tokí
, "bridge_insecure")){

1061 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1062 if(
ªlﬂd
) ;

1063 if(!
cur_bridge
){

1064 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1065  
MOSQ_ERR_INVAL
;

1067 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "bridge_ö£cuª", &
cur_bridge
->
és_ö£cuª
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1068 if(
cur_bridge
->
és_ö£cuª
){

1069 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Bridgê%†usög in£cuª mode.", 
cur_bridge
->
«me
);

1072 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

1074 }if(!
	`°rcmp
(
tokí
, "bridge_require_ocsp")){

1075 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1076 if(
ªlﬂd
) ;

1077 if(!
cur_bridge
){

1078 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1079  
MOSQ_ERR_INVAL
;

1081 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "bridge_ªquúe_oc•", &
cur_bridge
->
és_oc•_ªquúed
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1083 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1085 }if(!
	`°rcmp
(
tokí
, "bridge_keyfile")){

1086 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1087 if(
ªlﬂd
) ;

1088 if(!
cur_bridge
){

1089 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1090  
MOSQ_ERR_INVAL
;

1092 #ifde‡
FINAL_WITH_TLS_PSK


1093 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

1094 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

1095  
MOSQ_ERR_INVAL
;

1098 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_keyfûe", &
cur_bridge
->
és_keyfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1100 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1102 }if(!
	`°rcmp
(
tokí
, "bridge_protocol_version")){

1103 #ifde‡
WITH_BRIDGE


1104 if(
ªlﬂd
) ;

1105 if(!
cur_bridge
){

1106 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1107  
MOSQ_ERR_INVAL
;

1109 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

1110 if(
tokí
){

1111 if(!
	`°rcmp
(
tokí
, "mqttv31")){

1112 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ31
;

1113 }if(!
	`°rcmp
(
tokí
, "mqttv311")){

1114 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ311
;

1116 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridge_¥Ÿocﬁ_vîsi⁄ vÆuê(%s).", 
tokí
);

1117  
MOSQ_ERR_INVAL
;

1120 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_protocol_version value in configuration.");

1121  
MOSQ_ERR_INVAL
;

1124 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1126 }if(!
	`°rcmp
(
tokí
, "bridge_psk")){

1127 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
FINAL_WITH_TLS_PSK
)

1128 if(
ªlﬂd
) ;

1129 if(!
cur_bridge
){

1130 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1131  
MOSQ_ERR_INVAL
;

1133 if(
cur_bridge
->
és_ˇfûe
 || cur_bridge->
és_ˇ∑th
 || cur_bridge->
és_˚πfûe
 || cur_bridge->
és_keyfûe
){

1134 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

1135  
MOSQ_ERR_INVAL
;

1137 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_psk", &
cur_bridge
->
és_psk
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1139 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

1141 }if(!
	`°rcmp
(
tokí
, "bridge_tls_version")){

1142 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

1143 if(
ªlﬂd
) ;

1144 if(!
cur_bridge
){

1145 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1146  
MOSQ_ERR_INVAL
;

1148 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridge_és_vîsi⁄", &
cur_bridge
->
és_vîsi⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1150 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

1152 }if(!
	`°rcmp
(
tokí
, "cafile")){

1153 #i‡
	`deföed
(
WITH_TLS
)

1154 if(
ªlﬂd
) ;

1155 if(
cur_li°íî
->
psk_höt
){

1156 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná singleÜistener.");

1157  
MOSQ_ERR_INVAL
;

1159 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "ˇfûe", &
cur_li°íî
->
ˇfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1161 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1163 }if(!
	`°rcmp
(
tokí
, "capath")){

1164 #ifde‡
WITH_TLS


1165 if(
ªlﬂd
) ;

1166 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "ˇ∑th", &
cur_li°íî
->
ˇ∑th
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1168 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1170 }if(!
	`°rcmp
(
tokí
, "certfile")){

1171 #ifde‡
WITH_TLS


1172 if(
ªlﬂd
) ;

1173 if(
cur_li°íî
->
psk_höt
){

1174 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná singleÜistener.");

1175  
MOSQ_ERR_INVAL
;

1177 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "˚πfûe", &
cur_li°íî
->
˚πfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1179 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1181 }if(!
	`°rcmp
(
tokí
, "check_retain_source")){

1182 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

1183 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "check_ªèö_sour˚", &
c⁄fig
->
check_ªèö_sour˚
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1184 }if(!
	`°rcmp
(
tokí
, "ciphers")){

1185 #ifde‡
WITH_TLS


1186 if(
ªlﬂd
) ;

1187 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "cùhîs", &
cur_li°íî
->
cùhîs
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1189 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1191 }if(!
	`°rcmp
(
tokí
, "clientid") || !strcmp(token, "remote_clientid")){

1192 #ifde‡
WITH_BRIDGE


1193 if(
ªlﬂd
) ;

1194 if(!
cur_bridge
){

1195 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1196  
MOSQ_ERR_INVAL
;

1198 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêªmŸê˛õ¡id", &
cur_bridge
->
ªmŸe_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1200 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1202 }if(!
	`°rcmp
(
tokí
, "cleansession")){

1203 #ifde‡
WITH_BRIDGE


1204 if(
ªlﬂd
) ;

1205 if(!
cur_bridge
){

1206 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1207  
MOSQ_ERR_INVAL
;

1209 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "˛ón£ssi⁄", &
cur_bridge
->
˛ón_°¨t
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1211 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1213 }if(!
	`°rcmp
(
tokí
, "clientid_prefixes")){

1214 if(
ªlﬂd
){

1215 
	`mosquôto__‰ì
(
c⁄fig
->
˛õ¡id_¥efixes
);

1216 
c⁄fig
->
˛õ¡id_¥efixes
 = 
NULL
;

1218 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "˛õ¡id_¥efixes", &
c⁄fig
->
˛õ¡id_¥efixes
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1219 }if(!
	`°rcmp
(
tokí
, "connection")){

1220 #ifde‡
WITH_BRIDGE


1221 if(
ªlﬂd
) ;

1222 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1223 if(
tokí
){

1225 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

1226 if(!
	`°rcmp
(
c⁄fig
->
bridges
[
i
].
«me
, 
tokí
)){

1227 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Du∂iˇã bridgê«mê\"%s\".", 
tokí
);

1228  
MOSQ_ERR_INVAL
;

1232 
c⁄fig
->
bridge_cou¡
++;

1233 
c⁄fig
->
bridges
 = 
	`mosquôto__ªÆloc
(c⁄fig->bridges, c⁄fig->
bridge_cou¡
*(
mosquôto__bridge
));

1234 if(!
c⁄fig
->
bridges
){

1235 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1236  
MOSQ_ERR_NOMEM
;

1238 
cur_bridge
 = &(
c⁄fig
->
bridges
[c⁄fig->
bridge_cou¡
-1]);

1239 
	`mem£t
(
cur_bridge
, 0, (
mosquôto__bridge
));

1240 
cur_bridge
->
«me
 = 
	`mosquôto__°rdup
(
tokí
);

1241 if(!
cur_bridge
->
«me
){

1242 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1243  
MOSQ_ERR_NOMEM
;

1245 
cur_bridge
->
kì∑live
 = 60;

1246 
cur_bridge
->
nŸifiˇti⁄s
 = 
åue
;

1247 
cur_bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
 = 
Ál£
;

1248 
cur_bridge
->
°¨t_ty≥
 = 
b°_autom©ic
;

1249 
cur_bridge
->
idÀ_timeout
 = 60;

1250 
cur_bridge
->
ª°¨t_timeout
 = 0;

1251 
cur_bridge
->
backoff_ba£
 = 5;

1252 
cur_bridge
->
backoff_ˇp
 = 30;

1253 
cur_bridge
->
thªshﬁd
 = 10;

1254 
cur_bridge
->
åy_¥iv©e
 = 
åue
;

1255 
cur_bridge
->
©ãm±_unsubs¸ibe
 = 
åue
;

1256 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ311
;

1257 
cur_bridge
->
¥im¨y_ªåy_sock
 = 
INVALID_SOCKET
;

1259 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty connection value in configuration.");

1260  
MOSQ_ERR_INVAL
;

1263 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1265 }if(!
	`°rcmp
(
tokí
, "connection_messages")){

1266 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
c⁄√˘i⁄_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1267 }if(!
	`°rcmp
(
tokí
, "crlfile")){

1268 #ifde‡
WITH_TLS


1269 if(
ªlﬂd
) ;

1270 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "¸lfûe", &
cur_li°íî
->
¸lfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1272 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1274 }if(!
	`°rcmp
(
tokí
, "dhparamfile")){

1275 #ifde‡
WITH_TLS


1276 if(
ªlﬂd
) ;

1277 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "dh∑ømfûe", &
cur_li°íî
->
dh∑ømfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1279 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1281 }if(!
	`°rcmp
(
tokí
, "http_dir")){

1282 #ifde‡
WITH_WEBSOCKETS


1283 if(
ªlﬂd
) ;

1284 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "hâp_dú", &
cur_li°íî
->
hâp_dú
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1286 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets supportÇotávailable.");

1288 }if(!
	`°rcmp
(
tokí
, "idle_timeout")){

1289 #ifde‡
WITH_BRIDGE


1290 if(
ªlﬂd
) ;

1291 if(!
cur_bridge
){

1292 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1293  
MOSQ_ERR_INVAL
;

1295 if(
	`c⁄f__∑r£_öt
(&
tokí
, "idÀ_timeout", &
cur_bridge
->
idÀ_timeout
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1296 if(
cur_bridge
->
idÀ_timeout
 < 1){

1297 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "idle_timeout intervalÅooÜow, using 1 second.");

1298 
cur_bridge
->
idÀ_timeout
 = 1;

1301 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1303 }if(!
	`°rcmp
(
tokí
, "include_dir")){

1304 if(
Àvñ
 == 0){

1306 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

1307 if(!
tokí
){

1308 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty include_dir value in configuration.");

1312 **
fûes
;

1313 
fûe_cou¡
;

1314 
rc
 = 
	`c⁄fig__gë_dú_fûes
(
tokí
, &
fûes
, &
fûe_cou¡
);

1315 if(
rc
) Ñc;

1317 
i
=0; i<
fûe_cou¡
; i++){

1318 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Lﬂdög c⁄fig fûê%s", 
fûes
[
i
]);

1320 
rc
 = 
	`c⁄fig__ªad_fûe
(
c⁄fig
, 
ªlﬂd
, 
fûes
[
i
], 
¸
, 
Àvñ
+1, &
löío_ext
);

1321 if(
rc
){

1322 if(
löío_ext
 > 0){

1323 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ foundáà%s:%d.", 
fûes
[
i
], 
löío_ext
);

1329 
i
=0; i<
fûe_cou¡
; i++){

1330 
	`mosquôto__‰ì
(
fûes
[
i
]);

1332 
	`mosquôto__‰ì
(
fûes
);

1333 if(
rc
) Ñc;

1335 }if(!
	`°rcmp
(
tokí
, "keepalive_interval")){

1336 #ifde‡
WITH_BRIDGE


1337 if(
ªlﬂd
) ;

1338 if(!
cur_bridge
){

1339 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1340  
MOSQ_ERR_INVAL
;

1342 if(
	`c⁄f__∑r£_öt
(&
tokí
, "kì∑live_öãrvÆ", &
cur_bridge
->
kì∑live
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1343 if(
cur_bridge
->
kì∑live
 < 5){

1344 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "keepalive intervalÅooÜow, using 5 seconds.");

1345 
cur_bridge
->
kì∑live
 = 5;

1348 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1350 }if(!
	`°rcmp
(
tokí
, "keyfile")){

1351 #ifde‡
WITH_TLS


1352 if(
ªlﬂd
) ;

1353 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "keyfûe", &
cur_li°íî
->
keyfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1355 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1357 }if(!
	`°rcmp
(
tokí
, "listener")){

1358 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1359 if(
tokí
){

1360 
tmp_öt
 = 
	`©oi
(
tokí
);

1361 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

1362 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

1363  
MOSQ_ERR_INVAL
;

1366 if(
ªlﬂd
){

1369 
cur_li°íî
 = 
NULL
;

1370 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

1371 if(
c⁄fig
->
li°íîs
[
i
].
p‹t
 =
tmp_öt
){

1372 
cur_li°íî
 = &
c⁄fig
->
li°íîs
[
i
];

1375 if(!
cur_li°íî
){

1376 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: It isÇot currentlyÖossibleÅoádd/removeÜisteners whenÑeloadingÅhe config file.");

1377  
MOSQ_ERR_INVAL
;

1380 
c⁄fig
->
li°íî_cou¡
++;

1381 
c⁄fig
->
li°íîs
 = 
	`mosquôto__ªÆloc
(c⁄fig->li°íîs, (
mosquôto__li°íî
)*c⁄fig->
li°íî_cou¡
);

1382 if(!
c⁄fig
->
li°íîs
){

1383 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1384  
MOSQ_ERR_NOMEM
;

1386 
cur_li°íî
 = &
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1];

1387 
	`mem£t
(
cur_li°íî
, 0, (
mosquôto__li°íî
));

1390 
cur_li°íî
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 = -1;

1391 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_mqâ
;

1392 
cur_li°íî
->
p‹t
 = 
tmp_öt
;

1393 
cur_li°íî
->
maximum_qos
 = 2;

1394 
cur_li°íî
->
max_t›ic_Æüs
 = 10;

1395 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1396 i‡(
tokí
 !
NULL
 &&Åoken[0] == '#'){

1397 
tokí
 = 
NULL
;

1399 
	`mosquôto__‰ì
(
cur_li°íî
->
ho°
);

1400 if(
tokí
){

1401 
cur_li°íî
->
ho°
 = 
	`mosquôto__°rdup
(
tokí
);

1403 
cur_li°íî
->
ho°
 = 
NULL
;

1406 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜistener value in configuration.");

1407  
MOSQ_ERR_INVAL
;

1409 }if(!
	`°rcmp
(
tokí
, "local_clientid")){

1410 #ifde‡
WITH_BRIDGE


1411 if(
ªlﬂd
) ;

1412 if(!
cur_bridge
){

1413 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1414  
MOSQ_ERR_INVAL
;

1416 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêloˇ»˛õ¡d", &
cur_bridge
->
loˇl_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1418 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1420 }if(!
	`°rcmp
(
tokí
, "local_password")){

1421 #ifde‡
WITH_BRIDGE


1422 if(
ªlﬂd
) ;

1423 if(!
cur_bridge
){

1424 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1425  
MOSQ_ERR_INVAL
;

1427 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêloˇl_∑ssw‹d", &
cur_bridge
->
loˇl_∑ssw‹d
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1429 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1431 }if(!
	`°rcmp
(
tokí
, "local_username")){

1432 #ifde‡
WITH_BRIDGE


1433 if(
ªlﬂd
) ;

1434 if(!
cur_bridge
){

1435 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1436  
MOSQ_ERR_INVAL
;

1438 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêloˇl_u£∫ame", &
cur_bridge
->
loˇl_u£∫ame
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1440 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1442 }if(!
	`°rcmp
(
tokí
, "log_dest")){

1443 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1444 if(
tokí
){

1445 
¸
->
log_de°_£t
 = 1;

1446 if(!
	`°rcmp
(
tokí
, "none")){

1447 
¸
->
log_de°
 = 
MQTT3_LOG_NONE
;

1448 }if(!
	`°rcmp
(
tokí
, "syslog")){

1449 
¸
->
log_de°
 |
MQTT3_LOG_SYSLOG
;

1450 }if(!
	`°rcmp
(
tokí
, "stdout")){

1451 
¸
->
log_de°
 |
MQTT3_LOG_STDOUT
;

1452 }if(!
	`°rcmp
(
tokí
, "stderr")){

1453 
¸
->
log_de°
 |
MQTT3_LOG_STDERR
;

1454 }if(!
	`°rcmp
(
tokí
, "topic")){

1455 
¸
->
log_de°
 |
MQTT3_LOG_TOPIC
;

1456 }if(!
	`°rcmp
(
tokí
, "file")){

1457 
¸
->
log_de°
 |
MQTT3_LOG_FILE
;

1458 if(
c⁄fig
->
log_Âå
 || c⁄fig->
log_fûe
){

1459 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate \"log_dest file\" value.");

1460  
MOSQ_ERR_INVAL
;

1463 
tokí
 = &tokí[
	`°æí
(token)+1];

1464 
tokí
[0] == ' ' ||Åoken[0] == '\t'){

1465 
tokí
++;

1467 if(
tokí
[0]){

1468 
c⁄fig
->
log_fûe
 = 
	`mosquôto__°rdup
(
tokí
);

1469 if(!
c⁄fig
->
log_fûe
){

1470 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1471  
MOSQ_ERR_NOMEM
;

1474 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty \"log_dest file\" value in configuration.");

1475  
MOSQ_ERR_INVAL
;

1478 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_de° vÆuê(%s).", 
tokí
);

1479  
MOSQ_ERR_INVAL
;

1481 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

1482 if(
£rvi˚_h™dÀ
){

1483 if(
¸
->
log_de°
 =
MQTT3_LOG_STDOUT
 || cr->log_de° =
MQTT3_LOG_STDERR
){

1484 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: CannotÜogÅo stdout/stderr whenÑunningásá Windows service.");

1485  
MOSQ_ERR_INVAL
;

1490 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜog_dest value in configuration.");

1491  
MOSQ_ERR_INVAL
;

1493 }if(!
	`°rcmp
(
tokí
, "log_facility")){

1494 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

1495 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning:Üog_facilityÇot supported on Windows.");

1497 if(
	`c⁄f__∑r£_öt
(&
tokí
, "log_Ácûôy", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1498 
tmp_öt
){

1500 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL0
;

1503 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL1
;

1506 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL2
;

1509 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL3
;

1512 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL4
;

1515 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL5
;

1518 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL6
;

1521 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL7
;

1524 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_Ácûôy vÆuê(%d).", 
tmp_öt
);

1525  
MOSQ_ERR_INVAL
;

1528 }if(!
	`°rcmp
(
tokí
, "log_timestamp")){

1529 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
log_time°amp
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1530 }if(!
	`°rcmp
(
tokí
, "log_timestamp_format")){

1531 if(
	`c⁄f__∑r£_°rög
(&
tokí
,Åokí, &
c⁄fig
->
log_time°amp_f‹m©
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1532 }if(!
	`°rcmp
(
tokí
, "log_type")){

1533 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1534 if(
tokí
){

1535 
¸
->
log_ty≥_£t
 = 1;

1536 if(!
	`°rcmp
(
tokí
, "none")){

1537 
¸
->
log_ty≥
 = 
MOSQ_LOG_NONE
;

1538 }if(!
	`°rcmp
(
tokí
, "information")){

1539 
¸
->
log_ty≥
 |
MOSQ_LOG_INFO
;

1540 }if(!
	`°rcmp
(
tokí
, "notice")){

1541 
¸
->
log_ty≥
 |
MOSQ_LOG_NOTICE
;

1542 }if(!
	`°rcmp
(
tokí
, "warning")){

1543 
¸
->
log_ty≥
 |
MOSQ_LOG_WARNING
;

1544 }if(!
	`°rcmp
(
tokí
, "error")){

1545 
¸
->
log_ty≥
 |
MOSQ_LOG_ERR
;

1546 }if(!
	`°rcmp
(
tokí
, "debug")){

1547 
¸
->
log_ty≥
 |
MOSQ_LOG_DEBUG
;

1548 }if(!
	`°rcmp
(
tokí
, "subscribe")){

1549 
¸
->
log_ty≥
 |
MOSQ_LOG_SUBSCRIBE
;

1550 }if(!
	`°rcmp
(
tokí
, "unsubscribe")){

1551 
¸
->
log_ty≥
 |
MOSQ_LOG_UNSUBSCRIBE
;

1552 }if(!
	`°rcmp
(
tokí
, "internal")){

1553 
¸
->
log_ty≥
 |
MOSQ_LOG_INTERNAL
;

1554 #ifde‡
WITH_WEBSOCKETS


1555 }if(!
	`°rcmp
(
tokí
, "websockets")){

1556 
¸
->
log_ty≥
 |
MOSQ_LOG_WEBSOCKETS
;

1558 }if(!
	`°rcmp
(
tokí
, "all")){

1559 
¸
->
log_ty≥
 = 
MOSQ_LOG_ALL
;

1561 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_ty≥ vÆuê(%s).", 
tokí
);

1562  
MOSQ_ERR_INVAL
;

1565 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜog_type value in configuration.");

1567 }if(!
	`°rcmp
(
tokí
, "max_connections")){

1568 if(
ªlﬂd
) ;

1569 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1570 if(
tokí
){

1571 
cur_li°íî
->
max_c⁄√˘i⁄s
 = 
	`©oi
(
tokí
);

1572 if(
cur_li°íî
->
max_c⁄√˘i⁄s
 < 0) cur_listener->max_connections = -1;

1574 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_connections value in configuration.");

1576 }if(!
	`°rcmp
(
tokí
, "maximum_qos")){

1577 if(
ªlﬂd
) ;

1578 if(
	`c⁄f__∑r£_öt
(&
tokí
, "maximum_qos", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1579 if(
tmp_öt
 < 0 ||Åmp_int > 2){

1580 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: maximum_qos must be between 0ánd 2 inclusive.");

1581  
MOSQ_ERR_INVAL
;

1583 
cur_li°íî
->
maximum_qos
 = 
tmp_öt
;

1584 }if(!
	`°rcmp
(
tokí
, "max_inflight_bytes")){

1585 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1586 if(
tokí
){

1587 
¸
->
max_öÊight_byãs
 = 
	`©ﬁ
(
tokí
);

1589 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_inflight_bytes value in configuration.");

1591 }if(!
	`°rcmp
(
tokí
, "max_inflight_messages")){

1592 if(
	`c⁄f__∑r£_öt
(&
tokí
, "max_öÊight_mesßges", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1593 if(
tmp_öt
 < 0 ||Åmp_int == 65535){

1594 
tmp_öt
 = 0;

1595 }if(
tmp_öt
 > 65535){

1596 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: max_inflight_messages must be <= 65535.");

1597  
MOSQ_ERR_INVAL
;

1599 
c⁄fig
->
max_öÊight_mesßges
 = 
tmp_öt
;

1600 }if(!
	`°rcmp
(
tokí
, "max_keepalive")){

1601 if(
	`c⁄f__∑r£_öt
(&
tokí
, "max_kì∑live", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1602 if(
tmp_öt
 < 10 ||Åmp_int > 65535){

1603 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid max_kì∑livêvÆuê(%d).", 
tmp_öt
);

1604  
MOSQ_ERR_INVAL
;

1606 
c⁄fig
->
max_kì∑live
 = 
tmp_öt
;

1607 }if(!
	`°rcmp
(
tokí
, "max_packet_size")){

1608 if(
	`c⁄f__∑r£_öt
(&
tokí
, "max_∑ckë_size", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1609 if(
tmp_öt
 < 20){

1610 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid max_∑ckë_sizêvÆuê(%d).", 
tmp_öt
);

1611  
MOSQ_ERR_INVAL
;

1613 
c⁄fig
->
max_∑ckë_size
 = 
tmp_öt
;

1614 }if(!
	`°rcmp
(
tokí
, "max_queued_bytes")){

1615 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1616 if(
tokí
){

1617 
¸
->
max_queued_byãs
 = 
	`©ﬁ
(
tokí
);

1619 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_queued_bytes value in configuration.");

1621 }if(!
	`°rcmp
(
tokí
, "max_queued_messages")){

1622 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1623 if(
tokí
){

1624 
¸
->
max_queued_mesßges
 = 
	`©oi
(
tokí
);

1625 if(
¸
->
max_queued_mesßges
 < 0) cr->max_queued_messages = 0;

1627 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_queued_messages value in configuration.");

1629 }if(!
	`°rcmp
(
tokí
, "memory_limit")){

1630 
ssize_t
 
lim
;

1631 if(
	`c⁄f__∑r£_ssize_t
(&
tokí
, "mem‹y_limô", &
lim
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1632 if(
lim
 < 0){

1633 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid mem‹y_limô vÆuê(%ld).", 
lim
);

1634  
MOSQ_ERR_INVAL
;

1636 
	`mem‹y__£t_limô
(
lim
);

1637 }if(!
	`°rcmp
(
tokí
, "message_size_limit")){

1638 if(
	`c⁄f__∑r£_öt
(&
tokí
, "mesßge_size_limô", (*)&
c⁄fig
->
mesßge_size_limô
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1639 if(
c⁄fig
->
mesßge_size_limô
 > 
MQTT_MAX_PAYLOAD
){

1640 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid mesßge_size_limô vÆuê(%u).", 
c⁄fig
->
mesßge_size_limô
);

1641  
MOSQ_ERR_INVAL
;

1643 }if(!
	`°rcmp
(
tokí
, "mount_point")){

1644 if(
ªlﬂd
) ;

1645 if(
c⁄fig
->
li°íî_cou¡
 == 0){

1646 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: You must use createáÜistener before usingÅhe mount_point option inÅhe configuration file.");

1647  
MOSQ_ERR_INVAL
;

1649 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "mou¡_poöt", &
cur_li°íî
->
mou¡_poöt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1650 if(
	`mosquôto_pub_t›ic_check
(
cur_li°íî
->
mou¡_poöt
Ë!
MOSQ_ERR_SUCCESS
){

1651 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

1653 
cur_li°íî
->
mou¡_poöt
);

1654  
MOSQ_ERR_INVAL
;

1656 }if(!
	`°rcmp
(
tokí
, "notifications")){

1657 #ifde‡
WITH_BRIDGE


1658 if(
ªlﬂd
) ;

1659 if(!
cur_bridge
){

1660 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1661  
MOSQ_ERR_INVAL
;

1663 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "nŸifiˇti⁄s", &
cur_bridge
->
nŸifiˇti⁄s
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1665 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1667 }if(!
	`°rcmp
(
tokí
, "notifications_local_only")){

1668 #ifde‡
WITH_BRIDGE


1669 if(
ªlﬂd
) ;

1670 if(!
cur_bridge
){

1671 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration");

1672  
MOSQ_ERR_INVAL
;

1674 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "nŸifiˇti⁄s_loˇl_⁄ly", &
cur_bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1676 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1678 }if(!
	`°rcmp
(
tokí
, "notification_topic")){

1679 #ifde‡
WITH_BRIDGE


1680 if(
ªlﬂd
) ;

1681 if(!
cur_bridge
){

1682 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1683  
MOSQ_ERR_INVAL
;

1685 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "nŸifiˇti⁄_t›ic", &
cur_bridge
->
nŸifiˇti⁄_t›ic
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1687 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1689 }if(!
	`°rcmp
(
tokí
, "password") || !strcmp(token, "remote_password")){

1690 #ifde‡
WITH_BRIDGE


1691 if(
ªlﬂd
) ;

1692 if(!
cur_bridge
){

1693 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1694  
MOSQ_ERR_INVAL
;

1696 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêªmŸe_∑ssw‹d", &
cur_bridge
->
ªmŸe_∑ssw‹d
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1698 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1700 }if(!
	`°rcmp
(
tokí
, "password_file")){

1701 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

1702 if(
ªlﬂd
){

1703 
	`mosquôto__‰ì
(
cur_£curôy_›ti⁄s
->
∑ssw‹d_fûe
);

1704 
cur_£curôy_›ti⁄s
->
∑ssw‹d_fûe
 = 
NULL
;

1706 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "∑ssw‹d_fûe", &
cur_£curôy_›ti⁄s
->
∑ssw‹d_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1707 }if(!
	`°rcmp
(
tokí
, "per_listener_settings")){

1708 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "≥r_li°íî_£âögs", &
c⁄fig
->
≥r_li°íî_£âögs
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1709 if(
cur_£curôy_›ti⁄s
 && 
c⁄fig
->
≥r_li°íî_£âögs
){

1710 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error:Öer_listener_settings must be set beforeány other security settings.");

1711  
MOSQ_ERR_INVAL
;

1713 }if(!
	`°rcmp
(
tokí
, "persistence") || !strcmp(token, "retained_persistence")){

1714 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
≥rsi°í˚
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1715 }if(!
	`°rcmp
(
tokí
, "persistence_file")){

1716 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "≥rsi°í˚_fûe", &
c⁄fig
->
≥rsi°í˚_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1717 }if(!
	`°rcmp
(
tokí
, "persistence_location")){

1718 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "≥rsi°í˚_loˇti⁄", &
c⁄fig
->
≥rsi°í˚_loˇti⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1719 }if(!
	`°rcmp
(
tokí
, "persistent_client_expiration")){

1720 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1721 if(
tokí
){

1722 
tokí
[
	`°æí
(token)-1]){

1724 
expú©i⁄_mu…
 = 3600;

1727 
expú©i⁄_mu…
 = 86400;

1730 
expú©i⁄_mu…
 = 86400*7;

1733 
expú©i⁄_mu…
 = 86400*30;

1736 
expú©i⁄_mu…
 = 86400*365;

1739 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: InvalidÖersistent_client_expiration duration in configuration.");

1740  
MOSQ_ERR_INVAL
;

1742 
tokí
[
	`°æí
(token)-1] = '\0';

1743 
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 = 
	`©oi
(
tokí
)*
expú©i⁄_mu…
;

1744 if(
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 <= 0){

1745 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: InvalidÖersistent_client_expiration duration in configuration.");

1746  
MOSQ_ERR_INVAL
;

1749 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÖersistent_client_expiration value in configuration.");

1751 }if(!
	`°rcmp
(
tokí
, "pid_file")){

1752 if(
ªlﬂd
) ;

1753 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "pid_fûe", &
c⁄fig
->
pid_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1754 }if(!
	`°rcmp
(
tokí
, "port")){

1755 if(
ªlﬂd
) ;

1756 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

1757 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: DefaultÜistenerÖort specified multipleÅimes. OnlyÅheÜatest will be used.");

1759 if(
	`c⁄f__∑r£_öt
(&
tokí
, "p‹t", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1760 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

1761 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

1762  
MOSQ_ERR_INVAL
;

1764 
c⁄fig
->
deÁu…_li°íî
.
p‹t
 = 
tmp_öt
;

1765 }if(!
	`°rcmp
(
tokí
, "protocol")){

1766 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1767 if(
tokí
){

1768 if(!
	`°rcmp
(
tokí
, "mqtt")){

1769 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_mqâ
;

1774 }if(!
	`°rcmp
(
tokí
, "websockets")){

1775 #ifde‡
WITH_WEBSOCKETS


1776 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_websockës
;

1777 
c⁄fig
->
have_websockës_li°íî
 = 
åue
;

1779 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Websockets supportÇotávailable.");

1780  
MOSQ_ERR_INVAL
;

1783 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖrŸocﬁ vÆuê(%s).", 
tokí
);

1784  
MOSQ_ERR_INVAL
;

1787 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÖrotocol value in configuration.");

1789 }if(!
	`°rcmp
(
tokí
, "psk_file")){

1790 #ifde‡
FINAL_WITH_TLS_PSK


1791 
	`c⁄f__£t_cur_£curôy_›ti⁄s
(
c⁄fig
, 
cur_li°íî
, &
cur_£curôy_›ti⁄s
);

1792 if(
ªlﬂd
){

1793 
	`mosquôto__‰ì
(
cur_£curôy_›ti⁄s
->
psk_fûe
);

1794 
cur_£curôy_›ti⁄s
->
psk_fûe
 = 
NULL
;

1796 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "psk_fûe", &
cur_£curôy_›ti⁄s
->
psk_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1798 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS/TLS-PSK supportÇotávailable.");

1800 }if(!
	`°rcmp
(
tokí
, "psk_hint")){

1801 #ifde‡
FINAL_WITH_TLS_PSK


1802 if(
ªlﬂd
) ;

1803 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "psk_höt", &
cur_li°íî
->
psk_höt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1805 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS/TLS-PSK supportÇotávailable.");

1807 }if(!
	`°rcmp
(
tokí
, "queue_qos0_messages")){

1808 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
queue_qos0_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1809 }if(!
	`°rcmp
(
tokí
, "require_certificate")){

1810 #ifde‡
WITH_TLS


1811 if(
ªlﬂd
) ;

1812 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "ªquúe_˚πifiˇã", &
cur_li°íî
->
ªquúe_˚πifiˇã
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1814 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1816 }if(!
	`°rcmp
(
tokí
, "restart_timeout")){

1817 #ifde‡
WITH_BRIDGE


1818 if(
ªlﬂd
) ;

1819 if(!
cur_bridge
){

1820 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1821  
MOSQ_ERR_INVAL
;

1823 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1824 if(!
tokí
){

1825 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÑestart_timeout value in configuration.");

1826  
MOSQ_ERR_INVAL
;

1828 
cur_bridge
->
ª°¨t_timeout
 = 
	`©oi
(
tokí
);

1829 if(
cur_bridge
->
ª°¨t_timeout
 < 1){

1830 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "restart_timeout intervalÅooÜow, using 1 second.");

1831 
cur_bridge
->
ª°¨t_timeout
 = 1;

1833 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1834 if(
tokí
){

1835 
cur_bridge
->
backoff_ba£
 = cur_bridge->
ª°¨t_timeout
;

1836 
cur_bridge
->
backoff_ˇp
 = 
	`©oi
(
tokí
);

1837 if(
cur_bridge
->
backoff_ˇp
 < cur_bridge->
backoff_ba£
){

1838 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: backoff cap isÜowerÅhanÅhe base inÑestart_timeout.");

1839  
MOSQ_ERR_INVAL
;

1843 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1845 }if(!
	`°rcmp
(
tokí
, "retain_available")){

1846 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
ªèö_avaûabÀ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1847 }if(!
	`°rcmp
(
tokí
, "retry_interval")){

1848 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TheÑetry_interval option isÇoÜongerávailable.");

1849 }if(!
	`°rcmp
(
tokí
, "round_robin")){

1850 #ifde‡
WITH_BRIDGE


1851 if(
ªlﬂd
) ;

1852 if(!
cur_bridge
){

1853 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1854  
MOSQ_ERR_INVAL
;

1856 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "round_robö", &
cur_bridge
->
round_robö
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1858 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1860 }if(!
	`°rcmp
(
tokí
, "set_tcp_nodelay")){

1861 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "£t_t˝_nodñay", &
c⁄fig
->
£t_t˝_nodñay
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1862 }if(!
	`°rcmp
(
tokí
, "start_type")){

1863 #ifde‡
WITH_BRIDGE


1864 if(
ªlﬂd
) ;

1865 if(!
cur_bridge
){

1866 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1867  
MOSQ_ERR_INVAL
;

1869 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1870 if(
tokí
){

1871 if(!
	`°rcmp
(
tokí
, "automatic")){

1872 
cur_bridge
->
°¨t_ty≥
 = 
b°_autom©ic
;

1873 }if(!
	`°rcmp
(
tokí
, "lazy")){

1874 
cur_bridge
->
°¨t_ty≥
 = 
b°_œzy
;

1875 }if(!
	`°rcmp
(
tokí
, "manual")){

1876 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Manual start_typeÇot supported.");

1877  
MOSQ_ERR_INVAL
;

1878 }if(!
	`°rcmp
(
tokí
, "once")){

1879 
cur_bridge
->
°¨t_ty≥
 = 
b°_⁄˚
;

1881 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid sèπ_ty≥ vÆuêö c⁄figuøti⁄ (%s).", 
tokí
);

1882  
MOSQ_ERR_INVAL
;

1885 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty start_type value in configuration.");

1886  
MOSQ_ERR_INVAL
;

1889 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1891 }if(!
	`°rcmp
(
tokí
, "socket_domain")){

1892 if(
ªlﬂd
) ;

1893 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1894 if(
tokí
){

1895 if(!
	`°rcmp
(
tokí
, "ipv4")){

1896 
cur_li°íî
->
sockë_domaö
 = 
AF_INET
;

1897 }if(!
	`°rcmp
(
tokí
, "ipv6")){

1898 
cur_li°íî
->
sockë_domaö
 = 
AF_INET6
;

1900 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid sockë_domaö vÆuê\"%s\" i¿c⁄figuøti⁄.", 
tokí
);

1901  
MOSQ_ERR_INVAL
;

1904 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty socket_domain value in configuration.");

1905  
MOSQ_ERR_INVAL
;

1907 }if(!
	`°rcmp
(
tokí
, "store_clean_interval")){

1908 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: store_clean_interval isÇoÜongerÇeeded.");

1909 }if(!
	`°rcmp
(
tokí
, "sys_interval")){

1910 if(
	`c⁄f__∑r£_öt
(&
tokí
, "sys_öãrvÆ", &
c⁄fig
->
sys_öãrvÆ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1911 if(
c⁄fig
->
sys_öãrvÆ
 < 0 || config->sys_interval > 65535){

1912 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid sys_öãrvÆ vÆuê(%d).", 
c⁄fig
->
sys_öãrvÆ
);

1913  
MOSQ_ERR_INVAL
;

1915 }if(!
	`°rcmp
(
tokí
, "threshold")){

1916 #ifde‡
WITH_BRIDGE


1917 if(
ªlﬂd
) ;

1918 if(!
cur_bridge
){

1919 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1920  
MOSQ_ERR_INVAL
;

1922 if(
	`c⁄f__∑r£_öt
(&
tokí
, "thªshﬁd", &
cur_bridge
->
thªshﬁd
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1923 if(
cur_bridge
->
thªshﬁd
 < 1){

1924 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "thresholdÅooÜow, using 1 message.");

1925 
cur_bridge
->
thªshﬁd
 = 1;

1928 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1930 }if(!
	`°rcmp
(
tokí
, "tls_engine")){

1931 #ifde‡
WITH_TLS


1932 if(
ªlﬂd
) ;

1933 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "és_ígöe", &
cur_li°íî
->
és_ígöe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1935 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1937 }if(!
	`°rcmp
(
tokí
, "tls_engine_kpass_sha1")){

1938 #ifde‡
WITH_TLS


1939 if(
ªlﬂd
) ;

1940 *
k∑ss_sha
 = 
NULL
, *
k∑ss_sha_bö
 = NULL;

1941 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "és_ígöe_k∑ss_sha1", &
k∑ss_sha
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1942 if(
	`mosquôto__hex2bö_sha1
(
k∑ss_sha
, (**)&
k∑ss_sha_bö
Ë!
MOSQ_ERR_SUCCESS
){

1943 
	`mosquôto__‰ì
(
k∑ss_sha
);

1944  
MOSQ_ERR_INVAL
;

1946 
cur_li°íî
->
és_ígöe_k∑ss_sha1
 = 
k∑ss_sha_bö
;

1947 
	`mosquôto__‰ì
(
k∑ss_sha
);

1949 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1951 }if(!
	`°rcmp
(
tokí
, "tls_keyform")){

1952 #ifde‡
WITH_TLS


1953 if(
ªlﬂd
) ;

1954 *
keyf‹m
 = 
NULL
;

1955 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "és_keyf‹m", &
keyf‹m
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1956 
cur_li°íî
->
és_keyf‹m
 = 
mosq_k_≥m
;

1957 if(!
	`°rcmp
(
keyf‹m
, "ígöe")Ë
cur_li°íî
->
és_keyf‹m
 = 
mosq_k_ígöe
;

1958 
	`mosquôto__‰ì
(
keyf‹m
);

1960 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1962 }if(!
	`°rcmp
(
tokí
, "tls_version")){

1963 #i‡
	`deföed
(
WITH_TLS
)

1964 if(
ªlﬂd
) ;

1965 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "és_vîsi⁄", &
cur_li°íî
->
és_vîsi⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1967 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1969 }if(!
	`°rcmp
(
tokí
, "topic")){

1970 #ifde‡
WITH_BRIDGE


1971 if(
ªlﬂd
) ;

1972 if(!
cur_bridge
){

1973 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1974  
MOSQ_ERR_INVAL
;

1976 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1977 if(
tokí
){

1978 
cur_bridge
->
t›ic_cou¡
++;

1979 
cur_bridge
->
t›ics
 = 
	`mosquôto__ªÆloc
(cur_bridge->topics,

1980 (
mosquôto__bridge_t›ic
)*
cur_bridge
->
t›ic_cou¡
);

1981 if(!
cur_bridge
->
t›ics
){

1982 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1983  
MOSQ_ERR_NOMEM
;

1985 
cur_t›ic
 = &
cur_bridge
->
t›ics
[cur_bridge->
t›ic_cou¡
-1];

1986 if(!
	`°rcmp
(
tokí
, "\"\"")){

1987 
cur_t›ic
->
t›ic
 = 
NULL
;

1989 
cur_t›ic
->
t›ic
 = 
	`mosquôto__°rdup
(
tokí
);

1990 if(!
cur_t›ic
->
t›ic
){

1991 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1992  
MOSQ_ERR_NOMEM
;

1995 
cur_t›ic
->
dúe˘i⁄
 = 
bd_out
;

1996 
cur_t›ic
->
qos
 = 0;

1997 
cur_t›ic
->
loˇl_¥efix
 = 
NULL
;

1998 
cur_t›ic
->
ªmŸe_¥efix
 = 
NULL
;

2000 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÅopic value in configuration.");

2001  
MOSQ_ERR_INVAL
;

2003 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2004 if(
tokí
){

2005 if(!
	`°rˇ£cmp
(
tokí
, "out")){

2006 
cur_t›ic
->
dúe˘i⁄
 = 
bd_out
;

2007 }if(!
	`°rˇ£cmp
(
tokí
, "in")){

2008 
cur_t›ic
->
dúe˘i⁄
 = 
bd_ö
;

2009 }if(!
	`°rˇ£cmp
(
tokí
, "both")){

2010 
cur_t›ic
->
dúe˘i⁄
 = 
bd_bŸh
;

2012 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯dúe˘i⁄ '%s'.", 
tokí
);

2013  
MOSQ_ERR_INVAL
;

2015 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2016 if(
tokí
){

2017 i‡(
tokí
[0] == '#'){

2018 
	`°πok_r
(
NULL
, "", &
ßvïå
);

2020 
cur_t›ic
->
qos
 = 
	`©oi
(
tokí
);

2021 if(
cur_t›ic
->
qos
 < 0 || cur_topic->qos > 2){

2022 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêQoSÜevñ '%s'.", 
tokí
);

2023  
MOSQ_ERR_INVAL
;

2026 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2027 if(
tokí
){

2028 
cur_bridge
->
t›ic_ªm≠pög
 = 
åue
;

2029 if(!
	`°rcmp
(
tokí
, "\"\"") ||Åoken[0] == '#'){

2030 
cur_t›ic
->
loˇl_¥efix
 = 
NULL
;

2031 i‡(
tokí
[0] == '#'){

2032 
	`°πok_r
(
NULL
, "", &
ßvïå
);

2035 if(
	`mosquôto_pub_t›ic_check
(
tokí
Ë!
MOSQ_ERR_SUCCESS
){

2036 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯loˇ»¥efix '%s'.", 
tokí
);

2037  
MOSQ_ERR_INVAL
;

2039 
cur_t›ic
->
loˇl_¥efix
 = 
	`mosquôto__°rdup
(
tokí
);

2040 if(!
cur_t›ic
->
loˇl_¥efix
){

2041 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2042  
MOSQ_ERR_NOMEM
;

2046 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2047 if(
tokí
){

2048 if(!
	`°rcmp
(
tokí
, "\"\"") ||Åoken[0] == '#'){

2049 
cur_t›ic
->
ªmŸe_¥efix
 = 
NULL
;

2051 if(
	`mosquôto_pub_t›ic_check
(
tokí
Ë!
MOSQ_ERR_SUCCESS
){

2052 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯ªmŸê¥efix '%s'.", 
tokí
);

2053  
MOSQ_ERR_INVAL
;

2055 
cur_t›ic
->
ªmŸe_¥efix
 = 
	`mosquôto__°rdup
(
tokí
);

2056 if(!
cur_t›ic
->
ªmŸe_¥efix
){

2057 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2058  
MOSQ_ERR_NOMEM
;

2065 if(
cur_t›ic
->
t›ic
 =
NULL
 &&

2066 (
cur_t›ic
->
loˇl_¥efix
 =
NULL
 || cur_t›ic->
ªmŸe_¥efix
 == NULL)){

2068 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridgeÑemapping.");

2069  
MOSQ_ERR_INVAL
;

2071 if(
cur_t›ic
->
loˇl_¥efix
){

2072 if(
cur_t›ic
->
t›ic
){

2073 
Àn
 = 
	`°æí
(
cur_t›ic
->
t›ic
Ë+ såÀn(cur_t›ic->
loˇl_¥efix
)+1;

2074 
cur_t›ic
->
loˇl_t›ic
 = 
	`mosquôto__mÆloc
(
Àn
+1);

2075 if(!
cur_t›ic
->
loˇl_t›ic
){

2076 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2077  
MOSQ_ERR_NOMEM
;

2079 
	`¢¥ötf
(
cur_t›ic
->
loˇl_t›ic
, 
Àn
+1, "%s%s", cur_t›ic->
loˇl_¥efix
, cur_t›ic->
t›ic
);

2080 
cur_t›ic
->
loˇl_t›ic
[
Àn
] = '\0';

2082 
cur_t›ic
->
loˇl_t›ic
 = 
	`mosquôto__°rdup
(cur_t›ic->
loˇl_¥efix
);

2083 if(!
cur_t›ic
->
loˇl_t›ic
){

2084 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2085  
MOSQ_ERR_NOMEM
;

2089 
cur_t›ic
->
loˇl_t›ic
 = 
	`mosquôto__°rdup
(cur_t›ic->
t›ic
);

2090 if(!
cur_t›ic
->
loˇl_t›ic
){

2091 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2092  
MOSQ_ERR_NOMEM
;

2096 if(
cur_t›ic
->
ªmŸe_¥efix
){

2097 if(
cur_t›ic
->
t›ic
){

2098 
Àn
 = 
	`°æí
(
cur_t›ic
->
t›ic
Ë+ såÀn(cur_t›ic->
ªmŸe_¥efix
)+1;

2099 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`mosquôto__mÆloc
(
Àn
+1);

2100 if(!
cur_t›ic
->
ªmŸe_t›ic
){

2101 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2102  
MOSQ_ERR_NOMEM
;

2104 
	`¢¥ötf
(
cur_t›ic
->
ªmŸe_t›ic
, 
Àn
, "%s%s", cur_t›ic->
ªmŸe_¥efix
, cur_t›ic->
t›ic
);

2105 
cur_t›ic
->
ªmŸe_t›ic
[
Àn
] = '\0';

2107 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`mosquôto__°rdup
(cur_t›ic->
ªmŸe_¥efix
);

2108 if(!
cur_t›ic
->
ªmŸe_t›ic
){

2109 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2110  
MOSQ_ERR_NOMEM
;

2114 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`mosquôto__°rdup
(cur_t›ic->
t›ic
);

2115 if(!
cur_t›ic
->
ªmŸe_t›ic
){

2116 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2117  
MOSQ_ERR_NOMEM
;

2121 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

2123 }if(!
	`°rcmp
(
tokí
, "max_topic_alias")){

2124 if(
ªlﬂd
) ;

2125 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2126 if(
tokí
){

2127 
cur_li°íî
->
max_t›ic_Æüs
 = 
	`©oi
(
tokí
);

2129 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_topic_alias value in configuration.");

2131 }if(!
	`°rcmp
(
tokí
, "try_private")){

2132 #ifde‡
WITH_BRIDGE


2133 if(
ªlﬂd
) ;

2134 if(!
cur_bridge
){

2135 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

2136  
MOSQ_ERR_INVAL
;

2138 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "åy_¥iv©e", &
cur_bridge
->
åy_¥iv©e
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2140 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

2142 }if(!
	`°rcmp
(
tokí
, "upgrade_outgoing_qos")){

2143 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
upgøde_outgoög_qos
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2144 }if(!
	`°rcmp
(
tokí
, "use_identity_as_username")){

2145 #ifde‡
WITH_TLS


2146 if(
ªlﬂd
) ;

2147 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "u£_idítôy_as_u£∫ame", &
cur_li°íî
->
u£_idítôy_as_u£∫ame
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2149 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

2151 }if(!
	`°rcmp
(
tokí
, "use_subject_as_username")){

2152 #ifde‡
WITH_TLS


2153 if(
ªlﬂd
) ;

2154 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "u£_subje˘_as_u£∫ame", &
cur_li°íî
->
u£_subje˘_as_u£∫ame
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2156 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

2158 }if(!
	`°rcmp
(
tokí
, "user")){

2159 if(
ªlﬂd
) ;

2160 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "u£r", &
c⁄fig
->
u£r
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2161 }if(!
	`°rcmp
(
tokí
, "use_username_as_clientid")){

2162 if(
ªlﬂd
) ;

2163 if(
	`c⁄f__∑r£_boﬁ
(&
tokí
, "u£_u£∫ame_as_˛õ¡id", &
cur_li°íî
->
u£_u£∫ame_as_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2164 }if(!
	`°rcmp
(
tokí
, "username") || !strcmp(token, "remote_username")){

2165 #ifde‡
WITH_BRIDGE


2166 if(
ªlﬂd
) ;

2167 if(!
cur_bridge
){

2168 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

2169  
MOSQ_ERR_INVAL
;

2171 if(
	`c⁄f__∑r£_°rög
(&
tokí
, "bridgêªmŸe_u£∫ame", &
cur_bridge
->
ªmŸe_u£∫ame
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2173 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

2175 }if(!
	`°rcmp
(
tokí
, "websockets_log_level")){

2176 #ifde‡
WITH_WEBSOCKETS


2177 if(
	`c⁄f__∑r£_öt
(&
tokí
, "websockës_log_Àvñ", &
c⁄fig
->
websockës_log_Àvñ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2179 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets supportÇotávailable.");

2181 }if(!
	`°rcmp
(
tokí
, "websockets_headers_size")){

2182 #ifde‡
WITH_WEBSOCKETS


2183 #i‡
	`deföed
(
LWS_LIBRARY_VERSION_NUMBER
) && LWS_LIBRARY_VERSION_NUMBER>=1007000

2184 if(
	`c⁄f__∑r£_öt
(&
tokí
, "websockës_hódîs_size", &
c⁄fig
->
websockës_hódîs_size
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

2186 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets headers sizeÑequireÜibwebsocket 1.7+");

2189 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets supportÇotávailable.");

2191 }if(!
	`°rcmp
(
tokí
, "trace_level")

2192 || !
	`°rcmp
(
tokí
, "ffdc_output")

2193 || !
	`°rcmp
(
tokí
, "max_log_entries")

2194 || !
	`°rcmp
(
tokí
, "trace_output")){

2195 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Unsuµ‹ãdÑsmb c⁄figuøti⁄ o±i⁄ \"%s\".", 
tokí
);

2197 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Unknow¿c⁄figuøti⁄ v¨übÀ \"%s\".", 
tokí
);

2198  
MOSQ_ERR_INVAL
;

2203  
MOSQ_ERR_SUCCESS
;

2204 
	}
}

2206 
	$c⁄fig__ªad_fûe
(
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, c⁄° *
fûe
, 
c⁄fig_ªcur£
 *
¸
, 
Àvñ
, *
löío
)

2208 
rc
;

2209 
FILE
 *
Âå
 = 
NULL
;

2210 *
buf
;

2211 
buÊí
;

2213 
Âå
 = 
	`mosquôto__f›í
(
fûe
, "π", 
Ál£
);

2214 if(!
Âå
){

2215 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í c⁄fig fûê%s.", 
fûe
);

2219 
buÊí
 = 1000;

2220 
buf
 = 
	`mosquôto__mÆloc
(
buÊí
);

2221 if(!
buf
){

2222 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2223 
	`f˛o£
(
Âå
);

2224  
MOSQ_ERR_NOMEM
;

2227 
rc
 = 
	`c⁄fig__ªad_fûe_c‹e
(
c⁄fig
, 
ªlﬂd
, 
¸
, 
Àvñ
, 
löío
, 
Âå
, &
buf
, &
buÊí
);

2228 
	`mosquôto__‰ì
(
buf
);

2229 
	`f˛o£
(
Âå
);

2231  
rc
;

2232 
	}
}

2235 
	$c⁄fig__check
(
mosquôto__c⁄fig
 *
c⁄fig
)

2239 
i
;

2241 #ifde‡
WITH_BRIDGE


2242 
j
;

2243 
mosquôto__bridge
 *
bridge1
, *
bridge2
;

2244 
ho°«me
[256];

2245 
Àn
;

2249 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

2250 
bridge1
 = &
c⁄fig
->
bridges
[
i
];

2252 if(!
bridge1
->
ªmŸe_˛õ¡id
){

2253 if(!
	`gëho°«me
(
ho°«me
, 256)){

2254 
Àn
 = 
	`°æí
(
ho°«me
Ë+ såÀn(
bridge1
->
«me
) + 2;

2255 
bridge1
->
ªmŸe_˛õ¡id
 = 
	`mosquôto__mÆloc
(
Àn
);

2256 if(!
bridge1
->
ªmŸe_˛õ¡id
){

2257  
MOSQ_ERR_NOMEM
;

2259 
	`¢¥ötf
(
bridge1
->
ªmŸe_˛õ¡id
, 
Àn
, "%s.%s", 
ho°«me
, bridge1->
«me
);

2265 if(!
bridge1
->
loˇl_˛õ¡id
){

2266 
Àn
 = 
	`°æí
(
bridge1
->
ªmŸe_˛õ¡id
) + strlen("local.") + 2;

2267 
bridge1
->
loˇl_˛õ¡id
 = 
	`mosquôto__mÆloc
(
Àn
);

2268 if(!
bridge1
->
loˇl_˛õ¡id
){

2269 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2270  
MOSQ_ERR_NOMEM
;

2272 
	`¢¥ötf
(
bridge1
->
loˇl_˛õ¡id
, 
Àn
, "loˇl.%s", bridge1->
ªmŸe_˛õ¡id
);

2276 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

2277 
bridge1
 = &
c⁄fig
->
bridges
[
i
];

2278 
j
=
i
+1; j<
c⁄fig
->
bridge_cou¡
; j++){

2279 
bridge2
 = &
c⁄fig
->
bridges
[
j
];

2280 if(!
	`°rcmp
(
bridge1
->
loˇl_˛õ¡id
, 
bridge2
->local_clientid)){

2281 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: BridgeÜocal_clientid "

2284 
bridge1
->
loˇl_˛õ¡id
);

2285  
MOSQ_ERR_INVAL
;

2292 if(
c⁄fig
->
≥r_li°íî_£âögs
){

2293 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

2294 if(!
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix
){

2295 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix
 = 
	`mosquôto__°rdup
("auto-");

2296 if(!
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix
){

2297  
MOSQ_ERR_NOMEM
;

2299 
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
auto_id_¥efix_Àn
 = 
	`°æí
("auto-");

2303 if(!
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
){

2304 
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
 = 
	`mosquôto__°rdup
("auto-");

2305 if(!
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
){

2306  
MOSQ_ERR_NOMEM
;

2308 
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix_Àn
 = 
	`°æí
("auto-");

2312  
MOSQ_ERR_SUCCESS
;

2313 
	}
}

2316 
	$c⁄f__∑r£_boﬁ
(**
tokí
, c⁄° *
«me
, 
boﬁ
 *
vÆue
, *
ßvïå
)

2318 *
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2319 if(*
tokí
){

2320 if(!
	`°rcmp
(*
tokí
, "false") || !strcmp(*token, "0")){

2321 *
vÆue
 = 
Ál£
;

2322 }if(!
	`°rcmp
(*
tokí
, "true") || !strcmp(*token, "1")){

2323 *
vÆue
 = 
åue
;

2325 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid %†vÆuê(%s).", 
«me
, *
tokí
);

2326  
MOSQ_ERR_INVAL
;

2329 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

2330  
MOSQ_ERR_INVAL
;

2333  
MOSQ_ERR_SUCCESS
;

2334 
	}
}

2336 
	$c⁄f__∑r£_öt
(**
tokí
, c⁄° *
«me
, *
vÆue
, *
ßvïå
)

2338 *
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2339 if(*
tokí
){

2340 *
vÆue
 = 
	`©oi
(*
tokí
);

2342 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

2343  
MOSQ_ERR_INVAL
;

2346  
MOSQ_ERR_SUCCESS
;

2347 
	}
}

2349 
	$c⁄f__∑r£_ssize_t
(**
tokí
, c⁄° *
«me
, 
ssize_t
 *
vÆue
, *
ßvïå
)

2351 *
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

2352 if(*
tokí
){

2353 *
vÆue
 = 
	`©ﬁ
(*
tokí
);

2355 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

2356  
MOSQ_ERR_INVAL
;

2359  
MOSQ_ERR_SUCCESS
;

2360 
	}
}

2362 
	$c⁄f__∑r£_°rög
(**
tokí
, c⁄° *
«me
, **
vÆue
, *
ßvïå
)

2364 *
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

2365 if(*
tokí
){

2366 if(*
vÆue
){

2367 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Du∂iˇã %†vÆuêö c⁄figuøti⁄.", 
«me
);

2368  
MOSQ_ERR_INVAL
;

2371 (*
tokí
)[0] == ' ' || (*token)[0] == '\t'){

2372 (*
tokí
)++;

2374 if(
	`mosquôto_vÆid©e_utf8
(*
tokí
, 
	`°æí
(*token))){

2375 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Malformed UTF-8 in configuration.");

2376  
MOSQ_ERR_INVAL
;

2378 *
vÆue
 = 
	`mosquôto__°rdup
(*
tokí
);

2379 if(!*
vÆue
){

2380 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

2381  
MOSQ_ERR_NOMEM
;

2384 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

2385  
MOSQ_ERR_INVAL
;

2387  
MOSQ_ERR_SUCCESS
;

2388 
	}
}

	@src/conf_includedir.c

17 
	~"c⁄fig.h
"

19 
	~<˘y≥.h
>

20 
	~<limôs.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<î∫o.h
>

26 #ifde‡
WIN32


28 
	~<dúít.h
>

31 #i‚de‡
WIN32


32 
	~<°rögs.h
>

33 
	~<√tdb.h
>

34 
	~<sys/sockë.h
>

36 
	~<wösock2.h
>

37 
	~<ws2t˝ù.h
>

40 #i‡!
deföed
(
WIN32
Ë&& !deföed(
__CYGWIN__
Ë&& !deföed(
__QNX__
)

41 
	~<sys/sy¶og.h
>

44 
	~"mosquôto_brokî_öã∫Æ.h
"

45 
	~"mem‹y_mosq.h
"

46 
	~"és_mosq.h
"

47 
	~"utû_mosq.h
"

48 
	~"mqâ_¥Ÿocﬁ.h
"

51 
	$scmp_p
(c⁄° *
p1
, c⁄° *
p2
)

53 c⁄° *
s1
 = *(c⁄° **)
p1
;

54 c⁄° *
s2
 = *(c⁄° **)
p2
;

55 
ªsu…
;

57 
s1
[0] && 
s2
[0]){

59 
ªsu…
 = 
	`touµî
(
s1
[0]Ë-Åouµî(
s2
[0]);

60 if(
ªsu…
 == 0){

62 
ªsu…
 = 
s1
[0] - 
s2
[0];

63 if(
ªsu…
 != 0){

64  
ªsu…
;

68  
ªsu…
;

70 
s1
++;

71 
s2
++;

74  
s1
[0] - 
s2
[0];

75 
	}
}

77 #ifde‡
WIN32


78 
	$c⁄fig__gë_dú_fûes
(c⁄° *
ö˛ude_dú
, ***
fûes
, *
fûe_cou¡
)

80 
Àn
;

81 
i
;

82 **
l_fûes
 = 
NULL
;

83 
l_fûe_cou¡
 = 0;

84 **
fûes_tmp
;

86 
HANDLE
 
fh
;

87 
dú∑th
[
MAX_PATH
];

88 
WIN32_FIND_DATA
 
föd_d©a
;

90 
	`¢¥ötf
(
dú∑th
, 
MAX_PATH
, "%s\\*.c⁄f", 
ö˛ude_dú
);

91 
fh
 = 
	`FödFú°Fûe
(
dú∑th
, &
föd_d©a
);

92 if(
fh
 =
INVALID_HANDLE_VALUE
){

93 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í in˛ude_dú '%s'.", 
ö˛ude_dú
);

98 
Àn
 = 
	`°æí
(
ö˛ude_dú
)+1+°æí(
föd_d©a
.
cFûeName
)+1;

100 
l_fûe_cou¡
++;

101 
fûes_tmp
 = 
	`mosquôto__ªÆloc
(
l_fûes
, 
l_fûe_cou¡
*(*));

102 if(!
fûes_tmp
){

103 
i
=0; i<
l_fûe_cou¡
-1; i++){

104 
	`mosquôto__‰ì
(
l_fûes
[
i
]);

106 
	`mosquôto__‰ì
(
l_fûes
);

107 
	`FödClo£
(
fh
);

108  
MOSQ_ERR_NOMEM
;

110 
l_fûes
 = 
fûes_tmp
;

112 
l_fûes
[
l_fûe_cou¡
-1] = 
	`mosquôto__mÆloc
(
Àn
+1);

113 if(!
l_fûes
[
l_fûe_cou¡
-1]){

114 
i
=0; i<
l_fûe_cou¡
-1; i++){

115 
	`mosquôto__‰ì
(
l_fûes
[
i
]);

117 
	`mosquôto__‰ì
(
l_fûes
);

118 
	`FödClo£
(
fh
);

119  
MOSQ_ERR_NOMEM
;

121 
	`¢¥ötf
(
l_fûes
[
l_fûe_cou¡
-1], 
Àn
, "%s/%s", 
ö˛ude_dú
, 
föd_d©a
.
cFûeName
);

122 
l_fûes
[
l_fûe_cou¡
-1][
Àn
] = '\0';

123 }
	`FödNextFûe
(
fh
, &
föd_d©a
));

125 
	`FödClo£
(
fh
);

127 if(
l_fûes
){

128 
	`qs‹t
(
l_fûes
, 
l_fûe_cou¡
, (*), 
scmp_p
);

130 *
fûes
 = 
l_fûes
;

131 *
fûe_cou¡
 = 
l_fûe_cou¡
;

134 
	}
}

138 #i‚de‡
WIN32


140 
	$c⁄fig__gë_dú_fûes
(c⁄° *
ö˛ude_dú
, ***
fûes
, *
fûe_cou¡
)

142 **
l_fûes
 = 
NULL
;

143 
l_fûe_cou¡
 = 0;

144 **
fûes_tmp
;

145 
Àn
;

146 
i
;

148 
DIR
 *
dh
;

149 
dúít
 *
de
;

151 
dh
 = 
	`›ídú
(
ö˛ude_dú
);

152 if(!
dh
){

153 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í in˛ude_dú '%s'.", 
ö˛ude_dú
);

156 (
de
 = 
	`ªaddú
(
dh
)Ë!
NULL
){

157 if(
	`°æí
(
de
->
d_«me
) > 5){

158 if(!
	`°rcmp
(&
de
->
d_«me
[
	`°æí
(de->d_name)-5], ".conf")){

159 
Àn
 = 
	`°æí
(
ö˛ude_dú
)+1+°æí(
de
->
d_«me
)+1;

161 
l_fûe_cou¡
++;

162 
fûes_tmp
 = 
	`mosquôto__ªÆloc
(
l_fûes
, 
l_fûe_cou¡
*(*));

163 if(!
fûes_tmp
){

164 
i
=0; i<
l_fûe_cou¡
-1; i++){

165 
	`mosquôto__‰ì
(
l_fûes
[
i
]);

167 
	`mosquôto__‰ì
(
l_fûes
);

168 
	`˛o£dú
(
dh
);

169  
MOSQ_ERR_NOMEM
;

171 
l_fûes
 = 
fûes_tmp
;

173 
l_fûes
[
l_fûe_cou¡
-1] = 
	`mosquôto__mÆloc
(
Àn
+1);

174 if(!
l_fûes
[
l_fûe_cou¡
-1]){

175 
i
=0; i<
l_fûe_cou¡
-1; i++){

176 
	`mosquôto__‰ì
(
l_fûes
[
i
]);

178 
	`mosquôto__‰ì
(
l_fûes
);

179 
	`˛o£dú
(
dh
);

180  
MOSQ_ERR_NOMEM
;

182 
	`¢¥ötf
(
l_fûes
[
l_fûe_cou¡
-1], 
Àn
, "%s/%s", 
ö˛ude_dú
, 
de
->
d_«me
);

183 
l_fûes
[
l_fûe_cou¡
-1][
Àn
] = '\0';

187 
	`˛o£dú
(
dh
);

189 if(
l_fûes
){

190 
	`qs‹t
(
l_fûes
, 
l_fûe_cou¡
, (*), 
scmp_p
);

192 *
fûes
 = 
l_fûes
;

193 *
fûe_cou¡
 = 
l_fûe_cou¡
;

196 
	}
}

	@src/context.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<time.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"Æüs_mosq.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"¥›îty_mosq.h
"

27 
	~"time_mosq.h
"

28 
	~"utû_mosq.h
"

29 
	~"wûl_mosq.h
"

31 
	~"uthash.h
"

33 
mosquôto
 *
	$c⁄ãxt__öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
)

35 
mosquôto
 *
c⁄ãxt
;

36 
addªss
[1024];

38 
c⁄ãxt
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto
));

39 if(!
c⁄ãxt
Ë 
NULL
;

41 
c⁄ãxt
->
pﬁlfd_ödex
 = -1;

42 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_√w
);

43 
c⁄ãxt
->
sock
 = sock;

44 
c⁄ãxt
->
œ°_msg_ö
 = 
	`mosquôto_time
();

45 
c⁄ãxt
->
√xt_msg_out
 = 
	`mosquôto_time
() + 60;

46 
c⁄ãxt
->
kì∑live
 = 60;

47 
c⁄ãxt
->
˛ón_°¨t
 = 
åue
;

48 
c⁄ãxt
->
id
 = 
NULL
;

49 
c⁄ãxt
->
œ°_mid
 = 0;

50 
c⁄ãxt
->
wûl
 = 
NULL
;

51 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

52 
c⁄ãxt
->
∑ssw‹d
 = 
NULL
;

53 
c⁄ãxt
->
li°íî
 = 
NULL
;

54 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

59 
c⁄ãxt
->
is_bridge
 = 
Ál£
;

61 
c⁄ãxt
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

62 
	`∑ckë__˛ónup
(&
c⁄ãxt
->
ö_∑ckë
);

63 
c⁄ãxt
->
out_∑ckë
 = 
NULL
;

64 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

66 
c⁄ãxt
->
addªss
 = 
NULL
;

67 if(()
sock
 >= 0){

68 if(!
	`√t__sockë_gë_addªss
(
sock
, 
addªss
, 1024)){

69 
c⁄ãxt
->
addªss
 = 
	`mosquôto__°rdup
(address);

71 if(!
c⁄ãxt
->
addªss
){

73 
	`mosquôto__‰ì
(
c⁄ãxt
);

74  
NULL
;

77 
c⁄ãxt
->
bridge
 = 
NULL
;

78 
c⁄ãxt
->
msgs_ö
.
öÊight_maximum
 = 
db
->
c⁄fig
->
max_öÊight_mesßges
;

79 
c⁄ãxt
->
msgs_out
.
öÊight_maximum
 = 
db
->
c⁄fig
->
max_öÊight_mesßges
;

80 
c⁄ãxt
->
msgs_ö
.
öÊight_quŸa
 = 
db
->
c⁄fig
->
max_öÊight_mesßges
;

81 
c⁄ãxt
->
msgs_out
.
öÊight_quŸa
 = 
db
->
c⁄fig
->
max_öÊight_mesßges
;

82 
c⁄ãxt
->
maximum_qos
 = 2;

83 #ifde‡
WITH_TLS


84 
c⁄ãxt
->
s¶
 = 
NULL
;

87 if(()
c⁄ãxt
->
sock
 >= 0){

88 
	`HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
c⁄ãxt
->sock), context);

90  
c⁄ãxt
;

91 
	}
}

99 
	$c⁄ãxt__˛ónup
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
do_‰ì
)

101 
mosquôto__∑ckë
 *
∑ckë
;

102 #ifde‡
WITH_BRIDGE


103 
i
;

106 if(!
c⁄ãxt
) ;

108 #ifde‡
WITH_BRIDGE


109 if(
c⁄ãxt
->
bridge
){

110 
i
=0; i<
db
->
bridge_cou¡
; i++){

111 if(
db
->
bridges
[
i
] =
c⁄ãxt
){

112 
db
->
bridges
[
i
] = 
NULL
;

115 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
);

116 
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
 = 
NULL
;

118 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
);

119 
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
 = 
NULL
;

121 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
loˇl_∑ssw‹d
);

122 
c⁄ãxt
->
bridge
->
loˇl_∑ssw‹d
 = 
NULL
;

124 if(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
 !c⁄ãxt->
id
){

125 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

127 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
 = 
NULL
;

129 if(
c⁄ãxt
->
bridge
->
ªmŸe_u£∫ame
 !c⁄ãxt->
u£∫ame
){

130 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
ªmŸe_u£∫ame
);

132 
c⁄ãxt
->
bridge
->
ªmŸe_u£∫ame
 = 
NULL
;

134 if(
c⁄ãxt
->
bridge
->
ªmŸe_∑ssw‹d
 !c⁄ãxt->
∑ssw‹d
){

135 
	`mosquôto__‰ì
(
c⁄ãxt
->
bridge
->
ªmŸe_∑ssw‹d
);

137 
c⁄ãxt
->
bridge
->
ªmŸe_∑ssw‹d
 = 
NULL
;

141 
	`Æüs__‰ì_Æl
(
c⁄ãxt
);

143 
	`mosquôto__‰ì
(
c⁄ãxt
->
auth_mëhod
);

144 
c⁄ãxt
->
auth_mëhod
 = 
NULL
;

146 
	`mosquôto__‰ì
(
c⁄ãxt
->
u£∫ame
);

147 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

149 
	`mosquôto__‰ì
(
c⁄ãxt
->
∑ssw‹d
);

150 
c⁄ãxt
->
∑ssw‹d
 = 
NULL
;

152 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

153 if(
do_‰ì
 || 
c⁄ãxt
->
˛ón_°¨t
){

154 
	`sub__˛ón_£ssi⁄
(
db
, 
c⁄ãxt
);

155 
	`db__mesßges_dñëe
(
db
, 
c⁄ãxt
);

158 
	`mosquôto__‰ì
(
c⁄ãxt
->
addªss
);

159 
c⁄ãxt
->
addªss
 = 
NULL
;

161 
	`c⁄ãxt__£nd_wûl
(
db
, 
c⁄ãxt
);

163 if(
c⁄ãxt
->
id
){

164 
	`c⁄ãxt__ªmove_‰om_by_id
(
db
, 
c⁄ãxt
);

165 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

166 
c⁄ãxt
->
id
 = 
NULL
;

168 
	`∑ckë__˛ónup
(&(
c⁄ãxt
->
ö_∑ckë
));

169 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

170 
	`∑ckë__˛ónup
(
c⁄ãxt
->
cuºít_out_∑ckë
);

171 
	`mosquôto__‰ì
(
c⁄ãxt
->
cuºít_out_∑ckë
);

172 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

174 
c⁄ãxt
->
out_∑ckë
){

175 
	`∑ckë__˛ónup
(
c⁄ãxt
->
out_∑ckë
);

176 
∑ckë
 = 
c⁄ãxt
->
out_∑ckë
;

177 
c⁄ãxt
->
out_∑ckë
 = c⁄ãxt->out_∑ckë->
√xt
;

178 
	`mosquôto__‰ì
(
∑ckë
);

180 if(
do_‰ì
 || 
c⁄ãxt
->
˛ón_°¨t
){

181 
	`db__mesßges_dñëe
(
db
, 
c⁄ãxt
);

183 #i‡
	`deföed
(
WITH_BROKER
Ë&& deföed(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

184 if(
c⁄ãxt
->
adns
){

185 
	`gai_ˇn˚l
(
c⁄ãxt
->
adns
);

186 
	`mosquôto__‰ì
((
addröfo
 *)
c⁄ãxt
->
adns
->
¨_ªque°
);

187 
	`mosquôto__‰ì
(
c⁄ãxt
->
adns
);

190 if(
do_‰ì
){

191 
	`mosquôto__‰ì
(
c⁄ãxt
);

193 
	}
}

196 
	$c⁄ãxt__£nd_wûl
(
mosquôto_db
 *
db
, 
mosquôto
 *
˘xt
)

198 if(
˘xt
->
°©e
 !
mosq_cs_disc⁄√˘ög
 && ctxt->
wûl
){

199 if(
˘xt
->
wûl_dñay_öãrvÆ
 > 0){

200 
	`wûl_dñay__add
(
˘xt
);

204 if(
	`mosquôto_a˛_check
(
db
, 
˘xt
,

205 
˘xt
->
wûl
->
msg
.
t›ic
,

206 
˘xt
->
wûl
->
msg
.
∑ylﬂdÀn
,

207 
˘xt
->
wûl
->
msg
.
∑ylﬂd
,

208 
˘xt
->
wûl
->
msg
.
qos
,

209 
˘xt
->
wûl
->
msg
.
ªèö
,

210 
MOSQ_ACL_WRITE
Ë=
MOSQ_ERR_SUCCESS
){

213 
	`db__mesßges_ósy_queue
(
db
, 
˘xt
,

214 
˘xt
->
wûl
->
msg
.
t›ic
,

215 
˘xt
->
wûl
->
msg
.
qos
,

216 
˘xt
->
wûl
->
msg
.
∑ylﬂdÀn
,

217 
˘xt
->
wûl
->
msg
.
∑ylﬂd
,

218 
˘xt
->
wûl
->
msg
.
ªèö
,

219 
˘xt
->
wûl
->
expúy_öãrvÆ
,

220 &
˘xt
->
wûl
->
¥›îtõs
);

223 
	`wûl__˛ór
(
˘xt
);

224 
	}
}

227 
	$c⁄ãxt__disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

229 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

231 
	`c⁄ãxt__£nd_wûl
(
db
, 
c⁄ãxt
);

232 if(
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 == 0){

234 #ifde‡
WITH_BRIDGE


235 if(!
c⁄ãxt
->
bridge
)

239 if(
c⁄ãxt
->
wûl_dñay_öãrvÆ
 == 0){

241 
	`c⁄ãxt__add_to_disu£d
(
db
, 
c⁄ãxt
);

245 
	`£ssi⁄_expúy__add
(
db
, 
c⁄ãxt
);

247 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ed
);

248 
	}
}

250 
	$c⁄ãxt__add_to_disu£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

252 if(
c⁄ãxt
->
°©e
 =
mosq_cs_disu£d
) ;

254 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disu£d
);

256 if(
c⁄ãxt
->
id
){

257 
	`c⁄ãxt__ªmove_‰om_by_id
(
db
, 
c⁄ãxt
);

258 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

259 
c⁄ãxt
->
id
 = 
NULL
;

262 if(
db
->
Œ_f‹_‰ì
){

263 
c⁄ãxt
->
f‹_‰ì_√xt
 = 
db
->
Œ_f‹_‰ì
;

264 
db
->
Œ_f‹_‰ì
 = 
c⁄ãxt
;

266 
db
->
Œ_f‹_‰ì
 = 
c⁄ãxt
;

268 
	}
}

270 
	$c⁄ãxt__‰ì_disu£d
(
mosquôto_db
 *
db
)

272 
mosquôto
 *
c⁄ãxt
, *
√xt
;

273 #ifde‡
WITH_WEBSOCKETS


274 
mosquôto
 *
œ°
 = 
NULL
;

276 
	`as£π
(
db
);

278 
c⁄ãxt
 = 
db
->
Œ_f‹_‰ì
;

279 
c⁄ãxt
){

280 #ifde‡
WITH_WEBSOCKETS


281 if(
c⁄ãxt
->
wsi
){

283 if(
œ°
){

284 
œ°
->
f‹_‰ì_√xt
 = 
c⁄ãxt
;

286 
db
->
Œ_f‹_‰ì
 = 
c⁄ãxt
;

288 
√xt
 = 
c⁄ãxt
->
f‹_‰ì_√xt
;

289 
c⁄ãxt
->
f‹_‰ì_√xt
 = 
NULL
;

290 
œ°
 = 
c⁄ãxt
;

291 
c⁄ãxt
 = 
√xt
;

295 
√xt
 = 
c⁄ãxt
->
f‹_‰ì_√xt
;

296 
	`c⁄ãxt__˛ónup
(
db
, 
c⁄ãxt
, 
åue
);

297 
c⁄ãxt
 = 
√xt
;

300 
db
->
Œ_f‹_‰ì
 = 
NULL
;

301 
	}
}

304 
	$c⁄ãxt__ªmove_‰om_by_id
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

306 if(
c⁄ãxt
->
ªmoved_‰om_by_id
 =
Ál£
 && c⁄ãxt->
id
){

307 
	`HASH_DELETE
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
);

308 
c⁄ãxt
->
ªmoved_‰om_by_id
 = 
åue
;

310 
	}
}

	@src/database.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<uéi°.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"£nd_mosq.h
"

26 
	~"sys_åì.h
"

27 
	~"time_mosq.h
"

28 
	~"utû_mosq.h
"

30 
	gmax_öÊight_byãs
 = 0;

31 
	gmax_queued
 = 100;

32 
	gmax_queued_byãs
 = 0;

40 
boﬁ
 
	$db__ªady_f‹_Êight
(
mosquôto_msg_d©a
 *
msgs
, 
qos
)

42 
boﬁ
 
vÆid_byãs
;

43 
boﬁ
 
vÆid_cou¡
;

45 if(
qos
 =0 || (
msgs
->
öÊight_maximum
 =0 && 
max_öÊight_byãs
 == 0)){

46  
åue
;

49 
vÆid_byãs
 = 
msgs
->
msg_byãs12
 < 
max_öÊight_byãs
;

50 
vÆid_cou¡
 = 
msgs
->
öÊight_quŸa
 > 0;

52 if(
msgs
->
öÊight_maximum
 == 0){

53  
vÆid_byãs
;

55 if(
max_öÊight_byãs
 == 0){

56  
vÆid_cou¡
;

59  
vÆid_byãs
 && 
vÆid_cou¡
;

60 
	}
}

71 
boﬁ
 
	$db__ªady_f‹_queue
(
mosquôto
 *
c⁄ãxt
, 
qos
, 
mosquôto_msg_d©a
 *
msg_d©a
)

73 
sour˚_cou¡
;

74 
adju°_cou¡
;

75 
sour˚_byãs
;

76 
adju°_byãs
 = 
max_öÊight_byãs
;

78 if(
max_queued
 =0 && 
max_queued_byãs
 == 0){

79  
åue
;

82 if(
qos
 == 0){

83 
sour˚_byãs
 = 
msg_d©a
->
msg_byãs
;

84 
sour˚_cou¡
 = 
msg_d©a
->
msg_cou¡
;

86 
sour˚_byãs
 = 
msg_d©a
->
msg_byãs12
;

87 
sour˚_cou¡
 = 
msg_d©a
->
msg_cou¡12
;

89 
adju°_cou¡
 = 
msg_d©a
->
öÊight_maximum
;

92 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

93 
adju°_byãs
 = 0;

94 
adju°_cou¡
 = 0;

97 
boﬁ
 
vÆid_byãs
 = 
sour˚_byãs
 - 
adju°_byãs
 < 
max_queued_byãs
;

98 
boﬁ
 
vÆid_cou¡
 = 
sour˚_cou¡
 - 
adju°_cou¡
 < 
max_queued
;

100 if(
max_queued_byãs
 == 0){

101  
vÆid_cou¡
;

103 if(
max_queued
 == 0){

104  
vÆid_byãs
;

107  
vÆid_byãs
 && 
vÆid_cou¡
;

108 
	}
}

111 
	$db__›í
(
mosquôto__c⁄fig
 *
c⁄fig
, 
mosquôto_db
 *
db
)

113 
mosquôto__subhõr
 *
subhõr
;

115 if(!
c⁄fig
 || !
db
Ë 
MOSQ_ERR_INVAL
;

117 
db
->
œ°_db_id
 = 0;

119 
db
->
c⁄ãxts_by_id
 = 
NULL
;

120 
db
->
c⁄ãxts_by_sock
 = 
NULL
;

121 
db
->
c⁄ãxts_f‹_‰ì
 = 
NULL
;

122 #ifde‡
WITH_BRIDGE


123 
db
->
bridges
 = 
NULL
;

124 
db
->
bridge_cou¡
 = 0;

128 
db
->
˛õ¡id_ödex_hash
 = 
NULL
;

130 
db
->
subs
 = 
NULL
;

132 
subhõr
 = 
	`sub__add_hõr_íåy
(
NULL
, &
db
->
subs
, "", 
	`°æí
(""));

133 if(!
subhõr
Ë 
MOSQ_ERR_NOMEM
;

135 
subhõr
 = 
	`sub__add_hõr_íåy
(
NULL
, &
db
->
subs
, "$SYS", 
	`°æí
("$SYS"));

136 if(!
subhõr
Ë 
MOSQ_ERR_NOMEM
;

138 
db
->
u≈wd
 = 
NULL
;

140 #ifde‡
WITH_PERSISTENCE


141 if(
	`≥rsi°__ª°‹e
(
db
))  1;

144  
MOSQ_ERR_SUCCESS
;

145 
	}
}

147 
	$subhõr_˛ón
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 **
subhõr
)

149 
mosquôto__subhõr
 *
≥î
, *
subhõr_tmp
;

150 
mosquôto__subÀaf
 *
Àaf
, *
√xéóf
;

152 
	`HASH_ITER
(
hh
, *
subhõr
, 
≥î
, 
subhõr_tmp
){

153 
Àaf
 = 
≥î
->
subs
;

154 
Àaf
){

155 
√xéóf
 = 
Àaf
->
√xt
;

156 
	`mosquôto__‰ì
(
Àaf
);

157 
Àaf
 = 
√xéóf
;

159 if(
≥î
->
ªèöed
){

160 
	`db__msg_°‹e_ªf_dec
(
db
, &
≥î
->
ªèöed
);

162 
	`subhõr_˛ón
(
db
, &
≥î
->
chûdªn
);

163 
	`mosquôto__‰ì
(
≥î
->
t›ic
);

165 
	`HASH_DELETE
(
hh
, *
subhõr
, 
≥î
);

166 
	`mosquôto__‰ì
(
≥î
);

168 
	}
}

170 
	$db__˛o£
(
mosquôto_db
 *
db
)

172 
	`subhõr_˛ón
(
db
, &db->
subs
);

173 
	`db__msg_°‹e_˛ón
(
db
);

175  
MOSQ_ERR_SUCCESS
;

176 
	}
}

179 
	$db__msg_°‹e_add
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
)

181 
°‹e
->
√xt
 = 
db
->
msg_°‹e
;

182 
°‹e
->
¥ev
 = 
NULL
;

183 if(
db
->
msg_°‹e
){

184 
db
->
msg_°‹e
->
¥ev
 = 
°‹e
;

186 
db
->
msg_°‹e
 = 
°‹e
;

187 
	}
}

190 
	$db__msg_°‹e_ªmove
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
)

192 
i
;

194 if(
°‹e
->
¥ev
){

195 
°‹e
->
¥ev
->
√xt
 = store->next;

196 if(
°‹e
->
√xt
){

197 
°‹e
->
√xt
->
¥ev
 = store->prev;

200 
db
->
msg_°‹e
 = 
°‹e
->
√xt
;

201 if(
°‹e
->
√xt
){

202 
°‹e
->
√xt
->
¥ev
 = 
NULL
;

205 
db
->
msg_°‹e_cou¡
--;

206 
db
->
msg_°‹e_byãs
 -
°‹e
->
∑ylﬂdÀn
;

208 
	`mosquôto__‰ì
(
°‹e
->
sour˚_id
);

209 
	`mosquôto__‰ì
(
°‹e
->
sour˚_u£∫ame
);

210 if(
°‹e
->
de°_ids
){

211 
i
=0; i<
°‹e
->
de°_id_cou¡
; i++){

212 
	`mosquôto__‰ì
(
°‹e
->
de°_ids
[
i
]);

214 
	`mosquôto__‰ì
(
°‹e
->
de°_ids
);

216 
	`mosquôto__‰ì
(
°‹e
->
t›ic
);

217 
	`mosquôto_¥›îty_‰ì_Æl
(&
°‹e
->
¥›îtõs
);

218 
	`UHPA_FREE_PAYLOAD
(
°‹e
);

219 
	`mosquôto__‰ì
(
°‹e
);

220 
	}
}

223 
	$db__msg_°‹e_˛ón
(
mosquôto_db
 *
db
)

225 
mosquôto_msg_°‹e
 *
°‹e
, *
√xt
;;

227 
°‹e
 = 
db
->
msg_°‹e
;

228 
°‹e
){

229 
√xt
 = 
°‹e
->next;

230 
	`db__msg_°‹e_ªmove
(
db
, 
°‹e
);

231 
°‹e
 = 
√xt
;

233 
	}
}

235 
	$db__msg_°‹e_ªf_öc
(
mosquôto_msg_°‹e
 *
°‹e
)

237 
°‹e
->
ªf_cou¡
++;

238 
	}
}

240 
	$db__msg_°‹e_ªf_dec
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 **
°‹e
)

242 (*
°‹e
)->
ªf_cou¡
--;

243 if((*
°‹e
)->
ªf_cou¡
 == 0){

244 
	`db__msg_°‹e_ªmove
(
db
, *
°‹e
);

245 *
°‹e
 = 
NULL
;

247 
	}
}

250 
	$db__msg_°‹e_com∑˘
(
mosquôto_db
 *
db
)

252 
mosquôto_msg_°‹e
 *
°‹e
, *
√xt
;

254 
°‹e
 = 
db
->
msg_°‹e
;

255 
°‹e
){

256 
√xt
 = 
°‹e
->next;

257 if(
°‹e
->
ªf_cou¡
 < 1){

258 
	`db__msg_°‹e_ªmove
(
db
, 
°‹e
);

260 
°‹e
 = 
√xt
;

262 
	}
}

265 
	$db__mesßge_ªmove
(
mosquôto_db
 *
db
, 
mosquôto_msg_d©a
 *
msg_d©a
, 
mosquôto_˛õ¡_msg
 *
ôem
)

267 if(!
msg_d©a
 || !
ôem
){

271 
	`DL_DELETE
(
msg_d©a
->
öÊight
, 
ôem
);

272 if(
ôem
->
°‹e
){

273 
msg_d©a
->
msg_cou¡
--;

274 
msg_d©a
->
msg_byãs
 -
ôem
->
°‹e
->
∑ylﬂdÀn
;

275 if(
ôem
->
qos
 > 0){

276 
msg_d©a
->
msg_cou¡12
--;

277 
msg_d©a
->
msg_byãs12
 -
ôem
->
°‹e
->
∑ylﬂdÀn
;

279 
	`db__msg_°‹e_ªf_dec
(
db
, &
ôem
->
°‹e
);

282 
	`mosquôto_¥›îty_‰ì_Æl
(&
ôem
->
¥›îtõs
);

283 
	`mosquôto__‰ì
(
ôem
);

284 
	}
}

287 
	$db__mesßge_dequeue_fú°
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_msg_d©a
 *
msg_d©a
)

289 
mosquôto_˛õ¡_msg
 *
msg
;

291 
msg
 = 
msg_d©a
->
queued
;

292 
	`DL_DELETE
(
msg_d©a
->
queued
, 
msg
);

293 
	`DL_APPEND
(
msg_d©a
->
öÊight
, 
msg
);

294 if(
msg_d©a
->
öÊight_quŸa
 > 0){

295 
msg_d©a
->
öÊight_quŸa
--;

297 
	}
}

300 
	$db__mesßge_dñëe_outgoög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
ex≥˘_°©e
, 
qos
)

302 
mosquôto_˛õ¡_msg
 *
èû
, *
tmp
;

303 
msg_ödex
 = 0;

305 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

307 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
öÊight
, 
èû
, 
tmp
){

308 
msg_ödex
++;

309 if(
èû
->
mid
 == mid){

310 if(
èû
->
qos
 != qos){

311  
MOSQ_ERR_PROTOCOL
;

312 }if(
qos
 =2 && 
èû
->
°©e
 !
ex≥˘_°©e
){

313  
MOSQ_ERR_PROTOCOL
;

315 
msg_ödex
--;

316 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_out
, 
èû
);

320 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
queued
, 
èû
, 
tmp
){

321 if(
c⁄ãxt
->
msgs_out
.
öÊight_maximum
 !0 && 
msg_ödex
 >= context->msgs_out.inflight_maximum){

325 
msg_ödex
++;

326 
èû
->
time°amp
 = 
	`mosquôto_time
();

327 
èû
->
qos
){

329 
èû
->
°©e
 = 
mosq_ms_publish_qos0
;

332 
èû
->
°©e
 = 
mosq_ms_publish_qos1
;

335 
èû
->
°©e
 = 
mosq_ms_publish_qos2
;

338 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_out
);

341  
MOSQ_ERR_SUCCESS
;

342 
	}
}

344 
	$db__mesßge_ö£π
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
mosquôto_¥›îty
 *
¥›îtõs
)

346 
mosquôto_˛õ¡_msg
 *
msg
;

347 
mosquôto_msg_d©a
 *
msg_d©a
;

348 
mosquôto_msg_°©e
 
°©e
 = 
mosq_ms_övÆid
;

349 
rc
 = 0;

350 
i
;

351 **
de°_ids
;

353 
	`as£π
(
°‹ed
);

354 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

355 if(!
c⁄ãxt
->
id
Ë 
MOSQ_ERR_SUCCESS
;

357 if(
dú
 =
mosq_md_out
){

358 
msg_d©a
 = &
c⁄ãxt
->
msgs_out
;

360 
msg_d©a
 = &
c⁄ãxt
->
msgs_ö
;

370 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ5


371 && 
db
->
c⁄fig
->
Ælow_du∂iˇã_mesßges
 =
Ál£


372 && 
dú
 =
mosq_md_out
 && 
ªèö
 =
Ál£
 && 
°‹ed
->
de°_ids
){

374 
i
=0; i<
°‹ed
->
de°_id_cou¡
; i++){

375 if(!
	`°rcmp
(
°‹ed
->
de°_ids
[
i
], 
c⁄ãxt
->
id
)){

377 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

378  
MOSQ_ERR_SUCCESS
;

382 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

384 if(
qos
 =0 && !
db
->
c⁄fig
->
queue_qos0_mesßges
){

385 if(!
c⁄ãxt
->
bridge
){

386 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

389 if(
c⁄ãxt
->
bridge
->
°¨t_ty≥
 !
b°_œzy
){

390 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

397 if(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
){

398 if(
	`db__ªady_f‹_Êight
(
msg_d©a
, 
qos
)){

399 if(
dú
 =
mosq_md_out
){

400 
qos
){

402 
°©e
 = 
mosq_ms_publish_qos0
;

405 
°©e
 = 
mosq_ms_publish_qos1
;

408 
°©e
 = 
mosq_ms_publish_qos2
;

412 if(
qos
 == 2){

413 
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

415 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

419 }if(
	`db__ªady_f‹_queue
(
c⁄ãxt
, 
qos
, 
msg_d©a
)){

420 
°©e
 = 
mosq_ms_queued
;

421 
rc
 = 2;

424 if(
c⁄ãxt
->
is_dr›pög
 =
Ál£
){

425 
c⁄ãxt
->
is_dr›pög
 = 
åue
;

426 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

428 
c⁄ãxt
->
id
);

430 
	`G_MSGS_DROPPED_INC
();

431 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

435 i‡(
	`db__ªady_f‹_queue
(
c⁄ãxt
, 
qos
, 
msg_d©a
)){

436 
°©e
 = 
mosq_ms_queued
;

438 
	`G_MSGS_DROPPED_INC
();

439 if(
c⁄ãxt
->
is_dr›pög
 =
Ál£
){

440 
c⁄ãxt
->
is_dr›pög
 = 
åue
;

441 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

443 
c⁄ãxt
->
id
);

445 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

449 
	`as£π
(
°©e
 !
mosq_ms_övÆid
);

451 #ifde‡
WITH_PERSISTENCE


452 if(
°©e
 =
mosq_ms_queued
){

453 
db
->
≥rsi°í˚_ch™ges
++;

457 
msg
 = 
	`mosquôto__mÆloc
((
mosquôto_˛õ¡_msg
));

458 if(!
msg
Ë 
MOSQ_ERR_NOMEM
;

459 
msg
->
¥ev
 = 
NULL
;

460 
msg
->
√xt
 = 
NULL
;

461 
msg
->
°‹e
 = 
°‹ed
;

462 
	`db__msg_°‹e_ªf_öc
(
msg
->
°‹e
);

463 
msg
->
mid
 = mid;

464 
msg
->
time°amp
 = 
	`mosquôto_time
();

465 
msg
->
dúe˘i⁄
 = 
dú
;

466 
msg
->
°©e
 = state;

467 
msg
->
dup
 = 
Ál£
;

468 if(
qos
 > 
c⁄ãxt
->
maximum_qos
){

469 
msg
->
qos
 = 
c⁄ãxt
->
maximum_qos
;

471 
msg
->
qos
 = qos;

473 
msg
->
ªèö
 =Ñetain;

474 
msg
->
¥›îtõs
 =Öroperties;

476 if(
°©e
 =
mosq_ms_queued
){

477 
	`DL_APPEND
(
msg_d©a
->
queued
, 
msg
);

479 
	`DL_APPEND
(
msg_d©a
->
öÊight
, 
msg
);

481 
msg_d©a
->
msg_cou¡
++;

482 
msg_d©a
->
msg_byãs
+
msg
->
°‹e
->
∑ylﬂdÀn
;

483 if(
qos
 > 0){

484 
msg_d©a
->
msg_cou¡12
++;

485 
msg_d©a
->
msg_byãs12
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

488 if(
db
->
c⁄fig
->
Ælow_du∂iˇã_mesßges
 =
Ál£
 && 
dú
 =
mosq_md_out
 && 
ªèö
 == false){

496 
de°_ids
 = 
	`mosquôto__ªÆloc
(
°‹ed
->de°_ids, (*)*(°‹ed->
de°_id_cou¡
+1));

497 if(
de°_ids
){

498 
°‹ed
->
de°_ids
 = dest_ids;

499 
°‹ed
->
de°_id_cou¡
++;

500 
°‹ed
->
de°_ids
[°‹ed->
de°_id_cou¡
-1] = 
	`mosquôto__°rdup
(
c⁄ãxt
->
id
);

501 if(!
°‹ed
->
de°_ids
[°‹ed->
de°_id_cou¡
-1]){

502  
MOSQ_ERR_NOMEM
;

505  
MOSQ_ERR_NOMEM
;

508 #ifde‡
WITH_BRIDGE


509 if(
c⁄ãxt
->
bridge
 && c⁄ãxt->bridge->
°¨t_ty≥
 =
b°_œzy


510 && 
c⁄ãxt
->
sock
 =
INVALID_SOCKET


511 && 
c⁄ãxt
->
msgs_out
.
msg_cou¡
 >c⁄ãxt->
bridge
->
thªshﬁd
){

513 
c⁄ãxt
->
bridge
->
œzy_ªc⁄√˘
 = 
åue
;

517 if(
dú
 =
mosq_md_out
 && 
msg
->
qos
 > 0){

518 
	`utû__de¸emít_£nd_quŸa
(
c⁄ãxt
);

520 #ifde‡
WITH_WEBSOCKETS


521 if(
c⁄ãxt
->
wsi
 && 
rc
 == 0){

522  
	`db__mesßge_wrôe
(
db
, 
c⁄ãxt
);

524  
rc
;

527  
rc
;

529 
	}
}

531 
	$db__mesßge_upd©e_outgoög
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
°©e
, 
qos
)

533 
mosquôto_˛õ¡_msg
 *
èû
;

535 
	`DL_FOREACH
(
c⁄ãxt
->
msgs_out
.
öÊight
, 
èû
){

536 if(
èû
->
mid
 == mid){

537 if(
èû
->
qos
 != qos){

538  
MOSQ_ERR_PROTOCOL
;

540 
èû
->
°©e
 = state;

541 
èû
->
time°amp
 = 
	`mosquôto_time
();

542  
MOSQ_ERR_SUCCESS
;

545  
MOSQ_ERR_NOT_FOUND
;

546 
	}
}

549 
	$db__mesßges_dñëe_li°
(
mosquôto_db
 *
db
, 
mosquôto_˛õ¡_msg
 **
hód
)

551 
mosquôto_˛õ¡_msg
 *
èû
, *
tmp
;

553 
	`DL_FOREACH_SAFE
(*
hód
, 
èû
, 
tmp
){

554 
	`DL_DELETE
(*
hód
, 
èû
);

555 
	`db__msg_°‹e_ªf_dec
(
db
, &
èû
->
°‹e
);

556 
	`mosquôto_¥›îty_‰ì_Æl
(&
èû
->
¥›îtõs
);

557 
	`mosquôto__‰ì
(
èû
);

559 *
hód
 = 
NULL
;

560 
	}
}

563 
	$db__mesßges_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

565 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

567 
	`db__mesßges_dñëe_li°
(
db
, &
c⁄ãxt
->
msgs_ö
.
öÊight
);

568 
	`db__mesßges_dñëe_li°
(
db
, &
c⁄ãxt
->
msgs_ö
.
queued
);

569 
	`db__mesßges_dñëe_li°
(
db
, &
c⁄ãxt
->
msgs_out
.
öÊight
);

570 
	`db__mesßges_dñëe_li°
(
db
, &
c⁄ãxt
->
msgs_out
.
queued
);

572 
c⁄ãxt
->
msgs_ö
.
msg_byãs
 = 0;

573 
c⁄ãxt
->
msgs_ö
.
msg_byãs12
 = 0;

574 
c⁄ãxt
->
msgs_ö
.
msg_cou¡
 = 0;

575 
c⁄ãxt
->
msgs_ö
.
msg_cou¡12
 = 0;

577 
c⁄ãxt
->
msgs_out
.
msg_byãs
 = 0;

578 
c⁄ãxt
->
msgs_out
.
msg_byãs12
 = 0;

579 
c⁄ãxt
->
msgs_out
.
msg_cou¡
 = 0;

580 
c⁄ãxt
->
msgs_out
.
msg_cou¡12
 = 0;

582  
MOSQ_ERR_SUCCESS
;

583 
	}
}

585 
	$db__mesßges_ósy_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
, uöt32_à
mesßge_expúy_öãrvÆ
, 
mosquôto_¥›îty
 **
¥›îtõs
)

587 
mosquôto_msg_°‹e
 *
°‹ed
;

588 *
sour˚_id
;

589 *
t›ic_hóp
;

590 
mosquôto__∑ylﬂd_uh∑
 
∑ylﬂd_uh∑
;

591 
mosquôto_¥›îty
 *
loˇl_¥›îtõs
 = 
NULL
;

592 
mosquôto_msg_‹igö
 
‹igö
;

594 
	`as£π
(
db
);

596 
∑ylﬂd_uh∑
.
±r
 = 
NULL
;

598 if(!
t›ic
Ë 
MOSQ_ERR_INVAL
;

599 
t›ic_hóp
 = 
	`mosquôto__°rdup
(
t›ic
);

600 if(!
t›ic_hóp
Ë 
MOSQ_ERR_INVAL
;

602 if(
db
->
c⁄fig
->
ªèö_avaûabÀ
 =
Ál£
){

603 
ªèö
 = 0;

606 if(
	`UHPA_ALLOC
(
∑ylﬂd_uh∑
, 
∑ylﬂdÀn
) == 0){

607 
	`mosquôto__‰ì
(
t›ic_hóp
);

608  
MOSQ_ERR_NOMEM
;

610 
	`mem˝y
(
	`UHPA_ACCESS
(
∑ylﬂd_uh∑
, 
∑ylﬂdÀn
), 
∑ylﬂd
,Öayloadlen);

612 if(
c⁄ãxt
 && c⁄ãxt->
id
){

613 
sour˚_id
 = 
c⁄ãxt
->
id
;

615 
sour˚_id
 = "";

617 if(
¥›îtõs
){

618 
loˇl_¥›îtõs
 = *
¥›îtõs
;

619 *
¥›îtõs
 = 
NULL
;

622 if(
c⁄ãxt
){

623 
‹igö
 = 
mosq_mo_˛õ¡
;

625 
‹igö
 = 
mosq_mo_brokî
;

627 if(
	`db__mesßge_°‹e
(
db
, 
c⁄ãxt
, 0, 
t›ic_hóp
, 
qos
, 
∑ylﬂdÀn
, &
∑ylﬂd_uh∑
, 
ªèö
, &
°‹ed
, 
mesßge_expúy_öãrvÆ
, 
loˇl_¥›îtõs
, 0, 
‹igö
))  1;

629  
	`sub__mesßges_queue
(
db
, 
sour˚_id
, 
t›ic_hóp
, 
qos
, 
ªèö
, &
°‹ed
);

630 
	}
}

633 
	$db__mesßge_°‹e
(
mosquôto_db
 *
db
, c⁄° 
mosquôto
 *
sour˚
, 
uöt16_t
 
sour˚_mid
, *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, 
mosquôto__∑ylﬂd_uh∑
 *
∑ylﬂd
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
, uöt32_à
mesßge_expúy_öãrvÆ
, 
mosquôto_¥›îty
 *
¥›îtõs
, 
dbid_t
 
°‹e_id
, 
mosquôto_msg_‹igö
 
‹igö
)

635 
mosquôto_msg_°‹e
 *
ãmp
 = 
NULL
;

636 
rc
 = 
MOSQ_ERR_SUCCESS
;

638 
	`as£π
(
db
);

639 
	`as£π
(
°‹ed
);

641 
ãmp
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_msg_°‹e
));

642 if(!
ãmp
){

643 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

644 
rc
 = 
MOSQ_ERR_NOMEM
;

645 
îr‹
;

648 
ãmp
->
t›ic
 = 
NULL
;

649 
ãmp
->
∑ylﬂd
.
±r
 = 
NULL
;

651 
ãmp
->
ªf_cou¡
 = 0;

652 if(
sour˚
 && sour˚->
id
){

653 
ãmp
->
sour˚_id
 = 
	`mosquôto__°rdup
(
sour˚
->
id
);

655 
ãmp
->
sour˚_id
 = 
	`mosquôto__°rdup
("");

657 if(!
ãmp
->
sour˚_id
){

658 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

659 
rc
 = 
MOSQ_ERR_NOMEM
;

660 
îr‹
;

663 if(
sour˚
 && sour˚->
u£∫ame
){

664 
ãmp
->
sour˚_u£∫ame
 = 
	`mosquôto__°rdup
(
sour˚
->
u£∫ame
);

665 if(!
ãmp
->
sour˚_u£∫ame
){

666 
rc
 = 
MOSQ_ERR_NOMEM
;

667 
îr‹
;

670 if(
sour˚
){

671 
ãmp
->
sour˚_li°íî
 = 
sour˚
->
li°íî
;

673 
ãmp
->
sour˚_mid
 = source_mid;

674 
ãmp
->
mid
 = 0;

675 
ãmp
->
qos
 = qos;

676 
ãmp
->
ªèö
 =Ñetain;

677 
ãmp
->
t›ic
 =Åopic;

678 
t›ic
 = 
NULL
;

679 
ãmp
->
∑ylﬂdÀn
 =Öayloadlen;

680 
ãmp
->
¥›îtõs
 =Öroperties;

681 
ãmp
->
‹igö
 = origin;

682 if(
∑ylﬂdÀn
){

683 
	`UHPA_MOVE
(
ãmp
->
∑ylﬂd
, *∑ylﬂd, 
∑ylﬂdÀn
);

685 
ãmp
->
∑ylﬂd
.
±r
 = 
NULL
;

687 if(
mesßge_expúy_öãrvÆ
 > 0){

688 
ãmp
->
mesßge_expúy_time
 = 
	`time
(
NULL
Ë+ 
mesßge_expúy_öãrvÆ
;

690 
ãmp
->
mesßge_expúy_time
 = 0;

693 
ãmp
->
de°_ids
 = 
NULL
;

694 
ãmp
->
de°_id_cou¡
 = 0;

695 
db
->
msg_°‹e_cou¡
++;

696 
db
->
msg_°‹e_byãs
 +
∑ylﬂdÀn
;

697 (*
°‹ed
Ë
ãmp
;

699 if(!
°‹e_id
){

700 
ãmp
->
db_id
 = ++
db
->
œ°_db_id
;

702 
ãmp
->
db_id
 = 
°‹e_id
;

705 
	`db__msg_°‹e_add
(
db
, 
ãmp
);

707  
MOSQ_ERR_SUCCESS
;

708 
îr‹
:

709 
	`mosquôto__‰ì
(
t›ic
);

710 if(
ãmp
){

711 
	`mosquôto__‰ì
(
ãmp
->
sour˚_id
);

712 
	`mosquôto__‰ì
(
ãmp
->
sour˚_u£∫ame
);

713 
	`mosquôto__‰ì
(
ãmp
->
t›ic
);

714 
	`mosquôto__‰ì
(
ãmp
);

716 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

717 
	`UHPA_FREE
(*
∑ylﬂd
, 
∑ylﬂdÀn
);

718  
rc
;

719 
	}
}

721 
	$db__mesßge_°‹e_föd
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°‹e
 **
°‹ed
)

723 
mosquôto_˛õ¡_msg
 *
èû
;

725 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

727 *
°‹ed
 = 
NULL
;

728 
	`DL_FOREACH
(
c⁄ãxt
->
msgs_ö
.
öÊight
, 
èû
){

729 if(
èû
->
°‹e
->
sour˚_mid
 =
mid
){

730 *
°‹ed
 = 
èû
->
°‹e
;

731  
MOSQ_ERR_SUCCESS
;

735 
	`DL_FOREACH
(
c⁄ãxt
->
msgs_ö
.
queued
, 
èû
){

736 if(
èû
->
°‹e
->
sour˚_mid
 =
mid
){

737 *
°‹ed
 = 
èû
->
°‹e
;

738  
MOSQ_ERR_SUCCESS
;

743 
	}
}

747 
	$db__mesßge_ªc⁄√˘_ª£t_outgoög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

749 
mosquôto_˛õ¡_msg
 *
msg
, *
tmp
;

751 
c⁄ãxt
->
msgs_out
.
msg_byãs
 = 0;

752 
c⁄ãxt
->
msgs_out
.
msg_byãs12
 = 0;

753 
c⁄ãxt
->
msgs_out
.
msg_cou¡
 = 0;

754 
c⁄ãxt
->
msgs_out
.
msg_cou¡12
 = 0;

755 
c⁄ãxt
->
msgs_out
.
öÊight_quŸa
 = c⁄ãxt->msgs_out.
öÊight_maximum
;

757 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
öÊight
, 
msg
, 
tmp
){

758 
c⁄ãxt
->
msgs_out
.
msg_cou¡
++;

759 
c⁄ãxt
->
msgs_out
.
msg_byãs
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

760 if(
msg
->
qos
 > 0){

761 
c⁄ãxt
->
msgs_out
.
msg_cou¡12
++;

762 
c⁄ãxt
->
msgs_out
.
msg_byãs12
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

763 
	`utû__de¸emít_ª˚ive_quŸa
(
c⁄ãxt
);

766 
msg
->
qos
){

768 
msg
->
°©e
 = 
mosq_ms_publish_qos0
;

771 
msg
->
°©e
 = 
mosq_ms_publish_qos1
;

774 if(
msg
->
°©e
 =
mosq_ms_waô_f‹_pubcomp
){

775 
msg
->
°©e
 = 
mosq_ms_ª£nd_pubªl
;

777 
msg
->
°©e
 = 
mosq_ms_publish_qos2
;

788 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
queued
, 
msg
, 
tmp
){

789 
c⁄ãxt
->
msgs_out
.
msg_cou¡
++;

790 
c⁄ãxt
->
msgs_out
.
msg_byãs
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

791 if(
msg
->
qos
 > 0){

792 
c⁄ãxt
->
msgs_out
.
msg_cou¡12
++;

793 
c⁄ãxt
->
msgs_out
.
msg_byãs12
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

795 if(
	`db__ªady_f‹_Êight
(&
c⁄ãxt
->
msgs_out
, 
msg
->
qos
)){

796 
msg
->
qos
){

798 
msg
->
°©e
 = 
mosq_ms_publish_qos0
;

801 
msg
->
°©e
 = 
mosq_ms_publish_qos1
;

804 
msg
->
°©e
 = 
mosq_ms_publish_qos2
;

807 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_out
);

811  
MOSQ_ERR_SUCCESS
;

812 
	}
}

816 
	$db__mesßge_ªc⁄√˘_ª£t_öcomög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

818 
mosquôto_˛õ¡_msg
 *
msg
, *
tmp
;

820 
c⁄ãxt
->
msgs_ö
.
msg_byãs
 = 0;

821 
c⁄ãxt
->
msgs_ö
.
msg_byãs12
 = 0;

822 
c⁄ãxt
->
msgs_ö
.
msg_cou¡
 = 0;

823 
c⁄ãxt
->
msgs_ö
.
msg_cou¡12
 = 0;

824 
c⁄ãxt
->
msgs_ö
.
öÊight_quŸa
 = c⁄ãxt->msgs_ö.
öÊight_maximum
;

826 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
öÊight
, 
msg
, 
tmp
){

827 
c⁄ãxt
->
msgs_ö
.
msg_cou¡
++;

828 
c⁄ãxt
->
msgs_ö
.
msg_byãs
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

829 if(
msg
->
qos
 > 0){

830 
c⁄ãxt
->
msgs_ö
.
msg_cou¡12
++;

831 
c⁄ãxt
->
msgs_ö
.
msg_byãs12
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

832 
	`utû__de¸emít_ª˚ive_quŸa
(
c⁄ãxt
);

835 if(
msg
->
qos
 != 2){

838 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_ö
, 
msg
);

851 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
queued
, 
msg
, 
tmp
){

852 
c⁄ãxt
->
msgs_ö
.
msg_cou¡
++;

853 
c⁄ãxt
->
msgs_ö
.
msg_byãs
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

854 if(
msg
->
qos
 > 0){

855 
c⁄ãxt
->
msgs_ö
.
msg_cou¡12
++;

856 
c⁄ãxt
->
msgs_ö
.
msg_byãs12
 +
msg
->
°‹e
->
∑ylﬂdÀn
;

858 if(
	`db__ªady_f‹_Êight
(&
c⁄ãxt
->
msgs_ö
, 
msg
->
qos
)){

859 
msg
->
qos
){

861 
msg
->
°©e
 = 
mosq_ms_publish_qos0
;

864 
msg
->
°©e
 = 
mosq_ms_publish_qos1
;

867 
msg
->
°©e
 = 
mosq_ms_publish_qos2
;

870 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_ö
);

874  
MOSQ_ERR_SUCCESS
;

875 
	}
}

878 
	$db__mesßge_ªc⁄√˘_ª£t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

880 
rc
;

882 
rc
 = 
	`db__mesßge_ªc⁄√˘_ª£t_outgoög
(
db
, 
c⁄ãxt
);

883 if(
rc
) Ñc;

884  
	`db__mesßge_ªc⁄√˘_ª£t_öcomög
(
db
, 
c⁄ãxt
);

885 
	}
}

888 
	$db__mesßge_ªÀa£_öcomög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
)

890 
mosquôto_˛õ¡_msg
 *
èû
, *
tmp
;

891 
ªèö
;

892 *
t›ic
;

893 *
sour˚_id
;

894 
msg_ödex
 = 0;

895 
boﬁ
 
dñëed
 = 
Ál£
;

896 
rc
;

898 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

900 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
öÊight
, 
èû
, 
tmp
){

901 
msg_ödex
++;

902 if(
èû
->
mid
 == mid){

903 if(
èû
->
°‹e
->
qos
 != 2){

904  
MOSQ_ERR_PROTOCOL
;

906 
t›ic
 = 
èû
->
°‹e
->topic;

907 
ªèö
 = 
èû
->retain;

908 
sour˚_id
 = 
èû
->
°‹e
->source_id;

914 if(!
t›ic
){

915 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_ö
, 
èû
);

916 
dñëed
 = 
åue
;

918 
rc
 = 
	`sub__mesßges_queue
(
db
, 
sour˚_id
, 
t›ic
, 2, 
ªèö
, &
èû
->
°‹e
);

919 if(
rc
 =
MOSQ_ERR_SUCCESS
 ||Ñ¯=
MOSQ_ERR_NO_SUBSCRIBERS
){

920 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_ö
, 
èû
);

921 
dñëed
 = 
åue
;

929 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
queued
, 
èû
, 
tmp
){

930 if(
c⁄ãxt
->
msgs_ö
.
öÊight_maximum
 !0 && 
msg_ödex
 >= context->msgs_in.inflight_maximum){

934 
msg_ödex
++;

935 
èû
->
time°amp
 = 
	`mosquôto_time
();

937 if(
èû
->
qos
 == 2){

938 
	`£nd__pubªc
(
c⁄ãxt
, 
èû
->
mid
, 0);

939 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

940 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_ö
);

943 if(
dñëed
){

944  
MOSQ_ERR_SUCCESS
;

946  
MOSQ_ERR_NOT_FOUND
;

948 
	}
}

950 
	$db__mesßge_wrôe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

952 
rc
;

953 
mosquôto_˛õ¡_msg
 *
èû
, *
tmp
;

954 
uöt16_t
 
mid
;

955 
ªåõs
;

956 
ªèö
;

957 c⁄° *
t›ic
;

958 
qos
;

959 
uöt32_t
 
∑ylﬂdÀn
;

960 c⁄° *
∑ylﬂd
;

961 
msg_cou¡
 = 0;

962 
mosquôto_¥›îty
 *
cmsg_¥›s
 = 
NULL
, *
°‹e_¥›s
 = NULL;

963 
time_t
 
now
 = 0;

964 
uöt32_t
 
expúy_öãrvÆ
;

966 if(!
c⁄ãxt
 || c⁄ãxt->
sock
 =
INVALID_SOCKET


967 || (
c⁄ãxt
->
°©e
 =
mosq_cs_a˘ive
 && !c⁄ãxt->
id
)){

968  
MOSQ_ERR_INVAL
;

971 if(
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
){

972  
MOSQ_ERR_SUCCESS
;

975 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
öÊight
, 
èû
, 
tmp
){

976 
msg_cou¡
++;

977 
expúy_öãrvÆ
 = 0;

978 if(
èû
->
°‹e
->
mesßge_expúy_time
){

979 if(
now
 == 0){

980 
now
 = 
	`time
(
NULL
);

982 if(
now
 > 
èû
->
°‹e
->
mesßge_expúy_time
){

984 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_ö
, 
èû
);

987 
expúy_öãrvÆ
 = 
èû
->
°‹e
->
mesßge_expúy_time
 - 
now
;

990 
mid
 = 
èû
->mid;

991 
ªåõs
 = 
èû
->
dup
;

992 
ªèö
 = 
èû
->retain;

993 
t›ic
 = 
èû
->
°‹e
->topic;

994 
qos
 = 
èû
->qos;

995 
∑ylﬂdÀn
 = 
èû
->
°‹e
->payloadlen;

996 
∑ylﬂd
 = 
	`UHPA_ACCESS_PAYLOAD
(
èû
->
°‹e
);

997 
cmsg_¥›s
 = 
èû
->
¥›îtõs
;

998 
°‹e_¥›s
 = 
èû
->
°‹e
->
¥›îtõs
;

1000 
èû
->
°©e
){

1001 
mosq_ms_£nd_pubªc
:

1002 
rc
 = 
	`£nd__pubªc
(
c⁄ãxt
, 
mid
, 0);

1003 if(!
rc
){

1004 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

1006  
rc
;

1010 
mosq_ms_ª£nd_pubcomp
:

1011 
rc
 = 
	`£nd__pubcomp
(
c⁄ãxt
, 
mid
);

1012 if(!
rc
){

1013 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

1015  
rc
;

1019 
mosq_ms_övÆid
:

1020 
mosq_ms_publish_qos0
:

1021 
mosq_ms_publish_qos1
:

1022 
mosq_ms_publish_qos2
:

1023 
mosq_ms_ª£nd_pubªl
:

1024 
mosq_ms_waô_f‹_puback
:

1025 
mosq_ms_waô_f‹_pubªc
:

1026 
mosq_ms_waô_f‹_pubªl
:

1027 
mosq_ms_waô_f‹_pubcomp
:

1028 
mosq_ms_queued
:

1033 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
öÊight
, 
èû
, 
tmp
){

1034 
msg_cou¡
++;

1035 
expúy_öãrvÆ
 = 0;

1036 if(
èû
->
°‹e
->
mesßge_expúy_time
){

1037 if(
now
 == 0){

1038 
now
 = 
	`time
(
NULL
);

1040 if(
now
 > 
èû
->
°‹e
->
mesßge_expúy_time
){

1042 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_out
, 
èû
);

1045 
expúy_öãrvÆ
 = 
èû
->
°‹e
->
mesßge_expúy_time
 - 
now
;

1048 
mid
 = 
èû
->mid;

1049 
ªåõs
 = 
èû
->
dup
;

1050 
ªèö
 = 
èû
->retain;

1051 
t›ic
 = 
èû
->
°‹e
->topic;

1052 
qos
 = 
èû
->qos;

1053 
∑ylﬂdÀn
 = 
èû
->
°‹e
->payloadlen;

1054 
∑ylﬂd
 = 
	`UHPA_ACCESS_PAYLOAD
(
èû
->
°‹e
);

1055 
cmsg_¥›s
 = 
èû
->
¥›îtõs
;

1056 
°‹e_¥›s
 = 
èû
->
°‹e
->
¥›îtõs
;

1058 
èû
->
°©e
){

1059 
mosq_ms_publish_qos0
:

1060 
rc
 = 
	`£nd__publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
, 
cmsg_¥›s
, 
°‹e_¥›s
, 
expúy_öãrvÆ
);

1061 if(
rc
 =
MOSQ_ERR_SUCCESS
 ||Ñ¯=
MOSQ_ERR_OVERSIZE_PACKET
){

1062 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_out
, 
èû
);

1064  
rc
;

1068 
mosq_ms_publish_qos1
:

1069 
rc
 = 
	`£nd__publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
, 
cmsg_¥›s
, 
°‹e_¥›s
, 
expúy_öãrvÆ
);

1070 if(
rc
 =
MOSQ_ERR_SUCCESS
){

1071 
èû
->
time°amp
 = 
	`mosquôto_time
();

1072 
èû
->
dup
 = 1;

1073 
èû
->
°©e
 = 
mosq_ms_waô_f‹_puback
;

1074 }if(
rc
 =
MOSQ_ERR_OVERSIZE_PACKET
){

1075 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_out
, 
èû
);

1077  
rc
;

1081 
mosq_ms_publish_qos2
:

1082 
rc
 = 
	`£nd__publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
, 
cmsg_¥›s
, 
°‹e_¥›s
, 
expúy_öãrvÆ
);

1083 if(
rc
 =
MOSQ_ERR_SUCCESS
){

1084 
èû
->
time°amp
 = 
	`mosquôto_time
();

1085 
èû
->
dup
 = 1;

1086 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªc
;

1087 }if(
rc
 =
MOSQ_ERR_OVERSIZE_PACKET
){

1088 
	`db__mesßge_ªmove
(
db
, &
c⁄ãxt
->
msgs_out
, 
èû
);

1090  
rc
;

1094 
mosq_ms_ª£nd_pubªl
:

1095 
rc
 = 
	`£nd__pubªl
(
c⁄ãxt
, 
mid
);

1096 if(!
rc
){

1097 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubcomp
;

1099  
rc
;

1103 
mosq_ms_övÆid
:

1104 
mosq_ms_£nd_pubªc
:

1105 
mosq_ms_ª£nd_pubcomp
:

1106 
mosq_ms_waô_f‹_puback
:

1107 
mosq_ms_waô_f‹_pubªc
:

1108 
mosq_ms_waô_f‹_pubªl
:

1109 
mosq_ms_waô_f‹_pubcomp
:

1110 
mosq_ms_queued
:

1115 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_ö
.
queued
, 
èû
, 
tmp
){

1116 if(
c⁄ãxt
->
msgs_out
.
öÊight_maximum
 !0 && c⁄ãxt->
msgs_ö
.
öÊight_quŸa
 == 0){

1120 
msg_cou¡
++;

1122 if(
èû
->
qos
 == 2){

1123 
èû
->
°©e
 = 
mosq_ms_£nd_pubªc
;

1124 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_ö
);

1125 
rc
 = 
	`£nd__pubªc
(
c⁄ãxt
, 
èû
->
mid
, 0);

1126 if(!
rc
){

1127 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

1129  
rc
;

1134 
	`DL_FOREACH_SAFE
(
c⁄ãxt
->
msgs_out
.
queued
, 
èû
, 
tmp
){

1135 if(
c⁄ãxt
->
msgs_out
.
öÊight_maximum
 !0 && c⁄ãxt->msgs_out.
öÊight_quŸa
 == 0){

1139 
msg_cou¡
++;

1141 
èû
->
qos
){

1143 
èû
->
°©e
 = 
mosq_ms_publish_qos0
;

1146 
èû
->
°©e
 = 
mosq_ms_publish_qos1
;

1149 
èû
->
°©e
 = 
mosq_ms_publish_qos2
;

1152 
	`db__mesßge_dequeue_fú°
(
c⁄ãxt
, &c⁄ãxt->
msgs_out
);

1155  
MOSQ_ERR_SUCCESS
;

1156 
	}
}

1158 
	$db__limôs_£t
(
öÊight_byãs
, 
queued
, 
queued_byãs
)

1160 
max_öÊight_byãs
 = 
öÊight_byãs
;

1161 
max_queued
 = 
queued
;

1162 
max_queued_byãs
 = 
queued_byãs
;

1163 
	}
}

	@src/db_dump/db_dump.c

17 
	~<¨∑/öë.h
>

18 
	~<as£π.h
>

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<öây≥s.h
>

22 
	~<°dio.h
>

23 
	~<°dlib.h
>

24 
	~<°rög.h
>

25 
	~<sys/°©.h
>

26 
	~<time.h
>

28 
	~<mosquôto_brokî_öã∫Æ.h
>

29 
	~<mem‹y_mosq.h
>

30 
	~<≥rsi°.h
>

32 
	#mosquôto__mÆloc
(
A
Ë
	`mÆloc
((A))

	)

33 
	#mosquôto__‰ì
(
A
Ë
	`‰ì
((A))

	)

34 
	#_mosquôto_mÆloc
(
A
Ë
	`mÆloc
((A))

	)

35 
	#_mosquôto_‰ì
(
A
Ë
	`‰ì
((A))

	)

36 
	~<uthash.h
>

38 c⁄° 
	gmagic
[15] = {0x00, 0xB5, 0x00, 'm','o','s','q','u','i','t','t','o',' ','d','b'};

40 
	s˛õ¡_chunk


42 
UT_hash_h™dÀ
 
	mhh_id
;

43 *
	mid
;

44 
	msubs¸ùti⁄s
;

45 
	msubs¸ùti⁄_size
;

46 
	mmesßges
;

47 
	mmesßge_size
;

50 
	smsg_°‹e_chunk


52 
UT_hash_h™dÀ
 
	mhh
;

53 
dbid_t
 
	m°‹e_id
;

54 
uöt32_t
 
	mÀngth
;

57 
	sdb_sub


59 *
	m˛õ¡_id
;

60 *
	mt›ic
;

61 
uöt8_t
 
	mqos
;

64 
	sdb_˛õ¡


66 *
	m˛õ¡_id
;

67 
uöt16_t
 
	mœ°_mid
;

68 
time_t
 
	mdisc⁄√˘_t
;

71 
	sdb_˛õ¡_msg


73 *
	m˛õ¡_id
;

74 
uöt8_t
 
	mqos
, 
	mªèö
, 
	mdúe˘i⁄
, 
	m°©e
, 
	mdup
;

75 
dbid_t
 
	m°‹e_id
;

76 
uöt16_t
 
	mmid
;

79 
	sdb_msg


81 
dbid_t
 
	m°‹e_id
;

82 
uöt32_t
 
	m∑ylﬂdÀn
;

83 
uöt16_t
 
	msour˚_mid
, 
	mmid
;

84 
uöt8_t
 
	mqos
, 
	mªèö
;

85 
uöt8_t
 *
	m∑ylﬂd
;

86 *
	msour˚_id
;

87 *
	msour˚_u£∫ame
;

88 *
	mt›ic
;

89 
uöt16_t
 
	msour˚_p‹t
;

92 
uöt32_t
 
	gdb_vîsi⁄
;

93 
	g°©s
 = 0;

94 
	g˛õ¡_°©s
 = 0;

95 
	gdo_¥öt
 = 1;

97 
˛õ¡_chunk
 *
	g˛õ¡s_by_id
 = 
NULL
;

98 
msg_°‹e_chunk
 *
	gmsgs_by_id
 = 
NULL
;

101 
	$‰ì__db_sub
(
db_sub
 *
sub
)

103 
	`‰ì
(
sub
->
˛õ¡_id
);

104 
	`‰ì
(
sub
->
t›ic
);

105 
	}
}

108 
	$‰ì__db_˛õ¡
(
db_˛õ¡
 *
˛õ¡
)

110 
	`‰ì
(
˛õ¡
->
˛õ¡_id
);

111 
	}
}

114 
	$‰ì__db_˛õ¡_msg
(
db_˛õ¡_msg
 *
msg
)

116 
	`‰ì
(
msg
->
˛õ¡_id
);

117 
	}
}

120 
	$‰ì__db_msg
(
db_msg
 *
msg
)

122 
	`‰ì
(
msg
->
sour˚_id
);

123 
	`‰ì
(
msg
->
t›ic
);

124 
	`‰ì
(
msg
->
∑ylﬂd
);

125 
	}
}

128 
	$¥öt_db_˛õ¡
(
db_˛õ¡
 *
˛õ¡
, 
Àngth
)

130 
	`¥ötf
("DB_CHUNK_CLIENT:\n");

131 
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

132 
	`¥ötf
("\tClõ¡ ID: %s\n", 
˛õ¡
->
˛õ¡_id
);

133 
	`¥ötf
("\tLa° MID: %d\n", 
˛õ¡
->
œ°_mid
);

134 
	`¥ötf
("\tDisc⁄√˘Åime: %ld\n", 
˛õ¡
->
disc⁄√˘_t
);

135 
	}
}

138 
	$¥öt_db_˛õ¡_msg
(
db_˛õ¡_msg
 *
msg
, 
Àngth
)

140 
	`¥ötf
("DB_CHUNK_CLIENT_MSG:\n");

141 
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

142 
	`¥ötf
("\tClõ¡ ID: %s\n", 
msg
->
˛õ¡_id
);

143 
	`¥ötf
("\tSt‹êID: %" 
PRIu64
 "\n", 
msg
->
°‹e_id
);

144 
	`¥ötf
("\tMID: %d\n", 
msg
->
mid
);

145 
	`¥ötf
("\tQoS: %d\n", 
msg
->
qos
);

146 
	`¥ötf
("\tRëaö: %d\n", 
msg
->
ªèö
);

147 
	`¥ötf
("\tDúe˘i⁄: %d\n", 
msg
->
dúe˘i⁄
);

148 
	`¥ötf
("\tSèã: %d\n", 
msg
->
°©e
);

149 
	`¥ötf
("\tDup: %d\n", 
msg
->
dup
);

150 
	}
}

153 
	$¥öt_db_sub
(
db_sub
 *
sub
, 
Àngth
)

155 
	`¥ötf
("DB_CHUNK_SUB:\n");

156 
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

157 
	`¥ötf
("\tClõ¡ ID: %s\n", 
sub
->
˛õ¡_id
);

158 
	`¥ötf
("\tT›ic: %s\n", 
sub
->
t›ic
);

159 
	`¥ötf
("\tQoS: %d\n", 
sub
->
qos
);

160 
	}
}

163 
	$¥öt_db_msg
(
db_msg
 *
msg
, 
Àngth
)

165 
	`¥ötf
("DB_CHUNK_MSG_STORE:\n");

166 
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

167 
	`¥ötf
("\tSt‹êID: %" 
PRIu64
 "\n", 
msg
->
°‹e_id
);

168 
	`¥ötf
("\tSour˚ ID: %s\n", 
msg
->
sour˚_id
);

169 
	`¥ötf
("\tSour˚ U£∫ame: %s\n", 
msg
->
sour˚_u£∫ame
);

170 
	`¥ötf
("\tSour˚ P‹t: %d\n", 
msg
->
sour˚_p‹t
);

171 
	`¥ötf
("\tSour˚ MID: %d\n", 
msg
->
sour˚_mid
);

172 
	`¥ötf
("\tMID: %d\n", 
msg
->
mid
);

173 
	`¥ötf
("\tT›ic: %s\n", 
msg
->
t›ic
);

174 
	`¥ötf
("\tQoS: %d\n", 
msg
->
qos
);

175 
	`¥ötf
("\tRëaö: %d\n", 
msg
->
ªèö
);

176 
	`¥ötf
("\tPaylﬂd Lígth: %d\n", 
msg
->
∑ylﬂdÀn
);

178 
boﬁ
 
bö¨y
 = 
Ál£
;

179 
i
=0; i<
msg
->
∑ylﬂdÀn
; i++){

180 if(
msg
->
∑ylﬂd
[
i
] =0Ë
bö¨y
 = 
åue
;

182 if(
bö¨y
 =
Ál£
 && 
msg
->
∑ylﬂdÀn
<256){

183 
	`¥ötf
("\tPaylﬂd: %s\n", 
msg
->
∑ylﬂd
);

185 
	}
}

188 
	$≥rsi°__ªad_°rög
(
FILE
 *
db_Âå
, **
°r
)

190 
uöt16_t
 
i16ãmp
;

191 
uöt16_t
 
¶í
;

192 *
s
 = 
NULL
;

194 if(
	`‰ód
(&
i16ãmp
, 1, (
uöt16_t
), 
db_Âå
) != (uint16_t)){

195  
MOSQ_ERR_INVAL
;

198 
¶í
 = 
	`¡ohs
(
i16ãmp
);

199 if(
¶í
){

200 
s
 = 
	`mosquôto__mÆloc
(
¶í
+1);

201 if(!
s
){

202 
	`f˛o£
(
db_Âå
);

203 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

204  
MOSQ_ERR_NOMEM
;

206 if(
	`‰ód
(
s
, 1, 
¶í
, 
db_Âå
) != slen){

207 
	`mosquôto__‰ì
(
s
);

208 
	`Ârötf
(
°dîr
, "Eº‹: %s.\n", 
	`°ªº‹
(
î∫o
));

209  
MOSQ_ERR_INVAL
;

211 
s
[
¶í
] = '\0';

214 *
°r
 = 
s
;

215  
MOSQ_ERR_SUCCESS
;

216 
	}
}

219 
	$db__˛õ¡_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
, 
db_˛õ¡
 *
˛õ¡
)

221 
uöt16_t
 
i16ãmp
;

222 
rc
 = 0;

223 
˛õ¡_chunk
 *
cc
;

225 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
˛õ¡
->
˛õ¡_id
);

226 if(
rc
){

227 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

228 
	`f˛o£
(
db_fd
);

229  
rc
;

232 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

233 
˛õ¡
->
œ°_mid
 = 
	`¡ohs
(
i16ãmp
);

235 if(
db_vîsi⁄
 == 2){

236 
˛õ¡
->
disc⁄√˘_t
 = 
	`time
(
NULL
);

238 
	`ªad_e
(
db_fd
, &
˛õ¡
->
disc⁄√˘_t
, (
time_t
));

241 if(
˛õ¡_°©s
){

242 
cc
 = 
	`ˇŒoc
(1, (
˛õ¡_chunk
));

243 if(!
cc
){

244 
î∫o
 = 
ENOMEM
;

245 
îr‹
;

247 
cc
->
id
 = 
	`°rdup
(
˛õ¡
->
˛õ¡_id
);

248 
	`HASH_ADD_KEYPTR
(
hh_id
, 
˛õ¡s_by_id
, 
cc
->
id
, 
	`°æí
(cc->id), cc);

251  
rc
;

252 
îr‹
:

253 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

254 if(
db_fd
Ë
	`f˛o£
(db_fd);

255 
	`‰ì
(
˛õ¡
->
˛õ¡_id
);

257 
	}
}

259 
	$db__˛õ¡_msg_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
, 
uöt32_t
 
Àngth
, 
db_˛õ¡_msg
 *
msg
)

261 
dbid_t
 
i64ãmp
;

262 
uöt16_t
 
i16ãmp
;

263 
˛õ¡_chunk
 *
cc
;

264 
msg_°‹e_chunk
 *
msc
;

265 
rc
;

267 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
msg
->
˛õ¡_id
);

268 if(
rc
){

269 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

270 
	`f˛o£
(
db_fd
);

271  
rc
;

274 
	`ªad_e
(
db_fd
, &
i64ãmp
, (
dbid_t
));

275 
msg
->
°‹e_id
 = 
i64ãmp
;

277 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

278 
msg
->
mid
 = 
	`¡ohs
(
i16ãmp
);

280 
	`ªad_e
(
db_fd
, &
msg
->
qos
, (
uöt8_t
));

281 
	`ªad_e
(
db_fd
, &
msg
->
ªèö
, (
uöt8_t
));

282 
	`ªad_e
(
db_fd
, &
msg
->
dúe˘i⁄
, (
uöt8_t
));

283 
	`ªad_e
(
db_fd
, &
msg
->
°©e
, (
uöt8_t
));

284 
	`ªad_e
(
db_fd
, &
msg
->
dup
, (
uöt8_t
));

286 if(
˛õ¡_°©s
){

287 
	`HASH_FIND
(
hh_id
, 
˛õ¡s_by_id
, 
msg
->
˛õ¡_id
, 
	`°æí
(msg->˛õ¡_id), 
cc
);

288 if(
cc
){

289 
cc
->
mesßges
++;

290 
cc
->
mesßge_size
 +
Àngth
;

292 
	`HASH_FIND
(
hh
, 
msgs_by_id
, &
msg
->
°‹e_id
, (
dbid_t
), 
msc
);

293 if(
msc
){

294 
cc
->
mesßge_size
 +
msc
->
Àngth
;

300 
îr‹
:

301 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

302 if(
db_fd
Ë
	`f˛o£
(db_fd);

303 
	`‰ì
(
msg
->
˛õ¡_id
);

305 
	}
}

307 
	$db__msg_°‹e_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
, 
uöt32_t
 
Àngth
, 
db_msg
 *
msg
)

309 
dbid_t
 
i64ãmp
;

310 
uöt32_t
 
i32ãmp
;

311 
uöt16_t
 
i16ãmp
;

312 
rc
 = 0;

313 
msg_°‹e_chunk
 *
mcs
;

315 
	`ªad_e
(
db_fd
, &
i64ãmp
, (
dbid_t
));

316 
msg
->
°‹e_id
 = 
i64ãmp
;

318 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
msg
->
sour˚_id
);

319 if(
rc
){

320 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

321 
	`f˛o£
(
db_fd
);

322  
rc
;

324 if(
db_vîsi⁄
 == 4){

325 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
msg
->
sour˚_u£∫ame
);

326 if(
rc
){

327 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

328 
	`f˛o£
(
db_fd
);

329 
	`‰ì
(
msg
->
sour˚_id
);

330 
	`‰ì
(
msg
->
t›ic
);

331 
	`‰ì
(
msg
->
∑ylﬂd
);

332 
	`‰ì
(
msg
->
sour˚_id
);

335 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

336 
msg
->
sour˚_p‹t
 = 
	`¡ohs
(
i16ãmp
);

340 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

341 
msg
->
sour˚_mid
 = 
	`¡ohs
(
i16ãmp
);

343 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

344 
msg
->
mid
 = 
	`¡ohs
(
i16ãmp
);

346 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
msg
->
t›ic
);

347 if(
rc
){

348 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

349 
	`f˛o£
(
db_fd
);

350  
rc
;

353 
	`ªad_e
(
db_fd
, &
msg
->
qos
, (
uöt8_t
));

354 
	`ªad_e
(
db_fd
, &
msg
->
ªèö
, (
uöt8_t
));

356 
	`ªad_e
(
db_fd
, &
i32ãmp
, (
uöt32_t
));

357 
msg
->
∑ylﬂdÀn
 = 
	`¡ohl
(
i32ãmp
);

359 if(
msg
->
∑ylﬂdÀn
){

360 
msg
->
∑ylﬂd
 = 
	`mÆloc
(msg->
∑ylﬂdÀn
+1);

361 if(!
msg
->
∑ylﬂd
){

362 
	`f˛o£
(
db_fd
);

363 
	`‰ì
(
msg
->
sour˚_id
);

364 
	`‰ì
(
msg
->
t›ic
);

365 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

368 
	`mem£t
(
msg
->
∑ylﬂd
, 0, msg->
∑ylﬂdÀn
+1);

369 if(
	`‰ód
(
msg
->
∑ylﬂd
, 1, msg->
∑ylﬂdÀn
, 
db_fd
) != msg->payloadlen){

370 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

371 
	`f˛o£
(
db_fd
);

372 
	`‰ì
(
msg
->
sour˚_id
);

373 
	`‰ì
(
msg
->
t›ic
);

374 
	`‰ì
(
msg
->
∑ylﬂd
);

379 if(
˛õ¡_°©s
){

380 
mcs
 = 
	`ˇŒoc
(1, (
msg_°‹e_chunk
));

381 if(!
mcs
){

382 
î∫o
 = 
ENOMEM
;

383 
îr‹
;

385 
mcs
->
°‹e_id
 = 
msg
->store_id;

386 
mcs
->
Àngth
 =Üength;

387 
	`HASH_ADD
(
hh
, 
msgs_by_id
, 
°‹e_id
, (
dbid_t
), 
mcs
);

390  
rc
;

391 
îr‹
:

392 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

393 if(
db_fd
Ë
	`f˛o£
(db_fd);

394 
	`‰ì
(
msg
->
sour˚_id
);

395 
	`‰ì
(
msg
->
t›ic
);

397 
	}
}

399 
	$db__ªèö_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

401 
dbid_t
 
i64ãmp
, 
°‹e_id
;

403 if(
	`‰ód
(&
i64ãmp
, (
dbid_t
), 1, 
db_fd
) != 1){

404 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

405 
	`f˛o£
(
db_fd
);

408 
°‹e_id
 = 
i64ãmp
;

409 if(
do_¥öt
Ë
	`¥ötf
("\tSt‹êID: %" 
PRIu64
 "\n", 
°‹e_id
);

411 
	}
}

413 
	$db__sub_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
, 
uöt32_t
 
Àngth
, 
db_sub
 *
sub
)

415 
rc
 = 0;

416 
˛õ¡_chunk
 *
cc
;

418 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
sub
->
˛õ¡_id
);

419 if(
rc
){

420 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

421 
	`f˛o£
(
db_fd
);

422  
rc
;

425 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_fd
, &
sub
->
t›ic
);

426 if(
rc
){

427 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

428 
	`f˛o£
(
db_fd
);

429  
rc
;

432 
	`ªad_e
(
db_fd
, &
sub
->
qos
, (
uöt8_t
));

434 if(
˛õ¡_°©s
){

435 
	`HASH_FIND
(
hh_id
, 
˛õ¡s_by_id
, 
sub
->
˛õ¡_id
, 
	`°æí
(sub->˛õ¡_id), 
cc
);

436 if(
cc
){

437 
cc
->
subs¸ùti⁄s
++;

438 
cc
->
subs¸ùti⁄_size
 +
Àngth
;

442  
rc
;

443 
îr‹
:

444 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

445 if(
db_fd
 >0Ë
	`f˛o£
(db_fd);

447 
	}
}

449 
	$maö
(
¨gc
, *
¨gv
[])

451 
FILE
 *
fd
;

452 
hódî
[15];

453 
rc
 = 0;

454 
uöt32_t
 
¸c
;

455 
dbid_t
 
i64ãmp
;

456 
uöt32_t
 
i32ãmp
, 
Àngth
;

457 
uöt16_t
 
i16ãmp
, 
chunk
;

458 
uöt8_t
 
i8ãmp
;

459 
ssize_t
 
æí
;

460 
mosquôto_db
 
db
;

461 *
fûíame
;

462 
cfg_cou¡
 = 0;

463 
msg_°‹e_cou¡
 = 0;

464 
˛õ¡_msg_cou¡
 = 0;

465 
ªèö_cou¡
 = 0;

466 
sub_cou¡
 = 0;

467 
˛õ¡_cou¡
 = 0;

468 
˛õ¡_chunk
 *
cc
, *
cc_tmp
;

470 if(
¨gc
 == 2){

471 
fûíame
 = 
¨gv
[1];

472 }if(
¨gc
 =3 && !
	`°rcmp
(
¨gv
[1], "--stats")){

473 
°©s
 = 1;

474 
do_¥öt
 = 0;

475 
fûíame
 = 
¨gv
[2];

476 }if(
¨gc
 =3 && !
	`°rcmp
(
¨gv
[1], "--client-stats")){

477 
˛õ¡_°©s
 = 1;

478 
do_¥öt
 = 0;

479 
fûíame
 = 
¨gv
[2];

481 
	`Ârötf
(
°dîr
, "Usage: db_dump [--stats | --client-stats] <mosquitto db filename>\n");

484 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

485 
fd
 = 
	`f›í
(
fûíame
, "rb");

486 if(!
fd
)  0;

487 
	`ªad_e
(
fd
, &
hódî
, 15);

488 if(!
	`memcmp
(
hódî
, 
magic
, 15)){

489 if(
do_¥öt
Ë
	`¥ötf
("Mosquitto DB dump\n");

491 
	`ªad_e
(
fd
, &
¸c
, (
uöt32_t
));

492 if(
do_¥öt
Ë
	`¥ötf
("CRC: %d\n", 
¸c
);

493 
	`ªad_e
(
fd
, &
i32ãmp
, (
uöt32_t
));

494 
db_vîsi⁄
 = 
	`¡ohl
(
i32ãmp
);

495 if(
do_¥öt
Ë
	`¥ötf
("DB vîsi⁄: %d\n", 
db_vîsi⁄
);

497 
æí
 = 
	`‰ód
(&
i16ãmp
, (
uöt16_t
), 1, 
fd
),Ñlen == 1){

498 
chunk
 = 
	`¡ohs
(
i16ãmp
);

499 
	`ªad_e
(
fd
, &
i32ãmp
, (
uöt32_t
));

500 
Àngth
 = 
	`¡ohl
(
i32ãmp
);

501 
chunk
){

502 
DB_CHUNK_CFG
:

503 
cfg_cou¡
++;

504 if(
do_¥öt
Ë
	`¥ötf
("DB_CHUNK_CFG:\n");

505 if(
do_¥öt
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

506 
	`ªad_e
(
fd
, &
i8ãmp
, (
uöt8_t
));

507 if(
do_¥öt
Ë
	`¥ötf
("\tShutdown: %d\n", 
i8ãmp
);

508 
	`ªad_e
(
fd
, &
i8ãmp
, (
uöt8_t
));

509 if(
do_¥öt
Ë
	`¥ötf
("\tDB ID size: %d\n", 
i8ãmp
);

510 if(
i8ãmp
 !(
dbid_t
)){

511 
	`Ârötf
(
°dîr
, "Error: Incompatible database configuration (dbid size is %d bytes,Éxpected %ld)",

512 
i8ãmp
, (
dbid_t
));

513 
	`f˛o£
(
fd
);

516 
	`ªad_e
(
fd
, &
i64ãmp
, (
dbid_t
));

517 if(
do_¥öt
Ë
	`¥ötf
("\tLa° DB ID: %ld\n", ()
i64ãmp
);

520 
DB_CHUNK_MSG_STORE
:

521 
msg_°‹e_cou¡
++;

522 
db_msg
 
msg
 = {0};

523 if(
	`db__msg_°‹e_chunk_ª°‹e
(&
db
, 
fd
, 
Àngth
, &
msg
))  1;

524 if(
do_¥öt
) {

525 
	`¥öt_db_msg
(&
msg
, 
Àngth
);

527 
	`‰ì__db_msg
(&
msg
);

530 
DB_CHUNK_CLIENT_MSG
:

531 
˛õ¡_msg_cou¡
++;

532 
db_˛õ¡_msg
 
cmsg
 = {0};

533 if(
	`db__˛õ¡_msg_chunk_ª°‹e
(&
db
, 
fd
, 
Àngth
, &
cmsg
))  1;

534 if(
do_¥öt
) {

535 
	`¥öt_db_˛õ¡_msg
(&
cmsg
, 
Àngth
);

537 
	`‰ì__db_˛õ¡_msg
(&
cmsg
);

540 
DB_CHUNK_RETAIN
:

541 
ªèö_cou¡
++;

542 if(
do_¥öt
Ë
	`¥ötf
("DB_CHUNK_RETAIN:\n");

543 if(
do_¥öt
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

544 if(
	`db__ªèö_chunk_ª°‹e
(&
db
, 
fd
))  1;

547 
DB_CHUNK_SUB
:

548 
sub_cou¡
++;

549 
db_sub
 
sub
 = {0};

550 if(
	`db__sub_chunk_ª°‹e
(&
db
, 
fd
, 
Àngth
, &
sub
))  1;

551 if(
do_¥öt
) {

552 
	`¥öt_db_sub
(&
sub
, 
Àngth
);

554 
	`‰ì__db_sub
(&
sub
);

557 
DB_CHUNK_CLIENT
:

558 
˛õ¡_cou¡
++;

559 
db_˛õ¡
 
˛õ¡
 = {0};

560 if(
	`db__˛õ¡_chunk_ª°‹e
(&
db
, 
fd
, &
˛õ¡
))  1;

561 if(
do_¥öt
) {

562 
	`¥öt_db_˛õ¡
(&
˛õ¡
, 
Àngth
);

564 
	`‰ì__db_˛õ¡
(&
˛õ¡
);

568 
	`Ârötf
(
°dîr
, "W¨nög: Unsuµ‹ãd chunk \"%d\" i¿≥rsi°íàd©aba£ fûe. Ign‹ög.\n", 
chunk
);

569 
	`f£ek
(
fd
, 
Àngth
, 
SEEK_CUR
);

573 if(
æí
 < 0Ë
îr‹
;

575 
	`Ârötf
(
°dîr
, "Error: Unrecognised file format.");

576 
rc
 = 1;

579 
	`f˛o£
(
fd
);

581 if(
°©s
){

582 
	`¥ötf
("DB_CHUNK_CFG: %ld\n", 
cfg_cou¡
);

583 
	`¥ötf
("DB_CHUNK_MSG_STORE: %ld\n", 
msg_°‹e_cou¡
);

584 
	`¥ötf
("DB_CHUNK_CLIENT_MSG: %ld\n", 
˛õ¡_msg_cou¡
);

585 
	`¥ötf
("DB_CHUNK_RETAIN: %ld\n", 
ªèö_cou¡
);

586 
	`¥ötf
("DB_CHUNK_SUB: %ld\n", 
sub_cou¡
);

587 
	`¥ötf
("DB_CHUNK_CLIENT: %ld\n", 
˛õ¡_cou¡
);

590 if(
˛õ¡_°©s
){

591 
	`HASH_ITER
(
hh_id
, 
˛õ¡s_by_id
, 
cc
, 
cc_tmp
){

592 
	`¥ötf
("SC: %d SS: %d MC: %d MS: %ld ", 
cc
->
subs¸ùti⁄s
, cc->
subs¸ùti⁄_size
, cc->
mesßges
, cc->
mesßge_size
);

593 
	`¥ötf
("%s\n", 
cc
->
id
);

594 
	`‰ì
(
cc
->
id
);

598  
rc
;

599 
îr‹
:

600 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

601 if(
fd
 >0Ë
	`f˛o£
(fd);

603 
	}
}

	@src/deps/uthash.h

24 #i‚de‡
UTHASH_H


25 
	#UTHASH_H


	)

27 
	~<°rög.h
>

28 
	~<°ddef.h
>

29 
	~<°dlib.h
>

35 #ifde‡
_MSC_VER


36 #i‡
_MSC_VER
 >1600 && 
deföed
(
__˝lu•lus
)

37 
	#DECLTYPE
(
x
Ë(
	`de˛ty≥
(x))

	)

39 
	#NO_DECLTYPE


	)

40 
	#DECLTYPE
(
x
)

	)

43 
	#DECLTYPE
(
x
Ë(
	`__ty≥of
(x))

	)

46 #ifde‡
NO_DECLTYPE


47 
	#DECLTYPE_ASSIGN
(
d°
,
§c
) \

49 **
_da_d°
 = (**)(&(
d°
)); \

50 *
_da_d°
 = (*)(
§c
); \

51 } 0)

	)

53 
	#DECLTYPE_ASSIGN
(
d°
,
§c
) \

55 (
d°
Ë
	`DECLTYPE
(d°)(
§c
); \

56 } 0)

	)

60 #ifde‡
_MSC_VER


61 
	tuöt32_t
;

62 
	tuöt8_t
;

64 
	~<öây≥s.h
>

67 
	#UTHASH_VERSION
 1.9.8

	)

69 #i‚de‡
uthash_Áèl


70 
	#uthash_Áèl
(
msg
Ë
	`exô
(-1Ë

	)

72 #i‚de‡
uthash_mÆloc


73 
	#uthash_mÆloc
(
sz
Ë
	`mÆloc
(szË

	)

75 #i‚de‡
uthash_‰ì


76 
	#uthash_‰ì
(
±r
,
sz
Ë
	`‰ì
’åË

	)

79 #i‚de‡
uthash_n€x∑nd_fyi


80 
	#uthash_n€x∑nd_fyi
(
tbl
Ë

	)

82 #i‚de‡
uthash_ex∑nd_fyi


83 
	#uthash_ex∑nd_fyi
(
tbl
Ë

	)

87 
	#HASH_INITIAL_NUM_BUCKETS
 32

	)

88 
	#HASH_INITIAL_NUM_BUCKETS_LOG2
 5

	)

89 
	#HASH_BKT_CAPACITY_THRESH
 10

	)

92 
	#ELMT_FROM_HH
(
tbl
,
hhp
Ë((*)(((*)(hhp)Ë- (—bl)->
hho
)))

	)

94 
	#HASH_FIND
(
hh
,
hód
,
key±r
,
keyÀn
,
out
) \

96 
_hf_bkt
,
_hf_hashv
; \

97 
out
=
NULL
; \

98 i‡(
hód
) { \

99 
	`HASH_FCN
(
key±r
,
keyÀn
, (
hód
)->
hh
.
tbl
->
num_buckës
, 
_hf_hashv
, 
_hf_bkt
); \

100 i‡(
	`HASH_BLOOM_TEST
((
hód
)->
hh
.
tbl
, 
_hf_hashv
)) { \

101 
	`HASH_FIND_IN_BKT
((
hód
)->
hh
.
tbl
, hh, (hód)->hh.tbl->
buckës
[ 
_hf_bkt
 ], \

102 
key±r
,
keyÀn
,
out
); \

105 } 0)

	)

107 #ifde‡
HASH_BLOOM


108 
	#HASH_BLOOM_BITLEN
 (1ULL << 
HASH_BLOOM
)

	)

109 
	#HASH_BLOOM_BYTELEN
 (
HASH_BLOOM_BITLEN
/8Ë+ ((HASH_BLOOM_BITLEN%8Ë? 1:0)

	)

110 
	#HASH_BLOOM_MAKE
(
tbl
) \

112 (
tbl
)->
bloom_nbôs
 = 
HASH_BLOOM
; \

113 (
tbl
)->
bloom_bv
 = (
uöt8_t
*)
	`uthash_mÆloc
(
HASH_BLOOM_BYTELEN
); \

114 i‡(!((
tbl
)->
bloom_bv
)Ë{ 
	`uthash_Áèl
( "out of memory"); } \

115 
	`mem£t
((
tbl
)->
bloom_bv
, 0, 
HASH_BLOOM_BYTELEN
); \

116 (
tbl
)->
bloom_sig
 = 
HASH_BLOOM_SIGNATURE
; \

117 } 0)

	)

119 
	#HASH_BLOOM_FREE
(
tbl
) \

121 
	`uthash_‰ì
((
tbl
)->
bloom_bv
, 
HASH_BLOOM_BYTELEN
); \

122 } 0)

	)

124 
	#HASH_BLOOM_BITSET
(
bv
,
idx
Ë(bv[(idx)/8] |(1U << ((idx)%8)))

	)

125 
	#HASH_BLOOM_BITTEST
(
bv
,
idx
Ë(bv[(idx)/8] & (1U << ((idx)%8)))

	)

127 
	#HASH_BLOOM_ADD
(
tbl
,
hashv
) \

128 
	`HASH_BLOOM_BITSET
((
tbl
)->
bloom_bv
, (
hashv
 & (
uöt32_t
)((1ULL << (tbl)->
bloom_nbôs
Ë- 1)))

	)

130 
	#HASH_BLOOM_TEST
(
tbl
,
hashv
) \

131 
	`HASH_BLOOM_BITTEST
((
tbl
)->
bloom_bv
, (
hashv
 & (
uöt32_t
)((1ULL << (tbl)->
bloom_nbôs
Ë- 1)))

	)

134 
	#HASH_BLOOM_MAKE
(
tbl
)

	)

135 
	#HASH_BLOOM_FREE
(
tbl
)

	)

136 
	#HASH_BLOOM_ADD
(
tbl
,
hashv
)

	)

137 
	#HASH_BLOOM_TEST
(
tbl
,
hashv
Ë(1)

	)

138 
	#HASH_BLOOM_BYTELEN
 0

	)

141 
	#HASH_MAKE_TABLE
(
hh
,
hód
) \

143 (
hód
)->
hh
.
tbl
 = (
UT_hash_èbÀ
*)
	`uthash_mÆloc
( \

144 (
UT_hash_èbÀ
)); \

145 i‡(!((
hód
)->
hh
.
tbl
)Ë{ 
	`uthash_Áèl
( "out of memory"); } \

146 
	`mem£t
((
hód
)->
hh
.
tbl
, 0, (
UT_hash_èbÀ
)); \

147 (
hód
)->
hh
.
tbl
->
èû
 = &((head)->hh); \

148 (
hód
)->
hh
.
tbl
->
num_buckës
 = 
HASH_INITIAL_NUM_BUCKETS
; \

149 (
hód
)->
hh
.
tbl
->
log2_num_buckës
 = 
HASH_INITIAL_NUM_BUCKETS_LOG2
; \

150 (
hód
)->
hh
.
tbl
->
hho
 = (*)(&(head)->hh) - (*)(head); \

151 (
hód
)->
hh
.
tbl
->
buckës
 = (
UT_hash_buckë
*)
	`uthash_mÆloc
( \

152 
HASH_INITIAL_NUM_BUCKETS
*(
UT_hash_buckë
)); \

153 i‡(! (
hód
)->
hh
.
tbl
->
buckës
Ë{ 
	`uthash_Áèl
( "out of memory"); } \

154 
	`mem£t
((
hód
)->
hh
.
tbl
->
buckës
, 0, \

155 
HASH_INITIAL_NUM_BUCKETS
*(
UT_hash_buckë
)); \

156 
	`HASH_BLOOM_MAKE
((
hód
)->
hh
.
tbl
); \

157 (
hód
)->
hh
.
tbl
->
sig«tuª
 = 
HASH_SIGNATURE
; \

158 } 0)

	)

160 
	#HASH_ADD
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
) \

161 
	`HASH_ADD_KEYPTR
(
hh
,
hód
,&((
add
)->
fõld«me
),
keyÀn_ö
,add)

	)

163 
	#HASH_REPLACE
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
,
ª∂a˚d
) \

165 
ª∂a˚d
=
NULL
; \

166 
	`HASH_FIND
(
hh
,
hód
,&((
add
)->
fõld«me
),
keyÀn_ö
,
ª∂a˚d
); \

167 i‡(
ª∂a˚d
!=
NULL
) { \

168 
	`HASH_DELETE
(
hh
,
hód
,
ª∂a˚d
); \

170 
	`HASH_ADD
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
); \

171 } 0)

	)

173 
	#HASH_ADD_KEYPTR
(
hh
,
hód
,
key±r
,
keyÀn_ö
,
add
) \

175 
_ha_bkt
; \

176 (
add
)->
hh
.
√xt
 = 
NULL
; \

177 (
add
)->
hh
.
key
 = (*)
key±r
; \

178 (
add
)->
hh
.
keyÀn
 = ()
keyÀn_ö
; \

179 i‡(!(
hód
)) { \

180 
hód
 = (
add
); \

181 (
hód
)->
hh
.
¥ev
 = 
NULL
; \

182 
	`HASH_MAKE_TABLE
(
hh
,
hód
); \

184 (
hód
)->
hh
.
tbl
->
èû
->
√xt
 = (
add
); \

185 (
add
)->
hh
.
¥ev
 = 
	`ELMT_FROM_HH
((
hód
)->hh.
tbl
, (hód)->hh.tbl->
èû
); \

186 (
hód
)->
hh
.
tbl
->
èû
 = &((
add
)->hh); \

188 (
hód
)->
hh
.
tbl
->
num_ôems
++; \

189 (
add
)->
hh
.
tbl
 = (
hód
)->hh.tbl; \

190 
	`HASH_FCN
(
key±r
,
keyÀn_ö
, (
hód
)->
hh
.
tbl
->
num_buckës
, \

191 (
add
)->
hh
.
hashv
, 
_ha_bkt
); \

192 
	`HASH_ADD_TO_BKT
((
hód
)->
hh
.
tbl
->
buckës
[
_ha_bkt
],&(
add
)->hh); \

193 
	`HASH_BLOOM_ADD
((
hód
)->
hh
.
tbl
,(
add
)->hh.
hashv
); \

194 
	`HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
keyÀn_ö
); \

195 
	`HASH_FSCK
(
hh
,
hód
); \

196 } 0)

	)

198 
	#HASH_TO_BKT
–
hashv
, 
num_bkts
, 
bkt
 ) \

200 
bkt
 = ((
hashv
Ë& ((
num_bkts
) - 1)); \

201 } 0)

	)

215 
	#HASH_DELETE
(
hh
,
hód
,
dñ±r
) \

217 
_hd_bkt
; \

218 
UT_hash_h™dÀ
 *
_hd_hh_dñ
; \

219 i‡–((
dñ±r
)->
hh
.
¥ev
 =
NULL
Ë&& ((dñ±r)->hh.
√xt
 == NULL) ) { \

220 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
->
buckës
, \

221 (
hód
)->
hh
.
tbl
->
num_buckës
*(
UT_hash_buckë
) ); \

222 
	`HASH_BLOOM_FREE
((
hód
)->
hh
.
tbl
); \

223 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
, (
UT_hash_èbÀ
)); \

224 
hód
 = 
NULL
; \

226 
_hd_hh_dñ
 = &((
dñ±r
)->
hh
); \

227 i‡((
dñ±r
Ë=
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,(hód)->hh.tbl->
èû
)) { \

228 (
hód
)->
hh
.
tbl
->
èû
 = \

229 (
UT_hash_h™dÀ
*)((
±rdiff_t
)((
dñ±r
)->
hh
.
¥ev
) + \

230 (
hód
)->
hh
.
tbl
->
hho
); \

232 i‡((
dñ±r
)->
hh
.
¥ev
) { \

233 ((
UT_hash_h™dÀ
*)((
±rdiff_t
)((
dñ±r
)->
hh
.
¥ev
) + \

234 (
hód
)->
hh
.
tbl
->
hho
))->
√xt
 = (
dñ±r
)->hh.next; \

236 
	`DECLTYPE_ASSIGN
(
hód
,(
dñ±r
)->
hh
.
√xt
); \

238 i‡(
_hd_hh_dñ
->
√xt
) { \

239 ((
UT_hash_h™dÀ
*)((
±rdiff_t
)
_hd_hh_dñ
->
√xt
 + \

240 (
hód
)->
hh
.
tbl
->
hho
))->
¥ev
 = \

241 
_hd_hh_dñ
->
¥ev
; \

243 
	`HASH_TO_BKT
–
_hd_hh_dñ
->
hashv
, (
hód
)->
hh
.
tbl
->
num_buckës
, 
_hd_bkt
); \

244 
	`HASH_DEL_IN_BKT
(
hh
,(
hód
)->hh.
tbl
->
buckës
[
_hd_bkt
], 
_hd_hh_dñ
); \

245 (
hód
)->
hh
.
tbl
->
num_ôems
--; \

247 
	`HASH_FSCK
(
hh
,
hód
); \

248 } 0)

	)

252 
	#HASH_FIND_STR
(
hód
,
föd°r
,
out
) \

253 
	`HASH_FIND
(
hh
,
hód
,
föd°r
,
	`°æí
(föd°r),
out
)

	)

254 
	#HASH_ADD_STR
(
hód
,
°rfõld
,
add
) \

255 
	`HASH_ADD
(
hh
,
hód
,
°rfõld
,
	`°æí
(
add
->°rfõld),add)

	)

256 
	#HASH_REPLACE_STR
(
hód
,
°rfõld
,
add
,
ª∂a˚d
) \

257 
	`HASH_REPLACE
(
hh
,
hód
,
°rfõld
,
	`°æí
(
add
->°rfõld),add,
ª∂a˚d
)

	)

258 
	#HASH_FIND_INT
(
hód
,
födöt
,
out
) \

259 
	`HASH_FIND
(
hh
,
hód
,
födöt
,(),
out
)

	)

260 
	#HASH_ADD_INT
(
hód
,
ötfõld
,
add
) \

261 
	`HASH_ADD
(
hh
,
hód
,
ötfõld
,(),
add
)

	)

262 
	#HASH_REPLACE_INT
(
hód
,
ötfõld
,
add
,
ª∂a˚d
) \

263 
	`HASH_REPLACE
(
hh
,
hód
,
ötfõld
,(),
add
,
ª∂a˚d
)

	)

264 
	#HASH_FIND_PTR
(
hód
,
föd±r
,
out
) \

265 
	`HASH_FIND
(
hh
,
hód
,
föd±r
,(*),
out
)

	)

266 
	#HASH_ADD_PTR
(
hód
,
±rfõld
,
add
) \

267 
	`HASH_ADD
(
hh
,
hód
,
±rfõld
,(*),
add
)

	)

268 
	#HASH_REPLACE_PTR
(
hód
,
±rfõld
,
add
) \

269 
	`HASH_REPLACE
(
hh
,
hód
,
±rfõld
,(*),
add
,
ª∂a˚d
)

	)

270 
	#HASH_DEL
(
hód
,
dñ±r
) \

271 
	`HASH_DELETE
(
hh
,
hód
,
dñ±r
)

	)

276 #ifde‡
HASH_DEBUG


277 
	#HASH_OOPS
(...Ëdÿ{ 
	`Ârötf
(
°dîr
,
__VA_ARGS__
); 
	`exô
(-1); } 0)

	)

278 
	#HASH_FSCK
(
hh
,
hód
) \

280 
_bkt_i
; \

281 
_cou¡
, 
_bkt_cou¡
; \

282 *
_¥ev
; \

283 
UT_hash_h™dÀ
 *
_thh
; \

284 i‡(
hód
) { \

285 
_cou¡
 = 0; \

286  
_bkt_i
 = 0; _bkt_ò< (
hód
)->
hh
.
tbl
->
num_buckës
; _bkt_i++) { \

287 
_bkt_cou¡
 = 0; \

288 
_thh
 = (
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
hh_hód
; \

289 
_¥ev
 = 
NULL
; \

290 
_thh
) { \

291 i‡(
_¥ev
 !(*)(
_thh
->
hh_¥ev
)) { \

292 
	`HASH_OOPS
("invalid hh_prev %p,áctual %p\n", \

293 
_thh
->
hh_¥ev
, 
_¥ev
 ); \

295 
_bkt_cou¡
++; \

296 
_¥ev
 = (*)(
_thh
); \

297 
_thh
 = _thh->
hh_√xt
; \

299 
_cou¡
 +
_bkt_cou¡
; \

300 i‡((
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
cou¡
 !
_bkt_cou¡
) { \

301 
	`HASH_OOPS
("invalid bucket count %d,áctual %d\n", \

302 (
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
cou¡
, 
_bkt_cou¡
); \

305 i‡(
_cou¡
 !(
hód
)->
hh
.
tbl
->
num_ôems
) { \

306 
	`HASH_OOPS
("invalid hh item count %d,áctual %d\n", \

307 (
hód
)->
hh
.
tbl
->
num_ôems
, 
_cou¡
 ); \

310 
_cou¡
 = 0; \

311 
_¥ev
 = 
NULL
; \

312 
_thh
 = &(
hód
)->
hh
; \

313 
_thh
) { \

314 
_cou¡
++; \

315 i‡(
_¥ev
 !=(*)(
_thh
->
¥ev
)) { \

316 
	`HASH_OOPS
("invalidÖrev %p,áctual %p\n", \

317 
_thh
->
¥ev
, 
_¥ev
 ); \

319 
_¥ev
 = (*)
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
, 
_thh
); \

320 
_thh
 = ( _thh->
√xt
 ? (
UT_hash_h™dÀ
*)((*)(_thh->next) + \

321 (
hód
)->
hh
.
tbl
->
hho
Ë: 
NULL
 ); \

323 i‡(
_cou¡
 !(
hód
)->
hh
.
tbl
->
num_ôems
) { \

324 
	`HASH_OOPS
("invalidápp item count %d,áctual %d\n", \

325 (
hód
)->
hh
.
tbl
->
num_ôems
, 
_cou¡
 ); \

328 } 0)

	)

330 
	#HASH_FSCK
(
hh
,
hód
)

	)

336 #ifde‡
HASH_EMIT_KEYS


337 
	#HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
fõldÀn
) \

339 
_kÀn
 = 
fõldÀn
; \

340 
	`wrôe
(
HASH_EMIT_KEYS
, &
_kÀn
, (_klen)); \

341 
	`wrôe
(
HASH_EMIT_KEYS
, 
key±r
, 
fõldÀn
); \

342 } 0)

	)

344 
	#HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
fõldÀn
)

	)

348 #ifde‡
HASH_FUNCTION


349 
	#HASH_FCN
 
HASH_FUNCTION


	)

351 
	#HASH_FCN
 
HASH_JEN


	)

355 
	#HASH_BER
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

357 
_hb_keyÀn
=
keyÀn
; \

358 *
_hb_key
=(*)(
key
); \

359 (
hashv
) = 0; \

360 
_hb_keyÀn
--Ë{ (
hashv
Ë((hashvË* 33Ë+ *
_hb_key
++; } \

361 
bkt
 = (
hashv
Ë& (
num_bkts
-1); \

362 } 0)

	)

367 
	#HASH_SAX
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

369 
_sx_i
; \

370 *
_hs_key
=(*)(
key
); \

371 
hashv
 = 0; \

372 
_sx_i
=0; _sx_ò< 
keyÀn
; _sx_i++) \

373 
hashv
 ^(hashv << 5Ë+ (hashv >> 2Ë+ 
_hs_key
[
_sx_i
]; \

374 
bkt
 = 
hashv
 & (
num_bkts
-1); \

375 } 0)

	)

377 
	#HASH_FNV
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

379 
_‚_i
; \

380 *
_hf_key
=(*)(
key
); \

381 
hashv
 = 2166136261UL; \

382 
_‚_i
=0; _‚_ò< 
keyÀn
; _fn_i++) \

383 
hashv
 = (hashv * 16777619Ë^ 
_hf_key
[
_‚_i
]; \

384 
bkt
 = 
hashv
 & (
num_bkts
-1); \

385 } 0)

	)

387 
	#HASH_OAT
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

389 
_ho_i
; \

390 *
_ho_key
=(*)(
key
); \

391 
hashv
 = 0; \

392 
_ho_i
=0; _ho_ò< 
keyÀn
; _ho_i++) { \

393 
hashv
 +
_ho_key
[
_ho_i
]; \

394 
hashv
 += (hashv << 10); \

395 
hashv
 ^= (hashv >> 6); \

397 
hashv
 += (hashv << 3); \

398 
hashv
 ^= (hashv >> 11); \

399 
hashv
 += (hashv << 15); \

400 
bkt
 = 
hashv
 & (
num_bkts
-1); \

401 } 0)

	)

403 
	#HASH_JEN_MIX
(
a
,
b
,
c
) \

405 
a
 -
b
;á -
c
;á ^= ( c >> 13 ); \

406 
b
 -
c
; b -
a
; b ^= (á << 8 ); \

407 
c
 -
a
; c -
b
; c ^= ( b >> 13 ); \

408 
a
 -
b
;á -
c
;á ^= ( c >> 12 ); \

409 
b
 -
c
; b -
a
; b ^= (á << 16 ); \

410 
c
 -
a
; c -
b
; c ^= ( b >> 5 ); \

411 
a
 -
b
;á -
c
;á ^= ( c >> 3 ); \

412 
b
 -
c
; b -
a
; b ^= (á << 10 ); \

413 
c
 -
a
; c -
b
; c ^= ( b >> 15 ); \

414 } 0)

	)

416 
	#HASH_JEN
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

418 
_hj_i
,
_hj_j
,
_hj_k
; \

419 *
_hj_key
=(*)(
key
); \

420 
hashv
 = 0xfeedbeef; \

421 
_hj_i
 = 
_hj_j
 = 0x9e3779b9; \

422 
_hj_k
 = ()
keyÀn
; \

423 
_hj_k
 >= 12) { \

424 
_hj_i
 +(
_hj_key
[0] + ( ()_hj_key[1] << 8 ) \

425 + ( ()
_hj_key
[2] << 16 ) \

426 + ( ()
_hj_key
[3] << 24 ) ); \

427 
_hj_j
 +(
_hj_key
[4] + ( ()_hj_key[5] << 8 ) \

428 + ( ()
_hj_key
[6] << 16 ) \

429 + ( ()
_hj_key
[7] << 24 ) ); \

430 
hashv
 +(
_hj_key
[8] + ( ()_hj_key[9] << 8 ) \

431 + ( ()
_hj_key
[10] << 16 ) \

432 + ( ()
_hj_key
[11] << 24 ) ); \

434 
	`HASH_JEN_MIX
(
_hj_i
, 
_hj_j
, 
hashv
); \

436 
_hj_key
 += 12; \

437 
_hj_k
 -= 12; \

439 
hashv
 +
keyÀn
; \

440  
_hj_k
 ) { \

441 11: 
hashv
 +–()
_hj_key
[10] << 24 ); \

442 10: 
hashv
 +–()
_hj_key
[9] << 16 ); \

443 9: 
hashv
 +–()
_hj_key
[8] << 8 ); \

444 8: 
_hj_j
 +–()
_hj_key
[7] << 24 ); \

445 7: 
_hj_j
 +–()
_hj_key
[6] << 16 ); \

446 6: 
_hj_j
 +–()
_hj_key
[5] << 8 ); \

447 5: 
_hj_j
 +
_hj_key
[4]; \

448 4: 
_hj_i
 +–()
_hj_key
[3] << 24 ); \

449 3: 
_hj_i
 +–()
_hj_key
[2] << 16 ); \

450 2: 
_hj_i
 +–()
_hj_key
[1] << 8 ); \

451 1: 
_hj_i
 +
_hj_key
[0]; \

453 
	`HASH_JEN_MIX
(
_hj_i
, 
_hj_j
, 
hashv
); \

454 
bkt
 = 
hashv
 & (
num_bkts
-1); \

455 } 0)

	)

458 #unde‡
gë16bôs


459 #i‡(
deföed
(
__GNUC__
Ë&& deföed(
__i386__
)Ë|| deföed(
__WATCOMC__
) \

460 || 
deföed
(
_MSC_VER
Ë|| deföed (
__BORLANDC__
Ë|| 
	$deföed
 (
__TURBOC__
)

461 
	#gë16bôs
(
d
Ë(*((c⁄° 
uöt16_t
 *Ë(d)))

	)

464 #i‡!
	`deföed
 (
gë16bôs
)

465 
	#gë16bôs
(
d
Ë((((
uöt32_t
)(((c⁄° 
uöt8_t
 *)(d))[1])) << 8) \

466 +(
uöt32_t
)(((c⁄° 
uöt8_t
 *)(
d
))[0]Ë)

	)

468 
	#HASH_SFH
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

470 *
_sfh_key
=(*)(
key
); \

471 
uöt32_t
 
_sfh_tmp
, 
_sfh_Àn
 = 
keyÀn
; \

473 
_sfh_ªm
 = 
_sfh_Àn
 & 3; \

474 
_sfh_Àn
 >>= 2; \

475 
hashv
 = 0xcafebabe; \

478 ;
_sfh_Àn
 > 0; _sfh_len--) { \

479 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

480 
_sfh_tmp
 = (
uöt32_t
)(
	`gë16bôs
 (
_sfh_key
+2)Ë<< 11 ^ 
hashv
; \

481 
hashv
 = (hashv << 16Ë^ 
_sfh_tmp
; \

482 
_sfh_key
 +2* (
uöt16_t
); \

483 
hashv
 += hashv >> 11; \

487 
_sfh_ªm
) { \

488 3: 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

489 
hashv
 ^= hashv << 16; \

490 
hashv
 ^(
uöt32_t
)(
_sfh_key
[ (
uöt16_t
)] << 18); \

491 
hashv
 += hashv >> 11; \

493 2: 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

494 
hashv
 ^= hashv << 11; \

495 
hashv
 += hashv >> 17; \

497 1: 
hashv
 +*
_sfh_key
; \

498 
hashv
 ^= hashv << 10; \

499 
hashv
 += hashv >> 1; \

503 
hashv
 ^= hashv << 3; \

504 
hashv
 += hashv >> 5; \

505 
hashv
 ^= hashv << 4; \

506 
hashv
 += hashv >> 17; \

507 
hashv
 ^= hashv << 25; \

508 
hashv
 += hashv >> 6; \

509 
bkt
 = 
hashv
 & (
num_bkts
-1); \

510 
	}
} 0)

	)

512 #ifde‡
HASH_USING_NO_STRICT_ALIASING


522 #i‡(
deföed
(
__i386__
Ë|| deföed(
__x86_64__
Ë|| deföed(
_M_IX86
))

523 
	#MUR_GETBLOCK
(
p
,
i
Ëp[i]

	)

525 
	#MUR_PLUS0_ALIGNED
(
p
Ë(((Ì & 0x3Ë=0)

	)

526 
	#MUR_PLUS1_ALIGNED
(
p
Ë(((Ì & 0x3Ë=1)

	)

527 
	#MUR_PLUS2_ALIGNED
(
p
Ë(((Ì & 0x3Ë=2)

	)

528 
	#MUR_PLUS3_ALIGNED
(
p
Ë(((Ì & 0x3Ë=3)

	)

529 
	#WP
(
p
Ë((
uöt32_t
*)(()’Ë& ~3UL))

	)

530 #i‡(
deföed
(
__BIG_ENDIAN__
Ë|| deföed(
SPARC
Ë|| deföed(
__µc__
Ë|| deföed(
__µc64__
))

531 
	#MUR_THREE_ONE
(
p
Ë((((*
	`WP
’))&0x00ffffffË<< 8Ë| (((*(WP’)+1))&0xff000000Ë>> 24))

	)

532 
	#MUR_TWO_TWO
(
p
Ë((((*
	`WP
’))&0x0000ffffË<<16Ë| (((*(WP’)+1))&0xffff0000Ë>> 16))

	)

533 
	#MUR_ONE_THREE
(
p
Ë((((*
	`WP
’))&0x000000ffË<<24Ë| (((*(WP’)+1))&0xffffff00Ë>> 8))

	)

535 
	#MUR_THREE_ONE
(
p
Ë((((*
	`WP
’))&0xffffff00Ë>> 8Ë| (((*(WP’)+1))&0x000000ffË<< 24))

	)

536 
	#MUR_TWO_TWO
(
p
Ë((((*
	`WP
’))&0xffff0000Ë>>16Ë| (((*(WP’)+1))&0x0000ffffË<< 16))

	)

537 
	#MUR_ONE_THREE
(
p
Ë((((*
	`WP
’))&0xff000000Ë>>24Ë| (((*(WP’)+1))&0x00ffffffË<< 8))

	)

539 
	#MUR_GETBLOCK
(
p
,
i
Ë(
	`MUR_PLUS0_ALIGNED
(p) ? ((p)[i]) : \

540 (
	`MUR_PLUS1_ALIGNED
(
p
Ë? 
	`MUR_THREE_ONE
(p) : \

541 (
	`MUR_PLUS2_ALIGNED
(
p
Ë? 
	`MUR_TWO_TWO
(p) : \

542 
	`MUR_ONE_THREE
(
p
))))

	)

544 
	#MUR_ROTL32
(
x
,
r
Ë(((xË<< (r)Ë| ((xË>> (32 - (r))))

	)

545 
	#MUR_FMIX
(
_h
) \

547 
_h
 ^= _h >> 16; \

548 
_h
 *= 0x85ebca6b; \

549 
_h
 ^= _h >> 13; \

550 
_h
 *= 0xc2b2ae35l; \

551 
_h
 ^= _h >> 16; \

552 } 0)

	)

554 
	#HASH_MUR
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

556 c⁄° 
uöt8_t
 *
_mur_d©a
 = (c⁄° uöt8_t*)(
key
); \

557 c⁄° 
_mur_nblocks
 = (
keyÀn
) / 4; \

558 
uöt32_t
 
_mur_h1
 = 0xf88D5353; \

559 
uöt32_t
 
_mur_c1
 = 0xcc9e2d51; \

560 
uöt32_t
 
_mur_c2
 = 0x1b873593; \

561 
uöt32_t
 
_mur_k1
 = 0; \

562 c⁄° 
uöt8_t
 *
_mur_èû
; \

563 c⁄° 
uöt32_t
 *
_mur_blocks
 = (c⁄° uöt32_t*)(
_mur_d©a
+
_mur_nblocks
*4); \

564 
_mur_i
; \

565 
_mur_i
 = -
_mur_nblocks
; _mur_i; _mur_i++) { \

566 
_mur_k1
 = 
	`MUR_GETBLOCK
(
_mur_blocks
,
_mur_i
); \

567 
_mur_k1
 *
_mur_c1
; \

568 
_mur_k1
 = 
	`MUR_ROTL32
(_mur_k1,15); \

569 
_mur_k1
 *
_mur_c2
; \

571 
_mur_h1
 ^
_mur_k1
; \

572 
_mur_h1
 = 
	`MUR_ROTL32
(_mur_h1,13); \

573 
_mur_h1
 = _mur_h1*5+0xe6546b64; \

575 
_mur_èû
 = (c⁄° 
uöt8_t
*)(
_mur_d©a
 + 
_mur_nblocks
*4); \

576 
_mur_k1
=0; \

577 (
keyÀn
) & 3) { \

578 3: 
_mur_k1
 ^
_mur_èû
[2] << 16; \

579 2: 
_mur_k1
 ^
_mur_èû
[1] << 8; \

580 1: 
_mur_k1
 ^
_mur_èû
[0]; \

581 
_mur_k1
 *
_mur_c1
; \

582 
_mur_k1
 = 
	`MUR_ROTL32
(_mur_k1,15); \

583 
_mur_k1
 *
_mur_c2
; \

584 
_mur_h1
 ^
_mur_k1
; \

586 
_mur_h1
 ^(
keyÀn
); \

587 
	`MUR_FMIX
(
_mur_h1
); \

588 
hashv
 = 
_mur_h1
; \

589 
bkt
 = 
hashv
 & (
num_bkts
-1); \

590 } 0)

	)

594 
	#HASH_KEYCMP
(
a
,
b
,
Àn
Ë
	`memcmp
◊,b,Àn)

	)

597 
	#HASH_FIND_IN_BKT
(
tbl
,
hh
,
hód
,
key±r
,
keyÀn_ö
,
out
) \

599 i‡(
hód
.
hh_hód
Ë
	`DECLTYPE_ASSIGN
(
out
,
	`ELMT_FROM_HH
(
tbl
,head.hh_head)); \

600 
out
=
NULL
; \

601 
out
) { \

602 i‡((
out
)->
hh
.
keyÀn
 =
keyÀn_ö
) { \

603 i‡((
	`HASH_KEYCMP
((
out
)->
hh
.
key
,
key±r
,
keyÀn_ö
)) == 0) ; \

605 i‡((
out
)->
hh
.
hh_√xt
Ë
	`DECLTYPE_ASSIGN
(out,
	`ELMT_FROM_HH
(
tbl
,(out)->hh.hh_next)); \

606 
out
 = 
NULL
; \

608 } 0)

	)

611 
	#HASH_ADD_TO_BKT
(
hód
,
addhh
) \

613 
hód
.
cou¡
++; \

614 (
addhh
)->
hh_√xt
 = 
hód
.
hh_hód
; \

615 (
addhh
)->
hh_¥ev
 = 
NULL
; \

616 i‡(
hód
.
hh_hód
Ë{ (hód).hh_hód->
hh_¥ev
 = (
addhh
); } \

617 (
hód
).
hh_hód
=
addhh
; \

618 i‡(
hód
.
cou¡
 >((hód.
ex∑nd_mu…
+1Ë* 
HASH_BKT_CAPACITY_THRESH
) \

619 && (
addhh
)->
tbl
->
n€x∑nd
 != 1) { \

620 
	`HASH_EXPAND_BUCKETS
((
addhh
)->
tbl
); \

622 } 0)

	)

625 
	#HASH_DEL_IN_BKT
(
hh
,
hód
,
hh_dñ
) \

626 (
hód
).
cou¡
--; \

627 i‡((
hód
).
hh_hód
 =
hh_dñ
) { \

628 (
hód
).
hh_hód
 = 
hh_dñ
->
hh_√xt
; \

630 i‡(
hh_dñ
->
hh_¥ev
) { \

631 
hh_dñ
->
hh_¥ev
->
hh_√xt
 = hh_del->hh_next; \

633 i‡(
hh_dñ
->
hh_√xt
) { \

634 
hh_dñ
->
hh_√xt
->
hh_¥ev
 = hh_del->hh_prev; \

635 }

	)

666 
	#HASH_EXPAND_BUCKETS
(
tbl
) \

668 
_he_bkt
; \

669 
_he_bkt_i
; \

670 
UT_hash_h™dÀ
 *
_he_thh
, *
_he_hh_nxt
; \

671 
UT_hash_buckë
 *
_he_√w_buckës
, *
_he_√wbkt
; \

672 
_he_√w_buckës
 = (
UT_hash_buckë
*)
	`uthash_mÆloc
( \

673 2 * 
tbl
->
num_buckës
 * (
UT_hash_buckë
)); \

674 i‡(!
_he_√w_buckës
Ë{ 
	`uthash_Áèl
( "out of memory"); } \

675 
	`mem£t
(
_he_√w_buckës
, 0, \

676 2 * 
tbl
->
num_buckës
 * (
UT_hash_buckë
)); \

677 
tbl
->
idól_chaö_maxÀn
 = \

678 (
tbl
->
num_ôems
 >> (tbl->
log2_num_buckës
+1)) + \

679 ((
tbl
->
num_ôems
 & (—bl->
num_buckës
*2)-1)) ? 1 : 0); \

680 
tbl
->
n⁄idól_ôems
 = 0; \

681 
_he_bkt_i
 = 0; _he_bkt_ò< 
tbl
->
num_buckës
; _he_bkt_i++) \

683 
_he_thh
 = 
tbl
->
buckës
[ 
_he_bkt_i
 ].
hh_hód
; \

684 
_he_thh
) { \

685 
_he_hh_nxt
 = 
_he_thh
->
hh_√xt
; \

686 
	`HASH_TO_BKT
–
_he_thh
->
hashv
, 
tbl
->
num_buckës
*2, 
_he_bkt
); \

687 
_he_√wbkt
 = &(
_he_√w_buckës
[ 
_he_bkt
 ]); \

688 i‡(++(
_he_√wbkt
->
cou¡
Ë> 
tbl
->
idól_chaö_maxÀn
) { \

689 
tbl
->
n⁄idól_ôems
++; \

690 
_he_√wbkt
->
ex∑nd_mu…
 = _he_√wbkt->
cou¡
 / \

691 
tbl
->
idól_chaö_maxÀn
; \

693 
_he_thh
->
hh_¥ev
 = 
NULL
; \

694 
_he_thh
->
hh_√xt
 = 
_he_√wbkt
->
hh_hód
; \

695 i‡(
_he_√wbkt
->
hh_hód
Ë_he_√wbkt->hh_hód->
hh_¥ev
 = \

696 
_he_thh
; \

697 
_he_√wbkt
->
hh_hód
 = 
_he_thh
; \

698 
_he_thh
 = 
_he_hh_nxt
; \

701 
	`uthash_‰ì
–
tbl
->
buckës
,Åbl->
num_buckës
*(
UT_hash_buckë
) ); \

702 
tbl
->
num_buckës
 *= 2; \

703 
tbl
->
log2_num_buckës
++; \

704 
tbl
->
buckës
 = 
_he_√w_buckës
; \

705 
tbl
->
öeff_ex∑nds
 = (tbl->
n⁄idól_ôems
 > (tbl->
num_ôems
 >> 1)) ? \

706 (
tbl
->
öeff_ex∑nds
+1) : 0; \

707 i‡(
tbl
->
öeff_ex∑nds
 > 1) { \

708 
tbl
->
n€x∑nd
=1; \

709 
	`uthash_n€x∑nd_fyi
(
tbl
); \

711 
	`uthash_ex∑nd_fyi
(
tbl
); \

712 } 0)

	)

718 
	#HASH_SORT
(
hód
,
cmpf˙
Ë
	`HASH_SRT
(
hh
,hód,cmpf˙)

	)

719 
	#HASH_SRT
(
hh
,
hód
,
cmpf˙
) \

721 
_hs_i
; \

722 
_hs_lo›ög
,
_hs_nmîges
,
_hs_ösize
,
_hs_psize
,
_hs_qsize
; \

723 
UT_hash_h™dÀ
 *
_hs_p
, *
_hs_q
, *
_hs_e
, *
_hs_li°
, *
_hs_èû
; \

724 i‡(
hód
) { \

725 
_hs_ösize
 = 1; \

726 
_hs_lo›ög
 = 1; \

727 
_hs_li°
 = &((
hód
)->
hh
); \

728 
_hs_lo›ög
) { \

729 
_hs_p
 = 
_hs_li°
; \

730 
_hs_li°
 = 
NULL
; \

731 
_hs_èû
 = 
NULL
; \

732 
_hs_nmîges
 = 0; \

733 
_hs_p
) { \

734 
_hs_nmîges
++; \

735 
_hs_q
 = 
_hs_p
; \

736 
_hs_psize
 = 0; \

737  
_hs_i
 = 0; _hs_ò< 
_hs_ösize
; _hs_i++ ) { \

738 
_hs_psize
++; \

739 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

740 ((*)((*)(
_hs_q
->
√xt
) + \

741 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

742 i‡(! (
_hs_q
) ) ; \

744 
_hs_qsize
 = 
_hs_ösize
; \

745 (
_hs_psize
 > 0Ë|| ((
_hs_qsize
 > 0Ë&& 
_hs_q
 )) { \

746 i‡(
_hs_psize
 == 0) { \

747 
_hs_e
 = 
_hs_q
; \

748 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

749 ((*)((*)(
_hs_q
->
√xt
) + \

750 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

751 
_hs_qsize
--; \

752 } i‡–(
_hs_qsize
 =0Ë|| !(
_hs_q
) ) { \

753 
_hs_e
 = 
_hs_p
; \

754 i‡(
_hs_p
){ \

755 
_hs_p
 = (
UT_hash_h™dÀ
*)((_hs_p->
√xt
) ? \

756 ((*)((*)(
_hs_p
->
√xt
) + \

757 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

759 
_hs_psize
--; \

761 
	`cmpf˙
(
	`DECLTYPE
(
hód
)(
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
,
_hs_p
)), \

762 
	`DECLTYPE
(
hód
)(
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
,
_hs_q
))) \

764 
_hs_e
 = 
_hs_p
; \

765 i‡(
_hs_p
){ \

766 
_hs_p
 = (
UT_hash_h™dÀ
*)((_hs_p->
√xt
) ? \

767 ((*)((*)(
_hs_p
->
√xt
) + \

768 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

770 
_hs_psize
--; \

772 
_hs_e
 = 
_hs_q
; \

773 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

774 ((*)((*)(
_hs_q
->
√xt
) + \

775 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

776 
_hs_qsize
--; \

778 i‡–
_hs_èû
 ) { \

779 
_hs_èû
->
√xt
 = ((
_hs_e
) ? \

780 
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,
_hs_e
Ë: 
NULL
); \

782 
_hs_li°
 = 
_hs_e
; \

784 i‡(
_hs_e
) { \

785 
_hs_e
->
¥ev
 = ((
_hs_èû
) ? \

786 
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,
_hs_èû
Ë: 
NULL
); \

788 
_hs_èû
 = 
_hs_e
; \

790 
_hs_p
 = 
_hs_q
; \

792 i‡(
_hs_èû
){ \

793 
_hs_èû
->
√xt
 = 
NULL
; \

795 i‡–
_hs_nmîges
 <= 1 ) { \

796 
_hs_lo›ög
=0; \

797 (
hód
)->
hh
.
tbl
->
èû
 = 
_hs_èû
; \

798 
	`DECLTYPE_ASSIGN
(
hód
,
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
, 
_hs_li°
)); \

800 
_hs_ösize
 *= 2; \

802 
	`HASH_FSCK
(
hh
,
hód
); \

804 } 0)

	)

811 
	#HASH_SELECT
(
hh_d°
, 
d°
, 
hh_§c
, 
§c
, 
c⁄d
) \

813 
_§c_bkt
, 
_d°_bkt
; \

814 *
_œ°_ñt
=
NULL
, *
_ñt
; \

815 
UT_hash_h™dÀ
 *
_§c_hh
, *
_d°_hh
, *
_œ°_ñt_hh
=
NULL
; \

816 
±rdiff_t
 
_d°_hho
 = ((*)(&(
d°
)->
hh_d°
) - (*)(dst)); \

817 i‡(
§c
) { \

818 
_§c_bkt
=0; _§c_bkà< (
§c
)->
hh_§c
.
tbl
->
num_buckës
; _src_bkt++) { \

819 
_§c_hh
 = (
§c
)->
hh_§c
.
tbl
->
buckës
[
_§c_bkt
].
hh_hód
; \

820 
_§c_hh
; \

821 
_§c_hh
 = _§c_hh->
hh_√xt
) { \

822 
_ñt
 = 
	`ELMT_FROM_HH
((
§c
)->
hh_§c
.
tbl
, 
_§c_hh
); \

823 i‡(
	`c⁄d
(
_ñt
)) { \

824 
_d°_hh
 = (
UT_hash_h™dÀ
*)(((*)
_ñt
Ë+ 
_d°_hho
); \

825 
_d°_hh
->
key
 = 
_§c_hh
->key; \

826 
_d°_hh
->
keyÀn
 = 
_§c_hh
->keylen; \

827 
_d°_hh
->
hashv
 = 
_§c_hh
->hashv; \

828 
_d°_hh
->
¥ev
 = 
_œ°_ñt
; \

829 
_d°_hh
->
√xt
 = 
NULL
; \

830 i‡(
_œ°_ñt_hh
Ë{ _œ°_ñt_hh->
√xt
 = 
_ñt
; } \

831 i‡(!
d°
) { \

832 
	`DECLTYPE_ASSIGN
(
d°
,
_ñt
); \

833 
	`HASH_MAKE_TABLE
(
hh_d°
,
d°
); \

835 
_d°_hh
->
tbl
 = (
d°
)->
hh_d°
.tbl; \

837 
	`HASH_TO_BKT
(
_d°_hh
->
hashv
, _d°_hh->
tbl
->
num_buckës
, 
_d°_bkt
); \

838 
	`HASH_ADD_TO_BKT
(
_d°_hh
->
tbl
->
buckës
[
_d°_bkt
],_dst_hh); \

839 (
d°
)->
hh_d°
.
tbl
->
num_ôems
++; \

840 
_œ°_ñt
 = 
_ñt
; \

841 
_œ°_ñt_hh
 = 
_d°_hh
; \

846 
	`HASH_FSCK
(
hh_d°
,
d°
); \

847 } 0)

	)

849 
	#HASH_CLEAR
(
hh
,
hód
) \

851 i‡(
hód
) { \

852 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
->
buckës
, \

853 (
hód
)->
hh
.
tbl
->
num_buckës
*(
UT_hash_buckë
)); \

854 
	`HASH_BLOOM_FREE
((
hód
)->
hh
.
tbl
); \

855 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
, (
UT_hash_èbÀ
)); \

856 (
hód
)=
NULL
; \

858 } 0)

	)

860 
	#HASH_OVERHEAD
(
hh
,
hód
) \

861 (
size_t
)((((
hód
)->
hh
.
tbl
->
num_ôems
 * (
UT_hash_h™dÀ
)) + \

862 ((
hód
)->
hh
.
tbl
->
num_buckës
 * (
UT_hash_buckë
)) + \

863 ((
UT_hash_èbÀ
)) + \

864 (
HASH_BLOOM_BYTELEN
)))

	)

866 #ifde‡
NO_DECLTYPE


867 
	#HASH_ITER
(
hh
,
hód
,
ñ
,
tmp
) \

868 (
ñ
)=(
hód
), (*(**)(&(
tmp
)))=(*)((hód)?(hód)->
hh
.
√xt
:
NULL
); \

869 
ñ
; (ñ)=(
tmp
),(*(**)(&—mp)))=(*)(—mp)?—mp)->
hh
.
√xt
:
NULL
))

	)

871 
	#HASH_ITER
(
hh
,
hód
,
ñ
,
tmp
) \

872 (
ñ
)=(
hód
),(
tmp
)=
	`DECLTYPE
”l)((hód)?(hód)->
hh
.
√xt
:
NULL
); \

873 
ñ
; (ñ)=(
tmp
),—mp)=
	`DECLTYPE
”l)(—mp)?—mp)->
hh
.
√xt
:
NULL
))

	)

877 
	#HASH_COUNT
(
hód
Ë
	`HASH_CNT
(
hh
,hód)

	)

878 
	#HASH_CNT
(
hh
,
hód
Ë((hód)?((hód)->hh.
tbl
->
num_ôems
):0)

	)

880 
	sUT_hash_buckë
 {

881 
UT_hash_h™dÀ
 *
	mhh_hód
;

882 
	mcou¡
;

896 
	mex∑nd_mu…
;

898 } 
	tUT_hash_buckë
;

901 
	#HASH_SIGNATURE
 0xa0111„1

	)

902 
	#HASH_BLOOM_SIGNATURE
 0xb12220f2

	)

904 
	sUT_hash_èbÀ
 {

905 
UT_hash_buckë
 *
	mbuckës
;

906 
	mnum_buckës
, 
	mlog2_num_buckës
;

907 
	mnum_ôems
;

908 
UT_hash_h™dÀ
 *
	mèû
;

909 
±rdiff_t
 
	mhho
;

913 
	midól_chaö_maxÀn
;

918 
	mn⁄idól_ôems
;

926 
	möeff_ex∑nds
, 
	mn€x∑nd
;

928 
uöt32_t
 
	msig«tuª
;

929 #ifde‡
HASH_BLOOM


930 
uöt32_t
 
	mbloom_sig
;

931 
uöt8_t
 *
	mbloom_bv
;

932 
	mbloom_nbôs
;

935 } 
	tUT_hash_èbÀ
;

937 
	sUT_hash_h™dÀ
 {

938 
UT_hash_èbÀ
 *
	mtbl
;

939 *
	m¥ev
;

940 *
	m√xt
;

941 
UT_hash_h™dÀ
 *
	mhh_¥ev
;

942 
UT_hash_h™dÀ
 *
	mhh_√xt
;

943 *
	mkey
;

944 
	mkeyÀn
;

945 
	mhashv
;

946 } 
	tUT_hash_h™dÀ
;

	@src/deps/utlist.h

24 #i‚de‡
UTLIST_H


25 
	#UTLIST_H


	)

27 
	#UTLIST_VERSION
 2.1.0

	)

29 
	~<as£π.h
>

66 #i‡!
deföed
(
LDECLTYPE
Ë&& !deföed(
NO_DECLTYPE
)

67 #i‡
deföed
(
_MSC_VER
)

68 #i‡
_MSC_VER
 >1600 && 
deföed
(
__˝lu•lus
)

69 
	#LDECLTYPE
(
x
Ë
	`de˛ty≥
(x)

	)

71 
	#NO_DECLTYPE


	)

73 #ñi‡
deföed
(
__BORLANDC__
Ë|| deföed(
__ICCARM__
Ë|| deföed(
__LCC__
Ë|| deföed(
__WATCOMC__
)

74 
	#NO_DECLTYPE


	)

76 
	#LDECLTYPE
(
x
Ë
	`__ty≥of
(x)

	)

83 #ifde‡
NO_DECLTYPE


84 
	#IF_NO_DECLTYPE
(
x
Ë
	)
x

85 
	#LDECLTYPE
(
x
Ë*

	)

86 
	#UTLIST_SV
(
ñt
,
li°
Ë
_tmp
 = (*)÷i°); {**
_Æüs
 = (**)&÷i°); *_Æü†”…); }

	)

87 
	#UTLIST_NEXT
(
ñt
,
li°
,
√xt
Ë((*)(÷i°)->√xt))

	)

88 
	#UTLIST_NEXTASGN
(
ñt
,
li°
,
to
,
√xt
Ë{ **
_Æüs
 = (**)&(÷i°)->√xt); *_Æüs=(*)—o); }

	)

90 
	#UTLIST_PREVASGN
(
ñt
,
li°
,
to
,
¥ev
Ë{ **
_Æüs
 = (**)&(÷i°)->¥ev); *_Æüs=(*)—o); }

	)

91 
	#UTLIST_RS
(
li°
Ë{ **
_Æüs
 = (**)&÷i°); *_Æüs=
_tmp
; }

	)

92 
	#UTLIST_CASTASGN
(
a
,
b
Ë{ **
_Æüs
 = (**)&◊); *_Æüs=(*)(b); }

	)

94 
	#IF_NO_DECLTYPE
(
x
)

	)

95 
	#UTLIST_SV
(
ñt
,
li°
)

	)

96 
	#UTLIST_NEXT
(
ñt
,
li°
,
√xt
Ë(”…)->√xt)

	)

97 
	#UTLIST_NEXTASGN
(
ñt
,
li°
,
to
,
√xt
Ë(”…)->√xt)=—o)

	)

99 
	#UTLIST_PREVASGN
(
ñt
,
li°
,
to
,
¥ev
Ë(”…)->¥ev)=—o)

	)

100 
	#UTLIST_RS
(
li°
)

	)

101 
	#UTLIST_CASTASGN
(
a
,
b
Ë◊)=(b)

	)

108 
	#LL_SORT
(
li°
, 
cmp
) \

109 
	`LL_SORT2
(
li°
, 
cmp
, 
√xt
)

	)

111 
	#LL_SORT2
(
li°
, 
cmp
, 
√xt
) \

113 
	`LDECLTYPE
(
li°
Ë
_ls_p
; \

114 
	`LDECLTYPE
(
li°
Ë
_ls_q
; \

115 
	`LDECLTYPE
(
li°
Ë
_ls_e
; \

116 
	`LDECLTYPE
(
li°
Ë
_ls_èû
; \

117 
	`IF_NO_DECLTYPE
(
	`LDECLTYPE
(
li°
Ë
_tmp
;) \

118 
_ls_ösize
, 
_ls_nmîges
, 
_ls_psize
, 
_ls_qsize
, 
_ls_i
, 
_ls_lo›ög
; \

119 i‡(
li°
) { \

120 
_ls_ösize
 = 1; \

121 
_ls_lo›ög
 = 1; \

122 
_ls_lo›ög
) { \

123 
	`UTLIST_CASTASGN
(
_ls_p
,
li°
); \

124 (
li°
Ë
NULL
; \

125 
_ls_èû
 = 
NULL
; \

126 
_ls_nmîges
 = 0; \

127 
_ls_p
) { \

128 
_ls_nmîges
++; \

129 
_ls_q
 = 
_ls_p
; \

130 
_ls_psize
 = 0; \

131 
_ls_i
 = 0; _ls_ò< 
_ls_ösize
; _ls_i++) { \

132 
_ls_psize
++; \

133 
	`UTLIST_SV
(
_ls_q
,
li°
); _ls_q = 
	`UTLIST_NEXT
(_ls_q,li°,
√xt
); 
	`UTLIST_RS
(list); \

134 i‡(!
_ls_q
) ; \

136 
_ls_qsize
 = 
_ls_ösize
; \

137 
_ls_psize
 > 0 || (
_ls_qsize
 > 0 && 
_ls_q
)) { \

138 i‡(
_ls_psize
 == 0) { \

139 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

140 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

141 } i‡(
_ls_qsize
 =0 || !
_ls_q
) { \

142 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

143 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

144 } i‡(
	`cmp
(
_ls_p
,
_ls_q
) <= 0) { \

145 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

146 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

148 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

149 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

151 i‡(
_ls_èû
) { \

152 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
_ls_e
,
√xt
); 
	`UTLIST_RS
(list); \

154 
	`UTLIST_CASTASGN
(
li°
,
_ls_e
); \

156 
_ls_èû
 = 
_ls_e
; \

158 
_ls_p
 = 
_ls_q
; \

160 i‡(
_ls_èû
) { \

161 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
NULL
,
√xt
); 
	`UTLIST_RS
(list); \

163 i‡(
_ls_nmîges
 <= 1) { \

164 
_ls_lo›ög
=0; \

166 
_ls_ösize
 *= 2; \

169 } 0)

	)

172 
	#DL_SORT
(
li°
, 
cmp
) \

173 
	`DL_SORT2
(
li°
, 
cmp
, 
¥ev
, 
√xt
)

	)

175 
	#DL_SORT2
(
li°
, 
cmp
, 
¥ev
, 
√xt
) \

177 
	`LDECLTYPE
(
li°
Ë
_ls_p
; \

178 
	`LDECLTYPE
(
li°
Ë
_ls_q
; \

179 
	`LDECLTYPE
(
li°
Ë
_ls_e
; \

180 
	`LDECLTYPE
(
li°
Ë
_ls_èû
; \

181 
	`IF_NO_DECLTYPE
(
	`LDECLTYPE
(
li°
Ë
_tmp
;) \

182 
_ls_ösize
, 
_ls_nmîges
, 
_ls_psize
, 
_ls_qsize
, 
_ls_i
, 
_ls_lo›ög
; \

183 i‡(
li°
) { \

184 
_ls_ösize
 = 1; \

185 
_ls_lo›ög
 = 1; \

186 
_ls_lo›ög
) { \

187 
	`UTLIST_CASTASGN
(
_ls_p
,
li°
); \

188 (
li°
Ë
NULL
; \

189 
_ls_èû
 = 
NULL
; \

190 
_ls_nmîges
 = 0; \

191 
_ls_p
) { \

192 
_ls_nmîges
++; \

193 
_ls_q
 = 
_ls_p
; \

194 
_ls_psize
 = 0; \

195 
_ls_i
 = 0; _ls_ò< 
_ls_ösize
; _ls_i++) { \

196 
_ls_psize
++; \

197 
	`UTLIST_SV
(
_ls_q
,
li°
); _ls_q = 
	`UTLIST_NEXT
(_ls_q,li°,
√xt
); 
	`UTLIST_RS
(list); \

198 i‡(!
_ls_q
) ; \

200 
_ls_qsize
 = 
_ls_ösize
; \

201 (
_ls_psize
 > 0Ë|| ((
_ls_qsize
 > 0Ë&& 
_ls_q
)) { \

202 i‡(
_ls_psize
 == 0) { \

203 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

204 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

205 } i‡((
_ls_qsize
 =0Ë|| (!
_ls_q
)) { \

206 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

207 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

208 } i‡(
	`cmp
(
_ls_p
,
_ls_q
) <= 0) { \

209 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

210 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

212 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

213 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

215 i‡(
_ls_èû
) { \

216 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
_ls_e
,
√xt
); 
	`UTLIST_RS
(list); \

218 
	`UTLIST_CASTASGN
(
li°
,
_ls_e
); \

220 
	`UTLIST_SV
(
_ls_e
,
li°
); 
	`UTLIST_PREVASGN
(_ls_e,li°,
_ls_èû
,
¥ev
); 
	`UTLIST_RS
(list); \

221 
_ls_èû
 = 
_ls_e
; \

223 
_ls_p
 = 
_ls_q
; \

225 
	`UTLIST_CASTASGN
((
li°
)->
¥ev
, 
_ls_èû
); \

226 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
NULL
,
√xt
); 
	`UTLIST_RS
(list); \

227 i‡(
_ls_nmîges
 <= 1) { \

228 
_ls_lo›ög
=0; \

230 
_ls_ösize
 *= 2; \

233 } 0)

	)

235 
	#CDL_SORT
(
li°
, 
cmp
) \

236 
	`CDL_SORT2
(
li°
, 
cmp
, 
¥ev
, 
√xt
)

	)

238 
	#CDL_SORT2
(
li°
, 
cmp
, 
¥ev
, 
√xt
) \

240 
	`LDECLTYPE
(
li°
Ë
_ls_p
; \

241 
	`LDECLTYPE
(
li°
Ë
_ls_q
; \

242 
	`LDECLTYPE
(
li°
Ë
_ls_e
; \

243 
	`LDECLTYPE
(
li°
Ë
_ls_èû
; \

244 
	`LDECLTYPE
(
li°
Ë
_ls_ﬁdhód
; \

245 
	`LDECLTYPE
(
li°
Ë
_tmp
; \

246 
_ls_ösize
, 
_ls_nmîges
, 
_ls_psize
, 
_ls_qsize
, 
_ls_i
, 
_ls_lo›ög
; \

247 i‡(
li°
) { \

248 
_ls_ösize
 = 1; \

249 
_ls_lo›ög
 = 1; \

250 
_ls_lo›ög
) { \

251 
	`UTLIST_CASTASGN
(
_ls_p
,
li°
); \

252 
	`UTLIST_CASTASGN
(
_ls_ﬁdhód
,
li°
); \

253 (
li°
Ë
NULL
; \

254 
_ls_èû
 = 
NULL
; \

255 
_ls_nmîges
 = 0; \

256 
_ls_p
) { \

257 
_ls_nmîges
++; \

258 
_ls_q
 = 
_ls_p
; \

259 
_ls_psize
 = 0; \

260 
_ls_i
 = 0; _ls_ò< 
_ls_ösize
; _ls_i++) { \

261 
_ls_psize
++; \

262 
	`UTLIST_SV
(
_ls_q
,
li°
); \

263 i‡(
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
Ë=
_ls_ﬁdhód
) { \

264 
_ls_q
 = 
NULL
; \

266 
_ls_q
 = 
	`UTLIST_NEXT
(_ls_q,
li°
,
√xt
); \

268 
	`UTLIST_RS
(
li°
); \

269 i‡(!
_ls_q
) ; \

271 
_ls_qsize
 = 
_ls_ösize
; \

272 
_ls_psize
 > 0 || (
_ls_qsize
 > 0 && 
_ls_q
)) { \

273 i‡(
_ls_psize
 == 0) { \

274 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

275 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

276 i‡(
_ls_q
 =
_ls_ﬁdhód
Ë{ _ls_q = 
NULL
; } \

277 } i‡(
_ls_qsize
 =0 || !
_ls_q
) { \

278 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

279 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

280 i‡(
_ls_p
 =
_ls_ﬁdhód
Ë{ _ls_∞
NULL
; } \

281 } i‡(
	`cmp
(
_ls_p
,
_ls_q
) <= 0) { \

282 
_ls_e
 = 
_ls_p
; 
	`UTLIST_SV
(_ls_p,
li°
); _ls_p = \

283 
	`UTLIST_NEXT
(
_ls_p
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_psize
--; \

284 i‡(
_ls_p
 =
_ls_ﬁdhód
Ë{ _ls_∞
NULL
; } \

286 
_ls_e
 = 
_ls_q
; 
	`UTLIST_SV
(_ls_q,
li°
); _ls_q = \

287 
	`UTLIST_NEXT
(
_ls_q
,
li°
,
√xt
); 
	`UTLIST_RS
÷i°); 
_ls_qsize
--; \

288 i‡(
_ls_q
 =
_ls_ﬁdhód
Ë{ _ls_q = 
NULL
; } \

290 i‡(
_ls_èû
) { \

291 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
_ls_e
,
√xt
); 
	`UTLIST_RS
(list); \

293 
	`UTLIST_CASTASGN
(
li°
,
_ls_e
); \

295 
	`UTLIST_SV
(
_ls_e
,
li°
); 
	`UTLIST_PREVASGN
(_ls_e,li°,
_ls_èû
,
¥ev
); 
	`UTLIST_RS
(list); \

296 
_ls_èû
 = 
_ls_e
; \

298 
_ls_p
 = 
_ls_q
; \

300 
	`UTLIST_CASTASGN
((
li°
)->
¥ev
,
_ls_èû
); \

301 
	`UTLIST_CASTASGN
(
_tmp
,
li°
); \

302 
	`UTLIST_SV
(
_ls_èû
,
li°
); 
	`UTLIST_NEXTASGN
(_ls_èû,li°,
_tmp
,
√xt
); 
	`UTLIST_RS
(list); \

303 i‡(
_ls_nmîges
 <= 1) { \

304 
_ls_lo›ög
=0; \

306 
_ls_ösize
 *= 2; \

309 } 0)

	)

314 
	#LL_PREPEND
(
hód
,
add
) \

315 
	`LL_PREPEND2
(
hód
,
add
,
√xt
)

	)

317 
	#LL_PREPEND2
(
hód
,
add
,
√xt
) \

319 (
add
)->
√xt
 = (
hód
); \

320 (
hód
Ë(
add
); \

321 } 0)

	)

323 
	#LL_CONCAT
(
hód1
,
hód2
) \

324 
	`LL_CONCAT2
(
hód1
,
hód2
,
√xt
)

	)

326 
	#LL_CONCAT2
(
hód1
,
hód2
,
√xt
) \

328 
	`LDECLTYPE
(
hód1
Ë
_tmp
; \

329 i‡(
hód1
) { \

330 
_tmp
 = (
hód1
); \

331 
_tmp
->
√xt
) { _tmp = _tmp->next; } \

332 
_tmp
->
√xt
=(
hód2
); \

334 (
hód1
)=(
hód2
); \

336 } 0)

	)

338 
	#LL_APPEND
(
hód
,
add
) \

339 
	`LL_APPEND2
(
hód
,
add
,
√xt
)

	)

341 
	#LL_APPEND2
(
hód
,
add
,
√xt
) \

343 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

344 (
add
)->
√xt
=
NULL
; \

345 i‡(
hód
) { \

346 
_tmp
 = (
hód
); \

347 
_tmp
->
√xt
) { _tmp = _tmp->next; } \

348 
_tmp
->
√xt
=(
add
); \

350 (
hód
)=(
add
); \

352 } 0)

	)

354 
	#LL_INSERT_INORDER
(
hód
,
add
,
cmp
) \

355 
	`LL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
√xt
)

	)

357 
	#LL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
√xt
) \

359 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

360 i‡(
hód
) { \

361 
	`LL_LOWER_BOUND2
(
hód
, 
_tmp
, 
add
, 
cmp
, 
√xt
); \

362 
	`LL_APPEND_ELEM2
(
hód
, 
_tmp
, 
add
, 
√xt
); \

364 (
hód
Ë(
add
); \

365 (
hód
)->
√xt
 = 
NULL
; \

367 } 0)

	)

369 
	#LL_LOWER_BOUND
(
hód
,
ñt
,
like
,
cmp
) \

370 
	`LL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
)

	)

372 
	#LL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
) \

374 i‡((
hód
Ë=
NULL
 || (
	`cmp
(hód, 
like
)) >= 0) { \

375 (
ñt
Ë
NULL
; \

377 (
ñt
Ë(
hód
); (ñt)->
√xt
 !
NULL
; (elt) = (elt)->next) { \

378 i‡(
	`cmp
((
ñt
)->
√xt
, 
like
) >= 0) { \

383 } 0)

	)

385 
	#LL_DELETE
(
hód
,
dñ
) \

386 
	`LL_DELETE2
(
hód
,
dñ
,
√xt
)

	)

388 
	#LL_DELETE2
(
hód
,
dñ
,
√xt
) \

390 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

391 i‡((
hód
Ë=(
dñ
)) { \

392 (
hód
)=(hód)->
√xt
; \

394 
_tmp
 = (
hód
); \

395 
_tmp
->
√xt
 && (_tmp->√xà!(
dñ
))) { \

396 
_tmp
 = _tmp->
√xt
; \

398 i‡(
_tmp
->
√xt
) { \

399 
_tmp
->
√xt
 = (
dñ
)->next; \

402 } 0)

	)

404 
	#LL_COUNT
(
hód
,
ñ
,
cou¡î
) \

405 
	`LL_COUNT2
(
hód
,
ñ
,
cou¡î
,
√xt
) \

406 

	)

407 
	#LL_COUNT2
(
hód
,
ñ
,
cou¡î
,
√xt
) \

409 (
cou¡î
) = 0; \

410 
	`LL_FOREACH2
(
hód
,
ñ
,
√xt
Ë{ ++(
cou¡î
); } \

411 } 0)

	)

413 
	#LL_FOREACH
(
hód
,
ñ
) \

414 
	`LL_FOREACH2
(
hód
,
ñ
,
√xt
)

	)

416 
	#LL_FOREACH2
(
hód
,
ñ
,
√xt
) \

417 (
ñ
Ë(
hód
);Él; (ñË”l)->
√xt
)

	)

419 
	#LL_FOREACH_SAFE
(
hód
,
ñ
,
tmp
) \

420 
	`LL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp
,
√xt
)

	)

422 
	#LL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp
,
√xt
) \

423 (
ñ
Ë(
hód
); (ñË&& ((
tmp
Ë”l)->
√xt
, 1); (ñË—mp))

	)

425 
	#LL_SEARCH_SCALAR
(
hód
,
out
,
fõld
,
vÆ
) \

426 
	`LL_SEARCH_SCALAR2
(
hód
,
out
,
fõld
,
vÆ
,
√xt
)

	)

428 
	#LL_SEARCH_SCALAR2
(
hód
,
out
,
fõld
,
vÆ
,
√xt
) \

430 
	`LL_FOREACH2
(
hód
,
out
,
√xt
) { \

431 i‡((
out
)->
fõld
 =(
vÆ
)) ; \

433 } 0)

	)

435 
	#LL_SEARCH
(
hód
,
out
,
ñt
,
cmp
) \

436 
	`LL_SEARCH2
(
hód
,
out
,
ñt
,
cmp
,
√xt
)

	)

438 
	#LL_SEARCH2
(
hód
,
out
,
ñt
,
cmp
,
√xt
) \

440 
	`LL_FOREACH2
(
hód
,
out
,
√xt
) { \

441 i‡((
	`cmp
(
out
,
ñt
))==0) ; \

443 } 0)

	)

445 
	#LL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
) \

447 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

448 
	`as£π
((
hód
Ë!
NULL
); \

449 
	`as£π
((
ñ
Ë!
NULL
); \

450 
	`as£π
((
add
Ë!
NULL
); \

451 (
add
)->
√xt
 = (
ñ
)->next; \

452 i‡((
hód
Ë=(
ñ
)) { \

453 (
hód
Ë(
add
); \

455 
_tmp
 = (
hód
); \

456 
_tmp
->
√xt
 && (_tmp->√xà!(
ñ
))) { \

457 
_tmp
 = _tmp->
√xt
; \

459 i‡(
_tmp
->
√xt
) { \

460 
_tmp
->
√xt
 = (
add
); \

463 } 0)

	)

465 
	#LL_REPLACE_ELEM
(
hód
, 
ñ
, 
add
) \

466 
	`LL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
)

	)

468 
	#LL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
) \

470 i‡(
ñ
) { \

471 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

472 
	`as£π
((
hód
Ë!
NULL
); \

473 
	`as£π
((
add
Ë!
NULL
); \

474 (
add
)->
√xt
 = (
ñ
); \

475 i‡((
hód
Ë=(
ñ
)) { \

476 (
hód
Ë(
add
); \

478 
_tmp
 = (
hód
); \

479 
_tmp
->
√xt
 && (_tmp->√xà!(
ñ
))) { \

480 
_tmp
 = _tmp->
√xt
; \

482 i‡(
_tmp
->
√xt
) { \

483 
_tmp
->
√xt
 = (
add
); \

487 
	`LL_APPEND2
(
hód
, 
add
, 
√xt
); \

490 

	)

491 
	#LL_PREPEND_ELEM
(
hód
, 
ñ
, 
add
) \

492 
	`LL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
)

	)

494 
	#LL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
) \

496 i‡(
ñ
) { \

497 
	`as£π
((
hód
Ë!
NULL
); \

498 
	`as£π
((
add
Ë!
NULL
); \

499 (
add
)->
√xt
 = (
ñ
)->next; \

500 (
ñ
)->
√xt
 = (
add
); \

502 
	`LL_PREPEND2
(
hód
, 
add
, 
√xt
); \

505 

	)

506 
	#LL_APPEND_ELEM
(
hód
, 
ñ
, 
add
) \

507 
	`LL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
)

	)

509 #ifde‡
NO_DECLTYPE


512 #unde‡
LL_CONCAT2


513 
	#LL_CONCAT2
(
hód1
,
hód2
,
√xt
) \

515 *
_tmp
; \

516 i‡(
hód1
) { \

517 
_tmp
 = (*)(
hód1
); \

518 (
hód1
)->
√xt
) { (head1) = (head1)->next; } \

519 (
hód1
)->
√xt
 = (
hód2
); \

520 
	`UTLIST_RS
(
hód1
); \

522 (
hód1
)=(
hód2
); \

524 } 0)

	)

526 #unde‡
LL_APPEND2


527 
	#LL_APPEND2
(
hód
,
add
,
√xt
) \

529 i‡(
hód
) { \

530 (
add
)->
√xt
 = 
hód
; \

531 (
add
)->
√xt
->next) { (add)->next = (add)->next->next; } \

532 (
add
)->
√xt
->next=(add); \

534 (
hód
)=(
add
); \

536 (
add
)->
√xt
=
NULL
; \

537 } 0)

	)

539 #unde‡
LL_INSERT_INORDER2


540 
	#LL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
√xt
) \

542 i‡((
hód
Ë=
NULL
 || (
	`cmp
(hód, 
add
)) >= 0) { \

543 (
add
)->
√xt
 = (
hód
); \

544 (
hód
Ë(
add
); \

546 *
_tmp
 = (*)(
hód
); \

547 (
hód
)->
√xt
 !
NULL
 && (
	`cmp
((hód)->√xt, 
add
)) < 0) { \

548 (
hód
Ë(hód)->
√xt
; \

550 (
add
)->
√xt
 = (
hód
)->next; \

551 (
hód
)->
√xt
 = (
add
); \

552 
	`UTLIST_RS
(
hód
); \

554 } 0)

	)

556 #unde‡
LL_DELETE2


557 
	#LL_DELETE2
(
hód
,
dñ
,
√xt
) \

559 i‡((
hód
Ë=(
dñ
)) { \

560 (
hód
)=(hód)->
√xt
; \

562 *
_tmp
 = (*)(
hód
); \

563 (
hód
)->
√xt
 && ((hód)->√xà!(
dñ
))) { \

564 (
hód
Ë(hód)->
√xt
; \

566 i‡((
hód
)->
√xt
) { \

567 (
hód
)->
√xt
 = ((
dñ
)->next); \

569 
	`UTLIST_RS
(
hód
); \

571 } 0)

	)

573 #unde‡
LL_REPLACE_ELEM2


574 
	#LL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
) \

576 
	`as£π
((
hód
Ë!
NULL
); \

577 
	`as£π
((
ñ
Ë!
NULL
); \

578 
	`as£π
((
add
Ë!
NULL
); \

579 i‡((
hód
Ë=(
ñ
)) { \

580 (
hód
Ë(
add
); \

582 (
add
)->
√xt
 = 
hód
; \

583 (
add
)->
√xt
->√xà&& (◊dd)->√xt->√xà!(
ñ
))) { \

584 (
add
)->
√xt
 = (add)->next->next; \

586 i‡((
add
)->
√xt
->next) { \

587 (
add
)->
√xt
->next = (add); \

590 (
add
)->
√xt
 = (
ñ
)->next; \

591 } 0)

	)

593 #unde‡
LL_PREPEND_ELEM2


594 
	#LL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
√xt
) \

596 i‡(
ñ
) { \

597 
	`as£π
((
hód
Ë!
NULL
); \

598 
	`as£π
((
add
Ë!
NULL
); \

599 i‡((
hód
Ë=(
ñ
)) { \

600 (
hód
Ë(
add
); \

602 (
add
)->
√xt
 = (
hód
); \

603 (
add
)->
√xt
->√xà&& (◊dd)->√xt->√xà!(
ñ
))) { \

604 (
add
)->
√xt
 = (add)->next->next; \

606 i‡((
add
)->
√xt
->next) { \

607 (
add
)->
√xt
->next = (add); \

610 (
add
)->
√xt
 = (
ñ
); \

612 
	`LL_APPEND2
(
hód
, 
add
, 
√xt
); \

615 

	)

621 
	#DL_PREPEND
(
hód
,
add
) \

622 
	`DL_PREPEND2
(
hód
,
add
,
¥ev
,
√xt
)

	)

624 
	#DL_PREPEND2
(
hód
,
add
,
¥ev
,
√xt
) \

626 (
add
)->
√xt
 = (
hód
); \

627 i‡(
hód
) { \

628 (
add
)->
¥ev
 = (
hód
)->prev; \

629 (
hód
)->
¥ev
 = (
add
); \

631 (
add
)->
¥ev
 = (add); \

633 (
hód
Ë(
add
); \

634 } 0)

	)

636 
	#DL_APPEND
(
hód
,
add
) \

637 
	`DL_APPEND2
(
hód
,
add
,
¥ev
,
√xt
)

	)

639 
	#DL_APPEND2
(
hód
,
add
,
¥ev
,
√xt
) \

641 i‡(
hód
) { \

642 (
add
)->
¥ev
 = (
hód
)->prev; \

643 (
hód
)->
¥ev
->
√xt
 = (
add
); \

644 (
hód
)->
¥ev
 = (
add
); \

645 (
add
)->
√xt
 = 
NULL
; \

647 (
hód
)=(
add
); \

648 (
hód
)->
¥ev
 = (head); \

649 (
hód
)->
√xt
 = 
NULL
; \

651 } 0)

	)

653 
	#DL_INSERT_INORDER
(
hód
,
add
,
cmp
) \

654 
	`DL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
)

	)

656 
	#DL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
) \

658 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

659 i‡(
hód
) { \

660 
	`DL_LOWER_BOUND2
(
hód
, 
_tmp
, 
add
, 
cmp
, 
√xt
); \

661 
	`DL_APPEND_ELEM2
(
hód
, 
_tmp
, 
add
, 
¥ev
, 
√xt
); \

663 (
hód
Ë(
add
); \

664 (
hód
)->
¥ev
 = (head); \

665 (
hód
)->
√xt
 = 
NULL
; \

667 } 0)

	)

669 
	#DL_LOWER_BOUND
(
hód
,
ñt
,
like
,
cmp
) \

670 
	`DL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
)

	)

672 
	#DL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
) \

674 i‡((
hód
Ë=
NULL
 || (
	`cmp
(hód, 
like
)) >= 0) { \

675 (
ñt
Ë
NULL
; \

677 (
ñt
Ë(
hód
); (ñt)->
√xt
 !
NULL
; (elt) = (elt)->next) { \

678 i‡((
	`cmp
((
ñt
)->
√xt
, 
like
)) >= 0) { \

683 } 0)

	)

685 
	#DL_CONCAT
(
hód1
,
hód2
) \

686 
	`DL_CONCAT2
(
hód1
,
hód2
,
¥ev
,
√xt
)

	)

688 
	#DL_CONCAT2
(
hód1
,
hód2
,
¥ev
,
√xt
) \

690 
	`LDECLTYPE
(
hód1
Ë
_tmp
; \

691 i‡(
hód2
) { \

692 i‡(
hód1
) { \

693 
	`UTLIST_CASTASGN
(
_tmp
, (
hód2
)->
¥ev
); \

694 (
hód2
)->
¥ev
 = (
hód1
)->prev; \

695 (
hód1
)->
¥ev
->
√xt
 = (
hód2
); \

696 
	`UTLIST_CASTASGN
((
hód1
)->
¥ev
, 
_tmp
); \

698 (
hód1
)=(
hód2
); \

701 } 0)

	)

703 
	#DL_DELETE
(
hód
,
dñ
) \

704 
	`DL_DELETE2
(
hód
,
dñ
,
¥ev
,
√xt
)

	)

706 
	#DL_DELETE2
(
hód
,
dñ
,
¥ev
,
√xt
) \

708 
	`as£π
((
hód
Ë!
NULL
); \

709 
	`as£π
((
dñ
)->
¥ev
 !
NULL
); \

710 i‡((
dñ
)->
¥ev
 == (del)) { \

711 (
hód
)=
NULL
; \

712 } i‡((
dñ
)==(
hód
)) { \

713 (
dñ
)->
√xt
->
¥ev
 = (del)->prev; \

714 (
hód
Ë(
dñ
)->
√xt
; \

716 (
dñ
)->
¥ev
->
√xt
 = (del)->next; \

717 i‡((
dñ
)->
√xt
) { \

718 (
dñ
)->
√xt
->
¥ev
 = (del)->prev; \

720 (
hód
)->
¥ev
 = (
dñ
)->prev; \

723 } 0)

	)

725 
	#DL_COUNT
(
hód
,
ñ
,
cou¡î
) \

726 
	`DL_COUNT2
(
hód
,
ñ
,
cou¡î
,
√xt
) \

727 

	)

728 
	#DL_COUNT2
(
hód
,
ñ
,
cou¡î
,
√xt
) \

730 (
cou¡î
) = 0; \

731 
	`DL_FOREACH2
(
hód
,
ñ
,
√xt
Ë{ ++(
cou¡î
); } \

732 } 0)

	)

734 
	#DL_FOREACH
(
hód
,
ñ
) \

735 
	`DL_FOREACH2
(
hód
,
ñ
,
√xt
)

	)

737 
	#DL_FOREACH2
(
hód
,
ñ
,
√xt
) \

738 (
ñ
Ë(
hód
);Él; (ñË”l)->
√xt
)

	)

741 
	#DL_FOREACH_SAFE
(
hód
,
ñ
,
tmp
) \

742 
	`DL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp
,
√xt
)

	)

744 
	#DL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp
,
√xt
) \

745 (
ñ
Ë(
hód
); (ñË&& ((
tmp
Ë”l)->
√xt
, 1); (ñË—mp))

	)

748 
	#DL_SEARCH_SCALAR
 
LL_SEARCH_SCALAR


	)

749 
	#DL_SEARCH
 
LL_SEARCH


	)

750 
	#DL_SEARCH_SCALAR2
 
LL_SEARCH_SCALAR2


	)

751 
	#DL_SEARCH2
 
LL_SEARCH2


	)

753 
	#DL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

755 
	`as£π
((
hód
Ë!
NULL
); \

756 
	`as£π
((
ñ
Ë!
NULL
); \

757 
	`as£π
((
add
Ë!
NULL
); \

758 i‡((
hód
Ë=(
ñ
)) { \

759 (
hód
Ë(
add
); \

760 (
add
)->
√xt
 = (
ñ
)->next; \

761 i‡((
ñ
)->
√xt
 =
NULL
) { \

762 (
add
)->
¥ev
 = (add); \

764 (
add
)->
¥ev
 = (
ñ
)->prev; \

765 (
add
)->
√xt
->
¥ev
 = (add); \

768 (
add
)->
√xt
 = (
ñ
)->next; \

769 (
add
)->
¥ev
 = (
ñ
)->prev; \

770 (
add
)->
¥ev
->
√xt
 = (add); \

771 i‡((
ñ
)->
√xt
 =
NULL
) { \

772 (
hód
)->
¥ev
 = (
add
); \

774 (
add
)->
√xt
->
¥ev
 = (add); \

777 } 0)

	)

779 
	#DL_REPLACE_ELEM
(
hód
, 
ñ
, 
add
) \

780 
	`DL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

782 
	#DL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

784 i‡(
ñ
) { \

785 
	`as£π
((
hód
Ë!
NULL
); \

786 
	`as£π
((
add
Ë!
NULL
); \

787 (
add
)->
√xt
 = (
ñ
); \

788 (
add
)->
¥ev
 = (
ñ
)->prev; \

789 (
ñ
)->
¥ev
 = (
add
); \

790 i‡((
hód
Ë=(
ñ
)) { \

791 (
hód
Ë(
add
); \

793 (
add
)->
¥ev
->
√xt
 = (add); \

796 
	`DL_APPEND2
(
hód
, 
add
, 
¥ev
, 
√xt
); \

799 

	)

800 
	#DL_PREPEND_ELEM
(
hód
, 
ñ
, 
add
) \

801 
	`DL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

803 
	#DL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

805 i‡(
ñ
) { \

806 
	`as£π
((
hód
Ë!
NULL
); \

807 
	`as£π
((
add
Ë!
NULL
); \

808 (
add
)->
√xt
 = (
ñ
)->next; \

809 (
add
)->
¥ev
 = (
ñ
); \

810 (
ñ
)->
√xt
 = (
add
); \

811 i‡((
add
)->
√xt
) { \

812 (
add
)->
√xt
->
¥ev
 = (add); \

814 (
hód
)->
¥ev
 = (
add
); \

817 
	`DL_PREPEND2
(
hód
, 
add
, 
¥ev
, 
√xt
); \

820 

	)

821 
	#DL_APPEND_ELEM
(
hód
, 
ñ
, 
add
) \

822 
	`DL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

824 #ifde‡
NO_DECLTYPE


827 #unde‡
DL_INSERT_INORDER2


828 
	#DL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
) \

830 i‡((
hód
Ë=
NULL
) { \

831 (
add
)->
¥ev
 = (add); \

832 (
add
)->
√xt
 = 
NULL
; \

833 (
hód
Ë(
add
); \

834 } i‡((
	`cmp
(
hód
, 
add
)) >= 0) { \

835 (
add
)->
¥ev
 = (
hód
)->prev; \

836 (
add
)->
√xt
 = (
hód
); \

837 (
hód
)->
¥ev
 = (
add
); \

838 (
hód
Ë(
add
); \

840 *
_tmp
 = (*)(
hód
); \

841 (
hód
)->
√xt
 && (
	`cmp
((hód)->√xt, 
add
)) < 0) { \

842 (
hód
Ë(hód)->
√xt
; \

844 (
add
)->
¥ev
 = (
hód
); \

845 (
add
)->
√xt
 = (
hód
)->next; \

846 (
hód
)->
√xt
 = (
add
); \

847 
	`UTLIST_RS
(
hód
); \

848 i‡((
add
)->
√xt
) { \

849 (
add
)->
√xt
->
¥ev
 = (add); \

851 (
hód
)->
¥ev
 = (
add
); \

854 } 0)

	)

860 
	#CDL_APPEND
(
hód
,
add
) \

861 
	`CDL_APPEND2
(
hód
,
add
,
¥ev
,
√xt
)

	)

863 
	#CDL_APPEND2
(
hód
,
add
,
¥ev
,
√xt
) \

865 i‡(
hód
) { \

866 (
add
)->
¥ev
 = (
hód
)->prev; \

867 (
add
)->
√xt
 = (
hód
); \

868 (
hód
)->
¥ev
 = (
add
); \

869 (
add
)->
¥ev
->
√xt
 = (add); \

871 (
add
)->
¥ev
 = (add); \

872 (
add
)->
√xt
 = (add); \

873 (
hód
Ë(
add
); \

875 } 0)

	)

877 
	#CDL_PREPEND
(
hód
,
add
) \

878 
	`CDL_PREPEND2
(
hód
,
add
,
¥ev
,
√xt
)

	)

880 
	#CDL_PREPEND2
(
hód
,
add
,
¥ev
,
√xt
) \

882 i‡(
hód
) { \

883 (
add
)->
¥ev
 = (
hód
)->prev; \

884 (
add
)->
√xt
 = (
hód
); \

885 (
hód
)->
¥ev
 = (
add
); \

886 (
add
)->
¥ev
->
√xt
 = (add); \

888 (
add
)->
¥ev
 = (add); \

889 (
add
)->
√xt
 = (add); \

891 (
hód
Ë(
add
); \

892 } 0)

	)

894 
	#CDL_INSERT_INORDER
(
hód
,
add
,
cmp
) \

895 
	`CDL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
)

	)

897 
	#CDL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
) \

899 
	`LDECLTYPE
(
hód
Ë
_tmp
; \

900 i‡(
hód
) { \

901 
	`CDL_LOWER_BOUND2
(
hód
, 
_tmp
, 
add
, 
cmp
, 
√xt
); \

902 
	`CDL_APPEND_ELEM2
(
hód
, 
_tmp
, 
add
, 
¥ev
, 
√xt
); \

904 (
hód
Ë(
add
); \

905 (
hód
)->
√xt
 = (head); \

906 (
hód
)->
¥ev
 = (head); \

908 } 0)

	)

910 
	#CDL_LOWER_BOUND
(
hód
,
ñt
,
like
,
cmp
) \

911 
	`CDL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
)

	)

913 
	#CDL_LOWER_BOUND2
(
hód
,
ñt
,
like
,
cmp
,
√xt
) \

915 i‡((
hód
Ë=
NULL
 || (
	`cmp
(hód, 
like
)) >= 0) { \

916 (
ñt
Ë
NULL
; \

918 (
ñt
Ë(
hód
); (ñt)->
√xt
 != (head); (elt) = (elt)->next) { \

919 i‡((
	`cmp
((
ñt
)->
√xt
, 
like
)) >= 0) { \

924 } 0)

	)

926 
	#CDL_DELETE
(
hód
,
dñ
) \

927 
	`CDL_DELETE2
(
hód
,
dñ
,
¥ev
,
√xt
)

	)

929 
	#CDL_DELETE2
(
hód
,
dñ
,
¥ev
,
√xt
) \

931 i‡(((
hód
)==(
dñ
)Ë&& ((hód)->
√xt
 == (head))) { \

932 (
hód
Ë
NULL
; \

934 (
dñ
)->
√xt
->
¥ev
 = (del)->prev; \

935 (
dñ
)->
¥ev
->
√xt
 = (del)->next; \

936 i‡((
dñ
Ë=(
hód
)Ë(hód)=(dñ)->
√xt
; \

938 } 0)

	)

940 
	#CDL_COUNT
(
hód
,
ñ
,
cou¡î
) \

941 
	`CDL_COUNT2
(
hód
,
ñ
,
cou¡î
,
√xt
) \

942 

	)

943 
	#CDL_COUNT2
(
hód
, 
ñ
, 
cou¡î
,
√xt
) \

945 (
cou¡î
) = 0; \

946 
	`CDL_FOREACH2
(
hód
,
ñ
,
√xt
Ë{ ++(
cou¡î
); } \

947 } 0)

	)

949 
	#CDL_FOREACH
(
hód
,
ñ
) \

950 
	`CDL_FOREACH2
(
hód
,
ñ
,
√xt
)

	)

952 
	#CDL_FOREACH2
(
hód
,
ñ
,
√xt
) \

953 (
ñ
)=(
hód
);ñ;”l)=((”l)->
√xt
==(hód)Ë? 
NULL
 : (ñ)->√xt))

	)

955 
	#CDL_FOREACH_SAFE
(
hód
,
ñ
,
tmp1
,
tmp2
) \

956 
	`CDL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp1
,
tmp2
,
¥ev
,
√xt
)

	)

958 
	#CDL_FOREACH_SAFE2
(
hód
,
ñ
,
tmp1
,
tmp2
,
¥ev
,
√xt
) \

959 (
ñ
Ë(
hód
), (
tmp1
Ë(hódË? (hód)->
¥ev
 : 
NULL
; \

960 (
ñ
Ë&& ((
tmp2
Ë”l)->
√xt
, 1); \

961 (
ñ
Ë(”lË=(
tmp1
Ë? 
NULL
 : (
tmp2
)))

	)

963 
	#CDL_SEARCH_SCALAR
(
hód
,
out
,
fõld
,
vÆ
) \

964 
	`CDL_SEARCH_SCALAR2
(
hód
,
out
,
fõld
,
vÆ
,
√xt
)

	)

966 
	#CDL_SEARCH_SCALAR2
(
hód
,
out
,
fõld
,
vÆ
,
√xt
) \

968 
	`CDL_FOREACH2
(
hód
,
out
,
√xt
) { \

969 i‡((
out
)->
fõld
 =(
vÆ
)) ; \

971 } 0)

	)

973 
	#CDL_SEARCH
(
hód
,
out
,
ñt
,
cmp
) \

974 
	`CDL_SEARCH2
(
hód
,
out
,
ñt
,
cmp
,
√xt
)

	)

976 
	#CDL_SEARCH2
(
hód
,
out
,
ñt
,
cmp
,
√xt
) \

978 
	`CDL_FOREACH2
(
hód
,
out
,
√xt
) { \

979 i‡((
	`cmp
(
out
,
ñt
))==0) ; \

981 } 0)

	)

983 
	#CDL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

985 
	`as£π
((
hód
Ë!
NULL
); \

986 
	`as£π
((
ñ
Ë!
NULL
); \

987 
	`as£π
((
add
Ë!
NULL
); \

988 i‡((
ñ
)->
√xt
 == (el)) { \

989 (
add
)->
√xt
 = (add); \

990 (
add
)->
¥ev
 = (add); \

991 (
hód
Ë(
add
); \

993 (
add
)->
√xt
 = (
ñ
)->next; \

994 (
add
)->
¥ev
 = (
ñ
)->prev; \

995 (
add
)->
√xt
->
¥ev
 = (add); \

996 (
add
)->
¥ev
->
√xt
 = (add); \

997 i‡((
hód
Ë=(
ñ
)) { \

998 (
hód
Ë(
add
); \

1001 } 0)

	)

1003 
	#CDL_REPLACE_ELEM
(
hód
, 
ñ
, 
add
) \

1004 
	`CDL_REPLACE_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

1006 
	#CDL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

1008 i‡(
ñ
) { \

1009 
	`as£π
((
hód
Ë!
NULL
); \

1010 
	`as£π
((
add
Ë!
NULL
); \

1011 (
add
)->
√xt
 = (
ñ
); \

1012 (
add
)->
¥ev
 = (
ñ
)->prev; \

1013 (
ñ
)->
¥ev
 = (
add
); \

1014 (
add
)->
¥ev
->
√xt
 = (add); \

1015 i‡((
hód
Ë=(
ñ
)) { \

1016 (
hód
Ë(
add
); \

1019 
	`CDL_APPEND2
(
hód
, 
add
, 
¥ev
, 
√xt
); \

1021 } 0)

	)

1023 
	#CDL_PREPEND_ELEM
(
hód
, 
ñ
, 
add
) \

1024 
	`CDL_PREPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

1026 
	#CDL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
) \

1028 i‡(
ñ
) { \

1029 
	`as£π
((
hód
Ë!
NULL
); \

1030 
	`as£π
((
add
Ë!
NULL
); \

1031 (
add
)->
√xt
 = (
ñ
)->next; \

1032 (
add
)->
¥ev
 = (
ñ
); \

1033 (
ñ
)->
√xt
 = (
add
); \

1034 (
add
)->
√xt
->
¥ev
 = (add); \

1036 
	`CDL_PREPEND2
(
hód
, 
add
, 
¥ev
, 
√xt
); \

1038 } 0)

	)

1040 
	#CDL_APPEND_ELEM
(
hód
, 
ñ
, 
add
) \

1041 
	`CDL_APPEND_ELEM2
(
hód
, 
ñ
, 
add
, 
¥ev
, 
√xt
)

	)

1043 #ifde‡
NO_DECLTYPE


1046 #unde‡
CDL_INSERT_INORDER2


1047 
	#CDL_INSERT_INORDER2
(
hód
,
add
,
cmp
,
¥ev
,
√xt
) \

1049 i‡((
hód
Ë=
NULL
) { \

1050 (
add
)->
¥ev
 = (add); \

1051 (
add
)->
√xt
 = (add); \

1052 (
hód
Ë(
add
); \

1053 } i‡((
	`cmp
(
hód
, 
add
)) >= 0) { \

1054 (
add
)->
¥ev
 = (
hód
)->prev; \

1055 (
add
)->
√xt
 = (
hód
); \

1056 (
add
)->
¥ev
->
√xt
 = (add); \

1057 (
hód
)->
¥ev
 = (
add
); \

1058 (
hód
Ë(
add
); \

1060 *
_tmp
 = (*)(
hód
); \

1061 (*)(
hód
)->
√xt
 !
_tmp
 && (
	`cmp
((hód)->√xt, 
add
)) < 0) { \

1062 (
hód
Ë(hód)->
√xt
; \

1064 (
add
)->
¥ev
 = (
hód
); \

1065 (
add
)->
√xt
 = (
hód
)->next; \

1066 (
add
)->
√xt
->
¥ev
 = (add); \

1067 (
hód
)->
√xt
 = (
add
); \

1068 
	`UTLIST_RS
(
hód
); \

1070 } 0)

	)

	@src/handle_auth.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mqâ_¥Ÿocﬁ.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"¥›îty_mosq.h
"

27 
	~"£nd_mosq.h
"

28 
	~"utû_mosq.h
"

29 
	~"wûl_mosq.h
"

32 
	$h™dÀ__auth
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

34 
rc
 = 0;

35 
uöt8_t
 
ªas⁄_code
 = 0;

36 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

37 *
auth_mëhod
 = 
NULL
;

38 *
auth_d©a
 = 
NULL
;

39 
uöt16_t
 
auth_d©a_Àn
 = 0;

40 *
auth_d©a_out
 = 
NULL
;

41 
uöt16_t
 
auth_d©a_out_Àn
 = 0;

43 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

45 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
 || c⁄ãxt->
auth_mëhod
 =
NULL
){

46  
MOSQ_ERR_PROTOCOL
;

49 if(
c⁄ãxt
->
ö_∑ckë
.
ªmaöög_Àngth
 > 0){

50 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
ªas⁄_code
))  1;

51 if(
ªas⁄_code
 !
MQTT_RC_CONTINUE_AUTHENTICATION


52 && 
ªas⁄_code
 !
MQTT_RC_REAUTHENTICATE
){

54 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_PROTOCOL_ERROR
, 
NULL
);

55  
MOSQ_ERR_PROTOCOL
;

58 if((
ªas⁄_code
 =
MQTT_RC_REAUTHENTICATE
 && 
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
)

59 || (
ªas⁄_code
 =
MQTT_RC_CONTINUE_AUTHENTICATION


60 && 
c⁄ãxt
->
°©e
 !
mosq_cs_authítiˇtög
 && c⁄ãxt->°©ê!
mosq_cs_ªauthítiˇtög
)){

62 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_PROTOCOL_ERROR
, 
NULL
);

63  
MOSQ_ERR_PROTOCOL
;

66 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_AUTH
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

67 if(
rc
){

68 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_UNSPECIFIED
, 
NULL
);

69  
rc
;

73 if(
	`mosquôto_¥›îty_ªad_°rög
(
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_METHOD
, &
auth_mëhod
, 
Ál£
Ë=
NULL
){

74 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

75 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_UNSPECIFIED
, 
NULL
);

76  
MOSQ_ERR_PROTOCOL
;

79 if(!
auth_mëhod
 || 
	`°rcmp
◊uth_mëhod, 
c⁄ãxt
->auth_method)){

81 
	`mosquôto__‰ì
(
auth_mëhod
);

82 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

83 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_PROTOCOL_ERROR
, 
NULL
);

84  
MOSQ_ERR_PROTOCOL
;

86 
	`mosquôto__‰ì
(
auth_mëhod
);

88 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_DATA
, &
auth_d©a
, &
auth_d©a_Àn
, 
Ál£
);

90 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

93 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived AUTH from %†‘c%d, %s)", 
c⁄ãxt
->
id
, 
ªas⁄_code
, c⁄ãxt->
auth_mëhod
);

96 if(
ªas⁄_code
 =
MQTT_RC_REAUTHENTICATE
){

98 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_ªauthítiˇtög
);

99 
rc
 = 
	`mosquôto_£curôy_auth_°¨t
(
db
, 
c⁄ãxt
, 
åue
, 
auth_d©a
, 
auth_d©a_Àn
, &
auth_d©a_out
, &
auth_d©a_out_Àn
);

101 if(
c⁄ãxt
->
°©e
 !
mosq_cs_ªauthítiˇtög
){

102 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_authítiˇtög
);

104 
rc
 = 
	`mosquôto_£curôy_auth_c⁄töue
(
db
, 
c⁄ãxt
, 
auth_d©a
, 
auth_d©a_Àn
, &
auth_d©a_out
, &
auth_d©a_out_Àn
);

106 
	`mosquôto__‰ì
(
auth_d©a
);

107 if(
rc
 =
MOSQ_ERR_SUCCESS
){

108 if(
c⁄ãxt
->
°©e
 =
mosq_cs_authítiˇtög
){

109  
	`c⁄√˘__⁄_auth‹i£d
(
db
, 
c⁄ãxt
, 
auth_d©a_out
, 
auth_d©a_out_Àn
);

111 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_a˘ive
);

112 
rc
 = 
	`£nd__auth
(
db
, 
c⁄ãxt
, 
MQTT_RC_SUCCESS
, 
auth_d©a_out
, 
auth_d©a_out_Àn
);

113 
	`‰ì
(
auth_d©a_out
);

114  
rc
;

116 }if(
rc
 =
MOSQ_ERR_AUTH_CONTINUE
){

117 
rc
 = 
	`£nd__auth
(
db
, 
c⁄ãxt
, 
MQTT_RC_CONTINUE_AUTHENTICATION
, 
auth_d©a_out
, 
auth_d©a_out_Àn
);

118 
	`‰ì
(
auth_d©a_out
);

119  
rc
;

121 
	`‰ì
(
auth_d©a_out
);

122 if(
c⁄ãxt
->
°©e
 =
mosq_cs_authítiˇtög
 && c⁄ãxt->
wûl
){

124 
	`wûl__˛ór
(
c⁄ãxt
);

126 if(
rc
 =
MOSQ_ERR_AUTH
){

127 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

128 if(
c⁄ãxt
->
°©e
 =
mosq_cs_authítiˇtög
){

129 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

130 
c⁄ãxt
->
id
 = 
NULL
;

132  
MOSQ_ERR_PROTOCOL
;

133 }if(
rc
 =
MOSQ_ERR_NOT_SUPPORTED
){

135 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_AUTHENTICATION_METHOD
, 
NULL
);

136 if(
c⁄ãxt
->
°©e
 =
mosq_cs_authítiˇtög
){

137 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

138 
c⁄ãxt
->
id
 = 
NULL
;

140  
MOSQ_ERR_PROTOCOL
;

142 if(
c⁄ãxt
->
°©e
 =
mosq_cs_authítiˇtög
){

143 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

144 
c⁄ãxt
->
id
 = 
NULL
;

146  
rc
;

149 
	}
}

	@src/handle_connack.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"£nd_mosq.h
"

27 
	~"utû_mosq.h
"

29 
	$h™dÀ__c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

31 
rc
;

32 
uöt8_t
 
c⁄√˘_acknowÀdge
;

33 
uöt8_t
 
ªas⁄_code
;

34 
i
;

35 *
nŸifiˇti⁄_t›ic
;

36 
nŸifiˇti⁄_t›ic_Àn
;

37 
nŸifiˇti⁄_∑ylﬂd
;

38 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

40 if(!
c⁄ãxt
){

41  
MOSQ_ERR_INVAL
;

43 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived CONNACK o¿c⁄√˘i⁄ %s.", 
c⁄ãxt
->
id
);

44 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
c⁄√˘_acknowÀdge
))  1;

45 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
ªas⁄_code
))  1;

47 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

48 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNACK
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

49 if(
rc
) Ñc;

50 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

52 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

54 
ªas⁄_code
){

55 
CONNACK_ACCEPTED
:

56 if(
c⁄ãxt
->
bridge
){

57 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s
){

58 
nŸifiˇti⁄_∑ylﬂd
 = '1';

59 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
){

60 if(!
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
){

61 if(
	`£nd__ªÆ_publish
(
c⁄ãxt
, 
	`mosquôto__mid_gíî©e
(context),

62 
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 0, 
NULL
, NULL, 0)){

67 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

69 
nŸifiˇti⁄_t›ic_Àn
 = 
	`°æí
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
)+strlen("$SYS/broker/connection//state");

70 
nŸifiˇti⁄_t›ic
 = 
	`mosquôto__mÆloc
(()*(
nŸifiˇti⁄_t›ic_Àn
+1));

71 if(!
nŸifiˇti⁄_t›ic
Ë 
MOSQ_ERR_NOMEM
;

73 
	`¢¥ötf
(
nŸifiˇti⁄_t›ic
, 
nŸifiˇti⁄_t›ic_Àn
+1, "$SYS/brokî/c⁄√˘i⁄/%s/°©e", 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

74 
nŸifiˇti⁄_∑ylﬂd
 = '1';

75 if(!
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s_loˇl_⁄ly
){

76 if(
	`£nd__ªÆ_publish
(
c⁄ãxt
, 
	`mosquôto__mid_gíî©e
(context),

77 
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 0, 
NULL
, NULL, 0)){

79 
	`mosquôto__‰ì
(
nŸifiˇti⁄_t›ic
);

83 
	`db__mesßges_ósy_queue
(
db
, 
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 0, 
NULL
);

84 
	`mosquôto__‰ì
(
nŸifiˇti⁄_t›ic
);

87 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

88 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_ö
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

89 if(
	`£nd__subs¸ibe
(
c⁄ãxt
, 
NULL
, 1, &c⁄ãxt->
bridge
->
t›ics
[
i
].
ªmŸe_t›ic
, c⁄ãxt->bridge->t›ics[i].
qos
, NULL)){

93 if(
c⁄ãxt
->
bridge
->
©ãm±_unsubs¸ibe
){

94 if(
	`£nd__unsubs¸ibe
(
c⁄ãxt
, 
NULL
, 1, &c⁄ãxt->
bridge
->
t›ics
[
i
].
ªmŸe_t›ic
, NULL)){

103 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

104 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_out
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

105 
	`sub__ªèö_queue
(
db
, 
c⁄ãxt
,

106 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
loˇl_t›ic
,

107 
c⁄ãxt
->
bridge
->
t›ics
[
i
].
qos
, 0);

111 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_a˘ive
);

112  
MOSQ_ERR_SUCCESS
;

113 
CONNACK_REFUSED_PROTOCOL_VERSION
:

114 if(
c⁄ãxt
->
bridge
){

115 
c⁄ãxt
->
bridge
->
åy_¥iv©e_ac˚±ed
 = 
Ál£
;

117 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: unacceptableÖrotocol version");

119 
CONNACK_REFUSED_IDENTIFIER_REJECTED
:

120 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: identifierÑejected");

122 
CONNACK_REFUSED_SERVER_UNAVAILABLE
:

123 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: broker unavailable");

125 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
:

126 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: broker unavailable");

128 
CONNACK_REFUSED_NOT_AUTHORIZED
:

129 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused:Çotáuthorised");

132 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: unknownÑeason");

136 
	}
}

	@src/handle_connect.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

21 
	~<uéi°.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"∑ckë_mosq.h
"

27 
	~"¥›îty_mosq.h
"

28 
	~"£nd_mosq.h
"

29 
	~"sys_åì.h
"

30 
	~"time_mosq.h
"

31 
	~"és_mosq.h
"

32 
	~"utû_mosq.h
"

33 
	~"wûl_mosq.h
"

35 #ifde‡
WITH_WEBSOCKETS


36 
	~<libwebsockës.h
>

40 
	$nibbÀ_to_hex
(
uöt8_t
 
vÆue
)

42 if(
vÆue
 < 0x0A){

43  '0'+
vÆue
;

45  'A'+
vÆue
-0x0A;

47 
	}
}

49 *
	$˛õ¡_id_gí
(*
idÀn
, c⁄° *
auto_id_¥efix
, 
auto_id_¥efix_Àn
)

51 *
˛õ¡_id
;

52 
uöt8_t
 
∫d
[16];

53 
i
;

54 
pos
;

56 if(
	`utû__øndom_byãs
(
∫d
, 16)Ë 
NULL
;

58 *
idÀn
 = 36 + 
auto_id_¥efix_Àn
;

60 
˛õ¡_id
 = (*)
	`mosquôto__ˇŒoc
((*
idÀn
) + 1, ());

61 if(!
˛õ¡_id
){

62  
NULL
;

64 if(
auto_id_¥efix
){

65 
	`mem˝y
(
˛õ¡_id
, 
auto_id_¥efix
, 
auto_id_¥efix_Àn
);

68 
pos
 = 0;

69 
i
=0; i<16; i++){

70 
˛õ¡_id
[
auto_id_¥efix_Àn
 + 
pos
 + 0] = 
	`nibbÀ_to_hex
(
∫d
[
i
] & 0x0F);

71 
˛õ¡_id
[
auto_id_¥efix_Àn
 + 
pos
 + 1] = 
	`nibbÀ_to_hex
((
∫d
[
i
] >> 4) & 0x0F);

72 
pos
 += 2;

73 if(
pos
 == 8 ||Öos == 13 ||Öos == 18 ||Öos == 23){

74 
˛õ¡_id
[
auto_id_¥efix_Àn
 + 
pos
] = '-';

75 
pos
++;

79  
˛õ¡_id
;

80 
	}
}

84 
	$c⁄√˘i⁄_check_a˛
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto_˛õ¡_msg
 **
hód
)

86 
mosquôto_˛õ¡_msg
 *
msg_èû
, *
tmp
;

88 
	`DL_FOREACH_SAFE
((*
hód
), 
msg_èû
, 
tmp
){

89 if(
msg_èû
->
dúe˘i⁄
 =
mosq_md_out
){

90 if(
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
msg_èû
->
°‹e
->
t›ic
,

91 
msg_èû
->
°‹e
->
∑ylﬂdÀn
, 
	`UHPA_ACCESS
(msg_èû->°‹e->
∑ylﬂd
, msg_tail->store->payloadlen),

92 
msg_èû
->
°‹e
->
qos
, msg_èû->°‹e->
ªèö
, 
MOSQ_ACL_READ
Ë!
MOSQ_ERR_SUCCESS
){

94 
	`DL_DELETE
((*
hód
), 
msg_èû
);

95 
	`db__msg_°‹e_ªf_dec
(
db
, &
msg_èû
->
°‹e
);

96 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_èû
->
¥›îtõs
);

97 
	`mosquôto__‰ì
(
msg_èû
);

101 
	}
}

104 
	$c⁄√˘__⁄_auth‹i£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, *
auth_d©a_out
, 
uöt16_t
 
auth_d©a_out_Àn
)

106 
mosquôto
 *
found_c⁄ãxt
;

107 
mosquôto__subÀaf
 *
Àaf
;

108 
mosquôto_¥›îty
 *
c⁄«ck_¥›s
 = 
NULL
;

109 
uöt8_t
 
c⁄√˘_ack
 = 0;

110 
i
;

111 
rc
;

114 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
->
id
, 
	`°æí
(c⁄ãxt->id), 
found_c⁄ãxt
);

115 if(
found_c⁄ãxt
){

117 if(
found_c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

123 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

124 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Clõ¡ %†Æªady c⁄√˘ed, closög old c⁄√˘i⁄.", 
c⁄ãxt
->
id
);

128 if(
c⁄ãxt
->
˛ón_°¨t
 =
Ál£
 && 
found_c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 > 0){

129 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

130 
c⁄√˘_ack
 |= 0x01;

133 if(
found_c⁄ãxt
->
msgs_ö
.
öÊight
 || found_c⁄ãxt->msgs_ö.
queued


134 || 
found_c⁄ãxt
->
msgs_out
.
öÊight
 || found_c⁄ãxt->msgs_out.
queued
){

136 
	`mem˝y
(&
c⁄ãxt
->
msgs_ö
, &
found_c⁄ãxt
->msgs_ö, (
mosquôto_msg_d©a
));

137 
	`mem˝y
(&
c⁄ãxt
->
msgs_out
, &
found_c⁄ãxt
->msgs_out, (
mosquôto_msg_d©a
));

139 
	`mem£t
(&
found_c⁄ãxt
->
msgs_ö
, 0, (
mosquôto_msg_d©a
));

140 
	`mem£t
(&
found_c⁄ãxt
->
msgs_out
, 0, (
mosquôto_msg_d©a
));

142 
	`db__mesßge_ªc⁄√˘_ª£t
(
db
, 
c⁄ãxt
);

144 
c⁄ãxt
->
subs
 = 
found_c⁄ãxt
->subs;

145 
found_c⁄ãxt
->
subs
 = 
NULL
;

146 
c⁄ãxt
->
sub_cou¡
 = 
found_c⁄ãxt
->sub_count;

147 
found_c⁄ãxt
->
sub_cou¡
 = 0;

148 
c⁄ãxt
->
œ°_mid
 = 
found_c⁄ãxt
->last_mid;

150 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

151 if(
c⁄ãxt
->
subs
[
i
]){

152 
Àaf
 = 
c⁄ãxt
->
subs
[
i
]->subs;

153 
Àaf
){

154 if(
Àaf
->
c⁄ãxt
 =
found_c⁄ãxt
){

155 
Àaf
->
c⁄ãxt
 = context;

157 
Àaf
 =Üóf->
√xt
;

163 
	`£ssi⁄_expúy__ªmove
(
found_c⁄ãxt
);

164 
	`wûl_dñay__ªmove
(
found_c⁄ãxt
);

165 
	`wûl__˛ór
(
found_c⁄ãxt
);

167 
found_c⁄ãxt
->
˛ón_°¨t
 = 
åue
;

168 
found_c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 0;

169 
	`mosquôto__£t_°©e
(
found_c⁄ãxt
, 
mosq_cs_du∂iˇã
);

170 
	`do_disc⁄√˘
(
db
, 
found_c⁄ãxt
, 
MOSQ_ERR_SUCCESS
);

173 
rc
 = 
	`a˛__föd_a˛s
(
db
, 
c⁄ãxt
);

174 if(
rc
){

175 
	`‰ì
(
auth_d©a_out
);

176  
rc
;

179 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

180 if(
c⁄ãxt
->
is_bridge
){

181 if(
c⁄ãxt
->
u£∫ame
){

182 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New bridge connected from %sás %s (p%d, c%d, k%d, u'%s').",

183 
c⁄ãxt
->
addªss
, c⁄ãxt->
id
, c⁄ãxt->
¥Ÿocﬁ
, c⁄ãxt->
˛ón_°¨t
, c⁄ãxt->
kì∑live
, c⁄ãxt->
u£∫ame
);

185 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New bridge connected from %sás %s (p%d, c%d, k%d).",

186 
c⁄ãxt
->
addªss
, c⁄ãxt->
id
, c⁄ãxt->
¥Ÿocﬁ
, c⁄ãxt->
˛ón_°¨t
, c⁄ãxt->
kì∑live
);

189 if(
c⁄ãxt
->
u£∫ame
){

190 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New client connected from %sás %s (p%d, c%d, k%d, u'%s').",

191 
c⁄ãxt
->
addªss
, c⁄ãxt->
id
, c⁄ãxt->
¥Ÿocﬁ
, c⁄ãxt->
˛ón_°¨t
, c⁄ãxt->
kì∑live
, c⁄ãxt->
u£∫ame
);

193 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New client connected from %sás %s (p%d, c%d, k%d).",

194 
c⁄ãxt
->
addªss
, c⁄ãxt->
id
, c⁄ãxt->
¥Ÿocﬁ
, c⁄ãxt->
˛ón_°¨t
, c⁄ãxt->
kì∑live
);

198 if(
c⁄ãxt
->
wûl
) {

199 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Will message specified (%ld bytes) (r%d, q%d).",

200 ()
c⁄ãxt
->
wûl
->
msg
.
∑ylﬂdÀn
,

201 
c⁄ãxt
->
wûl
->
msg
.
ªèö
,

202 
c⁄ãxt
->
wûl
->
msg
.
qos
);

204 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "\t%s", 
c⁄ãxt
->
wûl
->
msg
.
t›ic
);

206 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "No will message specified.");

210 
c⁄ãxt
->
pög_t
 = 0;

211 
c⁄ãxt
->
is_dr›pög
 = 
Ál£
;

213 
	`c⁄√˘i⁄_check_a˛
(
db
, 
c⁄ãxt
, &c⁄ãxt->
msgs_ö
.
öÊight
);

214 
	`c⁄√˘i⁄_check_a˛
(
db
, 
c⁄ãxt
, &c⁄ãxt->
msgs_ö
.
queued
);

215 
	`c⁄√˘i⁄_check_a˛
(
db
, 
c⁄ãxt
, &c⁄ãxt->
msgs_out
.
öÊight
);

216 
	`c⁄√˘i⁄_check_a˛
(
db
, 
c⁄ãxt
, &c⁄ãxt->
msgs_out
.
queued
);

218 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
->
id
, 
	`°æí
(context->id), context);

220 #ifde‡
WITH_PERSISTENCE


221 if(!
c⁄ãxt
->
˛ón_°¨t
){

222 
db
->
≥rsi°í˚_ch™ges
++;

225 
c⁄ãxt
->
maximum_qos
 = c⁄ãxt->
li°íî
->maximum_qos;

227 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

228 if(
c⁄ãxt
->
maximum_qos
 != 2){

229 if(
	`mosquôto_¥›îty_add_byã
(&
c⁄«ck_¥›s
, 
MQTT_PROP_MAXIMUM_QOS
, 
c⁄ãxt
->
maximum_qos
)){

230 
rc
 = 
MOSQ_ERR_NOMEM
;

231 
îr‹
;

234 if(
c⁄ãxt
->
li°íî
->
max_t›ic_Æüs
 > 0){

235 if(
	`mosquôto_¥›îty_add_öt16
(&
c⁄«ck_¥›s
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 
c⁄ãxt
->
li°íî
->
max_t›ic_Æüs
)){

236 
rc
 = 
MOSQ_ERR_NOMEM
;

237 
îr‹
;

240 if(
c⁄ãxt
->
kì∑live
 > 
db
->
c⁄fig
->
max_kì∑live
){

241 
c⁄ãxt
->
kì∑live
 = 
db
->
c⁄fig
->
max_kì∑live
;

242 if(
	`mosquôto_¥›îty_add_öt16
(&
c⁄«ck_¥›s
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 
c⁄ãxt
->
kì∑live
)){

243 
rc
 = 
MOSQ_ERR_NOMEM
;

244 
îr‹
;

247 if(
c⁄ãxt
->
assig√d_id
){

248 if(
	`mosquôto_¥›îty_add_°rög
(&
c⁄«ck_¥›s
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, 
c⁄ãxt
->
id
)){

249 
rc
 = 
MOSQ_ERR_NOMEM
;

250 
îr‹
;

253 if(
c⁄ãxt
->
auth_mëhod
){

254 if(
	`mosquôto_¥›îty_add_°rög
(&
c⁄«ck_¥›s
, 
MQTT_PROP_AUTHENTICATION_METHOD
, 
c⁄ãxt
->
auth_mëhod
)){

255 
rc
 = 
MOSQ_ERR_NOMEM
;

256 
îr‹
;

259 if(
auth_d©a_out
 && 
auth_d©a_out_Àn
 > 0){

260 if(
	`mosquôto_¥›îty_add_bö¨y
(&
c⁄«ck_¥›s
, 
MQTT_PROP_AUTHENTICATION_DATA
, 
auth_d©a_out
, 
auth_d©a_out_Àn
)){

261 
rc
 = 
MOSQ_ERR_NOMEM
;

262 
îr‹
;

267 
	`‰ì
(
auth_d©a_out
);

269 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_a˘ive
);

270 
rc
 = 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 
c⁄√˘_ack
, 
CONNACK_ACCEPTED
, 
c⁄«ck_¥›s
);

271 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

272  
rc
;

273 
îr‹
:

274 
	`‰ì
(
auth_d©a_out
);

275 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

276  
rc
;

277 
	}
}

280 
	$wûl__ªad
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_mesßge_Æl
 **
wûl
, 
uöt8_t
 
wûl_qos
, 
wûl_ªèö
)

282 
rc
 = 
MOSQ_ERR_SUCCESS
;

283 
¶í
;

284 
mosquôto_mesßge_Æl
 *
wûl_°ru˘
 = 
NULL
;

285 *
wûl_t›ic_mou¡
 = 
NULL
;

286 
uöt16_t
 
∑ylﬂdÀn
;

287 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

289 
wûl_°ru˘
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_mesßge_Æl
));

290 if(!
wûl_°ru˘
){

291 
rc
 = 
MOSQ_ERR_NOMEM
;

292 
îr‹_˛ónup
;

294 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
PROTOCOL_VERSION_v5
){

295 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_WILL
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

296 if(
rc
Ë
îr‹_˛ónup
;

298 
rc
 = 
	`¥›îty__¥o˚ss_wûl
(
c⁄ãxt
, 
wûl_°ru˘
, &
¥›îtõs
);

299 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

300 if(
rc
Ë
îr‹_˛ónup
;

302 
rc
 = 
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
wûl_°ru˘
->
msg
.
t›ic
, &
¶í
);

303 if(
rc
Ë
îr‹_˛ónup
;

304 if(!
¶í
){

305 
rc
 = 
MOSQ_ERR_PROTOCOL
;

306 
îr‹_˛ónup
;

309 if(
c⁄ãxt
->
li°íî
->
mou¡_poöt
){

310 
¶í
 = 
	`°æí
(
c⁄ãxt
->
li°íî
->
mou¡_poöt
Ë+ såÀn(
wûl_°ru˘
->
msg
.
t›ic
) + 1;

311 
wûl_t›ic_mou¡
 = 
	`mosquôto__mÆloc
(
¶í
+1);

312 if(!
wûl_t›ic_mou¡
){

313 
rc
 = 
MOSQ_ERR_NOMEM
;

314 
îr‹_˛ónup
;

317 
	`¢¥ötf
(
wûl_t›ic_mou¡
, 
¶í
, "%s%s", 
c⁄ãxt
->
li°íî
->
mou¡_poöt
, 
wûl_°ru˘
->
msg
.
t›ic
);

318 
wûl_t›ic_mou¡
[
¶í
] = '\0';

320 
	`mosquôto__‰ì
(
wûl_°ru˘
->
msg
.
t›ic
);

321 
wûl_°ru˘
->
msg
.
t›ic
 = 
wûl_t›ic_mou¡
;

324 
rc
 = 
	`mosquôto_pub_t›ic_check
(
wûl_°ru˘
->
msg
.
t›ic
);

325 if(
rc
Ë
îr‹_˛ónup
;

327 
rc
 = 
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
∑ylﬂdÀn
);

328 if(
rc
Ë
îr‹_˛ónup
;

330 
wûl_°ru˘
->
msg
.
∑ylﬂdÀn
 =Öayloadlen;

331 if(
wûl_°ru˘
->
msg
.
∑ylﬂdÀn
 > 0){

332 
wûl_°ru˘
->
msg
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(wûl_°ru˘->msg.
∑ylﬂdÀn
);

333 if(!
wûl_°ru˘
->
msg
.
∑ylﬂd
){

334 
rc
 = 
MOSQ_ERR_NOMEM
;

335 
îr‹_˛ónup
;

338 
rc
 = 
	`∑ckë__ªad_byãs
(&
c⁄ãxt
->
ö_∑ckë
, 
wûl_°ru˘
->
msg
.
∑ylﬂd
, wûl_°ru˘->msg.
∑ylﬂdÀn
);

339 if(
rc
Ë
îr‹_˛ónup
;

342 
wûl_°ru˘
->
msg
.
qos
 = 
wûl_qos
;

343 
wûl_°ru˘
->
msg
.
ªèö
 = 
wûl_ªèö
;

345 *
wûl
 = 
wûl_°ru˘
;

346  
MOSQ_ERR_SUCCESS
;

348 
îr‹_˛ónup
:

349 if(
wûl_°ru˘
){

350 
	`mosquôto__‰ì
(
wûl_°ru˘
->
msg
.
t›ic
);

351 
	`mosquôto__‰ì
(
wûl_°ru˘
->
msg
.
∑ylﬂd
);

352 
	`mosquôto_¥›îty_‰ì_Æl
(&
wûl_°ru˘
->
¥›îtõs
);

353 
	`mosquôto__‰ì
(
wûl_°ru˘
);

355  
rc
;

356 
	}
}

360 
	$h™dÀ__c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

362 
¥Ÿocﬁ_«me
[7];

363 
uöt8_t
 
¥Ÿocﬁ_vîsi⁄
;

364 
uöt8_t
 
c⁄√˘_Êags
;

365 *
˛õ¡_id
 = 
NULL
;

366 
mosquôto_mesßge_Æl
 *
wûl_°ru˘
 = 
NULL
;

367 
uöt8_t
 
wûl
, 
wûl_ªèö
, 
wûl_qos
, 
˛ón_°¨t
;

368 
uöt8_t
 
u£∫ame_Êag
, 
∑ssw‹d_Êag
;

369 *
u£∫ame
 = 
NULL
, *
∑ssw‹d
 = NULL;

370 
rc
;

371 
¶í
;

372 
uöt16_t
 
¶í16
;

373 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

374 *
auth_d©a
 = 
NULL
;

375 
uöt16_t
 
auth_d©a_Àn
 = 0;

376 *
auth_d©a_out
 = 
NULL
;

377 
uöt16_t
 
auth_d©a_out_Àn
 = 0;

378 #ifde‡
WITH_TLS


379 
i
;

380 
X509
 *
˛õ¡_˚π
 = 
NULL
;

381 
X509_NAME
 *
«me
;

382 
X509_NAME_ENTRY
 *
«me_íåy
;

383 
ASN1_STRING
 *
«me_a¢1
 = 
NULL
;

386 
	`G_CONNECTION_COUNT_INC
();

388 if(!
c⁄ãxt
->
li°íî
){

389  
MOSQ_ERR_INVAL
;

393 if(
c⁄ãxt
->
°©e
 !
mosq_cs_√w
){

394 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Bad clõ¡ %†£ndög mu…ùÀ CONNECT mesßges.", 
c⁄ãxt
->
id
);

395 
rc
 = 
MOSQ_ERR_PROTOCOL
;

396 
h™dÀ_c⁄√˘_îr‹
;

402 if(
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
¶í16
)){

403 
rc
 = 1;

404 
h™dÀ_c⁄√˘_îr‹
;

406 
¶í
 = 
¶í16
;

407 if(
¶í
 != 4 && slen != 6 ){

408 
rc
 = 
MOSQ_ERR_PROTOCOL
;

409 
h™dÀ_c⁄√˘_îr‹
;

411 if(
	`∑ckë__ªad_byãs
(&
c⁄ãxt
->
ö_∑ckë
, 
¥Ÿocﬁ_«me
, 
¶í
)){

412 
rc
 = 
MOSQ_ERR_PROTOCOL
;

413 
h™dÀ_c⁄√˘_îr‹
;

415 
¥Ÿocﬁ_«me
[
¶í
] = '\0';

417 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
¥Ÿocﬁ_vîsi⁄
)){

418 
rc
 = 1;

419 
h™dÀ_c⁄√˘_îr‹
;

421 if(!
	`°rcmp
(
¥Ÿocﬁ_«me
, 
PROTOCOL_NAME_v31
)){

422 if((
¥Ÿocﬁ_vîsi⁄
&0x7FË!
PROTOCOL_VERSION_v31
){

423 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

424 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol version %d in CONNECT from %s.",

425 
¥Ÿocﬁ_vîsi⁄
, 
c⁄ãxt
->
addªss
);

427 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_PROTOCOL_VERSION
, 
NULL
);

428 
rc
 = 
MOSQ_ERR_PROTOCOL
;

429 
h™dÀ_c⁄√˘_îr‹
;

431 
c⁄ãxt
->
¥Ÿocﬁ
 = 
mosq_p_mqâ31
;

432 if((
¥Ÿocﬁ_vîsi⁄
&0x80) == 0x80){

433 
c⁄ãxt
->
is_bridge
 = 
åue
;

435 }if(!
	`°rcmp
(
¥Ÿocﬁ_«me
, 
PROTOCOL_NAME
)){

436 if((
¥Ÿocﬁ_vîsi⁄
&0x7FË=
PROTOCOL_VERSION_v311
){

437 
c⁄ãxt
->
¥Ÿocﬁ
 = 
mosq_p_mqâ311
;

439 if((
¥Ÿocﬁ_vîsi⁄
&0x80) == 0x80){

440 
c⁄ãxt
->
is_bridge
 = 
åue
;

442 }if((
¥Ÿocﬁ_vîsi⁄
&0x7FË=
PROTOCOL_VERSION_v5
){

443 
c⁄ãxt
->
¥Ÿocﬁ
 = 
mosq_p_mqâ5
;

445 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

446 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol version %d in CONNECT from %s.",

447 
¥Ÿocﬁ_vîsi⁄
, 
c⁄ãxt
->
addªss
);

449 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_PROTOCOL_VERSION
, 
NULL
);

450 
rc
 = 
MOSQ_ERR_PROTOCOL
;

451 
h™dÀ_c⁄√˘_îr‹
;

453 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x00){

455 
rc
 = 
MOSQ_ERR_PROTOCOL
;

456 
h™dÀ_c⁄√˘_îr‹
;

459 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

460 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol \"%s\" in CONNECT from %s.",

461 
¥Ÿocﬁ_«me
, 
c⁄ãxt
->
addªss
);

463 
rc
 = 
MOSQ_ERR_PROTOCOL
;

464 
h™dÀ_c⁄√˘_îr‹
;

467 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
c⁄√˘_Êags
)){

468 
rc
 = 1;

469 
h™dÀ_c⁄√˘_îr‹
;

471 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

472 if((
c⁄√˘_Êags
 & 0x01) != 0x00){

473 
rc
 = 
MOSQ_ERR_PROTOCOL
;

474 
h™dÀ_c⁄√˘_îr‹
;

478 
˛ón_°¨t
 = (
c⁄√˘_Êags
 & 0x02) >> 1;

480 if(
˛ón_°¨t
 =
Ál£
 && 
¥Ÿocﬁ_vîsi⁄
 !
PROTOCOL_VERSION_v5
){

482 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 
UINT32_MAX
;

484 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 0;

486 
wûl
 = 
c⁄√˘_Êags
 & 0x04;

487 
wûl_qos
 = (
c⁄√˘_Êags
 & 0x18) >> 3;

488 if(
wûl_qos
 == 3){

489 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Invalid Will QoS in CONNECT from %s.",

490 
c⁄ãxt
->
addªss
);

491 
rc
 = 
MOSQ_ERR_PROTOCOL
;

492 
h™dÀ_c⁄√˘_îr‹
;

494 
wûl_ªèö
 = ((
c⁄√˘_Êags
 & 0x20) == 0x20);

495 
∑ssw‹d_Êag
 = 
c⁄√˘_Êags
 & 0x40;

496 
u£∫ame_Êag
 = 
c⁄√˘_Êags
 & 0x80;

498 if(
wûl
 && 
wûl_ªèö
 && 
db
->
c⁄fig
->
ªèö_avaûabÀ
 =
Ál£
){

499 if(
¥Ÿocﬁ_vîsi⁄
 =
mosq_p_mqâ5
){

500 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_RETAIN_NOT_SUPPORTED
, 
NULL
);

502 
rc
 = 1;

503 
h™dÀ_c⁄√˘_îr‹
;

506 if(
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &(c⁄ãxt->
kì∑live
))){

507 
rc
 = 1;

508 
h™dÀ_c⁄√˘_îr‹
;

511 if(
¥Ÿocﬁ_vîsi⁄
 =
PROTOCOL_VERSION_v5
){

512 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

513 if(
rc
Ë
h™dÀ_c⁄√˘_îr‹
;

515 
	`¥›îty__¥o˚ss_c⁄√˘
(
c⁄ãxt
, &
¥›îtõs
);

517 if(
	`mosquôto_¥›îty_ªad_°rög
(
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_METHOD
, &
c⁄ãxt
->
auth_mëhod
, 
Ál£
)){

518 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_DATA
, &
auth_d©a
, &
auth_d©a_Àn
, 
Ál£
);

521 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

523 if(
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
˛õ¡_id
, &
¶í
)){

524 
rc
 = 1;

525 
h™dÀ_c⁄√˘_îr‹
;

528 if(
¶í
 == 0){

529 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

530 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_IDENTIFIER_REJECTED
, 
NULL
);

531 
rc
 = 
MOSQ_ERR_PROTOCOL
;

532 
h™dÀ_c⁄√˘_îr‹
;

534 
	`mosquôto__‰ì
(
˛õ¡_id
);

535 
˛õ¡_id
 = 
NULL
;

537 
boﬁ
 
Ælow_zîo_Àngth_˛õ¡id
;

538 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

539 
Ælow_zîo_Àngth_˛õ¡id
 = 
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
.allow_zero_length_clientid;

541 
Ælow_zîo_Àngth_˛õ¡id
 = 
db
->
c⁄fig
->
£curôy_›ti⁄s
.allow_zero_length_clientid;

543 if((
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 && 
˛ón_°¨t
 =0Ë|| 
Ælow_zîo_Àngth_˛õ¡id
 =
Ál£
){

544 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

545 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_IDENTIFIER_REJECTED
, 
NULL
);

547 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_UNSPECIFIED
, 
NULL
);

549 
rc
 = 
MOSQ_ERR_PROTOCOL
;

550 
h™dÀ_c⁄√˘_îr‹
;

552 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

553 
˛õ¡_id
 = 
	`˛õ¡_id_gí
(&
¶í
, 
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
.
auto_id_¥efix
, c⁄ãxt->li°íî->£curôy_›ti⁄s.
auto_id_¥efix_Àn
);

555 
˛õ¡_id
 = 
	`˛õ¡_id_gí
(&
¶í
, 
db
->
c⁄fig
->
£curôy_›ti⁄s
.
auto_id_¥efix
, db->c⁄fig->£curôy_›ti⁄s.
auto_id_¥efix_Àn
);

557 if(!
˛õ¡_id
){

558 
rc
 = 
MOSQ_ERR_NOMEM
;

559 
h™dÀ_c⁄√˘_îr‹
;

561 
c⁄ãxt
->
assig√d_id
 = 
åue
;

567 if(
db
->
c⁄fig
->
˛õ¡id_¥efixes
){

568 if(
	`°∫cmp
(
db
->
c⁄fig
->
˛õ¡id_¥efixes
, 
˛õ¡_id
, 
	`°æí
(db->config->clientid_prefixes))){

569 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

570 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

572 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
, 
NULL
);

574 
rc
 = 1;

575 
h™dÀ_c⁄√˘_îr‹
;

579 if(
wûl
){

580 
rc
 = 
	`wûl__ªad
(
c⁄ãxt
, &
wûl_°ru˘
, 
wûl_qos
, 
wûl_ªèö
);

581 if(
rc
Ë
h™dÀ_c⁄√˘_îr‹
;

583 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

584 if(
wûl_qos
 !0 || 
wûl_ªèö
 != 0){

585 
rc
 = 
MOSQ_ERR_PROTOCOL
;

586 
h™dÀ_c⁄√˘_îr‹
;

591 if(
u£∫ame_Êag
){

592 
rc
 = 
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
u£∫ame
, &
¶í
);

593 if(
rc
 =
MOSQ_ERR_NOMEM
){

594 
rc
 = 
MOSQ_ERR_NOMEM
;

595 
h™dÀ_c⁄√˘_îr‹
;

596 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

597 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

599 
u£∫ame_Êag
 = 0;

601 
rc
 = 
MOSQ_ERR_PROTOCOL
;

602 
h™dÀ_c⁄√˘_îr‹
;

606 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ31
){

607 if(
∑ssw‹d_Êag
){

609 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "PrŸocﬁÉº‹ from %s:Öassw‹d wôhouàu£∫ame, closög c⁄√˘i⁄.", 
˛õ¡_id
);

610 
rc
 = 
MOSQ_ERR_PROTOCOL
;

611 
h™dÀ_c⁄√˘_îr‹
;

615 if(
∑ssw‹d_Êag
){

616 
rc
 = 
	`∑ckë__ªad_bö¨y
(&
c⁄ãxt
->
ö_∑ckë
, (
uöt8_t
 **)&
∑ssw‹d
, &
¶í
);

617 if(
rc
 =
MOSQ_ERR_NOMEM
){

618 
rc
 = 
MOSQ_ERR_NOMEM
;

619 
h™dÀ_c⁄√˘_îr‹
;

620 }if(
rc
 =
MOSQ_ERR_PROTOCOL
){

621 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

624 
rc
 = 
MOSQ_ERR_PROTOCOL
;

625 
h™dÀ_c⁄√˘_îr‹
;

630 if(
c⁄ãxt
->
ö_∑ckë
.
pos
 !c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

632 
rc
 = 
MOSQ_ERR_PROTOCOL
;

633 
h™dÀ_c⁄√˘_îr‹
;

636 #ifde‡
WITH_TLS


637 if(
c⁄ãxt
->
li°íî
->
s¶_˘x
 && (c⁄ãxt->li°íî->
u£_idítôy_as_u£∫ame
 || c⁄ãxt->li°íî->
u£_subje˘_as_u£∫ame
)){

639 
	`mosquôto__‰ì
(
u£∫ame
);

640 
u£∫ame
 = 
NULL
;

641 
	`mosquôto__‰ì
(
∑ssw‹d
);

642 
∑ssw‹d
 = 
NULL
;

644 if(!
c⁄ãxt
->
s¶
){

645 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

646 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

648 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

650 
rc
 = 1;

651 
h™dÀ_c⁄√˘_îr‹
;

653 #ifde‡
FINAL_WITH_TLS_PSK


654 if(
c⁄ãxt
->
li°íî
->
psk_höt
){

656 if(!
c⁄ãxt
->
u£∫ame
){

657 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

658 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

660 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

662 
rc
 = 1;

663 
h™dÀ_c⁄√˘_îr‹
;

667 
˛õ¡_˚π
 = 
	`SSL_gë_≥î_˚πifiˇã
(
c⁄ãxt
->
s¶
);

668 if(!
˛õ¡_˚π
){

669 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

670 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

672 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

674 
rc
 = 1;

675 
h™dÀ_c⁄√˘_îr‹
;

677 
«me
 = 
	`X509_gë_subje˘_«me
(
˛õ¡_˚π
);

678 if(!
«me
){

679 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

680 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

682 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

684 
rc
 = 1;

685 
h™dÀ_c⁄√˘_îr‹
;

687 i‡(
c⁄ãxt
->
li°íî
->
u£_idítôy_as_u£∫ame
) {

688 
i
 = 
	`X509_NAME_gë_ödex_by_NID
(
«me
, 
NID_comm⁄Name
, -1);

689 if(
i
 == -1){

690 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

691 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

693 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

695 
rc
 = 1;

696 
h™dÀ_c⁄√˘_îr‹
;

698 
«me_íåy
 = 
	`X509_NAME_gë_íåy
(
«me
, 
i
);

699 if(
«me_íåy
){

700 
«me_a¢1
 = 
	`X509_NAME_ENTRY_gë_d©a
(
«me_íåy
);

701 i‡(
«me_a¢1
 =
NULL
) {

702 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

703 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

705 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

707 
rc
 = 1;

708 
h™dÀ_c⁄√˘_îr‹
;

710 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

711 
c⁄ãxt
->
u£∫ame
 = 
	`mosquôto__°rdup
((*Ë
	`ASN1_STRING_d©a
(
«me_a¢1
));

713 
c⁄ãxt
->
u£∫ame
 = 
	`mosquôto__°rdup
((*Ë
	`ASN1_STRING_gë0_d©a
(
«me_a¢1
));

715 if(!
c⁄ãxt
->
u£∫ame
){

716 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

717 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_SERVER_UNAVAILABLE
, 
NULL
);

719 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_SERVER_UNAVAILABLE
, 
NULL
);

721 
rc
 = 
MOSQ_ERR_NOMEM
;

722 
h™dÀ_c⁄√˘_îr‹
;

725 i‡((
size_t
)
	`ASN1_STRING_Àngth
(
«me_a¢1
Ë!
	`°æí
(
c⁄ãxt
->
u£∫ame
)) {

726 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

727 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_USERNAME_OR_PASSWORD
, 
NULL
);

729 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
, 
NULL
);

731 
rc
 = 1;

732 
h™dÀ_c⁄√˘_îr‹
;

736 
BIO
 *
subje˘_bio
 = 
	`BIO_√w
(
	`BIO_s_mem
());

737 
	`X509_NAME_¥öt_ex
(
subje˘_bio
, 
	`X509_gë_subje˘_«me
(
˛õ¡_˚π
), 0, 
XN_FLAG_RFC2253
);

738 *
d©a_°¨t
 = 
NULL
;

739 
«me_Àngth
 = 
	`BIO_gë_mem_d©a
(
subje˘_bio
, &
d©a_°¨t
);

740 *
subje˘
 = 
	`mosquôto__mÆloc
(()*
«me_Àngth
+1);

741 if(!
subje˘
){

742 
	`BIO_‰ì
(
subje˘_bio
);

743 
rc
 = 
MOSQ_ERR_NOMEM
;

744 
h™dÀ_c⁄√˘_îr‹
;

746 
	`mem˝y
(
subje˘
, 
d©a_°¨t
, 
«me_Àngth
);

747 
subje˘
[
«me_Àngth
] = '\0';

748 
	`BIO_‰ì
(
subje˘_bio
);

749 
c⁄ãxt
->
u£∫ame
 = 
subje˘
;

751 if(!
c⁄ãxt
->
u£∫ame
){

752 
rc
 = 1;

753 
h™dÀ_c⁄√˘_îr‹
;

755 
	`X509_‰ì
(
˛õ¡_˚π
);

756 
˛õ¡_˚π
 = 
NULL
;

757 #ifde‡
FINAL_WITH_TLS_PSK


762 if(
u£∫ame_Êag
 || 
∑ssw‹d_Êag
){

765 
c⁄ãxt
->
id
 = 
˛õ¡_id
;

766 
c⁄ãxt
->
u£∫ame
 = username;

767 
rc
 = 
	`mosquôto_u≈wd_check
(
db
, 
c⁄ãxt
, 
u£∫ame
, 
∑ssw‹d
);

768 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

769 
c⁄ãxt
->
id
 = 
NULL
;

770 
rc
){

771 
MOSQ_ERR_SUCCESS
:

773 
MOSQ_ERR_AUTH
:

774 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

775 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

777 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
, 
NULL
);

779 
	`c⁄ãxt__disc⁄√˘
(
db
, 
c⁄ãxt
);

780 
rc
 = 1;

781 
h™dÀ_c⁄√˘_îr‹
;

784 
	`c⁄ãxt__disc⁄√˘
(
db
, 
c⁄ãxt
);

785 
rc
 = 1;

786 
h™dÀ_c⁄√˘_îr‹
;

789 
c⁄ãxt
->
u£∫ame
 = username;

790 
c⁄ãxt
->
∑ssw‹d
 =Öassword;

791 
u£∫ame
 = 
NULL
;

792 
∑ssw‹d
 = 
NULL
;

794 if((
db
->
c⁄fig
->
≥r_li°íî_£âögs
 && 
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 =
Ál£
)

795 || (!
db
->
c⁄fig
->
≥r_li°íî_£âögs
 && db->c⁄fig->
£curôy_›ti⁄s
.
Ælow_™⁄ymous
 =
Ál£
)){

797 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

798 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

800 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
, 
NULL
);

802 
rc
 = 1;

803 
h™dÀ_c⁄√˘_îr‹
;

806 #ifde‡
WITH_TLS


810 if(
c⁄ãxt
->
li°íî
->
u£_u£∫ame_as_˛õ¡id
){

811 if(
c⁄ãxt
->
u£∫ame
){

812 
	`mosquôto__‰ì
(
˛õ¡_id
);

813 
˛õ¡_id
 = 
	`mosquôto__°rdup
(
c⁄ãxt
->
u£∫ame
);

814 if(!
˛õ¡_id
){

815 
rc
 = 
MOSQ_ERR_NOMEM
;

816 
h™dÀ_c⁄√˘_îr‹
;

819 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

820 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

822 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
, 
NULL
);

824 
rc
 = 1;

825 
h™dÀ_c⁄√˘_îr‹
;

828 
c⁄ãxt
->
˛ón_°¨t
 = clean_start;

829 
c⁄ãxt
->
id
 = 
˛õ¡_id
;

830 
c⁄ãxt
->
wûl
 = 
wûl_°ru˘
;

832 if(
c⁄ãxt
->
auth_mëhod
){

833 
rc
 = 
	`mosquôto_£curôy_auth_°¨t
(
db
, 
c⁄ãxt
, 
Ál£
, 
auth_d©a
, 
auth_d©a_Àn
, &
auth_d©a_out
, &
auth_d©a_out_Àn
);

834 
	`mosquôto__‰ì
(
auth_d©a
);

835 if(
rc
 =
MOSQ_ERR_SUCCESS
){

836  
	`c⁄√˘__⁄_auth‹i£d
(
db
, 
c⁄ãxt
, 
auth_d©a_out
, 
auth_d©a_out_Àn
);

837 }if(
rc
 =
MOSQ_ERR_AUTH_CONTINUE
){

838 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_authítiˇtög
);

839 
rc
 = 
	`£nd__auth
(
db
, 
c⁄ãxt
, 
MQTT_RC_CONTINUE_AUTHENTICATION
, 
auth_d©a_out
, 
auth_d©a_out_Àn
);

840 
	`‰ì
(
auth_d©a_out
);

841  
rc
;

843 
	`‰ì
(
auth_d©a_out
);

844 
	`wûl__˛ór
(
c⁄ãxt
);

845 if(
rc
 =
MOSQ_ERR_AUTH
){

846 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_NOT_AUTHORIZED
, 
NULL
);

847 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

848 
c⁄ãxt
->
id
 = 
NULL
;

849  
MOSQ_ERR_PROTOCOL
;

850 }if(
rc
 =
MOSQ_ERR_NOT_SUPPORTED
){

852 
	`£nd__c⁄«ck
(
db
, 
c⁄ãxt
, 0, 
MQTT_RC_BAD_AUTHENTICATION_METHOD
, 
NULL
);

853 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

854 
c⁄ãxt
->
id
 = 
NULL
;

855  
MOSQ_ERR_PROTOCOL
;

857 
	`mosquôto__‰ì
(
c⁄ãxt
->
id
);

858 
c⁄ãxt
->
id
 = 
NULL
;

859  
rc
;

863  
	`c⁄√˘__⁄_auth‹i£d
(
db
, 
c⁄ãxt
, 
NULL
, 0);

867 
h™dÀ_c⁄√˘_îr‹
:

868 
	`mosquôto__‰ì
(
auth_d©a
);

869 
	`mosquôto__‰ì
(
˛õ¡_id
);

870 
	`mosquôto__‰ì
(
u£∫ame
);

871 
	`mosquôto__‰ì
(
∑ssw‹d
);

872 if(
wûl_°ru˘
){

873 
	`mosquôto_¥›îty_‰ì_Æl
(&
wûl_°ru˘
->
¥›îtõs
);

874 
	`mosquôto__‰ì
(
wûl_°ru˘
->
msg
.
∑ylﬂd
);

875 
	`mosquôto__‰ì
(
wûl_°ru˘
->
msg
.
t›ic
);

876 
	`mosquôto__‰ì
(
wûl_°ru˘
);

878 #ifde‡
WITH_TLS


879 if(
˛õ¡_˚π
Ë
	`X509_‰ì
(client_cert);

882  
rc
;

883 
	}
}

	@src/handle_disconnect.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto_brokî_öã∫Æ.h
"

20 
	~"mqâ_¥Ÿocﬁ.h
"

21 
	~"∑ckë_mosq.h
"

22 
	~"¥›îty_mosq.h
"

23 
	~"£nd_mosq.h
"

24 
	~"utû_mosq.h
"

25 
	~"wûl_mosq.h
"

28 
	$h™dÀ__disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

30 
rc
;

31 
uöt8_t
 
ªas⁄_code
 = 0;

32 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

34 if(!
c⁄ãxt
){

35  
MOSQ_ERR_INVAL
;

38 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
 && c⁄ãxt->
ö_∑ckë
.
ªmaöög_Àngth
 > 0){

40 
rc
 = 
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
ªas⁄_code
);

41 if(
rc
) Ñc;

43 if(
c⁄ãxt
->
ö_∑ckë
.
ªmaöög_Àngth
 > 1){

44 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_DISCONNECT
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

45 if(
rc
) Ñc;

48 
rc
 = 
	`¥›îty__¥o˚ss_disc⁄√˘
(
c⁄ãxt
, &
¥›îtõs
);

49 if(
rc
){

50 if(
rc
 =
MOSQ_ERR_PROTOCOL
){

51 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_PROTOCOL_ERROR
, 
NULL
);

53 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

54  
rc
;

56 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

58 if(
c⁄ãxt
->
ö_∑ckë
.
pos
 !c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

59  
MOSQ_ERR_PROTOCOL
;

61 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived DISCONNECT from %s", 
c⁄ãxt
->
id
);

62 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

63 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x00){

64 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_PROTOCOL
);

65  
MOSQ_ERR_PROTOCOL
;

68 if(
ªas⁄_code
 =
MQTT_RC_DISCONNECT_WITH_WILL_MSG
){

69 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘_wôh_wûl
);

71 
	`wûl__˛ór
(
c⁄ãxt
);

72 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

74 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_SUCCESS
);

75  
MOSQ_ERR_SUCCESS
;

76 
	}
}

	@src/handle_publish.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"Æüs_mosq.h
"

25 
	~"mqâ_¥Ÿocﬁ.h
"

26 
	~"mem‹y_mosq.h
"

27 
	~"∑ckë_mosq.h
"

28 
	~"¥›îty_mosq.h
"

29 
	~"ªad_h™dÀ.h
"

30 
	~"£nd_mosq.h
"

31 
	~"sys_åì.h
"

32 
	~"utû_mosq.h
"

35 
	$h™dÀ__publish
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

37 *
t›ic
;

38 
mosquôto__∑ylﬂd_uh∑
 
∑ylﬂd
;

39 
uöt32_t
 
∑ylﬂdÀn
;

40 
uöt8_t
 
dup
, 
qos
, 
ªèö
;

41 
uöt16_t
 
mid
 = 0;

42 
rc
 = 0;

43 
rc2
;

44 
uöt8_t
 
hódî
 = 
c⁄ãxt
->
ö_∑ckë
.
comm™d
;

45 
ªs
 = 0;

46 
mosquôto_msg_°‹e
 *
°‹ed
 = 
NULL
;

47 
Àn
;

48 
¶í
;

49 *
t›ic_mou¡
;

50 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

51 
mosquôto_¥›îty
 *
p
, *
p_¥ev
;

52 
mosquôto_¥›îty
 *
msg_¥›îtõs
 = 
NULL
, *
msg_¥›îtõs_œ°
;

53 
uöt32_t
 
mesßge_expúy_öãrvÆ
 = 0;

54 
t›ic_Æüs
 = -1;

55 
uöt8_t
 
ªas⁄_code
 = 0;

57 #ifde‡
WITH_BRIDGE


58 *
t›ic_ãmp
;

59 
i
;

60 
mosquôto__bridge_t›ic
 *
cur_t›ic
;

61 
boﬁ
 
m©ch
;

64 if(
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
){

65  
MOSQ_ERR_PROTOCOL
;

68 
∑ylﬂd
.
±r
 = 
NULL
;

70 
dup
 = (
hódî
 & 0x08)>>3;

71 
qos
 = (
hódî
 & 0x06)>>1;

72 if(
qos
 == 3){

73 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

74 "InvÆid QoS i¿PUBLISH from %s, disc⁄√˘ög.", 
c⁄ãxt
->
id
);

77 if(
qos
 > 
c⁄ãxt
->
maximum_qos
){

78 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

79 "Toÿhigh QoS i¿PUBLISH from %s, disc⁄√˘ög.", 
c⁄ãxt
->
id
);

82 
ªèö
 = (
hódî
 & 0x01);

84 if(
ªèö
 && 
db
->
c⁄fig
->
ªèö_avaûabÀ
 =
Ál£
){

85 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

86 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_RETAIN_NOT_SUPPORTED
, 
NULL
);

91 if(
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
t›ic
, &
¶í
))  1;

92 if(!
¶í
 && 
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

94 
	`mosquôto__‰ì
(
t›ic
);

98 if(
qos
 > 0){

99 if(
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
)){

100 
	`mosquôto__‰ì
(
t›ic
);

103 if(
mid
 == 0){

104 
	`mosquôto__‰ì
(
t›ic
);

105  
MOSQ_ERR_PROTOCOL
;

110 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

111 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

112 if(
rc
) Ñc;

114 
p
 = 
¥›îtõs
;

115 
p_¥ev
 = 
NULL
;

116 
msg_¥›îtõs
 = 
NULL
;

117 
msg_¥›îtõs_œ°
 = 
NULL
;

118 
p
){

119 
p
->
idítifõr
){

120 
MQTT_PROP_CONTENT_TYPE
:

121 
MQTT_PROP_CORRELATION_DATA
:

122 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

123 
MQTT_PROP_RESPONSE_TOPIC
:

124 
MQTT_PROP_USER_PROPERTY
:

125 if(
msg_¥›îtõs
){

126 
msg_¥›îtõs_œ°
->
√xt
 = 
p
;

127 
msg_¥›îtõs_œ°
 = 
p
;

129 
msg_¥›îtõs
 = 
p
;

130 
msg_¥›îtõs_œ°
 = 
p
;

132 if(
p_¥ev
){

133 
p_¥ev
->
√xt
 = 
p
->next;

134 
p
 = 
p_¥ev
->
√xt
;

136 
¥›îtõs
 = 
p
->
√xt
;

137 
p
 = 
¥›îtõs
;

139 
msg_¥›îtõs_œ°
->
√xt
 = 
NULL
;

142 
MQTT_PROP_TOPIC_ALIAS
:

143 
t›ic_Æüs
 = 
p
->
vÆue
.
i16
;

144 
p_¥ev
 = 
p
;

145 
p
 =Ö->
√xt
;

148 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

149 
mesßge_expúy_öãrvÆ
 = 
p
->
vÆue
.
i32
;

150 
p_¥ev
 = 
p
;

151 
p
 =Ö->
√xt
;

154 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
:

155 
p_¥ev
 = 
p
;

156 
p
 =Ö->
√xt
;

160 
p
 =Ö->
√xt
;

165 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

167 if(
t›ic_Æüs
 =0 || (
c⁄ãxt
->
li°íî
 &&Å›ic_Æü†> c⁄ãxt->li°íî->
max_t›ic_Æüs
)){

168 
	`mosquôto__‰ì
(
t›ic
);

169 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_TOPIC_ALIAS_INVALID
, 
NULL
);

170  
MOSQ_ERR_PROTOCOL
;

171 }if(
t›ic_Æüs
 > 0){

172 if(
t›ic
){

173 
rc
 = 
	`Æüs__add
(
c⁄ãxt
, 
t›ic
, 
t›ic_Æüs
);

174 if(
rc
){

175 
	`mosquôto__‰ì
(
t›ic
);

176  
rc
;

179 
rc
 = 
	`Æüs__föd
(
c⁄ãxt
, &
t›ic
, 
t›ic_Æüs
);

180 if(
rc
){

181 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_TOPIC_ALIAS_INVALID
, 
NULL
);

182 
	`mosquôto__‰ì
(
t›ic
);

183  
rc
;

187 if(
	`mosquôto_vÆid©e_utf8
(
t›ic
, 
¶í
Ë!
MOSQ_ERR_SUCCESS
){

188 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Clõ¡ %†£¡Å›i¯wôh invÆid UTF-8, disc⁄√˘ög.", 
c⁄ãxt
->
id
);

189 
	`mosquôto__‰ì
(
t›ic
);

193 #ifde‡
WITH_BRIDGE


194 if(
c⁄ãxt
->
bridge
 && c⁄ãxt->bridge->
t›ics
 && c⁄ãxt->bridge->
t›ic_ªm≠pög
){

195 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

196 
cur_t›ic
 = &
c⁄ãxt
->
bridge
->
t›ics
[
i
];

197 if((
cur_t›ic
->
dúe˘i⁄
 =
bd_bŸh
 || cur_t›ic->dúe˘i⁄ =
bd_ö
)

198 && (
cur_t›ic
->
ªmŸe_¥efix
 || cur_t›ic->
loˇl_¥efix
)){

202 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
cur_t›ic
->
ªmŸe_t›ic
, 
t›ic
, &
m©ch
);

203 if(
rc
){

204 
	`mosquôto__‰ì
(
t›ic
);

205  
rc
;

207 if(
m©ch
){

208 if(
cur_t›ic
->
ªmŸe_¥efix
){

210 if(!
	`°∫cmp
(
cur_t›ic
->
ªmŸe_¥efix
, 
t›ic
, 
	`°æí
(cur_topic->remote_prefix))){

211 
t›ic_ãmp
 = 
	`mosquôto__°rdup
(
t›ic
+
	`°æí
(
cur_t›ic
->
ªmŸe_¥efix
));

212 if(!
t›ic_ãmp
){

213 
	`mosquôto__‰ì
(
t›ic
);

214  
MOSQ_ERR_NOMEM
;

216 
	`mosquôto__‰ì
(
t›ic
);

217 
t›ic
 = 
t›ic_ãmp
;

221 if(
cur_t›ic
->
loˇl_¥efix
){

223 
Àn
 = 
	`°æí
(
t›ic
Ë+ såÀn(
cur_t›ic
->
loˇl_¥efix
)+1;

224 
t›ic_ãmp
 = 
	`mosquôto__mÆloc
(
Àn
+1);

225 if(!
t›ic_ãmp
){

226 
	`mosquôto__‰ì
(
t›ic
);

227  
MOSQ_ERR_NOMEM
;

229 
	`¢¥ötf
(
t›ic_ãmp
, 
Àn
, "%s%s", 
cur_t›ic
->
loˇl_¥efix
, 
t›ic
);

230 
t›ic_ãmp
[
Àn
] = '\0';

232 
	`mosquôto__‰ì
(
t›ic
);

233 
t›ic
 = 
t›ic_ãmp
;

241 if(
	`mosquôto_pub_t›ic_check
(
t›ic
Ë!
MOSQ_ERR_SUCCESS
){

243 
	`mosquôto__‰ì
(
t›ic
);

247 
∑ylﬂdÀn
 = 
c⁄ãxt
->
ö_∑ckë
.
ªmaöög_Àngth
 - c⁄ãxt->ö_∑ckë.
pos
;

248 
	`G_PUB_BYTES_RECEIVED_INC
(
∑ylﬂdÀn
);

249 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
mou¡_poöt
){

250 
Àn
 = 
	`°æí
(
c⁄ãxt
->
li°íî
->
mou¡_poöt
Ë+ såÀn(
t›ic
) + 1;

251 
t›ic_mou¡
 = 
	`mosquôto__mÆloc
(
Àn
+1);

252 if(!
t›ic_mou¡
){

253 
	`mosquôto__‰ì
(
t›ic
);

254 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

255  
MOSQ_ERR_NOMEM
;

257 
	`¢¥ötf
(
t›ic_mou¡
, 
Àn
, "%s%s", 
c⁄ãxt
->
li°íî
->
mou¡_poöt
, 
t›ic
);

258 
t›ic_mou¡
[
Àn
] = '\0';

260 
	`mosquôto__‰ì
(
t›ic
);

261 
t›ic
 = 
t›ic_mou¡
;

264 if(
∑ylﬂdÀn
){

265 if(
db
->
c⁄fig
->
mesßge_size_limô
 && 
∑ylﬂdÀn
 > db->config->message_size_limit){

266 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Dr›≥dÅoÿœrgêPUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

267 
ªas⁄_code
 = 
MQTT_RC_IMPLEMENTATION_SPECIFIC
;

268 
¥o˚ss_bad_mesßge
;

270 if(
	`UHPA_ALLOC
(
∑ylﬂd
, 
∑ylﬂdÀn
) == 0){

271 
	`mosquôto__‰ì
(
t›ic
);

272 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

273  
MOSQ_ERR_NOMEM
;

276 if(
	`∑ckë__ªad_byãs
(&
c⁄ãxt
->
ö_∑ckë
, 
	`UHPA_ACCESS
(
∑ylﬂd
, 
∑ylﬂdÀn
),Öayloadlen)){

277 
	`mosquôto__‰ì
(
t›ic
);

278 
	`UHPA_FREE
(
∑ylﬂd
, 
∑ylﬂdÀn
);

279 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

285 
rc
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
t›ic
, 
∑ylﬂdÀn
, 
	`UHPA_ACCESS
(
∑ylﬂd
,ÖaylﬂdÀn), 
qos
, 
ªèö
, 
MOSQ_ACL_WRITE
);

286 if(
rc
 =
MOSQ_ERR_ACL_DENIED
){

287 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Díõd PUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

288 
ªas⁄_code
 = 
MQTT_RC_NOT_AUTHORIZED
;

289 
¥o˚ss_bad_mesßge
;

290 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

291 
	`mosquôto__‰ì
(
t›ic
);

292 
	`UHPA_FREE
(
∑ylﬂd
, 
∑ylﬂdÀn
);

293 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

294  
rc
;

297 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

298 if(
qos
 > 0){

299 
	`db__mesßge_°‹e_föd
(
c⁄ãxt
, 
mid
, &
°‹ed
);

301 if(!
°‹ed
){

302 
dup
 = 0;

303 if(
	`db__mesßge_°‹e
(
db
, 
c⁄ãxt
, 
mid
, 
t›ic
, 
qos
, 
∑ylﬂdÀn
, &
∑ylﬂd
, 
ªèö
, &
°‹ed
, 
mesßge_expúy_öãrvÆ
, 
msg_¥›îtõs
, 0, 
mosq_mo_˛õ¡
)){

304 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

307 
msg_¥›îtõs
 = 
NULL
;

309 
	`mosquôto__‰ì
(
t›ic
);

310 
t›ic
 = 
°‹ed
->topic;

311 
dup
 = 1;

312 
	`mosquôto_¥›îty_‰ì_Æl
(&
msg_¥›îtõs
);

313 
	`UHPA_FREE
(
∑ylﬂd
, 
∑ylﬂdÀn
);

316 
qos
){

318 
rc2
 = 
	`sub__mesßges_queue
(
db
, 
c⁄ãxt
->
id
, 
t›ic
, 
qos
, 
ªèö
, &
°‹ed
);

319 if(
rc2
 > 0Ë
rc
 = 1;

322 
	`utû__de¸emít_ª˚ive_quŸa
(
c⁄ãxt
);

323 
rc2
 = 
	`sub__mesßges_queue
(
db
, 
c⁄ãxt
->
id
, 
t›ic
, 
qos
, 
ªèö
, &
°‹ed
);

324 if(
rc2
 =
MOSQ_ERR_SUCCESS
 || 
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
){

325 if(
	`£nd__puback
(
c⁄ãxt
, 
mid
, 0)Ë
rc
 = 1;

326 }if(
rc2
 =
MOSQ_ERR_NO_SUBSCRIBERS
){

327 if(
	`£nd__puback
(
c⁄ãxt
, 
mid
, 
MQTT_RC_NO_MATCHING_SUBSCRIBERS
)Ë
rc
 = 1;

329 
rc
 = 
rc2
;

333 if(
dup
 == 0){

334 
ªs
 = 
	`db__mesßge_ö£π
(
db
, 
c⁄ãxt
, 
mid
, 
mosq_md_ö
, 
qos
, 
ªèö
, 
°‹ed
, 
NULL
);

336 
ªs
 = 0;

340 if(!
ªs
){

341 if(
	`£nd__pubªc
(
c⁄ãxt
, 
mid
, 0)Ë
rc
 = 1;

342 }if(
ªs
 == 1){

343 
rc
 = 1;

348  
rc
;

349 
¥o˚ss_bad_mesßge
:

350 
	`mosquôto__‰ì
(
t›ic
);

351 
	`UHPA_FREE
(
∑ylﬂd
, 
∑ylﬂdÀn
);

352 
qos
){

354  
MOSQ_ERR_SUCCESS
;

356  
	`£nd__puback
(
c⁄ãxt
, 
mid
, 
ªas⁄_code
);

358 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

359  
	`£nd__pubªc
(
c⁄ãxt
, 
mid
, 
ªas⁄_code
);

361  
	`£nd__pubªc
(
c⁄ãxt
, 
mid
, 0);

365 
	}
}

	@src/handle_subscribe.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"¥›îty_mosq.h
"

30 
	$h™dÀ__subs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

32 
rc
 = 0;

33 
rc2
;

34 
uöt16_t
 
mid
;

35 *
sub
;

36 
uöt8_t
 
subs¸ùti⁄_›ti⁄s
;

37 
uöt32_t
 
subs¸ùti⁄_idítifõr
 = 0;

38 
uöt8_t
 
qos
;

39 
uöt8_t
 
ªèö_h™dlög
 = 0;

40 
uöt8_t
 *
∑ylﬂd
 = 
NULL
, *
tmp_∑ylﬂd
;

41 
uöt32_t
 
∑ylﬂdÀn
 = 0;

42 
Àn
;

43 
¶í
;

44 *
sub_mou¡
;

45 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

47 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

49 if(
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
){

50  
MOSQ_ERR_PROTOCOL
;

53 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived SUBSCRIBE from %s", 
c⁄ãxt
->
id
);

55 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ31
){

56 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x02){

57  
MOSQ_ERR_PROTOCOL
;

60 if(
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
))  1;

61 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

63 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

64 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_SUBSCRIBE
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

65 if(
rc
) Ñc;

67 if(
	`mosquôto_¥›îty_ªad_v¨öt
(
¥›îtõs
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
,

68 &
subs¸ùti⁄_idítifõr
, 
Ál£
)){

71 if(
subs¸ùti⁄_idítifõr
 == 0){

72 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

73  
MOSQ_ERR_PROTOCOL
;

77 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

81 
c⁄ãxt
->
ö_∑ckë
.
pos
 < c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

82 
sub
 = 
NULL
;

83 if(
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
sub
, &
¶í
)){

84 
	`mosquôto__‰ì
(
∑ylﬂd
);

88 if(
sub
){

89 if(!
¶í
){

90 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

92 
c⁄ãxt
->
addªss
);

93 
	`mosquôto__‰ì
(
sub
);

94 
	`mosquôto__‰ì
(
∑ylﬂd
);

97 if(
	`mosquôto_sub_t›ic_check
(
sub
)){

98 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

100 
c⁄ãxt
->
addªss
);

101 
	`mosquôto__‰ì
(
sub
);

102 
	`mosquôto__‰ì
(
∑ylﬂd
);

106 if(
	`∑ckë__ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
subs¸ùti⁄_›ti⁄s
)){

107 
	`mosquôto__‰ì
(
sub
);

108 
	`mosquôto__‰ì
(
∑ylﬂd
);

111 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ311
){

112 
qos
 = 
subs¸ùti⁄_›ti⁄s
;

113 if(
c⁄ãxt
->
is_bridge
){

114 
subs¸ùti⁄_›ti⁄s
 = 
MQTT_SUB_OPT_RETAIN_AS_PUBLISHED
 | 
MQTT_SUB_OPT_NO_LOCAL
;

117 
qos
 = 
subs¸ùti⁄_›ti⁄s
 & 0x03;

118 
subs¸ùti⁄_›ti⁄s
 &= 0xFC;

120 
ªèö_h™dlög
 = (
subs¸ùti⁄_›ti⁄s
 & 0x30);

121 if(
ªèö_h™dlög
 =0x30 || (
subs¸ùti⁄_›ti⁄s
 & 0xC0) != 0){

122  
MOSQ_ERR_PROTOCOL
;

125 if(
qos
 > 2){

126 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

128 
c⁄ãxt
->
addªss
);

129 
	`mosquôto__‰ì
(
sub
);

130 
	`mosquôto__‰ì
(
∑ylﬂd
);

135 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
mou¡_poöt
){

136 
Àn
 = 
	`°æí
(
c⁄ãxt
->
li°íî
->
mou¡_poöt
Ë+ 
¶í
 + 1;

137 
sub_mou¡
 = 
	`mosquôto__mÆloc
(
Àn
+1);

138 if(!
sub_mou¡
){

139 
	`mosquôto__‰ì
(
sub
);

140 
	`mosquôto__‰ì
(
∑ylﬂd
);

141  
MOSQ_ERR_NOMEM
;

143 
	`¢¥ötf
(
sub_mou¡
, 
Àn
, "%s%s", 
c⁄ãxt
->
li°íî
->
mou¡_poöt
, 
sub
);

144 
sub_mou¡
[
Àn
] = '\0';

146 
	`mosquôto__‰ì
(
sub
);

147 
sub
 = 
sub_mou¡
;

150 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "\t%†(QoS %d)", 
sub
, 
qos
);

152 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ31
){

153 
rc2
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
sub
, 0, 
NULL
, 
qos
, 
Ál£
, 
MOSQ_ACL_SUBSCRIBE
);

154 
rc2
){

155 
MOSQ_ERR_SUCCESS
:

157 
MOSQ_ERR_ACL_DENIED
:

158 
qos
 = 0x80;

161 
	`mosquôto__‰ì
(
sub
);

162  
rc2
;

166 if(
qos
 != 0x80){

167 
rc2
 = 
	`sub__add
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, 
subs¸ùti⁄_idítifõr
, 
subs¸ùti⁄_›ti⁄s
, &db->
subs
);

168 if(
rc2
 > 0){

169 
	`mosquôto__‰ì
(
sub
);

170  
rc2
;

172 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ31
){

173 if(
rc2
 =
MOSQ_ERR_SUCCESS
 ||Ñc2 =
MOSQ_ERR_SUB_EXISTS
){

174 if(
	`sub__ªèö_queue
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, 0)Ë
rc
 = 1;

177 if((
ªèö_h™dlög
 =
MQTT_SUB_OPT_SEND_RETAIN_ALWAYS
)

178 || (
rc2
 =
MOSQ_ERR_SUCCESS
 && 
ªèö_h™dlög
 =
MQTT_SUB_OPT_SEND_RETAIN_NEW
)){

180 if(
	`sub__ªèö_queue
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, 
subs¸ùti⁄_idítifõr
)Ë
rc
 = 1;

184 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_SUBSCRIBE
, "%†%d %s", 
c⁄ãxt
->
id
, 
qos
, 
sub
);

186 
	`mosquôto__‰ì
(
sub
);

188 
tmp_∑ylﬂd
 = 
	`mosquôto__ªÆloc
(
∑ylﬂd
, 
∑ylﬂdÀn
 + 1);

189 if(
tmp_∑ylﬂd
){

190 
∑ylﬂd
 = 
tmp_∑ylﬂd
;

191 
∑ylﬂd
[
∑ylﬂdÀn
] = 
qos
;

192 
∑ylﬂdÀn
++;

194 
	`mosquôto__‰ì
(
∑ylﬂd
);

196  
MOSQ_ERR_NOMEM
;

201 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ31
){

202 if(
∑ylﬂdÀn
 == 0){

204  
MOSQ_ERR_PROTOCOL
;

207 if(
	`£nd__suback
(
c⁄ãxt
, 
mid
, 
∑ylﬂdÀn
, 
∑ylﬂd
)Ë
rc
 = 1;

208 
	`mosquôto__‰ì
(
∑ylﬂd
);

210 #ifde‡
WITH_PERSISTENCE


211 
db
->
≥rsi°í˚_ch™ges
++;

214  
rc
;

215 
	}
}

	@src/handle_unsubscribe.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"∑ckë_mosq.h
"

26 
	~"£nd_mosq.h
"

28 
	$h™dÀ__unsubs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

30 
uöt16_t
 
mid
;

31 *
sub
;

32 
¶í
;

33 
rc
;

34 
uöt8_t
 
ªas⁄
;

35 
ªas⁄_code_cou¡
 = 0;

36 
ªas⁄_code_max
;

37 
uöt8_t
 *
ªas⁄_codes
 = 
NULL
, *
ªas⁄_tmp
;

38 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

40 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

42 if(
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
){

43  
MOSQ_ERR_PROTOCOL
;

45 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived UNSUBSCRIBE from %s", 
c⁄ãxt
->
id
);

47 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ31
){

48 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x02){

49  
MOSQ_ERR_PROTOCOL
;

52 if(
	`∑ckë__ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
))  1;

53 if(
mid
 =0Ë 
MOSQ_ERR_PROTOCOL
;

55 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

56 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_UNSUBSCRIBE
, &
c⁄ãxt
->
ö_∑ckë
, &
¥›îtõs
);

57 if(
rc
) Ñc;

59 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

62 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

63 if(
c⁄ãxt
->
ö_∑ckë
.
pos
 =c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

65  
MOSQ_ERR_PROTOCOL
;

69 
ªas⁄_code_max
 = 10;

70 
ªas⁄_codes
 = 
	`mosquôto__mÆloc
(
ªas⁄_code_max
);

71 if(!
ªas⁄_codes
){

72  
MOSQ_ERR_NOMEM
;

75 
c⁄ãxt
->
ö_∑ckë
.
pos
 < c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

76 
sub
 = 
NULL
;

77 if(
	`∑ckë__ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
sub
, &
¶í
)){

81 if(!
¶í
){

82 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

84 
c⁄ãxt
->
id
);

85 
	`mosquôto__‰ì
(
sub
);

88 if(
	`mosquôto_sub_t›ic_check
(
sub
)){

89 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

91 
c⁄ãxt
->
id
);

92 
	`mosquôto__‰ì
(
sub
);

96 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "\t%s", 
sub
);

97 
rc
 = 
	`sub__ªmove
(
db
, 
c⁄ãxt
, 
sub
, db->
subs
, &
ªas⁄
);

98 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_UNSUBSCRIBE
, "%†%s", 
c⁄ãxt
->
id
, 
sub
);

99 
	`mosquôto__‰ì
(
sub
);

100 if(
rc
) Ñc;

102 
ªas⁄_codes
[
ªas⁄_code_cou¡
] = 
ªas⁄
;

103 
ªas⁄_code_cou¡
++;

104 if(
ªas⁄_code_cou¡
 =
ªas⁄_code_max
){

105 
ªas⁄_tmp
 = 
	`mosquôto__ªÆloc
(
ªas⁄_codes
, 
ªas⁄_code_max
*2);

106 if(!
ªas⁄_tmp
){

107 
	`mosquôto__‰ì
(
ªas⁄_codes
);

108  
MOSQ_ERR_NOMEM
;

110 
ªas⁄_codes
 = 
ªas⁄_tmp
;

111 
ªas⁄_code_max
 *= 2;

114 #ifde‡
WITH_PERSISTENCE


115 
db
->
≥rsi°í˚_ch™ges
++;

118 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög UNSUBACKÅÿ%s", 
c⁄ãxt
->
id
);

121 
rc
 = 
	`£nd__unsuback
(
c⁄ãxt
, 
mid
, 
ªas⁄_code_cou¡
, 
ªas⁄_codes
, 
NULL
);

122 
	`mosquôto__‰ì
(
ªas⁄_codes
);

123  
rc
;

124 
	}
}

	@src/lib_load.h

17 #i‚de‡
LIB_LOAD_H


18 
	#LIB_LOAD_H


	)

20 #ifde‡
WIN32


21 
	~<wödows.h
>

23 
	~<dlf˙.h
>

26 #ifde‡
WIN32


27 
	#LIB_LOAD
(
A
Ë
	`LﬂdLibøry
(A)

	)

28 
	#LIB_CLOSE
(
A
Ë
	`FªeLibøry
(A)

	)

29 
	#LIB_SYM
(
HANDLE
, 
SYM
Ë
	`GëProcAddªss
(HANDLE, SYM)

	)

31 
	#LIB_LOAD
(
A
Ë
	`dl›í
(A, 
RTLD_NOW
|
RTLD_GLOBAL
)

	)

32 
	#LIB_CLOSE
(
A
Ë
	`dl˛o£
(A)

	)

33 
	#LIB_SYM
(
HANDLE
, 
SYM
Ë
	`dlsym
(HANDLE, SYM)

	)

36 
	#LIB_SYM_EASY
(
MEMBER
, 
HANDLE
, 
SYM
Ëif(!(MEMBER = 
	`LIB_SYM
(HANDLE, SYM)Ë 1

	)

	@src/logging.c

16 
	~"c⁄fig.h
"

18 
	~<°d¨g.h
>

19 
	~<°dio.h
>

20 
	~<°rög.h
>

21 #i‚de‡
WIN32


22 
	~<sy¶og.h
>

24 
	~<time.h
>

26 #ifde‡
WITH_DLT


27 
	~<d…/d….h
>

30 
	~"mosquôto_brokî_öã∫Æ.h
"

31 
	~"mem‹y_mosq.h
"

32 
	~"utû_mosq.h
"

34 
mosquôto_db
 
öt_db
;

36 #ifde‡
WIN32


37 
HANDLE
 
	gsy¶og_h
;

52 
	glog_de°ö©i⁄s
 = 
MQTT3_LOG_STDERR
;

53 
	glog_¥i‹ôõs
 = 
MOSQ_LOG_ERR
 | 
MOSQ_LOG_WARNING
 | 
MOSQ_LOG_NOTICE
 | 
MOSQ_LOG_INFO
;

55 #ifde‡
WITH_DLT


56 
D…C⁄ãxt
 
	gd…C⁄ãxt
;

59 
	$gë_time
(
tm
 **
ti
)

61 #i‡
	`deföed
(
__APPLE__
)

62 
timevÆ
 
tv
;

64 
time•ec
 
ts
;

66 
time_t
 
s
;

68 #ifde‡
WIN32


69 
s
 = 
	`time
(
NULL
);

71 #ñi‡
	`deföed
(
__APPLE__
)

72 
	`gëtimeofday
(&
tv
, 
NULL
);

73 
s
 = 
tv
.
tv_£c
;

75 if(
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
ts
) != 0){

76 
	`Ârötf
(
°dîr
, "Error obtaining systemÅime.\n");

79 
s
 = 
ts
.
tv_£c
;

82 *
ti
 = 
	`loˇ…ime
(&
s
);

83 if(!(*
ti
)){

84 
	`Ârötf
(
°dîr
, "Error obtaining systemÅime.\n");

89 
	}
}

92 
	$log__öô
(
mosquôto__c⁄fig
 *
c⁄fig
)

94 
rc
 = 0;

96 
log_¥i‹ôõs
 = 
c⁄fig
->
log_ty≥
;

97 
log_de°ö©i⁄s
 = 
c⁄fig
->
log_de°
;

99 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

100 #i‚de‡
WIN32


101 
	`›ílog
("mosquôto", 
LOG_PID
|
LOG_CONS
, 
c⁄fig
->
log_Ácûôy
);

103 
sy¶og_h
 = 
	`O≥nEvítLog
(
NULL
, "mosquitto");

107 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
){

108 if(
	`dr›_¥ivûeges
(
c⁄fig
, 
åue
)){

111 
c⁄fig
->
log_Âå
 = 
	`mosquôto__f›í
(c⁄fig->
log_fûe
, "©", 
åue
);

112 if(!
c⁄fig
->
log_Âå
){

113 
log_de°ö©i⁄s
 = 
MQTT3_LOG_STDERR
;

114 
log_¥i‹ôõs
 = 
MOSQ_LOG_ERR
;

115 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íÜog fûê%†f‹ wrôög.", 
c⁄fig
->
log_fûe
);

116  
MOSQ_ERR_INVAL
;

118 
	`ª°‹e_¥ivûeges
();

120 #ifde‡
WITH_DLT


121 
	`DLT_REGISTER_APP
("MQTT","mosquittoÜog");

122 
	`d…_ªgi°î_c⁄ãxt
(&
d…C⁄ãxt
, "MQTT", "mosquitto DLT context");

124  
rc
;

125 
	}
}

127 
	$log__˛o£
(
mosquôto__c⁄fig
 *
c⁄fig
)

129 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

130 #i‚de‡
WIN32


131 
	`˛o£log
();

133 
	`Clo£EvítLog
(
sy¶og_h
);

136 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
){

137 if(
c⁄fig
->
log_Âå
){

138 
	`f˛o£
(
c⁄fig
->
log_Âå
);

139 
c⁄fig
->
log_Âå
 = 
NULL
;

143 #ifde‡
WITH_DLT


144 
	`d…_uƒegi°î_c⁄ãxt
(&
d…C⁄ãxt
);

145 
	`DLT_UNREGISTER_APP
();

148  
MOSQ_ERR_SUCCESS
;

149 
	}
}

151 #ifde‡
WITH_DLT


152 
D…LogLevñTy≥
 
	$gë_d…_Àvñ
(
¥i‹ôy
)

154 
¥i‹ôy
) {

155 
MOSQ_LOG_ERR
:

156  
DLT_LOG_ERROR
;

157 
MOSQ_LOG_WARNING
:

158  
DLT_LOG_WARN
;

159 
MOSQ_LOG_INFO
:

160  
DLT_LOG_INFO
;

161 
MOSQ_LOG_DEBUG
:

162  
DLT_LOG_DEBUG
;

163 
MOSQ_LOG_NOTICE
:

164 
MOSQ_LOG_SUBSCRIBE
:

165 
MOSQ_LOG_UNSUBSCRIBE
:

166  
DLT_LOG_VERBOSE
;

168  
DLT_LOG_DEFAULT
;

170 
	}
}

173 
	$log__v¥ötf
(
¥i‹ôy
, c⁄° *
fmt
, 
va_li°
 
va
)

175 *
s
;

176 *
°
;

177 
Àn
;

178 #ifde‡
WIN32


179 *
•
;

181 c⁄° *
t›ic
;

182 
sy¶og_¥i‹ôy
;

183 
time_t
 
now
 = 
	`time
(
NULL
);

184 
time_t
 
œ°_Êush
 = 0;

185 
time_buf
[50];

186 
boﬁ
 
log_time°amp
 = 
åue
;

187 *
log_time°amp_f‹m©
 = 
NULL
;

188 
FILE
 *
log_Âå
 = 
NULL
;

190 if(
öt_db
.
c⁄fig
){

191 
log_time°amp
 = 
öt_db
.
c⁄fig
->log_timestamp;

192 
log_time°amp_f‹m©
 = 
öt_db
.
c⁄fig
->log_timestamp_format;

193 
log_Âå
 = 
öt_db
.
c⁄fig
->log_fptr;

196 if((
log_¥i‹ôõs
 & 
¥i‹ôy
Ë&& 
log_de°ö©i⁄s
 !
MQTT3_LOG_NONE
){

197 
¥i‹ôy
){

198 
MOSQ_LOG_SUBSCRIBE
:

199 
t›ic
 = "$SYS/broker/log/M/subscribe";

200 #i‚de‡
WIN32


201 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

203 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

206 
MOSQ_LOG_UNSUBSCRIBE
:

207 
t›ic
 = "$SYS/broker/log/M/unsubscribe";

208 #i‚de‡
WIN32


209 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

211 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

214 
MOSQ_LOG_DEBUG
:

215 
t›ic
 = "$SYS/broker/log/D";

216 #i‚de‡
WIN32


217 
sy¶og_¥i‹ôy
 = 
LOG_DEBUG
;

219 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

222 
MOSQ_LOG_ERR
:

223 
t›ic
 = "$SYS/broker/log/E";

224 #i‚de‡
WIN32


225 
sy¶og_¥i‹ôy
 = 
LOG_ERR
;

227 
sy¶og_¥i‹ôy
 = 
EVENTLOG_ERROR_TYPE
;

230 
MOSQ_LOG_WARNING
:

231 
t›ic
 = "$SYS/broker/log/W";

232 #i‚de‡
WIN32


233 
sy¶og_¥i‹ôy
 = 
LOG_WARNING
;

235 
sy¶og_¥i‹ôy
 = 
EVENTLOG_WARNING_TYPE
;

238 
MOSQ_LOG_NOTICE
:

239 
t›ic
 = "$SYS/broker/log/N";

240 #i‚de‡
WIN32


241 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

243 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

246 
MOSQ_LOG_INFO
:

247 
t›ic
 = "$SYS/broker/log/I";

248 #i‚de‡
WIN32


249 
sy¶og_¥i‹ôy
 = 
LOG_INFO
;

251 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

254 #ifde‡
WITH_WEBSOCKETS


255 
MOSQ_LOG_WEBSOCKETS
:

256 
t›ic
 = "$SYS/broker/log/WS";

257 #i‚de‡
WIN32


258 
sy¶og_¥i‹ôy
 = 
LOG_DEBUG
;

260 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

265 
t›ic
 = "$SYS/broker/log/E";

266 #i‚de‡
WIN32


267 
sy¶og_¥i‹ôy
 = 
LOG_ERR
;

269 
sy¶og_¥i‹ôy
 = 
EVENTLOG_ERROR_TYPE
;

272 
Àn
 = 
	`°æí
(
fmt
) + 500;

273 
s
 = 
	`mosquôto__mÆloc
(
Àn
*());

274 if(!
s
Ë 
MOSQ_ERR_NOMEM
;

276 
	`v¢¥ötf
(
s
, 
Àn
, 
fmt
, 
va
);

277 
s
[
Àn
-1] = '\0';

279 if(
log_time°amp
 && 
log_time°amp_f‹m©
){

280 
tm
 *
ti
 = 
NULL
;

281 
	`gë_time
(&
ti
);

282 if(
	`°r·ime
(
time_buf
, 50, 
log_time°amp_f‹m©
, 
ti
) == 0){

283 
	`¢¥ötf
(
time_buf
, 50, "TimeÉrror");

286 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_STDOUT
){

287 if(
log_time°amp
){

288 if(
log_time°amp_f‹m©
){

289 
	`Ârötf
(
°dout
, "%s: %s\n", 
time_buf
, 
s
);

291 
	`Ârötf
(
°dout
, "%d: %s\n", ()
now
, 
s
);

294 
	`Ârötf
(
°dout
, "%s\n", 
s
);

296 
	`fÊush
(
°dout
);

298 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_STDERR
){

299 if(
log_time°amp
){

300 if(
log_time°amp_f‹m©
){

301 
	`Ârötf
(
°dîr
, "%s: %s\n", 
time_buf
, 
s
);

303 
	`Ârötf
(
°dîr
, "%d: %s\n", ()
now
, 
s
);

306 
	`Ârötf
(
°dîr
, "%s\n", 
s
);

308 
	`fÊush
(
°dîr
);

310 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
 && 
log_Âå
){

311 if(
log_time°amp
){

312 if(
log_time°amp_f‹m©
){

313 
	`Ârötf
(
log_Âå
, "%s: %s\n", 
time_buf
, 
s
);

315 
	`Ârötf
(
log_Âå
, "%d: %s\n", ()
now
, 
s
);

318 
	`Ârötf
(
log_Âå
, "%s\n", 
s
);

320 if(
now
 - 
œ°_Êush
 > 1){

321 
	`fÊush
(
log_Âå
);

322 
œ°_Êush
 = 
now
;

325 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

326 #i‚de‡
WIN32


327 
	`sy¶og
(
sy¶og_¥i‹ôy
, "%s", 
s
);

329 
•
 = (*)
s
;

330 
	`Rï‹tEvít
(
sy¶og_h
, 
sy¶og_¥i‹ôy
, 0, 0, 
NULL
, 1, 0, &
•
, NULL);

333 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_TOPIC
 && 
¥i‹ôy
 !
MOSQ_LOG_DEBUG
 &&Öri‹ôy !
MOSQ_LOG_INTERNAL
){

334 if(
log_time°amp
){

335 
Àn
 += 30;

336 
°
 = 
	`mosquôto__mÆloc
(
Àn
*());

337 if(!
°
){

338 
	`mosquôto__‰ì
(
s
);

339  
MOSQ_ERR_NOMEM
;

341 
	`¢¥ötf
(
°
, 
Àn
, "%d: %s", ()
now
, 
s
);

342 
	`db__mesßges_ósy_queue
(&
öt_db
, 
NULL
, 
t›ic
, 2, 
	`°æí
(
°
), st, 0, 20, NULL);

343 
	`mosquôto__‰ì
(
°
);

345 
	`db__mesßges_ósy_queue
(&
öt_db
, 
NULL
, 
t›ic
, 2, 
	`°æí
(
s
), s, 0, 20, NULL);

348 #ifde‡
WITH_DLT


349 if(
¥i‹ôy
 !
MOSQ_LOG_INTERNAL
){

350 
	`DLT_LOG_STRING
(
d…C⁄ãxt
, 
	`gë_d…_Àvñ
(
¥i‹ôy
), 
s
);

353 
	`mosquôto__‰ì
(
s
);

356  
MOSQ_ERR_SUCCESS
;

357 
	}
}

359 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

361 
va_li°
 
va
;

362 
rc
;

364 
	`UNUSED
(
mosq
);

366 
	`va_°¨t
(
va
, 
fmt
);

367 
rc
 = 
	`log__v¥ötf
(
¥i‹ôy
, 
fmt
, 
va
);

368 
	`va_íd
(
va
);

370  
rc
;

371 
	}
}

373 
	$log__öã∫Æ
(c⁄° *
fmt
, ...)

375 
va_li°
 
va
;

376 
buf
[200];

377 
Àn
;

379 
	`va_°¨t
(
va
, 
fmt
);

380 
Àn
 = 
	`v¢¥ötf
(
buf
, 200, 
fmt
, 
va
);

381 
	`va_íd
(
va
);

383 if(
Àn
 >= 200){

384 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INTERNAL
, "I¡î«»log buf„∏toÿsh‹à(%d)", 
Àn
);

388 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INTERNAL
, "%s%s%s", "\e[32m", 
buf
, "\e[0m");

389 
	}
}

391 
	$mosquôto_log_v¥ötf
(
Àvñ
, c⁄° *
fmt
, 
va_li°
 
va
)

393  
	`log__v¥ötf
(
Àvñ
, 
fmt
, 
va
);

394 
	}
}

396 
	$mosquôto_log_¥ötf
(
Àvñ
, c⁄° *
fmt
, ...)

398 
va_li°
 
va
;

400 
	`va_°¨t
(
va
, 
fmt
);

401 
	`log__v¥ötf
(
Àvñ
, 
fmt
, 
va
);

402 
	`va_íd
(
va
);

403 
	}
}

	@src/loop.c

18 
	~"c⁄fig.h
"

20 #i‚de‡
WIN32


21 
	#_GNU_SOURCE


	)

24 
	~<as£π.h
>

25 #i‚de‡
WIN32


26 #ifde‡
WITH_EPOLL


27 
	~<sys/ïﬁl.h
>

28 
	#MAX_EVENTS
 1000

	)

30 
	~<pﬁl.h
>

31 
	~<uni°d.h
>

33 
	~<¥o˚ss.h
>

34 
	~<wösock2.h
>

35 
	~<ws2t˝ù.h
>

38 
	~<î∫o.h
>

39 
	~<sig«l.h
>

40 
	~<°dio.h
>

41 
	~<°rög.h
>

42 #i‚de‡
WIN32


43 
	~<sys/sockë.h
>

45 
	~<time.h
>

47 #ifde‡
WITH_WEBSOCKETS


48 
	~<libwebsockës.h
>

51 
	~"mosquôto_brokî_öã∫Æ.h
"

52 
	~"mem‹y_mosq.h
"

53 
	~"∑ckë_mosq.h
"

54 
	~"£nd_mosq.h
"

55 
	~"sys_åì.h
"

56 
	~"time_mosq.h
"

57 
	~"utû_mosq.h
"

59 
boﬁ
 
Êag_ªlﬂd
;

60 #ifde‡
WITH_PERSISTENCE


61 
boﬁ
 
Êag_db_backup
;

63 
boﬁ
 
Êag_åì_¥öt
;

64 
run
;

66 #ifde‡
WITH_EPOLL


67 
lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
, 
uöt32_t
 
evíts
);

69 
lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
);

72 #ifde‡
WITH_WEBSOCKETS


73 
	$ãmp__expúe_websockës_˛õ¡s
(
mosquôto_db
 *
db
)

75 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

76 
time_t
 
œ°_check
 = 0;

77 
time_t
 
now
 = 
	`mosquôto_time
();

78 *
id
;

80 if(
now
 - 
œ°_check
 > 60){

81 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

82 if(
c⁄ãxt
->
wsi
 && c⁄ãxt->
sock
 !
INVALID_SOCKET
){

83 if(
c⁄ãxt
->
kì∑live
 && 
now
 - c⁄ãxt->
œ°_msg_ö
 > (
time_t
)(context->keepalive)*3/2){

84 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

85 if(
c⁄ãxt
->
id
){

86 
id
 = 
c⁄ãxt
->id;

88 
id
 = "<unknown>";

90 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

91 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†ha†ex˚ededÅimeout, disc⁄√˘ög.", 
id
);

95 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_KEEPALIVE
);

99 
œ°_check
 = 
	`mosquôto_time
();

101 
	}
}

104 #i‡
deföed
(
WITH_WEBSOCKETS
Ë&& 
LWS_LIBRARY_VERSION_NUMBER
 == 3002000

105 
	$lws__sul_ˇŒback
(
lws_s‹ãd_u£c_li°
 *
l
)

107 
	}
}

109 
lws_s‹ãd_u£c_li°
 
	gsul
;

112 
	$mosquôto_maö_lo›
(
mosquôto_db
 *
db
, 
mosq_sock_t
 *
li°ísock
, 
li°ísock_cou¡
)

114 #ifde‡
WITH_SYS_TREE


115 
time_t
 
°¨t_time
 = 
	`mosquôto_time
();

117 #ifde‡
WITH_PERSISTENCE


118 
time_t
 
œ°_backup
 = 
	`mosquôto_time
();

120 
time_t
 
now
 = 0;

121 
time_cou¡
;

122 
fdcou¡
;

123 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

124 #i‚de‡
WIN32


125 
sig£t_t
 
sigblock
, 
‹igsig
;

127 
i
;

128 #ifde‡
WITH_EPOLL


129 
j
;

130 
ïﬁl_evít
 
ev
, 
evíts
[
MAX_EVENTS
];

132 
pﬁlfd
 *
pﬁlfds
 = 
NULL
;

133 
pﬁlfd_ödex
;

134 
pﬁlfd_max
;

136 #ifde‡
WITH_BRIDGE


137 
rc
;

138 
îr
;

139 
sockÀn_t
 
Àn
;

141 
time_t
 
expú©i⁄_check_time
 = 0;

142 *
id
;

145 #i‡
	`deföed
(
WITH_WEBSOCKETS
Ë&& 
LWS_LIBRARY_VERSION_NUMBER
 == 3002000

146 
	`mem£t
(&
sul
, 0, (
lws_s‹ãd_u£c_li°
));

149 #i‚de‡
WIN32


150 
	`sigem±y£t
(&
sigblock
);

151 
	`sigadd£t
(&
sigblock
, 
SIGINT
);

152 
	`sigadd£t
(&
sigblock
, 
SIGTERM
);

153 
	`sigadd£t
(&
sigblock
, 
SIGUSR1
);

154 
	`sigadd£t
(&
sigblock
, 
SIGUSR2
);

155 
	`sigadd£t
(&
sigblock
, 
SIGHUP
);

158 #i‚de‡
WITH_EPOLL


159 #ifde‡
WIN32


160 
pﬁlfd_max
 = 
	`_gëmax°dio
();

162 
pﬁlfd_max
 = 
	`sysc⁄f
(
_SC_OPEN_MAX
);

165 
pﬁlfds
 = 
	`mosquôto__mÆloc
((
pﬁlfd
)*
pﬁlfd_max
);

166 if(!
pﬁlfds
){

167 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

168  
MOSQ_ERR_NOMEM
;

172 if(
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 > 0){

173 
expú©i⁄_check_time
 = 
	`time
(
NULL
) + 3600;

176 #ifde‡
WITH_EPOLL


177 
db
->
ïﬁlfd
 = 0;

178 i‡((
db
->
ïﬁlfd
 = 
	`ïﬁl_¸óã
(
MAX_EVENTS
)) == -1) {

179 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿ïﬁ»¸ótög: %s", 
	`°ªº‹
(
î∫o
));

180  
MOSQ_ERR_UNKNOWN
;

182 
	`mem£t
(&
ev
, 0, (
ïﬁl_evít
));

183 
	`mem£t
(&
evíts
, 0, (
ïﬁl_evít
)*
MAX_EVENTS
);

184 
i
=0; i<
li°ísock_cou¡
; i++){

185 
ev
.
d©a
.
fd
 = 
li°ísock
[
i
];

186 
ev
.
evíts
 = 
EPOLLIN
;

187 i‡(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
li°ísock
[
i
], &
ev
) == -1) {

188 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿ïﬁ»öôü»ªgi°îög: %s", 
	`°ªº‹
(
î∫o
));

189 ()
	`˛o£
(
db
->
ïﬁlfd
);

190 
db
->
ïﬁlfd
 = 0;

191  
MOSQ_ERR_UNKNOWN
;

194 #ifde‡
WITH_BRIDGE


195 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

196 if(
c⁄ãxt
->
bridge
){

197 
ev
.
d©a
.
fd
 = 
c⁄ãxt
->
sock
;

198 
ev
.
evíts
 = 
EPOLLIN
;

199 
c⁄ãxt
->
evíts
 = 
EPOLLIN
;

200 i‡(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

201 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿ïﬁ»öôü»ªgi°îög bridge: %s", 
	`°ªº‹
(
î∫o
));

202 ()
	`˛o£
(
db
->
ïﬁlfd
);

203 
db
->
ïﬁlfd
 = 0;

204  
MOSQ_ERR_UNKNOWN
;

211 
run
){

212 
	`c⁄ãxt__‰ì_disu£d
(
db
);

213 #ifde‡
WITH_SYS_TREE


214 if(
db
->
c⁄fig
->
sys_öãrvÆ
 > 0){

215 
	`sys_åì__upd©e
(
db
, db->
c⁄fig
->
sys_öãrvÆ
, 
°¨t_time
);

219 #i‚de‡
WITH_EPOLL


220 
	`mem£t
(
pﬁlfds
, -1, (
pﬁlfd
)*
pﬁlfd_max
);

222 
pﬁlfd_ödex
 = 0;

223 
i
=0; i<
li°ísock_cou¡
; i++){

224 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
li°ísock
[
i
];

225 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

226 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

227 
pﬁlfd_ödex
++;

231 
time_cou¡
 = 0;

232 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

233 if(
time_cou¡
 > 0){

234 
time_cou¡
--;

236 
time_cou¡
 = 1000;

237 
now
 = 
	`mosquôto_time
();

239 
c⁄ãxt
->
pﬁlfd_ödex
 = -1;

241 if(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
){

242 #ifde‡
WITH_BRIDGE


243 if(
c⁄ãxt
->
bridge
){

244 
	`mosquôto__check_kì∑live
(
db
, 
c⁄ãxt
);

245 if(
c⁄ãxt
->
bridge
->
round_robö
 =
Ál£


246 && 
c⁄ãxt
->
bridge
->
cur_addªss
 != 0

247 && 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy


248 && 
now
 > 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
){

250 if(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
 =
INVALID_SOCKET
){

251 
rc
 = 
	`√t__åy_c⁄√˘
(
c⁄ãxt
->
bridge
->
addªs£s
[0].
addªss
,

252 
c⁄ãxt
->
bridge
->
addªs£s
[0].
p‹t
,

253 &
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
, 
NULL
, 
Ál£
);

255 if(
rc
 == 0){

256 
	`COMPAT_CLOSE
(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
);

257 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
 = 
INVALID_SOCKET
;

258 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 0;

259 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

260 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

263 
Àn
 = ();

264 if(!
	`gësock›t
(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
îr
, &
Àn
)){

265 if(
îr
 == 0){

266 
	`COMPAT_CLOSE
(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
);

267 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
 = 
INVALID_SOCKET
;

268 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 0;

269 
	`√t__sockë_˛o£
(
db
, 
c⁄ãxt
);

270 
c⁄ãxt
->
bridge
->
cur_addªss
 = c⁄ãxt->bridge->
addªss_cou¡
-1;

272 
	`COMPAT_CLOSE
(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
);

273 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
 = 
INVALID_SOCKET
;

274 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 
now
+5;

277 
	`COMPAT_CLOSE
(
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
);

278 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy_sock
 = 
INVALID_SOCKET
;

279 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 
now
+5;

287 if(!(
c⁄ãxt
->
kì∑live
)

288 || 
c⁄ãxt
->
bridge


289 || 
now
 - 
c⁄ãxt
->
œ°_msg_ö
 <(
time_t
)(c⁄ãxt->
kì∑live
)*3/2){

291 if(
	`db__mesßge_wrôe
(
db
, 
c⁄ãxt
Ë=
MOSQ_ERR_SUCCESS
){

292 #ifde‡
WITH_EPOLL


293 if(
c⁄ãxt
->
cuºít_out_∑ckë
 || c⁄ãxt->
°©e
 =
mosq_cs_c⁄√˘_≥ndög
 || c⁄ãxt->
ws_w™t_wrôe
){

294 if(!(
c⁄ãxt
->
evíts
 & 
EPOLLOUT
)) {

295 
ev
.
d©a
.
fd
 = 
c⁄ãxt
->
sock
;

296 
ev
.
evíts
 = 
EPOLLIN
 | 
EPOLLOUT
;

297 if(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

298 if((
î∫o
 !
EEXIST
)||(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_MOD
, 
c⁄ãxt
->
sock
, &
ev
) == -1)) {

299 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»ª-ªgi°îögÅÿEPOLLOUT: %s", 
	`°ªº‹
(
î∫o
));

302 
c⁄ãxt
->
evíts
 = 
EPOLLIN
 | 
EPOLLOUT
;

304 
c⁄ãxt
->
ws_w™t_wrôe
 = 
Ál£
;

307 if(
c⁄ãxt
->
evíts
 & 
EPOLLOUT
) {

308 
ev
.
d©a
.
fd
 = 
c⁄ãxt
->
sock
;

309 
ev
.
evíts
 = 
EPOLLIN
;

310 if(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

311 if((
î∫o
 !
EEXIST
)||(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_MOD
, 
c⁄ãxt
->
sock
, &
ev
) == -1)) {

312 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»ª-ªgi°îögÅÿEPOLLIN: %s", 
	`°ªº‹
(
î∫o
));

315 
c⁄ãxt
->
evíts
 = 
EPOLLIN
;

319 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
c⁄ãxt
->
sock
;

320 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

321 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

322 if(
c⁄ãxt
->
cuºít_out_∑ckë
 || c⁄ãxt->
°©e
 =
mosq_cs_c⁄√˘_≥ndög
 || c⁄ãxt->
ws_w™t_wrôe
){

323 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 |
POLLOUT
;

324 
c⁄ãxt
->
ws_w™t_wrôe
 = 
Ál£
;

326 
c⁄ãxt
->
pﬁlfd_ödex
 =Öollfd_index;

327 
pﬁlfd_ödex
++;

330 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_CONN_LOST
);

334 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_KEEPALIVE
);

339 #ifde‡
WITH_BRIDGE


340 
time_cou¡
 = 0;

341 
i
=0; i<
db
->
bridge_cou¡
; i++){

342 if(!
db
->
bridges
[
i
]) ;

344 
c⁄ãxt
 = 
db
->
bridges
[
i
];

346 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

347 if(
time_cou¡
 > 0){

348 
time_cou¡
--;

350 
time_cou¡
 = 1000;

351 
now
 = 
	`mosquôto_time
();

354 if(!
c⁄ãxt
->
bridge
->
ª°¨t_t
){

355 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 
now
+c⁄ãxt->bridge->
ª°¨t_timeout
;

356 
c⁄ãxt
->
bridge
->
cur_addªss
++;

357 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

358 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

361 if((
c⁄ãxt
->
bridge
->
°¨t_ty≥
 =
b°_œzy
 && c⁄ãxt->bridge->
œzy_ªc⁄√˘
)

362 || (
c⁄ãxt
->
bridge
->
°¨t_ty≥
 =
b°_autom©ic
 && 
now
 > c⁄ãxt->bridge->
ª°¨t_t
)){

364 #i‡
	`deföed
(
__GLIBC__
Ë&& deföed(
WITH_ADNS
)

365 if(
c⁄ãxt
->
adns
){

367 
rc
 = 
	`gai_îr‹
(
c⁄ãxt
->
adns
);

368 if(
rc
 =
EAI_INPROGRESS
){

370 }if(
rc
 == 0){

371 
rc
 = 
	`bridge__c⁄√˘_°ï2
(
db
, 
c⁄ãxt
);

372 if(
rc
 =
MOSQ_ERR_SUCCESS
){

373 #ifde‡
WITH_EPOLL


374 
ev
.
d©a
.
fd
 = 
c⁄ãxt
->
sock
;

375 
ev
.
evíts
 = 
EPOLLIN
;

376 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

377 
ev
.
evíts
 |
EPOLLOUT
;

379 if(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

380 if((
î∫o
 !
EEXIST
)||(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_MOD
, 
c⁄ãxt
->
sock
, &
ev
) == -1)) {

381 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»ª-ªgi°îög bridge: %s", 
	`°ªº‹
(
î∫o
));

384 
c⁄ãxt
->
evíts
 = 
ev
.events;

387 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
c⁄ãxt
->
sock
;

388 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

389 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

390 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

391 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 |
POLLOUT
;

393 
c⁄ãxt
->
pﬁlfd_ödex
 =Öollfd_index;

394 
pﬁlfd_ödex
++;

396 }if(
rc
 =
MOSQ_ERR_CONN_PENDING
){

397 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 0;

399 
c⁄ãxt
->
bridge
->
cur_addªss
++;

400 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

401 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

403 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 0;

407 if(
c⁄ãxt
->
adns
->
¨_ªsu…
){

408 
	`‰ìaddröfo
(
c⁄ãxt
->
adns
->
¨_ªsu…
);

410 
	`mosquôto__‰ì
(
c⁄ãxt
->
adns
);

411 
c⁄ãxt
->
adns
 = 
NULL
;

412 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 0;

415 #ifde‡
WITH_EPOLL


417 
c⁄ãxt
->
evíts
 = 0;

419 
rc
 = 
	`bridge__c⁄√˘_°ï1
(
db
, 
c⁄ãxt
);

420 if(
rc
){

421 
c⁄ãxt
->
bridge
->
cur_addªss
++;

422 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

423 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

427 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 1;

432 
rc
 = 
	`bridge__c⁄√˘
(
db
, 
c⁄ãxt
);

433 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 0;

434 if(
rc
 =
MOSQ_ERR_SUCCESS
){

435 if(
c⁄ãxt
->
bridge
->
round_robö
 =
Ál£
 && c⁄ãxt->bridge->
cur_addªss
 != 0){

436 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 
now
 + 5;

438 #ifde‡
WITH_EPOLL


439 
ev
.
d©a
.
fd
 = 
c⁄ãxt
->
sock
;

440 
ev
.
evíts
 = 
EPOLLIN
;

441 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

442 
ev
.
evíts
 |
EPOLLOUT
;

444 if(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

445 if((
î∫o
 !
EEXIST
)||(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_MOD
, 
c⁄ãxt
->
sock
, &
ev
) == -1)) {

446 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»ª-ªgi°îög bridge: %s", 
	`°ªº‹
(
î∫o
));

449 
c⁄ãxt
->
evíts
 = 
ev
.events;

452 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
c⁄ãxt
->
sock
;

453 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

454 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

455 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

456 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 |
POLLOUT
;

458 
c⁄ãxt
->
pﬁlfd_ödex
 =Öollfd_index;

459 
pﬁlfd_ödex
++;

462 
c⁄ãxt
->
bridge
->
cur_addªss
++;

463 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

464 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

474 
now
 = 
	`time
(
NULL
);

475 if(
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 > 0 && 
now
 > 
expú©i⁄_check_time
){

476 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

477 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
 && c⁄ãxt->
£ssi⁄_expúy_öãrvÆ
 > 0 && c⁄ãxt->£ssi⁄_expúy_öãrvÆ !
UINT32_MAX
){

483 if(
now
 > 
c⁄ãxt
->
£ssi⁄_expúy_time
){

484 if(
c⁄ãxt
->
id
){

485 
id
 = 
c⁄ãxt
->id;

487 
id
 = "<unknown>";

489 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ExpúögÖîsi°íà˛õ¡ %†duêtÿtimeout.", 
id
);

490 
	`G_CLIENTS_EXPIRED_INC
();

491 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 0;

492 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_expúög
);

493 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_SUCCESS
);

497 
expú©i⁄_check_time
 = 
	`time
(
NULL
) + 3600;

500 #i‚de‡
WIN32


501 
	`sig¥ocmask
(
SIG_SETMASK
, &
sigblock
, &
‹igsig
);

502 #ifde‡
WITH_EPOLL


503 
fdcou¡
 = 
	`ïﬁl_waô
(
db
->
ïﬁlfd
, 
evíts
, 
MAX_EVENTS
, 100);

505 
fdcou¡
 = 
	`pﬁl
(
pﬁlfds
, 
pﬁlfd_ödex
, 100);

507 
	`sig¥ocmask
(
SIG_SETMASK
, &
‹igsig
, 
NULL
);

509 
fdcou¡
 = 
	`WSAPﬁl
(
pﬁlfds
, 
pﬁlfd_ödex
, 100);

511 #ifde‡
WITH_EPOLL


512 
fdcou¡
){

514 if(
î∫o
 !
EINTR
){

515 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿ïﬁ»waôög: %s.", 
	`°ªº‹
(
î∫o
));

521 
i
=0; i<
fdcou¡
; i++){

522 
j
=0; j<
li°ísock_cou¡
; j++){

523 i‡(
evíts
[
i
].
d©a
.
fd
 =
li°ísock
[
j
]) {

524 i‡(
evíts
[
i
].evít†& (
EPOLLIN
 | 
EPOLLPRI
)){

525 (
ev
.
d©a
.
fd
 = 
	`√t__sockë_ac˚±
(
db
, 
li°ísock
[
j
])) != -1){

526 
ev
.
evíts
 = 
EPOLLIN
;

527 i‡(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_ADD
, 
ev
.
d©a
.
fd
, &ev) == -1) {

528 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿ïﬁ»ac˚±ög: %s", 
	`°ªº‹
(
î∫o
));

530 
c⁄ãxt
 = 
NULL
;

531 
	`HASH_FIND
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, &(
ev
.
d©a
.
fd
), (
mosq_sock_t
), 
c⁄ãxt
);

532 if(!
c⁄ãxt
) {

533 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error inÉpolláccepting:Ço context");

535 
c⁄ãxt
->
evíts
 = 
EPOLLIN
;

541 i‡(
j
 =
li°ísock_cou¡
) {

542 
	`lo›_h™dÀ_ªads_wrôes
(
db
, 
evíts
[
i
].
d©a
.
fd
,Évents[i].events);

547 if(
fdcou¡
 == -1){

548 #ifde‡
WIN32


549 if(
pﬁlfd_ödex
 =0 && 
	`WSAGëLa°Eº‹
(Ë=
WSAEINVAL
){

554 
	`SÀï
(10);

558 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿pﬁl: %s.", 
	`°ªº‹
(
î∫o
));

561 
	`lo›_h™dÀ_ªads_wrôes
(
db
, 
pﬁlfds
);

563 
i
=0; i<
li°ísock_cou¡
; i++){

564 if(
pﬁlfds
[
i
].
ªvíts
 & (
POLLIN
 | 
POLLPRI
)){

565 
	`√t__sockë_ac˚±
(
db
, 
li°ísock
[
i
]) != -1){

571 
now
 = 
	`time
(
NULL
);

572 
	`£ssi⁄_expúy__check
(
db
, 
now
);

573 
	`wûl_dñay__check
(
db
, 
now
);

574 #ifde‡
WITH_PERSISTENCE


575 if(
db
->
c⁄fig
->
≥rsi°í˚
 && db->c⁄fig->
autoßve_öãrvÆ
){

576 if(
db
->
c⁄fig
->
autoßve_⁄_ch™ges
){

577 if(
db
->
≥rsi°í˚_ch™ges
 >db->
c⁄fig
->
autoßve_öãrvÆ
){

578 
	`≥rsi°__backup
(
db
, 
Ál£
);

579 
db
->
≥rsi°í˚_ch™ges
 = 0;

582 if(
œ°_backup
 + 
db
->
c⁄fig
->
autoßve_öãrvÆ
 < 
	`mosquôto_time
()){

583 
	`≥rsi°__backup
(
db
, 
Ál£
);

584 
œ°_backup
 = 
	`mosquôto_time
();

590 #ifde‡
WITH_PERSISTENCE


591 if(
Êag_db_backup
){

592 
	`≥rsi°__backup
(
db
, 
Ál£
);

593 
Êag_db_backup
 = 
Ál£
;

596 if(
Êag_ªlﬂd
){

597 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Reloading config.");

598 
	`c⁄fig__ªad
(
db
, db->
c⁄fig
, 
åue
);

599 
	`mosquôto_£curôy_˛ónup
(
db
, 
åue
);

600 
	`mosquôto_£curôy_öô
(
db
, 
åue
);

601 
	`mosquôto_£curôy_≠∂y
(
db
);

602 
	`log__˛o£
(
db
->
c⁄fig
);

603 
	`log__öô
(
db
->
c⁄fig
);

604 
Êag_ªlﬂd
 = 
Ál£
;

606 if(
Êag_åì_¥öt
){

607 
	`sub__åì_¥öt
(
db
->
subs
, 0);

608 
Êag_åì_¥öt
 = 
Ál£
;

610 #ifde‡
WITH_WEBSOCKETS


611 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

616 if(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
){

617 #i‡
LWS_LIBRARY_VERSION_NUMBER
 > 3002000

618 
	`libwebsockë_£rvi˚
(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
, -1);

619 #ñi‡
LWS_LIBRARY_VERSION_NUMBER
 == 3002000

620 
	`lws_sul_scheduÀ
(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
, 0, &
sul
, 
lws__sul_ˇŒback
, 10);

621 
	`libwebsockë_£rvi˚
(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
, 0);

623 
	`libwebsockë_£rvi˚
(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
, 0);

628 if(
db
->
c⁄fig
->
have_websockës_li°íî
){

629 
	`ãmp__expúe_websockës_˛õ¡s
(
db
);

634 #ifde‡
WITH_EPOLL


635 (Ë
	`˛o£
(
db
->
ïﬁlfd
);

636 
db
->
ïﬁlfd
 = 0;

638 
	`mosquôto__‰ì
(
pﬁlfds
);

640  
MOSQ_ERR_SUCCESS
;

641 
	}
}

643 
	$do_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ªas⁄
)

645 *
id
;

646 #ifde‡
WITH_EPOLL


647 
ïﬁl_evít
 
ev
;

649 #ifde‡
WITH_WEBSOCKETS


650 
boﬁ
 
is_du∂iˇã
 = 
Ál£
;

653 if(
c⁄ãxt
->
°©e
 =
mosq_cs_disc⁄√˘ed
){

656 #ifde‡
WITH_WEBSOCKETS


657 if(
c⁄ãxt
->
wsi
){

658 if(
c⁄ãxt
->
°©e
 =
mosq_cs_du∂iˇã
){

659 
is_du∂iˇã
 = 
åue
;

662 if(
c⁄ãxt
->
°©e
 !
mosq_cs_disc⁄√˘ög
 && c⁄ãxt->°©ê!
mosq_cs_disc⁄√˘_wôh_wûl
){

663 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘_ws
);

665 if(
c⁄ãxt
->
wsi
){

666 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
->
ws_c⁄ãxt
, c⁄ãxt->
wsi
);

668 if(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
){

669 
	`HASH_DELETE
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
);

670 #ifde‡
WITH_EPOLL


671 i‡(
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_DEL
, 
c⁄ãxt
->
sock
, &
ev
) == -1) {

672 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»disc⁄√˘ög websockës: %s", 
	`°ªº‹
(
î∫o
));

675 
c⁄ãxt
->
sock
 = 
INVALID_SOCKET
;

676 
c⁄ãxt
->
pﬁlfd_ödex
 = -1;

678 if(
is_du∂iˇã
){

685 
	`c⁄ãxt__ªmove_‰om_by_id
(
db
, 
c⁄ãxt
);

690 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

691 if(
c⁄ãxt
->
id
){

692 
id
 = 
c⁄ãxt
->id;

694 
id
 = "<unknown>";

696 if(
c⁄ãxt
->
°©e
 !
mosq_cs_disc⁄√˘ög
 && c⁄ãxt->°©ê!
mosq_cs_disc⁄√˘_wôh_wûl
){

697 
ªas⁄
){

698 
MOSQ_ERR_SUCCESS
:

700 
MOSQ_ERR_PROTOCOL
:

701 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†disc⁄√˘ed duêtÿ¥ŸocﬁÉº‹.", 
id
);

703 
MOSQ_ERR_CONN_LOST
:

704 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "SockëÉº‹ o¿˛õ¡ %s, disc⁄√˘ög.", 
id
);

706 
MOSQ_ERR_AUTH
:

707 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†disc⁄√˘ed,Çÿl⁄gîáuth‹i£d.", 
id
);

709 
MOSQ_ERR_KEEPALIVE
:

710 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†ha†ex˚ededÅimeout, disc⁄√˘ög.", 
id
);

713 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "SockëÉº‹ o¿˛õ¡ %s, disc⁄√˘ög.", 
id
);

717 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†disc⁄√˘ed.", 
id
);

720 #ifde‡
WITH_EPOLL


721 i‡(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
 && 
	`ïﬁl_˘l
(
db
->
ïﬁlfd
, 
EPOLL_CTL_DEL
, c⁄ãxt->sock, &
ev
) == -1) {

722 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

723 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Eº‹ i¿ïﬁ»disc⁄√˘ög: %s", 
	`°ªº‹
(
î∫o
));

727 
	`c⁄ãxt__disc⁄√˘
(
db
, 
c⁄ãxt
);

729 
	}
}

732 #ifde‡
WITH_EPOLL


733 
	$lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
, 
uöt32_t
 
evíts
)

735 
	$lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
)

738 
mosquôto
 *
c⁄ãxt
;

739 #i‚de‡
WITH_EPOLL


740 
mosquôto
 *
˘xt_tmp
;

742 
îr
;

743 
sockÀn_t
 
Àn
;

744 
rc
;

746 #ifde‡
WITH_EPOLL


747 
i
;

748 
c⁄ãxt
 = 
NULL
;

749 
	`HASH_FIND
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, &
sock
, (
mosq_sock_t
), 
c⁄ãxt
);

750 if(!
c⁄ãxt
) {

753 
i
=0;i<1;i++) {

755 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

756 if(
c⁄ãxt
->
pﬁlfd_ödex
 < 0){

760 
	`as£π
(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
fd
 =c⁄ãxt->
sock
);

763 #ifde‡
WITH_WEBSOCKETS


764 if(
c⁄ãxt
->
wsi
){

765 
lws_pﬁlfd
 
w•ﬁl
;

766 #ifde‡
WITH_EPOLL


767 
w•ﬁl
.
fd
 = 
c⁄ãxt
->
sock
;

768 
w•ﬁl
.
evíts
 = 
c⁄ãxt
->events;

769 
w•ﬁl
.
ªvíts
 = 
evíts
;

771 
w•ﬁl
.
fd
 = 
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].fd;

772 
w•ﬁl
.
evíts
 = 
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].events;

773 
w•ﬁl
.
ªvíts
 = 
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].revents;

775 #ifde‡
LWS_LIBRARY_VERSION_NUMBER


776 
	`lws_£rvi˚_fd
(
	`lws_gë_c⁄ãxt
(
c⁄ãxt
->
wsi
), &
w•ﬁl
);

778 
	`lws_£rvi˚_fd
(
c⁄ãxt
->
ws_c⁄ãxt
, &
w•ﬁl
);

784 #ifde‡
WITH_TLS


785 #ifde‡
WITH_EPOLL


786 if(
evíts
 & 
EPOLLOUT
 ||

788 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLOUT
 ||

790 
c⁄ãxt
->
w™t_wrôe
 ||

791 (
c⁄ãxt
->
s¶
 && c⁄ãxt->
°©e
 =
mosq_cs_√w
)){

793 #ifde‡
WITH_EPOLL


794 if(
evíts
 & 
EPOLLOUT
){

796 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLOUT
){

799 if(
c⁄ãxt
->
°©e
 =
mosq_cs_c⁄√˘_≥ndög
){

800 
Àn
 = ();

801 if(!
	`gësock›t
(
c⁄ãxt
->
sock
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
îr
, &
Àn
)){

802 if(
îr
 == 0){

803 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_√w
);

804 #i‡
	`deföed
(
WITH_ADNS
Ë&& deföed(
WITH_BRIDGE
)

805 if(
c⁄ãxt
->
bridge
){

806 
	`bridge__c⁄√˘_°ï3
(
db
, 
c⁄ãxt
);

812 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_CONN_LOST
);

816 
rc
 = 
	`∑ckë__wrôe
(
c⁄ãxt
);

817 if(
rc
){

818 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
rc
);

824 #ifde‡
WITH_EPOLL


825 
c⁄ãxt
 = 
NULL
;

826 
	`HASH_FIND
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, &
sock
, (
mosq_sock_t
), 
c⁄ãxt
);

827 if(!
c⁄ãxt
) {

830 
i
=0;i<1;i++) {

832 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

833 if(
c⁄ãxt
->
pﬁlfd_ödex
 < 0){

837 #ifde‡
WITH_WEBSOCKETS


838 if(
c⁄ãxt
->
wsi
){

844 #ifde‡
WITH_TLS


845 #ifde‡
WITH_EPOLL


846 if(
evíts
 & 
EPOLLIN
 ||

848 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLIN
 ||

850 (
c⁄ãxt
->
s¶
 && c⁄ãxt->
°©e
 =
mosq_cs_√w
)){

852 #ifde‡
WITH_EPOLL


853 if(
evíts
 & 
EPOLLIN
){

855 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLIN
){

859 
rc
 = 
	`∑ckë__ªad
(
db
, 
c⁄ãxt
);

860 if(
rc
){

861 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
rc
);

864 }
	`SSL_DATA_PENDING
(
c⁄ãxt
));

866 #ifde‡
WITH_EPOLL


867 if(
evíts
 & (
EPOLLERR
 | 
EPOLLHUP
)){

869 if(
c⁄ãxt
->
pﬁlfd_ödex
 >0 && 
pﬁlfds
[c⁄ãxt->pﬁlfd_ödex].
ªvíts
 & (
POLLERR
 | 
POLLNVAL
 | 
POLLHUP
)){

871 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_CONN_LOST
);

876 
	}
}

	@src/mosquitto.c

17 
	~"c⁄fig.h
"

19 #i‚de‡
WIN32


21 
	~<uni°d.h
>

22 
	~<gΩ.h
>

23 
	~<as£π.h
>

26 #i‚de‡
WIN32


27 
	~<pwd.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	~<ws2t˝ù.h
>

34 #i‚de‡
WIN32


35 
	~<sys/time.h
>

38 
	~<î∫o.h
>

39 
	~<sig«l.h
>

40 
	~<°dio.h
>

41 
	~<°rög.h
>

42 #ifde‡
WITH_SYSTEMD


43 
	~<sy°emd/sd-d´m⁄.h
>

45 #ifde‡
WITH_WRAP


46 
	~<t˝d.h
>

48 #ifde‡
WITH_WEBSOCKETS


49 
	~<libwebsockës.h
>

52 
	~"mosquôto_brokî_öã∫Æ.h
"

53 
	~"mem‹y_mosq.h
"

54 
	~"utû_mosq.h
"

56 
mosquôto_db
 
	göt_db
;

58 
boﬁ
 
	gÊag_ªlﬂd
 = 
Ál£
;

59 #ifde‡
WITH_PERSISTENCE


60 
boﬁ
 
	gÊag_db_backup
 = 
Ál£
;

62 
boﬁ
 
	gÊag_åì_¥öt
 = 
Ál£
;

63 
	grun
;

64 #ifde‡
WITH_WRAP


65 
	~<sy¶og.h
>

66 
	gÆlow_£vîôy
 = 
LOG_INFO
;

67 
	gdíy_£vîôy
 = 
LOG_INFO
;

70 
h™dÀ_sigöt
(
sig«l
);

71 
h™dÀ_sigu§1
(
sig«l
);

72 
h™dÀ_sigu§2
(
sig«l
);

73 #ifde‡
SIGHUP


74 
h™dÀ_sighup
(
sig«l
);

77 
mosquôto_db
 *
	$mosquôto__gë_db
()

79  &
öt_db
;

80 
	}
}

90 
	$dr›_¥ivûeges
(
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ãmp‹¨y
)

92 #i‡!
	`deföed
(
__CYGWIN__
Ë&& !deföed(
WIN32
)

93 
∑sswd
 *
pwd
;

94 *
îr
;

95 
rc
;

97 c⁄° *
¢≠
 = 
	`gëív
("SNAP_NAME");

98 if(
¢≠
 && !
	`°rcmp
(snap, "mosquitto")){

100  
MOSQ_ERR_SUCCESS
;

103 if(
	`gëeuid
() == 0){

104 if(
c⁄fig
->
u£r
 && 
	`°rcmp
(config->user, "root")){

105 
pwd
 = 
	`gëpw«m
(
c⁄fig
->
u£r
);

106 if(!
pwd
){

107 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid u£∏'%s'.", 
c⁄fig
->
u£r
);

110 if(
	`öôgroups
(
c⁄fig
->
u£r
, 
pwd
->
pw_gid
) == -1){

111 
îr
 = 
	`°ªº‹
(
î∫o
);

112 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög group†whû° dr›pögÖrivûeges: %s.", 
îr
);

115 if(
ãmp‹¨y
){

116 
rc
 = 
	`£ãgid
(
pwd
->
pw_gid
);

118 
rc
 = 
	`£tgid
(
pwd
->
pw_gid
);

120 if(
rc
 == -1){

121 
îr
 = 
	`°ªº‹
(
î∫o
);

122 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög gid whû° dr›pögÖrivûeges: %s.", 
îr
);

125 if(
ãmp‹¨y
){

126 
rc
 = 
	`£ãuid
(
pwd
->
pw_uid
);

128 
rc
 = 
	`£tuid
(
pwd
->
pw_uid
);

130 if(
rc
 == -1){

131 
îr
 = 
	`°ªº‹
(
î∫o
);

132 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög uid whû° dr›pögÖrivûeges: %s.", 
îr
);

136 if(
	`gëeuid
(Ë=0 || 
	`gëegid
() == 0){

137 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Mosquitto shouldÇot beÑunásÑoot/administrator.");

141  
MOSQ_ERR_SUCCESS
;

142 
	}
}

144 
	$ª°‹e_¥ivûeges
()

146 #i‡!
	`deföed
(
__CYGWIN__
Ë&& !deföed(
WIN32
)

147 *
îr
;

148 
rc
;

150 if(
	`gëuid
() == 0){

151 
rc
 = 
	`£ãgid
(0);

152 if(
rc
 == -1){

153 
îr
 = 
	`°ªº‹
(
î∫o
);

154 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög gid whû°Ñe°‹ögÖrivûeges: %s.", 
îr
);

157 
rc
 = 
	`£ãuid
(0);

158 if(
rc
 == -1){

159 
îr
 = 
	`°ªº‹
(
î∫o
);

160 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög uid whû°Ñe°‹ögÖrivûeges: %s.", 
îr
);

165  
MOSQ_ERR_SUCCESS
;

166 
	}
}

169 
	$mosquôto__d´m⁄i£
()

171 #i‚de‡
WIN32


172 *
îr
;

173 
pid_t
 
pid
;

175 
pid
 = 
	`f‹k
();

176 if(
pid
 < 0){

177 
îr
 = 
	`°ªº‹
(
î∫o
);

178 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿f‹k: %s", 
îr
);

179 
	`exô
(1);

181 if(
pid
 > 0){

182 
	`exô
(0);

184 if(
	`£tsid
() < 0){

185 
îr
 = 
	`°ªº‹
(
î∫o
);

186 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿£tsid: %s", 
îr
);

187 
	`exô
(1);

190 
	`as£π
(
	`‰e›í
("/dev/nuŒ", "r", 
°dö
));

191 
	`as£π
(
	`‰e›í
("/dev/nuŒ", "w", 
°dout
));

192 
	`as£π
(
	`‰e›í
("/dev/nuŒ", "w", 
°dîr
));

194 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Can't start in daemon mode in Windows.");

196 
	}
}

199 
	$maö
(
¨gc
, *
¨gv
[])

201 
mosq_sock_t
 *
li°ísock
 = 
NULL
;

202 
li°ísock_cou¡
 = 0;

203 
li°ísock_ödex
 = 0;

204 
mosquôto__c⁄fig
 
c⁄fig
;

205 
i
, 
j
;

206 
FILE
 *
pid
;

207 
rc
;

208 #ifde‡
WIN32


209 
SYSTEMTIME
 
°
;

211 
timevÆ
 
tv
;

213 
mosquôto
 *
˘xt
, *
˘xt_tmp
;

215 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

216 if(
¨gc
 == 2){

217 if(!
	`°rcmp
(
¨gv
[1], "run")){

218 
	`£rvi˚_run
();

220 }if(!
	`°rcmp
(
¨gv
[1], "install")){

221 
	`£rvi˚_ö°Æl
();

223 }if(!
	`°rcmp
(
¨gv
[1], "uninstall")){

224 
	`£rvi˚_unö°Æl
();

231 #ifde‡
WIN32


232 
	`GëSy°emTime
(&
°
);

233 
	`§™d
(
°
.
wSec⁄d
 + st.
wMûli£c⁄ds
);

235 
	`gëtimeofday
(&
tv
, 
NULL
);

236 
	`§™d
(
tv
.
tv_£c
 +Åv.
tv_u£c
);

239 #ifde‡
WIN32


240 
	`_£tmax°dio
(2048);

243 
	`mem£t
(&
öt_db
, 0, (
mosquôto_db
));

245 
	`√t__brokî_öô
();

247 
	`c⁄fig__öô
(&
öt_db
, &
c⁄fig
);

248 
rc
 = 
	`c⁄fig__∑r£_¨gs
(&
öt_db
, &
c⁄fig
, 
¨gc
, 
¨gv
);

249 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

250 
öt_db
.
c⁄fig
 = &config;

252 if(
c⁄fig
.
d´m⁄
){

253 
	`mosquôto__d´m⁄i£
();

256 if(
c⁄fig
.
d´m⁄
 && c⁄fig.
pid_fûe
){

257 
pid
 = 
	`mosquôto__f›í
(
c⁄fig
.
pid_fûe
, "wt", 
Ál£
);

258 if(
pid
){

259 
	`Ârötf
(
pid
, "%d", 
	`gëpid
());

260 
	`f˛o£
(
pid
);

262 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo writeÖid file.");

267 
rc
 = 
	`db__›í
(&
c⁄fig
, &
öt_db
);

268 if(
rc
 !
MOSQ_ERR_SUCCESS
){

269 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Couldn't open database.");

270  
rc
;

275 if(
	`log__öô
(&
c⁄fig
)){

276 
rc
 = 1;

277  
rc
;

279 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "mosquôtÿvîsi⁄ %†°¨tög", 
VERSION
);

280 if(
öt_db
.
c⁄fig_fûe
){

281 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "C⁄figÜﬂded from %s.", 
öt_db
.
c⁄fig_fûe
);

283 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Using default config.");

286 
rc
 = 
	`mosquôto_£curôy_moduÀ_öô
(&
öt_db
);

287 if(
rc
) Ñc;

288 
rc
 = 
	`mosquôto_£curôy_öô
(&
öt_db
, 
Ál£
);

289 if(
rc
) Ñc;

291 #ifde‡
WITH_SYS_TREE


292 
	`sys_åì__öô
(&
öt_db
);

295 
li°ísock_ödex
 = 0;

296 
i
=0; i<
c⁄fig
.
li°íî_cou¡
; i++){

297 if(
c⁄fig
.
li°íîs
[
i
].
¥Ÿocﬁ
 =
mp_mqâ
){

298 if(
	`√t__sockë_li°í
(&
c⁄fig
.
li°íîs
[
i
])){

299 
	`db__˛o£
(&
öt_db
);

300 if(
c⁄fig
.
pid_fûe
){

301 
	`ªmove
(
c⁄fig
.
pid_fûe
);

305 
li°ísock_cou¡
 +
c⁄fig
.
li°íîs
[
i
].
sock_cou¡
;

306 
li°ísock
 = 
	`mosquôto__ªÆloc
÷i°ísock, (
mosq_sock_t
)*
li°ísock_cou¡
);

307 if(!
li°ísock
){

308 
	`db__˛o£
(&
öt_db
);

309 if(
c⁄fig
.
pid_fûe
){

310 
	`ªmove
(
c⁄fig
.
pid_fûe
);

314 
j
=0; j<
c⁄fig
.
li°íîs
[
i
].
sock_cou¡
; j++){

315 if(
c⁄fig
.
li°íîs
[
i
].
socks
[
j
] =
INVALID_SOCKET
){

316 
	`db__˛o£
(&
öt_db
);

317 if(
c⁄fig
.
pid_fûe
){

318 
	`ªmove
(
c⁄fig
.
pid_fûe
);

322 
li°ísock
[
li°ísock_ödex
] = 
c⁄fig
.
li°íîs
[
i
].
socks
[
j
];

323 
li°ísock_ödex
++;

325 }if(
c⁄fig
.
li°íîs
[
i
].
¥Ÿocﬁ
 =
mp_websockës
){

326 #ifde‡
WITH_WEBSOCKETS


327 
c⁄fig
.
li°íîs
[
i
].
ws_c⁄ãxt
 = 
	`mosq_websockës_öô
(&config.listeners[i], &config);

328 if(!
c⁄fig
.
li°íîs
[
i
].
ws_c⁄ãxt
){

329 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ¸óã websockë†li°íî o¿p‹à%d.", 
c⁄fig
.
li°íîs
[
i
].
p‹t
);

336 
rc
 = 
	`dr›_¥ivûeges
(&
c⁄fig
, 
Ál£
);

337 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

339 
	`sig«l
(
SIGINT
, 
h™dÀ_sigöt
);

340 
	`sig«l
(
SIGTERM
, 
h™dÀ_sigöt
);

341 #ifde‡
SIGHUP


342 
	`sig«l
(
SIGHUP
, 
h™dÀ_sighup
);

344 #i‚de‡
WIN32


345 
	`sig«l
(
SIGUSR1
, 
h™dÀ_sigu§1
);

346 
	`sig«l
(
SIGUSR2
, 
h™dÀ_sigu§2
);

347 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

349 #ifde‡
WIN32


350 
	`Cª©eThªad
(
NULL
, 0, 
SigThªadProc
, NULL, 0, NULL);

353 #ifde‡
WITH_BRIDGE


354 
i
=0; i<
c⁄fig
.
bridge_cou¡
; i++){

355 if(
	`bridge__√w
(&
öt_db
, &(
c⁄fig
.
bridges
[
i
]))){

356 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: UnableÅo connectÅo bridge %s.",

357 
c⁄fig
.
bridges
[
i
].
«me
);

362 #ifde‡
WITH_SYSTEMD


363 
	`sd_nŸify
(0, "READY=1");

366 
run
 = 1;

367 
rc
 = 
	`mosquôto_maö_lo›
(&
öt_db
, 
li°ísock
, 
li°ísock_cou¡
);

369 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "mosquôtÿvîsi⁄ %†ãrmö©ög", 
VERSION
);

371 #ifde‡
WITH_WEBSOCKETS


372 
i
=0; i<
öt_db
.
c⁄fig
->
li°íî_cou¡
; i++){

373 if(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
){

374 
	`libwebsockë_c⁄ãxt_de°roy
(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
);

376 
	`mosquôto__‰ì
(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_¥Ÿocﬁ
);

383 
	`HASH_ITER
(
hh_id
, 
öt_db
.
c⁄ãxts_by_id
, 
˘xt
, 
˘xt_tmp
){

384 
	`c⁄ãxt__£nd_wûl
(&
öt_db
, 
˘xt
);

386 
	`wûl_dñay__£nd_Æl
(&
öt_db
);

388 #ifde‡
WITH_PERSISTENCE


389 if(
c⁄fig
.
≥rsi°í˚
){

390 
	`≥rsi°__backup
(&
öt_db
, 
åue
);

393 
	`£ssi⁄_expúy__ªmove_Æl
(&
öt_db
);

395 
	`HASH_ITER
(
hh_id
, 
öt_db
.
c⁄ãxts_by_id
, 
˘xt
, 
˘xt_tmp
){

396 #ifde‡
WITH_WEBSOCKETS


397 if(!
˘xt
->
wsi
){

398 
	`c⁄ãxt__˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

401 
	`c⁄ãxt__˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

404 
	`HASH_ITER
(
hh_sock
, 
öt_db
.
c⁄ãxts_by_sock
, 
˘xt
, 
˘xt_tmp
){

405 
	`c⁄ãxt__˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

407 #ifde‡
WITH_BRIDGE


408 
i
=0; i<
öt_db
.
bridge_cou¡
; i++){

409 if(
öt_db
.
bridges
[
i
]){

410 
	`c⁄ãxt__˛ónup
(&
öt_db
, i¡_db.
bridges
[
i
], 
åue
);

413 
	`mosquôto__‰ì
(
öt_db
.
bridges
);

415 
	`c⁄ãxt__‰ì_disu£d
(&
öt_db
);

417 
	`db__˛o£
(&
öt_db
);

419 if(
li°ísock
){

420 
i
=0; i<
li°ísock_cou¡
; i++){

421 if(
li°ísock
[
i
] !
INVALID_SOCKET
){

422 #i‚de‡
WIN32


423 
	`˛o£
(
li°ísock
[
i
]);

425 
	`˛o£sockë
(
li°ísock
[
i
]);

429 
	`mosquôto__‰ì
(
li°ísock
);

432 
	`mosquôto_£curôy_moduÀ_˛ónup
(&
öt_db
);

434 if(
c⁄fig
.
pid_fûe
){

435 
	`ªmove
(
c⁄fig
.
pid_fûe
);

438 
	`log__˛o£
(&
c⁄fig
);

439 
	`c⁄fig__˛ónup
(
öt_db
.
c⁄fig
);

440 
	`√t__brokî_˛ónup
();

442  
rc
;

443 
	}
}

445 #ifde‡
WIN32


446 
WINAPI
 
	$WöMaö
(
HINSTANCE
 
hIn°™˚
, HINSTANCE 
hPªvIn°™˚
, 
LPSTR
 
ÕCmdLöe
, 
nCmdShow
)

448 **
¨gv
;

449 
¨gc
 = 1;

450 *
tokí
;

451 *
ßvïå
 = 
NULL
;

452 
rc
;

454 
¨gv
 = 
	`mosquôto__mÆloc
((*)*1);

455 
¨gv
[0] = "mosquitto";

456 
tokí
 = 
	`°πok_r
(
ÕCmdLöe
, " ", &
ßvïå
);

457 
tokí
){

458 
¨gc
++;

459 
¨gv
 = 
	`mosquôto__ªÆloc
◊rgv, (*)*
¨gc
);

460 if(!
¨gv
){

461 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

462  
MOSQ_ERR_NOMEM
;

464 
¨gv
[
¨gc
-1] = 
tokí
;

465 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

467 
rc
 = 
	`maö
(
¨gc
, 
¨gv
);

468 
	`mosquôto__‰ì
(
¨gv
);

469  
rc
;

470 
	}
}

	@src/mosquitto_broker.h

17 #i‚de‡
MOSQUITTO_BROKER_H


18 
	#MOSQUITTO_BROKER_H


	)

20 #ifde‡
__˝lu•lus


24 
	~<°dboﬁ.h
>

26 
mosquôto
;

28 
	emosquôto_¥Ÿocﬁ
 {

29 
mp_mqâ
,

30 
mp_mqâ¢
,

31 
mp_websockës


65 
mosquôto_log_¥ötf
(
Àvñ
, c⁄° *
fmt
, ...);

81 c⁄° *
mosquôto_˛õ¡_addªss
(c⁄° 
mosquôto
 *
˛õ¡
);

89 
boﬁ
 
mosquôto_˛õ¡_˛ón_£ssi⁄
(c⁄° 
mosquôto
 *
˛õ¡
);

97 c⁄° *
mosquôto_˛õ¡_id
(c⁄° 
mosquôto
 *
˛õ¡
);

105 
mosquôto_˛õ¡_kì∑live
(c⁄° 
mosquôto
 *
˛õ¡
);

118 *
mosquôto_˛õ¡_˚πifiˇã
(c⁄° 
mosquôto
 *
˛õ¡
);

130 
mosquôto_˛õ¡_¥Ÿocﬁ
(c⁄° 
mosquôto
 *
˛õ¡
);

138 
mosquôto_˛õ¡_sub_cou¡
(c⁄° 
mosquôto
 *
˛õ¡
);

146 c⁄° *
mosquôto_˛õ¡_u£∫ame
(c⁄° 
mosquôto
 *
˛õ¡
);

166 
mosquôto_£t_u£∫ame
(
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
);

168 #ifde‡
__˝lu•lus


	@src/mosquitto_broker_internal.h

18 #i‚de‡
MOSQUITTO_BROKER_INTERNAL_H


19 
	#MOSQUITTO_BROKER_INTERNAL_H


	)

21 
	~"c⁄fig.h
"

22 
	~<°dio.h
>

24 #ifde‡
WITH_WEBSOCKETS


25 
	~<libwebsockës.h
>

27 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

28 
	#libwebsockë_ˇŒback_⁄_wrôabÀ
(
A
, 
B
Ë
	`lws_ˇŒback_⁄_wrôabÀ
((B))

	)

29 
	#libwebsockë_£rvi˚
(
A
, 
B
Ë
	`lws_£rvi˚
((A), (B))

	)

30 
	#libwebsockë_¸óã_c⁄ãxt
(
A
Ë
	`lws_¸óã_c⁄ãxt
((A))

	)

31 
	#libwebsockë_c⁄ãxt_de°roy
(
A
Ë
	`lws_c⁄ãxt_de°roy
((A))

	)

32 
	#libwebsockë_wrôe
(
A
, 
B
, 
C
, 
D
Ë
	`lws_wrôe
((A), (B), (C), (D))

	)

33 
	#libwebsockë_gë_sockë_fd
(
A
Ë
	`lws_gë_sockë_fd
((A))

	)

34 
	#libwebsockës_ªtu∫_hâp_°©us
(
A
, 
B
, 
C
, 
D
Ë
	`lws_ªtu∫_hâp_°©us
((B), (C), (D))

	)

35 
	#libwebsockës_gë_¥Ÿocﬁ
(
A
Ë
	`lws_gë_¥Ÿocﬁ
((A))

	)

36 
	#libwebsockë_c⁄ãxt
 
lws_c⁄ãxt


	)

37 
	#libwebsockë_¥Ÿocﬁs
 
lws_¥Ÿocﬁs


	)

38 
	#libwebsockë_ˇŒback_ªas⁄s
 
lws_ˇŒback_ªas⁄s


	)

39 
	#libwebsockë
 
lws


	)

41 
	#lws_pﬁlfd
 
pﬁlfd


	)

42 
	#lws_£rvi˚_fd
(
A
, 
B
Ë
	`libwebsockë_£rvi˚_fd
((A), (B))

	)

43 
	#lws_pﬁœrgs
 
libwebsockë_pﬁœrgs


	)

47 
	~"mosquôto_öã∫Æ.h
"

48 
	~"mosquôto_brokî.h
"

49 
	~"mosquôto_∂ugö.h
"

50 
	~"mosquôto.h
"

51 
	~"és_mosq.h
"

52 
	~"uthash.h
"

54 
	#uh∑_mÆloc
(
size
Ë
	`mosquôto__mÆloc
(size)

	)

55 
	#uh∑_‰ì
(
±r
Ë
	`mosquôto__‰ì
’å)

	)

56 
	~"uh∑.h
"

58 #i‚de‡
__GNUC__


59 
	#__©åibuã__
(
©åib
)

	)

63 
	#MQTT3_LOG_NONE
 0x00

	)

64 
	#MQTT3_LOG_SYSLOG
 0x01

	)

65 
	#MQTT3_LOG_FILE
 0x02

	)

66 
	#MQTT3_LOG_STDOUT
 0x04

	)

67 
	#MQTT3_LOG_STDERR
 0x08

	)

68 
	#MQTT3_LOG_TOPIC
 0x10

	)

69 
	#MQTT3_LOG_ALL
 0xFF

	)

71 
	#WEBSOCKET_CLIENT
 -2

	)

74 
	#TOPIC_HIERARCHY_LIMIT
 200

	)

121 
	#MOSQ_PAYLOAD_UNION_SIZE
 8

	)

123 *
	m±r
;

124 
	m¨øy
[
MOSQ_PAYLOAD_UNION_SIZE
];

125 } 
	tmosquôto__∑ylﬂd_uh∑
;

126 
	#UHPA_ALLOC_PAYLOAD
(
A
Ë
	`UHPA_ALLOC
((A)->
∑ylﬂd
, (A)->
∑ylﬂdÀn
)

	)

127 
	#UHPA_ACCESS_PAYLOAD
(
A
Ë
	`UHPA_ACCESS
((A)->
∑ylﬂd
, (A)->
∑ylﬂdÀn
)

	)

128 
	#UHPA_FREE_PAYLOAD
(
A
Ë
	`UHPA_FREE
((A)->
∑ylﬂd
, (A)->
∑ylﬂdÀn
)

	)

129 
	#UHPA_MOVE_PAYLOAD
(
DEST
, 
SRC
Ë
	`UHPA_MOVE
((DEST)->
∑ylﬂd
, (SRC)->∑ylﬂd, (SRC)->
∑ylﬂdÀn
)

	)

135 
uöt64_t
 
	tdbid_t
;

137 (*
	tFUNC_auth_∂ugö_öô_v4
)(**, 
	tmosquôto_›t
 *, );

138 (*
	tFUNC_auth_∂ugö_˛ónup_v4
)(*, 
	tmosquôto_›t
 *, );

139 (*
	tFUNC_auth_∂ugö_£curôy_öô_v4
)(*, 
	tmosquôto_›t
 *, , 
	tboﬁ
);

140 (*
	tFUNC_auth_∂ugö_£curôy_˛ónup_v4
)(*, 
	tmosquôto_›t
 *, , 
	tboﬁ
);

141 (*
	tFUNC_auth_∂ugö_a˛_check_v4
)(*, , 
	tmosquôto
 *, 
	tmosquôto_a˛_msg
 *);

142 (*
	tFUNC_auth_∂ugö_u≈wd_check_v4
)(*, 
	tmosquôto
 *, const *, const *);

143 (*
	tFUNC_auth_∂ugö_psk_key_gë_v4
)(*, 
	tmosquôto
 *, const *, const *, *, );

144 (*
	tFUNC_auth_∂ugö_auth_°¨t_v4
)(*, 
	tmosquôto
 *, c⁄° *, 
	tboﬁ
, c⁄° *, 
	tuöt16_t
, **, uint16_t *);

145 (*
	tFUNC_auth_∂ugö_auth_c⁄töue_v4
)(*, 
	tmosquôto
 *, c⁄° *, c⁄° *, 
	tuöt16_t
, **, uint16_t *);

147 (*
	tFUNC_auth_∂ugö_öô_v3
)(**, 
	tmosquôto_›t
 *, );

148 (*
	tFUNC_auth_∂ugö_˛ónup_v3
)(*, 
	tmosquôto_›t
 *, );

149 (*
	tFUNC_auth_∂ugö_£curôy_öô_v3
)(*, 
	tmosquôto_›t
 *, , 
	tboﬁ
);

150 (*
	tFUNC_auth_∂ugö_£curôy_˛ónup_v3
)(*, 
	tmosquôto_›t
 *, , 
	tboﬁ
);

151 (*
	tFUNC_auth_∂ugö_a˛_check_v3
)(*, , c⁄° 
	tmosquôto
 *, 
	tmosquôto_a˛_msg
 *);

152 (*
	tFUNC_auth_∂ugö_u≈wd_check_v3
)(*, c⁄° 
	tmosquôto
 *, const *, const *);

153 (*
	tFUNC_auth_∂ugö_psk_key_gë_v3
)(*, c⁄° 
	tmosquôto
 *, const *, const *, *, );

155 (*
	tFUNC_auth_∂ugö_öô_v2
)(**, 
	tmosquôto_auth_›t
 *, );

156 (*
	tFUNC_auth_∂ugö_˛ónup_v2
)(*, 
	tmosquôto_auth_›t
 *, );

157 (*
	tFUNC_auth_∂ugö_£curôy_öô_v2
)(*, 
	tmosquôto_auth_›t
 *, , 
	tboﬁ
);

158 (*
	tFUNC_auth_∂ugö_£curôy_˛ónup_v2
)(*, 
	tmosquôto_auth_›t
 *, , 
	tboﬁ
);

159 (*
	tFUNC_auth_∂ugö_a˛_check_v2
)(*, const *, const *, const *, );

160 (*
	tFUNC_auth_∂ugö_u≈wd_check_v2
)(*, const *, const *);

161 (*
	tFUNC_auth_∂ugö_psk_key_gë_v2
)(*, const *, const *, *, );

164 
	emosquôto_msg_‹igö
{

165 
mosq_mo_˛õ¡
 = 0,

166 
mosq_mo_brokî
 = 1

169 
	smosquôto__auth_∂ugö
{

170 *
lib
;

171 *
u£r_d©a
;

172 (*
∂ugö_vîsi⁄
)();

174 
FUNC_auth_∂ugö_öô_v4
 
∂ugö_öô_v4
;

175 
FUNC_auth_∂ugö_˛ónup_v4
 
∂ugö_˛ónup_v4
;

176 
FUNC_auth_∂ugö_£curôy_öô_v4
 
£curôy_öô_v4
;

177 
FUNC_auth_∂ugö_£curôy_˛ónup_v4
 
£curôy_˛ónup_v4
;

178 
FUNC_auth_∂ugö_a˛_check_v4
 
a˛_check_v4
;

179 
FUNC_auth_∂ugö_u≈wd_check_v4
 
u≈wd_check_v4
;

180 
FUNC_auth_∂ugö_psk_key_gë_v4
 
psk_key_gë_v4
;

181 
FUNC_auth_∂ugö_auth_°¨t_v4
 
auth_°¨t_v4
;

182 
FUNC_auth_∂ugö_auth_c⁄töue_v4
 
auth_c⁄töue_v4
;

184 
FUNC_auth_∂ugö_öô_v3
 
∂ugö_öô_v3
;

185 
FUNC_auth_∂ugö_˛ónup_v3
 
∂ugö_˛ónup_v3
;

186 
FUNC_auth_∂ugö_£curôy_öô_v3
 
£curôy_öô_v3
;

187 
FUNC_auth_∂ugö_£curôy_˛ónup_v3
 
£curôy_˛ónup_v3
;

188 
FUNC_auth_∂ugö_a˛_check_v3
 
a˛_check_v3
;

189 
FUNC_auth_∂ugö_u≈wd_check_v3
 
u≈wd_check_v3
;

190 
FUNC_auth_∂ugö_psk_key_gë_v3
 
psk_key_gë_v3
;

192 
FUNC_auth_∂ugö_öô_v2
 
∂ugö_öô_v2
;

193 
FUNC_auth_∂ugö_˛ónup_v2
 
∂ugö_˛ónup_v2
;

194 
FUNC_auth_∂ugö_£curôy_öô_v2
 
£curôy_öô_v2
;

195 
FUNC_auth_∂ugö_£curôy_˛ónup_v2
 
£curôy_˛ónup_v2
;

196 
FUNC_auth_∂ugö_a˛_check_v2
 
a˛_check_v2
;

197 
FUNC_auth_∂ugö_u≈wd_check_v2
 
u≈wd_check_v2
;

198 
FUNC_auth_∂ugö_psk_key_gë_v2
 
psk_key_gë_v2
;

199 
vîsi⁄
;

202 
	smosquôto__auth_∂ugö_c⁄fig


204 *
∑th
;

205 
mosquôto_›t
 *
›ti⁄s
;

206 
›ti⁄_cou¡
;

207 
boﬁ
 
díy_•ecül_ch¨s
;

209 
mosquôto__auth_∂ugö
 
∂ugö
;

212 
	smosquôto__£curôy_›ti⁄s
 {

217 
mosquôto__a˛_u£r
 *
a˛_li°
;

218 
mosquôto__a˛
 *
a˛_∑âîns
;

219 *
∑ssw‹d_fûe
;

220 *
psk_fûe
;

221 *
a˛_fûe
;

222 
mosquôto__auth_∂ugö_c⁄fig
 *
auth_∂ugö_c⁄figs
;

223 
auth_∂ugö_c⁄fig_cou¡
;

224 
öt8_t
 
Ælow_™⁄ymous
;

225 
boﬁ
 
Ælow_zîo_Àngth_˛õ¡id
;

226 *
auto_id_¥efix
;

227 
auto_id_¥efix_Àn
;

230 
	smosquôto__li°íî
 {

231 
fd
;

232 
uöt16_t
 
p‹t
;

233 *
ho°
;

234 *
böd_öãrÁ˚
;

235 
max_c⁄√˘i⁄s
;

236 *
mou¡_poöt
;

237 
mosq_sock_t
 *
socks
;

238 
sock_cou¡
;

239 
˛õ¡_cou¡
;

240 
mosquôto_¥Ÿocﬁ
 
¥Ÿocﬁ
;

241 
sockë_domaö
;

242 
boﬁ
 
u£_u£∫ame_as_˛õ¡id
;

243 
uöt8_t
 
maximum_qos
;

244 
uöt16_t
 
max_t›ic_Æüs
;

245 #ifde‡
WITH_TLS


246 *
ˇfûe
;

247 *
ˇ∑th
;

248 *
˚πfûe
;

249 *
keyfûe
;

250 *
és_ígöe
;

251 *
és_ígöe_k∑ss_sha1
;

252 *
cùhîs
;

253 *
psk_höt
;

254 
SSL_CTX
 *
s¶_˘x
;

255 *
¸lfûe
;

256 *
és_vîsi⁄
;

257 *
dh∑ømfûe
;

258 
boﬁ
 
u£_idítôy_as_u£∫ame
;

259 
boﬁ
 
u£_subje˘_as_u£∫ame
;

260 
boﬁ
 
ªquúe_˚πifiˇã
;

261 
mosquôto__keyf‹m
 
és_keyf‹m
;

263 #ifde‡
WITH_WEBSOCKETS


264 
libwebsockë_c⁄ãxt
 *
ws_c⁄ãxt
;

265 *
hâp_dú
;

266 
libwebsockë_¥Ÿocﬁs
 *
ws_¥Ÿocﬁ
;

268 
mosquôto__£curôy_›ti⁄s
 
£curôy_›ti⁄s
;

269 
mosquôto__u≈wd
 *
u≈wd
;

270 
mosquôto__u≈wd
 *
psk_id
;

273 
	smosquôto__c⁄fig
 {

274 
boﬁ
 
Ælow_du∂iˇã_mesßges
;

275 
autoßve_öãrvÆ
;

276 
boﬁ
 
autoßve_⁄_ch™ges
;

277 
boﬁ
 
check_ªèö_sour˚
;

278 *
˛õ¡id_¥efixes
;

279 
boﬁ
 
c⁄√˘i⁄_mesßges
;

280 
boﬁ
 
d´m⁄
;

281 
mosquôto__li°íî
 
deÁu…_li°íî
;

282 
mosquôto__li°íî
 *
li°íîs
;

283 
li°íî_cou¡
;

284 
log_de°
;

285 
log_Ácûôy
;

286 
log_ty≥
;

287 
boﬁ
 
log_time°amp
;

288 *
log_time°amp_f‹m©
;

289 *
log_fûe
;

290 
FILE
 *
log_Âå
;

291 
uöt16_t
 
max_öÊight_mesßges
;

292 
uöt16_t
 
max_kì∑live
;

293 
uöt32_t
 
max_∑ckë_size
;

294 
uöt32_t
 
mesßge_size_limô
;

295 
boﬁ
 
≥rsi°í˚
;

296 *
≥rsi°í˚_loˇti⁄
;

297 *
≥rsi°í˚_fûe
;

298 *
≥rsi°í˚_fûï©h
;

299 
time_t
 
≥rsi°ít_˛õ¡_expú©i⁄
;

300 *
pid_fûe
;

301 
boﬁ
 
queue_qos0_mesßges
;

302 
boﬁ
 
≥r_li°íî_£âögs
;

303 
boﬁ
 
ªèö_avaûabÀ
;

304 
boﬁ
 
£t_t˝_nodñay
;

305 
sys_öãrvÆ
;

306 
boﬁ
 
upgøde_outgoög_qos
;

307 *
u£r
;

308 #ifde‡
WITH_WEBSOCKETS


309 
websockës_log_Àvñ
;

310 
websockës_hódîs_size
;

311 
boﬁ
 
have_websockës_li°íî
;

313 #ifde‡
WITH_BRIDGE


314 
mosquôto__bridge
 *
bridges
;

315 
bridge_cou¡
;

317 
mosquôto__£curôy_›ti⁄s
 
£curôy_›ti⁄s
;

320 
	smosquôto__subÀaf
 {

321 
mosquôto__subÀaf
 *
¥ev
;

322 
mosquôto__subÀaf
 *
√xt
;

323 
mosquôto
 *
c⁄ãxt
;

324 
uöt32_t
 
idítifõr
;

325 
uöt8_t
 
qos
;

326 
boﬁ
 
no_loˇl
;

327 
boﬁ
 
ªèö_as_published
;

331 
	smosquôto__subsh¨ed_ªf
 {

332 
mosquôto__subhõr
 *
hõr
;

333 
mosquôto__subsh¨ed
 *
sh¨ed
;

337 
	smosquôto__subsh¨ed
 {

338 
UT_hash_h™dÀ
 
hh
;

339 *
«me
;

340 
mosquôto__subÀaf
 *
subs
;

343 
	smosquôto__subhõr
 {

344 
UT_hash_h™dÀ
 
hh
;

345 
mosquôto__subhõr
 *
∑ª¡
;

346 
mosquôto__subhõr
 *
chûdªn
;

347 
mosquôto__subÀaf
 *
subs
;

348 
mosquôto__subsh¨ed
 *
sh¨ed
;

349 
mosquôto_msg_°‹e
 *
ªèöed
;

350 *
t›ic
;

351 
uöt16_t
 
t›ic_Àn
;

354 
	smosquôto_msg_°‹e_lﬂd
{

355 
UT_hash_h™dÀ
 
hh
;

356 
dbid_t
 
db_id
;

357 
mosquôto_msg_°‹e
 *
°‹e
;

360 
	smosquôto_msg_°‹e
{

361 
mosquôto_msg_°‹e
 *
√xt
;

362 
mosquôto_msg_°‹e
 *
¥ev
;

363 
dbid_t
 
db_id
;

364 *
sour˚_id
;

365 *
sour˚_u£∫ame
;

366 
mosquôto__li°íî
 *
sour˚_li°íî
;

367 **
de°_ids
;

368 
de°_id_cou¡
;

369 
ªf_cou¡
;

370 * 
t›ic
;

371 
mosquôto_¥›îty
 *
¥›îtõs
;

372 
mosquôto__∑ylﬂd_uh∑
 
∑ylﬂd
;

373 
time_t
 
mesßge_expúy_time
;

374 
uöt32_t
 
∑ylﬂdÀn
;

375 
uöt16_t
 
sour˚_mid
;

376 
uöt16_t
 
mid
;

377 
uöt8_t
 
qos
;

378 
boﬁ
 
ªèö
;

379 
uöt8_t
 
‹igö
;

382 
	smosquôto_˛õ¡_msg
{

383 
mosquôto_˛õ¡_msg
 *
¥ev
;

384 
mosquôto_˛õ¡_msg
 *
√xt
;

385 
mosquôto_msg_°‹e
 *
°‹e
;

386 
mosquôto_¥›îty
 *
¥›îtõs
;

387 
time_t
 
time°amp
;

388 
uöt16_t
 
mid
;

389 
uöt8_t
 
qos
;

390 
boﬁ
 
ªèö
;

391 
mosquôto_msg_dúe˘i⁄
 
dúe˘i⁄
;

392 
mosquôto_msg_°©e
 
°©e
;

393 
boﬁ
 
dup
;

396 
	smosquôto__u≈wd
{

397 *
u£∫ame
;

398 *
∑ssw‹d
;

399 #ifde‡
WITH_TLS


400 
∑ssw‹d_Àn
;

401 
ß…_Àn
;

402 *
ß…
;

404 
UT_hash_h™dÀ
 
hh
;

407 
	smosquôto__a˛
{

408 
mosquôto__a˛
 *
√xt
;

409 *
t›ic
;

410 
ac˚ss
;

411 
ucou¡
;

412 
ccou¡
;

415 
	smosquôto__a˛_u£r
{

416 
mosquôto__a˛_u£r
 *
√xt
;

417 *
u£∫ame
;

418 
mosquôto__a˛
 *
a˛
;

421 
	smosquôto_db
{

422 
dbid_t
 
œ°_db_id
;

423 
mosquôto__subhõr
 *
subs
;

424 
mosquôto__u≈wd
 *
u≈wd
;

425 
mosquôto__u≈wd
 *
psk_id
;

426 
mosquôto
 *
c⁄ãxts_by_id
;

427 
mosquôto
 *
c⁄ãxts_by_sock
;

428 
mosquôto
 *
c⁄ãxts_f‹_‰ì
;

429 #ifde‡
WITH_BRIDGE


430 
mosquôto
 **
bridges
;

432 
˛õ¡id__ödex_hash
 *
˛õ¡id_ödex_hash
;

433 
mosquôto_msg_°‹e
 *
msg_°‹e
;

434 
mosquôto_msg_°‹e_lﬂd
 *
msg_°‹e_lﬂd
;

435 #ifde‡
WITH_BRIDGE


436 
bridge_cou¡
;

438 
msg_°‹e_cou¡
;

439 
msg_°‹e_byãs
;

440 *
c⁄fig_fûe
;

441 
mosquôto__c⁄fig
 *
c⁄fig
;

442 
auth_∂ugö_cou¡
;

443 
boﬁ
 
vîbo£
;

444 #ifde‡
WITH_SYS_TREE


445 
subs¸ùti⁄_cou¡
;

446 
sh¨ed_subs¸ùti⁄_cou¡
;

447 
ªèöed_cou¡
;

449 
≥rsi°í˚_ch™ges
;

450 
mosquôto
 *
Œ_f‹_‰ì
;

451 #ifde‡
WITH_EPOLL


452 
ïﬁlfd
;

456 
	emosquôto__bridge_dúe˘i⁄
{

457 
bd_out
 = 0,

458 
bd_ö
 = 1,

459 
bd_bŸh
 = 2

462 
	emosquôto_bridge_°¨t_ty≥
{

463 
b°_autom©ic
 = 0,

464 
b°_œzy
 = 1,

465 
b°_m™uÆ
 = 2,

466 
b°_⁄˚
 = 3

469 
	smosquôto__bridge_t›ic
{

470 *
t›ic
;

471 
qos
;

472 
mosquôto__bridge_dúe˘i⁄
 
dúe˘i⁄
;

473 *
loˇl_¥efix
;

474 *
ªmŸe_¥efix
;

475 *
loˇl_t›ic
;

476 *
ªmŸe_t›ic
;

479 
	sbridge_addªss
{

480 *
addªss
;

481 
p‹t
;

484 
	smosquôto__bridge
{

485 *
«me
;

486 
bridge_addªss
 *
addªs£s
;

487 
cur_addªss
;

488 
addªss_cou¡
;

489 
time_t
 
¥im¨y_ªåy
;

490 
mosq_sock_t
 
¥im¨y_ªåy_sock
;

491 
boﬁ
 
round_robö
;

492 
boﬁ
 
åy_¥iv©e
;

493 
boﬁ
 
åy_¥iv©e_ac˚±ed
;

494 
boﬁ
 
˛ón_°¨t
;

495 
kì∑live
;

496 
mosquôto__bridge_t›ic
 *
t›ics
;

497 
t›ic_cou¡
;

498 
boﬁ
 
t›ic_ªm≠pög
;

499 
mosquôto__¥Ÿocﬁ
 
¥Ÿocﬁ_vîsi⁄
;

500 
time_t
 
ª°¨t_t
;

501 *
ªmŸe_˛õ¡id
;

502 *
ªmŸe_u£∫ame
;

503 *
ªmŸe_∑ssw‹d
;

504 *
loˇl_˛õ¡id
;

505 *
loˇl_u£∫ame
;

506 *
loˇl_∑ssw‹d
;

507 *
nŸifiˇti⁄_t›ic
;

508 
boﬁ
 
nŸifiˇti⁄s
;

509 
boﬁ
 
nŸifiˇti⁄s_loˇl_⁄ly
;

510 
mosquôto_bridge_°¨t_ty≥
 
°¨t_ty≥
;

511 
idÀ_timeout
;

512 
ª°¨t_timeout
;

513 
backoff_ba£
;

514 
backoff_ˇp
;

515 
thªshﬁd
;

516 
boﬁ
 
œzy_ªc⁄√˘
;

517 
boﬁ
 
©ãm±_unsubs¸ibe
;

518 
boﬁ
 
öôül_nŸifiˇti⁄_d⁄e
;

519 #ifde‡
WITH_TLS


520 
boﬁ
 
és_ö£cuª
;

521 
boﬁ
 
és_oc•_ªquúed
;

522 *
és_ˇfûe
;

523 *
és_ˇ∑th
;

524 *
és_˚πfûe
;

525 *
és_keyfûe
;

526 *
és_vîsi⁄
;

527 *
és_Æ≤
;

528 #ifde‡
FINAL_WITH_TLS_PSK


529 *
és_psk_idítôy
;

530 *
és_psk
;

535 #ifde‡
WITH_WEBSOCKETS


536 
	slibws_mqâ_hack
 {

537 *
hâp_dú
;

540 
	slibws_mqâ_d©a
 {

541 
mosquôto
 *
mosq
;

545 
	~<√t_mosq.h
>

550 
	`mosquôto_maö_lo›
(
mosquôto_db
 *
db
, 
mosq_sock_t
 *
li°ísock
, 
li°ísock_cou¡
);

551 
mosquôto_db
 *
	`mosquôto__gë_db
();

557 
	`c⁄fig__öô
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
);

559 
	`c⁄fig__∑r£_¨gs
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
, 
¨gc
, *
¨gv
[]);

564 
	`c⁄fig__ªad
(
mosquôto_db
 *
db
, 
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
);

566 
	`c⁄fig__˛ónup
(
mosquôto__c⁄fig
 *
c⁄fig
);

567 
	`c⁄fig__gë_dú_fûes
(c⁄° *
ö˛ude_dú
, ***
fûes
, *
fûe_cou¡
);

569 
	`dr›_¥ivûeges
(
mosquôto__c⁄fig
 *
c⁄fig
, 
boﬁ
 
ãmp‹¨y
);

570 
	`ª°‹e_¥ivûeges
();

575 
	`£nd__c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ack
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

576 
	`£nd__suback
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
);

577 
	`£nd__unsuback
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
ªas⁄_code_cou¡
, 
uöt8_t
 *
ªas⁄_codes
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
);

578 
	`£nd__auth
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ªas⁄_code
, c⁄° *
auth_d©a
, 
uöt16_t
 
auth_d©a_Àn
);

583 
	`√t__brokî_öô
();

584 
	`√t__brokî_˛ónup
();

585 
	`√t__sockë_ac˚±
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
li°ísock
);

586 
	`√t__sockë_li°í
(
mosquôto__li°íî
 *
li°íî
);

587 
	`√t__sockë_gë_addªss
(
mosq_sock_t
 
sock
, *
buf
, 
Àn
);

588 
	`√t__és_lﬂd_vîify
(
mosquôto__li°íî
 *
li°íî
);

589 
	`√t__és_£rvî_˘x
(
mosquôto__li°íî
 *
li°íî
);

594 
	`h™dÀ__∑ckë
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

595 
	`h™dÀ__c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

596 
	`h™dÀ__c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

597 
	`h™dÀ__disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

598 
	`h™dÀ__publish
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

599 
	`h™dÀ__subs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

600 
	`h™dÀ__unsubs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

601 
	`h™dÀ__auth
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

606 
	`db__›í
(
mosquôto__c⁄fig
 *
c⁄fig
, 
mosquôto_db
 *
db
);

607 
	`db__˛o£
(
mosquôto_db
 *
db
);

608 #ifde‡
WITH_PERSISTENCE


609 
	`≥rsi°__backup
(
mosquôto_db
 *
db
, 
boﬁ
 
shutdown
);

610 
	`≥rsi°__ª°‹e
(
mosquôto_db
 *
db
);

612 
	`db__limôs_£t
(
öÊight_byãs
, 
queued
, 
queued_byãs
);

614 
	`db__mesßge_cou¡
(*
cou¡
);

615 
	`db__mesßge_dñëe_outgoög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
ex≥˘_°©e
, 
qos
);

616 
	`db__mesßge_ö£π
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
mosquôto_¥›îty
 *
¥›îtõs
);

617 
	`db__mesßge_ªÀa£_öcomög
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
);

618 
	`db__mesßge_upd©e_outgoög
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°©e
 
°©e
, 
qos
);

619 
	`db__mesßge_wrôe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

620 
	`db__mesßge_dequeue_fú°
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_msg_d©a
 *
msg_d©a
);

621 
	`db__mesßges_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

622 
	`db__mesßges_ósy_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
, uöt32_à
mesßge_expúy_öãrvÆ
, 
mosquôto_¥›îty
 **
¥›îtõs
);

623 
	`db__mesßge_°‹e
(
mosquôto_db
 *
db
, c⁄° 
mosquôto
 *
sour˚
, 
uöt16_t
 
sour˚_mid
, *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, 
mosquôto__∑ylﬂd_uh∑
 *
∑ylﬂd
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
, uöt32_à
mesßge_expúy_öãrvÆ
, 
mosquôto_¥›îty
 *
¥›îtõs
, 
dbid_t
 
°‹e_id
, 
mosquôto_msg_‹igö
 
‹igö
);

624 
	`db__mesßge_°‹e_föd
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°‹e
 **
°‹ed
);

625 
	`db__msg_°‹e_add
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
);

626 
	`db__msg_°‹e_ªmove
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
);

627 
	`db__msg_°‹e_ªf_öc
(
mosquôto_msg_°‹e
 *
°‹e
);

628 
	`db__msg_°‹e_ªf_dec
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 **
°‹e
);

629 
	`db__msg_°‹e_˛ón
(
mosquôto_db
 *
db
);

630 
	`db__msg_°‹e_com∑˘
(
mosquôto_db
 *
db
);

631 
	`db__mesßge_ªc⁄√˘_ª£t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

632 
	`sys_åì__öô
(
mosquôto_db
 *
db
);

633 
	`sys_åì__upd©e
(
mosquôto_db
 *
db
, 
öãrvÆ
, 
time_t
 
°¨t_time
);

638 
	`sub__add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 **
roŸ
);

639 
mosquôto__subhõr
 *
	`sub__add_hõr_íåy
(mosquôto__subhõ∏*
∑ª¡
, mosquôto__subhõ∏**
siblög
, c⁄° *
t›ic
, 
size_t
 
Àn
);

640 
	`sub__ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
mosquôto__subhõr
 *
roŸ
, 
uöt8_t
 *
ªas⁄
);

641 
	`sub__åì_¥öt
(
mosquôto__subhõr
 *
roŸ
, 
Àvñ
);

642 
	`sub__˛ón_£ssi⁄
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

643 
	`sub__ªèö_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
, 
uöt32_t
 
subs¸ùti⁄_idítifõr
);

644 
	`sub__mesßges_queue
(
mosquôto_db
 *
db
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
);

649 
mosquôto
 *
	`c⁄ãxt__öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
);

650 
	`c⁄ãxt__˛ónup
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
do_‰ì
);

651 
	`c⁄ãxt__disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

652 
	`c⁄ãxt__add_to_disu£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

653 
	`c⁄ãxt__‰ì_disu£d
(
mosquôto_db
 *
db
);

654 
	`c⁄ãxt__£nd_wûl
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

655 
	`c⁄ãxt__ªmove_‰om_by_id
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

657 
	`c⁄√˘__⁄_auth‹i£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, *
auth_d©a_out
, 
uöt16_t
 
auth_d©a_out_Àn
);

662 
	`log__öô
(
mosquôto__c⁄fig
 *
c⁄fig
);

663 
	`log__˛o£
(
mosquôto__c⁄fig
 *
c⁄fig
);

664 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
Àvñ
, c⁄° *
fmt
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4)));

665 
	$log__öã∫Æ
(c⁄° *
fmt
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

670 #ifde‡
WITH_BRIDGE


671 
	`bridge__√w
(
mosquôto_db
 *
db
, 
mosquôto__bridge
 *
bridge
);

672 
	`bridge__c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

673 
	`bridge__c⁄√˘_°ï1
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

674 
	`bridge__c⁄√˘_°ï2
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

675 
	`bridge__c⁄√˘_°ï3
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

676 
	`bridge__∑ckë_˛ónup
(
mosquôto
 *
c⁄ãxt
);

682 
	`¥›îty__¥o˚ss_c⁄√˘
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_¥›îty
 **
¥›s
);

683 
	`¥›îty__¥o˚ss_wûl
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_mesßge_Æl
 *
msg
, 
mosquôto_¥›îty
 **
¥›s
);

684 
	`¥›îty__¥o˚ss_disc⁄√˘
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_¥›îty
 **
¥›s
);

689 
	`a˛__föd_a˛s
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

690 
	`mosquôto_£curôy_moduÀ_öô
(
mosquôto_db
 *
db
);

691 
	`mosquôto_£curôy_moduÀ_˛ónup
(
mosquôto_db
 *
db
);

693 
	`mosquôto_£curôy_öô
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

694 
	`mosquôto_£curôy_≠∂y
(
mosquôto_db
 *
db
);

695 
	`mosquôto_£curôy_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

696 
	`mosquôto_a˛_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, * 
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
ac˚ss
);

697 
	`mosquôto_u≈wd_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

698 
	`mosquôto_psk_key_gë
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

700 
	`mosquôto_£curôy_öô_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

701 
	`mosquôto_£curôy_≠∂y_deÁu…
(
mosquôto_db
 *
db
);

702 
	`mosquôto_£curôy_˛ónup_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

703 
	`mosquôto_a˛_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
);

704 
	`mosquôto_u≈wd_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

705 
	`mosquôto_psk_key_gë_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

707 
	`mosquôto_£curôy_auth_°¨t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
ªauth
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_ö_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
);

708 
	`mosquôto_£curôy_auth_c⁄töue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
);

713 
	`£ssi⁄_expúy__add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

714 
	`£ssi⁄_expúy__ªmove
(
mosquôto
 *
c⁄ãxt
);

715 
	`£ssi⁄_expúy__ªmove_Æl
(
mosquôto_db
 *
db
);

716 
	`£ssi⁄_expúy__check
(
mosquôto_db
 *
db
, 
time_t
 
now
);

717 
	`£ssi⁄_expúy__£nd_Æl
(
mosquôto_db
 *
db
);

722 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

723 
	`£rvi˚_ö°Æl
();

724 
	`£rvi˚_unö°Æl
();

725 
	`£rvi˚_run
();

727 
DWORD
 
WINAPI
 
	`SigThªadProc
(* 
d©a
);

733 #ifde‡
WITH_WEBSOCKETS


734 #i‡
	`deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

735 
lws_c⁄ãxt
 *
	`mosq_websockës_öô
(
mosquôto__li°íî
 *
li°íî
, c⁄° 
mosquôto__c⁄fig
 *
c⁄f
);

737 
libwebsockë_c⁄ãxt
 *
	`mosq_websockës_öô
(
mosquôto__li°íî
 *
li°íî
, c⁄° 
mosquôto__c⁄fig
 *
c⁄f
);

740 
	`do_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ªas⁄
);

745 
	`wûl_dñay__add
(
mosquôto
 *
c⁄ãxt
);

746 
	`wûl_dñay__check
(
mosquôto_db
 *
db
, 
time_t
 
now
);

747 
	`wûl_dñay__£nd_Æl
(
mosquôto_db
 *
db
);

748 
	`wûl_dñay__ªmove
(
mosquôto
 *
mosq
);

	@src/mosquitto_passwd.c

17 
	~"c⁄fig.h
"

19 
	~<î∫o.h
>

20 
	~<›ís¶/›ís¶v.h
>

21 
	~<›ís¶/evp.h
>

22 
	~<›ís¶/ønd.h
>

23 
	~<›ís¶/buf„r.h
>

24 
	~<sig«l.h
>

25 
	~<°dio.h
>

26 
	~<°dlib.h
>

27 
	~<°rög.h
>

30 #ifde‡
WIN32


31 
	~<wödows.h
>

32 
	~<¥o˚ss.h
>

33 #i‚de‡
__˝lu•lus


34 #i‡
deföed
(
_MSC_VER
) && _MSC_VER < 1900

35 
	#boﬁ
 

	)

36 
	#åue
 1

	)

37 
	#Ál£
 0

	)

39 
	~<°dboﬁ.h
>

42 
	#¢¥ötf
 
•rötf_s


	)

43 
	~<io.h
>

44 
	~<wödows.h
>

46 
	~<°dboﬁ.h
>

47 
	~<uni°d.h
>

48 
	~<ãrmios.h
>

49 
	~<sys/°©.h
>

52 
	#MAX_BUFFER_LEN
 1024

	)

53 
	#SALT_LEN
 12

	)

55 #ifde‡
WIN32


56 
FILE
 *
	$mpw_tmpfûe
()

58  
	`tmpfûe
();

59 
	}
}

62 
	gÆph™um
[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

64 
	gtmpfûe_∑th
[36];

65 
FILE
 *
	$mpw_tmpfûe
()

67 
fd
;

68 
size_t
 
i
;

70 if(
	`RAND_byãs
(
tmpfûe_∑th
, (tmpfile_path)) != 1){

71  
NULL
;

74 
	`°r˝y
((*)
tmpfûe_∑th
, "/tmp/");

76 
i
=
	`°æí
((*)
tmpfûe_∑th
); i<(tmpfile_path)-8; i++){

77 
tmpfûe_∑th
[
i
] = 
Æph™um
[tmpfile_path[i]%((alphanum)-1)];

79 
tmpfûe_∑th
[(tmpfile_path)-8] = '-';

80 
i
=(
tmpfûe_∑th
)-7; i<(tmpfile_path)-1; i++){

81 
tmpfûe_∑th
[
i
] = 'X';

83 
tmpfûe_∑th
[(tmpfile_path)-1] = '\0';

85 
	`umask
(077);

86 
fd
 = 
	`mk°emp
((*)
tmpfûe_∑th
);

87 if(
fd
 < 0Ë 
NULL
;

88 
	`u∆ök
((*)
tmpfûe_∑th
);

90  
	`fd›í
(
fd
, "w+");

91 
	}
}

95 
	$ba£64_ícode
(*
ö
, 
ö_Àn
, **
ícoded
)

97 
BIO
 *
bmem
, *
b64
;

98 
BUF_MEM
 *
b±r
;

100 
b64
 = 
	`BIO_√w
(
	`BIO_f_ba£64
());

101 
	`BIO_£t_Êags
(
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

102 
bmem
 = 
	`BIO_√w
(
	`BIO_s_mem
());

103 
b64
 = 
	`BIO_push
(b64, 
bmem
);

104 
	`BIO_wrôe
(
b64
, 
ö
, 
ö_Àn
);

105 if(
	`BIO_Êush
(
b64
) != 1){

106 
	`BIO_‰ì_Æl
(
b64
);

109 
	`BIO_gë_mem_±r
(
b64
, &
b±r
);

110 *
ícoded
 = 
	`mÆloc
(
b±r
->
Àngth
+1);

111 if(!(*
ícoded
)){

112 
	`BIO_‰ì_Æl
(
b64
);

115 
	`mem˝y
(*
ícoded
, 
b±r
->
d©a
, b±r->
Àngth
);

116 (*
ícoded
)[
b±r
->
Àngth
] = '\0';

117 
	`BIO_‰ì_Æl
(
b64
);

120 
	}
}

123 
	$¥öt_ußge
()

125 
	`¥ötf
("mosquitto_passwd isáÅool for managingÖassword files for mosquitto.\n\n");

126 
	`¥ötf
("Usage: mosquitto_passwd [-c | -D]Öasswordfile username\n");

127 
	`¥ötf
(" mosquitto_passwd -bÖasswordfile usernameÖassword\n");

128 
	`¥ötf
(" mosquitto_passwd -UÖasswordfile\n");

129 
	`¥ötf
(" -b :Ñun in batch modeÅoállowÖassingÖasswords onÅhe commandÜine.\n");

130 
	`¥ötf
(" -c : createáÇewÖassword file. This will overwriteÉxisting files.\n");

131 
	`¥ötf
(" -D : deleteÅhe usernameÑatherÅhanádding/updating itsÖassword.\n");

132 
	`¥ötf
(" -U : updateáÖlainÅextÖassword fileÅo use hashedÖasswords.\n");

133 
	`¥ötf
("\nSee https://mosquitto.org/ for more information.\n\n");

134 
	}
}

136 
	$ouçut_√w_∑ssw‹d
(
FILE
 *
Âå
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

138 
rc
;

139 
ß…
[
SALT_LEN
];

140 *
ß…64
 = 
NULL
, *
hash64
 = NULL;

141 
hash
[
EVP_MAX_MD_SIZE
];

142 
hash_Àn
;

143 c⁄° 
EVP_MD
 *
dige°
;

144 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

145 
EVP_MD_CTX
 
c⁄ãxt
;

147 
EVP_MD_CTX
 *
c⁄ãxt
;

150 
rc
 = 
	`RAND_byãs
(
ß…
, 
SALT_LEN
);

151 if(!
rc
){

152 
	`Ârötf
(
°dîr
, "Error: InsufficientÉntropyávailableÅoÖerformÖassword generation.\n");

156 
rc
 = 
	`ba£64_ícode
(
ß…
, 
SALT_LEN
, &
ß…64
);

157 if(
rc
){

158 
	`‰ì
(
ß…64
);

159 
	`Ârötf
(
°dîr
, "Error: UnableÅoÉncode salt.\n");

164 
dige°
 = 
	`EVP_gë_dige°by«me
("sha512");

165 if(!
dige°
){

166 
	`‰ì
(
ß…64
);

167 
	`Ârötf
(
°dîr
, "Error: UnableÅo create openssl digest.\n");

171 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

172 
	`EVP_MD_CTX_öô
(&
c⁄ãxt
);

173 
	`EVP_Dige°Inô_ex
(&
c⁄ãxt
, 
dige°
, 
NULL
);

174 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

175 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
ß…
, 
SALT_LEN
);

176 
	`EVP_Dige°FöÆ_ex
(&
c⁄ãxt
, 
hash
, &
hash_Àn
);

177 
	`EVP_MD_CTX_˛ónup
(&
c⁄ãxt
);

179 
c⁄ãxt
 = 
	`EVP_MD_CTX_√w
();

180 
	`EVP_Dige°Inô_ex
(
c⁄ãxt
, 
dige°
, 
NULL
);

181 
	`EVP_Dige°Upd©e
(
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

182 
	`EVP_Dige°Upd©e
(
c⁄ãxt
, 
ß…
, 
SALT_LEN
);

183 
	`EVP_Dige°FöÆ_ex
(
c⁄ãxt
, 
hash
, &
hash_Àn
);

184 
	`EVP_MD_CTX_‰ì
(
c⁄ãxt
);

187 
rc
 = 
	`ba£64_ícode
(
hash
, 
hash_Àn
, &
hash64
);

188 if(
rc
){

189 
	`‰ì
(
ß…64
);

190 
	`‰ì
(
hash64
);

191 
	`Ârötf
(
°dîr
, "Error: UnableÅoÉncode hash.\n");

195 
	`Ârötf
(
Âå
, "%s:$6$%s$%s\n", 
u£∫ame
, 
ß…64
, 
hash64
);

196 
	`‰ì
(
ß…64
);

197 
	`‰ì
(
hash64
);

200 
	}
}

202 
	$dñëe_pwu£r
(
FILE
 *
Âå
, FILE *
·mp
, c⁄° *
u£∫ame
)

204 
buf
[
MAX_BUFFER_LEN
];

205 
lbuf
[
MAX_BUFFER_LEN
], *
tokí
;

206 
boﬁ
 
found
 = 
Ál£
;

207 
löe
 = 0;

209 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

210 
löe
++;

211 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

212 
tokí
 = 
	`°πok
(
lbuf
, ":");

213 if(!
tokí
){

214 
	`Ârötf
(
°dîr
, "Eº‹: C‹ru±Öassw‹d fûê©Üöê%d.\n", 
löe
);

218 if(
	`°rcmp
(
u£∫ame
, 
tokí
)){

219 
	`Ârötf
(
·mp
, "%s", 
buf
);

221 
found
 = 
åue
;

224 if(!
found
){

225 
	`Ârötf
(
°dîr
, "W¨nög: U£∏%†nŸ found i¿∑ssw‹d fûe.\n", 
u£∫ame
);

229 
	}
}

231 
	$upd©e_fûe
(
FILE
 *
Âå
, FILE *
·mp
)

233 
buf
[
MAX_BUFFER_LEN
];

234 
lbuf
[
MAX_BUFFER_LEN
];

235 *
u£∫ame
, *
∑ssw‹d
;

236 
rc
;

237 
Àn
;

239 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

240 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

241 
u£∫ame
 = 
	`°πok
(
lbuf
, ":");

242 
∑ssw‹d
 = 
	`°πok
(
NULL
, ":");

243 if(
∑ssw‹d
){

244 
Àn
 = 
	`°æí
(
∑ssw‹d
);

245 
Àn
 && (
∑ssw‹d
[len-1] == '\n' ||Öassword[len-1] == '\r')){

246 
∑ssw‹d
[
Àn
-1] = '\0';

247 
Àn
 = 
	`°æí
(
∑ssw‹d
);

249 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

250 if(
rc
) Ñc;

252 
	`Ârötf
(
·mp
, "%s", 
u£∫ame
);

256 
	}
}

258 
	$upd©e_pwu£r
(
FILE
 *
Âå
, FILE *
·mp
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

260 
buf
[
MAX_BUFFER_LEN
];

261 
lbuf
[
MAX_BUFFER_LEN
], *
tokí
;

262 
boﬁ
 
found
 = 
Ál£
;

263 
rc
 = 1;

264 
löe
 = 0;

266 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

267 
löe
++;

268 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

269 
tokí
 = 
	`°πok
(
lbuf
, ":");

270 if(!
tokí
){

271 
	`Ârötf
(
°dîr
, "Eº‹: C‹ru±Öassw‹d fûê©Üöê%d.\n", 
löe
);

275 if(
	`°rcmp
(
u£∫ame
, 
tokí
)){

276 
	`Ârötf
(
·mp
, "%s", 
buf
);

278 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

279 
found
 = 
åue
;

282 if(
found
){

283  
rc
;

285  
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

287 
	}
}

289 
	$gës_quõt
(*
s
, 
Àn
)

291 #ifde‡
WIN32


292 
HANDLE
 
h
;

293 
DWORD
 
c⁄_‹ig
, 
c⁄_quõt
 = 0;

294 
DWORD
 
ªad_Àn
 = 0;

296 
	`mem£t
(
s
, 0, 
Àn
);

297 
h
 = 
	`GëStdH™dÀ
(
STD_INPUT_HANDLE
);

298 
	`GëC⁄sﬁeMode
(
h
, &
c⁄_‹ig
);

299 
c⁄_quõt
 = 
c⁄_‹ig
;

300 
c⁄_quõt
 &~
ENABLE_ECHO_INPUT
;

301 
c⁄_quõt
 |
ENABLE_LINE_INPUT
;

302 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_quõt
);

303 if(!
	`RódC⁄sﬁe
(
h
, 
s
, 
Àn
, &
ªad_Àn
, 
NULL
)){

304 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_‹ig
);

307 
s
[
	`°æí
(s)-1] == 10 || s[strlen(s)-1] == 13){

308 
s
[
	`°æí
(s)-1] = 0;

310 if(
	`°æí
(
s
) == 0){

313 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_‹ig
);

317 
ãrmios
 
ts_quõt
, 
ts_‹ig
;

318 *
rs
;

320 
	`mem£t
(
s
, 0, 
Àn
);

321 
	`tcgë©å
(0, &
ts_‹ig
);

322 
ts_quõt
 = 
ts_‹ig
;

323 
ts_quõt
.
c_lÊag
 &~(
ECHO
 | 
ICANON
);

324 
	`tc£èâr
(0, 
TCSANOW
, &
ts_quõt
);

326 
rs
 = 
	`fgës
(
s
, 
Àn
, 
°dö
);

327 
	`tc£èâr
(0, 
TCSANOW
, &
ts_‹ig
);

329 if(!
rs
){

332 
s
[
	`°æí
(s)-1] == 10 || s[strlen(s)-1] == 13){

333 
s
[
	`°æí
(s)-1] = 0;

335 if(
	`°æí
(
s
) == 0){

341 
	}
}

343 
	$gë_∑ssw‹d
(*
∑ssw‹d
, 
size_t
 
Àn
)

345 
pw1
[
MAX_BUFFER_LEN
], 
pw2
[MAX_BUFFER_LEN];

346 
size_t
 
möLí
;

347 
möLí
 = 
Àn
 < 
MAX_BUFFER_LEN
 ?Üen : MAX_BUFFER_LEN;

349 
	`¥ötf
("Password: ");

350 
	`fÊush
(
°dout
);

351 if(
	`gës_quõt
(
pw1
, 
möLí
)){

352 
	`Ârötf
(
°dîr
, "Error: EmptyÖassword.\n");

355 
	`¥ötf
("\n");

357 
	`¥ötf
("ReenterÖassword: ");

358 
	`fÊush
(
°dout
);

359 if(
	`gës_quõt
(
pw2
, 
möLí
)){

360 
	`Ârötf
(
°dîr
, "Error: EmptyÖassword.\n");

363 
	`¥ötf
("\n");

365 if(
	`°rcmp
(
pw1
, 
pw2
)){

366 
	`Ârötf
(
°dîr
, "Error: Passwords doÇot match.\n");

370 
	`°∫˝y
(
∑ssw‹d
, 
pw1
, 
möLí
);

372 
	}
}

374 
	$c›y_c⁄ã¡s
(
FILE
 *
§c
, FILE *
de°
)

376 
buf
[
MAX_BUFFER_LEN
];

377 
size_t
 
Àn
;

379 
	`ªwöd
(
§c
);

380 
	`ªwöd
(
de°
);

382 #ifde‡
WIN32


383 
	`_chsize
(
	`fûío
(
de°
), 0);

385 if(
	`·runˇã
(
	`fûío
(
de°
), 0))  1;

388 !
	`„of
(
§c
)){

389 
Àn
 = 
	`‰ód
(
buf
, 1, 
MAX_BUFFER_LEN
, 
§c
);

390 if(
Àn
 > 0){

391 if(
	`fwrôe
(
buf
, 1, 
Àn
, 
de°
) !=Üen){

395  !
	`„of
(
§c
);

399 
	}
}

401 
	$¸óã_backup
(c⁄° *
backup_fûe
, 
FILE
 *
Âå
)

403 
FILE
 *
fbackup
;

405 
fbackup
 = 
	`f›í
(
backup_fûe
, "wt");

406 if(!
fbackup
){

407 
	`Ârötf
(
°dîr
, "Eº‹ cª©ög backu∞∑ssw‹d fûê\"%s\",ÇŸ c⁄töuög.\n", 
backup_fûe
);

410 if(
	`c›y_c⁄ã¡s
(
Âå
, 
fbackup
)){

411 
	`Ârötf
(
°dîr
, "Eº‹ c›yög d©®tÿbacku∞∑ssw‹d fûê\"%s\",ÇŸ c⁄töuög.\n", 
backup_fûe
);

412 
	`f˛o£
(
fbackup
);

415 
	`f˛o£
(
fbackup
);

416 
	`ªwöd
(
Âå
);

418 
	}
}

419 
	$h™dÀ_sigöt
(
sig«l
)

421 #i‚de‡
WIN32


422 
ãrmios
 
ts
;

424 
	`tcgë©å
(0, &
ts
);

425 
ts
.
c_lÊag
 |
ECHO
 | 
ICANON
;

426 
	`tc£èâr
(0, 
TCSANOW
, &
ts
);

429 
	`UNUSED
(
sig«l
);

431 
	`exô
(0);

432 
	}
}

434 
	$maö
(
¨gc
, *
¨gv
[])

436 *
∑ssw‹d_fûe_tmp
 = 
NULL
;

437 *
∑ssw‹d_fûe
 = 
NULL
;

438 *
u£∫ame
 = 
NULL
;

439 *
∑ssw‹d_cmd
 = 
NULL
;

440 
boﬁ
 
b©ch_mode
 = 
Ál£
;

441 
boﬁ
 
¸óã_√w
 = 
Ál£
;

442 
boﬁ
 
dñëe_u£r
 = 
Ál£
;

443 
FILE
 *
Âå
, *
·mp
;

444 
∑ssw‹d
[
MAX_BUFFER_LEN
];

445 
rc
;

446 
boﬁ
 
do_upd©e_fûe
 = 
Ál£
;

447 *
backup_fûe
;

449 
	`sig«l
(
SIGINT
, 
h™dÀ_sigöt
);

450 
	`sig«l
(
SIGTERM
, 
h™dÀ_sigöt
);

452 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L || 
OPENSSL_API_COMPAT
 < 0x10100000L

453 
	`O≥nSSL_add_Æl_dige°s
();

455 
	`OPENSSL_öô_¸y±o
(
OPENSSL_INIT_ADD_ALL_CIPHERS
 \

456 | 
OPENSSL_INIT_ADD_ALL_DIGESTS
 \

457 | 
OPENSSL_INIT_LOAD_CONFIG
, 
NULL
);

460 if(
¨gc
 == 1){

461 
	`¥öt_ußge
();

465 if(!
	`°rcmp
(
¨gv
[1], "-c")){

466 
¸óã_√w
 = 
åue
;

467 if(
¨gc
 != 4){

468 
	`Ârötf
(
°dîr
, "Error: -cárgument given butÖassword file or username missing.\n");

471 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

472 
u£∫ame
 = 
¨gv
[3];

474 }if(!
	`°rcmp
(
¨gv
[1], "-D")){

475 
dñëe_u£r
 = 
åue
;

476 if(
¨gc
 != 4){

477 
	`Ârötf
(
°dîr
, "Error: -Dárgument given butÖassword file or username missing.\n");

480 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

481 
u£∫ame
 = 
¨gv
[3];

483 }if(!
	`°rcmp
(
¨gv
[1], "-b")){

484 
b©ch_mode
 = 
åue
;

485 if(
¨gc
 != 5){

486 
	`Ârötf
(
°dîr
, "Error: -bárgument given butÖassword file, username orÖassword missing.\n");

489 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

490 
u£∫ame
 = 
¨gv
[3];

491 
∑ssw‹d_cmd
 = 
¨gv
[4];

493 }if(!
	`°rcmp
(
¨gv
[1], "-U")){

494 if(
¨gc
 != 3){

495 
	`Ârötf
(
°dîr
, "Error: -Uárgument given butÖassword file missing.\n");

498 
do_upd©e_fûe
 = 
åue
;

499 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

501 }if(
¨gc
 == 3){

502 
∑ssw‹d_fûe_tmp
 = 
¨gv
[1];

503 
u£∫ame
 = 
¨gv
[2];

505 
	`¥öt_ußge
();

509 #ifde‡
WIN32


510 
∑ssw‹d_fûe
 = 
	`_fuŒ∑th
(
NULL
, 
∑ssw‹d_fûe_tmp
, 0);

511 if(!
∑ssw‹d_fûe
){

512 
	`Ârötf
(
°dîr
, "Error getting fullÖath forÖassword file.\n");

516 
∑ssw‹d_fûe
 = 
	`ªÆ∑th
(
∑ssw‹d_fûe_tmp
, 
NULL
);

517 if(!
∑ssw‹d_fûe
){

518 if(
î∫o
 =
ENOENT
){

519 
∑ssw‹d_fûe
 = 
	`°rdup
(
∑ssw‹d_fûe_tmp
);

520 if(!
∑ssw‹d_fûe
){

521 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

525 
	`Ârötf
(
°dîr
, "Eº‹ÑódögÖassw‹d fûe: %s\n", 
	`°ªº‹
(
î∫o
));

531 if(
¸óã_√w
){

532 
rc
 = 
	`gë_∑ssw‹d
(
∑ssw‹d
, 
MAX_BUFFER_LEN
);

533 if(
rc
){

534 
	`‰ì
(
∑ssw‹d_fûe
);

535  
rc
;

537 
Âå
 = 
	`f›í
(
∑ssw‹d_fûe
, "wt");

538 if(!
Âå
){

539 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›í fûê%†f‹ wrôög. %s.\n", 
∑ssw‹d_fûe
, 
	`°ªº‹
(
î∫o
));

540 
	`‰ì
(
∑ssw‹d_fûe
);

543 
	`‰ì
(
∑ssw‹d_fûe
);

544 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
Âå
, 
u£∫ame
, 
∑ssw‹d
);

545 
	`f˛o£
(
Âå
);

546  
rc
;

548 
Âå
 = 
	`f›í
(
∑ssw‹d_fûe
, "r+t");

549 if(!
Âå
){

550 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›íÖassw‹d fûê%s. %s.\n", 
∑ssw‹d_fûe
, 
	`°ªº‹
(
î∫o
));

551 
	`‰ì
(
∑ssw‹d_fûe
);

555 
backup_fûe
 = 
	`mÆloc
(
	`°æí
(
∑ssw‹d_fûe
)+5);

556 if(!
backup_fûe
){

557 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

558 
	`‰ì
(
∑ssw‹d_fûe
);

561 
	`¢¥ötf
(
backup_fûe
, 
	`°æí
(
∑ssw‹d_fûe
)+5, "%s.tmp",Öassword_file);

562 
	`‰ì
(
∑ssw‹d_fûe
);

563 
∑ssw‹d_fûe
 = 
NULL
;

565 if(
	`¸óã_backup
(
backup_fûe
, 
Âå
)){

566 
	`f˛o£
(
Âå
);

567 
	`‰ì
(
backup_fûe
);

571 
·mp
 = 
	`mpw_tmpfûe
();

572 if(!
·mp
){

573 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›íÅemp‹¨y fûe. %s.\n", 
	`°ªº‹
(
î∫o
));

574 
	`f˛o£
(
Âå
);

575 
	`‰ì
(
backup_fûe
);

578 if(
dñëe_u£r
){

579 
rc
 = 
	`dñëe_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
);

580 }if(
do_upd©e_fûe
){

581 
rc
 = 
	`upd©e_fûe
(
Âå
, 
·mp
);

583 if(
b©ch_mode
){

585 
rc
 = 
	`upd©e_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
, 
∑ssw‹d_cmd
);

587 
rc
 = 
	`gë_∑ssw‹d
(
∑ssw‹d
, 
MAX_BUFFER_LEN
);

588 if(
rc
){

589 
	`f˛o£
(
Âå
);

590 
	`f˛o£
(
·mp
);

591 
	`u∆ök
(
backup_fûe
);

592 
	`‰ì
(
backup_fûe
);

593  
rc
;

596 
rc
 = 
	`upd©e_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
, 
∑ssw‹d
);

599 if(
rc
){

600 
	`f˛o£
(
Âå
);

601 
	`f˛o£
(
·mp
);

602 
	`u∆ök
(
backup_fûe
);

603 
	`‰ì
(
backup_fûe
);

604  
rc
;

607 if(
	`c›y_c⁄ã¡s
(
·mp
, 
Âå
)){

608 
	`f˛o£
(
Âå
);

609 
	`f˛o£
(
·mp
);

610 
	`Ârötf
(
°dîr
, "Error occurred updatingÖassword file.\n");

611 
	`Ârötf
(
°dîr
, "Passw‹d fûêmay bêc‹ru±, checkÅhêbacku∞fûe: %s.\n", 
backup_fûe
);

612 
	`‰ì
(
backup_fûe
);

615 
	`f˛o£
(
Âå
);

616 
	`f˛o£
(
·mp
);

620 
	`u∆ök
(
backup_fûe
);

621 
	`‰ì
(
backup_fûe
);

625 
	}
}

	@src/mosquitto_plugin.h

17 #i‚de‡
MOSQUITTO_PLUGIN_H


18 
	#MOSQUITTO_PLUGIN_H


	)

20 #ifde‡
__˝lu•lus


24 
	#MOSQ_AUTH_PLUGIN_VERSION
 4

	)

26 
	#MOSQ_ACL_NONE
 0x00

	)

27 
	#MOSQ_ACL_READ
 0x01

	)

28 
	#MOSQ_ACL_WRITE
 0x02

	)

29 
	#MOSQ_ACL_SUBSCRIBE
 0x04

	)

31 
	~<°dboﬁ.h
>

33 
mosquôto
;

35 
	smosquôto_›t
 {

36 *
key
;

37 *
vÆue
;

40 
	smosquôto_auth_›t
 {

41 *
key
;

42 *
vÆue
;

45 
	smosquôto_a˛_msg
 {

46 c⁄° *
t›ic
;

47 c⁄° *
∑ylﬂd
;

48 
∑ylﬂdÀn
;

49 
qos
;

50 
boﬁ
 
ªèö
;

110 
mosquôto_auth_∂ugö_vîsi⁄
();

132 
mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
›ts
, 
›t_cou¡
);

154 
mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
›ts
, 
›t_cou¡
);

182 
mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
›ts
, 
›t_cou¡
, 
boﬁ
 
ªlﬂd
);

210 
mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
›ts
, 
›t_cou¡
, 
boﬁ
 
ªlﬂd
);

237 
mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
);

254 
mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

282 
mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

309 
mosquôto_auth_°¨t
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, 
boﬁ
 
ªauth
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_ö_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
);

311 
mosquôto_auth_c⁄töue
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_ö_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
);

314 #ifde‡
__˝lu•lus


	@src/net.c

17 
	~"c⁄fig.h
"

19 #i‚de‡
WIN32


20 
	~<√tdb.h
>

21 
	~<uni°d.h
>

22 
	~<¨∑/öë.h
>

23 
	~<sys/sockë.h
>

24 
	~<√töë/t˝.h
>

25 
	~<√t/if.h
>

27 
	~<wösock2.h
>

28 
	~<ws2t˝ù.h
>

31 
	~<as£π.h
>

32 
	~<î∫o.h
>

33 
	~<f˙é.h
>

34 
	~<°dio.h
>

35 
	~<°rög.h
>

36 #ifde‡
WITH_WRAP


37 
	~<t˝d.h
>

40 #ifde‡
HAVE_NETINET_IN_H


41 
	~<√töë/ö.h
>

44 #ifde‡
__QNX__


45 
	~<√t/√tbyã.h
>

48 
	~"mosquôto_brokî_öã∫Æ.h
"

49 
	~"mqâ_¥Ÿocﬁ.h
"

50 
	~"mem‹y_mosq.h
"

51 
	~"√t_mosq.h
"

52 
	~"utû_mosq.h
"

54 #ifde‡
WITH_TLS


55 
	~"és_mosq.h
"

56 
	~<›ís¶/îr.h
>

57 
	gés_ex_ödex_c⁄ãxt
 = -1;

58 
	gés_ex_ödex_li°íî
 = -1;

61 
	~"sys_åì.h
"

64 
mosq_sock_t
 
	g•¨e_sock
 = 
INVALID_SOCKET
;

66 
	$√t__brokî_öô
()

68 
•¨e_sock
 = 
	`sockë
(
AF_INET
, 
SOCK_STREAM
, 0);

69 
	`√t__öô
();

70 
	}
}

73 
	$√t__brokî_˛ónup
()

75 if(
•¨e_sock
 !
INVALID_SOCKET
){

76 
	`COMPAT_CLOSE
(
•¨e_sock
);

77 
•¨e_sock
 = 
INVALID_SOCKET
;

79 
	`√t__˛ónup
();

80 
	}
}

83 
	$√t__¥öt_îr‹
(
log
, c⁄° *
f‹m©_°r
)

85 *
buf
;

87 #ifde‡
WIN32


88 
	`F‹m©Mesßge
(
FORMAT_MESSAGE_ALLOCATE_BUFFER
 | 
FORMAT_MESSAGE_FROM_SYSTEM
,

89 
NULL
, 
	`WSAGëLa°Eº‹
(), 
LANG_NEUTRAL
, &
buf
, 0, NULL);

91 
	`log__¥ötf
(
NULL
, 
log
, 
f‹m©_°r
, 
buf
);

92 
	`LoˇlFªe
(
buf
);

94 
buf
 = 
	`°ªº‹
(
î∫o
);

95 
	`log__¥ötf
(
NULL
, 
log
, 
f‹m©_°r
, 
buf
);

97 
	}
}

100 
	$√t__sockë_ac˚±
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
li°ísock
)

102 
i
;

103 
j
;

104 
mosq_sock_t
 
√w_sock
 = 
INVALID_SOCKET
;

105 
mosquôto
 *
√w_c⁄ãxt
;

106 #ifde‡
WITH_TLS


107 
BIO
 *
bio
;

108 
rc
;

109 
ebuf
[256];

110 
e
;

112 #ifde‡
WITH_WRAP


113 
ªque°_öfo
 
wøp_ªq
;

114 
addªss
[1024];

117 
√w_sock
 = 
	`ac˚±
(
li°ísock
, 
NULL
, 0);

118 if(
√w_sock
 =
INVALID_SOCKET
){

119 #ifde‡
WIN32


120 
î∫o
 = 
	`WSAGëLa°Eº‹
();

121 if(
î∫o
 =
WSAEMFILE
){

123 if(
î∫o
 =
EMFILE
 ||Éºnÿ=
ENFILE
){

132 
	`COMPAT_CLOSE
(
•¨e_sock
);

133 
√w_sock
 = 
	`ac˚±
(
li°ísock
, 
NULL
, 0);

134 if(
√w_sock
 !
INVALID_SOCKET
){

135 
	`COMPAT_CLOSE
(
√w_sock
);

137 
•¨e_sock
 = 
	`sockë
(
AF_INET
, 
SOCK_STREAM
, 0);

138 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
,

144 
	`G_SOCKET_CONNECTIONS_INC
();

146 if(
	`√t__sockë_n⁄block
(&
√w_sock
)){

147  
INVALID_SOCKET
;

150 #ifde‡
WITH_WRAP


152 
	`ªque°_öô
(&
wøp_ªq
, 
RQ_FILE
, 
√w_sock
, 
RQ_DAEMON
, "mosquitto", 0);

153 
	`‰omho°
(&
wøp_ªq
);

154 if(!
	`ho°s_ac˚ss
(&
wøp_ªq
)){

156 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

157 if(!
	`√t__sockë_gë_addªss
(
√w_sock
, 
addªss
, 1024)){

158 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ c⁄√˘i⁄ from %†díõdác˚s†byÅ˝d.", 
addªss
);

161 
	`COMPAT_CLOSE
(
√w_sock
);

166 if(
db
->
c⁄fig
->
£t_t˝_nodñay
){

167 
Êag
 = 1;

168 if(
	`£tsock›t
(
√w_sock
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
Êag
, ()) != 0){

169 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: UnableÅo set TCP_NODELAY.");

173 
√w_c⁄ãxt
 = 
	`c⁄ãxt__öô
(
db
, 
√w_sock
);

174 if(!
√w_c⁄ãxt
){

175 
	`COMPAT_CLOSE
(
√w_sock
);

178 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

179 
j
=0; j<
db
->
c⁄fig
->
li°íîs
[
i
].
sock_cou¡
; j++){

180 if(
db
->
c⁄fig
->
li°íîs
[
i
].
socks
[
j
] =
li°ísock
){

181 
√w_c⁄ãxt
->
li°íî
 = &
db
->
c⁄fig
->
li°íîs
[
i
];

182 
√w_c⁄ãxt
->
li°íî
->
˛õ¡_cou¡
++;

187 if(!
√w_c⁄ãxt
->
li°íî
){

188 
	`c⁄ãxt__˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

192 if(
√w_c⁄ãxt
->
li°íî
->
max_c⁄√˘i⁄s
 > 0 &&Çew_c⁄ãxt->li°íî->
˛õ¡_cou¡
 >Çew_context->listener->max_connections){

193 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

194 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ c⁄√˘i⁄ from %†díõd: max_c⁄√˘i⁄†ex˚eded.", 
√w_c⁄ãxt
->
addªss
);

196 
	`c⁄ãxt__˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

200 #ifde‡
WITH_TLS


202 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

203 
j
=0; j<
db
->
c⁄fig
->
li°íîs
[
i
].
sock_cou¡
; j++){

204 if(
db
->
c⁄fig
->
li°íîs
[
i
].
socks
[
j
] =
li°ísock
){

205 if(
db
->
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
){

206 
√w_c⁄ãxt
->
s¶
 = 
	`SSL_√w
(
db
->
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
);

207 if(!
√w_c⁄ãxt
->
s¶
){

208 
	`c⁄ãxt__˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

211 
	`SSL_£t_ex_d©a
(
√w_c⁄ãxt
->
s¶
, 
és_ex_ödex_c⁄ãxt
,Çew_context);

212 
	`SSL_£t_ex_d©a
(
√w_c⁄ãxt
->
s¶
, 
és_ex_ödex_li°íî
, &
db
->
c⁄fig
->
li°íîs
[
i
]);

213 
√w_c⁄ãxt
->
w™t_wrôe
 = 
åue
;

214 
bio
 = 
	`BIO_√w_sockë
(
√w_sock
, 
BIO_NOCLOSE
);

215 
	`SSL_£t_bio
(
√w_c⁄ãxt
->
s¶
, 
bio
, bio);

216 
	`ERR_˛ór_îr‹
();

217 
rc
 = 
	`SSL_ac˚±
(
√w_c⁄ãxt
->
s¶
);

218 if(
rc
 != 1){

219 
rc
 = 
	`SSL_gë_îr‹
(
√w_c⁄ãxt
->
s¶
,Ñc);

220 if(
rc
 =
SSL_ERROR_WANT_READ
){

222 }if(
rc
 =
SSL_ERROR_WANT_WRITE
){

223 
√w_c⁄ãxt
->
w™t_wrôe
 = 
åue
;

225 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

226 
e
 = 
	`ERR_gë_îr‹
();

227 
e
){

228 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

230 
√w_c⁄ãxt
->
addªss
, 
	`ERR_îr‹_°rög
(
e
, 
ebuf
));

231 
e
 = 
	`ERR_gë_îr‹
();

234 
	`c⁄ãxt__˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

244 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

245 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New c⁄√˘i⁄ from %†⁄Ö‹à%d.", 
√w_c⁄ãxt
->
addªss
,Çew_c⁄ãxt->
li°íî
->
p‹t
);

248  
√w_sock
;

249 
	}
}

251 #ifde‡
WITH_TLS


252 
	$˛õ¡_˚πifiˇã_vîify
(
¥evîify_ok
, 
X509_STORE_CTX
 *
˘x
)

254 
	`UNUSED
(
˘x
);

257  
¥evîify_ok
;

258 
	}
}

261 #ifde‡
FINAL_WITH_TLS_PSK


262 
	$psk_£rvî_ˇŒback
(
SSL
 *
s¶
, c⁄° *
idítôy
, *
psk
, 
max_psk_Àn
)

264 
mosquôto_db
 *
db
;

265 
mosquôto
 *
c⁄ãxt
;

266 
mosquôto__li°íî
 *
li°íî
;

267 *
psk_key
 = 
NULL
;

268 
Àn
;

269 c⁄° *
psk_höt
;

271 if(!
idítôy
)  0;

273 
db
 = 
	`mosquôto__gë_db
();

275 
c⁄ãxt
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_c⁄ãxt
);

276 if(!
c⁄ãxt
)  0;

278 
li°íî
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_li°íî
);

279 if(!
li°íî
)  0;

281 
psk_höt
 = 
li°íî
->psk_hint;

285 
psk_key
 = 
	`mosquôto__ˇŒoc
(1, 
max_psk_Àn
*2 + 1);

286 if(!
psk_key
)  0;

288 if(
	`mosquôto_psk_key_gë
(
db
, 
c⁄ãxt
, 
psk_höt
, 
idítôy
, 
psk_key
, 
max_psk_Àn
*2Ë!
MOSQ_ERR_SUCCESS
){

289 
	`mosquôto__‰ì
(
psk_key
);

293 
Àn
 = 
	`mosquôto__hex2bö
(
psk_key
, 
psk
, 
max_psk_Àn
);

294 i‡(
Àn
 < 0){

295 
	`mosquôto__‰ì
(
psk_key
);

299 if(
li°íî
->
u£_idítôy_as_u£∫ame
){

300 
c⁄ãxt
->
u£∫ame
 = 
	`mosquôto__°rdup
(
idítôy
);

301 if(!
c⁄ãxt
->
u£∫ame
){

302 
	`mosquôto__‰ì
(
psk_key
);

307 
	`mosquôto__‰ì
(
psk_key
);

308  
Àn
;

309 
	}
}

312 #ifde‡
WITH_TLS


313 
	$√t__és_£rvî_˘x
(
mosquôto__li°íî
 *
li°íî
)

315 
buf
[256];

316 
rc
;

317 
FILE
 *
dh∑ømfûe
;

318 
DH
 *
dh∑øm
 = 
NULL
;

320 if(
li°íî
->
s¶_˘x
){

321 
	`SSL_CTX_‰ì
(
li°íî
->
s¶_˘x
);

324 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

325 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`SSLv23_£rvî_mëhod
());

327 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`TLS_£rvî_mëhod
());

330 if(!
li°íî
->
s¶_˘x
){

331 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo create TLS context.");

335 if(
li°íî
->
és_vîsi⁄
 =
NULL
){

336 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
);

337 #ifde‡
SSL_OP_NO_TLSv1_3


338 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.3")){

339 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
 | 
SSL_OP_NO_TLSv1_2
);

340 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.2")){

341 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
 | 
SSL_OP_NO_TLSv1_3
);

342 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.1")){

343 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_2
 | 
SSL_OP_NO_TLSv1_3
);

345 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.2")){

346 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_1
);

347 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.1")){

348 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_SSLv3
 | 
SSL_OP_NO_TLSv1
 | 
SSL_OP_NO_TLSv1_2
);

351 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Unsuµ‹ãdÅls_vîsi⁄ \"%s\".", 
li°íî
->
és_vîsi⁄
);

355 #ifde‡
SSL_OP_NO_COMPRESSION


357 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_COMPRESSION
);

359 #ifde‡
SSL_OP_CIPHER_SERVER_PREFERENCE


361 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

364 #ifde‡
SSL_MODE_RELEASE_BUFFERS


366 
	`SSL_CTX_£t_mode
(
li°íî
->
s¶_˘x
, 
SSL_MODE_RELEASE_BUFFERS
);

369 #ifde‡
WITH_EC


370 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x10002000L && OPENSSL_VERSION_NUMBER < 0x10100000L

371 
	`SSL_CTX_£t_ecdh_auto
(
li°íî
->
s¶_˘x
, 1);

375 #ifde‡
SSL_OP_NO_RENEGOTIATION


376 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
SSL_OP_NO_RENEGOTIATION
);

379 
	`¢¥ötf
(
buf
, 256, "mosquôto-%d", 
li°íî
->
p‹t
);

380 
	`SSL_CTX_£t_£ssi⁄_id_c⁄ãxt
(
li°íî
->
s¶_˘x
, (*)
buf
, 
	`°æí
(buf));

382 if(
li°íî
->
cùhîs
){

383 
rc
 = 
	`SSL_CTX_£t_cùhî_li°
(
li°íî
->
s¶_˘x
,Üi°íî->
cùhîs
);

384 if(
rc
 == 0){

385 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ£àTLS cùhîs. Check cùhîÜi° \"%s\".", 
li°íî
->
cùhîs
);

389 
rc
 = 
	`SSL_CTX_£t_cùhî_li°
(
li°íî
->
s¶_˘x
, "DEFAULT:!aNULL:!eNULL:!LOW:!EXPORT:!SSLv2:@STRENGTH");

390 if(
rc
 == 0){

391 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ£àTLS cùhîs. Check cùhîÜi° \"%s\".", 
li°íî
->
cùhîs
);

395 if(
li°íî
->
dh∑ømfûe
){

396 
dh∑ømfûe
 = 
	`f›í
(
li°íî
->dhparamfile, "r");

397 if(!
dh∑ømfûe
){

398 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹Üﬂdög dh∑ømfûê\"%s\".", 
li°íî
->
dh∑ømfûe
);

401 
dh∑øm
 = 
	`PEM_ªad_DH∑øms
(
dh∑ømfûe
, 
NULL
, NULL, NULL);

402 
	`f˛o£
(
dh∑ømfûe
);

404 if(
dh∑øm
 =
NULL
 || 
	`SSL_CTX_£t_tmp_dh
(
li°íî
->
s¶_˘x
, dhparam) != 1){

405 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹Üﬂdög dh∑ømfûê\"%s\".", 
li°íî
->
dh∑ømfûe
);

409  
MOSQ_ERR_SUCCESS
;

410 
	}
}

414 
	$√t__lﬂd_¸l_fûe
(
mosquôto__li°íî
 *
li°íî
)

416 #ifde‡
WITH_TLS


417 
X509_STORE
 *
°‹e
;

418 
X509_LOOKUP
 *
lookup
;

419 
rc
;

421 
°‹e
 = 
	`SSL_CTX_gë_˚π_°‹e
(
li°íî
->
s¶_˘x
);

422 if(!
°‹e
){

423 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo obtain TLS store.");

424 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

427 
lookup
 = 
	`X509_STORE_add_lookup
(
°‹e
, 
	`X509_LOOKUP_fûe
());

428 
rc
 = 
	`X509_lﬂd_¸l_fûe
(
lookup
, 
li°íî
->
¸lfûe
, 
X509_FILETYPE_PEM
);

429 if(
rc
 != 1){

430 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd cîtifiˇãÑevoˇti⁄ fûê\"%s\". Check cæfûe.", 
li°íî
->
¸lfûe
);

431 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

434 
	`X509_STORE_£t_Êags
(
°‹e
, 
X509_V_FLAG_CRL_CHECK
);

437  
MOSQ_ERR_SUCCESS
;

438 
	}
}

441 
	$√t__és_lﬂd_vîify
(
mosquôto__li°íî
 *
li°íî
)

443 #ifde‡
WITH_TLS


444 
ENGINE
 *
ígöe
 = 
NULL
;

445 
rc
;

447 
rc
 = 
	`SSL_CTX_lﬂd_vîify_loˇti⁄s
(
li°íî
->
s¶_˘x
,Üi°íî->
ˇfûe
,Üi°íî->
ˇ∑th
);

448 if(
rc
 == 0){

449 if(
li°íî
->
ˇfûe
 &&Üi°íî->
ˇ∑th
){

450 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check cafûê\"%s\"ánd c≠©h \"%s\".", 
li°íî
->
ˇfûe
,Üi°íî->
ˇ∑th
);

451 }if(
li°íî
->
ˇfûe
){

452 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check cafûê\"%s\".", 
li°íî
->
ˇfûe
);

454 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check c≠©h \"%s\".", 
li°íî
->
ˇ∑th
);

456 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

459 if(
li°íî
->
és_ígöe
){

460 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

461 
ígöe
 = 
	`ENGINE_by_id
(
li°íî
->
és_ígöe
);

462 if(!
ígöe
){

463 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹Üﬂdög %†ígöe\n", 
li°íî
->
és_ígöe
);

466 if(!
	`ENGINE_öô
(
ígöe
)){

467 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "FailedÉngine initialisation\n");

468 
	`ENGINE_‰ì
(
ígöe
);

471 
	`ENGINE_£t_deÁu…
(
ígöe
, 
ENGINE_METHOD_ALL
);

472 
	`ENGINE_‰ì
(
ígöe
);

476 if(
li°íî
->
ªquúe_˚πifiˇã
){

477 
	`SSL_CTX_£t_vîify
(
li°íî
->
s¶_˘x
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
, 
˛õ¡_˚πifiˇã_vîify
);

479 
	`SSL_CTX_£t_vîify
(
li°íî
->
s¶_˘x
, 
SSL_VERIFY_NONE
, 
˛õ¡_˚πifiˇã_vîify
);

481 
rc
 = 
	`SSL_CTX_u£_˚πifiˇã_chaö_fûe
(
li°íî
->
s¶_˘x
,Üi°íî->
˚πfûe
);

482 if(
rc
 != 1){

483 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd sîvî cîtifiˇã \"%s\". Check cîtfûe.", 
li°íî
->
˚πfûe
);

484 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

485 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

486 
	`ENGINE_FINISH
(
ígöe
);

490 if(
li°íî
->
és_ígöe
 &&Üi°íî->
és_keyf‹m
 =
mosq_k_ígöe
){

491 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

492 
UI_METHOD
 *
ui_mëhod
 = 
	`√t__gë_ui_mëhod
();

493 if(
li°íî
->
és_ígöe_k∑ss_sha1
){

494 if(!
	`ENGINE_˘æ_cmd
(
ígöe
, 
ENGINE_SECRET_MODE
, 
ENGINE_SECRET_MODE_SHA
, 
NULL
, NULL, 0)){

495 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo setÉngine secret mode sha");

496 
	`ENGINE_FINISH
(
ígöe
);

499 if(!
	`ENGINE_˘æ_cmd
(
ígöe
, 
ENGINE_PIN
, 0, 
li°íî
->
és_ígöe_k∑ss_sha1
, 
NULL
, 0)){

500 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo setÉngineÖin");

501 
	`ENGINE_FINISH
(
ígöe
);

504 
ui_mëhod
 = 
NULL
;

506 
EVP_PKEY
 *
pkey
 = 
	`ENGINE_lﬂd_¥iv©e_key
(
ígöe
, 
li°íî
->
keyfûe
, 
ui_mëhod
, 
NULL
);

507 if(!
pkey
){

508 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂdÉngöê¥iv©êkey fûê\"%s\".", 
li°íî
->
keyfûe
);

509 
	`ENGINE_FINISH
(
ígöe
);

512 if(
	`SSL_CTX_u£_Priv©eKey
(
li°íî
->
s¶_˘x
, 
pkey
) <= 0){

513 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿu£Éngöê¥iv©êkey fûê\"%s\".", 
li°íî
->
keyfûe
);

514 
	`ENGINE_FINISH
(
ígöe
);

519 
rc
 = 
	`SSL_CTX_u£_Priv©eKey_fûe
(
li°íî
->
s¶_˘x
,Üi°íî->
keyfûe
, 
SSL_FILETYPE_PEM
);

520 if(
rc
 != 1){

521 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd sîvî key fûê\"%s\". Check keyfûe.", 
li°íî
->
keyfûe
);

522 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

523 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

524 
	`ENGINE_FINISH
(
ígöe
);

529 
rc
 = 
	`SSL_CTX_check_¥iv©e_key
(
li°íî
->
s¶_˘x
);

530 if(
rc
 != 1){

531 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Server certificate/keyáre inconsistent.");

532 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

533 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

534 
	`ENGINE_FINISH
(
ígöe
);

539 if(
li°íî
->
¸lfûe
){

540 
rc
 = 
	`√t__lﬂd_¸l_fûe
(
li°íî
);

541 if(
rc
){

542 #i‡!
	`deföed
(
OPENSSL_NO_ENGINE
)

543 
	`ENGINE_FINISH
(
ígöe
);

545  
rc
;

550  
MOSQ_ERR_SUCCESS
;

551 
	}
}

558 
	$√t__sockë_li°í
(
mosquôto__li°íî
 *
li°íî
)

560 
mosq_sock_t
 
sock
 = 
INVALID_SOCKET
;

561 
addröfo
 
höts
;

562 
addröfo
 *
aöfo
, *
Ω
;

563 
£rvi˚
[10];

564 
rc
;

565 #i‚de‡
WIN32


566 
ss_›t
 = 1;

568 
ss_›t
 = 1;

570 #ifde‡
SO_BINDTODEVICE


571 
i‰eq
 
i‰
;

574 if(!
li°íî
Ë 
MOSQ_ERR_INVAL
;

576 
	`¢¥ötf
(
£rvi˚
, 10, "%d", 
li°íî
->
p‹t
);

577 
	`mem£t
(&
höts
, 0, (
addröfo
));

578 if(
li°íî
->
sockë_domaö
){

579 
höts
.
ai_Ámûy
 = 
li°íî
->
sockë_domaö
;

581 
höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

583 
höts
.
ai_Êags
 = 
AI_PASSIVE
;

584 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

586 
rc
 = 
	`gëaddröfo
(
li°íî
->
ho°
, 
£rvi˚
, &
höts
, &
aöfo
);

587 i‡(
rc
){

588 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ögÜi°íî: %s.", 
	`gai_°ªº‹
(
rc
));

589  
INVALID_SOCKET
;

592 
li°íî
->
sock_cou¡
 = 0;

593 
li°íî
->
socks
 = 
NULL
;

595 
Ω
 = 
aöfo
;Ñp;Ñ∞Ω->
ai_√xt
){

596 if(
Ω
->
ai_Ámûy
 =
AF_INET
){

597 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög ipv4Üi°í sockë o¿p‹à%d.", 
	`¡ohs
(((
sockaddr_ö
 *)
Ω
->
ai_addr
)->
sö_p‹t
));

598 }if(
Ω
->
ai_Ámûy
 =
AF_INET6
){

599 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög ipv6Üi°í sockë o¿p‹à%d.", 
	`¡ohs
(((
sockaddr_ö6
 *)
Ω
->
ai_addr
)->
sö6_p‹t
));

604 
sock
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

605 if(
sock
 =
INVALID_SOCKET
){

606 
	`√t__¥öt_îr‹
(
MOSQ_LOG_WARNING
, "Warning: %s");

609 
li°íî
->
sock_cou¡
++;

610 
li°íî
->
socks
 = 
	`mosquôto__ªÆloc
÷i°íî->socks, (
mosq_sock_t
)*li°íî->
sock_cou¡
);

611 if(!
li°íî
->
socks
){

612 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

613  
MOSQ_ERR_NOMEM
;

615 
li°íî
->
socks
[li°íî->
sock_cou¡
-1] = 
sock
;

617 #i‚de‡
WIN32


618 
ss_›t
 = 1;

619 
	`£tsock›t
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
ss_›t
, (ss_opt));

621 #ifde‡
IPV6_V6ONLY


622 
ss_›t
 = 1;

623 
	`£tsock›t
(
sock
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, &
ss_›t
, (ss_opt));

626 if(
	`√t__sockë_n⁄block
(&
sock
)){

630 #ifde‡
SO_BINDTODEVICE


631 if(
li°íî
->
böd_öãrÁ˚
){

632 
	`mem£t
(&
i‰
, 0, (ifr));

633 
	`°∫˝y
(
i‰
.
i‰_«me
, 
li°íî
->
böd_öãrÁ˚
, (ifr.ifr_name)-1);

634 
i‰
.
i‰_«me
[(ifr.ifr_name)-1] = '\0';

635 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "BödögÜi°íîÅÿöãrÁ˚ \"%s\".", 
i‰
.
i‰_«me
);

636 if(
	`£tsock›t
(
sock
, 
SOL_SOCKET
, 
SO_BINDTODEVICE
, (*)&
i‰
, (ifr)) < 0) {

637 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

638 
	`COMPAT_CLOSE
(
sock
);

644 if(
	`böd
(
sock
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
) == -1){

645 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

646 
	`COMPAT_CLOSE
(
sock
);

650 if(
	`li°í
(
sock
, 100) == -1){

651 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

652 
	`COMPAT_CLOSE
(
sock
);

656 
	`‰ìaddröfo
(
aöfo
);

659 if(
li°íî
->
sock_cou¡
 > 0){

660 #ifde‡
WITH_TLS


661 if((
li°íî
->
ˇfûe
 ||Üi°íî->
ˇ∑th
Ë&&Üi°íî->
˚πfûe
 &&Üi°íî->
keyfûe
){

662 if(
	`√t__és_£rvî_˘x
(
li°íî
)){

663 
	`COMPAT_CLOSE
(
sock
);

667 if(
	`√t__és_lﬂd_vîify
(
li°íî
)){

668 
	`COMPAT_CLOSE
(
sock
);

671 #ifde‡
FINAL_WITH_TLS_PSK


672 }if(
li°íî
->
psk_höt
){

673 if(
és_ex_ödex_c⁄ãxt
 == -1){

674 
és_ex_ödex_c⁄ãxt
 = 
	`SSL_gë_ex_√w_ödex
(0, "˛õ¡ c⁄ãxt", 
NULL
, NULL, NULL);

676 if(
és_ex_ödex_li°íî
 == -1){

677 
és_ex_ödex_li°íî
 = 
	`SSL_gë_ex_√w_ödex
(0, "li°íî", 
NULL
, NULL, NULL);

680 if(
	`√t__és_£rvî_˘x
(
li°íî
)){

681 
	`COMPAT_CLOSE
(
sock
);

684 
	`SSL_CTX_£t_psk_£rvî_ˇŒback
(
li°íî
->
s¶_˘x
, 
psk_£rvî_ˇŒback
);

685 if(
li°íî
->
psk_höt
){

686 
rc
 = 
	`SSL_CTX_u£_psk_idítôy_höt
(
li°íî
->
s¶_˘x
,Üi°íî->
psk_höt
);

687 if(
rc
 == 0){

688 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo set TLS PSK hint.");

689 
	`√t__¥öt_îr‹
(
MOSQ_LOG_ERR
, "Error: %s");

690 
	`COMPAT_CLOSE
(
sock
);

701 
	}
}

703 
	$√t__sockë_gë_addªss
(
mosq_sock_t
 
sock
, *
buf
, 
Àn
)

705 
sockaddr_°‹age
 
addr
;

706 
sockÀn_t
 
addæí
;

708 
	`mem£t
(&
addr
, 0, (
sockaddr_°‹age
));

709 
addæí
 = (
addr
);

710 if(!
	`gë≥î«me
(
sock
, (
sockaddr
 *)&
addr
, &
addæí
)){

711 if(
addr
.
ss_Ámûy
 =
AF_INET
){

712 if(
	`öë_¡›
(
AF_INET
, &((
sockaddr_ö
 *)&
addr
)->
sö_addr
.
s_addr
, 
buf
, 
Àn
)){

715 }if(
addr
.
ss_Ámûy
 =
AF_INET6
){

716 if(
	`öë_¡›
(
AF_INET6
, &((
sockaddr_ö6
 *)&
addr
)->
sö6_addr
.
s6_addr
, 
buf
, 
Àn
)){

722 
	}
}

	@src/persist.h

17 #i‚de‡
PERSIST_H


18 
	#PERSIST_H


	)

20 
	#MOSQ_DB_VERSION
 5

	)

23 c⁄° 
magic
[15];

24 
	#DB_CHUNK_CFG
 1

	)

25 
	#DB_CHUNK_MSG_STORE
 2

	)

26 
	#DB_CHUNK_CLIENT_MSG
 3

	)

27 
	#DB_CHUNK_RETAIN
 4

	)

28 
	#DB_CHUNK_SUB
 5

	)

29 
	#DB_CHUNK_CLIENT
 6

	)

32 
	#ªad_e
(
f
, 
b
, 
c
Ëif(
	`‰ód
(b, 1, c, fË!c){ 
îr‹
; }

	)

33 
	#wrôe_e
(
f
, 
b
, 
c
Ëif(
	`fwrôe
(b, 1, c, fË!c){ 
îr‹
; }

	)

48 
	sPF_hódî
{

49 
uöt32_t
 
	mchunk
;

50 
uöt32_t
 
	mÀngth
;

54 
	sPF_cfg
{

55 
uöt64_t
 
	mœ°_db_id
;

56 
uöt8_t
 
	mshutdown
;

57 
uöt8_t
 
	mdbid_size
;

60 
	sPF_˛õ¡
{

61 
öt64_t
 
	m£ssi⁄_expúy_time
;

62 
uöt32_t
 
	m£ssi⁄_expúy_öãrvÆ
;

63 
uöt16_t
 
	mœ°_mid
;

64 
uöt16_t
 
	mid_Àn
;

66 
	sP_˛õ¡
{

67 
PF_˛õ¡
 
	mF
;

68 *
	m˛õ¡_id
;

72 
	sPF_˛õ¡_msg
{

73 
dbid_t
 
	m°‹e_id
;

74 
uöt16_t
 
	mmid
;

75 
uöt16_t
 
	mid_Àn
;

76 
uöt8_t
 
	mqos
;

77 
uöt8_t
 
	m°©e
;

78 
uöt8_t
 
	mªèö_dup
;

79 
uöt8_t
 
	mdúe˘i⁄
;

81 
	sP_˛õ¡_msg
{

82 
PF_˛õ¡_msg
 
	mF
;

83 *
	m˛õ¡_id
;

84 
mosquôto_¥›îty
 *
	m¥›îtõs
;

88 
	sPF_msg_°‹e
{

89 
dbid_t
 
	m°‹e_id
;

90 
öt64_t
 
	mexpúy_time
;

91 
uöt32_t
 
	m∑ylﬂdÀn
;

92 
uöt16_t
 
	msour˚_mid
;

93 
uöt16_t
 
	msour˚_id_Àn
;

94 
uöt16_t
 
	msour˚_u£∫ame_Àn
;

95 
uöt16_t
 
	mt›ic_Àn
;

96 
uöt16_t
 
	msour˚_p‹t
;

97 
uöt8_t
 
	mqos
;

98 
uöt8_t
 
	mªèö
;

100 
	sP_msg_°‹e
{

101 
PF_msg_°‹e
 
	mF
;

102 
mosquôto__∑ylﬂd_uh∑
 
	m∑ylﬂd
;

103 
mosquôto
 
	msour˚
;

104 *
	mt›ic
;

105 
mosquôto_¥›îty
 *
	m¥›îtõs
;

109 
	sPF_sub
{

110 
uöt32_t
 
	midítifõr
;

111 
uöt16_t
 
	mid_Àn
;

112 
uöt16_t
 
	mt›ic_Àn
;

113 
uöt8_t
 
	mqos
;

114 
uöt8_t
 
	m›ti⁄s
;

116 
	sP_sub
{

117 
PF_sub
 
	mF
;

118 *
	m˛õ¡_id
;

119 *
	mt›ic
;

123 
	sPF_ªèö
{

124 
dbid_t
 
	m°‹e_id
;

126 
	sP_ªèö
{

127 
PF_ªèö
 
	mF
;

131 
≥rsi°__ªad_°rög_Àn
(
FILE
 *
db_Âå
, **
°r
, 
uöt16_t
 
Àn
);

132 
≥rsi°__ªad_°rög
(
FILE
 *
db_Âå
, **
°r
);

134 
≥rsi°__chunk_hódî_ªad_v234
(
FILE
 *
db_Âå
, *
chunk
, *
Àngth
);

135 
≥rsi°__chunk_cfg_ªad_v234
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
);

136 
≥rsi°__chunk_˛õ¡_ªad_v234
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
, 
db_vîsi⁄
);

137 
≥rsi°__chunk_˛õ¡_msg_ªad_v234
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
);

138 
≥rsi°__chunk_msg_°‹e_ªad_v234
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
, 
db_vîsi⁄
);

139 
≥rsi°__chunk_ªèö_ªad_v234
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
);

140 
≥rsi°__chunk_sub_ªad_v234
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
);

142 
≥rsi°__chunk_hódî_ªad_v5
(
FILE
 *
db_Âå
, *
chunk
, *
Àngth
);

143 
≥rsi°__chunk_cfg_ªad_v5
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
);

144 
≥rsi°__chunk_˛õ¡_ªad_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
);

145 
≥rsi°__chunk_˛õ¡_msg_ªad_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
, 
uöt32_t
 
Àngth
);

146 
≥rsi°__chunk_msg_°‹e_ªad_v5
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
, 
uöt32_t
 
Àngth
);

147 
≥rsi°__chunk_ªèö_ªad_v5
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
);

148 
≥rsi°__chunk_sub_ªad_v5
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
);

150 
≥rsi°__chunk_cfg_wrôe_v5
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
);

151 
≥rsi°__chunk_˛õ¡_wrôe_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
);

152 
≥rsi°__chunk_˛õ¡_msg_wrôe_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
);

153 
≥rsi°__chunk_mesßge_°‹e_wrôe_v5
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
);

154 
≥rsi°__chunk_ªèö_wrôe_v5
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
);

155 
≥rsi°__chunk_sub_wrôe_v5
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
);

	@src/persist_read.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

31 
	~<uéi°.h
>

33 
	~"mosquôto_brokî_öã∫Æ.h
"

34 
	~"mem‹y_mosq.h
"

35 
	~"≥rsi°.h
"

36 
	~"time_mosq.h
"

37 
	~"utû_mosq.h
"

39 
uöt32_t
 
	gdb_vîsi⁄
;

41 c⁄° 
	gmagic
[15] = {0x00, 0xB5, 0x00, 'm','o','s','q','u','i','t','t','o',' ','d','b'};

43 
≥rsi°__ª°‹e_sub
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, c⁄° *
sub
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
);

45 
mosquôto
 *
	$≥rsi°__föd_‹_add_c⁄ãxt
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, 
uöt16_t
 
œ°_mid
)

47 
mosquôto
 *
c⁄ãxt
;

49 if(!
˛õ¡_id
Ë 
NULL
;

51 
c⁄ãxt
 = 
NULL
;

52 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
˛õ¡_id
, 
	`°æí
(˛õ¡_id), 
c⁄ãxt
);

53 if(!
c⁄ãxt
){

54 
c⁄ãxt
 = 
	`c⁄ãxt__öô
(
db
, -1);

55 if(!
c⁄ãxt
Ë 
NULL
;

56 
c⁄ãxt
->
id
 = 
	`mosquôto__°rdup
(
˛õ¡_id
);

57 if(!
c⁄ãxt
->
id
){

58 
	`mosquôto__‰ì
(
c⁄ãxt
);

59  
NULL
;

62 
c⁄ãxt
->
˛ón_°¨t
 = 
Ál£
;

64 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
->
id
, 
	`°æí
(context->id), context);

66 if(
œ°_mid
){

67 
c⁄ãxt
->
œ°_mid
 =Üast_mid;

69  
c⁄ãxt
;

70 
	}
}

73 
	$≥rsi°__ªad_°rög_Àn
(
FILE
 *
db_Âå
, **
°r
, 
uöt16_t
 
Àn
)

75 *
s
 = 
NULL
;

77 if(
Àn
){

78 
s
 = 
	`mosquôto__mÆloc
(
Àn
+1);

79 if(!
s
){

80 
	`f˛o£
(
db_Âå
);

81 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

82  
MOSQ_ERR_NOMEM
;

84 if(
	`‰ód
(
s
, 1, 
Àn
, 
db_Âå
) !=Üen){

85 
	`mosquôto__‰ì
(
s
);

86  
MOSQ_ERR_NOMEM
;

88 
s
[
Àn
] = '\0';

91 *
°r
 = 
s
;

92  
MOSQ_ERR_SUCCESS
;

93 
	}
}

96 
	$≥rsi°__ªad_°rög
(
FILE
 *
db_Âå
, **
°r
)

98 
uöt16_t
 
i16ãmp
;

99 
uöt16_t
 
¶í
;

101 if(
	`‰ód
(&
i16ãmp
, 1, (
uöt16_t
), 
db_Âå
) != (uint16_t)){

102  
MOSQ_ERR_INVAL
;

105 
¶í
 = 
	`¡ohs
(
i16ãmp
);

106  
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, 
°r
, 
¶í
);

107 
	}
}

110 
	$≥rsi°__˛õ¡_msg_ª°‹e
(
mosquôto_db
 *
db
, 
P_˛õ¡_msg
 *
chunk
)

112 
mosquôto_˛õ¡_msg
 *
cmsg
;

113 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

114 
mosquôto
 *
c⁄ãxt
;

115 
mosquôto_msg_d©a
 *
msg_d©a
;

117 
cmsg
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_˛õ¡_msg
));

118 if(!
cmsg
){

119 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

120  
MOSQ_ERR_NOMEM
;

123 
cmsg
->
√xt
 = 
NULL
;

124 
cmsg
->
°‹e
 = 
NULL
;

125 
cmsg
->
mid
 = 
chunk
->
F
.mid;

126 
cmsg
->
qos
 = 
chunk
->
F
.qos;

127 
cmsg
->
ªèö
 = (
chunk
->
F
.
ªèö_dup
&0xF0)>>4;

128 
cmsg
->
time°amp
 = 0;

129 
cmsg
->
dúe˘i⁄
 = 
chunk
->
F
.direction;

130 
cmsg
->
°©e
 = 
chunk
->
F
.state;

131 
cmsg
->
dup
 = 
chunk
->
F
.
ªèö_dup
&0x0F;

132 
cmsg
->
¥›îtõs
 = 
chunk
->properties;

134 
	`HASH_FIND
(
hh
, 
db
->
msg_°‹e_lﬂd
, &
chunk
->
F
.
°‹e_id
, (
dbid_t
), 
lﬂd
);

135 if(!
lﬂd
){

136 
	`mosquôto__‰ì
(
cmsg
);

137 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "ErrorÑestoringÖersistent database, message store corrupt.");

140 
cmsg
->
°‹e
 = 
lﬂd
->store;

141 
	`db__msg_°‹e_ªf_öc
(
cmsg
->
°‹e
);

143 
c⁄ãxt
 = 
	`≥rsi°__föd_‹_add_c⁄ãxt
(
db
, 
chunk
->
˛õ¡_id
, 0);

144 if(!
c⁄ãxt
){

145 
	`mosquôto__‰ì
(
cmsg
);

146 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "ErrorÑestoringÖersistent database, message store corrupt.");

150 if(
cmsg
->
dúe˘i⁄
 =
mosq_md_out
){

151 
msg_d©a
 = &
c⁄ãxt
->
msgs_out
;

153 
msg_d©a
 = &
c⁄ãxt
->
msgs_ö
;

156 if(
chunk
->
F
.
°©e
 =
mosq_ms_queued
 || (chunk->F.
qos
 > 0 && 
msg_d©a
->
öÊight_quŸa
 == 0)){

157 
	`DL_APPEND
(
msg_d©a
->
queued
, 
cmsg
);

159 
	`DL_APPEND
(
msg_d©a
->
öÊight
, 
cmsg
);

160 if(
chunk
->
F
.
qos
 > 0 && 
msg_d©a
->
öÊight_quŸa
 > 0){

161 
msg_d©a
->
öÊight_quŸa
--;

164 
msg_d©a
->
msg_cou¡
++;

165 
msg_d©a
->
msg_byãs
 +
cmsg
->
°‹e
->
∑ylﬂdÀn
;

166 if(
chunk
->
F
.
qos
 > 0){

167 
msg_d©a
->
msg_cou¡12
++;

168 
msg_d©a
->
msg_byãs12
 +
cmsg
->
°‹e
->
∑ylﬂdÀn
;

171  
MOSQ_ERR_SUCCESS
;

172 
	}
}

175 
	$≥rsi°__˛õ¡_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

177 
rc
 = 0;

178 
mosquôto
 *
c⁄ãxt
;

179 
P_˛õ¡
 
chunk
;

181 
	`mem£t
(&
chunk
, 0, (
P_˛õ¡
));

183 if(
db_vîsi⁄
 == 5){

184 
rc
 = 
	`≥rsi°__chunk_˛õ¡_ªad_v5
(
db_Âå
, &
chunk
);

186 
rc
 = 
	`≥rsi°__chunk_˛õ¡_ªad_v234
(
db_Âå
, &
chunk
, 
db_vîsi⁄
);

188 if(
rc
){

189 
	`f˛o£
(
db_Âå
);

190  
rc
;

193 
c⁄ãxt
 = 
	`≥rsi°__föd_‹_add_c⁄ãxt
(
db
, 
chunk
.
˛õ¡_id
, chunk.
F
.
œ°_mid
);

194 if(
c⁄ãxt
){

195 
c⁄ãxt
->
£ssi⁄_expúy_time
 = 
chunk
.
F
.session_expiry_time;

196 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 
chunk
.
F
.session_expiry_interval;

199 
rc
 = 1;

202 
	`mosquôto__‰ì
(
chunk
.
˛õ¡_id
);

204  
rc
;

205 
	}
}

208 
	$≥rsi°__˛õ¡_msg_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
uöt32_t
 
Àngth
)

210 
P_˛õ¡_msg
 
chunk
;

211 
rc
;

213 
	`mem£t
(&
chunk
, 0, (
P_˛õ¡_msg
));

215 if(
db_vîsi⁄
 == 5){

216 
rc
 = 
	`≥rsi°__chunk_˛õ¡_msg_ªad_v5
(
db_Âå
, &
chunk
, 
Àngth
);

218 
rc
 = 
	`≥rsi°__chunk_˛õ¡_msg_ªad_v234
(
db_Âå
, &
chunk
);

220 if(
rc
){

221 
	`f˛o£
(
db_Âå
);

222  
rc
;

225 
rc
 = 
	`≥rsi°__˛õ¡_msg_ª°‹e
(
db
, &
chunk
);

226 
	`mosquôto__‰ì
(
chunk
.
˛õ¡_id
);

228  
rc
;

229 
	}
}

232 
	$≥rsi°__msg_°‹e_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
uöt32_t
 
Àngth
)

234 
P_msg_°‹e
 
chunk
;

235 
mosquôto_msg_°‹e
 *
°‹ed
 = 
NULL
;

236 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

237 
öt64_t
 
mesßge_expúy_öãrvÆ64
;

238 
uöt32_t
 
mesßge_expúy_öãrvÆ
;

239 
rc
 = 0;

240 
i
;

242 
	`mem£t
(&
chunk
, 0, (
P_msg_°‹e
));

244 if(
db_vîsi⁄
 == 5){

245 
rc
 = 
	`≥rsi°__chunk_msg_°‹e_ªad_v5
(
db_Âå
, &
chunk
, 
Àngth
);

247 
rc
 = 
	`≥rsi°__chunk_msg_°‹e_ªad_v234
(
db_Âå
, &
chunk
, 
db_vîsi⁄
);

249 if(
rc
){

250 
	`f˛o£
(
db_Âå
);

251  
rc
;

254 if(
chunk
.
F
.
sour˚_p‹t
){

255 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

256 if(
db
->
c⁄fig
->
li°íîs
[
i
].
p‹t
 =
chunk
.
F
.
sour˚_p‹t
){

257 
chunk
.
sour˚
.
li°íî
 = &
db
->
c⁄fig
->
li°íîs
[
i
];

262 
lﬂd
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_msg_°‹e_lﬂd
));

263 if(!
lﬂd
){

264 
	`f˛o£
(
db_Âå
);

265 
	`mosquôto__‰ì
(
chunk
.
sour˚
.
id
);

266 
	`mosquôto__‰ì
(
chunk
.
sour˚
.
u£∫ame
);

267 
	`mosquôto__‰ì
(
chunk
.
t›ic
);

268 
	`UHPA_FREE
(
chunk
.
∑ylﬂd
, chunk.
F
.
∑ylﬂdÀn
);

269 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

270  
MOSQ_ERR_NOMEM
;

273 if(
chunk
.
F
.
expúy_time
 > 0){

274 
mesßge_expúy_öãrvÆ64
 = 
chunk
.
F
.
expúy_time
 - 
	`time
(
NULL
);

275 if(
mesßge_expúy_öãrvÆ64
 < 0 || mesßge_expúy_öãrvÆ64 > 
UINT32_MAX
){

276 
mesßge_expúy_öãrvÆ
 = 0;

278 
mesßge_expúy_öãrvÆ
 = (
uöt32_t
)
mesßge_expúy_öãrvÆ64
;

281 
mesßge_expúy_öãrvÆ
 = 0;

284 
rc
 = 
	`db__mesßge_°‹e
(
db
, &
chunk
.
sour˚
, chunk.
F
.
sour˚_mid
,

285 
chunk
.
t›ic
, chunk.
F
.
qos
, chunk.F.
∑ylﬂdÀn
,

286 &
chunk
.
∑ylﬂd
, chunk.
F
.
ªèö
, &
°‹ed
, 
mesßge_expúy_öãrvÆ
,

287 
chunk
.
¥›îtõs
, chunk.
F
.
°‹e_id
, 
mosq_mo_˛õ¡
);

289 
	`mosquôto__‰ì
(
chunk
.
sour˚
.
id
);

290 
	`mosquôto__‰ì
(
chunk
.
sour˚
.
u£∫ame
);

291 
chunk
.
sour˚
.
id
 = 
NULL
;

292 
chunk
.
sour˚
.
u£∫ame
 = 
NULL
;

294 if(
rc
 =
MOSQ_ERR_SUCCESS
){

295 
°‹ed
->
sour˚_li°íî
 = 
chunk
.
sour˚
.
li°íî
;

296 
lﬂd
->
db_id
 = 
°‹ed
->db_id;

297 
lﬂd
->
°‹e
 = 
°‹ed
;

299 
	`HASH_ADD
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
db_id
, (
dbid_t
), 
lﬂd
);

300  
MOSQ_ERR_SUCCESS
;

302 
	`mosquôto__‰ì
(
lﬂd
);

303 
	`f˛o£
(
db_Âå
);

304  
rc
;

306 
	}
}

308 
	$≥rsi°__ªèö_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

310 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

311 
P_ªèö
 
chunk
;

312 
rc
;

314 
	`mem£t
(&
chunk
, 0, (
P_ªèö
));

316 if(
db_vîsi⁄
 == 5){

317 
rc
 = 
	`≥rsi°__chunk_ªèö_ªad_v5
(
db_Âå
, &
chunk
);

319 
rc
 = 
	`≥rsi°__chunk_ªèö_ªad_v234
(
db_Âå
, &
chunk
);

321 if(
rc
){

322 
	`f˛o£
(
db_Âå
);

323  
rc
;

326 
	`HASH_FIND
(
hh
, 
db
->
msg_°‹e_lﬂd
, &
chunk
.
F
.
°‹e_id
, (
dbid_t
), 
lﬂd
);

327 if(
lﬂd
){

328 
	`sub__mesßges_queue
(
db
, 
NULL
, 
lﬂd
->
°‹e
->
t›ic
,Üﬂd->°‹e->
qos
,Üﬂd->°‹e->
ªèö
, &load->store);

330 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Corrupt database whilstÑestoringáÑetained message.");

331  
MOSQ_ERR_INVAL
;

333  
MOSQ_ERR_SUCCESS
;

334 
	}
}

336 
	$≥rsi°__sub_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

338 
P_sub
 
chunk
;

339 
rc
;

341 
	`mem£t
(&
chunk
, 0, (
P_sub
));

343 if(
db_vîsi⁄
 == 5){

344 
rc
 = 
	`≥rsi°__chunk_sub_ªad_v5
(
db_Âå
, &
chunk
);

346 
rc
 = 
	`≥rsi°__chunk_sub_ªad_v234
(
db_Âå
, &
chunk
);

348 if(
rc
){

349 
	`f˛o£
(
db_Âå
);

350  
rc
;

353 
rc
 = 
	`≥rsi°__ª°‹e_sub
(
db
, 
chunk
.
˛õ¡_id
, chunk.
t›ic
, chunk.
F
.
qos
, chunk.F.
idítifõr
, chunk.F.
›ti⁄s
);

355 
	`mosquôto__‰ì
(
chunk
.
˛õ¡_id
);

356 
	`mosquôto__‰ì
(
chunk
.
t›ic
);

358  
rc
;

359 
	}
}

362 
	$≥rsi°__chunk_hódî_ªad
(
FILE
 *
db_Âå
, *
chunk
, *
Àngth
)

364 if(
db_vîsi⁄
 == 5){

365  
	`≥rsi°__chunk_hódî_ªad_v5
(
db_Âå
, 
chunk
, 
Àngth
);

367  
	`≥rsi°__chunk_hódî_ªad_v234
(
db_Âå
, 
chunk
, 
Àngth
);

369 
	}
}

372 
	$≥rsi°__ª°‹e
(
mosquôto_db
 *
db
)

374 
FILE
 *
Âå
;

375 
hódî
[15];

376 
rc
 = 0;

377 
uöt32_t
 
¸c
;

378 
uöt32_t
 
i32ãmp
;

379 
chunk
, 
Àngth
;

380 
ssize_t
 
æí
;

381 *
îr
;

382 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
, *
lﬂd_tmp
;

383 
PF_cfg
 
cfg_chunk
;

385 
	`as£π
(
db
);

386 
	`as£π
(
db
->
c⁄fig
);

388 if(!
db
->
c⁄fig
->
≥rsi°í˚
 || db->c⁄fig->
≥rsi°í˚_fûï©h
 =
NULL
){

389  
MOSQ_ERR_SUCCESS
;

392 
db
->
msg_°‹e_lﬂd
 = 
NULL
;

394 
Âå
 = 
	`mosquôto__f›í
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
, "rb", 
Ál£
);

395 if(
Âå
 =
NULL
Ë 
MOSQ_ERR_SUCCESS
;

396 
æí
 = 
	`‰ód
(&
hódî
, 1, 15, 
Âå
);

397 if(
æí
 == 0){

398 
	`f˛o£
(
Âå
);

399 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Persistence file isÉmpty.");

401 }if(
æí
 != 15){

402 
îr‹
;

404 if(!
	`memcmp
(
hódî
, 
magic
, 15)){

406 
	`ªad_e
(
Âå
, &
¸c
, (
uöt32_t
));

407 
	`ªad_e
(
Âå
, &
i32ãmp
, (
uöt32_t
));

408 
db_vîsi⁄
 = 
	`¡ohl
(
i32ãmp
);

412 if(
db_vîsi⁄
 > 
MOSQ_DB_VERSION
 && db_version != 0){

413 if(
db_vîsi⁄
 == 4){

414 }if(
db_vîsi⁄
 == 3){

416 }if(
db_vîsi⁄
 == 2){

419 
	`f˛o£
(
Âå
);

420 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Unsuµ‹ãdÖîsi°íàd©aba£ f‹m© vîsi⁄ %d (√ed vîsi⁄ %d).", 
db_vîsi⁄
, 
MOSQ_DB_VERSION
);

425 
	`≥rsi°__chunk_hódî_ªad
(
Âå
, &
chunk
, &
Àngth
Ë=
MOSQ_ERR_SUCCESS
){

426 
chunk
){

427 
DB_CHUNK_CFG
:

428 if(
db_vîsi⁄
 == 5){

429 if(
	`≥rsi°__chunk_cfg_ªad_v5
(
Âå
, &
cfg_chunk
)){

433 if(
	`≥rsi°__chunk_cfg_ªad_v234
(
Âå
, &
cfg_chunk
)){

437 if(
cfg_chunk
.
dbid_size
 !(
dbid_t
)){

438 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Incompatible database configuration (dbid size is %d bytes,Éxpected %lu)",

439 
cfg_chunk
.
dbid_size
, ()(
dbid_t
));

440 
	`f˛o£
(
Âå
);

443 
db
->
œ°_db_id
 = 
cfg_chunk
.last_db_id;

446 
DB_CHUNK_MSG_STORE
:

447 if(
	`≥rsi°__msg_°‹e_chunk_ª°‹e
(
db
, 
Âå
, 
Àngth
))  1;

450 
DB_CHUNK_CLIENT_MSG
:

451 if(
	`≥rsi°__˛õ¡_msg_chunk_ª°‹e
(
db
, 
Âå
, 
Àngth
))  1;

454 
DB_CHUNK_RETAIN
:

455 if(
	`≥rsi°__ªèö_chunk_ª°‹e
(
db
, 
Âå
))  1;

458 
DB_CHUNK_SUB
:

459 if(
	`≥rsi°__sub_chunk_ª°‹e
(
db
, 
Âå
))  1;

462 
DB_CHUNK_CLIENT
:

463 if(
	`≥rsi°__˛õ¡_chunk_ª°‹e
(
db
, 
Âå
))  1;

467 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Unsuµ‹ãd chunk \"%d\" i¿≥rsi°íàd©aba£ fûe. Ign‹ög.", 
chunk
);

468 
	`f£ek
(
Âå
, 
Àngth
, 
SEEK_CUR
);

472 if(
æí
 < 0Ë
îr‹
;

474 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅoÑestoreÖersistent database. Unrecognised file format.");

475 
rc
 = 1;

478 
	`f˛o£
(
Âå
);

480 
	`HASH_ITER
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
lﬂd
, 
lﬂd_tmp
){

481 
	`HASH_DELETE
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
lﬂd
);

482 
	`mosquôto__‰ì
(
lﬂd
);

484  
rc
;

485 
îr‹
:

486 
îr
 = 
	`°ªº‹
(
î∫o
);

487 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

488 if(
Âå
Ë
	`f˛o£
(fptr);

490 
	}
}

492 
	$≥rsi°__ª°‹e_sub
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, c⁄° *
sub
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
)

494 
mosquôto
 *
c⁄ãxt
;

496 
	`as£π
(
db
);

497 
	`as£π
(
˛õ¡_id
);

498 
	`as£π
(
sub
);

500 
c⁄ãxt
 = 
	`≥rsi°__föd_‹_add_c⁄ãxt
(
db
, 
˛õ¡_id
, 0);

501 if(!
c⁄ãxt
)  1;

502  
	`sub__add
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, 
idítifõr
, 
›ti⁄s
, &db->
subs
);

503 
	}
}

	@src/persist_read_v234.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

32 
	~"mosquôto_brokî_öã∫Æ.h
"

33 
	~"mem‹y_mosq.h
"

34 
	~"≥rsi°.h
"

35 
	~"time_mosq.h
"

36 
	~"utû_mosq.h
"

39 
	$≥rsi°__chunk_hódî_ªad_v234
(
FILE
 *
db_Âå
, *
chunk
, *
Àngth
)

41 
size_t
 
æí
;

42 
uöt16_t
 
i16ãmp
;

43 
uöt32_t
 
i32ãmp
;

45 
æí
 = 
	`‰ód
(&
i16ãmp
, (
uöt16_t
), 1, 
db_Âå
);

46 if(
æí
 != 1)  1;

48 
æí
 = 
	`‰ód
(&
i32ãmp
, (
uöt32_t
), 1, 
db_Âå
);

49 if(
æí
 != 1)  1;

51 *
chunk
 = 
	`¡ohs
(
i16ãmp
);

52 *
Àngth
 = 
	`¡ohl
(
i32ãmp
);

54  
MOSQ_ERR_SUCCESS
;

55 
	}
}

58 
	$≥rsi°__chunk_cfg_ªad_v234
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
)

60 
	`ªad_e
(
db_Âå
, &
chunk
->
shutdown
, (
uöt8_t
));

61 
	`ªad_e
(
db_Âå
, &
chunk
->
dbid_size
, (
uöt8_t
));

62 
	`ªad_e
(
db_Âå
, &
chunk
->
œ°_db_id
, (
dbid_t
));

64  
MOSQ_ERR_SUCCESS
;

65 
îr‹
:

66 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

68 
	}
}

71 
	$≥rsi°__chunk_˛õ¡_ªad_v234
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
, 
db_vîsi⁄
)

73 
uöt16_t
 
i16ãmp
;

74 
rc
;

75 
time_t
 
ãmp
;

77 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
˛õ¡_id
);

78 if(
rc
){

79  
rc
;

82 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

83 
chunk
->
F
.
œ°_mid
 = 
	`¡ohs
(
i16ãmp
);

84 if(
db_vîsi⁄
 != 2){

85 
	`ªad_e
(
db_Âå
, &
ãmp
, (
time_t
));

88  
MOSQ_ERR_SUCCESS
;

89 
îr‹
:

90 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

91 
	`mosquôto__‰ì
(
chunk
->
˛õ¡_id
);

93 
	}
}

96 
	$≥rsi°__chunk_˛õ¡_msg_ªad_v234
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
)

98 
uöt16_t
 
i16ãmp
;

99 
rc
;

100 *
îr
;

101 
uöt8_t
 
ªèö
, 
dup
;

103 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
˛õ¡_id
);

104 if(
rc
){

105  
rc
;

108 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
°‹e_id
, (
dbid_t
));

110 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

111 
chunk
->
F
.
mid
 = 
	`¡ohs
(
i16ãmp
);

113 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
qos
, (
uöt8_t
));

114 
	`ªad_e
(
db_Âå
, &
ªèö
, (
uöt8_t
));

115 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
dúe˘i⁄
, (
uöt8_t
));

116 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
°©e
, (
uöt8_t
));

117 
	`ªad_e
(
db_Âå
, &
dup
, (
uöt8_t
));

119 
chunk
->
F
.
ªèö_dup
 = (
ªèö
&0x0F)<<4 | (
dup
&0x0F);

121  
MOSQ_ERR_SUCCESS
;

122 
îr‹
:

123 
îr
 = 
	`°ªº‹
(
î∫o
);

124 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

125 
	`mosquôto__‰ì
(
chunk
->
˛õ¡_id
);

127 
	}
}

130 
	$≥rsi°__chunk_msg_°‹e_ªad_v234
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
, 
db_vîsi⁄
)

132 
uöt32_t
 
i32ãmp
;

133 
uöt16_t
 
i16ãmp
;

134 
rc
 = 0;

135 *
îr
;

137 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
°‹e_id
, (
dbid_t
));

139 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
sour˚
.
id
);

140 if(
rc
){

141  
rc
;

143 if(
db_vîsi⁄
 == 4){

144 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
sour˚
.
u£∫ame
);

145 if(
rc
){

146 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

147  
rc
;

149 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

150 
chunk
->
F
.
sour˚_p‹t
 = 
	`¡ohs
(
i16ãmp
);

153 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

154 
chunk
->
F
.
sour˚_mid
 = 
	`¡ohs
(
i16ãmp
);

157 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

159 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
t›ic
);

160 if(
rc
){

161 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

162 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

163  
rc
;

166 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
qos
, (
uöt8_t
));

167 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
ªèö
, (
uöt8_t
));

169 
	`ªad_e
(
db_Âå
, &
i32ãmp
, (
uöt32_t
));

170 
chunk
->
F
.
∑ylﬂdÀn
 = 
	`¡ohl
(
i32ãmp
);

172 if(
chunk
->
F
.
∑ylﬂdÀn
){

173 if(
	`UHPA_ALLOC
(
chunk
->
∑ylﬂd
, chunk->
F
.
∑ylﬂdÀn
) == 0){

174 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

175 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

176 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

177 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

178  
MOSQ_ERR_NOMEM
;

180 
	`ªad_e
(
db_Âå
, 
	`UHPA_ACCESS
(
chunk
->
∑ylﬂd
, chunk->
F
.
∑ylﬂdÀn
), chunk->F.payloadlen);

183  
MOSQ_ERR_SUCCESS
;

184 
îr‹
:

185 
îr
 = 
	`°ªº‹
(
î∫o
);

186 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

187 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

188 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

190 
	}
}

193 
	$≥rsi°__chunk_ªèö_ªad_v234
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
)

195 
dbid_t
 
i64ãmp
;

196 *
îr
;

198 if(
	`‰ód
(&
i64ãmp
, (
dbid_t
), 1, 
db_Âå
) != 1){

199 
îr
 = 
	`°ªº‹
(
î∫o
);

200 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

203 
chunk
->
F
.
°‹e_id
 = 
i64ãmp
;

205  
MOSQ_ERR_SUCCESS
;

206 
	}
}

209 
	$≥rsi°__chunk_sub_ªad_v234
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
)

211 
rc
;

212 *
îr
;

214 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
˛õ¡_id
);

215 if(
rc
){

216  
rc
;

219 
rc
 = 
	`≥rsi°__ªad_°rög
(
db_Âå
, &
chunk
->
t›ic
);

220 if(
rc
){

221 
	`mosquôto__‰ì
(
chunk
->
˛õ¡_id
);

222  
rc
;

225 
	`ªad_e
(
db_Âå
, &
chunk
->
F
.
qos
, (
uöt8_t
));

227  
MOSQ_ERR_SUCCESS
;

228 
îr‹
:

229 
îr
 = 
	`°ªº‹
(
î∫o
);

230 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

231 
	`mosquôto__‰ì
(
chunk
->
˛õ¡_id
);

232 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

234 
	}
}

	@src/persist_read_v5.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

32 
	~"mosquôto_brokî_öã∫Æ.h
"

33 
	~"mem‹y_mosq.h
"

34 
	~"mqâ_¥Ÿocﬁ.h
"

35 
	~"≥rsi°.h
"

36 
	~"¥›îty_mosq.h
"

37 
	~"time_mosq.h
"

38 
	~"utû_mosq.h
"

41 
	$≥rsi°__chunk_hódî_ªad_v5
(
FILE
 *
db_Âå
, *
chunk
, *
Àngth
)

43 
size_t
 
æí
;

44 
PF_hódî
 
hódî
;

46 
æí
 = 
	`‰ód
(&
hódî
, (
PF_hódî
), 1, 
db_Âå
);

47 if(
æí
 != 1)  1;

49 *
chunk
 = 
	`¡ohl
(
hódî
.chunk);

50 *
Àngth
 = 
	`¡ohl
(
hódî
.length);

52  
MOSQ_ERR_SUCCESS
;

53 
	}
}

56 
	$≥rsi°__chunk_cfg_ªad_v5
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
)

58 if(
	`‰ód
(
chunk
, (
PF_cfg
), 1, 
db_Âå
) != 1){

59 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

63  
MOSQ_ERR_SUCCESS
;

64 
	}
}

67 
	$≥rsi°__chunk_˛õ¡_ªad_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
)

69 
rc
;

71 
	`ªad_e
(
db_Âå
, &
chunk
->
F
, (
PF_˛õ¡
));

72 
chunk
->
F
.
£ssi⁄_expúy_öãrvÆ
 = 
	`¡ohl
(chunk->F.session_expiry_interval);

73 
chunk
->
F
.
œ°_mid
 = 
	`¡ohs
(chunk->F.last_mid);

74 
chunk
->
F
.
id_Àn
 = 
	`¡ohs
(chunk->F.id_len);

76 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
˛õ¡_id
, chunk->
F
.
id_Àn
);

77 if(
rc
 || !
chunk
->
˛õ¡_id
){

80  
MOSQ_ERR_SUCCESS
;

82 
îr‹
:

83 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

85 
	}
}

88 
	$≥rsi°__chunk_˛õ¡_msg_ªad_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
, 
uöt32_t
 
Àngth
)

90 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

91 
mosquôto__∑ckë
 
¥›_∑ckë
;

92 
rc
;

94 
	`ªad_e
(
db_Âå
, &
chunk
->
F
, (
PF_˛õ¡_msg
));

95 
chunk
->
F
.
mid
 = 
	`¡ohs
(chunk->F.mid);

96 
chunk
->
F
.
id_Àn
 = 
	`¡ohs
(chunk->F.id_len);

98 
Àngth
 -((
PF_˛õ¡_msg
Ë+ 
chunk
->
F
.
id_Àn
);

100 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
˛õ¡_id
, chunk->
F
.
id_Àn
);

101 if(
rc
){

102  
rc
;

105 if(
Àngth
 > 0){

106 
	`mem£t
(&
¥›_∑ckë
, 0, (
mosquôto__∑ckë
));

107 
¥›_∑ckë
.
ªmaöög_Àngth
 = 
Àngth
;

108 
¥›_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(
Àngth
);

109 if(!
¥›_∑ckë
.
∑ylﬂd
){

110  
MOSQ_ERR_NOMEM
;

112 
	`ªad_e
(
db_Âå
, 
¥›_∑ckë
.
∑ylﬂd
, 
Àngth
);

113 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
¥›_∑ckë
, &
¥›îtõs
);

114 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

115 if(
rc
){

116  
rc
;

119 
chunk
->
¥›îtõs
 =Öroperties;

121  
MOSQ_ERR_SUCCESS
;

122 
îr‹
:

123 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

125 
	}
}

128 
	$≥rsi°__chunk_msg_°‹e_ªad_v5
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
, 
uöt32_t
 
Àngth
)

130 
rc
 = 0;

131 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

132 
mosquôto__∑ckë
 
¥›_∑ckë
;

134 
	`mem£t
(&
¥›_∑ckë
, 0, (
mosquôto__∑ckë
));

136 
	`ªad_e
(
db_Âå
, &
chunk
->
F
, (
PF_msg_°‹e
));

137 
chunk
->
F
.
∑ylﬂdÀn
 = 
	`¡ohl
(chunk->F.payloadlen);

138 if(
chunk
->
F
.
∑ylﬂdÀn
 > 
MQTT_MAX_PAYLOAD
){

139  
MOSQ_ERR_INVAL
;

141 
chunk
->
F
.
sour˚_mid
 = 
	`¡ohs
(chunk->F.source_mid);

142 
chunk
->
F
.
sour˚_id_Àn
 = 
	`¡ohs
(chunk->F.source_id_len);

143 
chunk
->
F
.
sour˚_u£∫ame_Àn
 = 
	`¡ohs
(chunk->F.source_username_len);

144 
chunk
->
F
.
t›ic_Àn
 = 
	`¡ohs
(chunk->F.topic_len);

145 
chunk
->
F
.
sour˚_p‹t
 = 
	`¡ohs
(chunk->F.source_port);

147 
Àngth
 -((
PF_msg_°‹e
Ë+ 
chunk
->
F
.
∑ylﬂdÀn
 + chunk->F.
sour˚_id_Àn
 + chunk->F.
sour˚_u£∫ame_Àn
 + chunk->F.
t›ic_Àn
);

149 if(
chunk
->
F
.
sour˚_id_Àn
){

150 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
sour˚
.
id
, chunk->
F
.
sour˚_id_Àn
);

151 if(
rc
){

152  
rc
;

155 if(
chunk
->
F
.
sour˚_u£∫ame_Àn
){

156 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
sour˚
.
u£∫ame
, chunk->
F
.
sour˚_u£∫ame_Àn
);

157 if(
rc
){

158 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

159 
chunk
->
sour˚
.
id
 = 
NULL
;

160  
rc
;

163 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
t›ic
, chunk->
F
.
t›ic_Àn
);

164 if(
rc
){

165 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

166 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

167 
chunk
->
sour˚
.
id
 = 
NULL
;

168 
chunk
->
sour˚
.
u£∫ame
 = 
NULL
;

169  
rc
;

172 if(
chunk
->
F
.
∑ylﬂdÀn
 > 0){

173 if(
	`UHPA_ALLOC
(
chunk
->
∑ylﬂd
, chunk->
F
.
∑ylﬂdÀn
) == 0){

174 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

175 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

176 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

177 
chunk
->
sour˚
.
id
 = 
NULL
;

178 
chunk
->
sour˚
.
u£∫ame
 = 
NULL
;

179 
chunk
->
t›ic
 = 
NULL
;

180 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

181  
MOSQ_ERR_NOMEM
;

183 
	`ªad_e
(
db_Âå
, 
	`UHPA_ACCESS
(
chunk
->
∑ylﬂd
, chunk->
F
.
∑ylﬂdÀn
), chunk->F.payloadlen);

186 if(
Àngth
 > 0){

187 
¥›_∑ckë
.
ªmaöög_Àngth
 = 
Àngth
;

188 
¥›_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(
Àngth
);

189 if(!
¥›_∑ckë
.
∑ylﬂd
){

190 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

191 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

192 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

193  
MOSQ_ERR_NOMEM
;

195 
	`ªad_e
(
db_Âå
, 
¥›_∑ckë
.
∑ylﬂd
, 
Àngth
);

196 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
¥›_∑ckë
, &
¥›îtõs
);

197 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

198 if(
rc
){

199 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

200 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

201 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

202  
rc
;

205 
chunk
->
¥›îtõs
 =Öroperties;

207  
MOSQ_ERR_SUCCESS
;

208 
îr‹
:

209 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

210 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
id
);

211 
	`mosquôto__‰ì
(
chunk
->
sour˚
.
u£∫ame
);

212 
	`mosquôto__‰ì
(
chunk
->
t›ic
);

213 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

215 
	}
}

218 
	$≥rsi°__chunk_ªèö_ªad_v5
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
)

220 if(
	`‰ód
(&
chunk
->
F
, (
P_ªèö
), 1, 
db_Âå
) != 1){

221 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

224  
MOSQ_ERR_SUCCESS
;

225 
	}
}

228 
	$≥rsi°__chunk_sub_ªad_v5
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
)

230 
rc
;

232 
	`ªad_e
(
db_Âå
, &
chunk
->
F
, (
PF_sub
));

233 
chunk
->
F
.
idítifõr
 = 
	`¡ohl
(chunk->F.identifier);

234 
chunk
->
F
.
id_Àn
 = 
	`¡ohs
(chunk->F.id_len);

235 
chunk
->
F
.
t›ic_Àn
 = 
	`¡ohs
(chunk->F.topic_len);

237 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
˛õ¡_id
, chunk->
F
.
id_Àn
);

238 if(
rc
){

239  
rc
;

241 
rc
 = 
	`≥rsi°__ªad_°rög_Àn
(
db_Âå
, &
chunk
->
t›ic
, chunk->
F
.
t›ic_Àn
);

242 if(
rc
){

243 
	`mosquôto__‰ì
(
chunk
->
˛õ¡_id
);

244 
chunk
->
˛õ¡_id
 = 
NULL
;

245  
rc
;

248  
MOSQ_ERR_SUCCESS
;

249 
îr‹
:

250 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

252 
	}
}

	@src/persist_write.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

32 
	~"mosquôto_brokî_öã∫Æ.h
"

33 
	~"mem‹y_mosq.h
"

34 
	~"≥rsi°.h
"

35 
	~"time_mosq.h
"

36 
	~"utû_mosq.h
"

38 
	$≥rsi°__˛õ¡_mesßges_ßve
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto_˛õ¡_msg
 *
queue
)

40 
P_˛õ¡_msg
 
chunk
;

41 
mosquôto_˛õ¡_msg
 *
cmsg
;

42 
rc
;

44 
	`as£π
(
db
);

45 
	`as£π
(
db_Âå
);

46 
	`as£π
(
c⁄ãxt
);

48 
	`mem£t
(&
chunk
, 0, (
P_˛õ¡_msg
));

50 
cmsg
 = 
queue
;

51 
cmsg
){

52 if(!
	`°∫cmp
(
cmsg
->
°‹e
->
t›ic
, "$SYS", 4)

53 && 
cmsg
->
°‹e
->
ªf_cou¡
 <= 1

54 && 
cmsg
->
°‹e
->
de°_id_cou¡
 == 0){

58 
cmsg
 = cmsg->
√xt
;

62 
chunk
.
F
.
°‹e_id
 = 
cmsg
->
°‹e
->
db_id
;

63 
chunk
.
F
.
mid
 = 
cmsg
->mid;

64 
chunk
.
F
.
id_Àn
 = 
	`°æí
(
c⁄ãxt
->
id
);

65 
chunk
.
F
.
qos
 = 
cmsg
->qos;

66 
chunk
.
F
.
ªèö_dup
 = (
cmsg
->
ªèö
&0x0F)<<4 | (cmsg->
dup
&0x0F);

67 
chunk
.
F
.
dúe˘i⁄
 = 
cmsg
->direction;

68 
chunk
.
F
.
°©e
 = 
cmsg
->state;

69 
chunk
.
˛õ¡_id
 = 
c⁄ãxt
->
id
;

70 
chunk
.
¥›îtõs
 = 
cmsg
->properties;

72 
rc
 = 
	`≥rsi°__chunk_˛õ¡_msg_wrôe_v5
(
db_Âå
, &
chunk
);

73 if(
rc
){

74  
rc
;

77 
cmsg
 = cmsg->
√xt
;

80  
MOSQ_ERR_SUCCESS
;

81 
	}
}

84 
	$≥rsi°__mesßge_°‹e_ßve
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

86 
P_msg_°‹e
 
chunk
;

87 
mosquôto_msg_°‹e
 *
°‹ed
;

88 
rc
;

90 
	`as£π
(
db
);

91 
	`as£π
(
db_Âå
);

93 
	`mem£t
(&
chunk
, 0, (
P_msg_°‹e
));

95 
°‹ed
 = 
db
->
msg_°‹e
;

96 
°‹ed
){

97 if(
°‹ed
->
ªf_cou¡
 < 1 || st‹ed->
t›ic
 =
NULL
){

98 
°‹ed
 = st‹ed->
√xt
;

102 if(!
	`°∫cmp
(
°‹ed
->
t›ic
, "$SYS", 4)){

103 if(
°‹ed
->
ªf_cou¡
 <1 && st‹ed->
de°_id_cou¡
 == 0){

105 
°‹ed
 = st‹ed->
√xt
;

112 
chunk
.
F
.
ªèö
 = 0;

114 
chunk
.
F
.
ªèö
 = (
uöt8_t
)
°‹ed
->retain;

117 
chunk
.
F
.
°‹e_id
 = 
°‹ed
->
db_id
;

118 
chunk
.
F
.
expúy_time
 = 
°‹ed
->
mesßge_expúy_time
;

119 
chunk
.
F
.
∑ylﬂdÀn
 = 
°‹ed
->payloadlen;

120 
chunk
.
F
.
sour˚_mid
 = 
°‹ed
->source_mid;

121 if(
°‹ed
->
sour˚_id
){

122 
chunk
.
F
.
sour˚_id_Àn
 = 
	`°æí
(
°‹ed
->
sour˚_id
);

123 
chunk
.
sour˚
.
id
 = 
°‹ed
->
sour˚_id
;

125 
chunk
.
F
.
sour˚_id_Àn
 = 0;

126 
chunk
.
sour˚
.
id
 = 
NULL
;

128 if(
°‹ed
->
sour˚_u£∫ame
){

129 
chunk
.
F
.
sour˚_u£∫ame_Àn
 = 
	`°æí
(
°‹ed
->
sour˚_u£∫ame
);

130 
chunk
.
sour˚
.
u£∫ame
 = 
°‹ed
->
sour˚_u£∫ame
;

132 
chunk
.
F
.
sour˚_u£∫ame_Àn
 = 0;

133 
chunk
.
sour˚
.
u£∫ame
 = 
NULL
;

136 
chunk
.
F
.
t›ic_Àn
 = 
	`°æí
(
°‹ed
->
t›ic
);

137 
chunk
.
t›ic
 = 
°‹ed
->topic;

139 if(
°‹ed
->
sour˚_li°íî
){

140 
chunk
.
F
.
sour˚_p‹t
 = 
°‹ed
->
sour˚_li°íî
->
p‹t
;

142 
chunk
.
F
.
sour˚_p‹t
 = 0;

144 
chunk
.
F
.
qos
 = 
°‹ed
->qos;

145 
chunk
.
∑ylﬂd
 = 
°‹ed
->payload;

146 
chunk
.
¥›îtõs
 = 
°‹ed
->properties;

148 
rc
 = 
	`≥rsi°__chunk_mesßge_°‹e_wrôe_v5
(
db_Âå
, &
chunk
);

149 if(
rc
){

150  
rc
;

152 
°‹ed
 = st‹ed->
√xt
;

155  
MOSQ_ERR_SUCCESS
;

156 
	}
}

158 
	$≥rsi°__˛õ¡_ßve
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

160 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

161 
P_˛õ¡
 
chunk
;

162 
rc
;

164 
	`as£π
(
db
);

165 
	`as£π
(
db_Âå
);

167 
	`mem£t
(&
chunk
, 0, (
P_˛õ¡
));

169 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

170 if(
c⁄ãxt
 && c⁄ãxt->
˛ón_°¨t
 =
Ál£
){

171 
chunk
.
F
.
£ssi⁄_expúy_time
 = 
c⁄ãxt
->session_expiry_time;

172 
chunk
.
F
.
£ssi⁄_expúy_öãrvÆ
 = 
c⁄ãxt
->session_expiry_interval;

173 
chunk
.
F
.
œ°_mid
 = 
c⁄ãxt
->last_mid;

174 
chunk
.
F
.
id_Àn
 = 
	`°æí
(
c⁄ãxt
->
id
);

175 
chunk
.
˛õ¡_id
 = 
c⁄ãxt
->
id
;

177 
rc
 = 
	`≥rsi°__chunk_˛õ¡_wrôe_v5
(
db_Âå
, &
chunk
);

178 if(
rc
){

179  
rc
;

182 if(
	`≥rsi°__˛õ¡_mesßges_ßve
(
db
, 
db_Âå
, 
c⁄ãxt
, c⁄ãxt->
msgs_ö
.
öÊight
))  1;

183 if(
	`≥rsi°__˛õ¡_mesßges_ßve
(
db
, 
db_Âå
, 
c⁄ãxt
, c⁄ãxt->
msgs_ö
.
queued
))  1;

184 if(
	`≥rsi°__˛õ¡_mesßges_ßve
(
db
, 
db_Âå
, 
c⁄ãxt
, c⁄ãxt->
msgs_out
.
öÊight
))  1;

185 if(
	`≥rsi°__˛õ¡_mesßges_ßve
(
db
, 
db_Âå
, 
c⁄ãxt
, c⁄ãxt->
msgs_out
.
queued
))  1;

189  
MOSQ_ERR_SUCCESS
;

190 
	}
}

193 
	$≥rsi°__subs_ªèö_ßve
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
mosquôto__subhõr
 *
node
, c⁄° *
t›ic
, 
Àvñ
)

195 
mosquôto__subhõr
 *
subhõr
, *
subhõr_tmp
;

196 
mosquôto__subÀaf
 *
sub
;

197 
P_ªèö
 
ªèö_chunk
;

198 
P_sub
 
sub_chunk
;

199 *
thi°›ic
;

200 
size_t
 
¶í
;

201 
rc
;

203 
	`mem£t
(&
ªèö_chunk
, 0, (
P_ªèö
));

204 
	`mem£t
(&
sub_chunk
, 0, (
P_sub
));

206 
¶í
 = 
	`°æí
(
t›ic
Ë+ 
node
->
t›ic_Àn
 + 2;

207 
thi°›ic
 = 
	`mosquôto__mÆloc
(()*
¶í
);

208 if(!
thi°›ic
Ë 
MOSQ_ERR_NOMEM
;

209 if(
Àvñ
 > 1 || 
	`°æí
(
t›ic
)){

210 
	`¢¥ötf
(
thi°›ic
, 
¶í
, "%s/%s", 
t›ic
, 
node
->topic);

212 
	`¢¥ötf
(
thi°›ic
, 
¶í
, "%s", 
node
->
t›ic
);

215 
sub
 = 
node
->
subs
;

216 
sub
){

217 if(
sub
->
c⁄ãxt
->
˛ón_°¨t
 =
Ál£
 && sub->c⁄ãxt->
id
){

218 
sub_chunk
.
F
.
idítifõr
 = 
sub
->identifier;

219 
sub_chunk
.
F
.
id_Àn
 = 
	`°æí
(
sub
->
c⁄ãxt
->
id
);

220 
sub_chunk
.
F
.
t›ic_Àn
 = 
	`°æí
(
thi°›ic
);

221 
sub_chunk
.
F
.
qos
 = (
uöt8_t
)
sub
->qos;

222 
sub_chunk
.
F
.
›ti⁄s
 = 
sub
->
no_loˇl
<<2 | sub->
ªèö_as_published
<<3;

223 
sub_chunk
.
˛õ¡_id
 = 
sub
->
c⁄ãxt
->
id
;

224 
sub_chunk
.
t›ic
 = 
thi°›ic
;

226 
rc
 = 
	`≥rsi°__chunk_sub_wrôe_v5
(
db_Âå
, &
sub_chunk
);

227 if(
rc
){

228 
	`mosquôto__‰ì
(
thi°›ic
);

229  
rc
;

232 
sub
 = sub->
√xt
;

234 if(
node
->
ªèöed
){

235 if(
	`°∫cmp
(
node
->
ªèöed
->
t›ic
, "$SYS", 4)){

237 
ªèö_chunk
.
F
.
°‹e_id
 = 
node
->
ªèöed
->
db_id
;

238 
rc
 = 
	`≥rsi°__chunk_ªèö_wrôe_v5
(
db_Âå
, &
ªèö_chunk
);

239 if(
rc
){

240 
	`mosquôto__‰ì
(
thi°›ic
);

241  
rc
;

246 
	`HASH_ITER
(
hh
, 
node
->
chûdªn
, 
subhõr
, 
subhõr_tmp
){

247 
	`≥rsi°__subs_ªèö_ßve
(
db
, 
db_Âå
, 
subhõr
, 
thi°›ic
, 
Àvñ
+1);

249 
	`mosquôto__‰ì
(
thi°›ic
);

250  
MOSQ_ERR_SUCCESS
;

251 
	}
}

253 
	$≥rsi°__subs_ªèö_ßve_Æl
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

255 
mosquôto__subhõr
 *
subhõr
, *
subhõr_tmp
;

257 
	`HASH_ITER
(
hh
, 
db
->
subs
, 
subhõr
, 
subhõr_tmp
){

258 if(
subhõr
->
chûdªn
){

259 
	`≥rsi°__subs_ªèö_ßve
(
db
, 
db_Âå
, 
subhõr
->
chûdªn
, "", 0);

263  
MOSQ_ERR_SUCCESS
;

264 
	}
}

266 
	$≥rsi°__backup
(
mosquôto_db
 *
db
, 
boﬁ
 
shutdown
)

268 
rc
 = 0;

269 
FILE
 *
db_Âå
 = 
NULL
;

270 
uöt32_t
 
db_vîsi⁄_w
 = 
	`ht⁄l
(
MOSQ_DB_VERSION
);

271 
uöt32_t
 
¸c
 = 0;

272 *
îr
;

273 *
outfûe
 = 
NULL
;

274 
Àn
;

275 
PF_cfg
 
cfg_chunk
;

277 if(!
db
 || !db->
c⁄fig
 || !db->c⁄fig->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_INVAL
;

278 if(
db
->
c⁄fig
->
≥rsi°í˚
 =
Ál£
Ë 
MOSQ_ERR_SUCCESS
;

280 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Savög in-mem‹y d©aba£Åÿ%s.", 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
);

282 
Àn
 = 
	`°æí
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
)+5;

283 
outfûe
 = 
	`mosquôto__mÆloc
(
Àn
+1);

284 if(!
outfûe
){

285 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Error saving in-memory database, out of memory.");

286  
MOSQ_ERR_NOMEM
;

288 
	`¢¥ötf
(
outfûe
, 
Àn
, "%s.√w", 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
);

289 
outfûe
[
Àn
] = '\0';

291 #i‚de‡
WIN32


311 
rc
 = 
	`u∆ök
(
outfûe
);

312 i‡(
rc
 != 0) {

313 
rc
 = 0;

314 i‡(
î∫o
 !
ENOENT
) {

315 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Eº‹ savög in-mem‹y d©aba£, u«bÀÅÿªmovê%s.", 
outfûe
);

316 
îr‹
;

321 
db_Âå
 = 
	`mosquôto__f›í
(
outfûe
, "wb", 
åue
);

322 if(
db_Âå
 =
NULL
){

323 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Eº‹ savög in-mem‹y d©aba£, u«bÀÅÿ›í %†f‹ wrôög.", 
outfûe
);

324 
îr‹
;

328 
	`wrôe_e
(
db_Âå
, 
magic
, 15);

329 
	`wrôe_e
(
db_Âå
, &
¸c
, (
uöt32_t
));

330 
	`wrôe_e
(
db_Âå
, &
db_vîsi⁄_w
, (
uöt32_t
));

332 
	`mem£t
(&
cfg_chunk
, 0, (
PF_cfg
));

333 
cfg_chunk
.
œ°_db_id
 = 
db
->last_db_id;

334 
cfg_chunk
.
shutdown
 = shutdown;

335 
cfg_chunk
.
dbid_size
 = (
dbid_t
);

336 if(
	`≥rsi°__chunk_cfg_wrôe_v5
(
db_Âå
, &
cfg_chunk
)){

337 
îr‹
;

340 if(
	`≥rsi°__mesßge_°‹e_ßve
(
db
, 
db_Âå
)){

341 
îr‹
;

344 
	`≥rsi°__˛õ¡_ßve
(
db
, 
db_Âå
);

345 
	`≥rsi°__subs_ªèö_ßve_Æl
(
db
, 
db_Âå
);

347 #i‚de‡
WIN32


370 
	`fÊush
(
db_Âå
);

371 
	`fsync
(
	`fûío
(
db_Âå
));

373 
	`f˛o£
(
db_Âå
);

375 #ifde‡
WIN32


376 if(
	`ªmove
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
) != 0){

377 if(
î∫o
 !
ENOENT
){

378 
îr‹
;

382 if(
	`ª«me
(
outfûe
, 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
) != 0){

383 
îr‹
;

385 
	`mosquôto__‰ì
(
outfûe
);

386 
outfûe
 = 
NULL
;

387  
rc
;

388 
îr‹
:

389 
	`mosquôto__‰ì
(
outfûe
);

390 
îr
 = 
	`°ªº‹
(
î∫o
);

391 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

392 if(
db_Âå
Ë
	`f˛o£
(db_fptr);

394 
	}
}

	@src/persist_write_v5.c

17 
	~"c⁄fig.h
"

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

32 
	~"mosquôto_brokî_öã∫Æ.h
"

33 
	~"mem‹y_mosq.h
"

34 
	~"≥rsi°.h
"

35 
	~"∑ckë_mosq.h
"

36 
	~"¥›îty_mosq.h
"

37 
	~"time_mosq.h
"

38 
	~"utû_mosq.h
"

40 
	$≥rsi°__chunk_cfg_wrôe_v5
(
FILE
 *
db_Âå
, 
PF_cfg
 *
chunk
)

42 
PF_hódî
 
hódî
;

44 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_CFG
);

45 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_cfg
));

46 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

47 
	`wrôe_e
(
db_Âå
, 
chunk
, (
PF_cfg
));

49  
MOSQ_ERR_SUCCESS
;

50 
îr‹
:

51 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

53 
	}
}

56 
	$≥rsi°__chunk_˛õ¡_wrôe_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡
 *
chunk
)

58 
PF_hódî
 
hódî
;

59 
uöt16_t
 
id_Àn
 = 
chunk
->
F
.id_len;

61 
chunk
->
F
.
£ssi⁄_expúy_öãrvÆ
 = 
	`ht⁄l
(chunk->F.session_expiry_interval);

62 
chunk
->
F
.
œ°_mid
 = 
	`ht⁄s
(chunk->F.last_mid);

63 
chunk
->
F
.
id_Àn
 = 
	`ht⁄s
(chunk->F.id_len);

65 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_CLIENT
);

66 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_˛õ¡
)+
id_Àn
);

68 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

69 
	`wrôe_e
(
db_Âå
, &
chunk
->
F
, (
PF_˛õ¡
));

71 
	`wrôe_e
(
db_Âå
, 
chunk
->
˛õ¡_id
, 
id_Àn
);

73  
MOSQ_ERR_SUCCESS
;

74 
îr‹
:

75 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

77 
	}
}

80 
	$≥rsi°__chunk_˛õ¡_msg_wrôe_v5
(
FILE
 *
db_Âå
, 
P_˛õ¡_msg
 *
chunk
)

82 
PF_hódî
 
hódî
;

83 
mosquôto__∑ckë
 
¥›_∑ckë
;

84 
uöt16_t
 
id_Àn
 = 
chunk
->
F
.id_len;

85 
uöt32_t
 
¥›Àn
 = 0;

86 
rc
;

88 
	`mem£t
(&
¥›_∑ckë
, 0, (
mosquôto__∑ckë
));

89 if(
chunk
->
¥›îtõs
){

90 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
chunk
->
¥›îtõs
);

91 
¥›Àn
 +
	`∑ckë__v¨öt_byãs
(proplen);

94 
chunk
->
F
.
mid
 = 
	`ht⁄s
(chunk->F.mid);

95 
chunk
->
F
.
id_Àn
 = 
	`ht⁄s
(chunk->F.id_len);

97 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_CLIENT_MSG
);

98 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_˛õ¡_msg
Ë+ 
id_Àn
 + 
¥›Àn
);

100 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

101 
	`wrôe_e
(
db_Âå
, &
chunk
->
F
, (
PF_˛õ¡_msg
));

102 
	`wrôe_e
(
db_Âå
, 
chunk
->
˛õ¡_id
, 
id_Àn
);

103 if(
chunk
->
¥›îtõs
){

104 if(
¥›Àn
 > 0){

105 
¥›_∑ckë
.
ªmaöög_Àngth
 = 
¥›Àn
;

106 
¥›_∑ckë
.
∑ckë_Àngth
 = 
¥›Àn
;

107 
¥›_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(
¥›Àn
);

108 if(!
¥›_∑ckë
.
∑ylﬂd
){

109  
MOSQ_ERR_NOMEM
;

111 
rc
 = 
	`¥›îty__wrôe_Æl
(&
¥›_∑ckë
, 
chunk
->
¥›îtõs
, 
åue
);

112 if(
rc
) Ñc;

114 
	`wrôe_e
(
db_Âå
, 
¥›_∑ckë
.
∑ylﬂd
, 
¥›Àn
);

115 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

119  
MOSQ_ERR_SUCCESS
;

120 
îr‹
:

121 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

123 
	}
}

126 
	$≥rsi°__chunk_mesßge_°‹e_wrôe_v5
(
FILE
 *
db_Âå
, 
P_msg_°‹e
 *
chunk
)

128 
PF_hódî
 
hódî
;

129 
uöt32_t
 
∑ylﬂdÀn
 = 
chunk
->
F
.payloadlen;

130 
uöt16_t
 
sour˚_id_Àn
 = 
chunk
->
F
.source_id_len;

131 
uöt16_t
 
sour˚_u£∫ame_Àn
 = 
chunk
->
F
.source_username_len;

132 
uöt16_t
 
t›ic_Àn
 = 
chunk
->
F
.topic_len;

133 
uöt32_t
 
¥›Àn
 = 0;

134 
mosquôto__∑ckë
 
¥›_∑ckë
;

135 
rc
;

137 
	`mem£t
(&
¥›_∑ckë
, 0, (
mosquôto__∑ckë
));

138 if(
chunk
->
¥›îtõs
){

139 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
chunk
->
¥›îtõs
);

140 
¥›Àn
 +
	`∑ckë__v¨öt_byãs
(proplen);

143 
chunk
->
F
.
∑ylﬂdÀn
 = 
	`ht⁄l
(chunk->F.payloadlen);

144 
chunk
->
F
.
sour˚_mid
 = 
	`ht⁄s
(chunk->F.source_mid);

145 
chunk
->
F
.
sour˚_id_Àn
 = 
	`ht⁄s
(chunk->F.source_id_len);

146 
chunk
->
F
.
sour˚_u£∫ame_Àn
 = 
	`ht⁄s
(chunk->F.source_username_len);

147 
chunk
->
F
.
t›ic_Àn
 = 
	`ht⁄s
(chunk->F.topic_len);

148 
chunk
->
F
.
sour˚_p‹t
 = 
	`ht⁄s
(chunk->F.source_port);

150 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_MSG_STORE
);

151 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_msg_°‹e
) +

152 
t›ic_Àn
 + 
∑ylﬂdÀn
 +

153 
sour˚_id_Àn
 + 
sour˚_u£∫ame_Àn
 + 
¥›Àn
);

155 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

156 
	`wrôe_e
(
db_Âå
, &
chunk
->
F
, (
PF_msg_°‹e
));

157 if(
sour˚_id_Àn
){

158 
	`wrôe_e
(
db_Âå
, 
chunk
->
sour˚
.
id
, 
sour˚_id_Àn
);

160 if(
sour˚_u£∫ame_Àn
){

161 
	`wrôe_e
(
db_Âå
, 
chunk
->
sour˚
.
u£∫ame
, 
sour˚_u£∫ame_Àn
);

163 
	`wrôe_e
(
db_Âå
, 
chunk
->
t›ic
, 
t›ic_Àn
);

164 if(
∑ylﬂdÀn
){

165 
	`wrôe_e
(
db_Âå
, 
	`UHPA_ACCESS
(
chunk
->
∑ylﬂd
, 
∑ylﬂdÀn
), ()payloadlen);

167 if(
chunk
->
¥›îtõs
){

168 if(
¥›Àn
 > 0){

169 
¥›_∑ckë
.
ªmaöög_Àngth
 = 
¥›Àn
;

170 
¥›_∑ckë
.
∑ckë_Àngth
 = 
¥›Àn
;

171 
¥›_∑ckë
.
∑ylﬂd
 = 
	`mosquôto__mÆloc
(
¥›Àn
);

172 if(!
¥›_∑ckë
.
∑ylﬂd
){

173  
MOSQ_ERR_NOMEM
;

175 
rc
 = 
	`¥›îty__wrôe_Æl
(&
¥›_∑ckë
, 
chunk
->
¥›îtõs
, 
åue
);

176 if(
rc
) Ñc;

178 
	`wrôe_e
(
db_Âå
, 
¥›_∑ckë
.
∑ylﬂd
, 
¥›Àn
);

179 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

183  
MOSQ_ERR_SUCCESS
;

184 
îr‹
:

185 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

186 
	`mosquôto__‰ì
(
¥›_∑ckë
.
∑ylﬂd
);

188 
	}
}

191 
	$≥rsi°__chunk_ªèö_wrôe_v5
(
FILE
 *
db_Âå
, 
P_ªèö
 *
chunk
)

193 
PF_hódî
 
hódî
;

195 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_RETAIN
);

196 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_ªèö
));

198 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

199 
	`wrôe_e
(
db_Âå
, &
chunk
->
F
, (
PF_ªèö
));

201  
MOSQ_ERR_SUCCESS
;

202 
îr‹
:

203 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

205 
	}
}

208 
	$≥rsi°__chunk_sub_wrôe_v5
(
FILE
 *
db_Âå
, 
P_sub
 *
chunk
)

210 
PF_hódî
 
hódî
;

211 
uöt16_t
 
id_Àn
 = 
chunk
->
F
.id_len;

212 
uöt16_t
 
t›ic_Àn
 = 
chunk
->
F
.topic_len;

214 
chunk
->
F
.
idítifõr
 = 
	`ht⁄l
(chunk->F.identifier);

215 
chunk
->
F
.
id_Àn
 = 
	`ht⁄s
(chunk->F.id_len);

216 
chunk
->
F
.
t›ic_Àn
 = 
	`ht⁄s
(chunk->F.topic_len);

218 
hódî
.
chunk
 = 
	`ht⁄l
(
DB_CHUNK_SUB
);

219 
hódî
.
Àngth
 = 
	`ht⁄l
((
PF_sub
) +

220 
id_Àn
 + 
t›ic_Àn
);

222 
	`wrôe_e
(
db_Âå
, &
hódî
, (
PF_hódî
));

223 
	`wrôe_e
(
db_Âå
, &
chunk
->
F
, (
PF_sub
));

224 
	`wrôe_e
(
db_Âå
, 
chunk
->
˛õ¡_id
, 
id_Àn
);

225 
	`wrôe_e
(
db_Âå
, 
chunk
->
t›ic
, 
t›ic_Àn
);

227  
MOSQ_ERR_SUCCESS
;

228 
îr‹
:

229 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

231 
	}
}

	@src/plugin.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto_brokî_öã∫Æ.h
"

20 
	~"mosquôto_öã∫Æ.h
"

21 
	~"mosquôto_brokî.h
"

22 
	~"mem‹y_mosq.h
"

24 #ifde‡
WITH_TLS


25 
	~<›ís¶/s¶.h
>

28 c⁄° *
	$mosquôto_˛õ¡_addªss
(c⁄° 
mosquôto
 *
˛õ¡
)

30  
˛õ¡
->
addªss
;

31 
	}
}

34 
boﬁ
 
	$mosquôto_˛õ¡_˛ón_£ssi⁄
(c⁄° 
mosquôto
 *
˛õ¡
)

36  
˛õ¡
->
˛ón_°¨t
;

37 
	}
}

40 c⁄° *
	$mosquôto_˛õ¡_id
(c⁄° 
mosquôto
 *
˛õ¡
)

42  
˛õ¡
->
id
;

43 
	}
}

46 
	$mosquôto_˛õ¡_kì∑live
(c⁄° 
mosquôto
 *
˛õ¡
)

48  
˛õ¡
->
kì∑live
;

49 
	}
}

52 *
	$mosquôto_˛õ¡_˚πifiˇã
(c⁄° 
mosquôto
 *
˛õ¡
)

54 #ifde‡
WITH_TLS


55 if(
˛õ¡
->
s¶
){

56  
	`SSL_gë_≥î_˚πifiˇã
(
˛õ¡
->
s¶
);

58  
NULL
;

61  
NULL
;

63 
	}
}

66 
	$mosquôto_˛õ¡_¥Ÿocﬁ
(c⁄° 
mosquôto
 *
˛õ¡
)

68  
˛õ¡
->
¥Ÿocﬁ
;

69 
	}
}

72 
	$mosquôto_˛õ¡_sub_cou¡
(c⁄° 
mosquôto
 *
˛õ¡
)

74  
˛õ¡
->
sub_cou¡
;

75 
	}
}

78 c⁄° *
	$mosquôto_˛õ¡_u£∫ame
(c⁄° 
mosquôto
 *
c⁄ãxt
)

80 #ifde‡
WITH_BRIDGE


81 if(
c⁄ãxt
->
bridge
){

82  
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
;

86  
c⁄ãxt
->
u£∫ame
;

88 
	}
}

90 
	$mosquôto_£t_u£∫ame
(
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
)

92 *
u_dup
;

93 *
ﬁd
;

94 
rc
;

96 if(!
˛õ¡
Ë 
MOSQ_ERR_INVAL
;

98 if(
u£∫ame
){

99 
u_dup
 = 
	`mosquôto__°rdup
(
u£∫ame
);

100 if(!
u_dup
Ë 
MOSQ_ERR_NOMEM
;

102 
u_dup
 = 
NULL
;

105 
ﬁd
 = 
˛õ¡
->
u£∫ame
;

106 
˛õ¡
->
u£∫ame
 = 
u_dup
;

108 
rc
 = 
	`a˛__föd_a˛s
(
	`mosquôto__gë_db
(), 
˛õ¡
);

109 if(
rc
){

110 
˛õ¡
->
u£∫ame
 = 
ﬁd
;

111 
	`mosquôto__‰ì
(
u_dup
);

112  
rc
;

114 
	`mosquôto__‰ì
(
ﬁd
);

115  
MOSQ_ERR_SUCCESS
;

117 
	}
}

	@src/plugin_defer.c

19 
	~<°dio.h
>

21 
	~"mosquôto_brokî.h
"

22 
	~"mosquôto_∂ugö.h
"

23 
	~"mosquôto.h
"

25 
	$mosquôto_auth_∂ugö_vîsi⁄
()

27  
MOSQ_AUTH_PLUGIN_VERSION
;

28 
	}
}

30 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

32  
MOSQ_ERR_SUCCESS
;

33 
	}
}

35 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

37  
MOSQ_ERR_SUCCESS
;

38 
	}
}

40 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

42  
MOSQ_ERR_SUCCESS
;

43 
	}
}

45 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

47  
MOSQ_ERR_SUCCESS
;

48 
	}
}

50 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, c⁄° 
mosquôto
 *
˛õ¡
, 
mosquôto_a˛_msg
 *
msg
)

52 
	`¥ötf
("mosquôto_a˛_check(u:%s)\n", 
	`mosquôto_˛õ¡_u£∫ame
(
˛õ¡
));

53  
MOSQ_ERR_PLUGIN_DEFER
;

54 
	}
}

56 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, c⁄° 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

58  
MOSQ_ERR_PLUGIN_DEFER
;

59 
	}
}

61 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, c⁄° 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

63  
MOSQ_ERR_PLUGIN_DEFER
;

64 
	}
}

	@src/property_broker.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"¥›îty_mosq.h
"

29 
	$¥›îty__¥o˚ss_c⁄√˘
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_¥›îty
 **
¥›s
)

31 
mosquôto_¥›îty
 *
p
;

33 
p
 = *
¥›s
;

35 
p
){

36 if(
p
->
idítifõr
 =
MQTT_PROP_SESSION_EXPIRY_INTERVAL
){

37 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 
p
->
vÆue
.
i32
;

38 }if(
p
->
idítifõr
 =
MQTT_PROP_RECEIVE_MAXIMUM
){

39 if(
p
->
vÆue
.
i16
 == 0){

40  
MOSQ_ERR_PROTOCOL
;

43 
c⁄ãxt
->
msgs_out
.
öÊight_maximum
 = 
p
->
vÆue
.
i16
;

44 
c⁄ãxt
->
msgs_out
.
öÊight_quŸa
 = c⁄ãxt->msgs_out.
öÊight_maximum
;

45 }if(
p
->
idítifõr
 =
MQTT_PROP_MAXIMUM_PACKET_SIZE
){

46 if(
p
->
vÆue
.
i32
 == 0){

47  
MOSQ_ERR_PROTOCOL
;

49 
c⁄ãxt
->
maximum_∑ckë_size
 = 
p
->
vÆue
.
i32
;

51 
p
 =Ö->
√xt
;

54  
MOSQ_ERR_SUCCESS
;

55 
	}
}

58 
	$¥›îty__¥o˚ss_wûl
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_mesßge_Æl
 *
msg
, 
mosquôto_¥›îty
 **
¥›s
)

60 
mosquôto_¥›îty
 *
p
, *
p_¥ev
;

61 
mosquôto_¥›îty
 *
msg_¥›îtõs
, *
msg_¥›îtõs_œ°
;

63 
p
 = *
¥›s
;

64 
p_¥ev
 = 
NULL
;

65 
msg_¥›îtõs
 = 
NULL
;

66 
msg_¥›îtõs_œ°
 = 
NULL
;

67 
p
){

68 
p
->
idítifõr
){

69 
MQTT_PROP_CONTENT_TYPE
:

70 
MQTT_PROP_CORRELATION_DATA
:

71 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
:

72 
MQTT_PROP_RESPONSE_TOPIC
:

73 
MQTT_PROP_USER_PROPERTY
:

74 if(
msg_¥›îtõs
){

75 
msg_¥›îtõs_œ°
->
√xt
 = 
p
;

76 
msg_¥›îtõs_œ°
 = 
p
;

78 
msg_¥›îtõs
 = 
p
;

79 
msg_¥›îtõs_œ°
 = 
p
;

81 if(
p_¥ev
){

82 
p_¥ev
->
√xt
 = 
p
->next;

83 
p
 = 
p_¥ev
->
√xt
;

85 *
¥›s
 = 
p
->
√xt
;

86 
p
 = *
¥›s
;

88 
msg_¥›îtõs_œ°
->
√xt
 = 
NULL
;

91 
MQTT_PROP_WILL_DELAY_INTERVAL
:

92 
c⁄ãxt
->
wûl_dñay_öãrvÆ
 = 
p
->
vÆue
.
i32
;

93 
p_¥ev
 = 
p
;

94 
p
 =Ö->
√xt
;

97 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
:

98 
msg
->
expúy_öãrvÆ
 = 
p
->
vÆue
.
i32
;

99 
p_¥ev
 = 
p
;

100 
p
 =Ö->
√xt
;

104  
MOSQ_ERR_PROTOCOL
;

109 
msg
->
¥›îtõs
 = 
msg_¥›îtõs
;

110  
MOSQ_ERR_SUCCESS
;

111 
	}
}

116 
	$¥›îty__¥o˚ss_disc⁄√˘
(
mosquôto
 *
c⁄ãxt
, 
mosquôto_¥›îty
 **
¥›s
)

118 
mosquôto_¥›îty
 *
p
;

120 
p
 = *
¥›s
;

122 
p
){

123 if(
p
->
idítifõr
 =
MQTT_PROP_SESSION_EXPIRY_INTERVAL
){

124 if(
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 =0 && 
p
->
vÆue
.
i32
 != 0){

125  
MOSQ_ERR_PROTOCOL
;

127 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 
p
->
vÆue
.
i32
;

129 
p
 =Ö->
√xt
;

131  
MOSQ_ERR_SUCCESS
;

132 
	}
}

	@src/read_handle.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

20 
	~<°dio.h
>

21 
	~<°rög.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"∑ckë_mosq.h
"

27 
	~"ªad_h™dÀ.h
"

28 
	~"£nd_mosq.h
"

29 
	~"sys_åì.h
"

30 
	~"utû_mosq.h
"

33 
	$h™dÀ__∑ckë
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

35 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

37 (
c⁄ãxt
->
ö_∑ckë
.
comm™d
)&0xF0){

38 
CMD_PINGREQ
:

39  
	`h™dÀ__pögªq
(
c⁄ãxt
);

40 
CMD_PINGRESP
:

41  
	`h™dÀ__pögª•
(
c⁄ãxt
);

42 
CMD_PUBACK
:

43  
	`h™dÀ__pubackcomp
(
db
, 
c⁄ãxt
, "PUBACK");

44 
CMD_PUBCOMP
:

45  
	`h™dÀ__pubackcomp
(
db
, 
c⁄ãxt
, "PUBCOMP");

46 
CMD_PUBLISH
:

47  
	`h™dÀ__publish
(
db
, 
c⁄ãxt
);

48 
CMD_PUBREC
:

49  
	`h™dÀ__pubªc
(
db
, 
c⁄ãxt
);

50 
CMD_PUBREL
:

51  
	`h™dÀ__pubªl
(
db
, 
c⁄ãxt
);

52 
CMD_CONNECT
:

53  
	`h™dÀ__c⁄√˘
(
db
, 
c⁄ãxt
);

54 
CMD_DISCONNECT
:

55  
	`h™dÀ__disc⁄√˘
(
db
, 
c⁄ãxt
);

56 
CMD_SUBSCRIBE
:

57  
	`h™dÀ__subs¸ibe
(
db
, 
c⁄ãxt
);

58 
CMD_UNSUBSCRIBE
:

59  
	`h™dÀ__unsubs¸ibe
(
db
, 
c⁄ãxt
);

60 #ifde‡
WITH_BRIDGE


61 
CMD_CONNACK
:

62  
	`h™dÀ__c⁄«ck
(
db
, 
c⁄ãxt
);

63 
CMD_SUBACK
:

64  
	`h™dÀ__suback
(
c⁄ãxt
);

65 
CMD_UNSUBACK
:

66  
	`h™dÀ__unsuback
(
c⁄ãxt
);

68 
CMD_AUTH
:

69  
	`h™dÀ__auth
(
db
, 
c⁄ãxt
);

72  
MOSQ_ERR_PROTOCOL
;

74 
	}
}

	@src/security.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mosquôto_∂ugö.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"lib_lﬂd.h
"

27 (*
	tFUNC_auth_∂ugö_vîsi⁄
)();

29 
	`£curôy__˛ónup_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
›ts
, 
boﬁ
 
ªlﬂd
);

31 
	$LIB_ERROR
()

33 #ifde‡
WIN32


34 *
buf
;

35 
	`F‹m©Mesßge
(
FORMAT_MESSAGE_ALLOCATE_BUFFER
 | 
FORMAT_MESSAGE_FROM_STRING
,

36 
NULL
, 
	`GëLa°Eº‹
(), 
LANG_NEUTRAL
, &
buf
, 0, NULL);

37 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "LﬂdÉº‹: %s", 
buf
);

38 
	`LoˇlFªe
(
buf
);

40 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "LﬂdÉº‹: %s", 
	`dÀº‹
());

42 
	}
}

45 
	$£curôy__lﬂd_v2
(
mosquôto__auth_∂ugö
 *
∂ugö
, 
mosquôto_auth_›t
 *
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
, *
lib
)

47 
rc
;

49 if(!(
∂ugö
->
∂ugö_öô_v2
 = (
FUNC_auth_∂ugö_öô_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_init"))){

50 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

52 
	`LIB_ERROR
();

53 
	`LIB_CLOSE
(
lib
);

56 if(!(
∂ugö
->
∂ugö_˛ónup_v2
 = (
FUNC_auth_∂ugö_˛ónup_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_cleanup"))){

57 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

59 
	`LIB_ERROR
();

60 
	`LIB_CLOSE
(
lib
);

64 if(!(
∂ugö
->
£curôy_öô_v2
 = (
FUNC_auth_∂ugö_£curôy_öô_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_init"))){

65 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

67 
	`LIB_ERROR
();

68 
	`LIB_CLOSE
(
lib
);

72 if(!(
∂ugö
->
£curôy_˛ónup_v2
 = (
FUNC_auth_∂ugö_£curôy_˛ónup_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_cleanup"))){

73 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

75 
	`LIB_ERROR
();

76 
	`LIB_CLOSE
(
lib
);

80 if(!(
∂ugö
->
a˛_check_v2
 = (
FUNC_auth_∂ugö_a˛_check_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_acl_check"))){

81 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

83 
	`LIB_ERROR
();

84 
	`LIB_CLOSE
(
lib
);

88 if(!(
∂ugö
->
u≈wd_check_v2
 = (
FUNC_auth_∂ugö_u≈wd_check_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_unpwd_check"))){

89 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

91 
	`LIB_ERROR
();

92 
	`LIB_CLOSE
(
lib
);

96 if(!(
∂ugö
->
psk_key_gë_v2
 = (
FUNC_auth_∂ugö_psk_key_gë_v2
)
	`LIB_SYM
(
lib
, "mosquitto_auth_psk_key_get"))){

97 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

99 
	`LIB_ERROR
();

100 
	`LIB_CLOSE
(
lib
);

104 
∂ugö
->
lib
 =Üib;

105 
∂ugö
->
u£r_d©a
 = 
NULL
;

107 if(
∂ugö
->
∂ugö_öô_v2
){

108 
rc
 = 
∂ugö
->
	`∂ugö_öô_v2
(&∂ugö->
u£r_d©a
, 
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
);

109 if(
rc
){

110 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

111 "Eº‹: Authítiˇti⁄ÖlugöÑëu∫ed %d whí inôülisög.", 
rc
);

112  
rc
;

116 
	}
}

119 
	$£curôy__lﬂd_v3
(
mosquôto__auth_∂ugö
 *
∂ugö
, 
mosquôto_›t
 *
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
, *
lib
)

121 
rc
;

123 if(!(
∂ugö
->
∂ugö_öô_v3
 = (
FUNC_auth_∂ugö_öô_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_init"))){

124 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

126 
	`LIB_ERROR
();

127 
	`LIB_CLOSE
(
lib
);

130 if(!(
∂ugö
->
∂ugö_˛ónup_v3
 = (
FUNC_auth_∂ugö_˛ónup_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_cleanup"))){

131 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

133 
	`LIB_ERROR
();

134 
	`LIB_CLOSE
(
lib
);

138 if(!(
∂ugö
->
£curôy_öô_v3
 = (
FUNC_auth_∂ugö_£curôy_öô_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_init"))){

139 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

141 
	`LIB_ERROR
();

142 
	`LIB_CLOSE
(
lib
);

146 if(!(
∂ugö
->
£curôy_˛ónup_v3
 = (
FUNC_auth_∂ugö_£curôy_˛ónup_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_cleanup"))){

147 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

149 
	`LIB_ERROR
();

150 
	`LIB_CLOSE
(
lib
);

154 if(!(
∂ugö
->
a˛_check_v3
 = (
FUNC_auth_∂ugö_a˛_check_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_acl_check"))){

155 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

157 
	`LIB_ERROR
();

158 
	`LIB_CLOSE
(
lib
);

162 if(!(
∂ugö
->
u≈wd_check_v3
 = (
FUNC_auth_∂ugö_u≈wd_check_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_unpwd_check"))){

163 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

165 
	`LIB_ERROR
();

166 
	`LIB_CLOSE
(
lib
);

170 if(!(
∂ugö
->
psk_key_gë_v3
 = (
FUNC_auth_∂ugö_psk_key_gë_v3
)
	`LIB_SYM
(
lib
, "mosquitto_auth_psk_key_get"))){

171 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

173 
	`LIB_ERROR
();

174 
	`LIB_CLOSE
(
lib
);

178 
∂ugö
->
lib
 =Üib;

179 
∂ugö
->
u£r_d©a
 = 
NULL
;

180 if(
∂ugö
->
∂ugö_öô_v3
){

181 
rc
 = 
∂ugö
->
	`∂ugö_öô_v3
(&∂ugö->
u£r_d©a
, 
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
);

182 if(
rc
){

183 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

184 "Eº‹: Authítiˇti⁄ÖlugöÑëu∫ed %d whí inôülisög.", 
rc
);

185  
rc
;

189 
	}
}

192 
	$£curôy__lﬂd_v4
(
mosquôto__auth_∂ugö
 *
∂ugö
, 
mosquôto_›t
 *
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
, *
lib
)

194 
rc
;

196 if(!(
∂ugö
->
∂ugö_öô_v4
 = (
FUNC_auth_∂ugö_öô_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_init"))){

197 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

199 
	`LIB_ERROR
();

200 
	`LIB_CLOSE
(
lib
);

203 if(!(
∂ugö
->
∂ugö_˛ónup_v4
 = (
FUNC_auth_∂ugö_˛ónup_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_cleanup"))){

204 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

206 
	`LIB_ERROR
();

207 
	`LIB_CLOSE
(
lib
);

211 if(!(
∂ugö
->
£curôy_öô_v4
 = (
FUNC_auth_∂ugö_£curôy_öô_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_init"))){

212 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

214 
	`LIB_ERROR
();

215 
	`LIB_CLOSE
(
lib
);

219 if(!(
∂ugö
->
£curôy_˛ónup_v4
 = (
FUNC_auth_∂ugö_£curôy_˛ónup_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_cleanup"))){

220 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

222 
	`LIB_ERROR
();

223 
	`LIB_CLOSE
(
lib
);

227 if(!(
∂ugö
->
a˛_check_v4
 = (
FUNC_auth_∂ugö_a˛_check_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_acl_check"))){

228 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

230 
	`LIB_ERROR
();

231 
	`LIB_CLOSE
(
lib
);

235 
∂ugö
->
u≈wd_check_v4
 = (
FUNC_auth_∂ugö_u≈wd_check_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_unpwd_check");

236 if(
∂ugö
->
u≈wd_check_v4
){

237 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

240 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

244 
∂ugö
->
psk_key_gë_v4
 = (
FUNC_auth_∂ugö_psk_key_gë_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_psk_key_get");

245 if(
∂ugö
->
psk_key_gë_v4
){

246 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

249 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

253 
∂ugö
->
auth_°¨t_v4
 = (
FUNC_auth_∂ugö_auth_°¨t_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_start");

254 
∂ugö
->
auth_c⁄töue_v4
 = (
FUNC_auth_∂ugö_auth_c⁄töue_v4
)
	`LIB_SYM
(
lib
, "mosquitto_auth_continue");

256 if(
∂ugö
->
auth_°¨t_v4
){

257 if(
∂ugö
->
auth_c⁄töue_v4
){

258 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

261 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

263 
	`LIB_CLOSE
(
lib
);

267 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

271 
∂ugö
->
lib
 =Üib;

272 
∂ugö
->
u£r_d©a
 = 
NULL
;

273 if(
∂ugö
->
∂ugö_öô_v4
){

274 
rc
 = 
∂ugö
->
	`∂ugö_öô_v4
(&∂ugö->
u£r_d©a
, 
auth_›ti⁄s
, 
auth_›ti⁄_cou¡
);

275 if(
rc
){

276 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

277 "Eº‹: Authítiˇti⁄ÖlugöÑëu∫ed %d whí inôülisög.", 
rc
);

278  
rc
;

282 
	}
}

285 
	$£curôy__moduÀ_öô_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
›ts
)

287 *
lib
;

288 (*
∂ugö_vîsi⁄
)(Ë
NULL
;

289 
vîsi⁄
;

290 
i
;

291 
rc
;

293 if(
›ts
->
auth_∂ugö_c⁄fig_cou¡
 == 0){

294  
MOSQ_ERR_SUCCESS
;

297 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

298 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∑th
){

299 
	`mem£t
(&
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
, 0, (
mosquôto__auth_∂ugö
));

301 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "LﬂdögÖlugö: %s", 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∑th
);

303 
lib
 = 
	`LIB_LOAD
(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∑th
);

304 if(!
lib
){

305 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

306 "Eº‹: U«bÀÅÿlﬂdáuthÖlugö \"%s\".", 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∑th
);

307 
	`LIB_ERROR
();

311 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
lib
 = 
NULL
;

312 if(!(
∂ugö_vîsi⁄
 = (
FUNC_auth_∂ugö_vîsi⁄
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_version"))){

313 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

315 
	`LIB_ERROR
();

316 
	`LIB_CLOSE
(
lib
);

319 
vîsi⁄
 = 
	`∂ugö_vîsi⁄
();

320 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 = version;

321 if(
vîsi⁄
 == 4){

322 
rc
 = 
	`£curôy__lﬂd_v4
(

323 &
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
,

324 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

325 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

326 
lib
);

328 if(
rc
){

329  
rc
;

331 }if(
vîsi⁄
 == 3){

332 
rc
 = 
	`£curôy__lﬂd_v3
(

333 &
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
,

334 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

335 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

336 
lib
);

338 if(
rc
){

339  
rc
;

341 }if(
vîsi⁄
 == 2){

342 
rc
 = 
	`£curôy__lﬂd_v2
(

343 &
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
,

344 (
mosquôto_auth_›t
 *)
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

345 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

346 
lib
);

348 if(
rc
){

349  
rc
;

352 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

354 
vîsi⁄
, 
MOSQ_AUTH_PLUGIN_VERSION
);

355 
	`LIB_ERROR
();

357 
	`LIB_CLOSE
(
lib
);

362  
MOSQ_ERR_SUCCESS
;

363 
	}
}

366 
	$mosquôto_£curôy_moduÀ_öô
(
mosquôto_db
 *
db
)

368 
rc
 = 
MOSQ_ERR_SUCCESS
;

369 
i
;

371 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

372 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

373 
rc
 = 
	`£curôy__moduÀ_öô_sögÀ
(&
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
);

374 if(
rc
) Ñc;

377 
rc
 = 
	`£curôy__moduÀ_öô_sögÀ
(&
db
->
c⁄fig
->
£curôy_›ti⁄s
);

379  
rc
;

380 
	}
}

383 
	$£curôy__moduÀ_˛ónup_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
›ts
)

385 
i
;

387 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

389 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 4){

390 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`∂ugö_˛ónup_v4
(

391 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

392 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

393 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
);

395 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 3){

396 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`∂ugö_˛ónup_v3
(

397 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

398 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

399 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
);

401 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 2){

402 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`∂ugö_˛ónup_v2
(

403 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

404 (
mosquôto_auth_›t
 *)
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

405 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
);

408 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
lib
){

409 
	`LIB_CLOSE
(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
lib
);

411 
	`mem£t
(&
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
, 0, (
mosquôto__auth_∂ugö
));

413 
	}
}

416 
	$mosquôto_£curôy_moduÀ_˛ónup
(
mosquôto_db
 *
db
)

418 
i
;

420 
	`mosquôto_£curôy_˛ónup
(
db
, 
Ál£
);

422 
	`£curôy__moduÀ_˛ónup_sögÀ
(&
db
->
c⁄fig
->
£curôy_›ti⁄s
);

424 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

425 
	`£curôy__moduÀ_˛ónup_sögÀ
(&
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
);

428  
MOSQ_ERR_SUCCESS
;

429 
	}
}

432 
	$£curôy__öô_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
›ts
, 
boﬁ
 
ªlﬂd
)

434 
i
;

435 
rc
;

437 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

438 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 4){

439 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_öô_v4
(

440 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

441 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

442 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

443 
ªlﬂd
);

445 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 3){

446 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_öô_v3
(

447 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

448 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

449 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

450 
ªlﬂd
);

452 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 2){

453 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_öô_v2
(

454 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

455 (
mosquôto_auth_›t
 *)
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

456 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

457 
ªlﬂd
);

459 
rc
 = 
MOSQ_ERR_INVAL
;

461 if(
rc
 !
MOSQ_ERR_SUCCESS
){

462  
rc
;

465  
MOSQ_ERR_SUCCESS
;

466 
	}
}

469 
	$mosquôto_£curôy_öô
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

471 
i
;

472 
rc
;

474 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

475 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

476 
rc
 = 
	`£curôy__öô_sögÀ
(&
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
, 
ªlﬂd
);

477 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

480 
rc
 = 
	`£curôy__öô_sögÀ
(&
db
->
c⁄fig
->
£curôy_›ti⁄s
, 
ªlﬂd
);

481 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

483  
	`mosquôto_£curôy_öô_deÁu…
(
db
, 
ªlﬂd
);

484 
	}
}

492 
	$mosquôto_£curôy_≠∂y
(
mosquôto_db
 *
db
)

494  
	`mosquôto_£curôy_≠∂y_deÁu…
(
db
);

495 
	}
}

498 
	$£curôy__˛ónup_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
›ts
, 
boﬁ
 
ªlﬂd
)

500 
i
;

501 
rc
;

503 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

504 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 4){

505 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_˛ónup_v4
(

506 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

507 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

508 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

509 
ªlﬂd
);

511 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 3){

512 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_˛ónup_v3
(

513 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

514 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

515 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

516 
ªlﬂd
);

518 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 2){

519 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`£curôy_˛ónup_v2
(

520 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

521 (
mosquôto_auth_›t
 *)
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄s
,

522 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
›ti⁄_cou¡
,

523 
ªlﬂd
);

525 
rc
 = 
MOSQ_ERR_INVAL
;

527 if(
rc
 !
MOSQ_ERR_SUCCESS
){

528  
rc
;

532  
MOSQ_ERR_SUCCESS
;

533 
	}
}

536 
	$mosquôto_£curôy_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

538 
i
;

539 
rc
;

541 
rc
 = 
	`£curôy__˛ónup_sögÀ
(&
db
->
c⁄fig
->
£curôy_›ti⁄s
, 
ªlﬂd
);

542 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

544 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

545 
rc
 = 
	`£curôy__˛ónup_sögÀ
(&
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
, 
ªlﬂd
);

546 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

548  
	`mosquôto_£curôy_˛ónup_deÁu…
(
db
, 
ªlﬂd
);

549 
	}
}

553 
	$a˛__check_sögÀ
(
mosquôto__auth_∂ugö_c⁄fig
 *
auth_∂ugö
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto_a˛_msg
 *
msg
, 
ac˚ss
)

555 c⁄° *
u£∫ame
;

556 c⁄° *
t›ic
 = 
msg
->topic;

558 
u£∫ame
 = 
	`mosquôto_˛õ¡_u£∫ame
(
c⁄ãxt
);

559 if(
auth_∂ugö
->
díy_•ecül_ch¨s
 =
åue
){

566 if(
u£∫ame
 && 
	`°Ωbrk
(username, "+#")){

567 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ACL díyögác˚s†tÿ˛õ¡ wôh d™gîou†u£∫amê\"%s\"", 
u£∫ame
);

568  
MOSQ_ERR_ACL_DENIED
;

570 if(
c⁄ãxt
->
id
 && 
	`°Ωbrk
(context->id, "+#")){

571 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ACL díyögác˚s†tÿ˛õ¡ wôh d™gîou†˛õ¡ id \"%s\"", 
c⁄ãxt
->
id
);

572  
MOSQ_ERR_ACL_DENIED
;

576 if(
auth_∂ugö
->
∂ugö
.
vîsi⁄
 == 4){

577  
auth_∂ugö
->
∂ugö
.
	`a˛_check_v4
◊uth_∂ugö->∂ugö.
u£r_d©a
, 
ac˚ss
, 
c⁄ãxt
, 
msg
);

578 }if(
auth_∂ugö
->
∂ugö
.
vîsi⁄
 == 3){

579  
auth_∂ugö
->
∂ugö
.
	`a˛_check_v3
◊uth_∂ugö->∂ugö.
u£r_d©a
, 
ac˚ss
, 
c⁄ãxt
, 
msg
);

580 }if(
auth_∂ugö
->
∂ugö
.
vîsi⁄
 == 2){

581 if(
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
){

582  
MOSQ_ERR_SUCCESS
;

584  
auth_∂ugö
->
∂ugö
.
	`a˛_check_v2
◊uth_∂ugö->∂ugö.
u£r_d©a
, 
c⁄ãxt
->
id
, 
u£∫ame
, 
t›ic
, 
ac˚ss
);

586  
MOSQ_ERR_INVAL
;

588 
	}
}

591 
	$a˛__check_dﬁœr
(c⁄° *
t›ic
, 
ac˚ss
)

593 
rc
;

594 
boﬁ
 
m©ch
 = 
Ál£
;

596 if(
t›ic
[0] !'$'Ë 
MOSQ_ERR_SUCCESS
;

598 if(!
	`°∫cmp
(
t›ic
, "$SYS", 4)){

599 if(
ac˚ss
 =
MOSQ_ACL_WRITE
){

601 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
("$SYS/brokî/c⁄√˘i⁄/+/°©e", 
t›ic
, &
m©ch
);

602 if(
rc
 =
MOSQ_ERR_SUCCESS
 && 
m©ch
 =
åue
){

603  
MOSQ_ERR_SUCCESS
;

605  
MOSQ_ERR_ACL_DENIED
;

608  
MOSQ_ERR_SUCCESS
;

610 }if(!
	`°∫cmp
(
t›ic
, "$share", 6)){

612 if(
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
){

614  
MOSQ_ERR_SUCCESS
;

616  
MOSQ_ERR_ACL_DENIED
;

620  
MOSQ_ERR_SUCCESS
;

622 
	}
}

625 
	$mosquôto_a˛_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, * 
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
ac˚ss
)

627 
rc
;

628 
i
;

629 
mosquôto__£curôy_›ti⁄s
 *
›ts
;

630 
mosquôto_a˛_msg
 
msg
;

632 if(!
c⁄ãxt
->
id
){

633  
MOSQ_ERR_ACL_DENIED
;

636 
rc
 = 
	`a˛__check_dﬁœr
(
t›ic
, 
ac˚ss
);

637 if(
rc
) Ñc;

639 
rc
 = 
	`mosquôto_a˛_check_deÁu…
(
db
, 
c⁄ãxt
, 
t›ic
, 
ac˚ss
);

640 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

641  
rc
;

646 
rc
 = 
MOSQ_ERR_SUCCESS
;

648 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

649 
›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

651 
›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

654 
	`mem£t
(&
msg
, 0, (msg));

655 
msg
.
t›ic
 =Åopic;

656 
msg
.
∑ylﬂdÀn
 =Öayloadlen;

657 
msg
.
∑ylﬂd
 =Öayload;

658 
msg
.
qos
 = qos;

659 
msg
.
ªèö
 =Ñetain;

661 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

662 
rc
 = 
	`a˛__check_sögÀ
(&
›ts
->
auth_∂ugö_c⁄figs
[
i
], 
c⁄ãxt
, &
msg
, 
ac˚ss
);

663 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

664  
rc
;

670 if(
rc
 =
MOSQ_ERR_PLUGIN_DEFER
){

671 
rc
 = 
MOSQ_ERR_ACL_DENIED
;

673  
rc
;

674 
	}
}

676 
	$mosquôto_u≈wd_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

678 
rc
;

679 
i
;

680 
mosquôto__£curôy_›ti⁄s
 *
›ts
;

682 
rc
 = 
	`mosquôto_u≈wd_check_deÁu…
(
db
, 
c⁄ãxt
, 
u£∫ame
, 
∑ssw‹d
);

683 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

684  
rc
;

689 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

690 
›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

692 
›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

695 
rc
 = 
MOSQ_ERR_SUCCESS
;

696 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

697 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 4

698 && 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u≈wd_check_v4
){

700 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`u≈wd_check_v4
(

701 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

702 
c⁄ãxt
,

703 
u£∫ame
,

704 
∑ssw‹d
);

706 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 3){

707 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`u≈wd_check_v3
(

708 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

709 
c⁄ãxt
,

710 
u£∫ame
,

711 
∑ssw‹d
);

713 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 2){

714 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`u≈wd_check_v2
(

715 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

716 
u£∫ame
,

717 
∑ssw‹d
);

719 
rc
 = 
MOSQ_ERR_INVAL
;

721 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

722  
rc
;

727 if(
rc
 =
MOSQ_ERR_PLUGIN_DEFER
){

728 
rc
 = 
MOSQ_ERR_AUTH
;

730  
rc
;

731 
	}
}

733 
	$mosquôto_psk_key_gë
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

735 
rc
;

736 
i
;

737 
mosquôto__£curôy_›ti⁄s
 *
›ts
;

739 
rc
 = 
	`mosquôto_psk_key_gë_deÁu…
(
db
, 
c⁄ãxt
, 
höt
, 
idítôy
, 
key
, 
max_key_Àn
);

740 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

741  
rc
;

748 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

749 
›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

751 
›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

754 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

755 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 4

756 && 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
psk_key_gë_v4
){

758 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`psk_key_gë_v4
(

759 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

760 
c⁄ãxt
,

761 
höt
,

762 
idítôy
,

763 
key
,

764 
max_key_Àn
);

766 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 3){

767 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`psk_key_gë_v3
(

768 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

769 
c⁄ãxt
,

770 
höt
,

771 
idítôy
,

772 
key
,

773 
max_key_Àn
);

775 }if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
vîsi⁄
 == 2){

776 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`psk_key_gë_v2
(

777 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

778 
höt
,

779 
idítôy
,

780 
key
,

781 
max_key_Àn
);

783 
rc
 = 
MOSQ_ERR_INVAL
;

785 if(
rc
 !
MOSQ_ERR_PLUGIN_DEFER
){

786  
rc
;

792 if(
rc
 =
MOSQ_ERR_PLUGIN_DEFER
){

793 
rc
 = 
MOSQ_ERR_AUTH
;

795  
rc
;

796 
	}
}

799 
	$mosquôto_£curôy_auth_°¨t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
ªauth
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_ö_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

801 
rc
 = 
MOSQ_ERR_PLUGIN_DEFER
;

802 
i
;

803 
mosquôto__£curôy_›ti⁄s
 *
›ts
;

805 if(!
c⁄ãxt
 || !c⁄ãxt->
li°íî
 || !c⁄ãxt->
auth_mëhod
Ë 
MOSQ_ERR_INVAL
;

806 if(!
d©a_out
 || !
d©a_out_Àn
Ë 
MOSQ_ERR_INVAL
;

808 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

809 
›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

811 
›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

814 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

815 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
auth_°¨t_v4
){

816 *
d©a_out
 = 
NULL
;

817 *
d©a_out_Àn
 = 0;

819 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`auth_°¨t_v4
(

820 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

821 
c⁄ãxt
,

822 
c⁄ãxt
->
auth_mëhod
,

823 
ªauth
,

824 
d©a_ö
, 
d©a_ö_Àn
,

825 
d©a_out
, 
d©a_out_Àn
);

827 if(
rc
 =
MOSQ_ERR_SUCCESS
){

828  
MOSQ_ERR_SUCCESS
;

829 }if(
rc
 =
MOSQ_ERR_AUTH_CONTINUE
){

830  
MOSQ_ERR_AUTH_CONTINUE
;

831 }if(
rc
 !
MOSQ_ERR_NOT_SUPPORTED
){

832  
rc
;

837  
MOSQ_ERR_NOT_SUPPORTED
;

838 
	}
}

841 
	$mosquôto_£curôy_auth_c⁄töue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
d©a_ö
, 
uöt16_t
 
d©a_ö_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

843 
rc
 = 
MOSQ_ERR_PLUGIN_DEFER
;

844 
i
;

845 
mosquôto__£curôy_›ti⁄s
 *
›ts
;

847 if(!
c⁄ãxt
 || !c⁄ãxt->
li°íî
 || !c⁄ãxt->
auth_mëhod
Ë 
MOSQ_ERR_INVAL
;

848 if(!
d©a_out
 || !
d©a_out_Àn
Ë 
MOSQ_ERR_INVAL
;

850 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

851 
›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

853 
›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

856 
i
=0; i<
›ts
->
auth_∂ugö_c⁄fig_cou¡
; i++){

857 if(
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
auth_°¨t_v4
){

858 *
d©a_out
 = 
NULL
;

859 *
d©a_out_Àn
 = 0;

861 
rc
 = 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
	`auth_c⁄töue_v4
(

862 
›ts
->
auth_∂ugö_c⁄figs
[
i
].
∂ugö
.
u£r_d©a
,

863 
c⁄ãxt
,

864 
c⁄ãxt
->
auth_mëhod
,

865 
d©a_ö
, 
d©a_ö_Àn
,

866 
d©a_out
, 
d©a_out_Àn
);

868 if(
rc
 =
MOSQ_ERR_SUCCESS
){

869  
MOSQ_ERR_SUCCESS
;

870 }if(
rc
 =
MOSQ_ERR_AUTH_CONTINUE
){

871  
MOSQ_ERR_AUTH_CONTINUE
;

872 }if(
rc
 !
MOSQ_ERR_NOT_SUPPORTED
){

873  
rc
;

878  
MOSQ_ERR_NOT_SUPPORTED
;

879 
	}
}

	@src/security_default.c

17 
	~"c⁄fig.h
"

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~"mosquôto_brokî_öã∫Æ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"mqâ_¥Ÿocﬁ.h
"

25 
	~"£nd_mosq.h
"

26 
	~"utû_mosq.h
"

28 
a˛fûe__∑r£
(
mosquôto_db
 *
db
, 
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
);

29 
u≈wd__fûe_∑r£
(
mosquôto__u≈wd
 **
u≈wd
, c⁄° *
∑ssw‹d_fûe
);

30 
a˛__˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

31 
u≈wd__˛ónup
(
mosquôto__u≈wd
 **
u≈wd
, 
boﬁ
 
ªlﬂd
);

32 
psk__fûe_∑r£
(
mosquôto_db
 *
db
, 
mosquôto__u≈wd
 **
psk_id
, c⁄° *
psk_fûe
);

33 #ifde‡
WITH_TLS


34 
pw__dige°
(c⁄° *
∑ssw‹d
, c⁄° *
ß…
, 
ß…_Àn
, *
hash
, *
hash_Àn
);

35 
ba£64__decode
(*
ö
, **
decoded
, *
decoded_Àn
);

36 
mosquôto__memcmp_c⁄°
(c⁄° *
±r1
, c⁄° *
b
, 
size_t
 
Àn
);

41 
	$mosquôto_£curôy_öô_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

43 
rc
;

44 
i
;

45 *
pwf
;

46 *
pskf
;

48 
	`UNUSED
(
ªlﬂd
);

51 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

52 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

53 
pwf
 = 
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
∑ssw‹d_fûe
;

54 if(
pwf
){

55 
rc
 = 
	`u≈wd__fûe_∑r£
(&
db
->
c⁄fig
->
li°íîs
[
i
].
u≈wd
, 
pwf
);

56 if(
rc
){

57 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖassw‹d fûê\"%s\".", 
pwf
);

58  
rc
;

63 if(
db
->
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
){

64 
pwf
 = 
db
->
c⁄fig
->
£curôy_›ti⁄s
.
∑ssw‹d_fûe
;

65 if(
pwf
){

66 
rc
 = 
	`u≈wd__fûe_∑r£
(&
db
->
u≈wd
, 
pwf
);

67 if(
rc
){

68 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖassw‹d fûê\"%s\".", 
pwf
);

69  
rc
;

76 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

77 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

78 if(
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
a˛_fûe
){

79 
rc
 = 
	`a˛fûe__∑r£
(
db
, &db->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
);

80 if(
rc
){

81 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögá˛ fûê\"%s\".", 
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
a˛_fûe
);

82  
rc
;

87 if(
db
->
c⁄fig
->
£curôy_›ti⁄s
.
a˛_fûe
){

88 
rc
 = 
	`a˛fûe__∑r£
(
db
, &db->
c⁄fig
->
£curôy_›ti⁄s
);

89 if(
rc
){

90 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögá˛ fûê\"%s\".", 
db
->
c⁄fig
->
£curôy_›ti⁄s
.
a˛_fûe
);

91  
rc
;

97 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

98 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

99 
pskf
 = 
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
.
psk_fûe
;

100 if(
pskf
){

101 
rc
 = 
	`psk__fûe_∑r£
(
db
, &db->
c⁄fig
->
li°íîs
[
i
].
psk_id
, 
pskf
);

102 if(
rc
){

103 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖsk fûê\"%s\".", 
pskf
);

104  
rc
;

109 *
pskf
 = 
db
->
c⁄fig
->
£curôy_›ti⁄s
.
psk_fûe
;

110 if(
pskf
){

111 
rc
 = 
	`psk__fûe_∑r£
(
db
, &db->
psk_id
, 
pskf
);

112 if(
rc
){

113 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖsk fûê\"%s\".", 
pskf
);

114  
rc
;

119  
MOSQ_ERR_SUCCESS
;

120 
	}
}

122 
	$mosquôto_£curôy_˛ónup_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

124 
rc
;

125 
i
;

127 
rc
 = 
	`a˛__˛ónup
(
db
, 
ªlﬂd
);

128 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

130 
rc
 = 
	`u≈wd__˛ónup
(&
db
->
u≈wd
, 
ªlﬂd
);

131 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

133 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

134 if(
db
->
c⁄fig
->
li°íîs
[
i
].
u≈wd
){

135 
rc
 = 
	`u≈wd__˛ónup
(&
db
->
c⁄fig
->
li°íîs
[
i
].
u≈wd
, 
ªlﬂd
);

136 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

140 
rc
 = 
	`u≈wd__˛ónup
(&
db
->
psk_id
, 
ªlﬂd
);

141 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

143 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

144 if(
db
->
c⁄fig
->
li°íîs
[
i
].
psk_id
){

145 
rc
 = 
	`u≈wd__˛ónup
(&
db
->
c⁄fig
->
li°íîs
[
i
].
psk_id
, 
ªlﬂd
);

146 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

150  
MOSQ_ERR_SUCCESS
;

151 
	}
}

154 
	$add__a˛
(
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
, c⁄° *
u£r
, c⁄° *
t›ic
, 
ac˚ss
)

156 
mosquôto__a˛_u£r
 *
a˛_u£r
=
NULL
, *
u£r_èû
;

157 
mosquôto__a˛
 *
a˛
, *
a˛_èû
;

158 *
loˇl_t›ic
;

159 
boﬁ
 
√w_u£r
 = 
Ál£
;

161 if(!
£curôy_›ts
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

163 
loˇl_t›ic
 = 
	`mosquôto__°rdup
(
t›ic
);

164 if(!
loˇl_t›ic
){

165  
MOSQ_ERR_NOMEM
;

168 if(
£curôy_›ts
->
a˛_li°
){

169 
u£r_èû
 = 
£curôy_›ts
->
a˛_li°
;

170 
u£r_èû
){

171 if(
u£r
 =
NULL
){

172 if(
u£r_èû
->
u£∫ame
 =
NULL
){

173 
a˛_u£r
 = 
u£r_èû
;

176 }if(
u£r_èû
->
u£∫ame
 && !
	`°rcmp
(u£r_èû->u£∫ame, 
u£r
)){

177 
a˛_u£r
 = 
u£r_èû
;

180 
u£r_èû
 = u£r_èû->
√xt
;

183 if(!
a˛_u£r
){

184 
a˛_u£r
 = 
	`mosquôto__mÆloc
((
mosquôto__a˛_u£r
));

185 if(!
a˛_u£r
){

186 
	`mosquôto__‰ì
(
loˇl_t›ic
);

187  
MOSQ_ERR_NOMEM
;

189 
√w_u£r
 = 
åue
;

190 if(
u£r
){

191 
a˛_u£r
->
u£∫ame
 = 
	`mosquôto__°rdup
(
u£r
);

192 if(!
a˛_u£r
->
u£∫ame
){

193 
	`mosquôto__‰ì
(
loˇl_t›ic
);

194 
	`mosquôto__‰ì
(
a˛_u£r
);

195  
MOSQ_ERR_NOMEM
;

198 
a˛_u£r
->
u£∫ame
 = 
NULL
;

200 
a˛_u£r
->
√xt
 = 
NULL
;

201 
a˛_u£r
->
a˛
 = 
NULL
;

204 
a˛
 = 
	`mosquôto__mÆloc
((
mosquôto__a˛
));

205 if(!
a˛
){

206 
	`mosquôto__‰ì
(
loˇl_t›ic
);

207 
	`mosquôto__‰ì
(
a˛_u£r
->
u£∫ame
);

208 
	`mosquôto__‰ì
(
a˛_u£r
);

209  
MOSQ_ERR_NOMEM
;

211 
a˛
->
ac˚ss
 =áccess;

212 
a˛
->
t›ic
 = 
loˇl_t›ic
;

213 
a˛
->
√xt
 = 
NULL
;

214 
a˛
->
ccou¡
 = 0;

215 
a˛
->
ucou¡
 = 0;

218 if(
a˛_u£r
->
a˛
){

219 
a˛_èû
 = 
a˛_u£r
->
a˛
;

220 
a˛_èû
->
√xt
){

221 
a˛_èû
 =á˛_èû->
√xt
;

223 
a˛_èû
->
√xt
 = 
a˛
;

225 
a˛_u£r
->
a˛
 =ácl;

228 if(
√w_u£r
){

230 if(
£curôy_›ts
->
a˛_li°
){

231 
u£r_èû
 = 
£curôy_›ts
->
a˛_li°
;

232 
u£r_èû
->
√xt
){

233 
u£r_èû
 = u£r_èû->
√xt
;

235 
u£r_èû
->
√xt
 = 
a˛_u£r
;

237 
£curôy_›ts
->
a˛_li°
 = 
a˛_u£r
;

241  
MOSQ_ERR_SUCCESS
;

242 
	}
}

244 
	$add__a˛_∑âîn
(
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
, c⁄° *
t›ic
, 
ac˚ss
)

246 
mosquôto__a˛
 *
a˛
, *
a˛_èû
;

247 *
loˇl_t›ic
;

248 *
s
;

250 if(!
£curôy_›ts
| !
t›ic
Ë 
MOSQ_ERR_INVAL
;

252 
loˇl_t›ic
 = 
	`mosquôto__°rdup
(
t›ic
);

253 if(!
loˇl_t›ic
){

254  
MOSQ_ERR_NOMEM
;

257 
a˛
 = 
	`mosquôto__mÆloc
((
mosquôto__a˛
));

258 if(!
a˛
){

259 
	`mosquôto__‰ì
(
loˇl_t›ic
);

260  
MOSQ_ERR_NOMEM
;

262 
a˛
->
ac˚ss
 =áccess;

263 
a˛
->
t›ic
 = 
loˇl_t›ic
;

264 
a˛
->
√xt
 = 
NULL
;

266 
a˛
->
ccou¡
 = 0;

267 
s
 = 
loˇl_t›ic
;

268 
s
){

269 
s
 = 
	`°r°r
(s, "%c");

270 if(
s
){

271 
a˛
->
ccou¡
++;

272 
s
+=2;

276 
a˛
->
ucou¡
 = 0;

277 
s
 = 
loˇl_t›ic
;

278 
s
){

279 
s
 = 
	`°r°r
(s, "%u");

280 if(
s
){

281 
a˛
->
ucou¡
++;

282 
s
+=2;

286 if(
a˛
->
ccou¡
 =0 &&á˛->
ucou¡
 == 0){

287 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
,

289 
t›ic
);

292 if(
£curôy_›ts
->
a˛_∑âîns
){

293 
a˛_èû
 = 
£curôy_›ts
->
a˛_∑âîns
;

294 
a˛_èû
->
√xt
){

295 
a˛_èû
 =á˛_èû->
√xt
;

297 
a˛_èû
->
√xt
 = 
a˛
;

299 
£curôy_›ts
->
a˛_∑âîns
 = 
a˛
;

302  
MOSQ_ERR_SUCCESS
;

303 
	}
}

305 
	$mosquôto_a˛_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
)

307 *
loˇl_a˛
;

308 
mosquôto__a˛
 *
a˛_roŸ
;

309 
boﬁ
 
ªsu…
;

310 
i
;

311 
Àn
, 
éí
, 
˛í
, 
uÀn
;

312 *
s
;

313 
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
 = 
NULL
;

315 if(!
db
 || !
c⁄ãxt
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

316 if(
c⁄ãxt
->
bridge
Ë 
MOSQ_ERR_SUCCESS
;

318 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

319 if(!
c⁄ãxt
->
li°íî
Ë 
MOSQ_ERR_ACL_DENIED
;

320 
£curôy_›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

322 
£curôy_›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

324 if(!
£curôy_›ts
->
a˛_fûe
 && !£curôy_›ts->
a˛_li°
 && !£curôy_›ts->
a˛_∑âîns
){

325  
MOSQ_ERR_PLUGIN_DEFER
;

328 if(
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
Ë 
MOSQ_ERR_SUCCESS
;

329 if(!
c⁄ãxt
->
a˛_li°
 && !
£curôy_›ts
->
a˛_∑âîns
Ë 
MOSQ_ERR_ACL_DENIED
;

331 if(
c⁄ãxt
->
a˛_li°
){

332 
a˛_roŸ
 = 
c⁄ãxt
->
a˛_li°
->
a˛
;

334 
a˛_roŸ
 = 
NULL
;

338 
a˛_roŸ
){

342 if(
t›ic
[0] ='$' && 
a˛_roŸ
->topic[0] != '$'){

343 
a˛_roŸ
 =á˛_roŸ->
√xt
;

346 
	`mosquôto_t›ic_m©ches_sub
(
a˛_roŸ
->
t›ic
,Å›ic, &
ªsu…
);

347 if(
ªsu…
){

348 if(
ac˚ss
 & 
a˛_roŸ
->access){

350  
MOSQ_ERR_SUCCESS
;

353 
a˛_roŸ
 =á˛_roŸ->
√xt
;

356 
a˛_roŸ
 = 
£curôy_›ts
->
a˛_∑âîns
;

358 if(
a˛_roŸ
){

366 if(
c⁄ãxt
->
u£∫ame
 && 
	`°Ωbrk
(context->username, "+#")){

367 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ACL díyögác˚s†tÿ˛õ¡ wôh d™gîou†u£∫amê\"%s\"", 
c⁄ãxt
->
u£∫ame
);

368  
MOSQ_ERR_ACL_DENIED
;

371 if(
c⁄ãxt
->
id
 && 
	`°Ωbrk
(context->id, "+#")){

372 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ACL díyögác˚s†tÿ˛õ¡ wôh d™gîou†˛õ¡ id \"%s\"", 
c⁄ãxt
->
id
);

373  
MOSQ_ERR_ACL_DENIED
;

378 if(!
c⁄ãxt
->
id
Ë 
MOSQ_ERR_ACL_DENIED
;

379 
˛í
 = 
	`°æí
(
c⁄ãxt
->
id
);

381 
a˛_roŸ
){

382 
éí
 = 
	`°æí
(
a˛_roŸ
->
t›ic
);

384 if(
a˛_roŸ
->
ucou¡
 && !
c⁄ãxt
->
u£∫ame
){

385 
a˛_roŸ
 =á˛_roŸ->
√xt
;

389 if(
c⁄ãxt
->
u£∫ame
){

390 
uÀn
 = 
	`°æí
(
c⁄ãxt
->
u£∫ame
);

391 
Àn
 = 
éí
 + 
a˛_roŸ
->
ccou¡
*(
˛í
-2Ë+á˛_roŸ->
ucou¡
*(
uÀn
-2);

393 
uÀn
 = 0;

394 
Àn
 = 
éí
 + 
a˛_roŸ
->
ccou¡
*(
˛í
-2);

396 
loˇl_a˛
 = 
	`mosquôto__mÆloc
(
Àn
+1);

397 if(!
loˇl_a˛
)  1;

398 
s
 = 
loˇl_a˛
;

399 
i
=0; i<
éí
; i++){

400 if(
i
<
éí
-1 && 
a˛_roŸ
->
t›ic
[i] == '%'){

401 if(
a˛_roŸ
->
t›ic
[
i
+1] == 'c'){

402 
i
++;

403 
	`°∫˝y
(
s
, 
c⁄ãxt
->
id
, 
˛í
);

404 
s
+=
˛í
;

406 }if(
c⁄ãxt
->
u£∫ame
 && 
a˛_roŸ
->
t›ic
[
i
+1] == 'u'){

407 
i
++;

408 
	`°∫˝y
(
s
, 
c⁄ãxt
->
u£∫ame
, 
uÀn
);

409 
s
+=
uÀn
;

413 
s
[0] = 
a˛_roŸ
->
t›ic
[
i
];

414 
s
++;

416 
loˇl_a˛
[
Àn
] = '\0';

418 
	`mosquôto_t›ic_m©ches_sub
(
loˇl_a˛
, 
t›ic
, &
ªsu…
);

419 
	`mosquôto__‰ì
(
loˇl_a˛
);

420 if(
ªsu…
){

421 if(
ac˚ss
 & 
a˛_roŸ
->access){

423  
MOSQ_ERR_SUCCESS
;

427 
a˛_roŸ
 =á˛_roŸ->
√xt
;

430  
MOSQ_ERR_ACL_DENIED
;

431 
	}
}

434 
	$a˛fûe__∑r£
(
mosquôto_db
 *
db
, 
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
)

436 
FILE
 *
a˛Âå
;

437 
buf
[1024];

438 *
tokí
;

439 *
u£r
 = 
NULL
;

440 *
t›ic
;

441 *
ac˚ss_s
;

442 
ac˚ss
;

443 
rc
;

444 
¶í
;

445 
t›ic_∑âîn
;

446 *
ßvïå
 = 
NULL
;

448 if(!
db
 || !db->
c⁄fig
Ë 
MOSQ_ERR_INVAL
;

449 if(!
£curôy_›ts
Ë 
MOSQ_ERR_INVAL
;

450 if(!
£curôy_›ts
->
a˛_fûe
Ë 
MOSQ_ERR_SUCCESS
;

452 
a˛Âå
 = 
	`mosquôto__f›í
(
£curôy_›ts
->
a˛_fûe
, "π", 
Ál£
);

453 if(!
a˛Âå
){

454 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íá˛_fûê\"%s\".", 
£curôy_›ts
->
a˛_fûe
);

461 
	`fgës
(
buf
, 1024, 
a˛Âå
)){

462 
¶í
 = 
	`°æí
(
buf
);

463 
¶í
 > 0 && (
buf
[slen-1] == 10 || buf[slen-1] == 13)){

464 
buf
[
¶í
-1] = '\0';

465 
¶í
 = 
	`°æí
(
buf
);

467 if(
buf
[0] == '#'){

470 
tokí
 = 
	`°πok_r
(
buf
, " ", &
ßvïå
);

471 if(
tokí
){

472 if(!
	`°rcmp
(
tokí
, "topic") || !strcmp(token, "pattern")){

473 if(!
	`°rcmp
(
tokí
, "topic")){

474 
t›ic_∑âîn
 = 0;

476 
t›ic_∑âîn
 = 1;

479 
ac˚ss_s
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

480 if(!
ac˚ss_s
){

481 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±yÅ›i¯öá˛_fûê\"%s\".", 
£curôy_›ts
->
a˛_fûe
);

482 
	`mosquôto__‰ì
(
u£r
);

483 
	`f˛o£
(
a˛Âå
);

484  
MOSQ_ERR_INVAL
;

486 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

487 if(
tokí
){

488 
t›ic
 = 
tokí
;

490 
t›ic
[0] == ' '){

491 
t›ic
++;

494 
t›ic
 = 
ac˚ss_s
;

495 
ac˚ss_s
 = 
NULL
;

497 if(
ac˚ss_s
){

498 if(!
	`°rcmp
(
ac˚ss_s
, "read")){

499 
ac˚ss
 = 
MOSQ_ACL_READ
;

500 }if(!
	`°rcmp
(
ac˚ss_s
, "write")){

501 
ac˚ss
 = 
MOSQ_ACL_WRITE
;

502 }if(!
	`°rcmp
(
ac˚ss_s
, "readwrite")){

503 
ac˚ss
 = 
MOSQ_ACL_READ
 | 
MOSQ_ACL_WRITE
;

505 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÅ›i¯ac˚s†ty≥ \"%s\" i¿a˛_fûê\"%s\".", 
ac˚ss_s
, 
£curôy_›ts
->
a˛_fûe
);

506 
	`mosquôto__‰ì
(
u£r
);

507 
	`f˛o£
(
a˛Âå
);

508  
MOSQ_ERR_INVAL
;

511 
ac˚ss
 = 
MOSQ_ACL_READ
 | 
MOSQ_ACL_WRITE
;

513 if(
t›ic_∑âîn
 == 0){

514 
rc
 = 
	`add__a˛
(
£curôy_›ts
, 
u£r
, 
t›ic
, 
ac˚ss
);

516 
rc
 = 
	`add__a˛_∑âîn
(
£curôy_›ts
, 
t›ic
, 
ac˚ss
);

518 if(
rc
){

519 
	`mosquôto__‰ì
(
u£r
);

520 
	`f˛o£
(
a˛Âå
);

521  
rc
;

523 }if(!
	`°rcmp
(
tokí
, "user")){

524 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

525 if(
tokí
){

527 
tokí
[0] == ' '){

528 
tokí
++;

530 
	`mosquôto__‰ì
(
u£r
);

531 
u£r
 = 
	`mosquôto__°rdup
(
tokí
);

532 if(!
u£r
){

533 
	`f˛o£
(
a˛Âå
);

534  
MOSQ_ERR_NOMEM
;

537 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Missög u£∫amêöá˛_fûê\"%s\".", 
£curôy_›ts
->
a˛_fûe
);

538 
	`mosquôto__‰ì
(
u£r
);

539 
	`f˛o£
(
a˛Âå
);

543 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜöêöá˛_fûê\"%s\": %s.", 
£curôy_›ts
->
a˛_fûe
, 
buf
);

544 
	`f˛o£
(
a˛Âå
);

550 
	`mosquôto__‰ì
(
u£r
);

551 
	`f˛o£
(
a˛Âå
);

553  
MOSQ_ERR_SUCCESS
;

554 
	}
}

556 
	$‰ì__a˛
(
mosquôto__a˛
 *
a˛
)

558 if(!
a˛
) ;

560 if(
a˛
->
√xt
){

561 
	`‰ì__a˛
(
a˛
->
√xt
);

563 
	`mosquôto__‰ì
(
a˛
->
t›ic
);

564 
	`mosquôto__‰ì
(
a˛
);

565 
	}
}

568 
	$a˛__˛ónup_sögÀ
(
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
)

570 
mosquôto__a˛_u£r
 *
u£r_èû
;

572 
£curôy_›ts
->
a˛_li°
){

573 
u£r_èû
 = 
£curôy_›ts
->
a˛_li°
->
√xt
;

575 
	`‰ì__a˛
(
£curôy_›ts
->
a˛_li°
->
a˛
);

576 
	`mosquôto__‰ì
(
£curôy_›ts
->
a˛_li°
->
u£∫ame
);

577 
	`mosquôto__‰ì
(
£curôy_›ts
->
a˛_li°
);

579 
£curôy_›ts
->
a˛_li°
 = 
u£r_èû
;

582 if(
£curôy_›ts
->
a˛_∑âîns
){

583 
	`‰ì__a˛
(
£curôy_›ts
->
a˛_∑âîns
);

584 
£curôy_›ts
->
a˛_∑âîns
 = 
NULL
;

586 
	}
}

589 
	$a˛__˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

591 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

592 
i
;

594 
	`UNUSED
(
ªlﬂd
);

596 if(!
db
Ë 
MOSQ_ERR_INVAL
;

604 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

605 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

608 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

609 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

610 
	`a˛__˛ónup_sögÀ
(&
db
->
c⁄fig
->
li°íîs
[
i
].
£curôy_›ti⁄s
);

613 
	`a˛__˛ónup_sögÀ
(&
db
->
c⁄fig
->
£curôy_›ti⁄s
);

616  
MOSQ_ERR_SUCCESS
;

617 
	}
}

620 
	$a˛__föd_a˛s
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

622 
mosquôto__a˛_u£r
 *
a˛_èû
;

623 
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
;

626 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

627 if(!
c⁄ãxt
->
li°íî
){

628  
MOSQ_ERR_INVAL
;

630 
£curôy_›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

632 
£curôy_›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

635 if(
£curôy_›ts
->
a˛_li°
){

636 
a˛_èû
 = 
£curôy_›ts
->
a˛_li°
;

637 
a˛_èû
){

638 if(
c⁄ãxt
->
u£∫ame
){

639 if(
a˛_èû
->
u£∫ame
 && !
	`°rcmp
(
c⁄ãxt
->username,ácl_tail->username)){

640 
c⁄ãxt
->
a˛_li°
 = 
a˛_èû
;

644 if(
a˛_èû
->
u£∫ame
 =
NULL
){

645 
c⁄ãxt
->
a˛_li°
 = 
a˛_èû
;

649 
a˛_èû
 =á˛_èû->
√xt
;

652 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

655  
MOSQ_ERR_SUCCESS
;

656 
	}
}

659 
	$pwfûe__∑r£
(c⁄° *
fûe
, 
mosquôto__u≈wd
 **
roŸ
)

661 
FILE
 *
pwfûe
;

662 
mosquôto__u≈wd
 *
u≈wd
;

663 
buf
[256];

664 *
u£∫ame
, *
∑ssw‹d
;

665 
Àn
;

666 *
ßvïå
 = 
NULL
;

668 
pwfûe
 = 
	`mosquôto__f›í
(
fûe
, "π", 
Ál£
);

669 if(!
pwfûe
){

670 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íÖwfûê\"%s\".", 
fûe
);

674 !
	`„of
(
pwfûe
)){

675 if(
	`fgës
(
buf
, 256, 
pwfûe
)){

676 if(
buf
[0] == '#') ;

677 if(!
	`°rchr
(
buf
, ':')) ;

679 
u£∫ame
 = 
	`°πok_r
(
buf
, ":", &
ßvïå
);

680 if(
u£∫ame
){

681 
u≈wd
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__u≈wd
));

682 if(!
u≈wd
){

683 
	`f˛o£
(
pwfûe
);

684  
MOSQ_ERR_NOMEM
;

686 
u≈wd
->
u£∫ame
 = 
	`mosquôto__°rdup
(username);

687 if(!
u≈wd
->
u£∫ame
){

688 
	`mosquôto__‰ì
(
u≈wd
);

689 
	`f˛o£
(
pwfûe
);

690  
MOSQ_ERR_NOMEM
;

692 
Àn
 = 
	`°æí
(
u≈wd
->
u£∫ame
);

693 
u≈wd
->
u£∫ame
[
Àn
-1] == 10 || unpwd->username[len-1] == 13){

694 
u≈wd
->
u£∫ame
[
Àn
-1] = '\0';

695 
Àn
 = 
	`°æí
(
u≈wd
->
u£∫ame
);

697 
∑ssw‹d
 = 
	`°πok_r
(
NULL
, ":", &
ßvïå
);

698 if(
∑ssw‹d
){

699 
u≈wd
->
∑ssw‹d
 = 
	`mosquôto__°rdup
(password);

700 if(!
u≈wd
->
∑ssw‹d
){

701 
	`f˛o£
(
pwfûe
);

702 
	`mosquôto__‰ì
(
u≈wd
->
u£∫ame
);

703 
	`mosquôto__‰ì
(
u≈wd
);

704  
MOSQ_ERR_NOMEM
;

706 
Àn
 = 
	`°æí
(
u≈wd
->
∑ssw‹d
);

707 
Àn
 && (
u≈wd
->
∑ssw‹d
[len-1] == 10 || unpwd->password[len-1] == 13)){

708 
u≈wd
->
∑ssw‹d
[
Àn
-1] = '\0';

709 
Àn
 = 
	`°æí
(
u≈wd
->
∑ssw‹d
);

712 
	`HASH_ADD_KEYPTR
(
hh
, *
roŸ
, 
u≈wd
->
u£∫ame
, 
	`°æí
(unpwd->username), unpwd);

714 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "W¨nög: InvÆidÜöêöÖassw‹d fûê'%s': %s", 
fûe
, 
buf
);

715 
	`mosquôto__‰ì
(
u≈wd
->
u£∫ame
);

716 
	`mosquôto__‰ì
(
u≈wd
);

721 
	`f˛o£
(
pwfûe
);

723  
MOSQ_ERR_SUCCESS
;

724 
	}
}

727 #ifde‡
WITH_TLS


729 
	$u≈wd__‰ì_ôem
(
mosquôto__u≈wd
 **
u≈wd
, mosquôto__u≈wd *
ôem
)

731 
	`mosquôto__‰ì
(
ôem
->
u£∫ame
);

732 
	`mosquôto__‰ì
(
ôem
->
∑ssw‹d
);

733 
	`mosquôto__‰ì
(
ôem
->
ß…
);

734 
	`HASH_DEL
(*
u≈wd
, 
ôem
);

735 
	`mosquôto__‰ì
(
ôem
);

736 
	}
}

739 
	$u≈wd__decode_∑ssw‹ds
(
mosquôto__u≈wd
 **
u≈wd
)

741 
mosquôto__u≈wd
 *
u
, *
tmp
;

742 *
tokí
;

743 *
ß…
;

744 
ß…_Àn
;

745 *
∑ssw‹d
;

746 
∑ssw‹d_Àn
;

747 
rc
;

749 
	`HASH_ITER
(
hh
, *
u≈wd
, 
u
, 
tmp
){

751 if(
u
->
∑ssw‹d
){

752 
tokí
 = 
	`°πok
(
u
->
∑ssw‹d
, "$");

753 if(
tokí
 && !
	`°rcmp
(token, "6")){

754 
tokí
 = 
	`°πok
(
NULL
, "$");

755 if(
tokí
){

756 
rc
 = 
	`ba£64__decode
(
tokí
, &
ß…
, &
ß…_Àn
);

757 if(
rc
 =
MOSQ_ERR_SUCCESS
 && 
ß…_Àn
 == 12){

758 
u
->
ß…
 = salt;

759 
u
->
ß…_Àn
 = salt_len;

760 
tokí
 = 
	`°πok
(
NULL
, "$");

761 if(
tokí
){

762 
rc
 = 
	`ba£64__decode
(
tokí
, &
∑ssw‹d
, &
∑ssw‹d_Àn
);

763 if(
rc
 =
MOSQ_ERR_SUCCESS
 && 
∑ssw‹d_Àn
 == 64){

764 
	`mosquôto__‰ì
(
u
->
∑ssw‹d
);

765 
u
->
∑ssw‹d
 = (*)password;

766 
u
->
∑ssw‹d_Àn
 =Öassword_len;

768 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿdecodê∑ssw‹d f‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

769 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

772 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

773 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

776 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿdecodê∑ssw‹d sÆàf‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

777 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

780 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

781 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

784 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

785 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

788 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: MissögÖassw‹d hash f‹ u£∏%s,ÑemovögÉ¡ry.", 
u
->
u£∫ame
);

789 
	`u≈wd__‰ì_ôem
(
u≈wd
, 
u
);

793  
MOSQ_ERR_SUCCESS
;

794 
	}
}

798 
	$u≈wd__fûe_∑r£
(
mosquôto__u≈wd
 **
u≈wd
, c⁄° *
∑ssw‹d_fûe
)

800 
rc
;

801 if(!
u≈wd
Ë 
MOSQ_ERR_INVAL
;

803 if(!
∑ssw‹d_fûe
Ë 
MOSQ_ERR_SUCCESS
;

805 
rc
 = 
	`pwfûe__∑r£
(
∑ssw‹d_fûe
, 
u≈wd
);

807 #ifde‡
WITH_TLS


808 if(
rc
) Ñc;

809 
rc
 = 
	`u≈wd__decode_∑ssw‹ds
(
u≈wd
);

812  
rc
;

813 
	}
}

815 
	$psk__fûe_∑r£
(
mosquôto_db
 *
db
, 
mosquôto__u≈wd
 **
psk_id
, c⁄° *
psk_fûe
)

817 
rc
;

818 
mosquôto__u≈wd
 *
u
, *
tmp
;

820 if(!
db
 || !db->
c⁄fig
 || !
psk_id
Ë 
MOSQ_ERR_INVAL
;

823 if(!
psk_fûe
Ë 
MOSQ_ERR_SUCCESS
;

825 
rc
 = 
	`pwfûe__∑r£
(
psk_fûe
, 
psk_id
);

826 if(
rc
) Ñc;

828 
	`HASH_ITER
(
hh
, (*
psk_id
), 
u
, 
tmp
){

830 if(!
u
->
∑ssw‹d
){

831 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±yÖsk f‹ idítôy \"%s\".", 
u
->
u£∫ame
);

832  
MOSQ_ERR_INVAL
;

834 if(
	`°r•n
(
u
->
∑ssw‹d
, "0123456789abcdefABCDEF"Ë< 
	`°æí
(u->password)){

835 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹:Ösk f‹ idítôy \"%s\" c⁄èö†n⁄-hexadecimÆ ch¨a˘îs.", 
u
->
u£∫ame
);

836  
MOSQ_ERR_INVAL
;

839  
MOSQ_ERR_SUCCESS
;

840 
	}
}

843 #ifde‡
WITH_TLS


844 
	$mosquôto__memcmp_c⁄°
(c⁄° *
a
, c⁄° *
b
, 
size_t
 
Àn
)

846 
size_t
 
i
;

847 
rc
 = 0;

849 if(!
a
 || !
b
)  1;

851 
i
=0; i<
Àn
; i++){

852 if–((*)
a
)[
i
] !((*)
b
)[i] ){

853 
rc
 = 1;

856  
rc
;

857 
	}
}

861 
	$mosquôto_u≈wd_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

863 
mosquôto__u≈wd
 *
u
, *
tmp
;

864 
mosquôto__u≈wd
 *
u≈wd_ªf
;

865 #ifde‡
WITH_TLS


866 
hash
[
EVP_MAX_MD_SIZE
];

867 
hash_Àn
;

868 
rc
;

871 if(!
db
Ë 
MOSQ_ERR_INVAL
;

873 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

874 if(
c⁄ãxt
->
bridge
Ë 
MOSQ_ERR_SUCCESS
;

875 if(!
c⁄ãxt
->
li°íî
Ë 
MOSQ_ERR_INVAL
;

876 if(!
c⁄ãxt
->
li°íî
->
u≈wd
Ë 
MOSQ_ERR_PLUGIN_DEFER
;

877 
u≈wd_ªf
 = 
c⁄ãxt
->
li°íî
->
u≈wd
;

879 if(!
db
->
u≈wd
Ë 
MOSQ_ERR_PLUGIN_DEFER
;

880 
u≈wd_ªf
 = 
db
->
u≈wd
;

882 if(!
u£∫ame
){

886  
MOSQ_ERR_AUTH
;

889 
	`HASH_ITER
(
hh
, 
u≈wd_ªf
, 
u
, 
tmp
){

890 if(!
	`°rcmp
(
u
->
u£∫ame
, username)){

891 if(
u
->
∑ssw‹d
){

892 if(
∑ssw‹d
){

893 #ifde‡
WITH_TLS


894 
rc
 = 
	`pw__dige°
(
∑ssw‹d
, 
u
->
ß…
, u->
ß…_Àn
, 
hash
, &
hash_Àn
);

895 if(
rc
 =
MOSQ_ERR_SUCCESS
){

896 if(
hash_Àn
 =
u
->
∑ssw‹d_Àn
 && !
	`mosquôto__memcmp_c⁄°
(u->
∑ssw‹d
, 
hash
, hash_len)){

897  
MOSQ_ERR_SUCCESS
;

899  
MOSQ_ERR_AUTH
;

902  
rc
;

905 if(!
	`°rcmp
(
u
->
∑ssw‹d
,Öassword)){

906  
MOSQ_ERR_SUCCESS
;

910  
MOSQ_ERR_AUTH
;

913  
MOSQ_ERR_SUCCESS
;

918  
MOSQ_ERR_AUTH
;

919 
	}
}

921 
	$u≈wd__˛ónup
(
mosquôto__u≈wd
 **
roŸ
, 
boﬁ
 
ªlﬂd
)

923 
mosquôto__u≈wd
 *
u
, *
tmp
;

925 
	`UNUSED
(
ªlﬂd
);

927 if(!
roŸ
Ë 
MOSQ_ERR_INVAL
;

929 
	`HASH_ITER
(
hh
, *
roŸ
, 
u
, 
tmp
){

930 
	`HASH_DEL
(*
roŸ
, 
u
);

931 
	`mosquôto__‰ì
(
u
->
∑ssw‹d
);

932 
	`mosquôto__‰ì
(
u
->
u£∫ame
);

933 #ifde‡
WITH_TLS


934 
	`mosquôto__‰ì
(
u
->
ß…
);

936 
	`mosquôto__‰ì
(
u
);

939 *
roŸ
 = 
NULL
;

941  
MOSQ_ERR_SUCCESS
;

942 
	}
}

945 #ifde‡
WITH_TLS


946 
	$£curôy__disc⁄√˘_auth
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

948 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

949 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_ADMINISTRATIVE_ACTION
, 
NULL
);

951 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

952 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_AUTH
);

953 
	}
}

962 
	$mosquôto_£curôy_≠∂y_deÁu…
(
mosquôto_db
 *
db
)

964 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

965 
mosquôto__a˛_u£r
 *
a˛_u£r_èû
;

966 
boﬁ
 
Ælow_™⁄ymous
;

967 
mosquôto__£curôy_›ti⁄s
 *
£curôy_›ts
 = 
NULL
;

968 #ifde‡
WITH_TLS


969 
i
;

970 
X509
 *
˛õ¡_˚π
 = 
NULL
;

971 
X509_NAME
 *
«me
;

972 
X509_NAME_ENTRY
 *
«me_íåy
;

973 
ASN1_STRING
 *
«me_a¢1
 = 
NULL
;

974 
mosquôto__li°íî
 *
li°íî
;

977 if(!
db
Ë 
MOSQ_ERR_INVAL
;

979 #ifde‡
WITH_TLS


980 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

981 
li°íî
 = &
db
->
c⁄fig
->
li°íîs
[
i
];

982 if(
li°íî
 &&Üi°íî->
s¶_˘x
 && (li°íî->
ˇfûe
 ||Üi°íî->
ˇ∑th
Ë&&Üi°íî->
¸lfûe
 &&Üi°íî->
ªquúe_˚πifiˇã
){

983 if(
	`√t__és_£rvî_˘x
(
li°íî
)){

987 if(
	`√t__és_lﬂd_vîify
(
li°íî
)){

994 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

996 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

997 if(
c⁄ãxt
->
li°íî
){

998 
Ælow_™⁄ymous
 = 
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
.allow_anonymous;

1001 
Ælow_™⁄ymous
 = 
åue
;

1004 
Ælow_™⁄ymous
 = 
db
->
c⁄fig
->
£curôy_›ti⁄s
.allow_anonymous;

1007 if(!
Ælow_™⁄ymous
 && !
c⁄ãxt
->
u£∫ame
){

1008 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

1009 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_AUTH
);

1014 #ifde‡
WITH_TLS


1015 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
s¶_˘x
 && (c⁄ãxt->li°íî->
u£_idítôy_as_u£∫ame
 || c⁄ãxt->li°íî->
u£_subje˘_as_u£∫ame
)){

1017 if(!
c⁄ãxt
->
s¶
){

1018 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

1019 
	`£nd__disc⁄√˘
(
c⁄ãxt
, 
MQTT_RC_ADMINISTRATIVE_ACTION
, 
NULL
);

1021 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

1022 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_AUTH
);

1025 #ifde‡
FINAL_WITH_TLS_PSK


1026 if(
c⁄ãxt
->
li°íî
->
psk_höt
){

1028 if(!
c⁄ãxt
->
u£∫ame
){

1029 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1036 
	`mosquôto__‰ì
(
c⁄ãxt
->
u£∫ame
);

1037 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

1038 
	`mosquôto__‰ì
(
c⁄ãxt
->
∑ssw‹d
);

1039 
c⁄ãxt
->
∑ssw‹d
 = 
NULL
;

1041 
˛õ¡_˚π
 = 
	`SSL_gë_≥î_˚πifiˇã
(
c⁄ãxt
->
s¶
);

1042 if(!
˛õ¡_˚π
){

1043 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1046 
«me
 = 
	`X509_gë_subje˘_«me
(
˛õ¡_˚π
);

1047 if(!
«me
){

1048 
	`X509_‰ì
(
˛õ¡_˚π
);

1049 
˛õ¡_˚π
 = 
NULL
;

1050 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1053 i‡(
c⁄ãxt
->
li°íî
->
u£_idítôy_as_u£∫ame
) {

1054 
i
 = 
	`X509_NAME_gë_ödex_by_NID
(
«me
, 
NID_comm⁄Name
, -1);

1055 if(
i
 == -1){

1056 
	`X509_‰ì
(
˛õ¡_˚π
);

1057 
˛õ¡_˚π
 = 
NULL
;

1058 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1061 
«me_íåy
 = 
	`X509_NAME_gë_íåy
(
«me
, 
i
);

1062 if(
«me_íåy
){

1063 
«me_a¢1
 = 
	`X509_NAME_ENTRY_gë_d©a
(
«me_íåy
);

1064 i‡(
«me_a¢1
 =
NULL
) {

1065 
	`X509_‰ì
(
˛õ¡_˚π
);

1066 
˛õ¡_˚π
 = 
NULL
;

1067 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1070 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

1071 
c⁄ãxt
->
u£∫ame
 = 
	`mosquôto__°rdup
((*Ë
	`ASN1_STRING_d©a
(
«me_a¢1
));

1073 
c⁄ãxt
->
u£∫ame
 = 
	`mosquôto__°rdup
((*Ë
	`ASN1_STRING_gë0_d©a
(
«me_a¢1
));

1075 if(!
c⁄ãxt
->
u£∫ame
){

1076 
	`X509_‰ì
(
˛õ¡_˚π
);

1077 
˛õ¡_˚π
 = 
NULL
;

1078 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1082 i‡((
size_t
)
	`ASN1_STRING_Àngth
(
«me_a¢1
Ë!
	`°æí
(
c⁄ãxt
->
u£∫ame
)) {

1083 
	`X509_‰ì
(
˛õ¡_˚π
);

1084 
˛õ¡_˚π
 = 
NULL
;

1085 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1090 
BIO
 *
subje˘_bio
 = 
	`BIO_√w
(
	`BIO_s_mem
());

1091 
	`X509_NAME_¥öt_ex
(
subje˘_bio
, 
	`X509_gë_subje˘_«me
(
˛õ¡_˚π
), 0, 
XN_FLAG_RFC2253
);

1092 *
d©a_°¨t
 = 
NULL
;

1093 
«me_Àngth
 = 
	`BIO_gë_mem_d©a
(
subje˘_bio
, &
d©a_°¨t
);

1094 *
subje˘
 = 
	`mosquôto__mÆloc
(()*
«me_Àngth
+1);

1095 if(!
subje˘
){

1096 
	`BIO_‰ì
(
subje˘_bio
);

1097 
	`X509_‰ì
(
˛õ¡_˚π
);

1098 
˛õ¡_˚π
 = 
NULL
;

1099 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1102 
	`mem˝y
(
subje˘
, 
d©a_°¨t
, 
«me_Àngth
);

1103 
subje˘
[
«me_Àngth
] = '\0';

1104 
	`BIO_‰ì
(
subje˘_bio
);

1105 
c⁄ãxt
->
u£∫ame
 = 
subje˘
;

1107 if(!
c⁄ãxt
->
u£∫ame
){

1108 
	`X509_‰ì
(
˛õ¡_˚π
);

1109 
˛õ¡_˚π
 = 
NULL
;

1110 
	`£curôy__disc⁄√˘_auth
(
db
, 
c⁄ãxt
);

1113 
	`X509_‰ì
(
˛õ¡_˚π
);

1114 
˛õ¡_˚π
 = 
NULL
;

1120 if(
	`mosquôto_u≈wd_check
(
db
, 
c⁄ãxt
, c⁄ãxt->
u£∫ame
, c⁄ãxt->
∑ssw‹d
Ë!
MOSQ_ERR_SUCCESS
){

1121 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

1122 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_AUTH
);

1129 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

1130 if(
c⁄ãxt
->
li°íî
){

1131 
£curôy_›ts
 = &
c⁄ãxt
->
li°íî
->
£curôy_›ti⁄s
;

1133 if(
c⁄ãxt
->
°©e
 !
mosq_cs_a˘ive
){

1134 
	`mosquôto__£t_°©e
(
c⁄ãxt
, 
mosq_cs_disc⁄√˘ög
);

1135 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
, 
MOSQ_ERR_AUTH
);

1140 
£curôy_›ts
 = &
db
->
c⁄fig
->
£curôy_›ti⁄s
;

1143 if(
£curôy_›ts
 && securôy_›ts->
a˛_li°
){

1144 
a˛_u£r_èû
 = 
£curôy_›ts
->
a˛_li°
;

1145 
a˛_u£r_èû
){

1146 if(
a˛_u£r_èû
->
u£∫ame
){

1147 if(
c⁄ãxt
->
u£∫ame
){

1148 if(!
	`°rcmp
(
a˛_u£r_èû
->
u£∫ame
, 
c⁄ãxt
->username)){

1149 
c⁄ãxt
->
a˛_li°
 = 
a˛_u£r_èû
;

1154 if(!
c⁄ãxt
->
u£∫ame
){

1155 
c⁄ãxt
->
a˛_li°
 = 
a˛_u£r_èû
;

1159 
a˛_u£r_èû
 =á˛_u£r_èû->
√xt
;

1163  
MOSQ_ERR_SUCCESS
;

1164 
	}
}

1166 
	$mosquôto_psk_key_gë_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

1168 
mosquôto__u≈wd
 *
u
, *
tmp
;

1169 
mosquôto__u≈wd
 *
psk_id_ªf
 = 
NULL
;

1171 if(!
db
 || !
höt
 || !
idítôy
 || !
key
Ë 
MOSQ_ERR_INVAL
;

1173 if(
db
->
c⁄fig
->
≥r_li°íî_£âögs
){

1174 if(!
c⁄ãxt
->
li°íî
Ë 
MOSQ_ERR_INVAL
;

1175 if(!
c⁄ãxt
->
li°íî
->
psk_id
Ë 
MOSQ_ERR_PLUGIN_DEFER
;

1176 
psk_id_ªf
 = 
c⁄ãxt
->
li°íî
->
psk_id
;

1178 if(!
db
->
psk_id
Ë 
MOSQ_ERR_PLUGIN_DEFER
;

1179 
psk_id_ªf
 = 
db
->
psk_id
;

1181 if(!
psk_id_ªf
Ë 
MOSQ_ERR_PLUGIN_DEFER
;

1183 
	`HASH_ITER
(
hh
, 
psk_id_ªf
, 
u
, 
tmp
){

1184 if(!
	`°rcmp
(
u
->
u£∫ame
, 
idítôy
)){

1185 
	`°∫˝y
(
key
, 
u
->
∑ssw‹d
, 
max_key_Àn
);

1186  
MOSQ_ERR_SUCCESS
;

1190  
MOSQ_ERR_AUTH
;

1191 
	}
}

1193 #ifde‡
WITH_TLS


1194 
	$pw__dige°
(c⁄° *
∑ssw‹d
, c⁄° *
ß…
, 
ß…_Àn
, *
hash
, *
hash_Àn
)

1196 c⁄° 
EVP_MD
 *
dige°
;

1197 #i‡
OPENSSL_VERSION_NUMBER
 < 0x10100000L

1198 
EVP_MD_CTX
 
c⁄ãxt
;

1200 
dige°
 = 
	`EVP_gë_dige°by«me
("sha512");

1201 if(!
dige°
){

1206 
	`EVP_MD_CTX_öô
(&
c⁄ãxt
);

1207 
	`EVP_Dige°Inô_ex
(&
c⁄ãxt
, 
dige°
, 
NULL
);

1208 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

1209 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
ß…
, 
ß…_Àn
);

1211 
	`EVP_Dige°FöÆ_ex
(&
c⁄ãxt
, 
hash
, 
hash_Àn
);

1212 
	`EVP_MD_CTX_˛ónup
(&
c⁄ãxt
);

1214 
EVP_MD_CTX
 *
c⁄ãxt
;

1216 
dige°
 = 
	`EVP_gë_dige°by«me
("sha512");

1217 if(!
dige°
){

1222 
c⁄ãxt
 = 
	`EVP_MD_CTX_√w
();

1223 
	`EVP_Dige°Inô_ex
(
c⁄ãxt
, 
dige°
, 
NULL
);

1224 
	`EVP_Dige°Upd©e
(
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

1225 
	`EVP_Dige°Upd©e
(
c⁄ãxt
, 
ß…
, 
ß…_Àn
);

1227 
	`EVP_Dige°FöÆ_ex
(
c⁄ãxt
, 
hash
, 
hash_Àn
);

1228 
	`EVP_MD_CTX_‰ì
(
c⁄ãxt
);

1231  
MOSQ_ERR_SUCCESS
;

1232 
	}
}

1234 
	$ba£64__decode
(*
ö
, **
decoded
, *
decoded_Àn
)

1236 
BIO
 *
bmem
, *
b64
;

1237 
¶í
;

1239 
¶í
 = 
	`°æí
(
ö
);

1241 
b64
 = 
	`BIO_√w
(
	`BIO_f_ba£64
());

1242 if(!
b64
){

1245 
	`BIO_£t_Êags
(
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

1247 
bmem
 = 
	`BIO_√w
(
	`BIO_s_mem
());

1248 if(!
bmem
){

1249 
	`BIO_‰ì_Æl
(
b64
);

1252 
b64
 = 
	`BIO_push
(b64, 
bmem
);

1253 
	`BIO_wrôe
(
bmem
, 
ö
, 
¶í
);

1255 if(
	`BIO_Êush
(
bmem
) != 1){

1256 
	`BIO_‰ì_Æl
(
b64
);

1259 *
decoded
 = 
	`mosquôto__ˇŒoc
(
¶í
, 1);

1260 if(!(*
decoded
)){

1261 
	`BIO_‰ì_Æl
(
b64
);

1264 *
decoded_Àn
 = 
	`BIO_ªad
(
b64
, *
decoded
, 
¶í
);

1265 
	`BIO_‰ì_Æl
(
b64
);

1267 if(*
decoded_Àn
 <= 0){

1268 
	`mosquôto__‰ì
(*
decoded
);

1269 *
decoded
 = 
NULL
;

1270 *
decoded_Àn
 = 0;

1275 
	}
}

	@src/send_auth.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto_brokî_öã∫Æ.h
"

20 
	~"mqâ_¥Ÿocﬁ.h
"

21 
	~"mem‹y_mosq.h
"

22 
	~"∑ckë_mosq.h
"

23 
	~"¥›îty_mosq.h
"

24 
	~"utû_mosq.h
"

26 
	$£nd__auth
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ªas⁄_code
, c⁄° *
auth_d©a
, 
uöt16_t
 
auth_d©a_Àn
)

28 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

29 
rc
;

30 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

31 
¥›Àn
, 
v¨byãs
;

32 
uöt32_t
 
ªmaöög_Àngth
;

34 if(
c⁄ãxt
->
auth_mëhod
 =
NULL
Ë 
MOSQ_ERR_INVAL
;

35 if(
c⁄ãxt
->
¥Ÿocﬁ
 !
mosq_p_mqâ5
Ë 
MOSQ_ERR_PROTOCOL
;

37 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög AUTHÅÿ%†‘c%d, %s)", 
c⁄ãxt
->
id
, 
ªas⁄_code
, c⁄ãxt->
auth_mëhod
);

39 
ªmaöög_Àngth
 = 1;

41 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_METHOD
, 
c⁄ãxt
->
auth_mëhod
);

42 if(
rc
){

43 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

44  
rc
;

47 if(
auth_d©a
 !
NULL
 && 
auth_d©a_Àn
 > 0){

48 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›îtõs
, 
MQTT_PROP_AUTHENTICATION_DATA
, 
auth_d©a
, 
auth_d©a_Àn
);

49 if(
rc
){

50 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

51  
rc
;

55 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

56 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

57 
ªmaöög_Àngth
 +
¥›Àn
 + 
v¨byãs
;

59 if(
	`∑ckë__check_ovîsize
(
c⁄ãxt
, 
ªmaöög_Àngth
)){

60 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

61 
	`mosquôto__‰ì
(
∑ckë
);

62  
MOSQ_ERR_OVERSIZE_PACKET
;

65 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

66 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

68 
∑ckë
->
comm™d
 = 
CMD_AUTH
;

69 
∑ckë
->
ªmaöög_Àngth
 =Ñemaining_length;

71 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

72 if(
rc
){

73 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

74 
	`mosquôto__‰ì
(
∑ckë
);

75  
rc
;

77 
	`∑ckë__wrôe_byã
(
∑ckë
, 
ªas⁄_code
);

78 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

79 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

81  
	`∑ckë__queue
(
c⁄ãxt
, 
∑ckë
);

82 
	}
}

	@src/send_connack.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto_brokî_öã∫Æ.h
"

20 
	~"mqâ_¥Ÿocﬁ.h
"

21 
	~"mem‹y_mosq.h
"

22 
	~"∑ckë_mosq.h
"

23 
	~"¥›îty_mosq.h
"

24 
	~"utû_mosq.h
"

26 
	$£nd__c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
ack
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

28 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

29 
rc
;

30 
mosquôto_¥›îty
 *
c⁄«ck_¥›s
 = 
NULL
;

31 
¥›Àn
, 
v¨byãs
;

32 
uöt32_t
 
ªmaöög_Àngth
;

34 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
c⁄«ck_¥›s
, 
¥›îtõs
);

35 if(
rc
){

36  
rc
;

39 if(
c⁄ãxt
->
id
){

40 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög CONNACKÅÿ%†(%d, %d)", 
c⁄ãxt
->
id
, 
ack
, 
ªas⁄_code
);

42 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög CONNACKÅÿ%†(%d, %d)", 
c⁄ãxt
->
addªss
, 
ack
, 
ªas⁄_code
);

45 
ªmaöög_Àngth
 = 2;

47 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

48 if(
ªas⁄_code
 < 128 && 
db
->
c⁄fig
->
ªèö_avaûabÀ
 =
Ál£
){

49 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
c⁄«ck_¥›s
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

50 if(
rc
){

51 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

52  
rc
;

55 if(
db
->
c⁄fig
->
max_∑ckë_size
 > 0){

56 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
c⁄«ck_¥›s
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 
db
->
c⁄fig
->
max_∑ckë_size
);

57 if(
rc
){

58 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

59  
rc
;

63 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
c⁄«ck_¥›s
);

64 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

65 
ªmaöög_Àngth
 +
¥›Àn
 + 
v¨byãs
;

68 if(
	`∑ckë__check_ovîsize
(
c⁄ãxt
, 
ªmaöög_Àngth
)){

69 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

70 
	`mosquôto__‰ì
(
∑ckë
);

71  
MOSQ_ERR_OVERSIZE_PACKET
;

74 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

75 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

77 
∑ckë
->
comm™d
 = 
CMD_CONNACK
;

78 
∑ckë
->
ªmaöög_Àngth
 =Ñemaining_length;

80 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

81 if(
rc
){

82 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

83 
	`mosquôto__‰ì
(
∑ckë
);

84  
rc
;

86 
	`∑ckë__wrôe_byã
(
∑ckë
, 
ack
);

87 
	`∑ckë__wrôe_byã
(
∑ckë
, 
ªas⁄_code
);

88 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

89 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
c⁄«ck_¥›s
, 
åue
);

91 
	`mosquôto_¥›îty_‰ì_Æl
(&
c⁄«ck_¥›s
);

93  
	`∑ckë__queue
(
c⁄ãxt
, 
∑ckë
);

94 
	}
}

	@src/send_suback.c

17 
	~"c⁄fig.h
"

19 
	~"mosquôto_brokî_öã∫Æ.h
"

20 
	~"mqâ_¥Ÿocﬁ.h
"

21 
	~"mem‹y_mosq.h
"

22 
	~"∑ckë_mosq.h
"

23 
	~"¥›îty_mosq.h
"

24 
	~"utû_mosq.h
"

27 
	$£nd__suback
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
)

29 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

30 
rc
;

31 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

32 
¥›Àn
, 
v¨byãs
;

34 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög SUBACKÅÿ%s", 
c⁄ãxt
->
id
);

36 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

37 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

39 
∑ckë
->
comm™d
 = 
CMD_SUBACK
;

40 
∑ckë
->
ªmaöög_Àngth
 = 2+
∑ylﬂdÀn
;

41 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

42 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

43 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

44 
∑ckë
->
ªmaöög_Àngth
 +
¥›Àn
 + 
v¨byãs
;

46 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

47 if(
rc
){

48 
	`mosquôto__‰ì
(
∑ckë
);

49  
rc
;

51 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
mid
);

53 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

55 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

58 if(
∑ylﬂdÀn
){

59 
	`∑ckë__wrôe_byãs
(
∑ckë
, 
∑ylﬂd
, 
∑ylﬂdÀn
);

62  
	`∑ckë__queue
(
c⁄ãxt
, 
∑ckë
);

63 
	}
}

	@src/send_unsuback.c

17 
	~"c⁄fig.h
"

19 
	~<as£π.h
>

21 
	~"mosquôto_brokî_öã∫Æ.h
"

22 
	~"mqâ_¥Ÿocﬁ.h
"

23 
	~"mem‹y_mosq.h
"

24 
	~"∑ckë_mosq.h
"

25 
	~"¥›îty_mosq.h
"

28 
	$£nd__unsuback
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
ªas⁄_code_cou¡
, 
uöt8_t
 *
ªas⁄_codes
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

30 
mosquôto__∑ckë
 *
∑ckë
 = 
NULL
;

31 
rc
;

32 
¥›Àn
, 
v¨byãs
;

34 
	`as£π
(
mosq
);

35 
∑ckë
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__∑ckë
));

36 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

38 
∑ckë
->
comm™d
 = 
CMD_UNSUBACK
;

39 
∑ckë
->
ªmaöög_Àngth
 = 2;

41 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

42 
¥›Àn
 = 
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
);

43 
v¨byãs
 = 
	`∑ckë__v¨öt_byãs
(
¥›Àn
);

44 
∑ckë
->
ªmaöög_Àngth
 +
v¨byãs
 + 
¥›Àn
 + 
ªas⁄_code_cou¡
;

47 
rc
 = 
	`∑ckë__Æloc
(
∑ckë
);

48 if(
rc
){

49 
	`mosquôto__‰ì
(
∑ckë
);

50  
rc
;

53 
	`∑ckë__wrôe_uöt16
(
∑ckë
, 
mid
);

55 if(
mosq
->
¥Ÿocﬁ
 =
mosq_p_mqâ5
){

56 
	`¥›îty__wrôe_Æl
(
∑ckë
, 
¥›îtõs
, 
åue
);

57 
	`∑ckë__wrôe_byãs
(
∑ckë
, 
ªas⁄_codes
, 
ªas⁄_code_cou¡
);

60  
	`∑ckë__queue
(
mosq
, 
∑ckë
);

61 
	}
}

	@src/service.c

17 #i‡
deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

19 
	~"c⁄fig.h
"

21 
	~<wödows.h
>

23 
	~"mem‹y_mosq.h
"

25 
run
;

26 
SERVICE_STATUS_HANDLE
 
	g£rvi˚_h™dÀ
 = 0;

27 
SERVICE_STATUS
 
	g£rvi˚_°©us
;

28 
maö
(
¨gc
, *
¨gv
[]);

30 
	$¥öt_îr‹
()

32 *
buf
;

34 
	`F‹m©Mesßge
(
FORMAT_MESSAGE_ALLOCATE_BUFFER
 | 
FORMAT_MESSAGE_FROM_SYSTEM
,

35 
NULL
, 
	`GëLa°Eº‹
(), 
LANG_NEUTRAL
, &
buf
, 0, NULL);

37 
	`Ârötf
(
°dîr
, "Eº‹: %s\n", 
buf
);

38 
	`LoˇlFªe
(
buf
);

39 
	}
}

43 
__°dˇŒ
 
	$£rvi˚_h™dÀr
(
DWORD
 
fdwC⁄åﬁ
)

45 
fdwC⁄åﬁ
){

46 
SERVICE_CONTROL_CONTINUE
:

49 
SERVICE_CONTROL_PAUSE
:

52 
SERVICE_CONTROL_SHUTDOWN
:

54 
SERVICE_CONTROL_STOP
:

56 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOP_PENDING
;

57 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

58 
run
 = 0;

61 
	}
}

64 
__°dˇŒ
 
	$£rvi˚_maö
(
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
)

66 **
¨gv
;

67 
¨gc
 = 1;

68 
c⁄f_∑th
[
MAX_PATH
 + 20];

69 
rc
;

71 
£rvi˚_h™dÀ
 = 
	`Regi°îSîvi˚CålH™dÀr
("mosquôto", 
£rvi˚_h™dÀr
);

72 if(
£rvi˚_h™dÀ
){

73 
	`mem£t
(
c⁄f_∑th
, 0, 
MAX_PATH
 + 20);

74 
rc
 = 
	`GëEnvú⁄mítV¨übÀ
("MOSQUITTO_DIR", 
c⁄f_∑th
, 
MAX_PATH
);

75 if(!
rc
 ||Ñ¯=
MAX_PATH
){

76 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOPPED
;

77 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

80 
	`°rˇt
(
c⁄f_∑th
, "/mosquitto.conf");

82 
¨gv
 = 
	`mosquôto__mÆloc
((*)*3);

83 
¨gv
[0] = "mosquitto";

84 
¨gv
[1] = "-c";

85 
¨gv
[2] = 
c⁄f_∑th
;

86 
¨gc
 = 3;

88 
£rvi˚_°©us
.
dwSîvi˚Ty≥
 = 
SERVICE_WIN32_OWN_PROCESS
;

89 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_RUNNING
;

90 
£rvi˚_°©us
.
dwC⁄åﬁsAc˚±ed
 = 
SERVICE_ACCEPT_SHUTDOWN
 | 
SERVICE_ACCEPT_STOP
;

91 
£rvi˚_°©us
.
dwWö32ExôCode
 = 
NO_ERROR
;

92 
£rvi˚_°©us
.
dwCheckPoöt
 = 0;

93 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

95 
	`maö
(
¨gc
, 
¨gv
);

96 
	`mosquôto__‰ì
(
¨gv
);

98 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOPPED
;

99 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

101 
	}
}

103 
	$£rvi˚_ö°Æl
()

105 
SC_HANDLE
 
sc_m™agî
, 
svc_h™dÀ
;

106 
exe_∑th
[
MAX_PATH
 + 5];

107 
SERVICE_DESCRIPTION
 
svc_desc
;

109 
	`mem£t
(
exe_∑th
, 0, 
MAX_PATH
+5);

110 if(
	`GëModuÀFûeName
(
NULL
, 
exe_∑th
, 
MAX_PATH
) == MAX_PATH){

111 
	`Ârötf
(
°dîr
, "Error: PathÅooÜong.\n");

114 
	`°rˇt
(
exe_∑th
, "Ñun");

116 
sc_m™agî
 = 
	`O≥nSCM™agî
(
NULL
, NULL, 
SC_MANAGER_CREATE_SERVICE
);

117 if(
sc_m™agî
){

118 
svc_h™dÀ
 = 
	`Cª©eSîvi˚
(
sc_m™agî
, "mosquitto", "Mosquitto Broker",

119 
SERVICE_START
 | 
SERVICE_STOP
 | 
SERVICE_CHANGE_CONFIG
,

120 
SERVICE_WIN32_OWN_PROCESS
, 
SERVICE_AUTO_START
, 
SERVICE_ERROR_NORMAL
,

121 
exe_∑th
, 
NULL
, NULL, NULL, NULL, NULL);

123 if(
svc_h™dÀ
){

124 
svc_desc
.
ÕDes¸ùti⁄
 = "MQTT v3.1.1 broker";

125 
	`Ch™geSîvi˚C⁄fig2
(
svc_h™dÀ
, 
SERVICE_CONFIG_DESCRIPTION
, &
svc_desc
);

126 
	`Clo£Sîvi˚H™dÀ
(
svc_h™dÀ
);

128 
	`¥öt_îr‹
();

130 
	`Clo£Sîvi˚H™dÀ
(
sc_m™agî
);

132 
	`¥öt_îr‹
();

134 
	}
}

136 
	$£rvi˚_unö°Æl
()

138 
SC_HANDLE
 
sc_m™agî
, 
svc_h™dÀ
;

139 
SERVICE_STATUS
 
°©us
;

141 
sc_m™agî
 = 
	`O≥nSCM™agî
(
NULL
, 
SERVICES_ACTIVE_DATABASE
, 
SC_MANAGER_CONNECT
);

142 if(
sc_m™agî
){

143 
svc_h™dÀ
 = 
	`O≥nSîvi˚
(
sc_m™agî
, "mosquôto", 
SERVICE_QUERY_STATUS
 | 
DELETE
);

144 if(
svc_h™dÀ
){

145 if(
	`QuîySîvi˚Sètus
(
svc_h™dÀ
, &
°©us
)){

146 if(
°©us
.
dwCuºítSèã
 =
SERVICE_STOPPED
){

147 
	`DñëeSîvi˚
(
svc_h™dÀ
);

150 
	`Clo£Sîvi˚H™dÀ
(
svc_h™dÀ
);

152 
	`¥öt_îr‹
();

154 
	`Clo£Sîvi˚H™dÀ
(
sc_m™agî
);

156 
	`¥öt_îr‹
();

158 
	}
}

160 
	$£rvi˚_run
()

162 
SERVICE_TABLE_ENTRY
 
°e
[] = {

163 { "mosquôto", 
£rvi˚_maö
 },

164 { 
NULL
, NULL }

167 
	`SèπSîvi˚CålDi•©chî
(
°e
);

168 
	}
}

	@src/session_expiry.c

17 
	~"c⁄fig.h
"

19 
	~<m©h.h
>

20 
	~<°dio.h
>

21 
	~<uéi°.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"time_mosq.h
"

27 
£ssi⁄_expúy_li°
 *
	gexpúy_li°
 = 
NULL
;

28 
time_t
 
	gœ°_check
 = 0;

31 
	$£ssi⁄_expúy__cmp
(
£ssi⁄_expúy_li°
 *
i1
, £ssi⁄_expúy_li° *
i2
)

33  
i1
->
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 - 
i2
->context->session_expiry_interval;

34 
	}
}

37 
	$£ssi⁄_expúy__add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

39 
£ssi⁄_expúy_li°
 *
ôem
;

41 
ôem
 = 
	`mosquôto__ˇŒoc
(1, (
£ssi⁄_expúy_li°
));

42 if(!
ôem
Ë 
MOSQ_ERR_NOMEM
;

44 
ôem
->
c⁄ãxt
 = context;

45 
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_time
 = 
	`time
(
NULL
);

46 if(
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 == 0 ||

47 
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 < 
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
){

49 
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_time
 +ôem->c⁄ãxt->
£ssi⁄_expúy_öãrvÆ
;

51 
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_time
 +
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
;

53 
c⁄ãxt
->
expúy_li°_ôem
 = 
ôem
;

55 
	`DL_INSERT_INORDER
(
expúy_li°
, 
ôem
, 
£ssi⁄_expúy__cmp
);

57  
MOSQ_ERR_SUCCESS
;

58 
	}
}

61 
	$£ssi⁄_expúy__ªmove
(
mosquôto
 *
c⁄ãxt
)

63 if(
c⁄ãxt
->
expúy_li°_ôem
){

64 
	`DL_DELETE
(
expúy_li°
, 
c⁄ãxt
->
expúy_li°_ôem
);

65 
	`mosquôto__‰ì
(
c⁄ãxt
->
expúy_li°_ôem
);

66 
c⁄ãxt
->
expúy_li°_ôem
 = 
NULL
;

68 
	}
}

72 
	$£ssi⁄_expúy__ªmove_Æl
(
mosquôto_db
 *
db
)

74 
£ssi⁄_expúy_li°
 *
ôem
, *
tmp
;

75 
mosquôto
 *
c⁄ãxt
;

77 
	`DL_FOREACH_SAFE
(
expúy_li°
, 
ôem
, 
tmp
){

78 
c⁄ãxt
 = 
ôem
->context;

79 
	`£ssi⁄_expúy__ªmove
(
c⁄ãxt
);

80 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 0;

81 
c⁄ãxt
->
wûl_dñay_öãrvÆ
 = 0;

82 
	`wûl_dñay__ªmove
(
c⁄ãxt
);

83 
	`c⁄ãxt__disc⁄√˘
(
db
, 
c⁄ãxt
);

86 
	}
}

88 
	$£ssi⁄_expúy__check
(
mosquôto_db
 *
db
, 
time_t
 
now
)

90 
£ssi⁄_expúy_li°
 *
ôem
, *
tmp
;

91 
mosquôto
 *
c⁄ãxt
;

93 if(
now
 <
œ°_check
) ;

95 
œ°_check
 = 
now
;

97 
	`DL_FOREACH_SAFE
(
expúy_li°
, 
ôem
, 
tmp
){

98 if(
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 !
UINT32_MAX


99 && 
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_time
 < 
now
){

101 
c⁄ãxt
 = 
ôem
->context;

102 
	`£ssi⁄_expúy__ªmove
(
c⁄ãxt
);

105 
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 = 0;

107 
c⁄ãxt
->
wûl_dñay_öãrvÆ
 = 0;

108 
	`wûl_dñay__ªmove
(
c⁄ãxt
);

109 
	`c⁄ãxt__£nd_wûl
(
db
, 
c⁄ãxt
);

110 
	`c⁄ãxt__add_to_disu£d
(
db
, 
c⁄ãxt
);

116 
	}
}

	@src/signals.c

18 
	~"c⁄fig.h
"

20 #i‚de‡
WIN32


21 
	~<uni°d.h
>

22 
	~<gΩ.h
>

23 
	~<as£π.h
>

26 #i‚de‡
WIN32


27 
	~<pwd.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	~<ws2t˝ù.h
>

34 #i‚de‡
WIN32


35 
	~<sys/time.h
>

38 
	~<î∫o.h
>

39 
	~<sig«l.h
>

40 
	~<°dio.h
>

41 
	~<°rög.h
>

42 #ifde‡
WITH_SYSTEMD


43 
	~<sy°emd/sd-d´m⁄.h
>

45 #ifde‡
WITH_WRAP


46 
	~<t˝d.h
>

48 #ifde‡
WITH_WEBSOCKETS


49 
	~<libwebsockës.h
>

52 
	~"mosquôto_brokî_öã∫Æ.h
"

53 
	~"mem‹y_mosq.h
"

54 
	~"utû_mosq.h
"

56 
boﬁ
 
Êag_ªlﬂd
;

57 #ifde‡
WITH_PERSISTENCE


58 
boﬁ
 
Êag_db_backup
;

60 
boﬁ
 
Êag_åì_¥öt
;

61 
run
;

63 #ifde‡
SIGHUP


65 
	$h™dÀ_sighup
(
sig«l
)

67 
	`UNUSED
(
sig«l
);

69 
Êag_ªlﬂd
 = 
åue
;

70 
	}
}

74 
	$h™dÀ_sigöt
(
sig«l
)

76 
	`UNUSED
(
sig«l
);

78 
run
 = 0;

79 
	}
}

82 
	$h™dÀ_sigu§1
(
sig«l
)

84 
	`UNUSED
(
sig«l
);

86 #ifde‡
WITH_PERSISTENCE


87 
Êag_db_backup
 = 
åue
;

89 
	}
}

92 
	$h™dÀ_sigu§2
(
sig«l
)

94 
	`UNUSED
(
sig«l
);

96 
Êag_åì_¥öt
 = 
åue
;

97 
	}
}

112 #ifde‡
WIN32


113 
DWORD
 
WINAPI
 
	$SigThªadProc
(* 
d©a
)

115 
TCHAR
 
evt_«me
[
MAX_PATH
];

116 
HANDLE
 
evt
[3];

117 
pid
 = 
	`GëCuºítPro˚ssId
();

119 
	`•rötf_s
(
evt_«me
, 
MAX_PATH
, "mosq%d_shutdown", 
pid
);

120 
evt
[0] = 
	`Cª©eEvít
(
NULL
, 
TRUE
, 
FALSE
, 
evt_«me
);

121 
	`•rötf_s
(
evt_«me
, 
MAX_PATH
, "mosq%d_ªlﬂd", 
pid
);

122 
evt
[1] = 
	`Cª©eEvít
(
NULL
, 
FALSE
, FALSE, 
evt_«me
);

123 
	`•rötf_s
(
evt_«me
, 
MAX_PATH
, "mosq%d_backup", 
pid
);

124 
evt
[2] = 
	`Cª©eEvít
(
NULL
, 
FALSE
, FALSE, 
evt_«me
);

126 
åue
) {

127 
wr
 = 
	`WaôF‹Mu…ùÀObje˘s
((
evt
Ë/ (
HANDLE
),Évt, 
FALSE
, 
INFINITE
);

128 
wr
) {

129 
WAIT_OBJECT_0
 + 0:

130 
	`h™dÀ_sigöt
(
SIGINT
);

132 
WAIT_OBJECT_0
 + 1:

133 
Êag_ªlﬂd
 = 
åue
;

135 
WAIT_OBJECT_0
 + 2:

136 
	`h™dÀ_sigu§1
(0);

141 
	`Clo£H™dÀ
(
evt
[0]);

142 
	`Clo£H™dÀ
(
evt
[1]);

143 
	`Clo£H™dÀ
(
evt
[2]);

145 
	}
}

	@src/subs.c

48 
	~"c⁄fig.h
"

50 
	~<as£π.h
>

51 
	~<°dio.h
>

52 
	~<°rög.h
>

54 
	~"mosquôto_brokî_öã∫Æ.h
"

55 
	~"mem‹y_mosq.h
"

56 
	~"mqâ_¥Ÿocﬁ.h
"

57 
	~"utû_mosq.h
"

59 
	~"uéi°.h
"

61 
	ssub__tokí
 {

62 
sub__tokí
 *
	m√xt
;

63 *
	mt›ic
;

64 
uöt16_t
 
	mt›ic_Àn
;

68 
	$subs__£nd
(
mosquôto_db
 *
db
, 
mosquôto__subÀaf
 *
Àaf
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
)

70 
boﬁ
 
˛õ¡_ªèö
;

71 
uöt16_t
 
mid
;

72 
˛õ¡_qos
, 
msg_qos
;

73 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

74 
rc2
;

77 
rc2
 = 
	`mosquôto_a˛_check
(
db
, 
Àaf
->
c⁄ãxt
, 
t›ic
, 
°‹ed
->
∑ylﬂdÀn
, 
	`UHPA_ACCESS
(°‹ed->
∑ylﬂd
, st‹ed->∑ylﬂdÀn), st‹ed->
qos
, st‹ed->
ªèö
, 
MOSQ_ACL_READ
);

78 if(
rc2
 =
MOSQ_ERR_ACL_DENIED
){

79  
MOSQ_ERR_SUCCESS
;

80 }if(
rc2
 =
MOSQ_ERR_SUCCESS
){

81 
˛õ¡_qos
 = 
Àaf
->
qos
;

83 if(
db
->
c⁄fig
->
upgøde_outgoög_qos
){

84 
msg_qos
 = 
˛õ¡_qos
;

86 if(
qos
 > 
˛õ¡_qos
){

87 
msg_qos
 = 
˛õ¡_qos
;

89 
msg_qos
 = 
qos
;

92 if(
msg_qos
){

93 
mid
 = 
	`mosquôto__mid_gíî©e
(
Àaf
->
c⁄ãxt
);

95 
mid
 = 0;

97 if(
Àaf
->
ªèö_as_published
){

98 
˛õ¡_ªèö
 = 
ªèö
;

100 
˛õ¡_ªèö
 = 
Ál£
;

102 if(
Àaf
->
idítifõr
){

103 
	`mosquôto_¥›îty_add_v¨öt
(&
¥›îtõs
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 
Àaf
->
idítifõr
);

105 if(
	`db__mesßge_ö£π
(
db
, 
Àaf
->
c⁄ãxt
, 
mid
, 
mosq_md_out
, 
msg_qos
, 
˛õ¡_ªèö
, 
°‹ed
, 
¥›îtõs
) == 1){

112 
	}
}

115 
	$subs__sh¨ed_¥o˚ss
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 *
hõr
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
)

117 
rc
 = 0, 
rc2
;

118 
mosquôto__subsh¨ed
 *
sh¨ed
, *
sh¨ed_tmp
;

119 
mosquôto__subÀaf
 *
Àaf
;

121 
	`HASH_ITER
(
hh
, 
hõr
->
sh¨ed
, sh¨ed, 
sh¨ed_tmp
){

122 
Àaf
 = 
sh¨ed
->
subs
;

123 
rc2
 = 
	`subs__£nd
(
db
, 
Àaf
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
);

125 
	`DL_DELETE
(
sh¨ed
->
subs
, 
Àaf
);

126 
	`DL_APPEND
(
sh¨ed
->
subs
, 
Àaf
);

128 if(
rc2
Ë
rc
 = 1;

131  
rc
;

132 
	}
}

134 
	$subs__¥o˚ss
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 *
hõr
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
boﬁ
 
£t_ªèö
)

136 
rc
 = 0;

137 
rc2
;

138 
mosquôto__subÀaf
 *
Àaf
;

140 if(
ªèö
 && 
£t_ªèö
){

141 #ifde‡
WITH_PERSISTENCE


142 if(
	`°∫cmp
(
t›ic
, "$SYS", 4)){

145 
db
->
≥rsi°í˚_ch™ges
++;

148 if(
hõr
->
ªèöed
){

149 
	`db__msg_°‹e_ªf_dec
(
db
, &
hõr
->
ªèöed
);

150 #ifde‡
WITH_SYS_TREE


151 
db
->
ªèöed_cou¡
--;

154 if(
°‹ed
->
∑ylﬂdÀn
){

155 
hõr
->
ªèöed
 = 
°‹ed
;

156 
	`db__msg_°‹e_ªf_öc
(
hõr
->
ªèöed
);

157 #ifde‡
WITH_SYS_TREE


158 
db
->
ªèöed_cou¡
++;

161 
hõr
->
ªèöed
 = 
NULL
;

165 
rc
 = 
	`subs__sh¨ed_¥o˚ss
(
db
, 
hõr
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
);

167 
Àaf
 = 
hõr
->
subs
;

168 
sour˚_id
 && 
Àaf
){

169 if(!
Àaf
->
c⁄ãxt
->
id
 || (Àaf->
no_loˇl
 && !
	`°rcmp
÷óf->c⁄ãxt->id, 
sour˚_id
))){

170 
Àaf
 =Üóf->
√xt
;

173 
rc2
 = 
	`subs__£nd
(
db
, 
Àaf
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
);

174 if(
rc2
){

175 
rc
 = 1;

177 
Àaf
 =Üóf->
√xt
;

179 if(
hõr
->
subs
 || hõr->
sh¨ed
){

180  
rc
;

182  
MOSQ_ERR_NO_SUBSCRIBERS
;

184 
	}
}

186 
sub__tokí
 *
	$sub__t›ic_≠≥nd
(
sub__tokí
 **
èû
, sub__tokí **
t›ics
, *
t›ic
)

188 
sub__tokí
 *
√w_t›ic
;

190 if(!
t›ic
){

191  
NULL
;

193 
√w_t›ic
 = 
	`mosquôto__mÆloc
((
sub__tokí
));

194 if(!
√w_t›ic
){

195  
NULL
;

197 
√w_t›ic
->
√xt
 = 
NULL
;

198 
√w_t›ic
->
t›ic_Àn
 = 
	`°æí
(
t›ic
);

199 
√w_t›ic
->
t›ic
 = 
	`mosquôto__mÆloc
“ew_t›ic->
t›ic_Àn
+1);

200 if(!
√w_t›ic
->
t›ic
){

201 
	`mosquôto__‰ì
(
√w_t›ic
);

202  
NULL
;

204 
	`°∫˝y
(
√w_t›ic
->
t›ic
,Å›ic,Çew_t›ic->
t›ic_Àn
+1);

206 if(*
èû
){

207 (*
èû
)->
√xt
 = 
√w_t›ic
;

208 *
èû
 = (*èû)->
√xt
;

210 *
t›ics
 = 
√w_t›ic
;

211 *
èû
 = 
√w_t›ic
;

213  
√w_t›ic
;

214 
	}
}

216 
	$sub__t›ic_tokíi£
(c⁄° *
subt›ic
, 
sub__tokí
 **
t›ics
)

218 
sub__tokí
 *
√w_t›ic
, *
èû
 = 
NULL
;

219 
Àn
;

220 
°¨t
, 
°›
, 
éí
;

221 
i
;

222 *
t›ic
;

223 
cou¡
 = 0;

225 
	`as£π
(
subt›ic
);

226 
	`as£π
(
t›ics
);

228 if(
subt›ic
[0] != '$'){

229 
√w_t›ic
 = 
	`sub__t›ic_≠≥nd
(&
èû
, 
t›ics
, "");

230 if(!
√w_t›ic
Ë
˛ónup
;

233 
Àn
 = 
	`°æí
(
subt›ic
);

235 if(
subt›ic
[0] == '/'){

236 
√w_t›ic
 = 
	`sub__t›ic_≠≥nd
(&
èû
, 
t›ics
, "");

237 if(!
√w_t›ic
Ë
˛ónup
;

239 
°¨t
 = 1;

241 
°¨t
 = 0;

244 
°›
 = 0;

245 
i
=
°¨t
; i<
Àn
+1; i++){

246 
cou¡
++;

247 if(
subt›ic
[
i
] == '/' || subtopic[i] == '\0'){

248 
°›
 = 
i
;

250 if(
°¨t
 !
°›
){

251 
éí
 = 
°›
-
°¨t
;

253 
t›ic
 = 
	`mosquôto__mÆloc
(
éí
+1);

254 if(!
t›ic
Ë
˛ónup
;

255 
	`mem˝y
(
t›ic
, &
subt›ic
[
°¨t
], 
éí
);

256 
t›ic
[
éí
] = '\0';

257 
√w_t›ic
 = 
	`sub__t›ic_≠≥nd
(&
èû
, 
t›ics
, 
t›ic
);

258 
	`mosquôto__‰ì
(
t›ic
);

260 
√w_t›ic
 = 
	`sub__t›ic_≠≥nd
(&
èû
, 
t›ics
, "");

262 if(!
√w_t›ic
Ë
˛ónup
;

263 
°¨t
 = 
i
+1;

267 if(
cou¡
 > 
TOPIC_HIERARCHY_LIMIT
){

269 
˛ónup
;

272  
MOSQ_ERR_SUCCESS
;

274 
˛ónup
:

275 
èû
 = *
t›ics
;

276 *
t›ics
 = 
NULL
;

277 
èû
){

278 
	`mosquôto__‰ì
(
èû
->
t›ic
);

279 
√w_t›ic
 = 
èû
->
√xt
;

280 
	`mosquôto__‰ì
(
èû
);

281 
èû
 = 
√w_t›ic
;

284 
	}
}

286 
	$sub__t›ic_tokís_‰ì
(
sub__tokí
 *
tokís
)

288 
sub__tokí
 *
èû
;

290 
tokís
){

291 
èû
 = 
tokís
->
√xt
;

292 
	`mosquôto__‰ì
(
tokís
->
t›ic
);

293 
	`mosquôto__‰ì
(
tokís
);

294 
tokís
 = 
èû
;

296 
	}
}

299 
	$sub__add_Àaf
(
mosquôto
 *
c⁄ãxt
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subÀaf
 **
hód
, mosquôto__subÀa‡**
√wÀaf
)

301 
mosquôto__subÀaf
 *
Àaf
;

303 *
√wÀaf
 = 
NULL
;

304 
Àaf
 = *
hód
;

306 
Àaf
){

307 if(
Àaf
->
c⁄ãxt
 &&Üóf->c⁄ãxt->
id
 && !
	`°rcmp
(leaf->context->id, context->id)){

311 
Àaf
->
qos
 = qos;

312 
Àaf
->
idítifõr
 = identifier;

313  
MOSQ_ERR_SUB_EXISTS
;

315 
Àaf
 =Üóf->
√xt
;

317 
Àaf
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__subÀaf
));

318 if(!
Àaf
Ë 
MOSQ_ERR_NOMEM
;

319 
Àaf
->
c⁄ãxt
 = context;

320 
Àaf
->
qos
 = qos;

321 
Àaf
->
idítifõr
 = identifier;

322 
Àaf
->
no_loˇl
 = ((
›ti⁄s
 & 
MQTT_SUB_OPT_NO_LOCAL
) != 0);

323 
Àaf
->
ªèö_as_published
 = ((
›ti⁄s
 & 
MQTT_SUB_OPT_RETAIN_AS_PUBLISHED
) != 0);

325 
	`DL_APPEND
(*
hód
, 
Àaf
);

326 *
√wÀaf
 = 
Àaf
;

328  
MOSQ_ERR_SUCCESS
;

329 
	}
}

332 
	$sub__ªmove_sh¨ed_Àaf
(
mosquôto__subhõr
 *
subhõr
, 
mosquôto__subsh¨ed
 *
sh¨ed
, 
mosquôto__subÀaf
 *
Àaf
)

334 
	`DL_DELETE
(
sh¨ed
->
subs
, 
Àaf
);

335 if(
sh¨ed
->
subs
 =
NULL
){

336 
	`HASH_DELETE
(
hh
, 
subhõr
->
sh¨ed
, shared);

337 
	`mosquôto__‰ì
(
sh¨ed
->
«me
);

338 
	`mosquôto__‰ì
(
sh¨ed
);

340 
	`mosquôto__‰ì
(
Àaf
);

341 
	}
}

344 
	$sub__add_sh¨ed
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 *
subhõr
, *
sh¨íame
)

346 
mosquôto__subÀaf
 *
√wÀaf
;

347 
mosquôto__subsh¨ed
 *
sh¨ed
 = 
NULL
;

348 
mosquôto__subsh¨ed_ªf
 **
sh¨ed_subs
;

349 
mosquôto__subsh¨ed_ªf
 *
sh¨ed_ªf
;

350 
i
;

351 
¶í
;

352 
rc
;

354 
¶í
 = 
	`°æí
(
sh¨íame
);

356 
	`HASH_FIND
(
hh
, 
subhõr
->
sh¨ed
, 
sh¨íame
, 
¶í
, shared);

357 if(
sh¨ed
){

358 
	`mosquôto__‰ì
(
sh¨íame
);

360 
sh¨ed
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__subsh¨ed
));

361 if(!
sh¨ed
){

362 
	`mosquôto__‰ì
(
sh¨íame
);

363  
MOSQ_ERR_NOMEM
;

365 
sh¨ed
->
«me
 = 
sh¨íame
;

367 
	`HASH_ADD_KEYPTR
(
hh
, 
subhõr
->
sh¨ed
, sh¨ed->
«me
, 
¶í
, shared);

370 
rc
 = 
	`sub__add_Àaf
(
c⁄ãxt
, 
qos
, 
idítifõr
, 
›ti⁄s
, &
sh¨ed
->
subs
, &
√wÀaf
);

371 if(
rc
 > 0){

372 if(
sh¨ed
->
subs
 =
NULL
){

373 
	`HASH_DELETE
(
hh
, 
subhõr
->
sh¨ed
, shared);

374 
	`mosquôto__‰ì
(
sh¨ed
->
«me
);

375 
	`mosquôto__‰ì
(
sh¨ed
);

377  
rc
;

380 if(
rc
 !
MOSQ_ERR_SUB_EXISTS
){

381 
sh¨ed_ªf
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__subsh¨ed_ªf
));

382 if(!
sh¨ed_ªf
){

383 
	`sub__ªmove_sh¨ed_Àaf
(
subhõr
, 
sh¨ed
, 
√wÀaf
);

384  
MOSQ_ERR_NOMEM
;

386 
sh¨ed_ªf
->
hõr
 = 
subhõr
;

387 
sh¨ed_ªf
->
sh¨ed
 = shared;

389 
i
=0; i<
c⁄ãxt
->
sh¨ed_sub_cou¡
; i++){

390 if(!
c⁄ãxt
->
sh¨ed_subs
[
i
]){

391 
c⁄ãxt
->
sh¨ed_subs
[
i
] = 
sh¨ed_ªf
;

395 if(
i
 =
c⁄ãxt
->
sh¨ed_sub_cou¡
){

396 
sh¨ed_subs
 = 
	`mosquôto__ªÆloc
(
c⁄ãxt
->sh¨ed_subs, (
mosquôto__subhõr_ªf
 *)*(c⁄ãxt->
sh¨ed_sub_cou¡
 + 1));

397 if(!
sh¨ed_subs
){

398 
	`sub__ªmove_sh¨ed_Àaf
(
subhõr
, 
sh¨ed
, 
√wÀaf
);

399  
MOSQ_ERR_NOMEM
;

401 
c⁄ãxt
->
sh¨ed_subs
 = shared_subs;

402 
c⁄ãxt
->
sh¨ed_sub_cou¡
++;

403 
c⁄ãxt
->
sh¨ed_subs
[c⁄ãxt->
sh¨ed_sub_cou¡
-1] = 
sh¨ed_ªf
;

405 #ifde‡
WITH_SYS_TREE


406 
db
->
sh¨ed_subs¸ùti⁄_cou¡
++;

410 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

411  
rc
;

415  
MOSQ_ERR_SUCCESS
;

417 
	}
}

420 
	$sub__add_n‹mÆ
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 *
subhõr
)

422 
mosquôto__subÀaf
 *
√wÀaf
 = 
NULL
;

423 
mosquôto__subhõr
 **
subs
;

424 
i
;

425 
rc
;

427 
rc
 = 
	`sub__add_Àaf
(
c⁄ãxt
, 
qos
, 
idítifõr
, 
›ti⁄s
, &
subhõr
->
subs
, &
√wÀaf
);

428 if(
rc
 > 0){

429  
rc
;

432 if(
rc
 !
MOSQ_ERR_SUB_EXISTS
){

433 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

434 if(!
c⁄ãxt
->
subs
[
i
]){

435 
c⁄ãxt
->
subs
[
i
] = 
subhõr
;

439 if(
i
 =
c⁄ãxt
->
sub_cou¡
){

440 
subs
 = 
	`mosquôto__ªÆloc
(
c⁄ãxt
->subs, (
mosquôto__subhõr
 *)*(c⁄ãxt->
sub_cou¡
 + 1));

441 if(!
subs
){

442 
	`DL_DELETE
(
subhõr
->
subs
, 
√wÀaf
);

443 
	`mosquôto__‰ì
(
√wÀaf
);

444  
MOSQ_ERR_NOMEM
;

446 
c⁄ãxt
->
subs
 = subs;

447 
c⁄ãxt
->
sub_cou¡
++;

448 
c⁄ãxt
->
subs
[c⁄ãxt->
sub_cou¡
-1] = 
subhõr
;

450 #ifde‡
WITH_SYS_TREE


451 
db
->
subs¸ùti⁄_cou¡
++;

455 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
 || c⁄ãxt->¥Ÿocﬁ =
mosq_p_mqâ5
){

456  
rc
;

460  
MOSQ_ERR_SUCCESS
;

462 
	}
}

465 
	$sub__add_c⁄ãxt
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 *
subhõr
, 
sub__tokí
 *
tokís
, *
sh¨íame
)

467 
mosquôto__subhõr
 *
bønch
;

470 
tokís
){

471 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
bønch
);

472 if(!
bønch
){

474 
bønch
 = 
	`sub__add_hõr_íåy
(
subhõr
, &subhõr->
chûdªn
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
);

475 if(!
bønch
Ë 
MOSQ_ERR_NOMEM
;

477 
subhõr
 = 
bønch
;

478 
tokís
 =Åokí†->
√xt
;

482 if(
c⁄ãxt
 && c⁄ãxt->
id
){

483 if(
sh¨íame
){

484  
	`sub__add_sh¨ed
(
db
, 
c⁄ãxt
, 
qos
, 
idítifõr
, 
›ti⁄s
, 
subhõr
, 
sh¨íame
);

486  
	`sub__add_n‹mÆ
(
db
, 
c⁄ãxt
, 
qos
, 
idítifõr
, 
›ti⁄s
, 
subhõr
);

489  
MOSQ_ERR_SUCCESS
;

491 
	}
}

494 
	$sub__ªmove_n‹mÆ
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto__subhõr
 *
subhõr
, 
uöt8_t
 *
ªas⁄
)

496 
mosquôto__subÀaf
 *
Àaf
;

497 
i
;

499 
Àaf
 = 
subhõr
->
subs
;

500 
Àaf
){

501 if(
Àaf
->
c⁄ãxt
==context){

502 #ifde‡
WITH_SYS_TREE


503 
db
->
subs¸ùti⁄_cou¡
--;

505 
	`DL_DELETE
(
subhõr
->
subs
, 
Àaf
);

506 
	`mosquôto__‰ì
(
Àaf
);

512 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

513 if(
c⁄ãxt
->
subs
[
i
] =
subhõr
){

514 
c⁄ãxt
->
subs
[
i
] = 
NULL
;

518 *
ªas⁄
 = 0;

519  
MOSQ_ERR_SUCCESS
;

521 
Àaf
 =Üóf->
√xt
;

523  
MOSQ_ERR_NO_SUBSCRIBERS
;

524 
	}
}

527 
	$sub__ªmove_sh¨ed
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto__subhõr
 *
subhõr
, 
uöt8_t
 *
ªas⁄
, *
sh¨íame
)

529 
mosquôto__subsh¨ed
 *
sh¨ed
;

530 
mosquôto__subÀaf
 *
Àaf
;

531 
i
;

533 
	`HASH_FIND
(
hh
, 
subhõr
->
sh¨ed
, 
sh¨íame
, 
	`°æí
(sharename), shared);

534 
	`mosquôto__‰ì
(
sh¨íame
);

535 if(
sh¨ed
){

536 
Àaf
 = 
sh¨ed
->
subs
;

537 
Àaf
){

538 if(
Àaf
->
c⁄ãxt
==context){

539 #ifde‡
WITH_SYS_TREE


540 
db
->
sh¨ed_subs¸ùti⁄_cou¡
--;

542 
	`DL_DELETE
(
sh¨ed
->
subs
, 
Àaf
);

543 
	`mosquôto__‰ì
(
Àaf
);

549 
i
=0; i<
c⁄ãxt
->
sh¨ed_sub_cou¡
; i++){

550 if(
c⁄ãxt
->
sh¨ed_subs
[
i
]

551 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
 =
subhõr


552 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
sh¨ed
 == shared){

554 
	`mosquôto__‰ì
(
c⁄ãxt
->
sh¨ed_subs
[
i
]);

555 
c⁄ãxt
->
sh¨ed_subs
[
i
] = 
NULL
;

560 if(
sh¨ed
->
subs
 =
NULL
){

561 
	`HASH_DELETE
(
hh
, 
subhõr
->
sh¨ed
, shared);

562 
	`mosquôto__‰ì
(
sh¨ed
->
«me
);

563 
	`mosquôto__‰ì
(
sh¨ed
);

566 *
ªas⁄
 = 0;

567  
MOSQ_ERR_SUCCESS
;

569 
Àaf
 =Üóf->
√xt
;

571  
MOSQ_ERR_NO_SUBSCRIBERS
;

573  
MOSQ_ERR_NO_SUBSCRIBERS
;

575 
	}
}

578 
	$sub__ªmove_ªcur£
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto__subhõr
 *
subhõr
, 
sub__tokí
 *
tokís
, 
uöt8_t
 *
ªas⁄
, *
sh¨íame
)

580 
mosquôto__subhõr
 *
bønch
;

582 if(!
tokís
){

583 if(
sh¨íame
){

584  
	`sub__ªmove_sh¨ed
(
db
, 
c⁄ãxt
, 
subhõr
, 
ªas⁄
, 
sh¨íame
);

586  
	`sub__ªmove_n‹mÆ
(
db
, 
c⁄ãxt
, 
subhõr
, 
ªas⁄
);

590 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
bønch
);

591 if(
bønch
){

592 
	`sub__ªmove_ªcur£
(
db
, 
c⁄ãxt
, 
bønch
, 
tokís
->
√xt
, 
ªas⁄
, 
sh¨íame
);

593 if(!
bønch
->
chûdªn
 && !bønch->
subs
 && !bønch->
ªèöed
 && !bønch->
sh¨ed
){

594 
	`HASH_DELETE
(
hh
, 
subhõr
->
chûdªn
, 
bønch
);

595 
	`mosquôto__‰ì
(
bønch
->
t›ic
);

596 
	`mosquôto__‰ì
(
bønch
);

599  
MOSQ_ERR_SUCCESS
;

600 
	}
}

602 
	$sub__£¨ch
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 *
subhõr
, 
sub__tokí
 *
tokís
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
boﬁ
 
£t_ªèö
)

605 
mosquôto__subhõr
 *
bønch
;

606 
rc
;

607 
boﬁ
 
have_subs¸ibîs
 = 
Ál£
;

609 if(
tokís
){

611 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
bønch
);

613 if(
bønch
){

614 
rc
 = 
	`sub__£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
£t_ªèö
);

615 if(
rc
 =
MOSQ_ERR_SUCCESS
){

616 
have_subs¸ibîs
 = 
åue
;

617 }if(
rc
 !
MOSQ_ERR_NO_SUBSCRIBERS
){

618  
rc
;

620 if(!
tokís
->
√xt
){

621 
rc
 = 
	`subs__¥o˚ss
(
db
, 
bønch
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
£t_ªèö
);

622 if(
rc
 =
MOSQ_ERR_SUCCESS
){

623 
have_subs¸ibîs
 = 
åue
;

624 }if(
rc
 !
MOSQ_ERR_NO_SUBSCRIBERS
){

625  
rc
;

631 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, "+", 1, 
bønch
);

633 if(
bønch
){

634 
rc
 = 
	`sub__£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
Ál£
);

635 if(
rc
 =
MOSQ_ERR_SUCCESS
){

636 
have_subs¸ibîs
 = 
åue
;

637 }if(
rc
 !
MOSQ_ERR_NO_SUBSCRIBERS
){

638  
rc
;

640 if(!
tokís
->
√xt
){

641 
rc
 = 
	`subs__¥o˚ss
(
db
, 
bønch
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
Ál£
);

642 if(
rc
 =
MOSQ_ERR_SUCCESS
){

643 
have_subs¸ibîs
 = 
åue
;

644 }if(
rc
 !
MOSQ_ERR_NO_SUBSCRIBERS
){

645  
rc
;

652 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, "#", 1, 
bønch
);

653 if(
bønch
 && !bønch->
chûdªn
){

658 
rc
 = 
	`subs__¥o˚ss
(
db
, 
bønch
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
Ál£
);

659 if(
rc
 =
MOSQ_ERR_SUCCESS
){

660 
have_subs¸ibîs
 = 
åue
;

661 }if(
rc
 !
MOSQ_ERR_NO_SUBSCRIBERS
){

662  
rc
;

666 if(
have_subs¸ibîs
){

667  
MOSQ_ERR_SUCCESS
;

669  
MOSQ_ERR_NO_SUBSCRIBERS
;

671 
	}
}

674 
mosquôto__subhõr
 *
	$sub__add_hõr_íåy
(
mosquôto__subhõr
 *
∑ª¡
, mosquôto__subhõ∏**
siblög
, c⁄° *
t›ic
, 
size_t
 
Àn
)

676 
mosquôto__subhõr
 *
chûd
;

678 
	`as£π
(
siblög
);

680 
chûd
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto__subhõr
));

681 if(!
chûd
){

682 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

683  
NULL
;

685 
chûd
->
∑ª¡
 =Öarent;

686 
chûd
->
t›ic_Àn
 = 
Àn
;

687 
chûd
->
t›ic
 = 
	`mÆloc
(
Àn
+1);

688 if(!
chûd
->
t›ic
){

689 
chûd
->
t›ic_Àn
 = 0;

690 
	`mosquôto__‰ì
(
chûd
);

691 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

692  
NULL
;

694 
	`°∫˝y
(
chûd
->
t›ic
,Å›ic, chûd->
t›ic_Àn
+1);

697 
	`HASH_ADD_KEYPTR
(
hh
, *
siblög
, 
chûd
->
t›ic
, chûd->
t›ic_Àn
, child);

699  
chûd
;

700 
	}
}

703 
	$sub__add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 **
roŸ
)

705 
rc
 = 0;

706 
mosquôto__subhõr
 *
subhõr
;

707 
sub__tokí
 *
tokís
 = 
NULL
, *
t
;

708 *
sh¨íame
 = 
NULL
;

710 
	`as£π
(
roŸ
);

711 
	`as£π
(*
roŸ
);

712 
	`as£π
(
sub
);

714 if(
	`sub__t›ic_tokíi£
(
sub
, &
tokís
))  1;

716 if(!
	`°rcmp
(
tokís
->
t›ic
, "$share")){

717 if(!
tokís
->
√xt
 || !tokens->next->next){

718 
	`sub__t›ic_tokís_‰ì
(
tokís
);

719  
MOSQ_ERR_PROTOCOL
;

721 
t
 = 
tokís
->
√xt
;

722 
	`mosquôto__‰ì
(
tokís
->
t›ic
);

723 
	`mosquôto__‰ì
(
tokís
);

724 
tokís
 = 
t
;

726 
sh¨íame
 = 
tokís
->
t›ic
;

728 
tokís
->
t›ic
 = 
	`mosquôto__°rdup
("");

729 if(!
tokís
->
t›ic
){

730 
tokís
->
t›ic
 = 
sh¨íame
;

731 
	`sub__t›ic_tokís_‰ì
(
tokís
);

732  
MOSQ_ERR_PROTOCOL
;

734 
tokís
->
t›ic_Àn
 = 0;

737 
	`HASH_FIND
(
hh
, *
roŸ
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
subhõr
);

738 if(!
subhõr
){

739 
subhõr
 = 
	`sub__add_hõr_íåy
(
NULL
, 
roŸ
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
);

740 if(!
subhõr
){

741 
	`sub__t›ic_tokís_‰ì
(
tokís
);

742 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

743  
MOSQ_ERR_NOMEM
;

747 
rc
 = 
	`sub__add_c⁄ãxt
(
db
, 
c⁄ãxt
, 
qos
, 
idítifõr
, 
›ti⁄s
, 
subhõr
, 
tokís
, 
sh¨íame
);

749 
	`sub__t›ic_tokís_‰ì
(
tokís
);

751  
rc
;

752 
	}
}

754 
	$sub__ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
mosquôto__subhõr
 *
roŸ
, 
uöt8_t
 *
ªas⁄
)

756 
rc
 = 0;

757 
mosquôto__subhõr
 *
subhõr
;

758 
sub__tokí
 *
tokís
 = 
NULL
, *
t
;

759 *
sh¨íame
 = 
NULL
;

761 
	`as£π
(
roŸ
);

762 
	`as£π
(
sub
);

764 if(
	`sub__t›ic_tokíi£
(
sub
, &
tokís
))  1;

766 if(!
	`°rcmp
(
tokís
->
t›ic
, "$share")){

767 if(!
tokís
->
√xt
 || !tokens->next->next){

768 
	`sub__t›ic_tokís_‰ì
(
tokís
);

769  
MOSQ_ERR_PROTOCOL
;

771 
t
 = 
tokís
->
√xt
;

772 
	`mosquôto__‰ì
(
tokís
->
t›ic
);

773 
	`mosquôto__‰ì
(
tokís
);

774 
tokís
 = 
t
;

776 
sh¨íame
 = 
tokís
->
t›ic
;

778 
tokís
->
t›ic
 = 
	`mosquôto__°rdup
("");

779 if(!
tokís
->
t›ic
){

780 
tokís
->
t›ic
 = 
sh¨íame
;

781 
	`sub__t›ic_tokís_‰ì
(
tokís
);

782  
MOSQ_ERR_PROTOCOL
;

784 
tokís
->
t›ic_Àn
 = 0;

787 
	`HASH_FIND
(
hh
, 
roŸ
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
subhõr
);

788 if(
subhõr
){

789 *
ªas⁄
 = 
MQTT_RC_NO_SUBSCRIPTION_EXISTED
;

790 
rc
 = 
	`sub__ªmove_ªcur£
(
db
, 
c⁄ãxt
, 
subhõr
, 
tokís
, 
ªas⁄
, 
sh¨íame
);

793 
	`sub__t›ic_tokís_‰ì
(
tokís
);

795  
rc
;

796 
	}
}

798 
	$sub__mesßges_queue
(
mosquôto_db
 *
db
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
)

800 
rc
 = 0;

801 
mosquôto__subhõr
 *
subhõr
;

802 
sub__tokí
 *
tokís
 = 
NULL
;

804 
	`as£π
(
db
);

805 
	`as£π
(
t›ic
);

807 if(
	`sub__t›ic_tokíi£
(
t›ic
, &
tokís
))  1;

813 
	`db__msg_°‹e_ªf_öc
(*
°‹ed
);

815 
	`HASH_FIND
(
hh
, 
db
->
subs
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
subhõr
);

816 if(
subhõr
){

817 if(
ªèö
){

821 
	`sub__add_c⁄ãxt
(
db
, 
NULL
, 0, 0, 0, 
subhõr
, 
tokís
, NULL);

823 
rc
 = 
	`sub__£¨ch
(
db
, 
subhõr
, 
tokís
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, *
°‹ed
, 
åue
);

825 
	`sub__t›ic_tokís_‰ì
(
tokís
);

828 
	`db__msg_°‹e_ªf_dec
(
db
, 
°‹ed
);

830  
rc
;

831 
	}
}

835 
mosquôto__subhõr
 *
	$tmp_ªmove_subs
(
mosquôto__subhõr
 *
sub
)

837 
mosquôto__subhõr
 *
∑ª¡
;

839 if(!
sub
 || !sub->
∑ª¡
){

840  
NULL
;

843 if(
sub
->
chûdªn
 || sub->
subs
 || sub->
ªèöed
){

844  
NULL
;

847 
∑ª¡
 = 
sub
->parent;

848 
	`HASH_DELETE
(
hh
, 
∑ª¡
->
chûdªn
, 
sub
);

849 
	`mosquôto__‰ì
(
sub
->
t›ic
);

850 
	`mosquôto__‰ì
(
sub
);

852 if(
∑ª¡
->
subs
 =
NULL


853 && 
∑ª¡
->
chûdªn
 =
NULL


854 && 
∑ª¡
->
ªèöed
 =
NULL


855 && 
∑ª¡
->
sh¨ed
 =
NULL


856 && 
∑ª¡
->parent){

858  
∑ª¡
;

860  
NULL
;

862 
	}
}

865 
	$sub__˛ón_£ssi⁄_sh¨ed
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

867 
i
;

868 
mosquôto__subÀaf
 *
Àaf
;

869 
mosquôto__subhõr
 *
hõr
;

871 
i
=0; i<
c⁄ãxt
->
sh¨ed_sub_cou¡
; i++){

872 if(
c⁄ãxt
->
sh¨ed_subs
[
i
] =
NULL
){

875 
Àaf
 = 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
sh¨ed
->
subs
;

876 
Àaf
){

877 if(
Àaf
->
c⁄ãxt
==context){

878 #ifde‡
WITH_SYS_TREE


879 
db
->
sh¨ed_subs¸ùti⁄_cou¡
--;

881 
	`sub__ªmove_sh¨ed_Àaf
(
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
, c⁄ãxt->sh¨ed_subs[i]->
sh¨ed
, 
Àaf
);

884 
Àaf
 =Üóf->
√xt
;

886 if(
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
->
subs
 =
NULL


887 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
->
chûdªn
 =
NULL


888 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
->
ªèöed
 =
NULL


889 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
->
sh¨ed
 =
NULL


890 && 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
->
∑ª¡
){

892 
hõr
 = 
c⁄ãxt
->
sh¨ed_subs
[
i
]->hier;

893 
c⁄ãxt
->
sh¨ed_subs
[
i
]->
hõr
 = 
NULL
;

895 
hõr
 = 
	`tmp_ªmove_subs
(hier);

896 }
hõr
);

898 
	`mosquôto__‰ì
(
c⁄ãxt
->
sh¨ed_subs
[
i
]);

900 
	`mosquôto__‰ì
(
c⁄ãxt
->
sh¨ed_subs
);

901 
c⁄ãxt
->
sh¨ed_subs
 = 
NULL
;

902 
c⁄ãxt
->
sh¨ed_sub_cou¡
 = 0;

904  
MOSQ_ERR_SUCCESS
;

905 
	}
}

909 
	$sub__˛ón_£ssi⁄
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

911 
i
;

912 
mosquôto__subÀaf
 *
Àaf
;

913 
mosquôto__subhõr
 *
hõr
;

915 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

916 if(
c⁄ãxt
->
subs
[
i
] =
NULL
){

919 
Àaf
 = 
c⁄ãxt
->
subs
[
i
]->subs;

920 
Àaf
){

921 if(
Àaf
->
c⁄ãxt
==context){

922 #ifde‡
WITH_SYS_TREE


923 
db
->
subs¸ùti⁄_cou¡
--;

925 
	`DL_DELETE
(
c⁄ãxt
->
subs
[
i
]->subs, 
Àaf
);

926 
	`mosquôto__‰ì
(
Àaf
);

929 
Àaf
 =Üóf->
√xt
;

931 if(
c⁄ãxt
->
subs
[
i
]->sub†=
NULL


932 && 
c⁄ãxt
->
subs
[
i
]->
chûdªn
 =
NULL


933 && 
c⁄ãxt
->
subs
[
i
]->
ªèöed
 =
NULL


934 && 
c⁄ãxt
->
subs
[
i
]->
sh¨ed
 =
NULL


935 && 
c⁄ãxt
->
subs
[
i
]->
∑ª¡
){

937 
hõr
 = 
c⁄ãxt
->
subs
[
i
];

938 
c⁄ãxt
->
subs
[
i
] = 
NULL
;

940 
hõr
 = 
	`tmp_ªmove_subs
(hier);

941 }
hõr
);

944 
	`mosquôto__‰ì
(
c⁄ãxt
->
subs
);

945 
c⁄ãxt
->
subs
 = 
NULL
;

946 
c⁄ãxt
->
sub_cou¡
 = 0;

948  
	`sub__˛ón_£ssi⁄_sh¨ed
(
db
, 
c⁄ãxt
);

949 
	}
}

951 
	$sub__åì_¥öt
(
mosquôto__subhõr
 *
roŸ
, 
Àvñ
)

953 
i
;

954 
mosquôto__subhõr
 *
bønch
, *
bønch_tmp
;

955 
mosquôto__subÀaf
 *
Àaf
;

957 
	`HASH_ITER
(
hh
, 
roŸ
, 
bønch
, 
bønch_tmp
){

958 if(
Àvñ
 > -1){

959 
i
=0; i<(
Àvñ
+2)*2; i++){

960 
	`¥ötf
(" ");

962 
	`¥ötf
("%s", 
bønch
->
t›ic
);

963 
Àaf
 = 
bønch
->
subs
;

964 
Àaf
){

965 if(
Àaf
->
c⁄ãxt
){

966 
	`¥ötf
(" (%s, %d)", 
Àaf
->
c⁄ãxt
->
id
,Üóf->
qos
);

968 
	`¥ötf
(" (%s, %d)", "", 
Àaf
->
qos
);

970 
Àaf
 =Üóf->
√xt
;

972 if(
bønch
->
ªèöed
){

973 
	`¥ötf
(" (r)");

975 
	`¥ötf
("\n");

978 
	`sub__åì_¥öt
(
bønch
->
chûdªn
, 
Àvñ
+1);

980 
	}
}

982 
	$ªèö__¥o˚ss
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 *
bønch
, 
mosquôto
 *
c⁄ãxt
, 
sub_qos
, 
uöt32_t
 
subs¸ùti⁄_idítifõr
, 
time_t
 
now
)

984 
rc
 = 0;

985 
qos
;

986 
uöt16_t
 
mid
;

987 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

988 
mosquôto_msg_°‹e
 *
ªèöed
;

990 if(
bønch
->
ªèöed
->
mesßge_expúy_time
 > 0 && 
now
 > branch->retained->message_expiry_time){

991 
	`db__msg_°‹e_ªf_dec
(
db
, &
bønch
->
ªèöed
);

992 
bønch
->
ªèöed
 = 
NULL
;

993 #ifde‡
WITH_SYS_TREE


994 
db
->
ªèöed_cou¡
--;

996  
MOSQ_ERR_SUCCESS
;

999 
ªèöed
 = 
bønch
->retained;

1001 
rc
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
ªèöed
->
t›ic
,Ñëaöed->
∑ylﬂdÀn
, 
	`UHPA_ACCESS
‘ëaöed->
∑ylﬂd
,Ñetained->payloadlen),

1002 
ªèöed
->
qos
,Ñëaöed->
ªèö
, 
MOSQ_ACL_READ
);

1003 if(
rc
 =
MOSQ_ERR_ACL_DENIED
){

1004  
MOSQ_ERR_SUCCESS
;

1005 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

1006  
rc
;

1010 if(
db
->
c⁄fig
->
check_ªèö_sour˚
 && 
ªèöed
->
‹igö
 !
mosq_mo_brokî
 &&Ñëaöed->
sour˚_id
){

1011 
mosquôto
 
ªèö_˘xt
;

1012 
	`mem£t
(&
ªèö_˘xt
, 0, (
mosquôto
));

1014 
ªèö_˘xt
.
id
 = 
ªèöed
->
sour˚_id
;

1015 
ªèö_˘xt
.
u£∫ame
 = 
ªèöed
->
sour˚_u£∫ame
;

1016 
ªèö_˘xt
.
li°íî
 = 
ªèöed
->
sour˚_li°íî
;

1018 
rc
 = 
	`a˛__föd_a˛s
(
db
, &
ªèö_˘xt
);

1019 if(
rc
) Ñc;

1021 
rc
 = 
	`mosquôto_a˛_check
(
db
, &
ªèö_˘xt
, 
ªèöed
->
t›ic
,Ñëaöed->
∑ylﬂdÀn
, 
	`UHPA_ACCESS
‘ëaöed->
∑ylﬂd
,Ñetained->payloadlen),

1022 
ªèöed
->
qos
,Ñëaöed->
ªèö
, 
MOSQ_ACL_WRITE
);

1023 if(
rc
 =
MOSQ_ERR_ACL_DENIED
){

1024  
MOSQ_ERR_SUCCESS
;

1025 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

1026  
rc
;

1030 i‡(
db
->
c⁄fig
->
upgøde_outgoög_qos
){

1031 
qos
 = 
sub_qos
;

1033 
qos
 = 
ªèöed
->qos;

1034 if(
qos
 > 
sub_qos
) qos = sub_qos;

1036 if(
qos
 > 0){

1037 
mid
 = 
	`mosquôto__mid_gíî©e
(
c⁄ãxt
);

1039 
mid
 = 0;

1041 if(
subs¸ùti⁄_idítifõr
 > 0){

1042 
	`mosquôto_¥›îty_add_v¨öt
(&
¥›îtõs
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 
subs¸ùti⁄_idítifõr
);

1044  
	`db__mesßge_ö£π
(
db
, 
c⁄ãxt
, 
mid
, 
mosq_md_out
, 
qos
, 
åue
, 
ªèöed
, 
¥›îtõs
);

1045 
	}
}

1047 
	$ªèö__£¨ch
(
mosquôto_db
 *
db
, 
mosquôto__subhõr
 *
subhõr
, 
sub__tokí
 *
tokís
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
, 
uöt32_t
 
subs¸ùti⁄_idítifõr
, 
time_t
 
now
, 
Àvñ
)

1049 
mosquôto__subhõr
 *
bønch
, *
bønch_tmp
;

1050 
Êag
 = 0;

1052 if(!
	`°rcmp
(
tokís
->
t›ic
, "#"Ë&& !tokís->
√xt
){

1053 
	`HASH_ITER
(
hh
, 
subhõr
->
chûdªn
, 
bønch
, 
bønch_tmp
){

1058 
Êag
 = -1;

1059 if(
bønch
->
ªèöed
){

1060 
	`ªèö__¥o˚ss
(
db
, 
bønch
, 
c⁄ãxt
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
);

1062 if(
bønch
->
chûdªn
){

1063 
	`ªèö__£¨ch
(
db
, 
bønch
, 
tokís
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
, 
Àvñ
+1);

1067 if(!
	`°rcmp
(
tokís
->
t›ic
, "+")){

1068 
	`HASH_ITER
(
hh
, 
subhõr
->
chûdªn
, 
bønch
, 
bønch_tmp
){

1069 if(
tokís
->
√xt
){

1070 if(
	`ªèö__£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
, 
Àvñ
+1) == -1

1071 || (
tokís
->
√xt
 && !
	`°rcmp
—okís->√xt->
t›ic
, "#"Ë&& 
Àvñ
>0)){

1073 if(
bønch
->
ªèöed
){

1074 
	`ªèö__¥o˚ss
(
db
, 
bønch
, 
c⁄ãxt
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
);

1078 if(
bønch
->
ªèöed
){

1079 
	`ªèö__¥o˚ss
(
db
, 
bønch
, 
c⁄ãxt
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
);

1084 
	`HASH_FIND
(
hh
, 
subhõr
->
chûdªn
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
bønch
);

1085 if(
bønch
){

1086 if(
tokís
->
√xt
){

1087 if(
	`ªèö__£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
, 
Àvñ
+1) == -1

1088 || (
tokís
->
√xt
 && !
	`°rcmp
—okís->√xt->
t›ic
, "#"Ë&& 
Àvñ
>0)){

1090 if(
bønch
->
ªèöed
){

1091 
	`ªèö__¥o˚ss
(
db
, 
bønch
, 
c⁄ãxt
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
);

1095 if(
bønch
->
ªèöed
){

1096 
	`ªèö__¥o˚ss
(
db
, 
bønch
, 
c⁄ãxt
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
);

1102  
Êag
;

1103 
	}
}

1105 
	$sub__ªèö_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
, 
uöt32_t
 
subs¸ùti⁄_idítifõr
)

1107 
mosquôto__subhõr
 *
subhõr
;

1108 
sub__tokí
 *
tokís
 = 
NULL
, *
èû
;

1109 
time_t
 
now
;

1111 
	`as£π
(
db
);

1112 
	`as£π
(
c⁄ãxt
);

1113 
	`as£π
(
sub
);

1115 if(
	`sub__t›ic_tokíi£
(
sub
, &
tokís
))  1;

1117 
	`HASH_FIND
(
hh
, 
db
->
subs
, 
tokís
->
t›ic
,Åokís->
t›ic_Àn
, 
subhõr
);

1119 if(
subhõr
){

1120 
now
 = 
	`time
(
NULL
);

1121 
	`ªèö__£¨ch
(
db
, 
subhõr
, 
tokís
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
subs¸ùti⁄_idítifõr
, 
now
, 0);

1123 
tokís
){

1124 
èû
 = 
tokís
->
√xt
;

1125 
	`mosquôto__‰ì
(
tokís
->
t›ic
);

1126 
	`mosquôto__‰ì
(
tokís
);

1127 
tokís
 = 
èû
;

1130  
MOSQ_ERR_SUCCESS
;

1131 
	}
}

	@src/sys_tree.c

17 #ifde‡
WITH_SYS_TREE


19 
	~"c⁄fig.h
"

21 
	~<m©h.h
>

22 
	~<°dio.h
>

24 
	~"mosquôto_brokî_öã∫Æ.h
"

25 
	~"mem‹y_mosq.h
"

26 
	~"time_mosq.h
"

28 
	#BUFLEN
 100

	)

30 
	#SYS_TREE_QOS
 2

	)

32 
uöt64_t
 
	gg_byãs_ª˚ived
 = 0;

33 
uöt64_t
 
	gg_byãs_£¡
 = 0;

34 
uöt64_t
 
	gg_pub_byãs_ª˚ived
 = 0;

35 
uöt64_t
 
	gg_pub_byãs_£¡
 = 0;

36 
	gg_msgs_ª˚ived
 = 0;

37 
	gg_msgs_£¡
 = 0;

38 
	gg_pub_msgs_ª˚ived
 = 0;

39 
	gg_pub_msgs_£¡
 = 0;

40 
	gg_msgs_dr›≥d
 = 0;

41 
	gg_˛õ¡s_expúed
 = 0;

42 
	gg_sockë_c⁄√˘i⁄s
 = 0;

43 
	gg_c⁄√˘i⁄_cou¡
 = 0;

45 
	$sys_åì__öô
(
mosquôto_db
 *
db
)

47 
buf
[64];

49 if(
db
->
c⁄fig
->
sys_öãrvÆ
 == 0){

54 
	`¢¥ötf
(
buf
, 64, "mosquôtÿvîsi⁄ %s", 
VERSION
);

55 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/vîsi⁄", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 0, NULL);

56 
	}
}

58 
	$sys_åì__upd©e_˛õ¡s
(
mosquôto_db
 *
db
, *
buf
)

60 
˛õ¡_cou¡
 = -1;

61 
˛õ¡s_expúed
 = -1;

62 
˛õ¡_max
 = 0;

63 
disc⁄√˘ed_cou¡
 = -1;

64 
c⁄√˘ed_cou¡
 = -1;

66 
cou¡_tŸÆ
, 
cou¡_by_sock
;

68 
cou¡_tŸÆ
 = 
	`HASH_CNT
(
hh_id
, 
db
->
c⁄ãxts_by_id
);

69 
cou¡_by_sock
 = 
	`HASH_CNT
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
);

71 if(
˛õ¡_cou¡
 !
cou¡_tŸÆ
){

72 
˛õ¡_cou¡
 = 
cou¡_tŸÆ
;

73 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡_cou¡
);

74 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/tŸÆ", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

76 if(
˛õ¡_cou¡
 > 
˛õ¡_max
){

77 
˛õ¡_max
 = 
˛õ¡_cou¡
;

78 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡_max
);

79 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/maximum", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

83 if(
disc⁄√˘ed_cou¡
 !
cou¡_tŸÆ
-
cou¡_by_sock
){

84 
disc⁄√˘ed_cou¡
 = 
cou¡_tŸÆ
-
cou¡_by_sock
;

85 if(
disc⁄√˘ed_cou¡
 < 0){

90 
disc⁄√˘ed_cou¡
 = 0;

92 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
disc⁄√˘ed_cou¡
);

93 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/öa˘ive", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

94 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/disc⁄√˘ed", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

96 if(
c⁄√˘ed_cou¡
 !
cou¡_by_sock
){

97 
c⁄√˘ed_cou¡
 = 
cou¡_by_sock
;

98 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
c⁄√˘ed_cou¡
);

99 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/a˘ive", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

100 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/c⁄√˘ed", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

102 if(
g_˛õ¡s_expúed
 !
˛õ¡s_expúed
){

103 
˛õ¡s_expúed
 = 
g_˛õ¡s_expúed
;

104 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡s_expúed
);

105 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/expúed", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

107 
	}
}

109 #ifde‡
REAL_WITH_MEMORY_TRACKING


110 
	$sys_åì__upd©e_mem‹y
(
mosquôto_db
 *
db
, *
buf
)

112 
cuºít_hóp
 = -1;

113 
max_hóp
 = -1;

114 
vÆue_ul
;

116 
vÆue_ul
 = 
	`mosquôto__mem‹y_u£d
();

117 if(
cuºít_hóp
 !
vÆue_ul
){

118 
cuºít_hóp
 = 
vÆue_ul
;

119 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
cuºít_hóp
);

120 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/hóp/cuºít", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

122 
vÆue_ul
 =
	`mosquôto__max_mem‹y_u£d
();

123 if(
max_hóp
 !
vÆue_ul
){

124 
max_hóp
 = 
vÆue_ul
;

125 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
max_hóp
);

126 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/hóp/maximum", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

128 
	}
}

131 
	$ˇlc_lﬂd
(
mosquôto_db
 *
db
, *
buf
, c⁄° *
t›ic
, 
boﬁ
 
öôül
, 
exp⁄ít
, 
öãrvÆ
, *
cuºít
)

133 
√w_vÆue
;

135 i‡(
öôül
) {

136 
√w_vÆue
 = *
cuºít
;

137 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%.2f", 
√w_vÆue
);

138 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, 
t›ic
, 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

140 
√w_vÆue
 = 
öãrvÆ
 + 
exp⁄ít
*((*
cuºít
) - interval);

141 if(
	`Ábs
(
√w_vÆue
 - (*
cuºít
)) >= 0.01){

142 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%.2f", 
√w_vÆue
);

143 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, 
t›ic
, 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

146 (*
cuºít
Ë
√w_vÆue
;

147 
	}
}

155 
	$sys_åì__upd©e
(
mosquôto_db
 *
db
, 
öãrvÆ
, 
time_t
 
°¨t_time
)

157 
time_t
 
œ°_upd©e
 = 0;

158 
time_t
 
now
;

159 
time_t
 
u±ime
;

160 
buf
[
BUFLEN
];

162 
msg_°‹e_cou¡
 = -1;

163 
msg_°‹e_byãs
 = -1;

164 
msgs_ª˚ived
 = -1;

165 
msgs_£¡
 = -1;

166 
publish_dr›≥d
 = -1;

167 
pub_msgs_ª˚ived
 = -1;

168 
pub_msgs_£¡
 = -1;

169 
byãs_ª˚ived
 = -1;

170 
byãs_£¡
 = -1;

171 
pub_byãs_ª˚ived
 = -1;

172 
pub_byãs_£¡
 = -1;

173 
subs¸ùti⁄_cou¡
 = -1;

174 
sh¨ed_subs¸ùti⁄_cou¡
 = -1;

175 
ªèöed_cou¡
 = -1;

177 
msgs_ª˚ived_lﬂd1
 = 0;

178 
msgs_ª˚ived_lﬂd5
 = 0;

179 
msgs_ª˚ived_lﬂd15
 = 0;

180 
msgs_£¡_lﬂd1
 = 0;

181 
msgs_£¡_lﬂd5
 = 0;

182 
msgs_£¡_lﬂd15
 = 0;

183 
publish_dr›≥d_lﬂd1
 = 0;

184 
publish_dr›≥d_lﬂd5
 = 0;

185 
publish_dr›≥d_lﬂd15
 = 0;

186 
msgs_ª˚ived_öãrvÆ
, 
msgs_£¡_öãrvÆ
, 
publish_dr›≥d_öãrvÆ
;

188 
publish_ª˚ived_lﬂd1
 = 0;

189 
publish_ª˚ived_lﬂd5
 = 0;

190 
publish_ª˚ived_lﬂd15
 = 0;

191 
publish_£¡_lﬂd1
 = 0;

192 
publish_£¡_lﬂd5
 = 0;

193 
publish_£¡_lﬂd15
 = 0;

194 
publish_ª˚ived_öãrvÆ
, 
publish_£¡_öãrvÆ
;

196 
byãs_ª˚ived_lﬂd1
 = 0;

197 
byãs_ª˚ived_lﬂd5
 = 0;

198 
byãs_ª˚ived_lﬂd15
 = 0;

199 
byãs_£¡_lﬂd1
 = 0;

200 
byãs_£¡_lﬂd5
 = 0;

201 
byãs_£¡_lﬂd15
 = 0;

202 
byãs_ª˚ived_öãrvÆ
, 
byãs_£¡_öãrvÆ
;

204 
sockë_lﬂd1
 = 0;

205 
sockë_lﬂd5
 = 0;

206 
sockë_lﬂd15
 = 0;

207 
sockë_öãrvÆ
;

209 
c⁄√˘i⁄_lﬂd1
 = 0;

210 
c⁄√˘i⁄_lﬂd5
 = 0;

211 
c⁄√˘i⁄_lﬂd15
 = 0;

212 
c⁄√˘i⁄_öãrvÆ
;

214 
exp⁄ít
;

215 
i_mu…
;

217 
now
 = 
	`mosquôto_time
();

219 if(
öãrvÆ
 && 
now
 - i¡îvÆ > 
œ°_upd©e
){

220 
u±ime
 = 
now
 - 
°¨t_time
;

221 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d sec⁄ds", ()
u±ime
);

222 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/u±ime", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

224 
	`sys_åì__upd©e_˛õ¡s
(
db
, 
buf
);

225 
boﬁ
 
öôül_publish
 = 
Ál£
;

226 if(
œ°_upd©e
 == 0){

227 
öôül_publish
 = 
åue
;

228 
œ°_upd©e
 = 1;

230 if(
œ°_upd©e
 > 0){

231 
i_mu…
 = 60.0/()(
now
-
œ°_upd©e
);

233 
msgs_ª˚ived_öãrvÆ
 = (
g_msgs_ª˚ived
 - 
msgs_ª˚ived
)*
i_mu…
;

234 
msgs_£¡_öãrvÆ
 = (
g_msgs_£¡
 - 
msgs_£¡
)*
i_mu…
;

235 
publish_dr›≥d_öãrvÆ
 = (
g_msgs_dr›≥d
 - 
publish_dr›≥d
)*
i_mu…
;

237 
publish_ª˚ived_öãrvÆ
 = (
g_pub_msgs_ª˚ived
 - 
pub_msgs_ª˚ived
)*
i_mu…
;

238 
publish_£¡_öãrvÆ
 = (
g_pub_msgs_£¡
 - 
pub_msgs_£¡
)*
i_mu…
;

240 
byãs_ª˚ived_öãrvÆ
 = (
g_byãs_ª˚ived
 - 
byãs_ª˚ived
)*
i_mu…
;

241 
byãs_£¡_öãrvÆ
 = (
g_byãs_£¡
 - 
byãs_£¡
)*
i_mu…
;

243 
sockë_öãrvÆ
 = 
g_sockë_c⁄√˘i⁄s
*
i_mu…
;

244 
g_sockë_c⁄√˘i⁄s
 = 0;

245 
c⁄√˘i⁄_öãrvÆ
 = 
g_c⁄√˘i⁄_cou¡
*
i_mu…
;

246 
g_c⁄√˘i⁄_cou¡
 = 0;

249 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/60.0);

251 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/1mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd1
);

252 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/1mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd1
);

253 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/1mö", 
öôül_publish
, 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd1
);

254 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/1mö", 
öôül_publish
, 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd1
);

255 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/1mö", 
öôül_publish
, 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd1
);

256 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/1mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd1
);

257 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/1mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd1
);

258 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/1mö", 
öôül_publish
, 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd1
);

259 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/1mö", 
öôül_publish
, 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd1
);

262 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/300.0);

264 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/5mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd5
);

265 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/5mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd5
);

266 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/5mö", 
öôül_publish
, 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd5
);

267 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/5mö", 
öôül_publish
, 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd5
);

268 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/5mö", 
öôül_publish
, 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd5
);

269 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/5mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd5
);

270 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/5mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd5
);

271 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/5mö", 
öôül_publish
, 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd5
);

272 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/5mö", 
öôül_publish
, 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd5
);

275 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/900.0);

277 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/15mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd15
);

278 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/15mö", 
öôül_publish
, 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd15
);

279 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/15mö", 
öôül_publish
, 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd15
);

280 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/15mö", 
öôül_publish
, 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd15
);

281 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/15mö", 
öôül_publish
, 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd15
);

282 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/15mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd15
);

283 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/15mö", 
öôül_publish
, 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd15
);

284 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/15mö", 
öôül_publish
, 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd15
);

285 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/15mö", 
öôül_publish
, 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd15
);

288 if(
db
->
msg_°‹e_cou¡
 != msg_store_count){

289 
msg_°‹e_cou¡
 = 
db
->msg_store_count;

290 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
msg_°‹e_cou¡
);

291 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/°‹ed", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

292 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/°‹e/mesßges/cou¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

295 i‡(
db
->
msg_°‹e_byãs
 != msg_store_bytes){

296 
msg_°‹e_byãs
 = 
db
->msg_store_bytes;

297 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
msg_°‹e_byãs
);

298 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/°‹e/mesßges/byãs", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

301 if(
db
->
subs¸ùti⁄_cou¡
 != subscription_count){

302 
subs¸ùti⁄_cou¡
 = 
db
->subscription_count;

303 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
subs¸ùti⁄_cou¡
);

304 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/subs¸ùti⁄s/cou¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

307 if(
db
->
sh¨ed_subs¸ùti⁄_cou¡
 != shared_subscription_count){

308 
sh¨ed_subs¸ùti⁄_cou¡
 = 
db
->shared_subscription_count;

309 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
sh¨ed_subs¸ùti⁄_cou¡
);

310 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/sh¨ed_subs¸ùti⁄s/cou¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

313 if(
db
->
ªèöed_cou¡
 !=Ñetained_count){

314 
ªèöed_cou¡
 = 
db
->retained_count;

315 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
ªèöed_cou¡
);

316 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/ªèöed mesßges/cou¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

319 #ifde‡
REAL_WITH_MEMORY_TRACKING


320 
	`sys_åì__upd©e_mem‹y
(
db
, 
buf
);

323 if(
msgs_ª˚ived
 !
g_msgs_ª˚ived
){

324 
msgs_ª˚ived
 = 
g_msgs_ª˚ived
;

325 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
msgs_ª˚ived
);

326 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/ª˚ived", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

329 if(
msgs_£¡
 !
g_msgs_£¡
){

330 
msgs_£¡
 = 
g_msgs_£¡
;

331 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
msgs_£¡
);

332 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/£¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

335 if(
publish_dr›≥d
 !
g_msgs_dr›≥d
){

336 
publish_dr›≥d
 = 
g_msgs_dr›≥d
;

337 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
publish_dr›≥d
);

338 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/dr›≥d", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

341 if(
pub_msgs_ª˚ived
 !
g_pub_msgs_ª˚ived
){

342 
pub_msgs_ª˚ived
 = 
g_pub_msgs_ª˚ived
;

343 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
pub_msgs_ª˚ived
);

344 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/ª˚ived", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

347 if(
pub_msgs_£¡
 !
g_pub_msgs_£¡
){

348 
pub_msgs_£¡
 = 
g_pub_msgs_£¡
;

349 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
pub_msgs_£¡
);

350 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/£¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

353 if(
byãs_ª˚ived
 !
g_byãs_ª˚ived
){

354 
byãs_ª˚ived
 = 
g_byãs_ª˚ived
;

355 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
byãs_ª˚ived
);

356 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/byãs/ª˚ived", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

359 if(
byãs_£¡
 !
g_byãs_£¡
){

360 
byãs_£¡
 = 
g_byãs_£¡
;

361 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
byãs_£¡
);

362 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/byãs/£¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

365 if(
pub_byãs_ª˚ived
 !
g_pub_byãs_ª˚ived
){

366 
pub_byãs_ª˚ived
 = 
g_pub_byãs_ª˚ived
;

367 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
pub_byãs_ª˚ived
);

368 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/byãs/ª˚ived", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

371 if(
pub_byãs_£¡
 !
g_pub_byãs_£¡
){

372 
pub_byãs_£¡
 = 
g_pub_byãs_£¡
;

373 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
pub_byãs_£¡
);

374 
	`db__mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/byãs/£¡", 
SYS_TREE_QOS
, 
	`°æí
(
buf
), buf, 1, 60, NULL);

377 
œ°_upd©e
 = 
	`mosquôto_time
();

379 
	}
}

	@src/sys_tree.h

17 #i‚de‡
SYS_TREE_H


18 
	#SYS_TREE_H


	)

20 #i‡
deföed
(
WITH_SYS_TREE
Ë&& deföed(
WITH_BROKER
)

21 
uöt64_t
 
g_byãs_ª˚ived
;

22 
uöt64_t
 
g_byãs_£¡
;

23 
uöt64_t
 
g_pub_byãs_ª˚ived
;

24 
uöt64_t
 
g_pub_byãs_£¡
;

25 
g_msgs_ª˚ived
;

26 
g_msgs_£¡
;

27 
g_pub_msgs_ª˚ived
;

28 
g_pub_msgs_£¡
;

29 
g_msgs_dr›≥d
;

30 
g_˛õ¡s_expúed
;

31 
g_sockë_c⁄√˘i⁄s
;

32 
g_c⁄√˘i⁄_cou¡
;

34 
	#G_BYTES_RECEIVED_INC
(
A
Ë(
g_byãs_ª˚ived
+=(A))

	)

35 
	#G_BYTES_SENT_INC
(
A
Ë(
g_byãs_£¡
+=(A))

	)

36 
	#G_PUB_BYTES_RECEIVED_INC
(
A
Ë(
g_pub_byãs_ª˚ived
+=(A))

	)

37 
	#G_PUB_BYTES_SENT_INC
(
A
Ë(
g_pub_byãs_£¡
+=(A))

	)

38 
	#G_MSGS_RECEIVED_INC
(
A
Ë(
g_msgs_ª˚ived
+=(A))

	)

39 
	#G_MSGS_SENT_INC
(
A
Ë(
g_msgs_£¡
+=(A))

	)

40 
	#G_PUB_MSGS_RECEIVED_INC
(
A
Ë(
g_pub_msgs_ª˚ived
+=(A))

	)

41 
	#G_PUB_MSGS_SENT_INC
(
A
Ë(
g_pub_msgs_£¡
+=(A))

	)

42 
	#G_MSGS_DROPPED_INC
(Ë(
g_msgs_dr›≥d
++)

	)

43 
	#G_CLIENTS_EXPIRED_INC
(Ë(
g_˛õ¡s_expúed
++)

	)

44 
	#G_SOCKET_CONNECTIONS_INC
(Ë(
g_sockë_c⁄√˘i⁄s
++)

	)

45 
	#G_CONNECTION_COUNT_INC
(Ë(
g_c⁄√˘i⁄_cou¡
++)

	)

49 
	#G_BYTES_RECEIVED_INC
(
A
)

	)

50 
	#G_BYTES_SENT_INC
(
A
)

	)

51 
	#G_PUB_BYTES_RECEIVED_INC
(
A
)

	)

52 
	#G_PUB_BYTES_SENT_INC
(
A
)

	)

53 
	#G_MSGS_RECEIVED_INC
(
A
)

	)

54 
	#G_MSGS_SENT_INC
(
A
)

	)

55 
	#G_PUB_MSGS_RECEIVED_INC
(
A
)

	)

56 
	#G_PUB_MSGS_SENT_INC
(
A
)

	)

57 
	#G_MSGS_DROPPED_INC
(
A
)

	)

58 
	#G_CLIENTS_EXPIRED_INC
(
A
)

	)

59 
	#G_SOCKET_CONNECTIONS_INC
(
A
)

	)

60 
	#G_CONNECTION_COUNT_INC
(
A
)

	)

	@src/uhpa.h

16 #i‚de‡
UHPA_H


17 
	#UHPA_H


	)

124 #i‚de‡
uh∑_mÆloc


125 
	#uh∑_mÆloc
(
size
Ë
	`mÆloc
(size)

	)

128 #i‚de‡
uh∑_‰ì


129 
	#uh∑_‰ì
(
±r
Ë
	`‰ì
’å)

	)

132 
	#UHPA_ALLOC_CHK
(
u
, 
size
) \

133 ((
size
Ë> ((
u
).
¨øy
)? \

134 (((
u
).
±r
 = 
	`uh∑_mÆloc
((
size
)))?1:0) \

135 :-1)

	)

137 
	#UHPA_ACCESS_CHK
(
u
, 
size
Ë((sizeË> ((u).
¨øy
)?(u).
±r
:(u).¨øy)

	)

139 
	#UHPA_FREE_CHK
(
u
, 
size
) \

140 if((
size
Ë> ((
u
).
¨øy
Ë&& (u).
±r
){ \

141 
	`uh∑_‰ì
((
u
).
±r
); \

142 (
u
).
±r
 = 
NULL
; \

143 }

	)

145 
	#UHPA_MOVE_CHK
(
de°
, 
§c
, 
§c_size
) \

146 if((
§c_size
Ë> ((
§c
).
¨øy
Ë&& (§c).
±r
){ \

147 (
de°
).
±r
 = (
§c
).ptr; \

148 (
§c
).
±r
 = 
NULL
; \

150 
	`memmove
((
de°
).
¨øy
, (
§c
).¨øy, (
§c_size
)); \

151 
	`mem£t
((
§c
).
¨øy
, 0, (
§c_size
)); \

152 }

	)

154 #ifde‡
UHPA_FORCE_MALLOC


155 
	#UHPA_ALLOC
(
u
, 
size
Ë((u).
±r
 = 
	`uh∑_mÆloc
(size))

	)

156 
	#UHPA_ACCESS
(
u
, 
size
Ë(u).
±r


	)

157 
	#UHPA_FREE
(
u
, 
size
Ë
	`uh∑_‰ì
((u).
±r
); (u).±∏
NULL
;

	)

158 
	#UHPA_MOVE
(
de°
, 
§c
, 
§c_size
Ë{(de°).
±r
 = (§c).±r; (§c).±∏
NULL
;}

	)

160 
	#UHPA_ALLOC
(
u
, 
size
Ë
	`UHPA_ALLOC_CHK
(u, size)

	)

161 
	#UHPA_ACCESS
(
u
, 
size
Ë
	`UHPA_ACCESS_CHK
(u, size)

	)

162 
	#UHPA_FREE
(
u
, 
size
Ë
	`UHPA_FREE_CHK
(u, size)

	)

163 
	#UHPA_MOVE
(
de°
, 
§c
, 
§c_size
Ë
	`UHPA_MOVE_CHK
(de°, src, src_size)

	)

166 
	#UHPA_ALLOC_STR
(
u
, 
size
Ë
	`UHPA_ALLOC
((u), (size)+1)

	)

167 
	#UHPA_ACCESS_STR
(
u
, 
size
Ë((*)
	`UHPA_ACCESS
((u), (size)+1))

	)

168 
	#UHPA_FREE_STR
(
u
, 
size
Ë
	`UHPA_FREE
((u), (size)+1)

	)

169 
	#UHPA_MOVE_STR
(
de°
, 
§c
, 
§c_size
Ë
	`UHPA_MOVE
((de°), (§c), (§c_size)+1)

	)

	@src/websockets.c

30 #ifde‡
WITH_WEBSOCKETS


32 
	~"c⁄fig.h
"

34 
	~<libwebsockës.h
>

35 
	~"mosquôto_öã∫Æ.h
"

36 
	~"mosquôto_brokî_öã∫Æ.h
"

37 
	~"mqâ_¥Ÿocﬁ.h
"

38 
	~"mem‹y_mosq.h
"

39 
	~"∑ckë_mosq.h
"

40 
	~"sys_åì.h
"

41 
	~"utû_mosq.h
"

43 
	~<°dlib.h
>

44 
	~<î∫o.h
>

45 
	~<sys/°©.h
>

47 #i‚de‡
WIN32


48 
	~<sys/sockë.h
>

54 
	#WS_SERV_BUF_SIZE
 4096

	)

55 
	#WS_TX_BUF_SIZE
 (
WS_SERV_BUF_SIZE
*2)

	)

57 
mosquôto_db
 
öt_db
;

59 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

60 
ˇŒback_mqâ
(

62 
ˇŒback_mqâ
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

64 
libwebsockë
 *
wsi
,

65 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

66 *
u£r
,

67 *
ö
,

68 
size_t
 
Àn
);

70 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

71 
ˇŒback_hâp
(

73 
ˇŒback_hâp
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

75 
libwebsockë
 *
wsi
,

76 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

77 *
u£r
,

78 *
ö
,

79 
size_t
 
Àn
);

81 
	emosq_ws_¥Ÿocﬁs
 {

82 
PROTOCOL_HTTP
 = 0,

83 
PROTOCOL_MQTT
,

84 
DEMO_PROTOCOL_COUNT


87 
	slibws_hâp_d©a
 {

88 
FILE
 *
Âå
;

91 
libwebsockë_¥Ÿocﬁs
 
¥Ÿocﬁs
[] = {

95 
ˇŒback_hâp
,

96  (
libws_hâp_d©a
),

98 #i‚de‡
LWS_LIBRARY_VERSION_NUMBER


101 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


104 #ifde‡
LWS_LIBRARY_VERSION_NUMBER


105 
NULL
,

106 #i‡
LWS_LIBRARY_VERSION_NUMBER
 >= 2003000

107 
WS_TX_BUF_SIZE


113 
ˇŒback_mqâ
,

114 (
libws_mqâ_d©a
),

116 #i‚de‡
LWS_LIBRARY_VERSION_NUMBER


119 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


122 #ifde‡
LWS_LIBRARY_VERSION_NUMBER


123 
NULL
,

124 #i‡
LWS_LIBRARY_VERSION_NUMBER
 >= 2003000

125 
WS_TX_BUF_SIZE


131 
ˇŒback_mqâ
,

132 (
libws_mqâ_d©a
),

134 #i‚de‡
LWS_LIBRARY_VERSION_NUMBER


137 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


140 #ifde‡
LWS_LIBRARY_VERSION_NUMBER


141 
NULL
,

142 #i‡
LWS_LIBRARY_VERSION_NUMBER
 >= 2003000

143 
WS_TX_BUF_SIZE


148 
NULL
,

149 
NULL
,

152 #i‚de‡
LWS_LIBRARY_VERSION_NUMBER


155 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


158 #ifde‡
LWS_LIBRARY_VERSION_NUMBER


159 
NULL
,

160 #i‡
LWS_LIBRARY_VERSION_NUMBER
 >= 2003000

167 
	$ósy_addªss
(
sock
, 
mosquôto
 *
mosq
)

169 
addªss
[1024];

171 if(!
	`√t__sockë_gë_addªss
(
sock
, 
addªss
, 1024)){

172 
mosq
->
addªss
 = 
	`mosquôto__°rdup
(address);

174 
	}
}

176 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

177 
ˇŒback_mqâ
(

179 
ˇŒback_mqâ
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

181 
libwebsockë
 *
wsi
,

182 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

183 *
u£r
,

184 *
ö
,

185 
size_t
 
Àn
)

187 
mosquôto_db
 *
db
;

188 
mosquôto
 *
mosq
 = 
NULL
;

189 
mosquôto__∑ckë
 *
∑ckë
;

190 
size_t
 
txÀn
;

191 
cou¡
;

192 c⁄° 
libwebsockë_¥Ÿocﬁs
 *
p
;

193 
libws_mqâ_d©a
 *
u
 = (libws_mqâ_d©®*)
u£r
;

194 
size_t
 
pos
;

195 
uöt8_t
 *
buf
;

196 
rc
;

197 
uöt8_t
 
byã
;

199 
db
 = &
öt_db
;

201 
ªas⁄
) {

202 
LWS_CALLBACK_ESTABLISHED
:

203 
mosq
 = 
c⁄ãxt__öô
(
db
, 
WEBSOCKET_CLIENT
);

204 if(
mosq
){

205 
p
 = 
libwebsockës_gë_¥Ÿocﬁ
(
wsi
);

206 
mosq
->
li°íî
 = 
p
->
u£r
;

207 if(!
mosq
->
li°íî
){

208 
mosquôto__‰ì
(
mosq
);

211 #i‡!
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

212 
mosq
->
ws_c⁄ãxt
 = 
c⁄ãxt
;

214 
mosq
->
wsi
 = wsi;

215 #ifde‡
WITH_TLS


216 if(
ö
){

217 
mosq
->
s¶
 = (
SSL
 *)
ö
;

218 if(!
mosq
->
li°íî
->
s¶_˘x
){

219 
mosq
->
li°íî
->
s¶_˘x
 = 
SSL_gë_SSL_CTX
(mosq->
s¶
);

223 
u
->
mosq
 = mosq;

227 
ósy_addªss
(
libwebsockë_gë_sockë_fd
(
wsi
), 
mosq
);

228 if(!
mosq
->
addªss
){

230 
mosquôto__‰ì
(
mosq
);

231 
u
->
mosq
 = 
NULL
;

234 if(
mosq
->
li°íî
->
max_c⁄√˘i⁄s
 > 0 && mosq->li°íî->
˛õ¡_cou¡
 > mosq->listener->max_connections){

235 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

236 
log__¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ c⁄√˘i⁄ from %†díõd: max_c⁄√˘i⁄†ex˚eded.", 
mosq
->
addªss
);

238 
mosquôto__‰ì
(
mosq
->
addªss
);

239 
mosquôto__‰ì
(
mosq
);

240 
u
->
mosq
 = 
NULL
;

243 
mosq
->
sock
 = 
libwebsockë_gë_sockë_fd
(
wsi
);

244 
HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
mosq
->sock), mosq);

247 
LWS_CALLBACK_CLOSED
:

248 if(!
u
){

251 
mosq
 = 
u
->mosq;

252 if(
mosq
){

253 if(
mosq
->
sock
 !
INVALID_SOCKET
){

254 
HASH_DELETE
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
mosq
);

255 
mosq
->
sock
 = 
INVALID_SOCKET
;

256 
mosq
->
pﬁlfd_ödex
 = -1;

258 
mosq
->
wsi
 = 
NULL
;

259 #ifde‡
WITH_TLS


260 
mosq
->
s¶
 = 
NULL
;

262 
do_disc⁄√˘
(
db
, 
mosq
, 
MOSQ_ERR_CONN_LOST
);

266 
LWS_CALLBACK_SERVER_WRITEABLE
:

267 if(!
u
){

270 
mosq
 = 
u
->mosq;

271 if(!
mosq
){

275 
db__mesßge_wrôe
(
db
, 
mosq
);

277 if(
mosq
->
out_∑ckë
 && !mosq->
cuºít_out_∑ckë
){

278 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

279 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

280 if(!
mosq
->
out_∑ckë
){

281 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

285 if(
mosq
->
cuºít_out_∑ckë
 && !
lws_£nd_pùe_choked
(mosq->
wsi
)){

286 
∑ckë
 = 
mosq
->
cuºít_out_∑ckë
;

288 if(
∑ckë
->
pos
 =0 &&Öackë->
to_¥o˚ss
 =∑ckë->
∑ckë_Àngth
){

295 
memmove
(&
∑ckë
->
∑ylﬂd
[
LWS_SEND_BUFFER_PRE_PADDING
],Öackë->∑ylﬂd,Öackë->
∑ckë_Àngth
);

296 
∑ckë
->
pos
 +
LWS_SEND_BUFFER_PRE_PADDING
;

298 if(
∑ckë
->
to_¥o˚ss
 > 
WS_TX_BUF_SIZE
){

299 
txÀn
 = 
WS_TX_BUF_SIZE
;

301 
txÀn
 = 
∑ckë
->
to_¥o˚ss
;

303 
cou¡
 = 
libwebsockë_wrôe
(
wsi
, &
∑ckë
->
∑ylﬂd
[∑ckë->
pos
], 
txÀn
, 
LWS_WRITE_BINARY
);

304 if(
cou¡
 < 0){

305 i‡(
mosq
->
°©e
 =
mosq_cs_disc⁄√˘_ws
 || mosq->°©ê=
mosq_cs_disc⁄√˘ög
){

310 #ifde‡
WITH_SYS_TREE


311 
g_byãs_£¡
 +
cou¡
;

313 
∑ckë
->
to_¥o˚ss
 -
cou¡
;

314 
∑ckë
->
pos
 +
cou¡
;

315 if(
∑ckë
->
to_¥o˚ss
 > 0){

316 i‡(
mosq
->
°©e
 =
mosq_cs_disc⁄√˘_ws
 || mosq->°©ê=
mosq_cs_disc⁄√˘ög
){

322 #ifde‡
WITH_SYS_TREE


323 
g_msgs_£¡
++;

324 if(((
∑ckë
->
comm™d
)&0xF6Ë=
CMD_PUBLISH
){

325 
g_pub_msgs_£¡
++;

330 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

331 if(
mosq
->
out_∑ckë
){

332 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

333 if(!
mosq
->
out_∑ckë
){

334 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

338 
∑ckë__˛ónup
(
∑ckë
);

339 
mosquôto__‰ì
(
∑ckë
);

341 
mosq
->
√xt_msg_out
 = 
mosquôto_time
(Ë+ mosq->
kì∑live
;

343 i‡(
mosq
->
°©e
 =
mosq_cs_disc⁄√˘_ws
 || mosq->°©ê=
mosq_cs_disc⁄√˘ög
){

346 if(
mosq
->
cuºít_out_∑ckë
){

347 
libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

351 
LWS_CALLBACK_RECEIVE
:

352 if(!
u
 || !u->
mosq
){

355 
mosq
 = 
u
->mosq;

356 
pos
 = 0;

357 
buf
 = (
uöt8_t
 *)
ö
;

358 
G_BYTES_RECEIVED_INC
(
Àn
);

359 
pos
 < 
Àn
){

360 if(!
mosq
->
ö_∑ckë
.
comm™d
){

361 
mosq
->
ö_∑ckë
.
comm™d
 = 
buf
[
pos
];

362 
pos
++;

364 if(
mosq
->
°©e
 =
mosq_cs_√w
 && (mosq->
ö_∑ckë
.
comm™d
&0xF0Ë!
CMD_CONNECT
){

368 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 <= 0){

370 if(
pos
 =
Àn
){

373 
byã
 = 
buf
[
pos
];

374 
pos
++;

376 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
--;

380 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 < -4){

384 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 +(
byã
 & 127Ë* mosq->ö_∑ckë.
ªmaöög_mu…
;

385 
mosq
->
ö_∑ckë
.
ªmaöög_mu…
 *= 128;

386 }(
byã
 & 128) != 0);

387 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 *= -1;

389 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 0){

390 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
mosquôto__mÆloc
(mosq->ö_∑ckë.
ªmaöög_Àngth
*(
uöt8_t
));

391 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

394 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = mosq->ö_∑ckë.
ªmaöög_Àngth
;

397 if(
mosq
->
ö_∑ckë
.
to_¥o˚ss
>0){

398 if(
Àn
 - 
pos
 >
mosq
->
ö_∑ckë
.
to_¥o˚ss
){

399 
mem˝y
(&
mosq
->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
], &
buf
[pos], mosq->ö_∑ckë.
to_¥o˚ss
);

400 
mosq
->
ö_∑ckë
.
pos
 +mosq->ö_∑ckë.
to_¥o˚ss
;

401 
pos
 +
mosq
->
ö_∑ckë
.
to_¥o˚ss
;

402 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = 0;

404 
mem˝y
(&
mosq
->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
], &
buf
[pos], 
Àn
-pos);

405 
mosq
->
ö_∑ckë
.
pos
 +
Àn
-pos;

406 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
Àn
-
pos
;

411 
mosq
->
ö_∑ckë
.
pos
 = 0;

413 #ifde‡
WITH_SYS_TREE


414 
G_MSGS_RECEIVED_INC
(1);

415 if(((
mosq
->
ö_∑ckë
.
comm™d
)&0xF5Ë=
CMD_PUBLISH
){

416 
G_PUB_MSGS_RECEIVED_INC
(1);

419 
rc
 = 
h™dÀ__∑ckë
(
db
, 
mosq
);

422 
∑ckë__˛ónup
(&
mosq
->
ö_∑ckë
);

424 
mosq
->
œ°_msg_ö
 = 
mosquôto_time
();

426 if(
rc
 && (
mosq
->
out_∑ckë
 || mosq->
cuºít_out_∑ckë
)) {

427 if(
mosq
->
°©e
 !
mosq_cs_disc⁄√˘ög
){

428 
mosquôto__£t_°©e
(
mosq
, 
mosq_cs_disc⁄√˘_ws
);

430 
libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

431 } i‡(
rc
) {

432 
do_disc⁄√˘
(
db
, 
mosq
, 
MOSQ_ERR_CONN_LOST
);

446 *
hâp__ˇn⁄iˇl_fûíame
(

447 #i‚de‡
LWS_LIBRARY_VERSION_NUMBER


448 
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

450 
libwebsockë
 *
wsi
,

451 c⁄° *
ö
,

452 c⁄° *
hâp_dú
)

454 
size_t
 
öÀn
, 
¶í
;

455 *
fûíame
, *
fûíame_ˇn⁄iˇl
;

457 
öÀn
 = 
°æí
(
ö
);

458 if(
ö
[
öÀn
-1] == '/'){

459 
¶í
 = 
°æí
(
hâp_dú
Ë+ 
öÀn
 + strlen("/index.html") + 2;

461 
¶í
 = 
°æí
(
hâp_dú
Ë+ 
öÀn
 + 2;

463 
fûíame
 = 
mosquôto__mÆloc
(
¶í
);

464 if(!
fûíame
){

465 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

466  
NULL
;

468 if(((*)
ö
)[
öÀn
-1] == '/'){

469 
¢¥ötf
(
fûíame
, 
¶í
, "%s%södex.html", 
hâp_dú
, (*)
ö
);

471 
¢¥ötf
(
fûíame
, 
¶í
, "%s%s", 
hâp_dú
, (*)
ö
);

476 #ifde‡
WIN32


477 
fûíame_ˇn⁄iˇl
 = 
_fuŒ∑th
(
NULL
, 
fûíame
, 0);

478 
mosquôto__‰ì
(
fûíame
);

479 if(!
fûíame_ˇn⁄iˇl
){

480 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

481  
NULL
;

484 
fûíame_ˇn⁄iˇl
 = 
ªÆ∑th
(
fûíame
, 
NULL
);

485 
mosquôto__‰ì
(
fûíame
);

486 if(!
fûíame_ˇn⁄iˇl
){

487 if(
î∫o
 =
EACCES
){

488 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

489 }if(
î∫o
 =
EINVAL
 ||Éºnÿ=
EIO
 ||Éºnÿ=
ELOOP
){

490 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

491 }if(
î∫o
 =
ENAMETOOLONG
){

492 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_REQ_URI_TOO_LONG
, 
NULL
);

493 }if(
î∫o
 =
ENOENT
 ||Éºnÿ=
ENOTDIR
){

494 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_NOT_FOUND
, 
NULL
);

496  
NULL
;

499 if(
°∫cmp
(
hâp_dú
, 
fûíame_ˇn⁄iˇl
, 
°æí
(http_dir))){

501 
‰ì
(
fûíame_ˇn⁄iˇl
);

502 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

503  
NULL
;

506  
fûíame_ˇn⁄iˇl
;

510 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

511 
ˇŒback_hâp
(

513 
ˇŒback_hâp
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

515 
libwebsockë
 *
wsi
,

516 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

517 *
u£r
,

518 *
ö
,

519 
size_t
 
Àn
)

521 
libws_hâp_d©a
 *
u
 = (libws_hâp_d©®*)
u£r
;

522 
libws_mqâ_hack
 *
hack
;

523 *
hâp_dú
;

524 
size_t
 
buÊí
;

525 
size_t
 
wÀn
;

526 *
fûíame_ˇn⁄iˇl
;

527 
buf
[4096];

528 
°©
 
fûe°©
;

529 
mosquôto_db
 *
db
 = &
öt_db
;

530 
mosquôto
 *
mosq
;

531 
lws_pﬁœrgs
 *
pﬁœrgs
 = (lws_pﬁœrg†*)
ö
;

535 
ªas⁄
) {

536 
LWS_CALLBACK_HTTP
:

537 if(!
u
){

541 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

542 
hack
 = (
libws_mqâ_hack
 *)
lws_c⁄ãxt_u£r
(
lws_gë_c⁄ãxt
(
wsi
));

544 
hack
 = (
libws_mqâ_hack
 *)
libwebsockë_c⁄ãxt_u£r
(
c⁄ãxt
);

546 if(!
hack
){

549 
hâp_dú
 = 
hack
->http_dir;

551 if(!
hâp_dú
){

557 if(
lws_hdr_tŸÆ_Àngth
(
wsi
, 
WSI_TOKEN_POST_URI
)){

558 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_METHOD_NOT_ALLOWED
, 
NULL
);

562 #i‡
deföed
(
LWS_LIBRARY_VERSION_NUMBER
)

563 
fûíame_ˇn⁄iˇl
 = 
hâp__ˇn⁄iˇl_fûíame
(
wsi
, (*)
ö
, 
hâp_dú
);

565 
fûíame_ˇn⁄iˇl
 = 
hâp__ˇn⁄iˇl_fûíame
(
c⁄ãxt
, 
wsi
, (*)
ö
, 
hâp_dú
);

567 if(!
fûíame_ˇn⁄iˇl
)  -1;

569 
u
->
Âå
 = 
f›í
(
fûíame_ˇn⁄iˇl
, "rb");

570 if(!
u
->
Âå
){

571 
‰ì
(
fûíame_ˇn⁄iˇl
);

572 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_NOT_FOUND
, 
NULL
);

575 if(
f°©
(
fûío
(
u
->
Âå
), &
fûe°©
) < 0){

576 
‰ì
(
fûíame_ˇn⁄iˇl
);

577 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

578 
f˛o£
(
u
->
Âå
);

579 
u
->
Âå
 = 
NULL
;

584 if((
fûe°©
.
°_mode
 & 
S_IFDIR
) == S_IFDIR){

585 
f˛o£
(
u
->
Âå
);

586 
u
->
Âå
 = 
NULL
;

587 
‰ì
(
fûíame_ˇn⁄iˇl
);

590 
buÊí
 = 
¢¥ötf
((*)
buf
, 4096, "HTTP/1.0 302 OK\r\n"

592 (*)
ö
);

593  
libwebsockë_wrôe
(
wsi
, 
buf
, 
buÊí
, 
LWS_WRITE_HTTP
);

596 if((
fûe°©
.
°_mode
 & 
S_IFREG
) != S_IFREG){

597 
libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

598 
f˛o£
(
u
->
Âå
);

599 
u
->
Âå
 = 
NULL
;

600 
‰ì
(
fûíame_ˇn⁄iˇl
);

604 
log__¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "hâ∞£rvög fûê\"%s\".", 
fûíame_ˇn⁄iˇl
);

605 
‰ì
(
fûíame_ˇn⁄iˇl
);

607 
buÊí
 = 
¢¥ötf
((*)
buf
, 4096, "HTTP/1.0 200 OK\r\n"

610 ()
fûe°©
.
°_size
);

611 if(
libwebsockë_wrôe
(
wsi
, 
buf
, 
buÊí
, 
LWS_WRITE_HTTP
) < 0){

612 
f˛o£
(
u
->
Âå
);

613 
u
->
Âå
 = 
NULL
;

616 
libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
, 
wsi
);

619 
LWS_CALLBACK_HTTP_BODY
:

623 
LWS_CALLBACK_HTTP_BODY_COMPLETION
:

627 
LWS_CALLBACK_FILTER_HTTP_CONNECTION
:

631 
LWS_CALLBACK_HTTP_WRITEABLE
:

633 if(
u
 && u->
Âå
){

635 
buÊí
 = 
‰ód
(
buf
, 1, (buf), 
u
->
Âå
);

636 if(
buÊí
 < 1){

637 
f˛o£
(
u
->
Âå
);

638 
u
->
Âå
 = 
NULL
;

641 
wÀn
 = 
libwebsockë_wrôe
(
wsi
, 
buf
, 
buÊí
, 
LWS_WRITE_HTTP
);

642 if(
wÀn
 < 
buÊí
){

643 if(
f£ek
(
u
->
Âå
, 
buÊí
-
wÀn
, 
SEEK_CUR
) < 0){

644 
f˛o£
(
u
->
Âå
);

645 
u
->
Âå
 = 
NULL
;

649 if(
buÊí
 < (
buf
)){

650 
f˛o£
(
u
->
Âå
);

651 
u
->
Âå
 = 
NULL
;

654 }
u
->
Âå
 && !
lws_£nd_pùe_choked
(
wsi
));

655 
libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
, 
wsi
);

661 
LWS_CALLBACK_CLOSED
:

662 
LWS_CALLBACK_CLOSED_HTTP
:

663 
LWS_CALLBACK_HTTP_FILE_COMPLETION
:

664 if(
u
 && u->
Âå
){

665 
f˛o£
(
u
->
Âå
);

666 
u
->
Âå
 = 
NULL
;

670 
LWS_CALLBACK_ADD_POLL_FD
:

671 
LWS_CALLBACK_DEL_POLL_FD
:

672 
LWS_CALLBACK_CHANGE_MODE_POLL_FD
:

673 
HASH_FIND
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, &
pﬁœrgs
->
fd
, ’ﬁœrgs->fd), 
mosq
);

674 if(
mosq
 && (
pﬁœrgs
->
evíts
 & 
POLLOUT
)){

675 
mosq
->
ws_w™t_wrôe
 = 
åue
;

679 #ifde‡
WITH_TLS


680 
LWS_CALLBACK_OPENSSL_PERFORM_CLIENT_CERT_VERIFICATION
:

681 if(!
Àn
 || (
SSL_gë_vîify_ªsu…
((
SSL
*)
ö
Ë!
X509_V_OK
)){

694 
	$log_wøp
(
Àvñ
, c⁄° *
löe
)

696 *
l
 = (*)
löe
;

697 
l
[
	`°æí
(
löe
)-1] = '\0';

698 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_WEBSOCKETS
, "%s", 
l
);

699 
	}
}

701 
libwebsockë_c⁄ãxt
 *
	$mosq_websockës_öô
(
mosquôto__li°íî
 *
li°íî
, c⁄° 
mosquôto__c⁄fig
 *
c⁄f
)

703 
lws_c⁄ãxt_¸óti⁄_öfo
 
öfo
;

704 
libwebsockë_¥Ÿocﬁs
 *
p
;

705 
¥Ÿocﬁ_cou¡
;

706 
i
;

707 
libws_mqâ_hack
 *
u£r
;

710 
¥Ÿocﬁ_cou¡
=0; 
¥Ÿocﬁs
[¥Ÿocﬁ_cou¡].
«me
;Örotocol_count++);

712 
p
 = 
	`mosquôto__ˇŒoc
(
¥Ÿocﬁ_cou¡
+1, (
libwebsockë_¥Ÿocﬁs
));

713 if(!
p
){

714 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Out of memory.");

715  
NULL
;

717 
i
=0; 
¥Ÿocﬁs
[i].
«me
; i++){

718 
p
[
i
].
«me
 = 
¥Ÿocﬁs
[i].name;

719 
p
[
i
].
ˇŒback
 = 
¥Ÿocﬁs
[i].callback;

720 
p
[
i
].
≥r_£ssi⁄_d©a_size
 = 
¥Ÿocﬁs
[i].per_session_data_size;

721 
p
[
i
].
rx_buf„r_size
 = 
¥Ÿocﬁs
[i].rx_buffer_size;

722 
p
[
i
].
u£r
 = 
li°íî
;

725 
	`mem£t
(&
öfo
, 0, (info));

726 
öfo
.
iÁ˚
 = 
li°íî
->
ho°
;

727 
öfo
.
p‹t
 = 
li°íî
->port;

728 
öfo
.
¥Ÿocﬁs
 = 
p
;

729 
öfo
.
gid
 = -1;

730 
öfo
.
uid
 = -1;

731 #ifde‡
WITH_TLS


732 
öfo
.
s¶_ˇ_fûï©h
 = 
li°íî
->
ˇfûe
;

733 
öfo
.
s¶_˚π_fûï©h
 = 
li°íî
->
˚πfûe
;

734 
öfo
.
s¶_¥iv©e_key_fûï©h
 = 
li°íî
->
keyfûe
;

735 
öfo
.
s¶_cùhî_li°
 = 
li°íî
->
cùhîs
;

736 if(
li°íî
->
ªquúe_˚πifiˇã
){

737 
öfo
.
›ti⁄s
 |
LWS_SERVER_OPTION_REQUIRE_VALID_OPENSSL_CLIENT_CERT
;

741 #i‡
LWS_LIBRARY_VERSION_MAJOR
>1

742 
öfo
.
›ti⁄s
 |
LWS_SERVER_OPTION_DO_SSL_GLOBAL_INIT
;

744 if(
li°íî
->
sockë_domaö
 =
AF_INET
){

745 
öfo
.
›ti⁄s
 |
LWS_SERVER_OPTION_DISABLE_IPV6
;

747 #i‡
	`deföed
(
LWS_LIBRARY_VERSION_NUMBER
) && LWS_LIBRARY_VERSION_NUMBER>=1007000

748 
öfo
.
max_hâp_hódî_d©a
 = 
c⁄f
->
websockës_hódîs_size
;

751 
u£r
 = 
	`mosquôto__ˇŒoc
(1, (
libws_mqâ_hack
));

752 if(!
u£r
){

753 
	`mosquôto__‰ì
(
p
);

754 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Out of memory.");

755  
NULL
;

758 if(
li°íî
->
hâp_dú
){

759 #ifde‡
WIN32


760 
u£r
->
hâp_dú
 = 
	`_fuŒ∑th
(
NULL
, 
li°íî
->http_dir, 0);

762 
u£r
->
hâp_dú
 = 
	`ªÆ∑th
(
li°íî
->hâp_dú, 
NULL
);

764 if(!
u£r
->
hâp_dú
){

765 
	`mosquôto__‰ì
(
u£r
);

766 
	`mosquôto__‰ì
(
p
);

767 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í hâ∞dú \"%s\".", 
li°íî
->
hâp_dú
);

768  
NULL
;

772 
öfo
.
u£r
 = user;

773 #i‡
	`deföed
(
LWS_LIBRARY_VERSION_NUMBER
) && LWS_LIBRARY_VERSION_NUMBER>=2004000

774 
öfo
.
±_£rv_buf_size
 = 
WS_SERV_BUF_SIZE
;

776 
li°íî
->
ws_¥Ÿocﬁ
 = 
p
;

778 
	`lws_£t_log_Àvñ
(
c⁄f
->
websockës_log_Àvñ
, 
log_wøp
);

780 
	`log__¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög websockë†li°í sockë o¿p‹à%d.", 
li°íî
->
p‹t
);

781  
	`libwebsockë_¸óã_c⁄ãxt
(&
öfo
);

782 
	}
}

	@src/will_delay.c

17 
	~"c⁄fig.h
"

19 
	~<m©h.h
>

20 
	~<°dio.h
>

21 
	~<uéi°.h
>

23 
	~"mosquôto_brokî_öã∫Æ.h
"

24 
	~"mem‹y_mosq.h
"

25 
	~"time_mosq.h
"

27 
wûl_dñay_li°
 *
	gdñay_li°
 = 
NULL
;

28 
time_t
 
	gœ°_check
 = 0;

31 
	$wûl_dñay__cmp
(
wûl_dñay_li°
 *
i1
, wûl_dñay_li° *
i2
)

33  
i1
->
c⁄ãxt
->
wûl_dñay_öãrvÆ
 - 
i2
->context->will_delay_interval;

34 
	}
}

37 
	$wûl_dñay__add
(
mosquôto
 *
c⁄ãxt
)

39 
wûl_dñay_li°
 *
ôem
;

41 
ôem
 = 
	`mosquôto__ˇŒoc
(1, (
wûl_dñay_li°
));

42 if(!
ôem
Ë 
MOSQ_ERR_NOMEM
;

44 
ôem
->
c⁄ãxt
 = context;

45 
c⁄ãxt
->
wûl_dñay_íåy
 = 
ôem
;

46 
ôem
->
c⁄ãxt
->
wûl_dñay_time
 = 
	`time
(
NULL
Ë+ iãm->c⁄ãxt->
wûl_dñay_öãrvÆ
;

48 
	`DL_INSERT_INORDER
(
dñay_li°
, 
ôem
, 
wûl_dñay__cmp
);

50  
MOSQ_ERR_SUCCESS
;

51 
	}
}

55 
	$wûl_dñay__£nd_Æl
(
mosquôto_db
 *
db
)

57 
wûl_dñay_li°
 *
ôem
, *
tmp
;

59 
	`DL_FOREACH_SAFE
(
dñay_li°
, 
ôem
, 
tmp
){

60 
	`DL_DELETE
(
dñay_li°
, 
ôem
);

61 
ôem
->
c⁄ãxt
->
wûl_dñay_öãrvÆ
 = 0;

62 
ôem
->
c⁄ãxt
->
wûl_dñay_íåy
 = 
NULL
;

63 
	`c⁄ãxt__£nd_wûl
(
db
, 
ôem
->
c⁄ãxt
);

64 
	`mosquôto__‰ì
(
ôem
);

67 
	}
}

69 
	$wûl_dñay__check
(
mosquôto_db
 *
db
, 
time_t
 
now
)

71 
wûl_dñay_li°
 *
ôem
, *
tmp
;

73 if(
now
 <
œ°_check
) ;

75 
œ°_check
 = 
now
;

77 
	`DL_FOREACH_SAFE
(
dñay_li°
, 
ôem
, 
tmp
){

78 if(
ôem
->
c⁄ãxt
->
wûl_dñay_time
 < 
now
){

79 
	`DL_DELETE
(
dñay_li°
, 
ôem
);

80 
ôem
->
c⁄ãxt
->
wûl_dñay_öãrvÆ
 = 0;

81 
ôem
->
c⁄ãxt
->
wûl_dñay_íåy
 = 
NULL
;

82 
	`c⁄ãxt__£nd_wûl
(
db
, 
ôem
->
c⁄ãxt
);

83 if(
ôem
->
c⁄ãxt
->
£ssi⁄_expúy_öãrvÆ
 == 0){

84 
	`c⁄ãxt__add_to_disu£d
(
db
, 
ôem
->
c⁄ãxt
);

86 
	`mosquôto__‰ì
(
ôem
);

92 
	}
}

95 
	$wûl_dñay__ªmove
(
mosquôto
 *
mosq
)

97 if(
mosq
->
wûl_dñay_íåy
 !
NULL
){

98 
	`DL_DELETE
(
dñay_li°
, 
mosq
->
wûl_dñay_íåy
);

99 
	`mosquôto__‰ì
(
mosq
->
wûl_dñay_íåy
);

100 
mosq
->
wûl_dñay_íåy
 = 
NULL
;

102 
	}
}

	@test/broker/c/08-tls-psk-bridge.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<mosquôto.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
;

11 
	$⁄_log
(
mosquôto
 *
mosq
, *
obj
, 
Àvñ
, c⁄° *
°r
)

13 
	`¥ötf
("%s\n", 
°r
);

14 
	}
}

16 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

18 if(
rc
){

19 
	`exô
(1);

21 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "psk/ã°", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

23 
	}
}

25 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

27 if(
mid
 =
£¡_mid
){

28 
	`mosquôto_disc⁄√˘
(
mosq
);

29 
run
 = 0;

31 
	`exô
(1);

33 
	}
}

35 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

37 
run
 = 
rc
;

38 
	}
}

40 
	$maö
(
¨gc
, *
¨gv
[])

42 
rc
;

43 
mosquôto
 *
mosq
;

44 
p‹t
;

46 
p‹t
 = 
	`©oi
(
¨gv
[1]);

48 
	`mosquôto_lib_öô
();

50 
mosq
 = 
	`mosquôto_√w
("08-és-psk-bridge", 
åue
, 
NULL
);

51 
	`mosquôto_és_›ts_£t
(
mosq
, 1, "ésv1", 
NULL
);

52 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

53 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

54 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

55 
	`mosquôto_log_ˇŒback_£t
(
mosq
, 
⁄_log
);

57 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

58 if(
rc
) Ñc;

60 
run
 == -1){

61 
	`mosquôto_lo›
(
mosq
, -1, 1);

64 
	`mosquôto_lib_˛ónup
();

65  
run
;

66 
	}
}

	@test/broker/c/08-tls-psk-pub.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<mosquôto.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 if(
rc
){

14 
	`exô
(1);

16 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "psk/ã°", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
);

18 
	}
}

20 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

22 if(
mid
 =
£¡_mid
){

23 
	`mosquôto_disc⁄√˘
(
mosq
);

24 
run
 = 0;

26 
	`exô
(1);

28 
	}
}

30 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

32 
run
 = 
rc
;

33 
	}
}

35 
	$maö
(
¨gc
, *
¨gv
[])

37 
rc
;

38 
p‹t
;

39 
mosquôto
 *
mosq
;

41 
	`mosquôto_lib_öô
();

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
mosq
 = 
	`mosquôto_√w
("08-és-psk-pub", 
åue
, 
NULL
);

46 
	`mosquôto_és_›ts_£t
(
mosq
, 1, "ésv1", 
NULL
);

47 
rc
 = 
	`mosquôto_és_psk_£t
(
mosq
, "dódbìf", "psk-id", 
NULL
);

48 if(
rc
){

49 
	`mosquôto_de°roy
(
mosq
);

50  
rc
;

52 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

53 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

54 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

56 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

57 if(
rc
){

58 
	`mosquôto_de°roy
(
mosq
);

59  
rc
;

62 
run
 == -1){

63 
	`mosquôto_lo›
(
mosq
, -1, 1);

66 
	`mosquôto_de°roy
(
mosq
);

68 
	`mosquôto_lib_˛ónup
();

69  
run
;

70 
	}
}

	@test/broker/c/auth_plugin.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mosquôto.h
>

4 
	~<mosquôto_brokî.h
>

5 
	~<mosquôto_∂ugö.h
>

7 
	$mosquôto_auth_∂ugö_vîsi⁄
()

9  
MOSQ_AUTH_PLUGIN_VERSION
;

10 
	}
}

12 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

14  
MOSQ_ERR_SUCCESS
;

15 
	}
}

17 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

19  
MOSQ_ERR_SUCCESS
;

20 
	}
}

22 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

24  
MOSQ_ERR_SUCCESS
;

25 
	}
}

27 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

29  
MOSQ_ERR_SUCCESS
;

30 
	}
}

32 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

34 c⁄° *
u£∫ame
 = 
	`mosquôto_˛õ¡_u£∫ame
(
˛õ¡
);

36 if(
u£∫ame
 && !
	`°rcmp
(u£∫ame, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_READ
){

37  
MOSQ_ERR_SUCCESS
;

38 }if(
u£∫ame
 && !
	`°rcmp
(u£∫ame, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
 &&!
	`°rchr
(
msg
->
t›ic
, '#') && !strchr(msg->topic, '+')) {

39  
MOSQ_ERR_SUCCESS
;

40 }if(
u£∫ame
 && !
	`°rcmp
(username, "readwrite")){

41 if((!
	`°rcmp
(
msg
->
t›ic
, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_READ
)

42 || !
	`°rcmp
(
msg
->
t›ic
, "writeable")){

44  
MOSQ_ERR_SUCCESS
;

46  
MOSQ_ERR_ACL_DENIED
;

50  
MOSQ_ERR_ACL_DENIED
;

52 
	}
}

54 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

56 if(!
	`°rcmp
(
u£∫ame
, "ã°-u£∫ame"Ë&& 
∑ssw‹d
 && !strcmp(password, "cnwTICONIURW")){

57  
MOSQ_ERR_SUCCESS
;

58 }if(!
	`°rcmp
(
u£∫ame
, "readonly") || !strcmp(username, "readwrite")){

59  
MOSQ_ERR_SUCCESS
;

60 }if(!
	`°rcmp
(
u£∫ame
, "test-username@v2")){

61  
MOSQ_ERR_PLUGIN_DEFER
;

63  
MOSQ_ERR_AUTH
;

65 
	}
}

67 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

69  
MOSQ_ERR_AUTH
;

70 
	}
}

	@test/broker/c/auth_plugin_acl.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mosquôto.h
>

4 
	~<mosquôto_brokî.h
>

5 
	~<mosquôto_∂ugö.h
>

7 
	$mosquôto_auth_∂ugö_vîsi⁄
()

9  
MOSQ_AUTH_PLUGIN_VERSION
;

10 
	}
}

12 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

14  
MOSQ_ERR_SUCCESS
;

15 
	}
}

17 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

19  
MOSQ_ERR_SUCCESS
;

20 
	}
}

22 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

24  
MOSQ_ERR_SUCCESS
;

25 
	}
}

27 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

29  
MOSQ_ERR_SUCCESS
;

30 
	}
}

32 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

34 c⁄° *
u£∫ame
 = 
	`mosquôto_˛õ¡_u£∫ame
(
˛õ¡
);

36 if(
u£∫ame
 && !
	`°rcmp
(u£∫ame, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_READ
){

37  
MOSQ_ERR_SUCCESS
;

38 }if(
u£∫ame
 && !
	`°rcmp
(u£∫ame, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
 &&!
	`°rchr
(
msg
->
t›ic
, '#') && !strchr(msg->topic, '+')) {

39  
MOSQ_ERR_SUCCESS
;

41  
MOSQ_ERR_ACL_DENIED
;

43 
	}
}

45 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

47  
MOSQ_ERR_PLUGIN_DEFER
;

48 
	}
}

50 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

52  
MOSQ_ERR_AUTH
;

53 
	}
}

	@test/broker/c/auth_plugin_acl_sub_denied.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mosquôto.h
>

4 
	~<mosquôto_brokî.h
>

5 
	~<mosquôto_∂ugö.h
>

7 
	$mosquôto_auth_∂ugö_vîsi⁄
()

9  
MOSQ_AUTH_PLUGIN_VERSION
;

10 
	}
}

12 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

14  
MOSQ_ERR_SUCCESS
;

15 
	}
}

17 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

19  
MOSQ_ERR_SUCCESS
;

20 
	}
}

22 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

24  
MOSQ_ERR_SUCCESS
;

25 
	}
}

27 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

29  
MOSQ_ERR_SUCCESS
;

30 
	}
}

32 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

34 if(
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
){

35  
MOSQ_ERR_ACL_DENIED
;

37  
MOSQ_ERR_SUCCESS
;

39 
	}
}

41 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

43  
MOSQ_ERR_SUCCESS
;

44 
	}
}

46 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

48  
MOSQ_ERR_AUTH
;

49 
	}
}

	@test/broker/c/auth_plugin_context_params.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15  
MOSQ_ERR_SUCCESS
;

16 
	}
}

18 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

20  
MOSQ_ERR_SUCCESS
;

21 
	}
}

23 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

25  
MOSQ_ERR_SUCCESS
;

26 
	}
}

28 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

30  
MOSQ_ERR_SUCCESS
;

31 
	}
}

33 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

35  
MOSQ_ERR_PLUGIN_DEFER
;

36 
	}
}

38 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

40 c⁄° *
tmp
;

42 
tmp
 = 
	`mosquôto_˛õ¡_addªss
(
˛õ¡
);

43 if(!
tmp
 || 
	`°rcmp
(tmp, "127.0.0.1")){

44  
MOSQ_ERR_AUTH
;

47 if(!
	`mosquôto_˛õ¡_˛ón_£ssi⁄
(
˛õ¡
)){

48 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_check cÀ™_£ssi⁄Éº‹: %d\n", 
	`mosquôto_˛õ¡_˛ón_£ssi⁄
(
˛õ¡
));

49  
MOSQ_ERR_AUTH
;

52 
tmp
 = 
	`mosquôto_˛õ¡_id
(
˛õ¡
);

53 if(!
tmp
 || 
	`°rcmp
(tmp, "client-params-test")){

54 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_check clõ¡_idÉº‹: %s\n", 
tmp
);

55  
MOSQ_ERR_AUTH
;

58 if(
	`mosquôto_˛õ¡_kì∑live
(
˛õ¡
) != 42){

59 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_check kì∑livêîr‹: %d\n", 
	`mosquôto_˛õ¡_kì∑live
(
˛õ¡
));

60  
MOSQ_ERR_AUTH
;

63 if(!
	`mosquôto_˛õ¡_˚πifiˇã
(
˛õ¡
)){

68 if(
	`mosquôto_˛õ¡_¥Ÿocﬁ
(
˛õ¡
) != 2){

69 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_checkÖrŸocﬁÉº‹: %d\n", 
	`mosquôto_˛õ¡_¥Ÿocﬁ
(
˛õ¡
));

70  
MOSQ_ERR_AUTH
;

73 if(
	`mosquôto_˛õ¡_sub_cou¡
(
˛õ¡
)){

74 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_check sub_cou¡Éº‹: %d\n", 
	`mosquôto_˛õ¡_sub_cou¡
(
˛õ¡
));

75  
MOSQ_ERR_AUTH
;

78 
tmp
 = 
	`mosquôto_˛õ¡_u£∫ame
(
˛õ¡
);

79 if(!
tmp
 || 
	`°rcmp
(tmp, "client-username")){

80 
	`Ârötf
(
°dîr
, "mosquôto_auth_u≈wd_check u£∫amêîr‹: %s\n", 
tmp
);

81  
MOSQ_ERR_AUTH
;

84  
MOSQ_ERR_SUCCESS
;

85 
	}
}

87 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

89  
MOSQ_ERR_AUTH
;

90 
	}
}

	@test/broker/c/auth_plugin_extended_multiple.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15  
MOSQ_ERR_SUCCESS
;

16 
	}
}

18 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

20  
MOSQ_ERR_SUCCESS
;

21 
	}
}

23 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

25  
MOSQ_ERR_SUCCESS
;

26 
	}
}

28 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

30  
MOSQ_ERR_SUCCESS
;

31 
	}
}

33 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

35  
MOSQ_ERR_PLUGIN_DEFER
;

36 
	}
}

39 
	$mosquôto_auth_°¨t
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, 
boﬁ
 
ªauth
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

41 
i
;

43 if(!
	`°rcmp
(
mëhod
, "mirror")){

44 if(
d©a_Àn
 > 0){

45 *
d©a_out
 = 
	`mÆloc
(
d©a_Àn
);

46 if(!(*
d©a_out
)){

47  
MOSQ_ERR_NOMEM
;

49 
i
=0; i<
d©a_Àn
; i++){

50 ((
uöt8_t
 *)(*
d©a_out
))[
i
] = ((uöt8_à*)
d©a
)[
d©a_Àn
-i-1];

52 *
d©a_out_Àn
 = 
d©a_Àn
;

54  
MOSQ_ERR_AUTH_CONTINUE
;

56  
MOSQ_ERR_INVAL
;

59  
MOSQ_ERR_NOT_SUPPORTED
;

60 
	}
}

63 
	$mosquôto_auth_c⁄töue
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

65 
Àn
;

67 if(!
	`°rcmp
(
mëhod
, "mirror")){

68 if(
d©a_Àn
 > 0){

69 
Àn
 = 
	`°æí
("su≥rˇli‰agûi°i˚xpülidocious")>
d©a_Àn
?data_len:strlen("supercalifragilisticexpialidocious");

70 if(!
	`memcmp
(
d©a
, "su≥rˇli‰agûi°i˚xpülidocious", 
Àn
)){

71  
MOSQ_ERR_SUCCESS
;

73  
MOSQ_ERR_AUTH
;

76  
MOSQ_ERR_INVAL
;

79  
MOSQ_ERR_NOT_SUPPORTED
;

80 
	}
}

	@test/broker/c/auth_plugin_extended_single.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15  
MOSQ_ERR_SUCCESS
;

16 
	}
}

18 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

20  
MOSQ_ERR_SUCCESS
;

21 
	}
}

23 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

25  
MOSQ_ERR_SUCCESS
;

26 
	}
}

28 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

30  
MOSQ_ERR_SUCCESS
;

31 
	}
}

33 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

35  
MOSQ_ERR_PLUGIN_DEFER
;

36 
	}
}

39 
	$mosquôto_auth_°¨t
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, 
boﬁ
 
ªauth
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

41 
i
;

43 if(!
	`°rcmp
(
mëhod
, "error")){

44  
MOSQ_ERR_INVAL
;

45 }if(!
	`°rcmp
(
mëhod
, "non-matching")){

46  
MOSQ_ERR_NOT_SUPPORTED
;

47 }if(!
	`°rcmp
(
mëhod
, "single")){

48 
d©a_Àn
 = d©a_Àn>
	`°æí
("data")?strlen("data"):data_len;

49 if(!
	`memcmp
(
d©a
, "d©a", 
d©a_Àn
)){

50  
MOSQ_ERR_SUCCESS
;

52  
MOSQ_ERR_AUTH
;

54 }if(!
	`°rcmp
(
mëhod
, "change")){

55  
	`mosquôto_£t_u£∫ame
(
˛õ¡
, "new_username");

56 }if(!
	`°rcmp
(
mëhod
, "mirror")){

57 if(
d©a_Àn
 > 0){

58 *
d©a_out
 = 
	`mÆloc
(
d©a_Àn
);

59 if(!(*
d©a_out
)){

60  
MOSQ_ERR_NOMEM
;

62 
i
=0; i<
d©a_Àn
; i++){

63 ((
uöt8_t
 *)(*
d©a_out
))[
i
] = ((uöt8_à*)
d©a
)[
d©a_Àn
-i-1];

65 *
d©a_out_Àn
 = 
d©a_Àn
;

67  
MOSQ_ERR_SUCCESS
;

69  
MOSQ_ERR_INVAL
;

72  
MOSQ_ERR_NOT_SUPPORTED
;

73 
	}
}

75 
	$mosquôto_auth_c⁄töue
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

77  
MOSQ_ERR_AUTH
;

78 
	}
}

	@test/broker/c/auth_plugin_extended_single2.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15  
MOSQ_ERR_SUCCESS
;

16 
	}
}

18 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

20  
MOSQ_ERR_SUCCESS
;

21 
	}
}

23 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

25  
MOSQ_ERR_SUCCESS
;

26 
	}
}

28 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

30  
MOSQ_ERR_SUCCESS
;

31 
	}
}

33 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

35  
MOSQ_ERR_PLUGIN_DEFER
;

36 
	}
}

39 
	$mosquôto_auth_°¨t
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, 
boﬁ
 
ªauth
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

41 
i
;

43 if(!
	`°rcmp
(
mëhod
, "error2")){

44  
MOSQ_ERR_INVAL
;

45 }if(!
	`°rcmp
(
mëhod
, "non-matching2")){

46  
MOSQ_ERR_NOT_SUPPORTED
;

47 }if(!
	`°rcmp
(
mëhod
, "single2")){

48 
d©a_Àn
 = d©a_Àn>
	`°æí
("data")?strlen("data"):data_len;

49 if(!
	`memcmp
(
d©a
, "d©a", 
d©a_Àn
)){

50  
MOSQ_ERR_SUCCESS
;

52  
MOSQ_ERR_AUTH
;

54 }if(!
	`°rcmp
(
mëhod
, "change2")){

55  
	`mosquôto_£t_u£∫ame
(
˛õ¡
, "new_username");

56 }if(!
	`°rcmp
(
mëhod
, "mirror2")){

57 if(
d©a_Àn
 > 0){

58 *
d©a_out
 = 
	`mÆloc
(
d©a_Àn
);

59 if(!(*
d©a_out
)){

60  
MOSQ_ERR_NOMEM
;

62 
i
=0; i<
d©a_Àn
; i++){

63 ((
uöt8_t
 *)(*
d©a_out
))[
i
] = ((uöt8_à*)
d©a
)[
d©a_Àn
-i-1];

65 *
d©a_out_Àn
 = 
d©a_Àn
;

67  
MOSQ_ERR_SUCCESS
;

69  
MOSQ_ERR_INVAL
;

72  
MOSQ_ERR_NOT_SUPPORTED
;

73 
	}
}

75 
	$mosquôto_auth_c⁄töue
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
mëhod
, c⁄° *
d©a
, 
uöt16_t
 
d©a_Àn
, **
d©a_out
, uöt16_à*
d©a_out_Àn
)

77  
MOSQ_ERR_AUTH
;

78 
	}
}

	@test/broker/c/auth_plugin_msg_params.c

1 
	~<°dlib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15  
MOSQ_ERR_SUCCESS
;

16 
	}
}

18 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

20  
MOSQ_ERR_SUCCESS
;

21 
	}
}

23 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

25  
MOSQ_ERR_SUCCESS
;

26 
	}
}

28 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

30  
MOSQ_ERR_SUCCESS
;

31 
	}
}

33 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

35 if(
ac˚ss
 =
MOSQ_ACL_SUBSCRIBE
){

36  
MOSQ_ERR_SUCCESS
;

39 if(!
msg
->
t›ic
 || 
	`°rcmp
(msg->topic, "param/topic")){

40 
	`ab‹t
();

41  
MOSQ_ERR_ACL_DENIED
;

44 if(!
msg
->
∑ylﬂd
 || 
	`°∫cmp
(msg->∑ylﬂd, "∑ylﬂd c⁄ã¡s", 
	`°æí
("payload contents"))){

45 
	`ab‹t
();

46  
MOSQ_ERR_ACL_DENIED
;

49 if(
msg
->
∑ylﬂdÀn
 !
	`°æí
("payload contents")){

50 
	`ab‹t
();

51  
MOSQ_ERR_ACL_DENIED
;

54 if(
msg
->
qos
 != 1){

55 
	`ab‹t
();

56  
MOSQ_ERR_ACL_DENIED
;

59 if(!
msg
->
ªèö
){

60 
	`ab‹t
();

61  
MOSQ_ERR_ACL_DENIED
;

64  
MOSQ_ERR_SUCCESS
;

65 
	}
}

67 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

69  
MOSQ_ERR_PLUGIN_DEFER
;

70 
	}
}

72 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

74  
MOSQ_ERR_AUTH
;

75 
	}
}

	@test/broker/c/auth_plugin_pwd.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mosquôto.h
>

4 
	~<mosquôto_brokî.h
>

5 
	~<mosquôto_∂ugö.h
>

7 
	$mosquôto_auth_∂ugö_vîsi⁄
()

9  
MOSQ_AUTH_PLUGIN_VERSION
;

10 
	}
}

12 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

14  
MOSQ_ERR_SUCCESS
;

15 
	}
}

17 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

19  
MOSQ_ERR_SUCCESS
;

20 
	}
}

22 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

24  
MOSQ_ERR_SUCCESS
;

25 
	}
}

27 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

29  
MOSQ_ERR_SUCCESS
;

30 
	}
}

32 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

34  
MOSQ_ERR_PLUGIN_DEFER
;

35 
	}
}

37 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

39 if(!
	`°rcmp
(
u£∫ame
, "ã°-u£∫ame"Ë&& 
∑ssw‹d
 && !strcmp(password, "cnwTICONIURW")){

40  
MOSQ_ERR_SUCCESS
;

41 }if(!
	`°rcmp
(
u£∫ame
, "readonly")){

42  
MOSQ_ERR_SUCCESS
;

43 }if(!
	`°rcmp
(
u£∫ame
, "test-username@v2")){

44  
MOSQ_ERR_PLUGIN_DEFER
;

46  
MOSQ_ERR_AUTH
;

48 
	}
}

50 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

52  
MOSQ_ERR_AUTH
;

53 
	}
}

	@test/broker/c/auth_plugin_v2.c

1 
	~<°rög.h
>

2 
	~<°dboﬁ.h
>

3 
	~"mosquôto_∂ugö_v2.h
"

10 
	emosq_îr_t
 {

11 
	mMOSQ_ERR_SUCCESS
 = 0,

12 
	mMOSQ_ERR_AUTH
 = 11,

13 
	mMOSQ_ERR_ACL_DENIED
 = 12

16 
	$mosquôto_auth_∂ugö_vîsi⁄
()

18  
MOSQ_AUTH_PLUGIN_VERSION
;

19 
	}
}

21 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

23  
MOSQ_ERR_SUCCESS
;

24 
	}
}

26 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

28  
MOSQ_ERR_SUCCESS
;

29 
	}
}

31 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

33  
MOSQ_ERR_SUCCESS
;

34 
	}
}

36 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

38  
MOSQ_ERR_SUCCESS
;

39 
	}
}

41 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, c⁄° *
˛õ¡id
, c⁄° *
u£∫ame
, c⁄° *
t›ic
, 
ac˚ss
)

43 if(!
	`°rcmp
(
u£∫ame
, "ªad⁄ly"Ë&& 
ac˚ss
 =
MOSQ_ACL_READ
){

44  
MOSQ_ERR_SUCCESS
;

46  
MOSQ_ERR_ACL_DENIED
;

48 
	}
}

50 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

52 if(!
	`°rcmp
(
u£∫ame
, "ã°-u£∫ame"Ë&& 
∑ssw‹d
 && !strcmp(password, "cnwTICONIURW")){

53  
MOSQ_ERR_SUCCESS
;

54 }if(!
	`°rcmp
(
u£∫ame
, "readonly")){

55  
MOSQ_ERR_SUCCESS
;

56 }if(!
	`°rcmp
(
u£∫ame
, "test-username@v2")){

57  
MOSQ_ERR_SUCCESS
;

59  
MOSQ_ERR_AUTH
;

61 
	}
}

63 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

65  
MOSQ_ERR_AUTH
;

66 
	}
}

	@test/broker/c/mosquitto_plugin_v2.h

17 #i‚de‡
MOSQUITTO_PLUGIN_H


18 
	#MOSQUITTO_PLUGIN_H


	)

20 
	#MOSQ_AUTH_PLUGIN_VERSION
 2

	)

22 
	#MOSQ_ACL_NONE
 0x00

	)

23 
	#MOSQ_ACL_READ
 0x01

	)

24 
	#MOSQ_ACL_WRITE
 0x02

	)

26 
	smosquôto_auth_›t
 {

27 *
	mkey
;

28 *
	mvÆue
;

74 
mosquôto_log_¥ötf
(
Àvñ
, c⁄° *
fmt
, ...);

93 
mosquôto_auth_∂ugö_vîsi⁄
();

114 
mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
);

134 
mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
);

158 
mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
);

182 
mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
);

192 
mosquôto_auth_a˛_check
(*
u£r_d©a
, c⁄° *
˛õ¡id
, c⁄° *
u£∫ame
, c⁄° *
t›ic
, 
ac˚ss
);

202 
mosquôto_auth_u≈wd_check
(*
u£r_d©a
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

226 
mosquôto_auth_psk_key_gë
(*
u£r_d©a
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

	@test/lib/c/01-con-discon-success.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_disc⁄√˘
(
mosq
);

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$maö
(
¨gc
, *
¨gv
[])

24 
rc
;

25 
mosquôto
 *
mosq
;

27 
p‹t
 = 
	`©oi
(
¨gv
[1]);

29 
	`mosquôto_lib_öô
();

31 
mosq
 = 
	`mosquôto_√w
("01-c⁄-disc⁄-suc˚ss", 
åue
, 
NULL
);

32 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

33 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

35 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

37 
run
 == -1){

38 
	`mosquôto_lo›
(
mosq
, -1, 1);

41 
	`mosquôto_de°roy
(
mosq
);

43 
	`mosquôto_lib_˛ónup
();

44  
run
;

45 
	}
}

	@test/lib/c/01-keepalive-pingreq.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	}
}

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
rc
;

18 
mosquôto
 *
mosq
;

20 
p‹t
 = 
	`©oi
(
¨gv
[1]);

22 
	`mosquôto_lib_öô
();

24 
mosq
 = 
	`mosquôto_√w
("01-kì∑live-pögªq", 
åue
, 
NULL
);

25 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

27 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 4);

29 
run
 == -1){

30 
	`mosquôto_lo›
(
mosq
, -1, 1);

33 
	`mosquôto_de°roy
(
mosq
);

34 
	`mosquôto_lib_˛ónup
();

35  
run
;

36 
	}
}

	@test/lib/c/01-no-clean-session.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
rc
;

11 
mosquôto
 *
mosq
;

13 
p‹t
 = 
	`©oi
(
¨gv
[1]);

15 
	`mosquôto_lib_öô
();

17 
mosq
 = 
	`mosquôto_√w
("01-no-˛ón-£ssi⁄", 
Ál£
, 
NULL
);

19 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

21 
run
 == -1){

22 
	`mosquôto_lo›
(
mosq
, -1, 1);

25 
	`mosquôto_lib_˛ónup
();

26  
run
;

27 
	}
}

	@test/lib/c/01-server-keepalive-pingreq.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	}
}

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
rc
;

18 
mosquôto
 *
mosq
;

20 
p‹t
 = 
	`©oi
(
¨gv
[1]);

22 
	`mosquôto_lib_öô
();

24 
mosq
 = 
	`mosquôto_√w
("01-£rvî-kì∑live-pögªq", 
åue
, 
NULL
);

25 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

26 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

28 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

30 
run
 == -1){

31 
	`mosquôto_lo›
(
mosq
, -1, 1);

34 
	`mosquôto_de°roy
(
mosq
);

35 
	`mosquôto_lib_˛ónup
();

36  
run
;

37 
	}
}

	@test/lib/c/01-unpwd-set.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
rc
;

11 
mosquôto
 *
mosq
;

13 
p‹t
 = 
	`©oi
(
¨gv
[1]);

15 
	`mosquôto_lib_öô
();

17 
mosq
 = 
	`mosquôto_√w
("01-u≈wd-£t", 
åue
, 
NULL
);

18 
	`mosquôto_u£∫ame_pw_£t
(
mosq
, "uname", ";'[08gn=#");

20 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

22 
run
 == -1){

23 
	`mosquôto_lo›
(
mosq
, -1, 1);

26 
	`mosquôto_lib_˛ónup
();

27  
run
;

28 
	}
}

	@test/lib/c/01-will-set.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
rc
;

11 
mosquôto
 *
mosq
;

13 
p‹t
 = 
	`©oi
(
¨gv
[1]);

15 
	`mosquôto_lib_öô
();

17 
mosq
 = 
	`mosquôto_√w
("01-wûl-£t", 
åue
, 
NULL
);

18 
	`mosquôto_wûl_£t
(
mosq
, "t›ic/⁄/u√x≥˘ed/disc⁄√˘", 
	`°æí
("wû»mesßge"), "wû»mesßge", 1, 
åue
);

20 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

22 
run
 == -1){

23 
	`mosquôto_lo›
(
mosq
, -1, 1);

26 
	`mosquôto_lib_˛ónup
();

27  
run
;

28 
	}
}

	@test/lib/c/01-will-unpwd-set.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
rc
;

11 
mosquôto
 *
mosq
;

13 
p‹t
 = 
	`©oi
(
¨gv
[1]);

15 
	`mosquôto_lib_öô
();

17 
mosq
 = 
	`mosquôto_√w
("01-wûl-u≈wd-£t", 
åue
, 
NULL
);

18 
	`mosquôto_u£∫ame_pw_£t
(
mosq
, "oibvvwqw", "#'^2hg9a&nm38*us");

19 
	`mosquôto_wûl_£t
(
mosq
, "wûl-t›ic", 
	`°æí
("wû»mesßge"), "wû»mesßge", 2, 
Ál£
);

21 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

23 
run
 == -1){

24 
	`mosquôto_lo›
(
mosq
, -1, 1);

27 
	`mosquôto_lib_˛ónup
();

28  
run
;

29 
	}
}

	@test/lib/c/02-subscribe-qos0.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "qos0/test", 0);

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$maö
(
¨gc
, *
¨gv
[])

29 
rc
;

30 
mosquôto
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
	`mosquôto_lib_öô
();

36 
mosq
 = 
	`mosquôto_√w
("subs¸ibe-qos0-ã°", 
åue
, 
NULL
);

37 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

38 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

39 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

41 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

43 
run
 == -1){

44 
	`mosquôto_lo›
(
mosq
, -1, 1);

47 
	`mosquôto_lib_˛ónup
();

48  
run
;

49 
	}
}

	@test/lib/c/02-subscribe-qos1-async1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<time.h
>

5 
	~<mosquôto.h
>

9 
	grun
 = -1;

10 
boﬁ
 
	gshould_run
 = 
åue
;

12 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

14 if(
rc
){

15 
	`exô
(1);

17 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "qos1/test", 1);

19 
	}
}

21 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

23 
run
 = 
rc
;

24 
	}
}

26 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

29 
should_run
 = 
Ál£
;

30 
	}
}

32 
	$maö
(
¨gc
, *
¨gv
[])

34 
rc
;

35 
mosquôto
 *
mosq
;

37 
p‹t
 = 
	`©oi
(
¨gv
[1]);

39 
	`mosquôto_lib_öô
();

41 
mosq
 = 
	`mosquôto_√w
("subs¸ibe-qos1-ã°", 
åue
, 
NULL
);

42 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

43 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

44 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

45 
	`¥ötf
("ok,áboutÅo call connect_async\n");

50 
rc
 = 
	`mosquôto_lo›_°¨t
(
mosq
);

51 
	`¥ötf
("lo›_°¨àªtu∫edÑc: %d\n", 
rc
);

52 i‡(
rc
) {

53 
	`¥ötf
("which is: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

57 
rc
 = 
	`mosquôto_c⁄√˘_async
(
mosq
, "loˇlho°", 
p‹t
, 60);

58 
	`¥ötf
("c⁄√˘ásyn¯ªtu∫edÑc: %d\n", 
rc
);

59 i‡(
rc
) {

60 
	`¥ötf
("which is: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

63 
	`¥ötf
("ok, so we can start just waitingÇow,Üoop_start willÑun in it'sÅhread\n");

66 
time•ec
 
tv
 = { 1, 0 };

67 
should_run
){

68 
	`«no¶ìp
(&
tv
, 
NULL
);

69 
	`¥ötf
("...waiting...\n");

71 
	`¥ötf
("AlreadyÉxited should_run....\n");

73 
	`mosquôto_disc⁄√˘
(
mosq
);

74 
	`mosquôto_lo›_°›
(
mosq
, 
Ál£
);

76 
	`mosquôto_lib_˛ónup
();

77  
run
;

78 
	}
}

	@test/lib/c/02-subscribe-qos1-async2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<time.h
>

5 
	~<mosquôto.h
>

9 
	grun
 = -1;

10 
boﬁ
 
	gshould_run
 = 
åue
;

12 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

14 if(
rc
){

15 
	`exô
(1);

17 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "qos1/test", 1);

19 
	}
}

21 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

23 
run
 = 
rc
;

24 
	}
}

26 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

29 
should_run
 = 
Ál£
;

30 
	}
}

32 
	$maö
(
¨gc
, *
¨gv
[])

34 
rc
;

35 
mosquôto
 *
mosq
;

37 
p‹t
 = 
	`©oi
(
¨gv
[1]);

39 
	`mosquôto_lib_öô
();

41 
mosq
 = 
	`mosquôto_√w
("subs¸ibe-qos1-ã°", 
åue
, 
NULL
);

42 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

43 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

44 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

45 
	`¥ötf
("ok,áboutÅo call connect_async\n");

47 
rc
 = 
	`mosquôto_c⁄√˘_async
(
mosq
, "loˇlho°", 
p‹t
, 60);

48 
	`¥ötf
("c⁄√˘ásyn¯ªtu∫edÑc: %d\n", 
rc
);

49 i‡(
rc
) {

50 
	`¥ötf
("which is: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

53 
rc
 = 
	`mosquôto_lo›_°¨t
(
mosq
);

54 
	`¥ötf
("lo›_°¨àªtu∫edÑc: %d\n", 
rc
);

55 i‡(
rc
) {

56 
	`¥ötf
("which is: %s\n", 
	`mosquôto_°ªº‹
(
rc
));

59 
	`¥ötf
("ok, so we can start just waitingÇow,Üoop_start willÑun in it'sÅhread\n");

62 
time•ec
 
tv
 = { 1, 0 };

63 
should_run
){

64 
	`«no¶ìp
(&
tv
, 
NULL
);

65 
	`¥ötf
("...waiting...\n");

67 
	`¥ötf
("AlreadyÉxited should_run....\n");

69 
	`mosquôto_disc⁄√˘
(
mosq
);

70 
	`mosquôto_lo›_°›
(
mosq
, 
Ál£
);

72 
	`mosquôto_lib_˛ónup
();

73  
run
;

74 
	}
}

	@test/lib/c/02-subscribe-qos1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "qos1/test", 1);

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$maö
(
¨gc
, *
¨gv
[])

29 
rc
;

30 
mosquôto
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
	`mosquôto_lib_öô
();

36 
mosq
 = 
	`mosquôto_√w
("subs¸ibe-qos1-ã°", 
åue
, 
NULL
);

37 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

38 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

39 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

41 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

43 
run
 == -1){

44 
	`mosquôto_lo›
(
mosq
, -1, 1);

47 
	`mosquôto_lib_˛ónup
();

48  
run
;

49 
	}
}

	@test/lib/c/02-subscribe-qos2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "qos2/test", 2);

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$maö
(
¨gc
, *
¨gv
[])

29 
rc
;

30 
mosquôto
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
	`mosquôto_lib_öô
();

36 
mosq
 = 
	`mosquôto_√w
("subs¸ibe-qos2-ã°", 
åue
, 
NULL
);

37 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

38 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

39 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

41 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

43 
run
 == -1){

44 
	`mosquôto_lo›
(
mosq
, -1, 1);

47 
	`mosquôto_lib_˛ónup
();

48  
run
;

49 
	}
}

	@test/lib/c/02-unsubscribe-multiple-v5.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "unsubscribe/test", 2);

15 
	}
}

17 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
sub_cou¡
, c⁄° *
subs
)

19 *
unsubs
[] = {"unsubscribe/test", "no-sub"};

21 
	`mosquôto_unsubs¸ibe_mu…ùÀ
(
mosq
, 
NULL
, 2, 
unsubs
, NULL);

22 
	}
}

24 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

26 
run
 = 
rc
;

27 
	}
}

29 
	$⁄_unsubs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

31 
	`mosquôto_disc⁄√˘
(
mosq
);

32 
	}
}

35 
	$maö
(
¨gc
, *
¨gv
[])

37 
rc
;

38 
mosquôto
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
	`mosquôto_lib_öô
();

44 
mosq
 = 
	`mosquôto_√w
("unsubs¸ibe-ã°", 
åue
, 
NULL
);

45 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

46 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

47 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

48 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

49 
	`mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_unsubs¸ibe
);

51 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

53 
run
 == -1){

54 
	`mosquôto_lo›
(
mosq
, -1, 1);

57 
	`mosquôto_lib_˛ónup
();

58  
run
;

59 
	}
}

	@test/lib/c/02-unsubscribe-v5.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_unsubs¸ibe
(
mosq
, 
NULL
, "unsubscribe/test");

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$⁄_unsubs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$maö
(
¨gc
, *
¨gv
[])

29 
rc
;

30 
mosquôto
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
	`mosquôto_lib_öô
();

36 
mosq
 = 
	`mosquôto_√w
("unsubs¸ibe-ã°", 
åue
, 
NULL
);

37 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

38 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

39 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

40 
	`mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_unsubs¸ibe
);

42 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

44 
run
 == -1){

45 
	`mosquôto_lo›
(
mosq
, -1, 1);

48 
	`mosquôto_lib_˛ónup
();

49  
run
;

50 
	}
}

	@test/lib/c/02-unsubscribe.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<mosquôto.h
>

6 
	grun
 = -1;

8 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

10 if(
rc
){

11 
	`exô
(1);

13 
	`mosquôto_unsubs¸ibe
(
mosq
, 
NULL
, "unsubscribe/test");

15 
	}
}

17 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

19 
run
 = 
rc
;

20 
	}
}

22 
	$⁄_unsubs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$maö
(
¨gc
, *
¨gv
[])

29 
rc
;

30 
mosquôto
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
	`mosquôto_lib_öô
();

36 
mosq
 = 
	`mosquôto_√w
("unsubs¸ibe-ã°", 
åue
, 
NULL
);

37 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

38 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

39 
	`mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_unsubs¸ibe
);

41 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

43 
run
 == -1){

44 
	`mosquôto_lo›
(
mosq
, -1, 1);

47 
	`mosquôto_lib_˛ónup
();

48  
run
;

49 
	}
}

	@test/lib/c/03-publish-b2c-qos1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

9 if(
rc
){

10 
	`exô
(1);

12 
	}
}

14 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

16 if(
msg
->
mid
 != 123){

17 
	`¥ötf
("InvÆid mid (%d)\n", 
msg
->
mid
);

18 
	`exô
(1);

20 if(
msg
->
qos
 != 1){

21 
	`¥ötf
("InvÆid qo†(%d)\n", 
msg
->
qos
);

22 
	`exô
(1);

24 if(
	`°rcmp
(
msg
->
t›ic
, "pub/qos1/receive")){

25 
	`¥ötf
("InvÆidÅ›i¯(%s)\n", 
msg
->
t›ic
);

26 
	`exô
(1);

28 if(
	`°rcmp
(
msg
->
∑ylﬂd
, "message")){

29 
	`¥ötf
("InvÆidÖaylﬂd (%s)\n", (*)
msg
->
∑ylﬂd
);

30 
	`exô
(1);

32 if(
msg
->
∑ylﬂdÀn
 != 7){

33 
	`¥ötf
("InvÆidÖaylﬂdÀ¿(%d)\n", 
msg
->
∑ylﬂdÀn
);

34 
	`exô
(1);

36 if(
msg
->
ªèö
 !
Ál£
){

37 
	`¥ötf
("InvÆidÑëaö (%d)\n", 
msg
->
ªèö
);

38 
	`exô
(1);

41 
	`exô
(0);

42 
	}
}

44 
	$maö
(
¨gc
, *
¨gv
[])

46 
rc
;

47 
mosquôto
 *
mosq
;

49 
p‹t
 = 
	`©oi
(
¨gv
[1]);

51 
	`mosquôto_lib_öô
();

53 
mosq
 = 
	`mosquôto_√w
("publish-qos1-ã°", 
åue
, 
NULL
);

54 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

55 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge
);

56 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 3);

58 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

61 
	`mosquôto_lo›
(
mosq
, 300, 1);

64 
	`mosquôto_lib_˛ónup
();

66 
	}
}

	@test/lib/c/03-publish-b2c-qos2-len.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	}
}

16 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

18 if(
msg
->
mid
 != 56){

19 
	`¥ötf
("InvÆid mid (%d)\n", 
msg
->
mid
);

20 
	`exô
(1);

22 if(
msg
->
qos
 != 2){

23 
	`¥ötf
("InvÆid qo†(%d)\n", 
msg
->
qos
);

24 
	`exô
(1);

26 if(
	`°rcmp
(
msg
->
t›ic
, "len/qos2/test")){

27 
	`¥ötf
("InvÆidÅ›i¯(%s)\n", 
msg
->
t›ic
);

28 
	`exô
(1);

30 if(
	`°rcmp
(
msg
->
∑ylﬂd
, "message")){

31 
	`¥ötf
("InvÆidÖaylﬂd (%s)\n", (*)
msg
->
∑ylﬂd
);

32 
	`exô
(1);

34 if(
msg
->
∑ylﬂdÀn
 != 7){

35 
	`¥ötf
("InvÆidÖaylﬂdÀ¿(%d)\n", 
msg
->
∑ylﬂdÀn
);

36 
	`exô
(1);

38 if(
msg
->
ªèö
 !
Ál£
){

39 
	`¥ötf
("InvÆidÑëaö (%d)\n", 
msg
->
ªèö
);

40 
	`exô
(1);

43 
	`mosquôto_disc⁄√˘
(
mosq
);

44 
	}
}

46 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

48 
run
 = 0;

49 
	}
}

51 
	$maö
(
¨gc
, *
¨gv
[])

53 
rc
;

54 
mosquôto
 *
mosq
;

56 
p‹t
 = 
	`©oi
(
¨gv
[1]);

58 
	`mosquôto_lib_öô
();

60 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, &
run
);

61 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

62 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

63 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

64 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge
);

66 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

68 
run
 == -1){

69 
	`mosquôto_lo›
(
mosq
, 100, 1);

72 
	`mosquôto_lib_˛ónup
();

73  
run
;

74 
	}
}

	@test/lib/c/03-publish-b2c-qos2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	}
}

16 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

18 if(
msg
->
mid
 != 13423){

19 
	`¥ötf
("InvÆid mid (%d)\n", 
msg
->
mid
);

20 
	`exô
(1);

22 if(
msg
->
qos
 != 2){

23 
	`¥ötf
("InvÆid qo†(%d)\n", 
msg
->
qos
);

24 
	`exô
(1);

26 if(
	`°rcmp
(
msg
->
t›ic
, "pub/qos2/receive")){

27 
	`¥ötf
("InvÆidÅ›i¯(%s)\n", 
msg
->
t›ic
);

28 
	`exô
(1);

30 if(
	`°rcmp
(
msg
->
∑ylﬂd
, "message")){

31 
	`¥ötf
("InvÆidÖaylﬂd (%s)\n", (*)
msg
->
∑ylﬂd
);

32 
	`exô
(1);

34 if(
msg
->
∑ylﬂdÀn
 != 7){

35 
	`¥ötf
("InvÆidÖaylﬂdÀ¿(%d)\n", 
msg
->
∑ylﬂdÀn
);

36 
	`exô
(1);

38 if(
msg
->
ªèö
 !
Ál£
){

39 
	`¥ötf
("InvÆidÑëaö (%d)\n", 
msg
->
ªèö
);

40 
	`exô
(1);

43 
run
 = 0;

44 
	}
}

46 
	$maö
(
¨gc
, *
¨gv
[])

48 
rc
;

49 
mosquôto
 *
mosq
;

51 
p‹t
 = 
	`©oi
(
¨gv
[1]);

53 
	`mosquôto_lib_öô
();

55 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, &
run
);

56 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

57 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge
);

58 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 5);

60 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

62 
run
 == -1){

63 
	`mosquôto_lo›
(
mosq
, 300, 1);

66 
	`mosquôto_lib_˛ónup
();

67  
run
;

68 
	}
}

	@test/lib/c/03-publish-c2b-qos1-disconnect.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	gfú°_c⁄√˘i⁄
 = 1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 if(
fú°_c⁄√˘i⁄
 == 1){

16 
	`mosquôto_publish
(
mosq
, 
NULL
, "pub/qos1/ã°", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

17 
fú°_c⁄√˘i⁄
 = 0;

20 
	}
}

22 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

29 if(
rc
){

30 
	`mosquôto_ªc⁄√˘
(
mosq
);

32 
run
 = 0;

34 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
rc
;

39 
mosquôto
 *
mosq
;

41 
p‹t
 = 
	`©oi
(
¨gv
[1]);

43 
	`mosquôto_lib_öô
();

45 
mosq
 = 
	`mosquôto_√w
("publish-qos1-ã°", 
åue
, 
NULL
);

46 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

47 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

48 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

49 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 3);

51 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

53 
run
 == -1){

54 
	`mosquôto_lo›
(
mosq
, 300, 1);

57 
	`mosquôto_lib_˛ónup
();

58  
run
;

59 
	}
}

	@test/lib/c/03-publish-c2b-qos1-len.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_publish
(
mosq
, 
NULL
, "pub/qos1/ã°", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

16 
	}
}

18 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

20 
	`mosquôto_disc⁄√˘
(
mosq
);

21 
	}
}

23 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

25 
run
 = 0;

26 
	}
}

28 
	$maö
(
¨gc
, *
¨gv
[])

30 
rc
;

31 
mosquôto
 *
mosq
;

33 
p‹t
 = 
	`©oi
(
¨gv
[1]);

35 
	`mosquôto_lib_öô
();

37 
mosq
 = 
	`mosquôto_√w
("publish-qos1-ã°", 
åue
, 
NULL
);

38 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

39 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

40 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

41 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

42 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 3);

44 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

46 
run
 == -1){

47 
	`mosquôto_lo›
(
mosq
, 300, 1);

50 
	`mosquôto_lib_˛ónup
();

51  
run
;

52 
	}
}

	@test/lib/c/03-publish-c2b-qos1-receive-maximum.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

11 
i
;

13 if(
rc
){

14 
	`exô
(1);

17 
i
=0; i<6; i++){

18 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "t›ic", 5, "12345", 1, 
Ál£
, NULL);

20 
	}
}

22 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

24 if(
mid
 == 6){

25 
	`mosquôto_disc⁄√˘
(
mosq
);

26 
run
 = 0;

28 
	}
}

30 
	$maö
(
¨gc
, *
¨gv
[])

32 
rc
;

33 
mosquôto
 *
mosq
;

34 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

36 
p‹t
 = 
	`©oi
(
¨gv
[1]);

38 
	`mosquôto_lib_öô
();

40 
mosq
 = 
	`mosquôto_√w
("publish-qos1-ã°", 
åue
, &
run
);

41 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

43 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

44 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
⁄_publish
);

46 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, "loˇlho°", 
p‹t
, 60, 
NULL
, NULL);

48 
run
 == -1){

49 
	`mosquôto_lo›
(
mosq
, 300, 1);

52 
	`mosquôto_lib_˛ónup
();

53  
run
;

54 
	}
}

	@test/lib/c/03-publish-c2b-qos2-disconnect.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	gfú°_c⁄√˘i⁄
 = 1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 if(
fú°_c⁄√˘i⁄
 == 1){

16 
	`mosquôto_publish
(
mosq
, 
NULL
, "pub/qos2/ã°", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

17 
fú°_c⁄√˘i⁄
 = 0;

20 
	}
}

22 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

24 
	`mosquôto_disc⁄√˘
(
mosq
);

25 
	}
}

27 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

29 if(
rc
){

30 
	`mosquôto_ªc⁄√˘
(
mosq
);

32 
run
 = 0;

34 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
rc
;

39 
mosquôto
 *
mosq
;

41 
p‹t
 = 
	`©oi
(
¨gv
[1]);

43 
	`mosquôto_lib_öô
();

45 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, 
NULL
);

46 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

47 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

48 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

49 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 3);

51 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

53 
run
 == -1){

54 
	`mosquôto_lo›
(
mosq
, 300, 1);

57 
	`mosquôto_lib_˛ónup
();

58  
run
;

59 
	}
}

	@test/lib/c/03-publish-c2b-qos2-len.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_publish
(
mosq
, 
NULL
, "pub/qos2/ã°", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

16 
	}
}

18 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

20 
	`mosquôto_disc⁄√˘
(
mosq
);

21 
	}
}

23 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

25 
run
 = 0;

26 
	}
}

28 
	$maö
(
¨gc
, *
¨gv
[])

30 
rc
;

31 
mosquôto
 *
mosq
;

33 
p‹t
 = 
	`©oi
(
¨gv
[1]);

35 
	`mosquôto_lib_öô
();

37 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, 
NULL
);

38 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

39 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

40 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

41 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
⁄_publish
);

42 
	`mosquôto_mesßge_ªåy_£t
(
mosq
, 3);

44 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

46 
run
 == -1){

47 
	`mosquôto_lo›
(
mosq
, 300, 1);

50 
	`mosquôto_lib_˛ónup
();

51  
run
;

52 
	}
}

	@test/lib/c/03-publish-c2b-qos2-maximum-qos-0.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos2", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

15 if(
rc
 !
MOSQ_ERR_QOS_NOT_SUPPORTED
Ë
run
 = 1;

16 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos1", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

17 if(
rc
 !
MOSQ_ERR_QOS_NOT_SUPPORTED
Ë
run
 = 1;

18 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos0", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
);

19 if(
rc
 !
MOSQ_ERR_SUCCESS
Ë
run
 = 1;

21 
	}
}

23 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

25 if(
mid
 == 1){

26 
	`mosquôto_disc⁄√˘
(
mosq
);

28 
	}
}

30 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

32 
run
 = 0;

33 
	}
}

35 
	$maö
(
¨gc
, *
¨gv
[])

37 
rc
;

38 
mosquôto
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
	`mosquôto_lib_öô
();

44 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, 
NULL
);

45 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

46 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

47 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

48 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

50 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

52 
run
 == -1){

53 
	`mosquôto_lo›
(
mosq
, 50, 1);

56 
	`mosquôto_lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/c/03-publish-c2b-qos2-maximum-qos-1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos2", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

15 if(
rc
 !
MOSQ_ERR_QOS_NOT_SUPPORTED
Ë
run
 = 1;

16 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos1", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

17 if(
rc
 !
MOSQ_ERR_SUCCESS
Ë
run
 = 1;

18 
rc
 = 
	`mosquôto_publish
(
mosq
, 
NULL
, "maximum/qos/qos0", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
);

19 if(
rc
 !
MOSQ_ERR_SUCCESS
Ë
run
 = 1;

21 
	}
}

23 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

25 if(
mid
 == 2){

26 
	`mosquôto_disc⁄√˘
(
mosq
);

28 
	}
}

30 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

32 
run
 = 0;

33 
	}
}

35 
	$maö
(
¨gc
, *
¨gv
[])

37 
rc
;

38 
mosquôto
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
	`mosquôto_lib_öô
();

44 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, 
NULL
);

45 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

46 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

47 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

48 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

50 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

52 
run
 == -1){

53 
	`mosquôto_lo›
(
mosq
, 50, 1);

55 
	`mosquôto_lo›
(
mosq
, 50, 1);

57 
	`mosquôto_lib_˛ónup
();

58  
run
;

59 
	}
}

	@test/lib/c/03-publish-c2b-qos2-pubrec-error.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "t›ic", 
	`°æí
("ªje˘ed"), "ªje˘ed", 2, 
Ál£
, NULL);

15 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "t›ic", 
	`°æí
("ac˚±ed"), "ac˚±ed", 2, 
Ál£
, NULL);

16 
	}
}

18 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

20 if(
mid
 == 2){

21 
run
 = 0;

23 
	}
}

25 
	$maö
(
¨gc
, *
¨gv
[])

27 
rc
;

28 
mosquôto
 *
mosq
;

29 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

31 
p‹t
 = 
	`©oi
(
¨gv
[1]);

33 
	`mosquôto_lib_öô
();

35 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, &
run
);

36 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

38 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

39 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
⁄_publish
);

41 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, "loˇlho°", 
p‹t
, 60, 
NULL
, NULL);

43 
run
 == -1){

44 
	`mosquôto_lo›
(
mosq
, 100, 1);

47 
	`mosquôto_lib_˛ónup
();

48  
run
;

49 
	}
}

	@test/lib/c/03-publish-c2b-qos2-receive-maximum-1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

11 
i
;

13 if(
rc
){

14 
	`exô
(1);

17 
i
=0; i<5; i++){

18 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "t›ic", 5, "12345", 2, 
Ál£
, NULL);

20 
	}
}

22 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

24 if(
mid
 == 5){

25 
	`mosquôto_disc⁄√˘
(
mosq
);

26 
run
 = 0;

28 
	}
}

30 
	$maö
(
¨gc
, *
¨gv
[])

32 
rc
;

33 
mosquôto
 *
mosq
;

34 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

36 
p‹t
 = 
	`©oi
(
¨gv
[1]);

38 
	`mosquôto_lib_öô
();

40 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, &
run
);

41 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

43 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

44 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
⁄_publish
);

46 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, "loˇlho°", 
p‹t
, 60, 
NULL
, NULL);

48 
run
 == -1){

49 
	`mosquôto_lo›
(
mosq
, 300, 1);

52 
	`mosquôto_lib_˛ónup
();

53  
run
;

54 
	}
}

	@test/lib/c/03-publish-c2b-qos2-receive-maximum-2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
, 
Êags
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

11 
i
;

13 if(
rc
){

14 
	`exô
(1);

17 
i
=0; i<5; i++){

18 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "t›ic", 5, "12345", 2, 
Ál£
, NULL);

20 
	}
}

22 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
ªas⁄_code
, c⁄° 
mosquôto_¥›îty
 *
¥›îtõs
)

24 if(
mid
 == 5){

25 
	`mosquôto_disc⁄√˘
(
mosq
);

26 
run
 = 0;

28 
	}
}

30 
	$maö
(
¨gc
, *
¨gv
[])

32 
rc
;

33 
mosquôto
 *
mosq
;

34 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

36 
p‹t
 = 
	`©oi
(
¨gv
[1]);

38 
	`mosquôto_lib_öô
();

40 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, &
run
);

41 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

43 
	`mosquôto_c⁄√˘_v5_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

44 
	`mosquôto_publish_v5_ˇŒback_£t
(
mosq
, 
⁄_publish
);

46 
rc
 = 
	`mosquôto_c⁄√˘_böd_v5
(
mosq
, "loˇlho°", 
p‹t
, 60, 
NULL
, NULL);

48 
run
 == -1){

49 
	`mosquôto_lo›
(
mosq
, 300, 1);

52 
	`mosquôto_lib_˛ónup
();

53  
run
;

54 
	}
}

	@test/lib/c/03-publish-c2b-qos2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_publish
(
mosq
, 
NULL
, "pub/qos2/ã°", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

16 
	}
}

18 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

20 
	`mosquôto_disc⁄√˘
(
mosq
);

21 
	}
}

23 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

25 
run
 = 0;

26 
	}
}

28 
	$maö
(
¨gc
, *
¨gv
[])

30 
rc
;

31 
mosquôto
 *
mosq
;

33 
p‹t
 = 
	`©oi
(
¨gv
[1]);

35 
	`mosquôto_lib_öô
();

37 
mosq
 = 
	`mosquôto_√w
("publish-qos2-ã°", 
åue
, 
NULL
);

38 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

39 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

40 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

42 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

44 
run
 == -1){

45 
	`mosquôto_lo›
(
mosq
, 300, 1);

48 
	`mosquôto_lib_˛ónup
();

49  
run
;

50 
	}
}

	@test/lib/c/03-publish-qos0-no-payload.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	g£¡_mid
 = -1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "pub/qos0/no-∑ylﬂd/ã°", 0, 
NULL
, 0, 
Ál£
);

17 
	}
}

19 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

21 if(
mid
 =
£¡_mid
){

22 
	`mosquôto_disc⁄√˘
(
mosq
);

23 
run
 = 0;

25 
	`exô
(1);

27 
	}
}

29 
	$maö
(
¨gc
, *
¨gv
[])

31 
rc
;

32 
mosquôto
 *
mosq
;

34 
p‹t
 = 
	`©oi
(
¨gv
[1]);

36 
	`mosquôto_lib_öô
();

38 
mosq
 = 
	`mosquôto_√w
("publish-qos0-ã°-≈", 
åue
, 
NULL
);

39 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

40 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

42 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

44 
run
 == -1){

45 
	`mosquôto_lo›
(
mosq
, -1, 1);

48 
	`mosquôto_lib_˛ónup
();

49  
run
;

50 
	}
}

	@test/lib/c/03-publish-qos0.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	g£¡_mid
 = -1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "pub/qos0/ã°", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
);

17 
	}
}

19 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

21 if(
mid
 =
£¡_mid
){

22 
	`mosquôto_disc⁄√˘
(
mosq
);

23 
run
 = 0;

25 
	`exô
(1);

27 
	}
}

29 
	$maö
(
¨gc
, *
¨gv
[])

31 
rc
;

32 
mosquôto
 *
mosq
;

34 
p‹t
 = 
	`©oi
(
¨gv
[1]);

36 
	`mosquôto_lib_öô
();

38 
mosq
 = 
	`mosquôto_√w
("publish-qos0-ã°", 
åue
, 
NULL
);

39 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

40 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

42 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

44 
run
 == -1){

45 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

48 
	`mosquôto_lib_˛ónup
();

49  
run
;

50 
	}
}

	@test/lib/c/03-request-response-1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

6 
	~<mqâ_¥Ÿocﬁ.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
 = -1;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 if(
rc
){

14 
	`exô
(1);

16 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "response/topic", 0);

18 
	}
}

20 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

22 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

23 
	`mosquôto_¥›îty_add_°rög
(&
¥›s
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

24 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "ªque°/t›ic", 6, "a˘i⁄", 0, 0, 
¥›s
);

25 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›s
);

26 
	}
}

28 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

30 if(!
	`°rcmp
(
msg
->
∑ylﬂd
, "aÑesponse")){

31 
run
 = 0;

33 
run
 = 1;

35 
	}
}

37 
	$maö
(
¨gc
, *
¨gv
[])

39 
rc
;

40 
mosquôto
 *
mosq
;

41 
vî
 = 
PROTOCOL_VERSION_v5
;

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
	`mosquôto_lib_öô
();

47 
mosq
 = 
	`mosquôto_√w
("ªque°-ã°", 
åue
, 
NULL
);

48 
	`mosquôto_›ts_£t
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, &
vî
);

49 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

50 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

51 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge
);

53 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

55 
run
 == -1){

56 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

59 
	`mosquôto_lib_˛ónup
();

60  
run
;

61 
	}
}

	@test/lib/c/03-request-response-2.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

6 
	~<mqâ_¥Ÿocﬁ.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
 = -1;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 if(
rc
){

14 
	`exô
(1);

16 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "request/topic", 0);

18 
	}
}

20 
	$⁄_mesßge_v5
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
, c⁄° 
mosquôto_¥›îty
 *
¥›s
)

22 c⁄° 
mosquôto_¥›îty
 *
p_ª•
, *
p_c‹r
 = 
NULL
;

23 *
ª•_t›ic
 = 
NULL
;

24 
rc
;

26 if(!
	`°rcmp
(
msg
->
t›ic
, "request/topic")){

27 
p_ª•
 = 
	`mosquôto_¥›îty_ªad_°rög
(
¥›s
, 
MQTT_PROP_RESPONSE_TOPIC
, &
ª•_t›ic
, 
Ál£
);

28 if(
p_ª•
){

29 
p_c‹r
 = 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›s
, 
MQTT_PROP_CORRELATION_DATA
, 
NULL
, NULL, 
Ál£
);

30 
rc
 = 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, 
ª•_t›ic
, 
	`°æí
("®ª•⁄£"), "®ª•⁄£", 0, 
Ál£
, 
p_c‹r
);

31 
	`‰ì
(
ª•_t›ic
);

34 
	}
}

36 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

38 
run
 = 0;

39 
	}
}

42 
	$maö
(
¨gc
, *
¨gv
[])

44 
rc
;

45 
mosquôto
 *
mosq
;

46 
vî
 = 
PROTOCOL_VERSION_v5
;

48 
p‹t
 = 
	`©oi
(
¨gv
[1]);

50 
	`mosquôto_lib_öô
();

52 
mosq
 = 
	`mosquôto_√w
("ª•⁄£-ã°", 
åue
, 
NULL
);

53 
	`mosquôto_›ts_£t
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, &
vî
);

54 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

55 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

56 
	`mosquôto_mesßge_v5_ˇŒback_£t
(
mosq
, 
⁄_mesßge_v5
);

58 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

60 
run
 == -1){

61 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

64 
	`mosquôto_lib_˛ónup
();

65  
run
;

66 
	}
}

	@test/lib/c/03-request-response-correlation-1.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

6 
	~<mqâ_¥Ÿocﬁ.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
 = -1;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 if(
rc
){

14 
	`exô
(1);

16 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "response/topic", 0);

18 
	}
}

20 
	$⁄_subs¸ibe
(
mosquôto
 *
mosq
, *
obj
, 
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

22 
mosquôto_¥›îty
 *
¥›s
 = 
NULL
;

23 
	`mosquôto_¥›îty_add_°rög
(&
¥›s
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

24 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›s
, 
MQTT_PROP_CORRELATION_DATA
, "corridor", 8);

25 
	`mosquôto_publish_v5
(
mosq
, 
NULL
, "ªque°/t›ic", 6, "a˘i⁄", 0, 0, 
¥›s
);

26 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›s
);

27 
	}
}

29 
	$⁄_mesßge
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

31 if(!
	`°rcmp
(
msg
->
∑ylﬂd
, "aÑesponse")){

32 
run
 = 0;

34 
run
 = 1;

36 
	}
}

38 
	$maö
(
¨gc
, *
¨gv
[])

40 
rc
;

41 
mosquôto
 *
mosq
;

42 
vî
 = 
PROTOCOL_VERSION_v5
;

44 
p‹t
 = 
	`©oi
(
¨gv
[1]);

46 
	`mosquôto_lib_öô
();

48 
mosq
 = 
	`mosquôto_√w
("ªque°-ã°", 
åue
, 
NULL
);

49 
	`mosquôto_›ts_£t
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, &
vî
);

50 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

51 
	`mosquôto_subs¸ibe_ˇŒback_£t
(
mosq
, 
⁄_subs¸ibe
);

52 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
⁄_mesßge
);

54 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

56 
run
 == -1){

57 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

60 
	`mosquôto_lib_˛ónup
();

61  
run
;

62 
	}
}

	@test/lib/c/04-retain-qos0.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_publish
(
mosq
, 
NULL
, "ªèö/qos0/ã°", 
	`°æí
("ªèöed mesßge"), "ªèöed mesßge", 0, 
åue
);

16 
	}
}

18 
	$maö
(
¨gc
, *
¨gv
[])

20 
rc
;

21 
mosquôto
 *
mosq
;

23 
p‹t
 = 
	`©oi
(
¨gv
[1]);

25 
	`mosquôto_lib_öô
();

27 
mosq
 = 
	`mosquôto_√w
("ªèö-qos0-ã°", 
åue
, 
NULL
);

28 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

30 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

32 
run
 == -1){

33 
	`mosquôto_lo›
(
mosq
, -1, 1);

36 
	`mosquôto_lib_˛ónup
();

37  
run
;

38 
	}
}

	@test/lib/c/08-ssl-bad-cacert.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<mosquôto.h
>

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
rc
 = 1;

10 
mosquôto
 *
mosq
;

12 
	`mosquôto_lib_öô
();

14 
mosq
 = 
	`mosquôto_√w
("08-s¶-bad-ˇ˚π", 
åue
, 
NULL
);

15 if(
	`mosquôto_és_£t
(
mosq
, "this/fûe/d€¢t/exi°", 
NULL
, NULL, NULL, NULLË=
MOSQ_ERR_INVAL
){

16 
rc
 = 0;

18 
	`mosquôto_lib_˛ónup
();

19  
rc
;

20 
	}
}

	@test/lib/c/08-ssl-connect-cert-auth-enc.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<mosquôto.h
>

8 
	grun
 = -1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 
	`mosquôto_disc⁄√˘
(
mosq
);

17 
	}
}

19 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

21 
run
 = 
rc
;

22 
	}
}

24 
	$∑ssw‹d_ˇŒback
(* 
buf
, 
size
, 
rwÊag
, * 
u£rd©a
)

26 
	`°∫˝y
(
buf
, "∑ssw‹d", 
size
);

27 
buf
[
size
-1] = '\0';

29  
	`°æí
(
buf
);

30 
	}
}

32 
	$maö
(
¨gc
, *
¨gv
[])

34 
rc
;

35 
mosquôto
 *
mosq
;

37 
p‹t
 = 
	`©oi
(
¨gv
[1]);

39 
	`mosquôto_lib_öô
();

41 
mosq
 = 
	`mosquôto_√w
("08-s¶-c⁄√˘-¸t-auth-íc", 
åue
, 
NULL
);

42 
	`mosquôto_és_£t
(
mosq
, "../s¶/ã°-roŸ-ˇ.¸t", "../s¶/˚πs", "../s¶/˛õ¡-í¸y±ed.¸t", "../s¶/˛õ¡-í¸y±ed.key", 
∑ssw‹d_ˇŒback
);

43 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

44 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

46 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

48 
run
 == -1){

49 
	`mosquôto_lo›
(
mosq
, -1, 1);

52 
	`mosquôto_lib_˛ónup
();

53  
run
;

54 
	}
}

	@test/lib/c/08-ssl-connect-cert-auth.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_disc⁄√˘
(
mosq
);

16 
	}
}

18 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

20 
run
 = 
rc
;

21 
	}
}

23 
	$maö
(
¨gc
, *
¨gv
[])

25 
rc
;

26 
mosquôto
 *
mosq
;

28 
p‹t
 = 
	`©oi
(
¨gv
[1]);

30 
	`mosquôto_lib_öô
();

32 
mosq
 = 
	`mosquôto_√w
("08-s¶-c⁄√˘-¸t-auth", 
åue
, 
NULL
);

33 
	`mosquôto_és_£t
(
mosq
, "../s¶/ã°-roŸ-ˇ.¸t", "../s¶/˚πs", "../s¶/˛õ¡.¸t", "../s¶/˛õ¡.key", 
NULL
);

34 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

35 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

37 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

39 
run
 == -1){

40 
	`mosquôto_lo›
(
mosq
, -1, 1);

43 
	`mosquôto_lib_˛ónup
();

44  
run
;

45 
	}
}

	@test/lib/c/08-ssl-connect-no-auth.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 if(
rc
){

12 
	`exô
(1);

14 
	`mosquôto_disc⁄√˘
(
mosq
);

16 
	}
}

18 
	$⁄_disc⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

20 
run
 = 
rc
;

21 
	}
}

23 
	$maö
(
¨gc
, *
¨gv
[])

25 
rc
;

26 
mosquôto
 *
mosq
;

28 
p‹t
 = 
	`©oi
(
¨gv
[1]);

30 
	`mosquôto_lib_öô
();

32 
mosq
 = 
	`mosquôto_√w
("08-s¶-c⁄√˘-no-auth", 
åue
, 
NULL
);

33 
	`mosquôto_és_£t
(
mosq
, "../s¶/Æl-ˇ.¸t", 
NULL
, NULL, NULL, NULL);

34 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

35 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_disc⁄√˘
);

37 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

39 
run
 == -1){

40 
	`mosquôto_lo›
(
mosq
, -1, 1);

43 
	`mosquôto_lib_˛ónup
();

44  
run
;

45 
	}
}

	@test/lib/c/08-ssl-fake-cacert.c

1 
	~<î∫o.h
>

2 
	~<°dboﬁ.h
>

3 
	~<°dio.h
>

4 
	~<°dlib.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

9 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

11 
	`exô
(1);

12 
	}
}

14 
	$maö
(
¨gc
, *
¨gv
[])

16 
rc
;

17 
mosquôto
 *
mosq
;

19 
p‹t
 = 
	`©oi
(
¨gv
[1]);

21 
	`mosquôto_lib_öô
();

23 
mosq
 = 
	`mosquôto_√w
("08-s¶-c⁄√˘-¸t-auth", 
åue
, 
NULL
);

24 
	`mosquôto_és_£t
(
mosq
, "../s¶/ã°-Áke-roŸ-ˇ.¸t", 
NULL
, "../ssl/client.crt", "../ssl/client.key", NULL);

25 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

27 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

29 
rc
 = 
	`mosquôto_lo›_f‹evî
(
mosq
, -1, 1);

30 if(
rc
 =
MOSQ_ERR_ERRNO
 && 
î∫o
 =
EPROTO
){

35 
	}
}

	@test/lib/c/09-util-topic-tokenise.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mosquôto.h
>

5 
	$¥öt_îr‹
(c⁄° *
t›ic
, **
t›ics
, 
t›ic_cou¡
)

7 
i
;

8 
	`¥ötf
("TOPIC: %s\n", 
t›ic
);

9 
	`¥ötf
("TOKENS: ");

10 
i
=0; i<
t›ic_cou¡
; i++){

11 
	`¥ötf
("%s", 
t›ics
[
i
]);

12 if(
i
+1<
t›ic_cou¡
){

13 
	`¥ötf
("/");

16 
	`¥ötf
("\n");

17 
	}
}

19 
	$maö
(
¨gc
, *
¨gv
[])

21 **
t›ics
;

22 
t›ic_cou¡
;

23 
boﬁ
 
m©ch
;

25 if(
	`mosquôto_sub_t›ic_tokíi£
("t›ic", &
t›ics
, &
t›ic_cou¡
)){

26 
	`¥ötf
("Out of memory.\n");

29 if(
t›ic_cou¡
 !1 || 
	`°rcmp
(
t›ics
[0], "topic")){

30 
	`¥öt_îr‹
("t›ic", 
t›ics
, 
t›ic_cou¡
);

34 if(
	`mosquôto_sub_t›ic_tokíi£
("a/dìp/t›ic/hõørchy", &
t›ics
, &
t›ic_cou¡
)){

35 
	`¥ötf
("Out of memory.\n");

38 if(
t›ic_cou¡
 != 4

39 || 
	`°rcmp
(
t›ics
[0], "a")

40 || 
	`°rcmp
(
t›ics
[1], "deep")

41 || 
	`°rcmp
(
t›ics
[2], "topic")

42 || 
	`°rcmp
(
t›ics
[3], "hierarchy")){

43 
	`¥öt_îr‹
("a/dìp/t›ic/hõørchy", 
t›ics
, 
t›ic_cou¡
);

47 if(
	`mosquôto_sub_t›ic_tokíi£
("/a/dìp/t›ic/hõørchy", &
t›ics
, &
t›ic_cou¡
)){

48 
	`¥ötf
("Out of memory.\n");

51 if(
t›ic_cou¡
 != 5

52 || 
t›ics
[0]

53 || 
	`°rcmp
(
t›ics
[1], "a")

54 || 
	`°rcmp
(
t›ics
[2], "deep")

55 || 
	`°rcmp
(
t›ics
[3], "topic")

56 || 
	`°rcmp
(
t›ics
[4], "hierarchy")){

57 
	`¥öt_îr‹
("/a/dìp/t›ic/hõørchy", 
t›ics
, 
t›ic_cou¡
);

61 if(
	`mosquôto_sub_t›ic_tokíi£
("a/b/c", &
t›ics
, &
t›ic_cou¡
)){

62 
	`¥ötf
("Out of memory.\n");

65 if(
t›ic_cou¡
 != 3

66 || 
	`°rcmp
(
t›ics
[0], "a")

67 || 
	`°rcmp
(
t›ics
[1], "b")

68 || 
	`°rcmp
(
t›ics
[2], "c")){

69 
	`¥öt_îr‹
("a/b/c", 
t›ics
, 
t›ic_cou¡
);

73 if(
	`mosquôto_sub_t›ic_tokíi£
("/a/b/c", &
t›ics
, &
t›ic_cou¡
)){

74 
	`¥ötf
("Out of memory.\n");

77 if(
t›ic_cou¡
 != 4

78 || 
t›ics
[0]

79 || 
	`°rcmp
(
t›ics
[1], "a")

80 || 
	`°rcmp
(
t›ics
[2], "b")

81 || 
	`°rcmp
(
t›ics
[3], "c")){

82 
	`¥öt_îr‹
("/a/b/c", 
t›ics
, 
t›ic_cou¡
);

86 if(
	`mosquôto_sub_t›ic_tokíi£
("a///hõørchy", &
t›ics
, &
t›ic_cou¡
)){

87 
	`¥ötf
("Out of memory.\n");

90 if(
t›ic_cou¡
 != 4

91 || 
	`°rcmp
(
t›ics
[0], "a")

92 || 
t›ics
[1]

93 || 
t›ics
[2]

94 || 
	`°rcmp
(
t›ics
[3], "hierarchy")){

95 
	`¥öt_îr‹
("a///hõørchy", 
t›ics
, 
t›ic_cou¡
);

99 if(
	`mosquôto_sub_t›ic_tokíi£
("/a///hõørchy", &
t›ics
, &
t›ic_cou¡
)){

100 
	`¥ötf
("Out of memory.\n");

103 if(
t›ic_cou¡
 != 5

104 || 
t›ics
[0]

105 || 
	`°rcmp
(
t›ics
[1], "a")

106 || 
t›ics
[2]

107 || 
t›ics
[3]

108 || 
	`°rcmp
(
t›ics
[4], "hierarchy")){

109 
	`¥öt_îr‹
("/a///hõørchy", 
t›ics
, 
t›ic_cou¡
);

113 if(
	`mosquôto_sub_t›ic_tokíi£
("/a///hõørchy/", &
t›ics
, &
t›ic_cou¡
)){

114 
	`¥ötf
("Out of memory.\n");

117 if(
t›ic_cou¡
 != 6

118 || 
t›ics
[0]

119 || 
	`°rcmp
(
t›ics
[1], "a")

120 || 
t›ics
[2]

121 || 
t›ics
[3]

122 || 
	`°rcmp
(
t›ics
[4], "hierarchy")

123 || 
t›ics
[3]){

124 
	`¥öt_îr‹
("/a///hõørchy/", 
t›ics
, 
t›ic_cou¡
);

129 
	}
}

	@test/lib/c/11-prop-oversize-packet.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

7 
	grun
 = -1;

8 
	g£¡_mid
 = -1;

10 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

12 if(
rc
){

13 
	`exô
(1);

15 
rc
 = 
	`mosquôto_subs¸ibe
(
mosq
, 
NULL
, "0123456789012345678901234567890", 0);

16 if(
rc
 !
MOSQ_ERR_OVERSIZE_PACKET
){

17 
	`¥ötf
("Fail on subscribe\n");

18 
	`exô
(1);

21 
rc
 = 
	`mosquôto_unsubs¸ibe
(
mosq
, 
NULL
, "0123456789012345678901234567890");

22 if(
rc
 !
MOSQ_ERR_OVERSIZE_PACKET
){

23 
	`¥ötf
("Fail on unsubscribe\n");

24 
	`exô
(1);

27 
rc
 = 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "pub/ã°", 
	`°æí
("0123456789012345678"), "0123456789012345678", 0, 
Ál£
);

28 if(
rc
 !
MOSQ_ERR_OVERSIZE_PACKET
){

29 
	`¥ötf
("Fail onÖublish 1\n");

30 
	`exô
(1);

32 
rc
 = 
	`mosquôto_publish
(
mosq
, &
£¡_mid
, "pub/ã°", 
	`°æí
("012345678901234567"), "012345678901234567", 0, 
Ál£
);

33 if(
rc
 !
MOSQ_ERR_SUCCESS
){

34 
	`¥ötf
("Fail onÖublish 2\n");

35 
	`exô
(1);

38 
	}
}

40 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

42 if(
mid
 =
£¡_mid
){

43 
	`mosquôto_disc⁄√˘
(
mosq
);

44 
run
 = 0;

46 
	`exô
(1);

48 
	}
}

50 
	$maö
(
¨gc
, *
¨gv
[])

52 
rc
;

53 
mosquôto
 *
mosq
;

55 
p‹t
 = 
	`©oi
(
¨gv
[1]);

57 
	`mosquôto_lib_öô
();

59 
mosq
 = 
	`mosquôto_√w
("publish-qos0-ã°", 
åue
, 
NULL
);

60 
	`mosquôto_öt_›ti⁄
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, 
MQTT_PROTOCOL_V5
);

61 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

62 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

64 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

66 
run
 == -1){

67 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

70 
	`mosquôto_lib_˛ónup
();

71  
run
;

72 
	}
}

	@test/lib/c/11-prop-send-content-type.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

6 
	~<mqâ_¥Ÿocﬁ.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
 = -1;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 
rc2
;

14 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

16 if(
rc
){

17 
	`exô
(1);

19 
rc2
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_CONTENT_TYPE
, "application/json");

20 
	`mosquôto_publish_v5
(
mosq
, &
£¡_mid
, "¥›/qos0", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
, 
¥›li°
);

22 
	}
}

24 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

26 if(
mid
 =
£¡_mid
){

27 
	`mosquôto_disc⁄√˘
(
mosq
);

28 
run
 = 0;

30 
	`exô
(1);

32 
	}
}

34 
	$maö
(
¨gc
, *
¨gv
[])

36 
rc
;

37 
tmp
;

38 
mosquôto
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
	`mosquôto_lib_öô
();

44 
mosq
 = 
	`mosquôto_√w
("¥›-ã°", 
åue
, 
NULL
);

45 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

46 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

47 
tmp
 = 
MQTT_PROTOCOL_V5
;

48 
	`mosquôto_›ts_£t
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, &
tmp
);

50 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

52 
run
 == -1){

53 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

56 
	`mosquôto_lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/c/11-prop-send-payload-format.c

1 
	~<°dboﬁ.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<mosquôto.h
>

6 
	~<mqâ_¥Ÿocﬁ.h
>

8 
	grun
 = -1;

9 
	g£¡_mid
 = -1;

11 
	$⁄_c⁄√˘
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

13 
rc2
;

14 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

16 if(
rc
){

17 
	`exô
(1);

19 
rc2
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

20 
	`mosquôto_publish_v5
(
mosq
, &
£¡_mid
, "¥›/qos0", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
, 
¥›li°
);

22 
	}
}

24 
	$⁄_publish
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

26 if(
mid
 =
£¡_mid
){

27 
	`mosquôto_disc⁄√˘
(
mosq
);

28 
run
 = 0;

30 
	`exô
(1);

32 
	}
}

34 
	$maö
(
¨gc
, *
¨gv
[])

36 
rc
;

37 
tmp
;

38 
mosquôto
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
	`mosquôto_lib_öô
();

44 
mosq
 = 
	`mosquôto_√w
("¥›-ã°", 
åue
, 
NULL
);

45 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
⁄_c⁄√˘
);

46 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
⁄_publish
);

47 
tmp
 = 
MQTT_PROTOCOL_V5
;

48 
	`mosquôto_›ts_£t
(
mosq
, 
MOSQ_OPT_PROTOCOL_VERSION
, &
tmp
);

50 
rc
 = 
	`mosquôto_c⁄√˘
(
mosq
, "loˇlho°", 
p‹t
, 60);

52 
run
 == -1){

53 
rc
 = 
	`mosquôto_lo›
(
mosq
, -1, 1);

56 
	`mosquôto_lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/cpp/01-con-discon-success.cpp

4 
	~<mosquôt›p.h
>

6 
	grun
 = -1;

8 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


10 
public
:

11 
mosquôt›p_ã°
(c⁄° *
id
);

13 
⁄_c⁄√˘
(
rc
);

14 
⁄_disc⁄√˘
(
rc
);

17 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

19 
	}
}

21 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

23 if(
rc
){

24 
	`exô
(1);

26 
	`disc⁄√˘
();

28 
	}
}

30 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

32 
run
 = 
rc
;

33 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
mosquôt›p_ã°
 *
mosq
;

40 
p‹t
 = 
	`©oi
(
¨gv
[1]);

42 
mosqµ
::
	`lib_öô
();

44 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-con-discon-success");

46 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

48 
run
 == -1){

49 
mosq
->
	`lo›
();

52 
mosqµ
::
	`lib_˛ónup
();

54  
run
;

55 
	}
}

	@test/lib/cpp/01-keepalive-pingreq.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

13 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

15 
	}
}

17 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

19 if(
rc
){

20 
	`exô
(1);

22 
	}
}

24 
	$maö
(
¨gc
, *
¨gv
[])

26 
mosquôt›p_ã°
 *
mosq
;

28 
p‹t
 = 
	`©oi
(
¨gv
[1]);

30 
mosqµ
::
	`lib_öô
();

32 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-keepalive-pingreq");

34 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 4);

36 
run
 == -1){

37 
mosq
->
	`lo›
();

40 
mosqµ
::
	`lib_˛ónup
();

42  
run
;

43 
	}
}

	@test/lib/cpp/01-no-clean-session.cpp

1 
	~<c°rög
>

2 
	~<mosquôt›p.h
>

4 
	grun
 = -1;

6 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


8 
public
:

9 
mosquôt›p_ã°
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
);

12 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
Ë: 
mosqµ
::
	$mosquôt›p
(
id
, 
˛ón_£ssi⁄
)

14 
	}
}

16 
	$maö
(
¨gc
, *
¨gv
[])

18 
mosquôt›p_ã°
 *
mosq
;

20 
p‹t
 = 
	`©oi
(
¨gv
[1]);

22 
mosqµ
::
	`lib_öô
();

24 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-no-˛ón-£ssi⁄", 
Ál£
);

26 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

28 
run
 == -1){

29 
mosq
->
	`lo›
();

32 
mosqµ
::
	`lib_˛ónup
();

34  
run
;

35 
	}
}

	@test/lib/cpp/01-unpwd-set.cpp

1 
	~<c°rög
>

2 
	~<mosquôt›p.h
>

4 
	grun
 = -1;

6 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


8 
public
:

9 
mosquôt›p_ã°
(c⁄° *
id
);

12 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

14 
	}
}

16 
	$maö
(
¨gc
, *
¨gv
[])

18 
mosquôt›p_ã°
 *
mosq
;

20 
p‹t
 = 
	`©oi
(
¨gv
[1]);

22 
mosqµ
::
	`lib_öô
();

24 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-unpwd-set");

25 
mosq
->
	`u£∫ame_pw_£t
("uname", ";'[08gn=#");

27 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

29 
run
 == -1){

30 
mosq
->
	`lo›
();

33 
mosqµ
::
	`lib_˛ónup
();

35  
run
;

36 
	}
}

	@test/lib/cpp/01-will-set.cpp

4 
	~<c°rög
>

5 
	~<mosquôt›p.h
>

7 
	grun
 = -1;

9 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


11 
public
:

12 
mosquôt›p_ã°
(c⁄° *
id
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
	$maö
(
¨gc
, *
¨gv
[])

21 
mosquôt›p_ã°
 *
mosq
;

23 
p‹t
 = 
	`©oi
(
¨gv
[1]);

25 
mosqµ
::
	`lib_öô
();

27 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-will-set");

28 
mosq
->
	`wûl_£t
("t›ic/⁄/u√x≥˘ed/disc⁄√˘", 
	`°æí
("wû»mesßge"), "wû»mesßge", 1, 
åue
);

30 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

32 
run
 == -1){

33 
mosq
->
	`lo›
();

36 
mosqµ
::
	`lib_˛ónup
();

38  
run
;

39 
	}
}

	@test/lib/cpp/01-will-unpwd-set.cpp

1 
	~<c°rög
>

2 
	~<mosquôt›p.h
>

4 
	grun
 = -1;

6 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


8 
public
:

9 
mosquôt›p_ã°
(c⁄° *
id
);

12 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

14 
	}
}

16 
	$maö
(
¨gc
, *
¨gv
[])

18 
mosquôt›p_ã°
 *
mosq
;

20 
p‹t
 = 
	`©oi
(
¨gv
[1]);

22 
mosqµ
::
	`lib_öô
();

24 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("01-will-unpwd-set");

25 
mosq
->
	`u£∫ame_pw_£t
("oibvvwqw", "#'^2hg9a&nm38*us");

26 
mosq
->
	`wûl_£t
("wûl-t›ic", 
	`°æí
("wû»mesßge"), "wû»mesßge", 2, 
Ál£
);

28 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

30 
run
 == -1){

31 
mosq
->
	`lo›
();

34 
mosqµ
::
	`lib_˛ónup
();

36  
run
;

37 
	}
}

	@test/lib/cpp/02-subscribe-qos0.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

12 
⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

21 if(
rc
){

22 
	`exô
(1);

24 
	`subs¸ibe
(
NULL
, "qos0/test", 0);

26 
	}
}

28 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

30 
run
 = 
rc
;

31 
	}
}

33 
	gmosquôt›p_ã°
::
	$⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

35 
	`disc⁄√˘
();

36 
	}
}

38 
	$maö
(
¨gc
, *
¨gv
[])

40 
mosquôt›p_ã°
 *
mosq
;

42 
p‹t
 = 
	`©oi
(
¨gv
[1]);

44 
mosqµ
::
	`lib_öô
();

46 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("subscribe-qos0-test");

48 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

50 
run
 == -1){

51 
mosq
->
	`lo›
();

54 
mosqµ
::
	`lib_˛ónup
();

56  
run
;

57 
	}
}

	@test/lib/cpp/02-subscribe-qos1.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

12 
⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

21 if(
rc
){

22 
	`exô
(1);

24 
	`subs¸ibe
(
NULL
, "qos1/test", 1);

26 
	}
}

28 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

30 
run
 = 
rc
;

31 
	}
}

33 
	gmosquôt›p_ã°
::
	$⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

35 
	`disc⁄√˘
();

36 
	}
}

39 
	$maö
(
¨gc
, *
¨gv
[])

41 
mosquôt›p_ã°
 *
mosq
;

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
mosqµ
::
	`lib_öô
();

47 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("subscribe-qos1-test");

49 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

51 
run
 == -1){

52 
mosq
->
	`lo›
();

55 
mosqµ
::
	`lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/cpp/02-subscribe-qos2.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

12 
⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

21 if(
rc
){

22 
	`exô
(1);

24 
	`subs¸ibe
(
NULL
, "qos2/test", 2);

26 
	}
}

28 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

30 
run
 = 
rc
;

31 
	}
}

33 
	gmosquôt›p_ã°
::
	$⁄_subs¸ibe
(
mid
, 
qos_cou¡
, c⁄° *
gø¡ed_qos
)

35 
	`disc⁄√˘
();

36 
	}
}

39 
	$maö
(
¨gc
, *
¨gv
[])

41 
mosquôt›p_ã°
 *
mosq
;

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
mosqµ
::
	`lib_öô
();

47 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("subscribe-qos2-test");

49 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

51 
run
 == -1){

52 
mosq
->
	`lo›
();

55 
mosqµ
::
	`lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/cpp/02-unsubscribe.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

12 
⁄_unsubs¸ibe
(
mid
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

21 if(
rc
){

22 
	`exô
(1);

24 
	`unsubs¸ibe
(
NULL
, "unsubscribe/test");

26 
	}
}

28 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

30 
run
 = 
rc
;

31 
	}
}

33 
	gmosquôt›p_ã°
::
	$⁄_unsubs¸ibe
(
mid
)

35 
	`disc⁄√˘
();

36 
	}
}

38 
	$maö
(
¨gc
, *
¨gv
[])

40 
mosquôt›p_ã°
 *
mosq
;

42 
p‹t
 = 
	`©oi
(
¨gv
[1]);

44 
mosqµ
::
	`lib_öô
();

46 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("unsubscribe-test");

48 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

50 
run
 == -1){

51 
mosq
->
	`lo›
();

54 
mosqµ
::
	`lib_˛ónup
();

56  
run
;

57 
	}
}

	@test/lib/cpp/03-publish-b2c-qos1.cpp

1 
	~<c°dio
>

2 
	~<c°dlib
>

3 
	~<c°rög
>

5 
	~<mosquôt›p.h
>

7 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


9 
public
:

10 
mosquôt›p_ã°
(c⁄° *
id
);

12 
⁄_c⁄√˘
(
rc
);

13 
⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
msg
);

16 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

18 
	}
}

20 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

22 if(
rc
){

23 
	`exô
(1);

25 
	}
}

27 
	gmosquôt›p_ã°
::
	$⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
msg
)

29 if(
msg
->
mid
 != 123){

30 
	`¥ötf
("InvÆid mid (%d)\n", 
msg
->
mid
);

31 
	`exô
(1);

33 if(
msg
->
qos
 != 1){

34 
	`¥ötf
("InvÆid qo†(%d)\n", 
msg
->
qos
);

35 
	`exô
(1);

37 if(
	`°rcmp
(
msg
->
t›ic
, "pub/qos1/receive")){

38 
	`¥ötf
("InvÆidÅ›i¯(%s)\n", 
msg
->
t›ic
);

39 
	`exô
(1);

41 if(
	`°rcmp
((*)
msg
->
∑ylﬂd
, "message")){

42 
	`¥ötf
("InvÆidÖaylﬂd (%s)\n", (*)
msg
->
∑ylﬂd
);

43 
	`exô
(1);

45 if(
msg
->
∑ylﬂdÀn
 != 7){

46 
	`¥ötf
("InvÆidÖaylﬂdÀ¿(%d)\n", 
msg
->
∑ylﬂdÀn
);

47 
	`exô
(1);

49 if(
msg
->
ªèö
 !
Ál£
){

50 
	`¥ötf
("InvÆidÑëaö (%d)\n", 
msg
->
ªèö
);

51 
	`exô
(1);

54 
	`exô
(0);

55 
	}
}

57 
	$maö
(
¨gc
, *
¨gv
[])

59 
mosquôt›p_ã°
 *
mosq
;

61 
p‹t
 = 
	`©oi
(
¨gv
[1]);

63 
mosqµ
::
	`lib_öô
();

65 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos1-test");

66 
mosq
->
	`mesßge_ªåy_£t
(3);

68 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

71 
mosq
->
	`lo›
();

74 
mosqµ
::
	`lib_˛ónup
();

77 
	}
}

	@test/lib/cpp/03-publish-b2c-qos2.cpp

1 
	~<c°dio
>

2 
	~<c°dlib
>

3 
	~<c°rög
>

5 
	~<mosquôt›p.h
>

7 
	grun
 = -1;

9 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


11 
public
:

12 
mosquôt›p_ã°
(c⁄° *
id
);

14 
⁄_c⁄√˘
(
rc
);

15 
⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
msg
);

18 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

20 
	}
}

22 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

24 if(
rc
){

25 
	`exô
(1);

27 
	}
}

29 
	gmosquôt›p_ã°
::
	$⁄_mesßge
(c⁄° 
mosquôto_mesßge
 *
msg
)

31 if(
msg
->
mid
 != 13423){

32 
	`¥ötf
("InvÆid mid (%d)\n", 
msg
->
mid
);

33 
	`exô
(1);

35 if(
msg
->
qos
 != 2){

36 
	`¥ötf
("InvÆid qo†(%d)\n", 
msg
->
qos
);

37 
	`exô
(1);

39 if(
	`°rcmp
(
msg
->
t›ic
, "pub/qos2/receive")){

40 
	`¥ötf
("InvÆidÅ›i¯(%s)\n", 
msg
->
t›ic
);

41 
	`exô
(1);

43 if(
	`°rcmp
((*)
msg
->
∑ylﬂd
, "message")){

44 
	`¥ötf
("InvÆidÖaylﬂd (%s)\n", (*)
msg
->
∑ylﬂd
);

45 
	`exô
(1);

47 if(
msg
->
∑ylﬂdÀn
 != 7){

48 
	`¥ötf
("InvÆidÖaylﬂdÀ¿(%d)\n", 
msg
->
∑ylﬂdÀn
);

49 
	`exô
(1);

51 if(
msg
->
ªèö
 !
Ál£
){

52 
	`¥ötf
("InvÆidÑëaö (%d)\n", 
msg
->
ªèö
);

53 
	`exô
(1);

56 
run
 = 0;

57 
	}
}

59 
	$maö
(
¨gc
, *
¨gv
[])

61 
mosquôt›p_ã°
 *
mosq
;

63 
p‹t
 = 
	`©oi
(
¨gv
[1]);

65 
mosqµ
::
	`lib_öô
();

67 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos2-test");

68 
mosq
->
	`mesßge_ªåy_£t
(3);

70 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

72 
run
 == -1){

73 
mosq
->
	`lo›
();

76 
mosqµ
::
	`lib_˛ónup
();

78  
run
;

79 
	}
}

	@test/lib/cpp/03-publish-c2b-qos1-disconnect.cpp

1 
	~<c°dlib
>

2 
	~<c°rög
>

4 
	~<mosquôt›p.h
>

6 
	grun
 = -1;

7 
	gfú°_c⁄√˘i⁄
 = 1;

9 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


11 
public
:

12 
mosquôt›p_ã°
(c⁄° *
id
);

14 
⁄_c⁄√˘
(
rc
);

15 
⁄_disc⁄√˘
(
rc
);

16 
⁄_publish
(
mid
);

19 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

21 
	}
}

23 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

25 if(
rc
){

26 
	`exô
(1);

28 if(
fú°_c⁄√˘i⁄
 == 1){

29 
	`publish
(
NULL
, "pub/qos1/ã°", 
	`°æí
("mesßge"), "mesßge", 1, 
Ál£
);

30 
fú°_c⁄√˘i⁄
 = 0;

33 
	}
}

35 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

37 if(
rc
){

38 
	`ªc⁄√˘
();

40 
run
 = 0;

42 
	}
}

44 
	gmosquôt›p_ã°
::
	$⁄_publish
(
mid
)

46 
	`disc⁄√˘
();

47 
	}
}

49 
	$maö
(
¨gc
, *
¨gv
[])

51 
mosquôt›p_ã°
 *
mosq
;

53 
p‹t
 = 
	`©oi
(
¨gv
[1]);

55 
mosqµ
::
	`lib_öô
();

57 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos1-test");

58 
mosq
->
	`mesßge_ªåy_£t
(3);

60 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

62 
run
 == -1){

63 
mosq
->
	`lo›
();

66 
mosqµ
::
	`lib_˛ónup
();

68  
run
;

69 
	}
}

	@test/lib/cpp/03-publish-c2b-qos2-disconnect.cpp

1 
	~<c°dlib
>

2 
	~<c°rög
>

4 
	~<mosquôt›p.h
>

6 
	grun
 = -1;

7 
	gfú°_c⁄√˘i⁄
 = 1;

9 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


11 
public
:

12 
mosquôt›p_ã°
(c⁄° *
id
);

14 
⁄_c⁄√˘
(
rc
);

15 
⁄_disc⁄√˘
(
rc
);

16 
⁄_publish
(
mid
);

19 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

21 
	}
}

23 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

25 if(
rc
){

26 
	`exô
(1);

28 if(
fú°_c⁄√˘i⁄
 == 1){

29 
	`publish
(
NULL
, "pub/qos2/ã°", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

30 
fú°_c⁄√˘i⁄
 = 0;

33 
	}
}

35 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

37 if(
rc
){

38 
	`ªc⁄√˘
();

40 
run
 = 0;

42 
	}
}

44 
	gmosquôt›p_ã°
::
	$⁄_publish
(
mid
)

46 
	`disc⁄√˘
();

47 
	}
}

49 
	$maö
(
¨gc
, *
¨gv
[])

51 
mosquôt›p_ã°
 *
mosq
;

53 
p‹t
 = 
	`©oi
(
¨gv
[1]);

55 
mosqµ
::
	`lib_öô
();

57 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos2-test");

58 
mosq
->
	`mesßge_ªåy_£t
(3);

60 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

62 
run
 == -1){

63 
mosq
->
	`lo›
();

66 
mosqµ
::
	`lib_˛ónup
();

68  
run
;

69 
	}
}

	@test/lib/cpp/03-publish-c2b-qos2.cpp

1 
	~<c°dlib
>

2 
	~<c°rög
>

4 
	~<mosquôt›p.h
>

6 
	grun
 = -1;

8 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


10 
public
:

11 
mosquôt›p_ã°
(c⁄° *
id
);

13 
⁄_c⁄√˘
(
rc
);

14 
⁄_disc⁄√˘
(
rc
);

15 
⁄_publish
(
mid
);

18 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

20 
	}
}

22 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

24 if(
rc
){

25 
	`exô
(1);

27 
	`publish
(
NULL
, "pub/qos2/ã°", 
	`°æí
("mesßge"), "mesßge", 2, 
Ál£
);

29 
	}
}

31 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

33 
run
 = 0;

34 
	}
}

36 
	gmosquôt›p_ã°
::
	$⁄_publish
(
mid
)

38 
	`disc⁄√˘
();

39 
	}
}

41 
	$maö
(
¨gc
, *
¨gv
[])

43 
mosquôt›p_ã°
 *
mosq
;

45 
p‹t
 = 
	`©oi
(
¨gv
[1]);

47 
mosqµ
::
	`lib_öô
();

49 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos2-test");

51 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

53 
run
 == -1){

54 
mosq
->
	`lo›
();

57 
mosqµ
::
	`lib_˛ónup
();

59  
run
;

60 
	}
}

	@test/lib/cpp/03-publish-qos0-no-payload.cpp

1 
	~<c°rög
>

3 
	~<mosquôt›p.h
>

5 
	grun
 = -1;

6 
	g£¡_mid
 = -1;

8 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


10 
public
:

11 
mosquôt›p_ã°
(c⁄° *
id
);

13 
⁄_c⁄√˘
(
rc
);

14 
⁄_publish
(
mid
);

17 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

19 
	}
}

21 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

23 if(
rc
){

24 
	`exô
(1);

26 
	`publish
(&
£¡_mid
, "pub/qos0/no-∑ylﬂd/ã°", 0, 
NULL
, 0, 
Ál£
);

28 
	}
}

30 
	gmosquôt›p_ã°
::
	$⁄_publish
(
mid
)

32 if(
£¡_mid
 =
mid
){

33 
	`disc⁄√˘
();

35 
	`exô
(1);

37 
	}
}

39 
	$maö
(
¨gc
, *
¨gv
[])

41 
mosquôt›p_ã°
 *
mosq
;

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
mosqµ
::
	`lib_öô
();

47 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos0-test-np");

49 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

51 
run
 == -1){

52 
mosq
->
	`lo›
();

55 
mosqµ
::
	`lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/cpp/03-publish-qos0.cpp

1 
	~<c°rög
>

3 
	~<mosquôt›p.h
>

5 
	grun
 = -1;

6 
	g£¡_mid
 = -1;

8 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


10 
public
:

11 
mosquôt›p_ã°
(c⁄° *
id
);

13 
⁄_c⁄√˘
(
rc
);

14 
⁄_publish
(
mid
);

17 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

19 
	}
}

21 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

23 if(
rc
){

24 
	`exô
(1);

26 
	`publish
(&
£¡_mid
, "pub/qos0/ã°", 
	`°æí
("mesßge"), "mesßge", 0, 
Ál£
);

28 
	}
}

30 
	gmosquôt›p_ã°
::
	$⁄_publish
(
mid
)

32 if(
£¡_mid
 =
mid
){

33 
	`disc⁄√˘
();

35 
	`exô
(1);

37 
	}
}

39 
	$maö
(
¨gc
, *
¨gv
[])

41 
mosquôt›p_ã°
 *
mosq
;

43 
p‹t
 = 
	`©oi
(
¨gv
[1]);

45 
mosqµ
::
	`lib_öô
();

47 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("publish-qos0-test");

49 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

51 
run
 == -1){

52 
mosq
->
	`lo›
();

55 
mosqµ
::
	`lib_˛ónup
();

57  
run
;

58 
	}
}

	@test/lib/cpp/04-retain-qos0.cpp

1 
	~<c°rög
>

3 
	~<mosquôt›p.h
>

5 
	grun
 = -1;

7 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


9 
public
:

10 
mosquôt›p_ã°
(c⁄° *
id
);

12 
⁄_c⁄√˘
(
rc
);

15 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

17 
	}
}

19 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

21 if(
rc
){

22 
	`exô
(1);

24 
	`publish
(
NULL
, "ªèö/qos0/ã°", 
	`°æí
("ªèöed mesßge"), "ªèöed mesßge", 0, 
åue
);

26 
	}
}

28 
	$maö
(
¨gc
, *
¨gv
[])

30 
mosquôt›p_ã°
 *
mosq
;

32 
p‹t
 = 
	`©oi
(
¨gv
[1]);

34 
mosqµ
::
	`lib_öô
();

36 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("retain-qos0-test");

38 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

40 
run
 == -1){

41 
mosq
->
	`lo›
();

44 
mosqµ
::
	`lib_˛ónup
();

46  
run
;

47 
	}
}

	@test/lib/cpp/08-ssl-bad-cacert.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

11 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

13 
	}
}

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
mosquôt›p_ã°
 *
mosq
;

18 
rc
 = 1;

20 
mosqµ
::
	`lib_öô
();

22 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("08-ssl-bad-cacert");

24 
mosq
->
	`és_›ts_£t
(1, "ésv1", 
NULL
);

25 if(
mosq
->
	`és_£t
("this/fûe/d€¢t/exi°"Ë=
MOSQ_ERR_INVAL
){

26 
rc
 = 0;

28 
mosqµ
::
	`lib_˛ónup
();

30  
rc
;

31 
	}
}

	@test/lib/cpp/08-ssl-connect-cert-auth-enc.cpp

1 
	~<c°rög
>

2 
	~<mosquôt›p.h
>

4 
	grun
 = -1;

6 
	$∑ssw‹d_ˇŒback
(* 
buf
, 
size
, 
rwÊag
, * 
u£rd©a
)

8 
	`°∫˝y
(
buf
, "∑ssw‹d", 
size
);

9 
buf
[
size
-1] = '\0';

11  
	`°æí
(
buf
);

12 
	}
}

14 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


16 
public
:

17 
mosquôt›p_ã°
(c⁄° *
id
);

19 
⁄_c⁄√˘
(
rc
);

20 
⁄_disc⁄√˘
(
rc
);

23 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

25 
	}
}

27 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

29 if(
rc
){

30 
	`exô
(1);

32 
	`disc⁄√˘
();

34 
	}
}

36 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

38 
run
 = 
rc
;

39 
	}
}

42 
	$maö
(
¨gc
, *
¨gv
[])

44 
mosquôt›p_ã°
 *
mosq
;

46 
p‹t
 = 
	`©oi
(
¨gv
[1]);

48 
mosqµ
::
	`lib_öô
();

50 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("08-ssl-connect-crt-auth-enc");

52 
mosq
->
	`és_›ts_£t
(1, "ésv1", 
NULL
);

54 
mosq
->
	`és_£t
("../s¶/Æl-ˇ.¸t", 
NULL
, "../s¶/˛õ¡-í¸y±ed.¸t", "../s¶/˛õ¡-í¸y±ed.key", 
∑ssw‹d_ˇŒback
);

55 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

57 
run
 == -1){

58 
mosq
->
	`lo›
();

61 
mosqµ
::
	`lib_˛ónup
();

63  
run
;

64 
	}
}

	@test/lib/cpp/08-ssl-connect-cert-auth.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

14 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

16 
	}
}

18 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

20 if(
rc
){

21 
	`exô
(1);

23 
	`disc⁄√˘
();

25 
	}
}

27 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

29 
run
 = 
rc
;

30 
	}
}

33 
	$maö
(
¨gc
, *
¨gv
[])

35 
mosquôt›p_ã°
 *
mosq
;

37 
p‹t
 = 
	`©oi
(
¨gv
[1]);

39 
mosqµ
::
	`lib_öô
();

41 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("08-ssl-connect-crt-auth");

43 
mosq
->
	`és_›ts_£t
(1, "ésv1", 
NULL
);

45 
mosq
->
	`és_£t
("../s¶/Æl-ˇ.¸t", 
NULL
, "../ssl/client.crt", "../ssl/client.key");

46 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

48 
run
 == -1){

49 
mosq
->
	`lo›
();

52 
mosqµ
::
	`lib_˛ónup
();

54  
run
;

55 
	}
}

	@test/lib/cpp/08-ssl-connect-no-auth.cpp

1 
	~<mosquôt›p.h
>

3 
	grun
 = -1;

5 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


7 
public
:

8 
mosquôt›p_ã°
(c⁄° *
id
);

10 
⁄_c⁄√˘
(
rc
);

11 
⁄_disc⁄√˘
(
rc
);

14 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

16 
	}
}

18 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

20 if(
rc
){

21 
	`exô
(1);

23 
	`disc⁄√˘
();

25 
	}
}

27 
	gmosquôt›p_ã°
::
	$⁄_disc⁄√˘
(
rc
)

29 
run
 = 
rc
;

30 
	}
}

33 
	$maö
(
¨gc
, *
¨gv
[])

35 
mosquôt›p_ã°
 *
mosq
;

37 
p‹t
 = 
	`©oi
(
¨gv
[1]);

39 
mosqµ
::
	`lib_öô
();

41 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("08-ssl-connect-no-auth");

43 
mosq
->
	`és_›ts_£t
(1, "ésv1", 
NULL
);

45 
mosq
->
	`és_£t
("../ssl/all-ca.crt");

46 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

48 
run
 == -1){

49 
mosq
->
	`lo›
();

52 
mosqµ
::
	`lib_˛ónup
();

54  
run
;

55 
	}
}

	@test/lib/cpp/08-ssl-fake-cacert.cpp

1 
	~<î∫o.h
>

2 
	~<mosquôt›p.h
>

4 
	grun
 = -1;

6 ˛as†
	cmosquôt›p_ã°
 : 
public
 
mosqµ
::
mosquôt›p


8 
public
:

9 
mosquôt›p_ã°
(c⁄° *
id
);

11 
⁄_c⁄√˘
(
rc
);

14 
	gmosquôt›p_ã°
::
	$mosquôt›p_ã°
(c⁄° *
id
Ë: 
mosqµ
::
	$mosquôt›p
(
id
)

16 
	}
}

18 
mosquôt›p_ã°
::
	$⁄_c⁄√˘
(
rc
)

20 
	`exô
(1);

21 
	}
}

23 
	$maö
(
¨gc
, *
¨gv
[])

25 
mosquôt›p_ã°
 *
mosq
;

26 
rc
;

28 
p‹t
 = 
	`©oi
(
¨gv
[1]);

30 
mosqµ
::
	`lib_öô
();

32 
mosq
 = 
√w
 
	`mosquôt›p_ã°
("08-ssl-fake-cacert");

34 
mosq
->
	`és_›ts_£t
(1, "ésv1", 
NULL
);

35 
mosq
->
	`és_£t
("../s¶/ã°-Áke-roŸ-ˇ.¸t", 
NULL
, "../ssl/client.crt", "../ssl/client.key");

36 
mosq
->
	`c⁄√˘
("loˇlho°", 
p‹t
, 60);

38 
rc
 = 
mosq
->
	`lo›_f‹evî
();

39 if(
rc
 =
MOSQ_ERR_ERRNO
 && 
î∫o
 =
EPROTO
){

44 
	}
}

	@test/lib/cpp/09-util-topic-tokenise.cpp

1 
	~<c°dio
>

2 
	~<c°rög
>

3 
	~<mosquôt›p.h
>

5 
	$¥öt_îr‹
(c⁄° *
t›ic
, **
t›ics
, 
t›ic_cou¡
)

7 
i
;

8 
	`¥ötf
("TOPIC: %s\n", 
t›ic
);

9 
	`¥ötf
("TOKENS: ");

10 
i
=0; i<
t›ic_cou¡
; i++){

11 
	`¥ötf
("%s", 
t›ics
[
i
]);

12 if(
i
+1<
t›ic_cou¡
){

13 
	`¥ötf
("/");

16 
	`¥ötf
("\n");

17 
	}
}

19 
	$maö
(
¨gc
, *
¨gv
[])

21 **
t›ics
;

22 
t›ic_cou¡
;

24 if(
mosqµ
::
	`sub_t›ic_tokíi£
("t›ic", &
t›ics
, &
t›ic_cou¡
)){

25 
	`¥ötf
("Out of memory.\n");

28 if(
t›ic_cou¡
 !1 || 
	`°rcmp
(
t›ics
[0], "topic")){

29 
	`¥öt_îr‹
("t›ic", 
t›ics
, 
t›ic_cou¡
);

33 if(
mosqµ
::
	`sub_t›ic_tokíi£
("a/dìp/t›ic/hõørchy", &
t›ics
, &
t›ic_cou¡
)){

34 
	`¥ötf
("Out of memory.\n");

37 if(
t›ic_cou¡
 != 4

38 || 
	`°rcmp
(
t›ics
[0], "a")

39 || 
	`°rcmp
(
t›ics
[1], "deep")

40 || 
	`°rcmp
(
t›ics
[2], "topic")

41 || 
	`°rcmp
(
t›ics
[3], "hierarchy")){

42 
	`¥öt_îr‹
("a/dìp/t›ic/hõørchy", 
t›ics
, 
t›ic_cou¡
);

46 if(
mosqµ
::
	`sub_t›ic_tokíi£
("/a/dìp/t›ic/hõørchy", &
t›ics
, &
t›ic_cou¡
)){

47 
	`¥ötf
("Out of memory.\n");

50 if(
t›ic_cou¡
 != 5

51 || 
t›ics
[0]

52 || 
	`°rcmp
(
t›ics
[1], "a")

53 || 
	`°rcmp
(
t›ics
[2], "deep")

54 || 
	`°rcmp
(
t›ics
[3], "topic")

55 || 
	`°rcmp
(
t›ics
[4], "hierarchy")){

56 
	`¥öt_îr‹
("/a/dìp/t›ic/hõørchy", 
t›ics
, 
t›ic_cou¡
);

60 if(
mosqµ
::
	`sub_t›ic_tokíi£
("a/b/c", &
t›ics
, &
t›ic_cou¡
)){

61 
	`¥ötf
("Out of memory.\n");

64 if(
t›ic_cou¡
 != 3

65 || 
	`°rcmp
(
t›ics
[0], "a")

66 || 
	`°rcmp
(
t›ics
[1], "b")

67 || 
	`°rcmp
(
t›ics
[2], "c")){

68 
	`¥öt_îr‹
("a/b/c", 
t›ics
, 
t›ic_cou¡
);

72 if(
mosqµ
::
	`sub_t›ic_tokíi£
("/a/b/c", &
t›ics
, &
t›ic_cou¡
)){

73 
	`¥ötf
("Out of memory.\n");

76 if(
t›ic_cou¡
 != 4

77 || 
t›ics
[0]

78 || 
	`°rcmp
(
t›ics
[1], "a")

79 || 
	`°rcmp
(
t›ics
[2], "b")

80 || 
	`°rcmp
(
t›ics
[3], "c")){

81 
	`¥öt_îr‹
("/a/b/c", 
t›ics
, 
t›ic_cou¡
);

85 if(
mosqµ
::
	`sub_t›ic_tokíi£
("a///hõørchy", &
t›ics
, &
t›ic_cou¡
)){

86 
	`¥ötf
("Out of memory.\n");

89 if(
t›ic_cou¡
 != 4

90 || 
	`°rcmp
(
t›ics
[0], "a")

91 || 
t›ics
[1]

92 || 
t›ics
[2]

93 || 
	`°rcmp
(
t›ics
[3], "hierarchy")){

94 
	`¥öt_îr‹
("a///hõørchy", 
t›ics
, 
t›ic_cou¡
);

98 if(
mosqµ
::
	`sub_t›ic_tokíi£
("/a///hõørchy", &
t›ics
, &
t›ic_cou¡
)){

99 
	`¥ötf
("Out of memory.\n");

102 if(
t›ic_cou¡
 != 5

103 || 
t›ics
[0]

104 || 
	`°rcmp
(
t›ics
[1], "a")

105 || 
t›ics
[2]

106 || 
t›ics
[3]

107 || 
	`°rcmp
(
t›ics
[4], "hierarchy")){

108 
	`¥öt_îr‹
("/a///hõørchy", 
t›ics
, 
t›ic_cou¡
);

112 if(
mosqµ
::
	`sub_t›ic_tokíi£
("/a///hõørchy/", &
t›ics
, &
t›ic_cou¡
)){

113 
	`¥ötf
("Out of memory.\n");

116 if(
t›ic_cou¡
 != 6

117 || 
t›ics
[0]

118 || 
	`°rcmp
(
t›ics
[1], "a")

119 || 
t›ics
[2]

120 || 
t›ics
[3]

121 || 
	`°rcmp
(
t›ics
[4], "hierarchy")

122 || 
t›ics
[3]){

123 
	`¥öt_îr‹
("/a///hõørchy/", 
t›ics
, 
t›ic_cou¡
);

128 
	}
}

	@test/old/msgsps_common.h

1 
	#HOST
 "127.0.0.1"

	)

2 
	#PORT
 1888

	)

4 
	#PUB_QOS
 1

	)

5 
	#SUB_QOS
 1

	)

7 
	#MESSAGE_COUNT
 100000L

	)

8 
	#MESSAGE_SIZE
 1024L

	)

	@test/old/msgsps_pub.c

3 
	~<°dboﬁ.h
>

4 
	~<°döt.h
>

5 
	~<°dio.h
>

6 
	~<°dlib.h
>

7 
	~<sys/time.h
>

8 
	~<mosquôto.h
>

10 
	~<msg•s_comm⁄.h
>

12 
boﬁ
 
	grun
 = 
åue
;

13 
	gmesßge_cou¡
 = 0;

14 
timevÆ
 
	g°¨t
, 
	g°›
;

16 
	$my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

18 
	`¥ötf
("rc: %d\n", 
rc
);

19 
	`gëtimeofday
(&
°¨t
, 
NULL
);

20 
	}
}

22 
	$my_disc⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
)

24 
run
 = 
Ál£
;

25 
	}
}

27 
	$my_publish_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
mid
)

29 
mesßge_cou¡
++;

30 if(
mesßge_cou¡
 =
MESSAGE_COUNT
){

31 
	`gëtimeofday
(&
°›
, 
NULL
);

32 
	`mosquôto_disc⁄√˘
((
mosquôto
 *)
obj
);

34 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
mosquôto
 *
mosq
;

39 
i
;

40 
d°¨t
, 
d°›
, 
diff
;

41 
uöt8_t
 *
buf
;

43 
buf
 = 
	`mÆloc
(
MESSAGE_SIZE
*
MESSAGE_COUNT
);

44 if(!
buf
){

45 
	`¥ötf
("Error: Out of memory.\n");

49 
°¨t
.
tv_£c
 = 0;

50 
°¨t
.
tv_u£c
 = 0;

51 
°›
.
tv_£c
 = 0;

52 
°›
.
tv_u£c
 = 0;

54 
	`mosquôto_lib_öô
();

56 
mosq
 = 
	`mosquôto_√w
("≥r·e°", 
åue
, 
NULL
);

57 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
my_c⁄√˘_ˇŒback
);

58 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
my_disc⁄√˘_ˇŒback
);

59 
	`mosquôto_publish_ˇŒback_£t
(
mosq
, 
my_publish_ˇŒback
);

61 
	`mosquôto_c⁄√˘
(
mosq
, 
HOST
, 
PORT
, 600);

63 
	`mosquôto_lo›_°¨t
(
mosq
);

65 
i
=0;

66 
i
=0; i<
MESSAGE_COUNT
; i++){

67 
	`mosquôto_publish
(
mosq
, 
NULL
, "≥rf/ã°", 
MESSAGE_SIZE
, &
buf
[
i
*MESSAGE_SIZE], 
PUB_QOS
, 
Ál£
);

69 
	`mosquôto_lo›_°›
(
mosq
, 
Ál£
);

71 
d°¨t
 = ()
°¨t
.
tv_£c
*1.0e6 + ()°¨t.
tv_u£c
;

72 
d°›
 = ()
°›
.
tv_£c
*1.0e6 + ()°›.
tv_u£c
;

73 
diff
 = (
d°›
-
d°¨t
)/1.0e6;

75 
	`¥ötf
("Sèπ: %g\nSt›: %g\nDiff: %g\nMesßges/s: %g\n", 
d°¨t
, 
d°›
, 
diff
, ()
MESSAGE_COUNT
/diff);

77 
	`mosquôto_de°roy
(
mosq
);

78 
	`mosquôto_lib_˛ónup
();

81 
	}
}

	@test/old/msgsps_sub.c

3 
	~<°dboﬁ.h
>

4 
	~<°döt.h
>

5 
	~<°dio.h
>

6 
	~<sys/time.h
>

7 
	~<uni°d.h
>

8 
	~<mosquôto.h
>

10 
	~<msg•s_comm⁄.h
>

12 
boﬁ
 
	grun
 = 
åue
;

13 
	gmesßge_cou¡
 = 0;

14 
timevÆ
 
	g°¨t
, 
	g°›
;

15 
FILE
 *
	gÂå
 = 
NULL
;

18 
	$my_c⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
rc
)

20 
	`¥ötf
("rc: %d\n", 
rc
);

21 
	}
}

23 
	$my_disc⁄√˘_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, 
ªsu…
)

25 
run
 = 
Ál£
;

26 
	}
}

28 
	$my_mesßge_ˇŒback
(
mosquôto
 *
mosq
, *
obj
, c⁄° 
mosquôto_mesßge
 *
msg
)

30 if(
mesßge_cou¡
 == 0){

31 
	`gëtimeofday
(&
°¨t
, 
NULL
);

34 
mesßge_cou¡
++;

35 if(
mesßge_cou¡
 =
MESSAGE_COUNT
){

36 
	`gëtimeofday
(&
°›
, 
NULL
);

37 
	`mosquôto_disc⁄√˘
((
mosquôto
 *)
obj
);

39 
	}
}

41 
	$maö
(
¨gc
, *
¨gv
[])

43 
mosquôto
 *
mosq
;

44 
d°¨t
, 
d°›
, 
diff
;

45 
mid
 = 0;

46 
id
[50];

48 
°¨t
.
tv_£c
 = 0;

49 
°¨t
.
tv_u£c
 = 0;

50 
°›
.
tv_£c
 = 0;

51 
°›
.
tv_u£c
 = 0;

53 
Âå
 = 
	`f›í
("msgsps_sub.dat", "wb");

54 if(!
Âå
){

55 
	`¥ötf
("Error: UnableÅo writeÅo msgsps_sub.dat.\n");

58 
	`mosquôto_lib_öô
();

60 
	`¢¥ötf
(
id
, 50, "msgps_sub_%d", 
	`gëpid
());

61 
mosq
 = 
	`mosquôto_√w
(
id
, 
åue
, 
NULL
);

62 
	`mosquôto_c⁄√˘_ˇŒback_£t
(
mosq
, 
my_c⁄√˘_ˇŒback
);

63 
	`mosquôto_disc⁄√˘_ˇŒback_£t
(
mosq
, 
my_disc⁄√˘_ˇŒback
);

64 
	`mosquôto_mesßge_ˇŒback_£t
(
mosq
, 
my_mesßge_ˇŒback
);

66 
	`mosquôto_c⁄√˘
(
mosq
, 
HOST
, 
PORT
, 600);

67 
	`mosquôto_subs¸ibe
(
mosq
, &
mid
, "≥rf/ã°", 
SUB_QOS
);

69 
	`mosquôto_lo›_f‹evî
(
mosq
, 10, 1);

71 
d°¨t
 = ()
°¨t
.
tv_£c
*1.0e6 + ()°¨t.
tv_u£c
;

72 
d°›
 = ()
°›
.
tv_£c
*1.0e6 + ()°›.
tv_u£c
;

73 
diff
 = (
d°›
-
d°¨t
)/1.0e6;

75 
	`¥ötf
("Sèπ: %g\nSt›: %g\nDiff: %g\nMesßges/s: %g\n", 
d°¨t
, 
d°›
, 
diff
, ()
MESSAGE_COUNT
/diff);

77 
	`mosquôto_de°roy
(
mosq
);

78 
	`mosquôto_lib_˛ónup
();

79 
	`f˛o£
(
Âå
);

82 
	}
}

	@test/random/auth_plugin.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<time.h
>

4 
	~<mosquôto.h
>

5 
	~<mosquôto_brokî.h
>

6 
	~<mosquôto_∂ugö.h
>

8 
	$mosquôto_auth_∂ugö_vîsi⁄
()

10  
MOSQ_AUTH_PLUGIN_VERSION
;

11 
	}
}

13 
	$mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

15 
	`§™dom
(
	`time
(
NULL
));

16  
MOSQ_ERR_SUCCESS
;

17 
	}
}

19 
	$mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
)

21  
MOSQ_ERR_SUCCESS
;

22 
	}
}

24 
	$mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

26  
MOSQ_ERR_SUCCESS
;

27 
	}
}

29 
	$mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
)

31  
MOSQ_ERR_SUCCESS
;

32 
	}
}

34 
	$mosquôto_auth_a˛_check
(*
u£r_d©a
, 
ac˚ss
, 
mosquôto
 *
˛õ¡
, c⁄° 
mosquôto_a˛_msg
 *
msg
)

36 if(
	`øndom
() % 2 == 0){

37  
MOSQ_ERR_SUCCESS
;

39  
MOSQ_ERR_ACL_DENIED
;

41 
	}
}

43 
	$mosquôto_auth_u≈wd_check
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

45 if(
	`øndom
() % 2 == 0){

46  
MOSQ_ERR_SUCCESS
;

48  
MOSQ_ERR_AUTH
;

50 
	}
}

52 
	$mosquôto_auth_psk_key_gë
(*
u£r_d©a
, 
mosquôto
 *
˛õ¡
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

54  
MOSQ_ERR_AUTH
;

55 
	}
}

	@test/unit/datatype_read.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"∑ckë_mosq.h
"

6 
	$byã_ªad_hñ≥r
(

7 
uöt8_t
 *
∑ylﬂd
,

8 
ªmaöög_Àngth
,

9 
rc_ex≥˘ed
,

10 
uöt8_t
 
vÆue_ex≥˘ed
)

12 
mosquôto__∑ckë
 
∑ckë
;

13 
uöt8_t
 
vÆue
 = 0;

14 
rc
;

16 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

17 
∑ckë
.
∑ylﬂd
 =Öayload;

18 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

19 
rc
 = 
	`∑ckë__ªad_byã
(&
∑ckë
, &
vÆue
);

20 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

21 
	`CU_ASSERT_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
);

22 
	}
}

25 
	$uöt16_ªad_hñ≥r
(

26 
uöt8_t
 *
∑ylﬂd
,

27 
ªmaöög_Àngth
,

28 
rc_ex≥˘ed
,

29 
uöt16_t
 
vÆue_ex≥˘ed
)

31 
mosquôto__∑ckë
 
∑ckë
;

32 
uöt16_t
 
vÆue
 = 0;

33 
rc
;

35 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

36 
∑ckë
.
∑ylﬂd
 =Öayload;

37 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

38 
rc
 = 
	`∑ckë__ªad_uöt16
(&
∑ckë
, &
vÆue
);

39 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

40 
	`CU_ASSERT_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
);

41 
	}
}

44 
	$uöt32_ªad_hñ≥r
(

45 
uöt8_t
 *
∑ylﬂd
,

46 
ªmaöög_Àngth
,

47 
rc_ex≥˘ed
,

48 
uöt32_t
 
vÆue_ex≥˘ed
)

50 
mosquôto__∑ckë
 
∑ckë
;

51 
uöt32_t
 
vÆue
 = 0;

52 
rc
;

54 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

55 
∑ckë
.
∑ylﬂd
 =Öayload;

56 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

57 
rc
 = 
	`∑ckë__ªad_uöt32
(&
∑ckë
, &
vÆue
);

58 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

59 
	`CU_ASSERT_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
);

60 
	}
}

63 
	$v¨öt_ªad_hñ≥r
(

64 
uöt8_t
 *
∑ylﬂd
,

65 
ªmaöög_Àngth
,

66 
rc_ex≥˘ed
,

67 
öt32_t
 
vÆue_ex≥˘ed
,

68 
öt8_t
 
byãs_ex≥˘ed
)

70 
mosquôto__∑ckë
 
∑ckë
;

71 
öt32_t
 
vÆue
 = -1;

72 
öt8_t
 
byãs
 = -1;

73 
rc
;

75 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

76 
∑ckë
.
∑ylﬂd
 =Öayload;

77 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

78 
rc
 = 
	`∑ckë__ªad_v¨öt
(&
∑ckë
, &
vÆue
, &
byãs
);

79 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

80 
	`CU_ASSERT_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
);

81 
	`CU_ASSERT_EQUAL
(
byãs
, 
byãs_ex≥˘ed
);

82 
	}
}

85 
	$bö¨y_ªad_hñ≥r
(

86 
uöt8_t
 *
∑ylﬂd
,

87 
ªmaöög_Àngth
,

88 
rc_ex≥˘ed
,

89 c⁄° 
uöt8_t
 *
vÆue_ex≥˘ed
,

90 
Àngth_ex≥˘ed
)

92 
mosquôto__∑ckë
 
∑ckë
;

93 
uöt8_t
 *
vÆue
 = 
NULL
;

94 
Àngth
 = -1;

95 
rc
;

97 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

98 
∑ckë
.
∑ylﬂd
 =Öayload;

99 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

100 
rc
 = 
	`∑ckë__ªad_bö¨y
(&
∑ckë
, (
uöt8_t
 **)&
vÆue
, &
Àngth
);

101 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

102 if(
vÆue_ex≥˘ed
){

104 
	`CU_ASSERT_NSTRING_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
, 
Àngth_ex≥˘ed
);

106 
	`CU_ASSERT_EQUAL
(
vÆue
, 
NULL
);

108 
	`CU_ASSERT_EQUAL
(
Àngth
, 
Àngth_ex≥˘ed
);

109 
	`‰ì
(
vÆue
);

110 
	}
}

113 
	$°rög_ªad_hñ≥r
(

114 
uöt8_t
 *
∑ylﬂd
,

115 
ªmaöög_Àngth
,

116 
rc_ex≥˘ed
,

117 c⁄° 
uöt8_t
 *
vÆue_ex≥˘ed
,

118 
Àngth_ex≥˘ed
)

120 
mosquôto__∑ckë
 
∑ckë
;

121 
uöt8_t
 *
vÆue
 = 
NULL
;

122 
Àngth
 = -1;

123 
rc
;

125 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

126 
∑ckë
.
∑ylﬂd
 =Öayload;

127 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

128 
rc
 = 
	`∑ckë__ªad_°rög
(&
∑ckë
, (**)&
vÆue
, &
Àngth
);

129 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

130 if(
vÆue_ex≥˘ed
){

131 if(
vÆue
){

132 
	`CU_ASSERT_NSTRING_EQUAL
(
vÆue
, 
vÆue_ex≥˘ed
, 
Àngth_ex≥˘ed
);

135 
	`CU_ASSERT_PTR_NULL
(
vÆue
);

137 
	`CU_ASSERT_EQUAL
(
Àngth
, 
Àngth_ex≥˘ed
);

138 
	`‰ì
(
vÆue
);

139 
	}
}

142 
	$byãs_ªad_hñ≥r
(

143 
uöt8_t
 *
∑ylﬂd
,

144 
ªmaöög_Àngth
,

145 
rc_ex≥˘ed
,

146 c⁄° 
uöt8_t
 *
vÆue_ex≥˘ed
,

147 
cou¡
)

149 
mosquôto__∑ckë
 
∑ckë
;

150 
uöt8_t
 
vÆue
[
cou¡
];

151 
rc
;

152 
i
;

154 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

155 
∑ckë
.
∑ylﬂd
 =Öayload;

156 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

157 
rc
 = 
	`∑ckë__ªad_byãs
(&
∑ckë
, 
vÆue
, 
cou¡
);

158 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

159 if(
rc
 =
MOSQ_ERR_SUCCESS
){

160 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
cou¡
);

162 if(
vÆue_ex≥˘ed
){

163 
i
=0; i<
cou¡
; i++){

164 
	`CU_ASSERT_EQUAL
(
vÆue
[
i
], 
vÆue_ex≥˘ed
[i]);

167 
	}
}

179 
	$TEST_byã_ªad_em±y
()

182 
	`byã_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, 0);

183 
	}
}

191 
	$TEST_byã_ªad_suc˚ss
()

193 
uöt8_t
 
∑ylﬂd
[20];

196 
	`mem£t
(
∑ylﬂd
, 0, (payload));

197 
∑ylﬂd
[0] = 0x00;

198 
	`byã_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_SUCCESS
, 0x00);

201 
	`mem£t
(
∑ylﬂd
, 0, (payload));

202 
∑ylﬂd
[0] = 0x1F;

203 
	`byã_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_SUCCESS
, 0x1F);

206 
	`mem£t
(
∑ylﬂd
, 0, (payload));

207 
∑ylﬂd
[0] = 0xFF;

208 
	`byã_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_SUCCESS
, 0xFF);

210 
	}
}

222 
	$TEST_uöt16_ªad_em±y
()

225 
	`uöt16_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, 0);

226 
	}
}

234 
	$TEST_uöt16_ªad_åunˇãd
()

236 
uöt8_t
 
∑ylﬂd
[20];

239 
	`mem£t
(
∑ylﬂd
, 0, (payload));

240 
∑ylﬂd
[0] = 0x38;

241 
	`uöt16_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_PROTOCOL
, 0);

242 
	}
}

251 
	$TEST_uöt16_ªad_suc˚ss
()

253 
uöt8_t
 
∑ylﬂd
[20];

256 
	`mem£t
(
∑ylﬂd
, 0, (payload));

257 
∑ylﬂd
[0] = 0x00;

258 
∑ylﬂd
[1] = 0x00;

259 
	`uöt16_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, 0x0000);

262 
	`mem£t
(
∑ylﬂd
, 0, (payload));

263 
∑ylﬂd
[0] = 0x38;

264 
∑ylﬂd
[1] = 0xF3;

265 
	`uöt16_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, 0x38F3);

268 
	`mem£t
(
∑ylﬂd
, 0, (payload));

269 
∑ylﬂd
[0] = 0xFF;

270 
∑ylﬂd
[1] = 0xFF;

271 
	`uöt16_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, 0xFFFF);

273 
	}
}

285 
	$TEST_uöt32_ªad_em±y
()

288 
	`uöt32_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, 0);

289 
	}
}

297 
	$TEST_uöt32_ªad_åunˇãd
()

299 
uöt8_t
 
∑ylﬂd
[20];

302 
	`mem£t
(
∑ylﬂd
, 0, (payload));

303 
∑ylﬂd
[0] = 0x38;

304 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_PROTOCOL
, 0);

307 
	`mem£t
(
∑ylﬂd
, 0, (payload));

308 
∑ylﬂd
[0] = 0x38;

309 
∑ylﬂd
[1] = 0x38;

310 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, 0);

313 
	`mem£t
(
∑ylﬂd
, 0, (payload));

314 
∑ylﬂd
[0] = 0x38;

315 
∑ylﬂd
[1] = 0x38;

316 
∑ylﬂd
[2] = 0x38;

317 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, 0);

318 
	}
}

327 
	$TEST_uöt32_ªad_suc˚ss
()

329 
uöt8_t
 
∑ylﬂd
[20];

332 
	`mem£t
(
∑ylﬂd
, 0, (payload));

333 
∑ylﬂd
[0] = 0x00;

334 
∑ylﬂd
[1] = 0x00;

335 
∑ylﬂd
[2] = 0x00;

336 
∑ylﬂd
[3] = 0x00;

337 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 0x00000000);

340 
	`mem£t
(
∑ylﬂd
, 0, (payload));

341 
∑ylﬂd
[0] = 0x12;

342 
∑ylﬂd
[1] = 0x34;

343 
∑ylﬂd
[2] = 0x56;

344 
∑ylﬂd
[3] = 0x78;

345 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 0x12345678);

348 
	`mem£t
(
∑ylﬂd
, 0, (payload));

349 
∑ylﬂd
[0] = 0xFF;

350 
∑ylﬂd
[1] = 0xFF;

351 
∑ylﬂd
[2] = 0xFF;

352 
∑ylﬂd
[3] = 0xFF;

353 
	`uöt32_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 0xFFFFFFFF);

355 
	}
}

367 
	$TEST_v¨öt_ªad_em±y
()

370 
	`v¨öt_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, -1, -1);

371 
	}
}

379 
	$TEST_v¨öt_ªad_åunˇãd
()

381 
uöt8_t
 
∑ylﬂd
[20];

384 
	`mem£t
(
∑ylﬂd
, 0, (payload));

385 
∑ylﬂd
[0] = 0x80;

386 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_PROTOCOL
, -1, -1);

389 
	`mem£t
(
∑ylﬂd
, 1, (payload));

390 
∑ylﬂd
[0] = 0x80;

391 
∑ylﬂd
[1] = 0x80;

392 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, -1, -1);

395 
	`mem£t
(
∑ylﬂd
, 0, (payload));

396 
∑ylﬂd
[0] = 0x80;

397 
∑ylﬂd
[1] = 0x80;

398 
∑ylﬂd
[2] = 0x80;

399 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, -1, -1);

402 
	`mem£t
(
∑ylﬂd
, 0, (payload));

403 
∑ylﬂd
[0] = 0x80;

404 
∑ylﬂd
[1] = 0x80;

405 
∑ylﬂd
[2] = 0x80;

406 
∑ylﬂd
[3] = 0x80;

407 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, -1, -1);

408 
	}
}

416 
	$TEST_v¨öt_ªad_bound¨õs
()

418 
uöt8_t
 
∑ylﬂd
[20];

421 
	`mem£t
(
∑ylﬂd
, 0, (payload));

422 
∑ylﬂd
[0] = 0x00;

423 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_SUCCESS
, 0, 1);

426 
	`mem£t
(
∑ylﬂd
, 0, (payload));

427 
∑ylﬂd
[0] = 0x7F;

428 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_SUCCESS
, 127, 1);

431 
	`mem£t
(
∑ylﬂd
, 0, (payload));

432 
∑ylﬂd
[0] = 0x80;

433 
∑ylﬂd
[1] = 0x01;

434 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, 128, 2);

437 
	`mem£t
(
∑ylﬂd
, 0, (payload));

438 
∑ylﬂd
[0] = 0xFF;

439 
∑ylﬂd
[1] = 0x7F;

440 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, 16383, 2);

443 
	`mem£t
(
∑ylﬂd
, 0, (payload));

444 
∑ylﬂd
[0] = 0x80;

445 
∑ylﬂd
[1] = 0x80;

446 
∑ylﬂd
[2] = 0x01;

447 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 16384, 3);

450 
	`mem£t
(
∑ylﬂd
, 0, (payload));

451 
∑ylﬂd
[0] = 0xFF;

452 
∑ylﬂd
[1] = 0xFF;

453 
∑ylﬂd
[2] = 0x7F;

454 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 2097151, 3);

457 
	`mem£t
(
∑ylﬂd
, 0, (payload));

458 
∑ylﬂd
[0] = 0x80;

459 
∑ylﬂd
[1] = 0x80;

460 
∑ylﬂd
[2] = 0x80;

461 
∑ylﬂd
[3] = 0x01;

462 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 2097152, 4);

465 
	`mem£t
(
∑ylﬂd
, 0, (payload));

466 
∑ylﬂd
[0] = 0xFF;

467 
∑ylﬂd
[1] = 0xFF;

468 
∑ylﬂd
[2] = 0xFF;

469 
∑ylﬂd
[3] = 0x7F;

470 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 268435455, 4);

471 
	}
}

478 
	$TEST_v¨öt_ªad_5_byãs
()

480 
uöt8_t
 
∑ylﬂd
[20];

483 
	`mem£t
(
∑ylﬂd
, 0, (payload));

484 
∑ylﬂd
[0] = 0x80;

485 
∑ylﬂd
[1] = 0x80;

486 
∑ylﬂd
[2] = 0x80;

487 
∑ylﬂd
[3] = 0x80;

488 
∑ylﬂd
[4] = 0x01;

489 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 5, 
MOSQ_ERR_PROTOCOL
, -1, -1);

490 
	}
}

498 
	$TEST_v¨öt_ªad_ovîl⁄g_ícodög
()

500 
uöt8_t
 
∑ylﬂd
[20];

503 
	`mem£t
(
∑ylﬂd
, 0, (payload));

504 
∑ylﬂd
[0] = 0x80;

505 
∑ylﬂd
[1] = 0x00;

506 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, -1, -1);

509 
	`mem£t
(
∑ylﬂd
, 0, (payload));

510 
∑ylﬂd
[0] = 0xFF;

511 
∑ylﬂd
[1] = 0x00;

512 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, -1, -1);

515 
	`mem£t
(
∑ylﬂd
, 0, (payload));

516 
∑ylﬂd
[0] = 0x80;

517 
∑ylﬂd
[1] = 0x81;

518 
∑ylﬂd
[2] = 0x00;

519 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, -1, -1);

522 
	`mem£t
(
∑ylﬂd
, 0, (payload));

523 
∑ylﬂd
[0] = 0xFF;

524 
∑ylﬂd
[1] = 0xFF;

525 
∑ylﬂd
[2] = 0x00;

526 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, -1, -1);

529 
	`mem£t
(
∑ylﬂd
, 0, (payload));

530 
∑ylﬂd
[0] = 0x80;

531 
∑ylﬂd
[1] = 0x80;

532 
∑ylﬂd
[2] = 0x81;

533 
∑ylﬂd
[3] = 0x00;

534 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, -1, -1);

537 
	`mem£t
(
∑ylﬂd
, 0, (payload));

538 
∑ylﬂd
[0] = 0xFF;

539 
∑ylﬂd
[1] = 0xFF;

540 
∑ylﬂd
[2] = 0xFF;

541 
∑ylﬂd
[3] = 0x00;

542 
	`v¨öt_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, -1, -1);

543 
	}
}

555 
	$TEST_°rög_ªad_em±y
()

557 
	`°rög_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, NULL, -1);

558 
	}
}

565 
	$TEST_°rög_ªad_åunˇãd
()

567 
uöt8_t
 
∑ylﬂd
[20];

570 
	`mem£t
(
∑ylﬂd
, 0, (payload));

571 
∑ylﬂd
[0] = 0x02;

572 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

575 
	`mem£t
(
∑ylﬂd
, 0, (payload));

576 
∑ylﬂd
[0] = 0x02;

577 
∑ylﬂd
[1] = 0x02;

578 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

581 
	`mem£t
(
∑ylﬂd
, 0, (payload));

582 
∑ylﬂd
[0] = 0x00;

583 
∑ylﬂd
[1] = 0x02;

584 
∑ylﬂd
[2] = 'a';

585 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

588 
	`mem£t
(
∑ylﬂd
, 0, (payload));

589 
∑ylﬂd
[0] = 0x00;

590 
∑ylﬂd
[1] = 0x03;

591 
∑ylﬂd
[2] = 'a';

592 
∑ylﬂd
[3] = 'b';

593 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

594 
	}
}

602 
	$TEST_°rög_ªad_em±y_°rög
()

604 
uöt8_t
 
∑ylﬂd
[20];

606 
	`mem£t
(
∑ylﬂd
, 0, (payload));

607 
∑ylﬂd
[0] = 0x00;

608 
∑ylﬂd
[1] = 0x00;

609 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_SUCCESS
, (c⁄° 
uöt8_t
 *)"", 0);

610 
	}
}

617 
	$TEST_°rög_ªad_vÆid_°rög
()

619 
uöt8_t
 
∑ylﬂd
[20];

621 
	`mem£t
(
∑ylﬂd
, 0, (payload));

622 
∑ylﬂd
[0] = 0x00;

623 
∑ylﬂd
[1] = 0x0b;

624 
∑ylﬂd
[2] = 't';

625 
∑ylﬂd
[3] = 'e';

626 
∑ylﬂd
[4] = 's';

627 
∑ylﬂd
[5] = 't';

628 
∑ylﬂd
[6] = ' ';

629 
∑ylﬂd
[7] = 's';

630 
∑ylﬂd
[8] = 't';

631 
∑ylﬂd
[9] = 'r';

632 
∑ylﬂd
[10] = 'i';

633 
∑ylﬂd
[11] = 'n';

634 
∑ylﬂd
[12] = 'g';

635 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 13, 
MOSQ_ERR_SUCCESS
, (c⁄° 
uöt8_t
 *)"test string", 11);

636 
	}
}

644 
	$TEST_°rög_ªad_mÆf‹med_°rög
()

646 
uöt8_t
 
∑ylﬂd
[20];

648 
	`mem£t
(
∑ylﬂd
, 0, (payload));

649 
∑ylﬂd
[0] = 0x00;

650 
∑ylﬂd
[1] = 0x07;

651 
∑ylﬂd
[2] = 't';

652 
∑ylﬂd
[3] = 'e';

653 
∑ylﬂd
[4] = 's';

654 
∑ylﬂd
[5] = 't';

655 
∑ylﬂd
[6] = 0xED;

656 
∑ylﬂd
[7] = 0xA0;

657 
∑ylﬂd
[8] = 0x80;

658 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 9, 
MOSQ_ERR_MALFORMED_UTF8
, 
NULL
, -1);

659 
	}
}

667 
	$TEST_°rög_ªad_mqâ_1_5_4_3
()

669 
uöt8_t
 
∑ylﬂd
[20];

671 
	`mem£t
(
∑ylﬂd
, 0, (payload));

672 
∑ylﬂd
[0] = 0x00;

673 
∑ylﬂd
[1] = 0x0b;

674 
∑ylﬂd
[2] = 't';

675 
∑ylﬂd
[3] = 'e';

676 
∑ylﬂd
[4] = 's';

677 
∑ylﬂd
[5] = 't';

678 
∑ylﬂd
[6] = 0xEF;

679 
∑ylﬂd
[7] = 0xBB;

680 
∑ylﬂd
[8] = 0xBF;

681 
∑ylﬂd
[9] = 't';

682 
∑ylﬂd
[10] = 'e';

683 
∑ylﬂd
[11] = 's';

684 
∑ylﬂd
[12] = 't';

685 
	`°rög_ªad_hñ≥r
(
∑ylﬂd
, 13, 
MOSQ_ERR_SUCCESS
, &payload[2], 11);

686 
	}
}

698 
	$TEST_bö¨y_d©a_ªad_em±y
()

700 
	`bö¨y_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, NULL, -1);

701 
	}
}

709 
	$TEST_bö¨y_d©a_ªad_åunˇãd
()

711 
uöt8_t
 
∑ylﬂd
[20];

714 
	`mem£t
(
∑ylﬂd
, 0, (payload));

715 
∑ylﬂd
[0] = 0x02;

716 
	`bö¨y_ªad_hñ≥r
(
∑ylﬂd
, 1, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

719 
	`mem£t
(
∑ylﬂd
, 0, (payload));

720 
∑ylﬂd
[0] = 0x02;

721 
∑ylﬂd
[1] = 0x02;

722 
	`bö¨y_ªad_hñ≥r
(
∑ylﬂd
, 2, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

725 
	`mem£t
(
∑ylﬂd
, 0, (payload));

726 
∑ylﬂd
[0] = 0x00;

727 
∑ylﬂd
[1] = 0x02;

728 
∑ylﬂd
[2] = 'a';

729 
	`bö¨y_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

732 
	`mem£t
(
∑ylﬂd
, 0, (payload));

733 
∑ylﬂd
[0] = 0x00;

734 
∑ylﬂd
[1] = 0x03;

735 
∑ylﬂd
[2] = 'a';

736 
∑ylﬂd
[3] = 'b';

737 
	`bö¨y_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, 
NULL
, -1);

738 
	}
}

750 
	$TEST_byãs_ªad_em±y
()

753 
	`byãs_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_SUCCESS
, NULL, 0);

754 
	}
}

761 
	$TEST_byãs_ªad_åunˇãd
()

763 
	`byãs_ªad_hñ≥r
(
NULL
, 0, 
MOSQ_ERR_PROTOCOL
, NULL, 1);

764 
	}
}

771 
	$TEST_byãs_ªad_suc˚ss
()

773 
uöt8_t
 
∑ylﬂd
[20];

774 
i
;

776 
i
=0; i<20; i++){

777 
∑ylﬂd
[
i
] = i*2;

779 
	`byãs_ªad_hñ≥r
(
∑ylﬂd
, 20, 
MOSQ_ERR_SUCCESS
,Öayload, 20);

780 
	}
}

787 
	$öô_d©©y≥_ªad_ã°s
()

789 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

791 
ã°_suôe
 = 
	`CU_add_suôe
("D©©y≥Ñód", 
NULL
, NULL);

792 if(!
ã°_suôe
){

793 
	`¥ötf
("Errorádding CUnitÅest suite.\n");

798 || !
	`CU_add_ã°
(
ã°_suôe
, "ByãÑód (em±yÖackë)", 
TEST_byã_ªad_em±y
)

799 || !
	`CU_add_ã°
(
ã°_suôe
, "ByãÑód (suc˚s†vÆues)", 
TEST_byã_ªad_suc˚ss
)

800 || !
	`CU_add_ã°
(
ã°_suôe
, "TwÿByã I¡egîÑód (em±yÖackë)", 
TEST_uöt16_ªad_em±y
)

801 || !
	`CU_add_ã°
(
ã°_suôe
, "TwÿByã I¡egîÑód (åunˇãdÖackë)", 
TEST_uöt16_ªad_åunˇãd
)

802 || !
	`CU_add_ã°
(
ã°_suôe
, "TwÿByã I¡egîÑód (suc˚s†vÆues)", 
TEST_uöt16_ªad_suc˚ss
)

803 || !
	`CU_add_ã°
(
ã°_suôe
, "Fou∏Byã I¡egîÑód (em±yÖackë)", 
TEST_uöt32_ªad_em±y
)

804 || !
	`CU_add_ã°
(
ã°_suôe
, "Fou∏Byã I¡egîÑód (åunˇãdÖackë)", 
TEST_uöt32_ªad_åunˇãd
)

805 || !
	`CU_add_ã°
(
ã°_suôe
, "Fou∏Byã I¡egîÑód (suc˚s†vÆues)", 
TEST_uöt32_ªad_suc˚ss
)

806 || !
	`CU_add_ã°
(
ã°_suôe
, "V¨übÀ Byã I¡egîÑód (em±yÖackë)", 
TEST_v¨öt_ªad_em±y
)

807 || !
	`CU_add_ã°
(
ã°_suôe
, "V¨übÀ Byã I¡egîÑód (åunˇãdÖackës)", 
TEST_v¨öt_ªad_åunˇãd
)

808 || !
	`CU_add_ã°
(
ã°_suôe
, "V¨übÀ Byã I¡egîÑód (ícodög bound¨õs)", 
TEST_v¨öt_ªad_bound¨õs
)

809 || !
	`CU_add_ã°
(
ã°_suôe
, "V¨übÀ Byã I¡egîÑód (fivêbyãÉncodög)", 
TEST_v¨öt_ªad_5_byãs
)

810 || !
	`CU_add_ã°
(
ã°_suôe
, "V¨übÀ Byã I¡egîÑód (ovîl⁄gÉncodögs)", 
TEST_v¨öt_ªad_ovîl⁄g_ícodög
)

811 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (em±yÖackë)", 
TEST_°rög_ªad_em±y
)

812 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (åunˇãdÖackë)", 
TEST_°rög_ªad_åunˇãd
)

813 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (em±y såög)", 
TEST_°rög_ªad_em±y_°rög
)

814 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (vÆid såög)", 
TEST_°rög_ªad_vÆid_°rög
)

815 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (mÆf‹med såög)", 
TEST_°rög_ªad_mÆf‹med_°rög
)

816 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 såögÑód (MQTT-1.5.4-3)", 
TEST_°rög_ªad_mqâ_1_5_4_3
)

817 || !
	`CU_add_ã°
(
ã°_suôe
, "Bö¨y D©®ªad (em±yÖackë)", 
TEST_bö¨y_d©a_ªad_em±y
)

818 || !
	`CU_add_ã°
(
ã°_suôe
, "Bö¨y D©®ªad (åunˇãdÖackë)", 
TEST_bö¨y_d©a_ªad_åunˇãd
)

819 || !
	`CU_add_ã°
(
ã°_suôe
, "Byã†ªad (em±yÖackë)", 
TEST_byãs_ªad_em±y
)

820 || !
	`CU_add_ã°
(
ã°_suôe
, "Byã†ªad (åunˇãdÖackë)", 
TEST_byãs_ªad_åunˇãd
)

821 || !
	`CU_add_ã°
(
ã°_suôe
, "Byã†ªad (suc˚ss)", 
TEST_byãs_ªad_suc˚ss
)

824 
	`¥ötf
("Errorádding DatatypeÑead CUnitÅests.\n");

829 
	}
}

	@test/unit/datatype_write.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~<¨∑/öë.h
>

6 
	~"∑ckë_mosq.h
"

13 
	$TEST_byã_wrôe
()

15 
uöt8_t
 
∑ylﬂd
[260];

16 
mosquôto__∑ckë
 
∑ckë
;

17 
i
;

19 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

20 
	`mem£t
(
∑ylﬂd
, 0, (payload));

21 
∑ckë
.
∑ylﬂd
 =Öayload;

22 
∑ckë
.
∑ckë_Àngth
 = 256;

24 
i
=0; i<256; i++){

25 
	`∑ckë__wrôe_byã
(&
∑ckë
, 255-
i
);

28 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 256);

29 
i
=0; i<256; i++){

30 
	`CU_ASSERT_EQUAL
(
∑ylﬂd
[
i
], 255-i);

32 
	}
}

40 
	$TEST_uöt16_wrôe
()

42 
uöt8_t
 
∑ylﬂd
[650];

43 
uöt16_t
 *
∑ylﬂd16
;

44 
mosquôto__∑ckë
 
∑ckë
;

45 
i
;

47 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

48 
	`mem£t
(
∑ylﬂd
, 0, (payload));

49 
∑ckë
.
∑ylﬂd
 =Öayload;

50 
∑ckë
.
∑ckë_Àngth
 = 650;

52 
i
=0; i<325; i++){

53 
	`∑ckë__wrôe_uöt16
(&
∑ckë
, 100*
i
);

56 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 650);

57 
∑ylﬂd16
 = (
uöt16_t
 *)
∑ylﬂd
;

58 
i
=0; i<325; i++){

59 
	`CU_ASSERT_EQUAL
(
∑ylﬂd16
[
i
], 
	`ht⁄s
(100*i));

61 
	}
}

69 
	$TEST_uöt32_wrôe
()

71 
uöt8_t
 *
∑ylﬂd
;

72 
uöt32_t
 *
∑ylﬂd32
;

73 
mosquôto__∑ckë
 
∑ckë
;

74 
i
;

76 
∑ylﬂd
 = 
	`ˇŒoc
(42000, (
uöt32_t
));

77 if(!
∑ylﬂd
){

78 
	`CU_FAIL_FATAL
("Out of memory");

81 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

82 
∑ckë
.
∑ylﬂd
 =Öayload;

83 
∑ckë
.
∑ckë_Àngth
 = 42000;

85 
i
=0; i<10500; i++){

86 
	`∑ckë__wrôe_uöt32
(&
∑ckë
, 1000*
i
);

89 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 42000);

90 
∑ylﬂd32
 = (
uöt32_t
 *)
∑ylﬂd
;

91 
i
=0; i<10500; i++){

92 
	`CU_ASSERT_EQUAL
(
∑ylﬂd32
[
i
], 
	`ht⁄l
(1000*i));

94 
	`‰ì
(
∑ylﬂd
);

95 
	}
}

103 
	$TEST_°rög_wrôe
()

105 
uöt8_t
 
∑ylﬂd
[100];

106 
mosquôto__∑ckë
 
∑ckë
;

108 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

109 
	`mem£t
(
∑ylﬂd
, 0, 100);

111 
∑ckë
.
∑ylﬂd
 =Öayload;

112 
∑ckë
.
∑ckë_Àngth
 = 100;

114 
	`∑ckë__wrôe_°rög
(&
∑ckë
, "fú°Åe°", 
	`°æí
("firstÅest"));

115 
	`∑ckë__wrôe_°rög
(&
∑ckë
, "£c⁄dÅe°", 
	`°æí
("secondÅest"));

117 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 2+10+2+11);

118 
	`CU_ASSERT_EQUAL
(
∑ylﬂd
[0], 0);

119 
	`CU_ASSERT_EQUAL
(
∑ylﬂd
[1], 10);

120 
	`CU_ASSERT_NSTRING_EQUAL
(
∑ylﬂd
+2, "firstÅest", 10);

121 
	`CU_ASSERT_EQUAL
(
∑ylﬂd
[2+10+0], 0);

122 
	`CU_ASSERT_EQUAL
(
∑ylﬂd
[2+10+1], 11);

123 
	`CU_ASSERT_NSTRING_EQUAL
(
∑ylﬂd
+2+10+2, "secondÅest", 11);

124 
	}
}

131 
	$öô_d©©y≥_wrôe_ã°s
()

133 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

135 
ã°_suôe
 = 
	`CU_add_suôe
("D©©y≥ wrôe", 
NULL
, NULL);

136 if(!
ã°_suôe
){

137 
	`¥ötf
("Errorádding CUnitÅest suite.\n");

142 || !
	`CU_add_ã°
(
ã°_suôe
, "Byã wrôe", 
TEST_byã_wrôe
)

143 || !
	`CU_add_ã°
(
ã°_suôe
, "TwÿByã I¡egî wrôe", 
TEST_uöt16_wrôe
)

144 || !
	`CU_add_ã°
(
ã°_suôe
, "Fou∏Byã I¡egî wrôe", 
TEST_uöt32_wrôe
)

145 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 Såög wrôe", 
TEST_°rög_wrôe
)

148 
	`¥ötf
("Errorádding Datatype write CUnitÅests.\n");

153 
	}
}

	@test/unit/persist_read_stubs.c

1 
	~<time.h
>

3 
	#WITH_BROKER


	)

5 
	~<loggög_mosq.h
>

6 
	~<mem‹y_mosq.h
>

7 
	~<mosquôto_brokî_öã∫Æ.h
>

8 
	~<√t_mosq.h
>

9 
	~<£nd_mosq.h
>

10 
	~<time_mosq.h
>

12 
uöt64_t
 
œ°_ªèöed
;

13 *
œ°_sub
;

14 
œ°_qos
;

15 
uöt32_t
 
œ°_idítifõr
;

17 
mosquôto
 *
	$c⁄ãxt__öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
)

19 
mosquôto
 *
m
;

21 
m
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto
));

22 if(
m
){

23 
m
->
msgs_ö
.
öÊight_maximum
 = 20;

24 
m
->
msgs_out
.
öÊight_maximum
 = 20;

25 
m
->
msgs_ö
.
öÊight_quŸa
 = 20;

26 
m
->
msgs_out
.
öÊight_quŸa
 = 20;

28  
m
;

29 
	}
}

31 
	$db__mesßge_°‹e
(
mosquôto_db
 *
db
, c⁄° 
mosquôto
 *
sour˚
, 
uöt16_t
 
sour˚_mid
, *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, 
mosquôto__∑ylﬂd_uh∑
 *
∑ylﬂd
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
, uöt32_à
mesßge_expúy_öãrvÆ
, 
mosquôto_¥›îty
 *
¥›îtõs
, 
dbid_t
 
°‹e_id
, 
mosquôto_msg_‹igö
 
‹igö
)

33 
mosquôto_msg_°‹e
 *
ãmp
 = 
NULL
;

34 
rc
 = 
MOSQ_ERR_SUCCESS
;

36 
ãmp
 = 
	`mosquôto__ˇŒoc
(1, (
mosquôto_msg_°‹e
));

37 if(!
ãmp
){

38 
rc
 = 
MOSQ_ERR_NOMEM
;

39 
îr‹
;

42 if(
sour˚
 && sour˚->
id
){

43 
ãmp
->
sour˚_id
 = 
	`mosquôto__°rdup
(
sour˚
->
id
);

45 
ãmp
->
sour˚_id
 = 
	`mosquôto__°rdup
("");

47 if(!
ãmp
->
sour˚_id
){

48 
rc
 = 
MOSQ_ERR_NOMEM
;

49 
îr‹
;

52 if(
sour˚
 && sour˚->
u£∫ame
){

53 
ãmp
->
sour˚_u£∫ame
 = 
	`mosquôto__°rdup
(
sour˚
->
u£∫ame
);

54 if(!
ãmp
->
sour˚_u£∫ame
){

55 
rc
 = 
MOSQ_ERR_NOMEM
;

56 
îr‹
;

59 if(
sour˚
){

60 
ãmp
->
sour˚_li°íî
 = 
sour˚
->
li°íî
;

62 
ãmp
->
sour˚_mid
 = source_mid;

63 
ãmp
->
mid
 = 0;

64 
ãmp
->
qos
 = qos;

65 
ãmp
->
ªèö
 =Ñetain;

66 
ãmp
->
t›ic
 =Åopic;

67 
t›ic
 = 
NULL
;

68 
ãmp
->
∑ylﬂdÀn
 =Öayloadlen;

69 
ãmp
->
¥›îtõs
 =Öroperties;

70 if(
∑ylﬂdÀn
){

71 
	`UHPA_MOVE
(
ãmp
->
∑ylﬂd
, *∑ylﬂd, 
∑ylﬂdÀn
);

73 
ãmp
->
∑ylﬂd
.
±r
 = 
NULL
;

75 if(
mesßge_expúy_öãrvÆ
 > 0){

76 
ãmp
->
mesßge_expúy_time
 = 
	`time
(
NULL
Ë+ 
mesßge_expúy_öãrvÆ
;

78 
ãmp
->
mesßge_expúy_time
 = 0;

81 
ãmp
->
de°_ids
 = 
NULL
;

82 
ãmp
->
de°_id_cou¡
 = 0;

83 
db
->
msg_°‹e_cou¡
++;

84 
db
->
msg_°‹e_byãs
 +
∑ylﬂdÀn
;

85 (*
°‹ed
Ë
ãmp
;

87 if(!
°‹e_id
){

88 
ãmp
->
db_id
 = ++
db
->
œ°_db_id
;

90 
ãmp
->
db_id
 = 
°‹e_id
;

93 
db
->
msg_°‹e
 = 
ãmp
;

95  
MOSQ_ERR_SUCCESS
;

96 
îr‹
:

97 
	`mosquôto__‰ì
(
t›ic
);

98 if(
ãmp
){

99 
	`mosquôto__‰ì
(
ãmp
->
sour˚_id
);

100 
	`mosquôto__‰ì
(
ãmp
->
sour˚_u£∫ame
);

101 
	`mosquôto__‰ì
(
ãmp
->
t›ic
);

102 
	`mosquôto__‰ì
(
ãmp
);

104 
	`UHPA_FREE
(*
∑ylﬂd
, 
∑ylﬂdÀn
);

105  
rc
;

106 
	}
}

108 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

111 
	}
}

113 
time_t
 
	$mosquôto_time
()

116 
	}
}

118 
	$√t__sockë_˛o£
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

120  
MOSQ_ERR_SUCCESS
;

121 
	}
}

123 
	$£nd__pögªq
(
mosquôto
 *
mosq
)

125  
MOSQ_ERR_SUCCESS
;

126 
	}
}

128 
	$sub__add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
qos
, 
uöt32_t
 
idítifõr
, 
›ti⁄s
, 
mosquôto__subhõr
 **
roŸ
)

130 
œ°_sub
 = 
	`°rdup
(
sub
);

131 
œ°_qos
 = 
qos
;

132 
œ°_idítifõr
 = 
idítifõr
;

134  
MOSQ_ERR_SUCCESS
;

135 
	}
}

137 
	$sub__mesßges_queue
(
mosquôto_db
 *
db
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
)

139 if(
ªèö
){

140 
œ°_ªèöed
 = (*
°‹ed
)->
db_id
;

142  
MOSQ_ERR_SUCCESS
;

143 
	}
}

146 
	$db__msg_°‹e_ªf_öc
(
mosquôto_msg_°‹e
 *
°‹e
)

148 
°‹e
->
ªf_cou¡
++;

149 
	}
}

	@test/unit/persist_read_test.c

6 
	~<CUnô/CUnô.h
>

7 
	~<CUnô/Basic.h
>

9 
	#WITH_BROKER


	)

10 
	#WITH_PERSISTENCE


	)

12 
	~"mosquôto_brokî_öã∫Æ.h
"

13 
	~"≥rsi°.h
"

14 
	~"¥›îty_mosq.h
"

16 
uöt64_t
 
	gœ°_ªèöed
;

17 *
	gœ°_sub
 = 
NULL
;

18 
	gœ°_qos
;

19 
uöt32_t
 
	gœ°_idítifõr
;

21 
	$TEST_≥rsi°í˚_dißbÀd
()

23 
mosquôto_db
 
db
;

24 
mosquôto__c⁄fig
 
c⁄fig
;

25 
rc
;

27 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

28 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

29 
db
.
c⁄fig
 = &config;

31 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

32 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

33 
	}
}

36 
	$TEST_em±y_fûe
()

38 
mosquôto_db
 
db
;

39 
mosquôto__c⁄fig
 
c⁄fig
;

40 
rc
;

42 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

43 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

44 
db
.
c⁄fig
 = &config;

46 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

48 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/empty.test-db";

49 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

50 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

51 
	}
}

54 
	$TEST_c‹ru±_hódî
()

56 
mosquôto_db
 
db
;

57 
mosquôto__c⁄fig
 
c⁄fig
;

58 
rc
;

60 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

61 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

62 
db
.
c⁄fig
 = &config;

64 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

66 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/corrupt-header-short.test-db";

67 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

68 
	`CU_ASSERT_EQUAL
(
rc
, 1);

70 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/corrupt-header-long.test-db";

71 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

72 
	`CU_ASSERT_EQUAL
(
rc
, 1);

73 
	}
}

75 
	$TEST_unsuµ‹ãd_vîsi⁄
()

77 
mosquôto_db
 
db
;

78 
mosquôto__c⁄fig
 
c⁄fig
;

79 
rc
;

81 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

82 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

83 
db
.
c⁄fig
 = &config;

85 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

86 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/unsupported-version.test-db";

88 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

89 
	`CU_ASSERT_EQUAL
(
rc
, 1);

90 
	}
}

93 
	$TEST_v3_c⁄fig_ok
()

95 
mosquôto_db
 
db
;

96 
mosquôto__c⁄fig
 
c⁄fig
;

97 
rc
;

99 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

100 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

101 
db
.
c⁄fig
 = &config;

103 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

104 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-cfg.test-db";

106 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

107 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

108 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0x7856341200000000);

109 
	}
}

112 
	$TEST_v4_c⁄fig_ok
()

114 
mosquôto_db
 
db
;

115 
mosquôto__c⁄fig
 
c⁄fig
;

116 
rc
;

118 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

119 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

120 
db
.
c⁄fig
 = &config;

122 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

123 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v4-cfg.test-db";

125 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

126 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

127 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0x7856341200000000);

128 
	}
}

131 
	$TEST_v3_c⁄fig_åunˇãd
()

133 
mosquôto_db
 
db
;

134 
mosquôto__c⁄fig
 
c⁄fig
;

135 
rc
;

137 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

138 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

139 
db
.
c⁄fig
 = &config;

141 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

142 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-cfg-truncated.test-db";

144 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

145 
	`CU_ASSERT_EQUAL
(
rc
, 1);

146 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0);

147 
	}
}

150 
	$TEST_v3_c⁄fig_bad_dbid
()

152 
mosquôto_db
 
db
;

153 
mosquôto__c⁄fig
 
c⁄fig
;

154 
rc
;

156 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

157 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

158 
db
.
c⁄fig
 = &config;

160 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

161 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-cfg-bad-dbid.test-db";

163 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

164 
	`CU_ASSERT_EQUAL
(
rc
, 1);

165 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0);

166 
	}
}

169 
	$TEST_v3_bad_chunk
()

171 
mosquôto_db
 
db
;

172 
mosquôto__c⁄fig
 
c⁄fig
;

173 
rc
;

175 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

176 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

177 
db
.
c⁄fig
 = &config;

179 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

180 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-bad-chunk.test-db";

182 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

183 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

184 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0x17);

185 
	}
}

188 
	$TEST_v3_mesßge_°‹e
()

190 
mosquôto_db
 
db
;

191 
mosquôto__c⁄fig
 
c⁄fig
;

192 
rc
;

194 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

195 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

196 
db
.
c⁄fig
 = &config;

198 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

199 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-message-store.test-db";

201 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

202 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

203 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

204 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

205 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

206 if(
db
.
msg_°‹e
){

207 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 1);

208 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

209 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 2);

210 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

211 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 2);

212 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 1);

213 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
t›ic
);

214 if(
db
.
msg_°‹e
->
t›ic
){

215 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

217 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

218 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

219 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

222 
	}
}

224 
	$TEST_v3_˛õ¡
()

226 
mosquôto_db
 
db
;

227 
mosquôto__c⁄fig
 
c⁄fig
;

228 
mosquôto
 *
c⁄ãxt
;

229 
rc
;

231 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

232 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

233 
db
.
c⁄fig
 = &config;

235 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

236 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-client.test-db";

238 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

239 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

241 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

242 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

243 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

244 if(
c⁄ãxt
){

245 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_ö
.
öÊight
);

246 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
);

247 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
œ°_mid
, 0x5287);

249 
	}
}

251 
	$TEST_v3_˛õ¡_mesßge
()

253 
mosquôto_db
 
db
;

254 
mosquôto__c⁄fig
 
c⁄fig
;

255 
mosquôto
 *
c⁄ãxt
;

256 
rc
;

258 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

259 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

260 
db
.
c⁄fig
 = &config;

262 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

263 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-client-message.test-db";

264 
c⁄fig
.
max_öÊight_mesßges
 = 20;

266 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

267 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

269 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

270 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

271 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

272 if(
c⁄ãxt
){

273 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
);

274 if(
c⁄ãxt
->
msgs_out
.
öÊight
){

275 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
√xt
);

276 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
);

277 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
){

278 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªf_cou¡
, 1);

279 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_id
, "source_id");

280 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_mid
, 2);

281 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
mid
, 0);

282 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
qos
, 2);

283 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªèö
, 1);

284 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
t›ic
);

285 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
t›ic
){

286 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
t›ic
, "topic");

288 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
, 7);

289 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
 == 7){

290 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
), "payload", 7);

293 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
mid
, 0x73);

294 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
qos
, 1);

295 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
ªèö
, 0);

296 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dúe˘i⁄
, 
mosq_md_out
);

297 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°©e
, 
mosq_ms_waô_f‹_puback
);

298 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dup
, 0);

299 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
);

302 
	}
}

304 
	$TEST_v3_ªèö
()

306 
mosquôto_db
 
db
;

307 
mosquôto__c⁄fig
 
c⁄fig
;

308 
rc
;

310 
œ°_ªèöed
 = 0;

312 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

313 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

314 
db
.
c⁄fig
 = &config;

316 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

317 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-retain.test-db";

319 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

320 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

321 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

322 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

323 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

324 if(
db
.
msg_°‹e
){

325 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 0x54);

326 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

327 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 2);

328 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

329 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 2);

330 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 1);

331 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
t›ic
);

332 if(
db
.
msg_°‹e
->
t›ic
){

333 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

335 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

336 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

337 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

340 
	`CU_ASSERT_EQUAL
(
œ°_ªèöed
, 0x54);

341 
	}
}

343 
	$TEST_v3_sub
()

345 
mosquôto_db
 
db
;

346 
mosquôto__c⁄fig
 
c⁄fig
;

347 
mosquôto
 *
c⁄ãxt
;

348 
rc
;

350 
œ°_sub
 = 
NULL
;

351 
œ°_qos
 = -1;

353 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

354 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

355 
db
.
c⁄fig
 = &config;

357 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

358 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v3-sub.test-db";

360 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

361 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

363 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

364 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

365 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

366 if(
c⁄ãxt
){

367 
	`CU_ASSERT_PTR_NOT_NULL
(
œ°_sub
);

368 if(
œ°_sub
){

369 
	`CU_ASSERT_STRING_EQUAL
(
œ°_sub
, "subscription")

370 
	`‰ì
(
œ°_sub
);

372 
	`CU_ASSERT_EQUAL
(
œ°_qos
, 1);

374 
	}
}

376 
	$TEST_v4_mesßge_°‹e
()

378 
mosquôto_db
 
db
;

379 
mosquôto__c⁄fig
 
c⁄fig
;

380 
rc
;

382 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

383 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

384 
db
.
c⁄fig
 = &config;

386 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

387 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v4-message-store.test-db";

389 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

390 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

391 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

392 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

393 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

394 if(
db
.
msg_°‹e
){

395 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 0xFEDCBA9876543210);

396 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

397 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 0x88);

398 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

399 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 1);

400 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 0);

401 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
t›ic
);

402 if(
db
.
msg_°‹e
->
t›ic
){

403 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

405 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

406 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

407 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

410 
	}
}

412 
	$TEST_v5_c⁄fig_ok
()

414 
mosquôto_db
 
db
;

415 
mosquôto__c⁄fig
 
c⁄fig
;

416 
rc
;

418 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

419 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

420 
db
.
c⁄fig
 = &config;

422 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

423 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-cfg.test-db";

425 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

426 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

427 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0x7856341200000000);

428 
	}
}

431 
	$TEST_v5_c⁄fig_åunˇãd
()

433 
mosquôto_db
 
db
;

434 
mosquôto__c⁄fig
 
c⁄fig
;

435 
rc
;

437 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

438 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

439 
db
.
c⁄fig
 = &config;

441 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

442 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-cfg-truncated.test-db";

444 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

445 
	`CU_ASSERT_EQUAL
(
rc
, 1);

446 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0);

447 
	}
}

450 
	$TEST_v5_bad_chunk
()

452 
mosquôto_db
 
db
;

453 
mosquôto__c⁄fig
 
c⁄fig
;

454 
rc
;

456 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

457 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

458 
db
.
c⁄fig
 = &config;

460 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

461 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-bad-chunk.test-db";

463 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

464 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

465 
	`CU_ASSERT_EQUAL
(
db
.
œ°_db_id
, 0x17);

466 
	}
}

469 
	$TEST_v5_mesßge_°‹e
()

471 
mosquôto_db
 
db
;

472 
mosquôto__c⁄fig
 
c⁄fig
;

473 
rc
;

475 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

476 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

477 
db
.
c⁄fig
 = &config;

479 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

480 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-message-store.test-db";

482 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

483 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

484 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

485 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

486 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

487 if(
db
.
msg_°‹e
){

488 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 1);

489 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

490 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 2);

491 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

492 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 2);

493 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 1);

494 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

495 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

496 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

497 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

499 
	`CU_ASSERT_PTR_NULL
(
db
.
msg_°‹e
->
¥›îtõs
);

501 
	}
}

504 
	$TEST_v5_mesßge_°‹e_¥›s
()

506 
mosquôto_db
 
db
;

507 
mosquôto__c⁄fig
 
c⁄fig
;

508 
mosquôto__li°íî
 
li°íî
;

509 
rc
;

511 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

512 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

513 
	`mem£t
(&
li°íî
, 0, (
mosquôto__li°íî
));

514 
db
.
c⁄fig
 = &config;

516 
li°íî
.
p‹t
 = 1883;

517 
c⁄fig
.
li°íîs
 = &
li°íî
;

518 
c⁄fig
.
li°íî_cou¡
 = 1;

520 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

521 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-message-store-props.test-db";

523 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

524 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

525 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

526 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

527 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

528 if(
db
.
msg_°‹e
){

529 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 1);

530 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

531 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 2);

532 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

533 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 2);

534 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 1);

535 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

536 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

537 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

538 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

540 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
¥›îtõs
);

541 if(
db
.
msg_°‹e
->
¥›îtõs
){

542 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
¥›îtõs
->
idítifõr
, 1);

543 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
¥›îtõs
->
vÆue
.
i8
, 1);

545 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
sour˚_li°íî
);

547 
	}
}

549 
	$TEST_v5_˛õ¡
()

551 
mosquôto_db
 
db
;

552 
mosquôto__c⁄fig
 
c⁄fig
;

553 
mosquôto
 *
c⁄ãxt
;

554 
rc
;

556 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

557 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

558 
db
.
c⁄fig
 = &config;

560 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

561 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client.test-db";

563 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

564 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

566 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

567 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

568 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

569 if(
c⁄ãxt
){

570 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_ö
.
öÊight
);

571 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
);

572 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
œ°_mid
, 0x5287);

574 
	}
}

576 
	$TEST_v5_˛õ¡_mesßge
()

578 
mosquôto_db
 
db
;

579 
mosquôto__c⁄fig
 
c⁄fig
;

580 
mosquôto
 *
c⁄ãxt
;

581 
rc
;

583 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

584 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

585 
db
.
c⁄fig
 = &config;

587 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

588 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client-message.test-db";

590 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

591 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

593 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

594 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

595 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

596 if(
c⁄ãxt
){

597 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
);

598 if(
c⁄ãxt
->
msgs_out
.
öÊight
){

599 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
√xt
);

600 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
);

601 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
){

602 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªf_cou¡
, 1);

603 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_id
, "source_id");

604 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_mid
, 2);

605 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
mid
, 0);

606 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
qos
, 2);

607 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªèö
, 1);

608 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
t›ic
, "topic");

609 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
, 7);

610 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
 == 7){

611 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
), "payload", 7);

614 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
mid
, 0x73);

615 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
qos
, 1);

616 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
ªèö
, 0);

617 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dúe˘i⁄
, 
mosq_md_out
);

618 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°©e
, 
mosq_ms_waô_f‹_puback
);

619 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dup
, 0);

620 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
);

623 
	}
}

625 
	$TEST_v5_˛õ¡_mesßge_¥›s
()

627 
mosquôto_db
 
db
;

628 
mosquôto__c⁄fig
 
c⁄fig
;

629 
mosquôto
 *
c⁄ãxt
;

630 
rc
;

632 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

633 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

634 
db
.
c⁄fig
 = &config;

636 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

637 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client-message-props.test-db";

639 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

640 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

642 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

643 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

644 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

645 if(
c⁄ãxt
){

646 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
);

647 if(
c⁄ãxt
->
msgs_out
.
öÊight
){

648 
	`CU_ASSERT_PTR_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
√xt
);

649 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
);

650 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
){

651 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªf_cou¡
, 1);

652 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_id
, "source_id");

653 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
sour˚_mid
, 2);

654 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
mid
, 0);

655 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
qos
, 2);

656 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
ªèö
, 1);

657 
	`CU_ASSERT_STRING_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
t›ic
, "topic");

658 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
, 7);

659 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
->
∑ylﬂdÀn
 == 7){

660 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°‹e
), "payload", 7);

663 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
mid
, 0x73);

664 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
qos
, 1);

665 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
ªèö
, 0);

666 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dúe˘i⁄
, 
mosq_md_out
);

667 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
°©e
, 
mosq_ms_waô_f‹_puback
);

668 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
dup
, 0);

669 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
);

670 if(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
){

671 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
->
idítifõr
, 1);

672 
	`CU_ASSERT_EQUAL
(
c⁄ãxt
->
msgs_out
.
öÊight
->
¥›îtõs
->
vÆue
.
i8
, 1);

676 
	}
}

678 
	$TEST_v5_ªèö
()

680 
mosquôto_db
 
db
;

681 
mosquôto__c⁄fig
 
c⁄fig
;

682 
rc
;

684 
œ°_ªèöed
 = 0;

686 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

687 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

688 
db
.
c⁄fig
 = &config;

690 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

691 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-retain.test-db";

693 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

694 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

695 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_cou¡
, 1);

696 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e_byãs
, 7);

697 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

698 if(
db
.
msg_°‹e
){

699 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
db_id
, 0x54);

700 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
sour˚_id
, "source_id");

701 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_mid
, 2);

702 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
mid
, 0);

703 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
qos
, 2);

704 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
ªèö
, 1);

705 
	`CU_ASSERT_STRING_EQUAL
(
db
.
msg_°‹e
->
t›ic
, "topic");

706 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
∑ylﬂdÀn
, 7);

707 if(
db
.
msg_°‹e
->
∑ylﬂdÀn
 == 7){

708 
	`CU_ASSERT_NSTRING_EQUAL
(
	`UHPA_ACCESS_PAYLOAD
(
db
.
msg_°‹e
), "payload", 7);

711 
	`CU_ASSERT_EQUAL
(
œ°_ªèöed
, 0x54);

712 
	}
}

714 
	$TEST_v5_sub
()

716 
mosquôto_db
 
db
;

717 
mosquôto__c⁄fig
 
c⁄fig
;

718 
mosquôto
 *
c⁄ãxt
;

719 
rc
;

721 
œ°_sub
 = 
NULL
;

722 
œ°_qos
 = -1;

724 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

725 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

726 
db
.
c⁄fig
 = &config;

728 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

729 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-sub.test-db";

731 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

732 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

734 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
c⁄ãxts_by_id
);

735 
	`HASH_FIND
(
hh_id
, 
db
.
c⁄ãxts_by_id
, "˛õ¡-id", 
	`°æí
("˛õ¡-id"), 
c⁄ãxt
);

736 
	`CU_ASSERT_PTR_NOT_NULL
(
c⁄ãxt
);

737 if(
c⁄ãxt
){

738 
	`CU_ASSERT_PTR_NOT_NULL
(
œ°_sub
);

739 if(
œ°_sub
){

740 
	`CU_ASSERT_STRING_EQUAL
(
œ°_sub
, "subscription")

741 
	`‰ì
(
œ°_sub
);

743 
	`CU_ASSERT_EQUAL
(
œ°_qos
, 1);

744 
	`CU_ASSERT_EQUAL
(
œ°_idítifõr
, 0x7623);

746 
	}
}

752 
	$öô_≥rsi°_ªad_ã°s
()

754 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

756 
ã°_suôe
 = 
	`CU_add_suôe
("Pîsi°Ñód", 
NULL
, NULL);

757 if(!
ã°_suôe
){

758 
	`¥ötf
("Errorádding CUnitÖersistÑeadÅest suite.\n");

763 || !
	`CU_add_ã°
(
ã°_suôe
, "Pîsi°í˚ dißbÀd", 
TEST_≥rsi°í˚_dißbÀd
)

764 || !
	`CU_add_ã°
(
ã°_suôe
, "Em±y fûe", 
TEST_em±y_fûe
)

765 || !
	`CU_add_ã°
(
ã°_suôe
, "C‹ru± hódî", 
TEST_c‹ru±_hódî
)

766 || !
	`CU_add_ã°
(
ã°_suôe
, "Unsuµ‹ãd vîsi⁄", 
TEST_unsuµ‹ãd_vîsi⁄
)

767 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 c⁄fig ok", 
TEST_v3_c⁄fig_ok
)

768 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 c⁄fig badÅrunˇãd", 
TEST_v3_c⁄fig_åunˇãd
)

769 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 c⁄fig bad dbid", 
TEST_v3_c⁄fig_bad_dbid
)

770 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 bad chunk", 
TEST_v3_bad_chunk
)

771 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 mesßgê°‹e", 
TEST_v3_mesßge_°‹e
)

772 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 clõ¡", 
TEST_v3_˛õ¡
)

773 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 clõ¡ mesßge", 
TEST_v3_˛õ¡_mesßge
)

774 || !
	`CU_add_ã°
(
ã°_suôe
, "v3Ñëaö", 
TEST_v3_ªèö
)

775 || !
	`CU_add_ã°
(
ã°_suôe
, "v3 sub", 
TEST_v3_sub
)

776 || !
	`CU_add_ã°
(
ã°_suôe
, "v4 c⁄fig ok", 
TEST_v4_c⁄fig_ok
)

777 || !
	`CU_add_ã°
(
ã°_suôe
, "v4 mesßgê°‹e", 
TEST_v4_mesßge_°‹e
)

778 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 c⁄fig ok", 
TEST_v5_c⁄fig_ok
)

779 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 c⁄fig badÅrunˇãd", 
TEST_v5_c⁄fig_åunˇãd
)

780 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 bad chunk", 
TEST_v5_bad_chunk
)

781 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 mesßgê°‹e", 
TEST_v5_mesßge_°‹e
)

782 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 mesßgê°‹e+¥›s", 
TEST_v5_mesßge_°‹e_¥›s
)

783 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡", 
TEST_v5_˛õ¡
)

784 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡ mesßge", 
TEST_v5_˛õ¡_mesßge
)

785 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡ mesßge+¥›s", 
TEST_v5_˛õ¡_mesßge_¥›s
)

786 || !
	`CU_add_ã°
(
ã°_suôe
, "v5Ñëaö", 
TEST_v5_ªèö
)

787 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 sub", 
TEST_v5_sub
)

790 
	`¥ötf
("ErroráddingÖersist CUnitÅests.\n");

795 
	}
}

797 
	$maö
(
¨gc
, *
¨gv
[])

799 
Áûs
;

801 if(
	`CU_öôülize_ªgi°ry
(Ë!
CUE_SUCCESS
){

802 
	`¥ötf
("Error initializing CUnitÑegistry.\n");

807 || 
	`öô_≥rsi°_ªad_ã°s
()

810 
	`CU_˛ónup_ªgi°ry
();

814 
	`CU_basic_£t_mode
(
CU_BRM_VERBOSE
);

815 
	`CU_basic_run_ã°s
();

816 
Áûs
 = 
	`CU_gë_numbî_of_Áûuªs
();

817 
	`CU_˛ónup_ªgi°ry
();

819  ()
Áûs
;

820 
	}
}

	@test/unit/persist_write_stubs.c

1 
	~<time.h
>

3 
	#WITH_BROKER


	)

5 
	~<loggög_mosq.h
>

6 
	~<mem‹y_mosq.h
>

7 
	~<mosquôto_brokî_öã∫Æ.h
>

8 
	~<√t_mosq.h
>

9 
	~<£nd_mosq.h
>

10 
	~<time_mosq.h
>

12 
uöt64_t
 
œ°_ªèöed
;

13 *
œ°_sub
;

14 
œ°_qos
;

16 
mosquôto
 *
	$c⁄ãxt__öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
)

18  
	`mosquôto__ˇŒoc
(1, (
mosquôto
));

19 
	}
}

21 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

24 
	}
}

26 
time_t
 
	$mosquôto_time
()

29 
	}
}

31 
	$√t__sockë_˛o£
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
)

33  
MOSQ_ERR_SUCCESS
;

34 
	}
}

36 
	$£nd__pögªq
(
mosquôto
 *
mosq
)

38  
MOSQ_ERR_SUCCESS
;

39 
	}
}

41 
	$mosquôto_a˛_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, * 
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, 
ac˚ss
)

43  
MOSQ_ERR_SUCCESS
;

44 
	}
}

46 
	$a˛__föd_a˛s
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

48  
MOSQ_ERR_SUCCESS
;

49 
	}
}

52 
	$£nd__publish
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, c⁄° *
t›ic
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
, boﬁ 
dup
, c⁄° 
mosquôto_¥›îty
 *
cmsg_¥›s
, c⁄° mosquôto_¥›îty *
°‹e_¥›s
, uöt32_à
expúy_öãrvÆ
)

54  
MOSQ_ERR_SUCCESS
;

55 
	}
}

57 
	$£nd__pubcomp
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
)

59  
MOSQ_ERR_SUCCESS
;

60 
	}
}

62 
	$£nd__pubªc
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
, 
uöt8_t
 
ªas⁄_code
)

64  
MOSQ_ERR_SUCCESS
;

65 
	}
}

67 
	$£nd__pubªl
(
mosquôto
 *
mosq
, 
uöt16_t
 
mid
)

69  
MOSQ_ERR_SUCCESS
;

70 
	}
}

	@test/unit/persist_write_test.c

6 
	~<CUnô/CUnô.h
>

7 
	~<CUnô/Basic.h
>

9 
	#WITH_BROKER


	)

10 
	#WITH_PERSISTENCE


	)

12 
	~"mosquôto_brokî_öã∫Æ.h
"

13 
	~"≥rsi°.h
"

15 
uöt64_t
 
	gœ°_ªèöed
;

16 *
	gœ°_sub
 = 
NULL
;

17 
	gœ°_qos
;

21 
	$fûe_ªad
(c⁄° *
fûíame
, 
uöt8_t
 **
d©a
, 
size_t
 *
Àn
)

23 
FILE
 *
Âå
;

24 
size_t
 
rc
;

26 
Âå
 = 
	`f›í
(
fûíame
, "rb");

27 if(!
Âå
)  1;

29 
	`f£ek
(
Âå
, 0, 
SEEK_END
);

30 *
Àn
 = 
	`·ñl
(
Âå
);

31 *
d©a
 = 
	`mÆloc
(*
Àn
);

32 if(!(*
d©a
)){

33 
	`f˛o£
(
Âå
);

36 
	`f£ek
(
Âå
, 0, 
SEEK_SET
);

37 
rc
 = 
	`‰ód
(*
d©a
, 1, *
Àn
, 
Âå
);

38 
	`f˛o£
(
Âå
);

40 if(
rc
 =*
Àn
){

43 *
Àn
 = 0;

44 
	`‰ì
(*
d©a
);

47 
	}
}

50 
	$fûe_diff
(c⁄° *
⁄e
, c⁄° *
two
)

52 
size_t
 
Àn1
, 
Àn2
;

53 
uöt8_t
 *
d©a1
 = 
NULL
, *
d©a2
 = NULL;

54 
rc
 = 1;

56 if(
	`fûe_ªad
(
⁄e
, &
d©a1
, &
Àn1
)){

60 if(
	`fûe_ªad
(
two
, &
d©a2
, &
Àn2
)){

61 
	`‰ì
(
d©a1
);

65 if(
Àn1
 =
Àn2
){

66 
rc
 = 
	`memcmp
(
d©a1
, 
d©a2
, 
Àn1
);

68 
	`‰ì
(
d©a1
);

69 
	`‰ì
(
d©a2
);

71  
rc
;

72 
	}
}

74 
	$TEST_≥rsi°í˚_dißbÀd
()

76 
mosquôto_db
 
db
;

77 
mosquôto__c⁄fig
 
c⁄fig
;

78 
rc
;

80 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

81 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

82 
db
.
c⁄fig
 = &config;

84 
rc
 = 
	`≥rsi°__backup
(&
db
, 
Ál£
);

85 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

87 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "disabled.db";

88 
rc
 = 
	`≥rsi°__backup
(&
db
, 
Ál£
);

89 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

90 
	}
}

93 
	$TEST_em±y_fûe
()

95 
mosquôto_db
 
db
;

96 
mosquôto__c⁄fig
 
c⁄fig
;

97 
rc
;

99 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

100 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

101 
db
.
c⁄fig
 = &config;

103 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

105 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "empty.db";

106 
rc
 = 
	`≥rsi°__backup
(&
db
, 
Ál£
);

107 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

108 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_write/empty.test-db", "empty.db"));

109 
	`u∆ök
("empty.db");

110 
	}
}

113 
	$TEST_v5_c⁄fig_ok
()

115 
mosquôto_db
 
db
;

116 
mosquôto__c⁄fig
 
c⁄fig
;

117 
rc
;

119 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

120 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

121 
db
.
c⁄fig
 = &config;

123 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

124 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-cfg.test-db";

125 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

126 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

128 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-cfg.db";

129 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

130 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

132 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-cfg.test-db", "v5-cfg.db"));

133 
	`u∆ök
("v5-cfg.db");

134 
	}
}

137 
	$TEST_v5_mesßge_°‹e_no_ªf
()

139 
mosquôto_db
 
db
;

140 
mosquôto__c⁄fig
 
c⁄fig
;

141 
rc
;

143 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

144 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

145 
db
.
c⁄fig
 = &config;

147 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

148 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-message-store.test-db";

149 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

150 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

152 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-message-store-no-ref.db";

153 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

154 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

156 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_write/v5-message-store-no-ref.test-db", "v5-message-store-no-ref.db"));

157 
	`u∆ök
("v5-message-store-no-ref.db");

158 
	}
}

161 
	$TEST_v5_mesßge_°‹e_¥›s
()

163 
mosquôto_db
 
db
;

164 
mosquôto__c⁄fig
 
c⁄fig
;

165 
mosquôto__li°íî
 
li°íî
;

166 
rc
;

168 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

169 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

170 
	`mem£t
(&
li°íî
, 0, (
mosquôto__li°íî
));

171 
db
.
c⁄fig
 = &config;

172 
li°íî
.
p‹t
 = 1883;

173 
c⁄fig
.
li°íîs
 = &
li°íî
;

174 
c⁄fig
.
li°íî_cou¡
 = 1;

176 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

177 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-message-store-props.test-db";

178 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

179 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

181 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-message-store-props.db";

182 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

183 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

185 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-message-store-props.test-db", "v5-message-store-props.db"));

186 
	`u∆ök
("v5-message-store-props.db");

187 
	}
}

190 
	$TEST_v5_˛õ¡
()

192 
mosquôto_db
 
db
;

193 
mosquôto__c⁄fig
 
c⁄fig
;

194 
rc
;

196 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

197 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

198 
db
.
c⁄fig
 = &config;

200 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

201 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client.test-db";

202 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

203 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

205 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-client.db";

206 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

207 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

209 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-client.test-db", "v5-client.db"));

210 
	`u∆ök
("v5-client.db");

211 
	}
}

214 
	$TEST_v5_˛õ¡_mesßge
()

216 
mosquôto_db
 
db
;

217 
mosquôto__c⁄fig
 
c⁄fig
;

218 
mosquôto__li°íî
 
li°íî
;

219 
rc
;

221 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

222 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

223 
	`mem£t
(&
li°íî
, 0, (
mosquôto__li°íî
));

224 
db
.
c⁄fig
 = &config;

225 
li°íî
.
p‹t
 = 1883;

226 
c⁄fig
.
li°íîs
 = &
li°íî
;

227 
c⁄fig
.
li°íî_cou¡
 = 1;

229 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

230 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client-message.test-db";

231 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

232 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

234 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-client-message.db";

235 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

236 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

238 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-client-message.test-db", "v5-client-message.db"));

239 
	`u∆ök
("v5-client-message.db");

240 
	}
}

243 
	$TEST_v5_˛õ¡_mesßge_¥›s
()

245 
mosquôto_db
 
db
;

246 
mosquôto__c⁄fig
 
c⁄fig
;

247 
mosquôto__li°íî
 
li°íî
;

248 
rc
;

250 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

251 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

252 
	`mem£t
(&
li°íî
, 0, (
mosquôto__li°íî
));

253 
db
.
c⁄fig
 = &config;

254 
li°íî
.
p‹t
 = 1883;

255 
c⁄fig
.
li°íîs
 = &
li°íî
;

256 
c⁄fig
.
li°íî_cou¡
 = 1;

258 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

259 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-client-message-props.test-db";

260 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

261 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

263 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
);

264 if(
db
.
msg_°‹e
){

265 
	`CU_ASSERT_PTR_NOT_NULL
(
db
.
msg_°‹e
->
sour˚_li°íî
);

266 if(
db
.
msg_°‹e
->
sour˚_li°íî
){

267 
	`CU_ASSERT_EQUAL
(
db
.
msg_°‹e
->
sour˚_li°íî
->
p‹t
, 1883);

271 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-client-message-props.db";

272 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

273 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

275 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-client-message-props.test-db", "v5-client-message-props.db"));

276 
	`u∆ök
("v5-client-message-props.db");

277 
	}
}

280 
	$TEST_v5_sub
()

282 
mosquôto_db
 
db
;

283 
mosquôto__c⁄fig
 
c⁄fig
;

284 
mosquôto__li°íî
 
li°íî
;

285 
rc
;

287 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

288 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

289 
	`mem£t
(&
li°íî
, 0, (
mosquôto__li°íî
));

290 
db
.
c⁄fig
 = &config;

291 
li°íî
.
p‹t
 = 1883;

292 
c⁄fig
.
li°íîs
 = &
li°íî
;

293 
c⁄fig
.
li°íî_cou¡
 = 1;

295 
	`db__›í
(&
c⁄fig
, &
db
);

297 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

298 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_read/v5-sub.test-db";

299 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

300 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

302 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-sub.db";

303 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

304 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

306 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_read/v5-sub.test-db", "v5-sub.db"));

307 
	`u∆ök
("v5-sub.db");

308 
	}
}

312 
NOT
 
WORKING


313 
	$TEST_v5_fuŒ
()

315 
mosquôto_db
 
db
;

316 
mosquôto__c⁄fig
 
c⁄fig
;

317 
rc
;

319 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

320 
	`mem£t
(&
c⁄fig
, 0, (
mosquôto__c⁄fig
));

321 
db
.
c⁄fig
 = &config;

323 
	`db__›í
(&
c⁄fig
, &
db
);

325 
c⁄fig
.
≥rsi°í˚
 = 
åue
;

326 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "files/persist_write/v5-full.test-db";

327 
rc
 = 
	`≥rsi°__ª°‹e
(&
db
);

328 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

330 
c⁄fig
.
≥rsi°í˚_fûï©h
 = "v5-full.db";

331 
rc
 = 
	`≥rsi°__backup
(&
db
, 
åue
);

332 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

334 
	`CU_ASSERT_EQUAL
(0, 
	`fûe_diff
("files/persist_write/v5-full.test-db", "v5-full.db"));

335 
	`u∆ök
("v5-full.db");

336 
	}
}

345 
	$maö
(
¨gc
, *
¨gv
[])

347 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

348 
Áûs
;

350 if(
	`CU_öôülize_ªgi°ry
(Ë!
CUE_SUCCESS
){

351 
	`¥ötf
("Error initializing CUnitÑegistry.\n");

355 
ã°_suôe
 = 
	`CU_add_suôe
("Pîsi° wrôe", 
NULL
, NULL);

356 if(!
ã°_suôe
){

357 
	`¥ötf
("Errorádding CUnitÖersist writeÅest suite.\n");

358 
	`CU_˛ónup_ªgi°ry
();

363 || !
	`CU_add_ã°
(
ã°_suôe
, "Pîsi°í˚ dißbÀd", 
TEST_≥rsi°í˚_dißbÀd
)

364 || !
	`CU_add_ã°
(
ã°_suôe
, "Em±y fûe", 
TEST_em±y_fûe
)

365 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 c⁄fig ok", 
TEST_v5_c⁄fig_ok
)

366 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 mesßgê°‹ê(mesßgêha†nÿªfs)", 
TEST_v5_mesßge_°‹e_no_ªf
)

367 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 mesßgê°‹ê+Ör›s", 
TEST_v5_mesßge_°‹e_¥›s
)

368 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡", 
TEST_v5_˛õ¡
)

369 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡ mesßge", 
TEST_v5_˛õ¡_mesßge
)

370 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 clõ¡ mesßge+¥›s", 
TEST_v5_˛õ¡_mesßge_¥›s
)

371 || !
	`CU_add_ã°
(
ã°_suôe
, "v5 sub", 
TEST_v5_sub
)

375 
	`¥ötf
("ErroráddingÖersist CUnitÅests.\n");

376 
	`CU_˛ónup_ªgi°ry
();

380 
	`CU_basic_£t_mode
(
CU_BRM_VERBOSE
);

381 
	`CU_basic_run_ã°s
();

382 
Áûs
 = 
	`CU_gë_numbî_of_Áûuªs
();

383 
	`CU_˛ónup_ªgi°ry
();

385  ()
Áûs
;

386 
	}
}

	@test/unit/property_add.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"mqâ_¥Ÿocﬁ.h
"

5 
	~"¥›îty_mosq.h
"

6 
	~"∑ckë_mosq.h
"

12 
	$bad_add_byã_hñ≥r
(
idítifõr
)

14 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

15 
rc
;

17 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
idítifõr
, 1);

18 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

19 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

20 
	}
}

22 
	$bad_add_öt16_hñ≥r
(
idítifõr
)

24 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

25 
rc
;

27 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
idítifõr
, 1);

28 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

29 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

30 
	}
}

32 
	$bad_add_öt32_hñ≥r
(
idítifõr
)

34 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

35 
rc
;

37 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
idítifõr
, 1);

38 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

39 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

40 
	}
}

42 
	$bad_add_v¨öt_hñ≥r
(
idítifõr
)

44 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

45 
rc
;

47 
rc
 = 
	`mosquôto_¥›îty_add_v¨öt
(&
¥›li°
, 
idítifõr
, 1);

48 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

49 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

50 
	}
}

52 
	$bad_add_bö¨y_hñ≥r
(
idítifõr
)

54 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

55 
rc
;

57 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›li°
, 
idítifõr
, "test", 4);

58 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

59 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

60 
	}
}

62 
	$bad_add_°rög_hñ≥r
(
idítifõr
)

64 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

65 
rc
;

67 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
idítifõr
, "test");

68 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

69 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

70 
	}
}

72 
	$bad_add_°rög_∑ú_hñ≥r
(
idítifõr
)

74 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

75 
rc
;

77 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(&
¥›li°
, 
idítifõr
, "key", "value");

78 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

79 
	`CU_ASSERT_PTR_NULL
(
¥›li°
);

80 
	}
}

82 
	$TEST_add_bad_byã
()

84 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

85 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

86 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

87 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

88 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

89 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

90 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

91 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

92 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

93 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

94 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

95 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

96 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

97 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_REASON_STRING
);

98 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

99 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

100 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

101 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

102 
	`bad_add_byã_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

103 
	}
}

105 
	$TEST_add_bad_öt16
()

107 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

108 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

109 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

110 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

111 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

112 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

113 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

114 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

115 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

116 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

117 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

118 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

119 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

120 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

121 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

122 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_REASON_STRING
);

123 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

124 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

125 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

126 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

127 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

128 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

129 
	`bad_add_öt16_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

130 
	}
}

132 
	$TEST_add_bad_öt32
()

134 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

135 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

136 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

137 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

138 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

139 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

140 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

141 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

142 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

143 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

144 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

145 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

146 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

147 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_REASON_STRING
);

148 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

149 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

150 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

151 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

152 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

153 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

154 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

155 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

156 
	`bad_add_öt32_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

157 
	}
}

159 
	$TEST_add_bad_v¨öt
()

161 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

162 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

163 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

164 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

165 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

166 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

167 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

168 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

169 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

170 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

171 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

172 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

173 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

174 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

175 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

176 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_REASON_STRING
);

177 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

178 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

179 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

180 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

181 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

182 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

183 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

184 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

185 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

186 
	`bad_add_v¨öt_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

187 
	}
}

189 
	$TEST_add_bad_bö¨y
()

191 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

192 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

193 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

194 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

195 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

196 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

197 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

198 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

199 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

200 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

201 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

202 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

203 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

204 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

205 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_REASON_STRING
);

206 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

207 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

208 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

209 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

210 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

211 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

212 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

213 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

214 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

215 
	`bad_add_bö¨y_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

216 
	}
}

218 
	$TEST_add_bad_°rög
()

220 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

221 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

222 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

223 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

224 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

225 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

226 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

227 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

228 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

229 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

230 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

231 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

232 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

233 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

234 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

235 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

236 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

237 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

238 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

239 
	`bad_add_°rög_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

240 
	}
}

242 
	$TEST_add_bad_°rög_∑ú
()

244 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

245 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

246 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

247 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

248 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

249 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

250 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

251 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

252 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

253 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

254 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

255 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

256 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

257 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

258 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

259 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

260 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_REASON_STRING
);

261 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

262 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

263 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

264 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

265 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

266 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

267 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

268 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

269 
	`bad_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

270 
	}
}

276 
	$sögÀ_add_byã_hñ≥r
(
idítifõr
)

278 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

279 
rc
;

281 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
idítifõr
, 1);

282 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

283 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

284 if(
¥›li°
){

285 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

286 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
i8
, 1);

287 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

289 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

291 
	}
}

293 
	$sögÀ_add_öt16_hñ≥r
(
idítifõr
)

295 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

296 
rc
;

298 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
idítifõr
, 11234);

299 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

300 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

301 if(
¥›li°
){

302 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

303 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
i16
, 11234);

304 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

306 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

308 
	}
}

310 
	$sögÀ_add_öt32_hñ≥r
(
idítifõr
)

312 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

313 
rc
;

315 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
idítifõr
, 765432);

316 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

317 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

318 if(
¥›li°
){

319 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

320 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
i32
, 765432);

321 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

323 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

325 
	}
}

327 
	$sögÀ_add_v¨öt_hñ≥r
(
idítifõr
)

329 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

330 
rc
;

332 
rc
 = 
	`mosquôto_¥›îty_add_v¨öt
(&
¥›li°
, 
idítifõr
, 139123999);

333 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

334 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

335 if(
¥›li°
){

336 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

337 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
v¨öt
, 139123999);

338 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

340 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

342 
	}
}

344 
	$sögÀ_add_bö¨y_hñ≥r
(
idítifõr
)

346 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

347 
rc
;

349 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›li°
, 
idítifõr
, "test", 4);

350 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

351 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

352 if(
¥›li°
){

353 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

354 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
bö
.
Àn
, 4);

355 
	`CU_ASSERT_NSTRING_EQUAL
(
¥›li°
->
vÆue
.
bö
.
v
, "test", 4);

356 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

358 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

360 
	}
}

362 
	$sögÀ_add_°rög_hñ≥r
(
idítifõr
)

364 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

365 
rc
;

367 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
idítifõr
, "string");

368 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

369 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

370 if(
¥›li°
){

371 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

372 
	`CU_ASSERT_STRING_EQUAL
(
¥›li°
->
vÆue
.
s
.
v
, "string");

373 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
s
.
Àn
, 
	`°æí
("string"));

374 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

376 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

378 
	}
}

380 
	$sögÀ_add_°rög_∑ú_hñ≥r
(
idítifõr
)

382 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

383 
rc
;

385 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(&
¥›li°
, 
idítifõr
, "key", "value");

386 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

387 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

388 if(
¥›li°
){

389 
	`CU_ASSERT_EQUAL
(
¥›li°
->
idítifõr
, identifier);

390 
	`CU_ASSERT_STRING_EQUAL
(
¥›li°
->
«me
.
v
, "key");

391 
	`CU_ASSERT_EQUAL
(
¥›li°
->
«me
.
Àn
, 
	`°æí
("key"));

392 
	`CU_ASSERT_STRING_EQUAL
(
¥›li°
->
vÆue
.
s
.
v
, "value");

393 
	`CU_ASSERT_EQUAL
(
¥›li°
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

394 
	`CU_ASSERT_PTR_NULL
(
¥›li°
->
√xt
);

396 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

398 
	}
}

400 
	$TEST_add_sögÀ_byã
()

402 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

403 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

404 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

405 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_MAXIMUM_QOS
);

406 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_RETAIN_AVAILABLE
);

407 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

408 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

409 
	`sögÀ_add_byã_hñ≥r
(
MQTT_PROP_SHARED_SUB_AVAILABLE
);

410 
	}
}

412 
	$TEST_add_sögÀ_öt16
()

414 
	`sögÀ_add_öt16_hñ≥r
(
MQTT_PROP_SERVER_KEEP_ALIVE
);

415 
	`sögÀ_add_öt16_hñ≥r
(
MQTT_PROP_RECEIVE_MAXIMUM
);

416 
	`sögÀ_add_öt16_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

417 
	`sögÀ_add_öt16_hñ≥r
(
MQTT_PROP_TOPIC_ALIAS
);

418 
	}
}

420 
	$TEST_add_sögÀ_öt32
()

422 
	`sögÀ_add_öt32_hñ≥r
(
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

423 
	`sögÀ_add_öt32_hñ≥r
(
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

424 
	`sögÀ_add_öt32_hñ≥r
(
MQTT_PROP_WILL_DELAY_INTERVAL
);

425 
	`sögÀ_add_öt32_hñ≥r
(
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

426 
	}
}

428 
	$TEST_add_sögÀ_v¨öt
()

430 
	`sögÀ_add_v¨öt_hñ≥r
(
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

431 
	}
}

433 
	$TEST_add_sögÀ_bö¨y
()

435 
	`sögÀ_add_bö¨y_hñ≥r
(
MQTT_PROP_CORRELATION_DATA
);

436 
	`sögÀ_add_bö¨y_hñ≥r
(
MQTT_PROP_AUTHENTICATION_DATA
);

437 
	}
}

439 
	$TEST_add_sögÀ_°rög
()

441 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

442 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_RESPONSE_TOPIC
);

443 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

444 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_AUTHENTICATION_METHOD
);

445 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_RESPONSE_INFORMATION
);

446 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_SERVER_REFERENCE
);

447 
	`sögÀ_add_°rög_hñ≥r
(
MQTT_PROP_REASON_STRING
);

448 
	}
}

450 
	$TEST_add_sögÀ_°rög_∑ú
()

452 
	`sögÀ_add_°rög_∑ú_hñ≥r
(
MQTT_PROP_USER_PROPERTY
);

453 
	}
}

459 
	$TEST_add_Æl_c⁄√˘
()

461 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

462 
mosquôto_¥›îty
 *
p
;

463 
cou¡
;

464 
rc
;

466 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 86400);

467 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

468 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

469 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

470 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

471 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

472 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

473 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

474 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

475 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

476 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

477 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

478 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

479 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

480 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

481 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

482 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

483 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

484 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

485 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

486 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

487 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(&
¥›li°
, 
MQTT_PROP_USER_PROPERTY
, "user-agent", "mosquitto/test");

488 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

489 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

490 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

491 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

492 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

494 
p
 = 
¥›li°
;

495 
cou¡
 = 0;

496 
p
){

497 
cou¡
++;

498 
p
 =Ö->
√xt
;

500 
	`CU_ASSERT_EQUAL
(
cou¡
, 9);

502 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

503 
	}
}

506 
	$TEST_add_Æl_c⁄«ck
()

508 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
;

509 
mosquôto_¥›îty
 *
p
;

510 
cou¡
;

511 
rc
;

513 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 86400);

514 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

515 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

516 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "clientid");

517 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

518 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

519 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 900);

520 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

521 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

522 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

523 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

524 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

525 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(&
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

526 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

527 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

528 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_RESPONSE_INFORMATION
, "response");

529 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

530 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

531 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_SERVER_REFERENCE
, "localhost");

532 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

533 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

534 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(&
¥›li°
, 
MQTT_PROP_REASON_STRING
, "reason");

535 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

536 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

537 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

538 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

539 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

540 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(&
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

541 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

542 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

543 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_MAXIMUM_QOS
, 1);

544 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

545 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

546 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

547 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

548 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

549 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(&
¥›li°
, 
MQTT_PROP_USER_PROPERTY
, "user-agent", "mosquitto/test");

550 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

551 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

552 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(&
¥›li°
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

553 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

554 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

555 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

556 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

557 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

558 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

559 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

560 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

561 
rc
 = 
	`mosquôto_¥›îty_add_byã
(&
¥›li°
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0);

562 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

563 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°
);

565 
p
 = 
¥›li°
;

566 
cou¡
 = 0;

567 
p
){

568 
cou¡
++;

569 
p
 =Ö->
√xt
;

571 
	`CU_ASSERT_EQUAL
(
cou¡
, 17);

573 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

574 
	}
}

580 
	$öô_¥›îty_add_ã°s
()

582 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

584 
ã°_suôe
 = 
	`CU_add_suôe
("Pr›îtyádd", 
NULL
, NULL);

585 if(!
ã°_suôe
){

586 
	`¥ötf
("Errorádding CUnit PropertyáddÅest suite.\n");

591 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad byã", 
TEST_add_bad_byã
)

592 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad i¡16", 
TEST_add_bad_öt16
)

593 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad i¡32", 
TEST_add_bad_öt32
)

594 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad v¨öt", 
TEST_add_bad_v¨öt
)

595 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad bö¨y", 
TEST_add_bad_bö¨y
)

596 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad såög", 
TEST_add_bad_°rög
)

597 || !
	`CU_add_ã°
(
ã°_suôe
, "Add bad såögÖaú", 
TEST_add_bad_°rög_∑ú
)

598 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ byã", 
TEST_add_sögÀ_byã
)

599 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ i¡16", 
TEST_add_sögÀ_öt16
)

600 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ i¡32", 
TEST_add_sögÀ_öt32
)

601 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ v¨öt", 
TEST_add_sögÀ_v¨öt
)

602 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ bö¨y", 
TEST_add_sögÀ_bö¨y
)

603 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ såög", 
TEST_add_sögÀ_°rög
)

604 || !
	`CU_add_ã°
(
ã°_suôe
, "Add sögÀ såögÖaú", 
TEST_add_sögÀ_°rög_∑ú
)

605 || !
	`CU_add_ã°
(
ã°_suôe
, "AddáŒ CONNECT", 
TEST_add_Æl_c⁄√˘
)

606 || !
	`CU_add_ã°
(
ã°_suôe
, "AddáŒ CONNACK", 
TEST_add_Æl_c⁄«ck
)

609 
	`¥ötf
("Errorádding Property Add CUnitÅests.\n");

614 
	}
}

	@test/unit/property_read.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"mqâ_¥Ÿocﬁ.h
"

5 
	~"¥›îty_mosq.h
"

6 
	~"∑ckë_mosq.h
"

8 
	$byã_¥›_ªad_hñ≥r
(

9 
comm™d
,

10 
uöt8_t
 *
∑ylﬂd
,

11 
ªmaöög_Àngth
,

12 
rc_ex≥˘ed
,

13 
idítifõr
,

14 
uöt8_t
 
vÆue_ex≥˘ed
)

16 
mosquôto__∑ckë
 
∑ckë
;

17 
mosquôto_¥›îty
 *
¥›îtõs
;

18 
rc
;

20 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

21 
∑ckë
.
∑ylﬂd
 =Öayload;

22 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

23 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

25 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

26 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

27 if(
¥›îtõs
){

28 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

29 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i8
, 
vÆue_ex≥˘ed
);

30 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

31 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 2);

32 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

34 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

35 
	}
}

37 
	$du∂iˇã_byã_hñ≥r
(
comm™d
, 
idítifõr
)

39 
uöt8_t
 
∑ylﬂd
[20];

41 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

42 
∑ylﬂd
[0] = 4;

43 
∑ylﬂd
[1] = 
idítifõr
;

44 
∑ylﬂd
[2] = 1;

45 
∑ylﬂd
[3] = 
idítifõr
;

46 
∑ylﬂd
[4] = 0;

48 
	`byã_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 5, 
MOSQ_ERR_DUPLICATE_PROPERTY
, 
idítifõr
, 1);

49 
	}
}

51 
	$bad_byã_hñ≥r
(
comm™d
, 
idítifõr
)

53 
uöt8_t
 
∑ylﬂd
[20];

55 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

56 
∑ylﬂd
[0] = 2;

57 
∑ylﬂd
[1] = 
idítifõr
;

58 
∑ylﬂd
[2] = 2;

60 
	`byã_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 3, 
MOSQ_ERR_PROTOCOL
, 
idítifõr
, 0);

61 
	}
}

64 
	$öt32_¥›_ªad_hñ≥r
(

65 
comm™d
,

66 
uöt8_t
 *
∑ylﬂd
,

67 
ªmaöög_Àngth
,

68 
rc_ex≥˘ed
,

69 
idítifõr
,

70 
uöt32_t
 
vÆue_ex≥˘ed
)

72 
mosquôto__∑ckë
 
∑ckë
;

73 
mosquôto_¥›îty
 *
¥›îtõs
;

74 
rc
;

76 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

77 
∑ckë
.
∑ylﬂd
 =Öayload;

78 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

79 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

81 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

82 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

83 if(
¥›îtõs
){

84 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

85 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i32
, 
vÆue_ex≥˘ed
);

86 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

87 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 5);

88 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

90 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

91 
	}
}

93 
	$du∂iˇã_öt32_hñ≥r
(
comm™d
, 
idítifõr
)

95 
uöt8_t
 
∑ylﬂd
[20];

97 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

98 
∑ylﬂd
[0] = 10;

99 
∑ylﬂd
[1] = 
idítifõr
;

100 
∑ylﬂd
[2] = 1;

101 
∑ylﬂd
[3] = 1;

102 
∑ylﬂd
[4] = 1;

103 
∑ylﬂd
[5] = 1;

104 
∑ylﬂd
[6] = 
idítifõr
;

105 
∑ylﬂd
[7] = 0;

106 
∑ylﬂd
[8] = 0;

107 
∑ylﬂd
[9] = 0;

108 
∑ylﬂd
[10] = 0;

110 
	`öt32_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 11, 
MOSQ_ERR_DUPLICATE_PROPERTY
, 
idítifõr
, 1);

111 
	}
}

114 
	$öt16_¥›_ªad_hñ≥r
(

115 
comm™d
,

116 
uöt8_t
 *
∑ylﬂd
,

117 
ªmaöög_Àngth
,

118 
rc_ex≥˘ed
,

119 
idítifõr
,

120 
uöt16_t
 
vÆue_ex≥˘ed
)

122 
mosquôto__∑ckë
 
∑ckë
;

123 
mosquôto_¥›îty
 *
¥›îtõs
;

124 
rc
;

126 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

127 
∑ckë
.
∑ylﬂd
 =Öayload;

128 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

129 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

131 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

132 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

133 if(
¥›îtõs
){

134 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

135 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i16
, 
vÆue_ex≥˘ed
);

136 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

137 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 3);

138 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

140 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

141 
	}
}

143 
	$du∂iˇã_öt16_hñ≥r
(
comm™d
, 
idítifõr
)

145 
uöt8_t
 
∑ylﬂd
[20];

147 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

148 
∑ylﬂd
[0] = 6;

149 
∑ylﬂd
[1] = 
idítifõr
;

150 
∑ylﬂd
[2] = 1;

151 
∑ylﬂd
[3] = 1;

152 
∑ylﬂd
[4] = 
idítifõr
;

153 
∑ylﬂd
[5] = 0;

154 
∑ylﬂd
[6] = 0;

156 
	`öt16_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 7, 
MOSQ_ERR_DUPLICATE_PROPERTY
, 
idítifõr
, 1);

157 
	}
}

159 
	$°rög_¥›_ªad_hñ≥r
(

160 
comm™d
,

161 
uöt8_t
 *
∑ylﬂd
,

162 
ªmaöög_Àngth
,

163 
rc_ex≥˘ed
,

164 
idítifõr
,

165 c⁄° *
vÆue_ex≥˘ed
)

167 
mosquôto__∑ckë
 
∑ckë
;

168 
mosquôto_¥›îty
 *
¥›îtõs
;

169 
rc
;

171 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

172 
∑ckë
.
∑ylﬂd
 =Öayload;

173 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

174 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

176 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

177 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

178 if(
¥›îtõs
){

179 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

180 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
Àn
, 
	`°æí
(
vÆue_ex≥˘ed
));

181 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
v
, 
vÆue_ex≥˘ed
);

182 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

183 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
	`°æí
(
vÆue_ex≥˘ed
));

184 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

186 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

187 
	}
}

189 
	$du∂iˇã_°rög_hñ≥r
(
comm™d
, 
idítifõr
)

191 
uöt8_t
 
∑ylﬂd
[20];

193 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

194 
∑ylﬂd
[0] = 8;

195 
∑ylﬂd
[1] = 
idítifõr
;

196 
∑ylﬂd
[2] = 0;

197 
∑ylﬂd
[3] = 1;

198 
∑ylﬂd
[4] = 'h';

199 
∑ylﬂd
[5] = 
idítifõr
;

200 
∑ylﬂd
[6] = 0;

201 
∑ylﬂd
[7] = 1;

202 
∑ylﬂd
[8] = 'h';

204 
	`°rög_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 9, 
MOSQ_ERR_DUPLICATE_PROPERTY
, 
idítifõr
, "");

205 
	}
}

207 
	$bad_°rög_hñ≥r
(
idítifõr
)

209 
uöt8_t
 
∑ylﬂd
[20];

211 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

212 
∑ylﬂd
[0] = 6;

213 
∑ylﬂd
[1] = 
idítifõr
;

214 
∑ylﬂd
[2] = 0;

215 
∑ylﬂd
[3] = 3;

216 
∑ylﬂd
[4] = 'h';

217 
∑ylﬂd
[5] = 0;

218 
∑ylﬂd
[6] = 'h';

220 
	`°rög_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 7, 
MOSQ_ERR_MALFORMED_UTF8
, 
idítifõr
, "");

221 
	}
}

223 
	$bö¨y_¥›_ªad_hñ≥r
(

224 
comm™d
,

225 
uöt8_t
 *
∑ylﬂd
,

226 
ªmaöög_Àngth
,

227 
rc_ex≥˘ed
,

228 
idítifõr
,

229 c⁄° 
uöt8_t
 *
vÆue_ex≥˘ed
,

230 
Àn_ex≥˘ed
)

232 
mosquôto__∑ckë
 
∑ckë
;

233 
mosquôto_¥›îty
 *
¥›îtõs
;

234 
rc
;

236 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

237 
∑ckë
.
∑ylﬂd
 =Öayload;

238 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

239 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

241 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

242 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

243 if(
¥›îtõs
){

244 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

245 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
bö
.
Àn
, 
Àn_ex≥˘ed
);

246 
	`CU_ASSERT_EQUAL
(
	`memcmp
(
¥›îtõs
->
vÆue
.
bö
.
v
, 
vÆue_ex≥˘ed
, 
Àn_ex≥˘ed
), 0);

247 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

248 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
Àn_ex≥˘ed
);

249 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

251 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

252 
	}
}

254 
	$du∂iˇã_bö¨y_hñ≥r
(
comm™d
, 
idítifõr
)

256 
uöt8_t
 
∑ylﬂd
[20];

258 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

259 
∑ylﬂd
[0] = 8;

260 
∑ylﬂd
[1] = 
idítifõr
;

261 
∑ylﬂd
[2] = 0;

262 
∑ylﬂd
[3] = 1;

263 
∑ylﬂd
[4] = 'h';

264 
∑ylﬂd
[5] = 
idítifõr
;

265 
∑ylﬂd
[6] = 0;

266 
∑ylﬂd
[7] = 1;

267 
∑ylﬂd
[8] = 'h';

269 
	`°rög_¥›_ªad_hñ≥r
(
comm™d
, 
∑ylﬂd
, 9, 
MOSQ_ERR_DUPLICATE_PROPERTY
, 
idítifõr
, "");

270 
	}
}

272 
	$°rög_∑ú_¥›_ªad_hñ≥r
(

273 
uöt8_t
 *
∑ylﬂd
,

274 
ªmaöög_Àngth
,

275 
rc_ex≥˘ed
,

276 
idítifõr
,

277 c⁄° *
«me_ex≥˘ed
,

278 c⁄° *
vÆue_ex≥˘ed
,

279 
boﬁ
 
ex≥˘_mu…ùÀ
)

281 
mosquôto__∑ckë
 
∑ckë
;

282 
mosquôto_¥›îty
 *
¥›îtõs
;

283 
rc
;

285 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

286 
∑ckë
.
∑ylﬂd
 =Öayload;

287 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

288 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

290 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

291 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

292 if(
¥›îtõs
){

293 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

294 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
«me
.
Àn
, 
	`°æí
(
«me_ex≥˘ed
));

295 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
Àn
, 
	`°æí
(
vÆue_ex≥˘ed
));

296 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
«me
.
v
, 
«me_ex≥˘ed
);

297 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
v
, 
vÆue_ex≥˘ed
);

298 if(
ex≥˘_mu…ùÀ
){

299 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
->
√xt
);

301 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
->
√xt
);

302 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
	`°æí
(
«me_ex≥˘ed
)+2+°æí(
vÆue_ex≥˘ed
));

304 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

306 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
);

307 
	}
}

309 
	$v¨öt_¥›_ªad_hñ≥r
(

310 
uöt8_t
 *
∑ylﬂd
,

311 
ªmaöög_Àngth
,

312 
rc_ex≥˘ed
,

313 
idítifõr
,

314 
uöt32_t
 
vÆue_ex≥˘ed
)

316 
mosquôto__∑ckë
 
∑ckë
;

317 
mosquôto_¥›îty
 *
¥›îtõs
;

318 
rc
;

320 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

321 
∑ckë
.
∑ylﬂd
 =Öayload;

322 
∑ckë
.
ªmaöög_Àngth
 =Ñemaining_length;

323 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
∑ckë
, &
¥›îtõs
);

325 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

326 if(
¥›îtõs
){

327 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

328 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
v¨öt
, 
vÆue_ex≥˘ed
);

329 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
->
√xt
);

330 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 
	`∑ckë__v¨öt_byãs
(
vÆue_ex≥˘ed
)+1);

331 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

333 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
);

334 
	}
}

336 
	$∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
comm™d
)

338 
uöt8_t
 
∑ylﬂd
[24] = {23,

339 
MQTT_PROP_REASON_STRING
, 0, 6, 'r', 'e', 'a', 's', 'o', 'n',

340 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e'};

342 
mosquôto__∑ckë
 
∑ckë
;

343 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

344 
rc
;

346 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

347 
∑ckë
.
∑ylﬂd
 =Öayload;

348 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

349 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

351 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

352 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
);

353 if(
¥›îtõs
){

354 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
->
√xt
);

355 
p
 = 
¥›îtõs
;

357 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REASON_STRING
);

358 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "reason");

359 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("reason"));

361 
p
 =Ö->
√xt
;

362 if(
p
){

363 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

365 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

366 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

367 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

368 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

369 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

372 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

374 
	}
}

380 
	$TEST_no_¥›îtõs
()

382 
mosquôto__∑ckë
 
∑ckë
;

383 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

384 
uöt8_t
 
∑ylﬂd
[5];

385 
rc
;

387 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

388 
	`mem£t
(
∑ylﬂd
, 0, (payload));

389 
∑ckë
.
∑ylﬂd
 =Öayload;

390 
∑ckë
.
ªmaöög_Àngth
 = 1;

391 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

392 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

393 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

394 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 1);

395 
	}
}

397 
	$TEST_åunˇãd
()

399 
mosquôto__∑ckë
 
∑ckë
;

400 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

401 
uöt8_t
 
∑ylﬂd
[5];

402 
rc
;

405 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

406 
	`mem£t
(
∑ylﬂd
, 0, (payload));

407 
∑ckë
.
∑ylﬂd
 =Öayload;

408 
∑ckë
.
ªmaöög_Àngth
 = 0;

409 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

410 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_PROTOCOL
);

411 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

412 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 0);

415 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

416 
	`mem£t
(
∑ylﬂd
, 0, (payload));

417 
∑ylﬂd
[0] = 2;

418 
∑ckë
.
∑ylﬂd
 =Öayload;

419 
∑ckë
.
ªmaöög_Àngth
 = 1;

420 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

421 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_PROTOCOL
);

422 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

423 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 1);

426 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

427 
	`mem£t
(
∑ylﬂd
, 0, (payload));

428 
∑ylﬂd
[0] = 4;

429 
∑ylﬂd
[1] = 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
;

430 
∑ckë
.
∑ylﬂd
 =Öayload;

431 
∑ckë
.
ªmaöög_Àngth
 = 2;

432 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

433 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_PROTOCOL
);

434 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

435 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 2);

436 
	}
}

442 
	$TEST_övÆid_¥›îty_id
()

444 
mosquôto__∑ckë
 
∑ckë
;

445 
mosquôto_¥›îty
 *
¥›îtõs
 = 
NULL
;

446 
uöt8_t
 
∑ylﬂd
[5];

447 
rc
;

450 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

451 
	`mem£t
(
∑ylﬂd
, 0, (payload));

452 
∑ylﬂd
[0] = 4;

453 
∑ckë
.
∑ylﬂd
 =Öayload;

454 
∑ckë
.
ªmaöög_Àngth
 = 2;

455 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

456 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_MALFORMED_PACKET
);

457 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

458 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 2);

461 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

462 
	`mem£t
(
∑ylﬂd
, 0, (payload));

463 
∑ylﬂd
[0] = 4;

464 
∑ylﬂd
[1] = 4;

465 
∑ckë
.
∑ylﬂd
 =Öayload;

466 
∑ckë
.
ªmaöög_Àngth
 = 2;

467 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

468 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_MALFORMED_PACKET
);

469 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

470 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 2);

471 
	}
}

477 
	$TEST_sögÀ_∑ylﬂd_f‹m©_ödiˇt‹
()

479 
uöt8_t
 
∑ylﬂd
[20];

481 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

482 
∑ylﬂd
[0] = 2;

483 
∑ylﬂd
[1] = 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
;

484 
∑ylﬂd
[2] = 1;

486 
	`byã_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

487 
	}
}

489 
	$TEST_sögÀ_ªque°_¥obÀm_öf‹m©i⁄
()

491 
uöt8_t
 
∑ylﬂd
[20];

493 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

494 
∑ylﬂd
[0] = 2;

495 
∑ylﬂd
[1] = 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
;

496 
∑ylﬂd
[2] = 1;

498 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

499 
	}
}

501 
	$TEST_sögÀ_ªque°_ª•⁄£_öf‹m©i⁄
()

503 
uöt8_t
 
∑ylﬂd
[20];

505 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

506 
∑ylﬂd
[0] = 2;

507 
∑ylﬂd
[1] = 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
;

508 
∑ylﬂd
[2] = 1;

510 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

511 
	}
}

513 
	$TEST_sögÀ_maximum_qos
()

515 
uöt8_t
 
∑ylﬂd
[20];

517 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

518 
∑ylﬂd
[0] = 2;

519 
∑ylﬂd
[1] = 
MQTT_PROP_MAXIMUM_QOS
;

520 
∑ylﬂd
[2] = 1;

522 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_QOS
, 1);

523 
	}
}

525 
	$TEST_sögÀ_ªèö_avaûabÀ
()

527 
uöt8_t
 
∑ylﬂd
[20];

529 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

530 
∑ylﬂd
[0] = 2;

531 
∑ylﬂd
[1] = 
MQTT_PROP_RETAIN_AVAILABLE
;

532 
∑ylﬂd
[2] = 1;

534 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RETAIN_AVAILABLE
, 1);

535 
	}
}

537 
	$TEST_sögÀ_wûdˇrd_subs¸ùti⁄_avaûabÀ
()

539 
uöt8_t
 
∑ylﬂd
[20];

541 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

542 
∑ylﬂd
[0] = 2;

543 
∑ylﬂd
[1] = 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
;

544 
∑ylﬂd
[2] = 0;

546 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

547 
	}
}

549 
	$TEST_sögÀ_subs¸ùti⁄_idítifõr_avaûabÀ
()

551 
uöt8_t
 
∑ylﬂd
[20];

553 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

554 
∑ylﬂd
[0] = 2;

555 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
;

556 
∑ylﬂd
[2] = 0;

558 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

559 
	}
}

561 
	$TEST_sögÀ_sh¨ed_subs¸ùti⁄_avaûabÀ
()

563 
uöt8_t
 
∑ylﬂd
[20];

565 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

566 
∑ylﬂd
[0] = 2;

567 
∑ylﬂd
[1] = 
MQTT_PROP_SHARED_SUB_AVAILABLE
;

568 
∑ylﬂd
[2] = 1;

570 
	`byã_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 1);

571 
	}
}

573 
	$TEST_sögÀ_mesßge_expúy_öãrvÆ
()

575 
uöt8_t
 
∑ylﬂd
[20];

577 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

578 
∑ylﬂd
[0] = 5;

579 
∑ylﬂd
[1] = 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
;

580 
∑ylﬂd
[2] = 0x12;

581 
∑ylﬂd
[3] = 0x23;

582 
∑ylﬂd
[4] = 0x34;

583 
∑ylﬂd
[5] = 0x45;

585 
	`öt32_¥›_ªad_hñ≥r
(
CMD_WILL
, 
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 0x12233445);

586 
	}
}

588 
	$TEST_sögÀ_£ssi⁄_expúy_öãrvÆ
()

590 
uöt8_t
 
∑ylﬂd
[20];

592 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

593 
∑ylﬂd
[0] = 5;

594 
∑ylﬂd
[1] = 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
;

595 
∑ylﬂd
[2] = 0x45;

596 
∑ylﬂd
[3] = 0x34;

597 
∑ylﬂd
[4] = 0x23;

598 
∑ylﬂd
[5] = 0x12;

600 
	`öt32_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 0x45342312);

601 
	}
}

603 
	$TEST_sögÀ_wûl_dñay_öãrvÆ
()

605 
uöt8_t
 
∑ylﬂd
[20];

607 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

608 
∑ylﬂd
[0] = 5;

609 
∑ylﬂd
[1] = 
MQTT_PROP_WILL_DELAY_INTERVAL
;

610 
∑ylﬂd
[2] = 0x45;

611 
∑ylﬂd
[3] = 0x34;

612 
∑ylﬂd
[4] = 0x23;

613 
∑ylﬂd
[5] = 0x12;

615 
	`öt32_¥›_ªad_hñ≥r
(
CMD_WILL
, 
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 0x45342312);

616 
	}
}

618 
	$TEST_sögÀ_maximum_∑ckë_size
()

620 
uöt8_t
 
∑ylﬂd
[20];

622 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

623 
∑ylﬂd
[0] = 5;

624 
∑ylﬂd
[1] = 
MQTT_PROP_MAXIMUM_PACKET_SIZE
;

625 
∑ylﬂd
[2] = 0x45;

626 
∑ylﬂd
[3] = 0x34;

627 
∑ylﬂd
[4] = 0x23;

628 
∑ylﬂd
[5] = 0x12;

630 
	`öt32_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 0x45342312);

631 
	}
}

633 
	$TEST_sögÀ_£rvî_kìp_Æive
()

635 
uöt8_t
 
∑ylﬂd
[20];

637 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

638 
∑ylﬂd
[0] = 3;

639 
∑ylﬂd
[1] = 
MQTT_PROP_SERVER_KEEP_ALIVE
;

640 
∑ylﬂd
[2] = 0x45;

641 
∑ylﬂd
[3] = 0x34;

643 
	`öt16_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 0x4534);

644 
	}
}

646 
	$TEST_sögÀ_ª˚ive_maximum
()

648 
uöt8_t
 
∑ylﬂd
[20];

650 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

651 
∑ylﬂd
[0] = 3;

652 
∑ylﬂd
[1] = 
MQTT_PROP_RECEIVE_MAXIMUM
;

653 
∑ylﬂd
[2] = 0x68;

654 
∑ylﬂd
[3] = 0x42;

656 
	`öt16_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 0x6842);

657 
	}
}

659 
	$TEST_sögÀ_t›ic_Æüs_maximum
()

661 
uöt8_t
 
∑ylﬂd
[20];

663 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

664 
∑ylﬂd
[0] = 3;

665 
∑ylﬂd
[1] = 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
;

666 
∑ylﬂd
[2] = 0x68;

667 
∑ylﬂd
[3] = 0x42;

669 
	`öt16_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 0x6842);

670 
	}
}

672 
	$TEST_sögÀ_t›ic_Æüs
()

674 
uöt8_t
 
∑ylﬂd
[20];

676 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

677 
∑ylﬂd
[0] = 3;

678 
∑ylﬂd
[1] = 
MQTT_PROP_TOPIC_ALIAS
;

679 
∑ylﬂd
[2] = 0x68;

680 
∑ylﬂd
[3] = 0x42;

682 
	`öt16_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS
, 0x6842);

683 
	}
}

685 
	$TEST_sögÀ_c⁄ã¡_ty≥
()

687 
uöt8_t
 
∑ylﬂd
[20];

689 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

690 
∑ylﬂd
[0] = 8;

691 
∑ylﬂd
[1] = 
MQTT_PROP_CONTENT_TYPE
;

692 
∑ylﬂd
[2] = 0x00;

693 
∑ylﬂd
[3] = 0x05;

694 
∑ylﬂd
[4] = 'h';

695 
∑ylﬂd
[5] = 'e';

696 
∑ylﬂd
[6] = 'l';

697 
∑ylﬂd
[7] = 'l';

698 
∑ylﬂd
[8] = 'o';

700 
	`°rög_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CONTENT_TYPE
, "hello");

701 
	}
}

703 
	$TEST_sögÀ_ª•⁄£_t›ic
()

705 
uöt8_t
 
∑ylﬂd
[20];

707 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

708 
∑ylﬂd
[0] = 8;

709 
∑ylﬂd
[1] = 
MQTT_PROP_RESPONSE_TOPIC
;

710 
∑ylﬂd
[2] = 0x00;

711 
∑ylﬂd
[3] = 0x05;

712 
∑ylﬂd
[4] = 'h';

713 
∑ylﬂd
[5] = 'e';

714 
∑ylﬂd
[6] = 'l';

715 
∑ylﬂd
[7] = 'l';

716 
∑ylﬂd
[8] = 'o';

718 
	`°rög_¥›_ªad_hñ≥r
(
CMD_WILL
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_TOPIC
, "hello");

719 
	}
}

721 
	$TEST_sögÀ_assig√d_˛õ¡_idítifõr
()

723 
uöt8_t
 
∑ylﬂd
[20];

725 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

726 
∑ylﬂd
[0] = 8;

727 
∑ylﬂd
[1] = 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
;

728 
∑ylﬂd
[2] = 0x00;

729 
∑ylﬂd
[3] = 0x05;

730 
∑ylﬂd
[4] = 'h';

731 
∑ylﬂd
[5] = 'e';

732 
∑ylﬂd
[6] = 'l';

733 
∑ylﬂd
[7] = 'l';

734 
∑ylﬂd
[8] = 'o';

736 
	`°rög_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "hello");

737 
	}
}

739 
	$TEST_sögÀ_authítiˇti⁄_mëhod
()

741 
uöt8_t
 
∑ylﬂd
[20];

743 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

744 
∑ylﬂd
[0] = 8;

745 
∑ylﬂd
[1] = 
MQTT_PROP_AUTHENTICATION_METHOD
;

746 
∑ylﬂd
[2] = 0x00;

747 
∑ylﬂd
[3] = 0x05;

748 
∑ylﬂd
[4] = 'h';

749 
∑ylﬂd
[5] = 'e';

750 
∑ylﬂd
[6] = 'l';

751 
∑ylﬂd
[7] = 'l';

752 
∑ylﬂd
[8] = 'o';

754 
	`°rög_¥›_ªad_hñ≥r
(
CMD_AUTH
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "hello");

755 
	}
}

757 
	$TEST_sögÀ_ª•⁄£_öf‹m©i⁄
()

759 
uöt8_t
 
∑ylﬂd
[20];

761 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

762 
∑ylﬂd
[0] = 8;

763 
∑ylﬂd
[1] = 
MQTT_PROP_RESPONSE_INFORMATION
;

764 
∑ylﬂd
[2] = 0x00;

765 
∑ylﬂd
[3] = 0x05;

766 
∑ylﬂd
[4] = 'h';

767 
∑ylﬂd
[5] = 'e';

768 
∑ylﬂd
[6] = 'l';

769 
∑ylﬂd
[7] = 'l';

770 
∑ylﬂd
[8] = 'o';

772 
	`°rög_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_INFORMATION
, "hello");

773 
	}
}

775 
	$TEST_sögÀ_£rvî_ª„ªn˚
()

777 
uöt8_t
 
∑ylﬂd
[20];

779 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

780 
∑ylﬂd
[0] = 8;

781 
∑ylﬂd
[1] = 
MQTT_PROP_SERVER_REFERENCE
;

782 
∑ylﬂd
[2] = 0x00;

783 
∑ylﬂd
[3] = 0x05;

784 
∑ylﬂd
[4] = 'h';

785 
∑ylﬂd
[5] = 'e';

786 
∑ylﬂd
[6] = 'l';

787 
∑ylﬂd
[7] = 'l';

788 
∑ylﬂd
[8] = 'o';

790 
	`°rög_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_REFERENCE
, "hello");

791 
	}
}

793 
	$TEST_sögÀ_ªas⁄_°rög
()

795 
uöt8_t
 
∑ylﬂd
[20];

797 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

798 
∑ylﬂd
[0] = 8;

799 
∑ylﬂd
[1] = 
MQTT_PROP_REASON_STRING
;

800 
∑ylﬂd
[2] = 0x00;

801 
∑ylﬂd
[3] = 0x05;

802 
∑ylﬂd
[4] = 'h';

803 
∑ylﬂd
[5] = 'e';

804 
∑ylﬂd
[6] = 'l';

805 
∑ylﬂd
[7] = 'l';

806 
∑ylﬂd
[8] = 'o';

808 
	`°rög_¥›_ªad_hñ≥r
(
CMD_PUBCOMP
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REASON_STRING
, "hello");

809 
	}
}

811 
	$TEST_sögÀ_c‹ªœti⁄_d©a
()

813 
uöt8_t
 
∑ylﬂd
[20];

815 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

816 
∑ylﬂd
[0] = 8;

817 
∑ylﬂd
[1] = 
MQTT_PROP_CORRELATION_DATA
;

818 
∑ylﬂd
[2] = 0x00;

819 
∑ylﬂd
[3] = 0x05;

820 
∑ylﬂd
[4] = 1;

821 
∑ylﬂd
[5] = 'e';

822 
∑ylﬂd
[6] = 0;

823 
∑ylﬂd
[7] = 'l';

824 
∑ylﬂd
[8] = 9;

826 
	`bö¨y_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CORRELATION_DATA
, &payload[4], 5);

827 
	}
}

829 
	$TEST_sögÀ_authítiˇti⁄_d©a
()

831 
uöt8_t
 
∑ylﬂd
[20];

833 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

834 
∑ylﬂd
[0] = 8;

835 
∑ylﬂd
[1] = 
MQTT_PROP_AUTHENTICATION_DATA
;

836 
∑ylﬂd
[2] = 0x00;

837 
∑ylﬂd
[3] = 0x05;

838 
∑ylﬂd
[4] = 1;

839 
∑ylﬂd
[5] = 'e';

840 
∑ylﬂd
[6] = 0;

841 
∑ylﬂd
[7] = 'l';

842 
∑ylﬂd
[8] = 9;

844 
	`bö¨y_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_DATA
, &payload[4], 5);

845 
	}
}

847 
	$TEST_sögÀ_u£r_¥›îty
()

849 
uöt8_t
 
∑ylﬂd
[20];

851 
∑ylﬂd
[0] = 9;

852 
∑ylﬂd
[1] = 
MQTT_PROP_USER_PROPERTY
;

853 
∑ylﬂd
[2] = 0;

854 
∑ylﬂd
[3] = 2;

855 
∑ylﬂd
[4] = 'z';

856 
∑ylﬂd
[5] = 'a';

857 
∑ylﬂd
[6] = 0;

858 
∑ylﬂd
[7] = 2;

859 
∑ylﬂd
[8] = 'b';

860 
∑ylﬂd
[9] = 'c';

862 
	`°rög_∑ú_¥›_ªad_hñ≥r
(
∑ylﬂd
, 10, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_USER_PROPERTY
, "za", "bc", 
Ál£
);

863 
	}
}

865 
	$TEST_sögÀ_subs¸ùti⁄_idítifõr
()

867 
uöt8_t
 
∑ylﬂd
[20];

869 
∑ylﬂd
[0] = 2;

870 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

871 
∑ylﬂd
[2] = 0;

872 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0);

874 
∑ylﬂd
[0] = 2;

875 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

876 
∑ylﬂd
[2] = 0x7F;

877 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 127);

879 
∑ylﬂd
[0] = 3;

880 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

881 
∑ylﬂd
[2] = 0x80;

882 
∑ylﬂd
[3] = 0x01;

883 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 128);

885 
∑ylﬂd
[0] = 3;

886 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

887 
∑ylﬂd
[2] = 0xFF;

888 
∑ylﬂd
[3] = 0x7F;

889 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 16383);

891 
∑ylﬂd
[0] = 4;

892 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

893 
∑ylﬂd
[2] = 0x80;

894 
∑ylﬂd
[3] = 0x80;

895 
∑ylﬂd
[4] = 0x01;

896 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 5, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 16384);

898 
∑ylﬂd
[0] = 4;

899 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

900 
∑ylﬂd
[2] = 0xFF;

901 
∑ylﬂd
[3] = 0xFF;

902 
∑ylﬂd
[4] = 0x7F;

903 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 5, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 2097151);

905 
∑ylﬂd
[0] = 5;

906 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

907 
∑ylﬂd
[2] = 0x80;

908 
∑ylﬂd
[3] = 0x80;

909 
∑ylﬂd
[4] = 0x80;

910 
∑ylﬂd
[5] = 0x01;

911 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 2097152);

914 
∑ylﬂd
[0] = 5;

915 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

916 
∑ylﬂd
[2] = 0xFF;

917 
∑ylﬂd
[3] = 0xFF;

918 
∑ylﬂd
[4] = 0xFF;

919 
∑ylﬂd
[5] = 0x7F;

920 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 268435455);

921 
	}
}

927 
	$TEST_du∂iˇã_∑ylﬂd_f‹m©_ödiˇt‹
()

929 
	`du∂iˇã_byã_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

930 
	}
}

932 
	$TEST_du∂iˇã_ªque°_¥obÀm_öf‹m©i⁄
()

934 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

935 
	}
}

937 
	$TEST_du∂iˇã_ªque°_ª•⁄£_öf‹m©i⁄
()

939 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

940 
	}
}

942 
	$TEST_du∂iˇã_maximum_qos
()

944 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_MAXIMUM_QOS
);

945 
	}
}

947 
	$TEST_du∂iˇã_ªèö_avaûabÀ
()

949 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_RETAIN_AVAILABLE
);

950 
	}
}

952 
	$TEST_du∂iˇã_wûdˇrd_subs¸ùti⁄_avaûabÀ
()

954 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

955 
	}
}

957 
	$TEST_du∂iˇã_subs¸ùti⁄_idítifõr_avaûabÀ
()

959 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

960 
	}
}

962 
	$TEST_du∂iˇã_sh¨ed_subs¸ùti⁄_avaûabÀ
()

964 
	`du∂iˇã_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
);

965 
	}
}

967 
	$TEST_du∂iˇã_mesßge_expúy_öãrvÆ
()

969 
	`du∂iˇã_öt32_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

970 
	}
}

972 
	$TEST_du∂iˇã_£ssi⁄_expúy_öãrvÆ
()

974 
	`du∂iˇã_öt32_hñ≥r
(
CMD_DISCONNECT
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

975 
	}
}

977 
	$TEST_du∂iˇã_wûl_dñay_öãrvÆ
()

979 
	`du∂iˇã_öt32_hñ≥r
(
CMD_WILL
, 
MQTT_PROP_WILL_DELAY_INTERVAL
);

980 
	}
}

982 
	$TEST_du∂iˇã_maximum_∑ckë_size
()

984 
	`du∂iˇã_öt32_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

985 
	}
}

987 
	$TEST_du∂iˇã_£rvî_kìp_Æive
()

989 
	`du∂iˇã_öt16_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SERVER_KEEP_ALIVE
);

990 
	}
}

992 
	$TEST_du∂iˇã_ª˚ive_maximum
()

994 
	`du∂iˇã_öt16_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_RECEIVE_MAXIMUM
);

995 
	}
}

997 
	$TEST_du∂iˇã_t›ic_Æüs_maximum
()

999 
	`du∂iˇã_öt16_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

1000 
	}
}

1002 
	$TEST_du∂iˇã_t›ic_Æüs
()

1004 
	`du∂iˇã_öt16_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_TOPIC_ALIAS
);

1005 
	}
}

1007 
	$TEST_du∂iˇã_c⁄ã¡_ty≥
()

1009 
	`du∂iˇã_°rög_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_CONTENT_TYPE
);

1010 
	}
}

1012 
	$TEST_du∂iˇã_ª•⁄£_t›ic
()

1014 
	`du∂iˇã_°rög_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_RESPONSE_TOPIC
);

1015 
	}
}

1017 
	$TEST_du∂iˇã_assig√d_˛õ¡_idítifõr
()

1019 
	`du∂iˇã_°rög_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

1020 
	}
}

1022 
	$TEST_du∂iˇã_authítiˇti⁄_mëhod
()

1024 
	`du∂iˇã_°rög_hñ≥r
(
CMD_AUTH
, 
MQTT_PROP_AUTHENTICATION_METHOD
);

1025 
	}
}

1027 
	$TEST_du∂iˇã_ª•⁄£_öf‹m©i⁄
()

1029 
	`du∂iˇã_°rög_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_RESPONSE_INFORMATION
);

1030 
	}
}

1032 
	$TEST_du∂iˇã_£rvî_ª„ªn˚
()

1034 
	`du∂iˇã_°rög_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SERVER_REFERENCE
);

1035 
	}
}

1037 
	$TEST_du∂iˇã_ªas⁄_°rög
()

1039 
	`du∂iˇã_°rög_hñ≥r
(
CMD_PUBACK
, 
MQTT_PROP_REASON_STRING
);

1040 
	}
}

1042 
	$TEST_du∂iˇã_c‹ªœti⁄_d©a
()

1044 
	`du∂iˇã_bö¨y_hñ≥r
(
CMD_PUBLISH
, 
MQTT_PROP_CORRELATION_DATA
);

1045 
	}
}

1047 
	$TEST_du∂iˇã_authítiˇti⁄_d©a
()

1049 
	`du∂iˇã_bö¨y_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_AUTHENTICATION_DATA
);

1050 
	}
}

1052 
	$TEST_du∂iˇã_u£r_¥›îty
()

1054 
uöt8_t
 
∑ylﬂd
[20];

1056 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1057 
∑ylﬂd
[0] = 18;

1058 
∑ylﬂd
[1] = 
MQTT_PROP_USER_PROPERTY
;

1059 
∑ylﬂd
[2] = 0;

1060 
∑ylﬂd
[3] = 2;

1061 
∑ylﬂd
[4] = 'a';

1062 
∑ylﬂd
[5] = 'b';

1063 
∑ylﬂd
[6] = 0;

1064 
∑ylﬂd
[7] = 2;

1065 
∑ylﬂd
[8] = 'g';

1066 
∑ylﬂd
[9] = 'h';

1067 
∑ylﬂd
[10] = 
MQTT_PROP_USER_PROPERTY
;

1068 
∑ylﬂd
[11] = 0;

1069 
∑ylﬂd
[12] = 2;

1070 
∑ylﬂd
[13] = 'c';

1071 
∑ylﬂd
[14] = 'd';

1072 
∑ylﬂd
[15] = 0;

1073 
∑ylﬂd
[16] = 2;

1074 
∑ylﬂd
[17] = 'e';

1075 
∑ylﬂd
[18] = 'f';

1077 
	`°rög_∑ú_¥›_ªad_hñ≥r
(
∑ylﬂd
, 19, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_USER_PROPERTY
, "ab", "gh", 
åue
);

1078 
	}
}

1080 
	$TEST_du∂iˇã_subs¸ùti⁄_idítifõr
()

1082 
uöt8_t
 
∑ylﬂd
[20];

1084 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1085 
∑ylﬂd
[0] = 4;

1086 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

1087 
∑ylﬂd
[2] = 0x80;

1088 
∑ylﬂd
[3] = 0x02;

1089 
∑ylﬂd
[4] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

1090 
∑ylﬂd
[5] = 0x04;

1092 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 5, 
MOSQ_ERR_PROTOCOL
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0);

1093 
	}
}

1099 
	$TEST_bad_ªque°_¥obÀm_öf‹m©i⁄
()

1101 
	`bad_byã_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

1102 
	}
}

1104 
	$TEST_bad_ªque°_ª•⁄£_öf‹m©i⁄
()

1106 
	`bad_byã_hñ≥r
(
CMD_CONNECT
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

1107 
	}
}

1109 
	$TEST_bad_maximum_qos
()

1111 
	`bad_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_MAXIMUM_QOS
);

1112 
	}
}

1114 
	$TEST_bad_ªèö_avaûabÀ
()

1116 
	`bad_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_RETAIN_AVAILABLE
);

1117 
	}
}

1119 
	$TEST_bad_wûdˇrd_sub_avaûabÀ
()

1121 
	`bad_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

1122 
	}
}

1124 
	$TEST_bad_subs¸ùti⁄_id_avaûabÀ
()

1126 
	`bad_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

1127 
	}
}

1129 
	$TEST_bad_sh¨ed_sub_avaûabÀ
()

1131 
	`bad_byã_hñ≥r
(
CMD_CONNACK
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
);

1132 
	}
}

1134 
	$TEST_bad_maximum_∑ckë_size
()

1136 
uöt8_t
 
∑ylﬂd
[20];

1138 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1139 
∑ylﬂd
[0] = 5;

1140 
∑ylﬂd
[1] = 
MQTT_PROP_MAXIMUM_PACKET_SIZE
;

1141 
∑ylﬂd
[2] = 0;

1142 
∑ylﬂd
[3] = 0;

1143 
∑ylﬂd
[4] = 0;

1144 
∑ylﬂd
[5] = 0;

1146 
	`öt32_¥›_ªad_hñ≥r
(
CMD_CONNACK
, 
∑ylﬂd
, 6, 
MOSQ_ERR_PROTOCOL
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 0);

1147 
	}
}

1149 
	$TEST_bad_ª˚ive_maximum
()

1151 
uöt8_t
 
∑ylﬂd
[20];

1153 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1154 
∑ylﬂd
[0] = 3;

1155 
∑ylﬂd
[1] = 
MQTT_PROP_RECEIVE_MAXIMUM
;

1156 
∑ylﬂd
[2] = 0;

1157 
∑ylﬂd
[3] = 0;

1159 
	`öt32_¥›_ªad_hñ≥r
(
CMD_CONNECT
, 
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 0);

1160 
	}
}

1162 
	$TEST_bad_t›ic_Æüs
()

1164 
uöt8_t
 
∑ylﬂd
[20];

1166 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1167 
∑ylﬂd
[0] = 3;

1168 
∑ylﬂd
[1] = 
MQTT_PROP_TOPIC_ALIAS
;

1169 
∑ylﬂd
[2] = 0;

1170 
∑ylﬂd
[3] = 0;

1172 
	`öt32_¥›_ªad_hñ≥r
(
CMD_PUBLISH
, 
∑ylﬂd
, 4, 
MOSQ_ERR_PROTOCOL
, 
MQTT_PROP_TOPIC_ALIAS
, 0);

1173 
	}
}

1175 
	$TEST_bad_c⁄ã¡_ty≥
()

1177 
	`bad_°rög_hñ≥r
(
MQTT_PROP_CONTENT_TYPE
);

1178 
	}
}

1180 
	$TEST_bad_subs¸ùti⁄_idítifõr
()

1182 
uöt8_t
 
∑ylﬂd
[20];

1184 
	`mem£t
(&
∑ylﬂd
, 0, (payload));

1185 
∑ylﬂd
[0] = 6;

1186 
∑ylﬂd
[1] = 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
;

1187 
∑ylﬂd
[2] = 0xFF;

1188 
∑ylﬂd
[3] = 0xFF;

1189 
∑ylﬂd
[4] = 0xFF;

1190 
∑ylﬂd
[5] = 0xFF;

1191 
∑ylﬂd
[6] = 0x01;

1193 
	`v¨öt_¥›_ªad_hñ≥r
(
∑ylﬂd
, 7, 
MOSQ_ERR_PROTOCOL
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0);

1194 
	}
}

1200 
	$TEST_∑ckë_c⁄√˘
()

1202 
uöt8_t
 
∑ylﬂd
[] = {0,

1203 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 0x12, 0x45, 0x00, 0x00,

1204 
MQTT_PROP_RECEIVE_MAXIMUM
, 0x00, 0x05,

1205 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 0x12, 0x45, 0x00, 0x00,

1206 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 0x00, 0x02,

1207 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1,

1208 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1,

1209 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e',

1210 
MQTT_PROP_AUTHENTICATION_METHOD
, 0x00, 0x04, 'n', 'o', 'n', 'e',

1211 
MQTT_PROP_AUTHENTICATION_DATA
, 0x00, 0x02, 1, 2};

1213 
mosquôto__∑ckë
 
∑ckë
;

1214 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1215 
rc
;

1217 
∑ylﬂd
[0] = (payload)-1;

1219 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1220 
∑ckë
.
∑ylﬂd
 =Öayload;

1221 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1222 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

1224 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1225 
p
 = 
¥›îtõs
;

1226 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
);

1227 if(
p
){

1228 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1229 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

1230 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1232 
p
 =Ö->
√xt
;

1233 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1234 if(
p
){

1235 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1236 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_RECEIVE_MAXIMUM
);

1237 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x0005);

1239 
p
 =Ö->
√xt
;

1240 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1241 if(
p
){

1242 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1243 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

1244 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1246 
p
 =Ö->
√xt
;

1247 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1248 if(
p
){

1249 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1250 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

1251 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x0002);

1253 
p
 =Ö->
√xt
;

1254 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1255 if(
p
){

1256 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1257 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
);

1258 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 1);

1260 
p
 =Ö->
√xt
;

1261 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1262 if(
p
){

1263 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1264 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
);

1265 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 1);

1267 
p
 =Ö->
√xt
;

1268 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1269 if(
p
){

1270 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1271 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1272 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1273 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1274 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1275 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1277 
p
 =Ö->
√xt
;

1278 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1279 if(
p
){

1280 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1281 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_METHOD
);

1282 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "none");

1283 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("none"));

1285 
p
 =Ö->
√xt
;

1286 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1287 if(
p
){

1288 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1289 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_DATA
);

1290 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[0], 1);

1291 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[1], 2);

1292 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 2);

1303 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1304 
	}
}

1306 
	$TEST_∑ckë_c⁄«ck
()

1308 
uöt8_t
 
∑ylﬂd
[] = {0,

1309 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 0x12, 0x45, 0x00, 0x00,

1310 
MQTT_PROP_RECEIVE_MAXIMUM
, 0x00, 0x05,

1311 
MQTT_PROP_MAXIMUM_QOS
, 1,

1312 
MQTT_PROP_RETAIN_AVAILABLE
, 0,

1313 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 0x12, 0x45, 0x00, 0x00,

1314 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, 0x00, 0x02, 'a', 'b',

1315 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 0x00, 0x02,

1316 
MQTT_PROP_REASON_STRING
, 0, 6, 'r', 'e', 'a', 's', 'o', 'n',

1317 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e',

1318 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0,

1319 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0,

1320 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0,

1321 
MQTT_PROP_SERVER_KEEP_ALIVE
, 0x00, 0xFF,

1322 
MQTT_PROP_RESPONSE_INFORMATION
, 0x00, 0x03, 'r', 's', 'p',

1323 
MQTT_PROP_SERVER_REFERENCE
, 0x00, 0x04, 's', 'e', 'r', 'v',

1324 
MQTT_PROP_AUTHENTICATION_METHOD
, 0x00, 0x04, 'n', 'o', 'n', 'e',

1325 
MQTT_PROP_AUTHENTICATION_DATA
, 0x00, 0x02, 1, 2};

1327 
mosquôto__∑ckë
 
∑ckë
;

1328 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1329 
rc
;

1331 
∑ylﬂd
[0] = (payload)-1;

1333 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1334 
∑ckë
.
∑ylﬂd
 =Öayload;

1335 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1336 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNACK
, &
∑ckë
, &
¥›îtõs
);

1338 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1339 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
);

1340 
p
 = 
¥›îtõs
;

1342 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1343 if(
p
){

1344 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

1345 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1347 
p
 =Ö->
√xt
;

1348 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1349 if(
p
){

1350 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1351 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_RECEIVE_MAXIMUM
);

1352 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x0005);

1354 
p
 =Ö->
√xt
;

1355 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1356 if(
p
){

1357 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1358 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_MAXIMUM_QOS
);

1359 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 1);

1361 
p
 =Ö->
√xt
;

1362 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1363 if(
p
){

1364 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1365 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_RETAIN_AVAILABLE
);

1366 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 0);

1368 
p
 =Ö->
√xt
;

1369 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1370 if(
p
){

1371 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1372 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
);

1373 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1375 
p
 =Ö->
√xt
;

1376 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1377 if(
p
){

1378 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1379 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
);

1380 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "ab");

1381 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("ab"));

1383 
p
 =Ö->
√xt
;

1384 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1385 if(
p
){

1386 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1387 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
);

1388 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x0002);

1390 
p
 =Ö->
√xt
;

1391 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1392 if(
p
){

1393 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1394 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REASON_STRING
);

1395 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "reason");

1396 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("reason"));

1398 
p
 =Ö->
√xt
;

1399 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1400 if(
p
){

1401 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1402 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1403 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1404 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1405 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1406 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1408 
p
 =Ö->
√xt
;

1409 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1410 if(
p
){

1411 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1412 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
);

1413 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 0);

1415 
p
 =Ö->
√xt
;

1416 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1417 if(
p
){

1418 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1419 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
);

1420 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 0);

1422 
p
 =Ö->
√xt
;

1423 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1424 if(
p
){

1425 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1426 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
);

1427 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 0);

1429 
p
 =Ö->
√xt
;

1430 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1431 if(
p
){

1432 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1433 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SERVER_KEEP_ALIVE
);

1434 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x00FF);

1436 
p
 =Ö->
√xt
;

1437 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1438 if(
p
){

1439 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1440 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_RESPONSE_INFORMATION
);

1441 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "rsp");

1442 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("rsp"));

1444 
p
 =Ö->
√xt
;

1445 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1446 if(
p
){

1447 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1448 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SERVER_REFERENCE
);

1449 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "serv");

1450 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("serv"));

1452 
p
 =Ö->
√xt
;

1453 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1454 if(
p
){

1455 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1456 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_METHOD
);

1457 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "none");

1458 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("none"));

1460 
p
 =Ö->
√xt
;

1461 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1462 if(
p
){

1463 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1464 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_DATA
);

1465 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[0], 1);

1466 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[1], 2);

1467 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 2);

1486 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1487 
	}
}

1489 
	$TEST_∑ckë_publish
()

1491 
uöt8_t
 
∑ylﬂd
[] = {0,

1492 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1,

1493 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 0x12, 0x45, 0x00, 0x00,

1494 
MQTT_PROP_TOPIC_ALIAS
, 0x00, 0x02,

1495 
MQTT_PROP_RESPONSE_TOPIC
, 0, 6, 'r', 'e', 's', 'p', 'o', 'n',

1496 
MQTT_PROP_CORRELATION_DATA
, 0x00, 0x02, 1, 2,

1497 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e',

1498 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0x04,

1499 
MQTT_PROP_CONTENT_TYPE
, 0, 5, 'e', 'm', 'p', 't', 'y'};

1501 
mosquôto__∑ckë
 
∑ckë
;

1502 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1503 
rc
;

1505 
∑ylﬂd
[0] = (payload)-1;

1507 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1508 
∑ckë
.
∑ylﬂd
 =Öayload;

1509 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1510 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
∑ckë
, &
¥›îtõs
);

1512 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1513 
p
 = 
¥›îtõs
;

1515 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1516 if(
p
){

1517 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1518 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
);

1519 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i8
, 1);

1521 
p
 =Ö->
√xt
;

1522 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1523 if(
p
){

1524 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1525 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
);

1526 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1528 
p
 =Ö->
√xt
;

1529 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1530 if(
p
){

1531 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1532 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_TOPIC_ALIAS
);

1533 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i16
, 0x0002);

1535 
p
 =Ö->
√xt
;

1536 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1537 if(
p
){

1538 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1539 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_RESPONSE_TOPIC
);

1540 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "respon");

1541 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("respon"));

1543 
p
 =Ö->
√xt
;

1544 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1545 if(
p
){

1546 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1547 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_CORRELATION_DATA
);

1548 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[0], 1);

1549 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[1], 2);

1550 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
Àn
, 2);

1552 
p
 =Ö->
√xt
;

1553 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1554 if(
p
){

1555 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1556 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1557 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1558 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1559 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1560 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1562 
p
 =Ö->
√xt
;

1563 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1564 if(
p
){

1565 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1566 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

1567 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
v¨öt
, 0x00000004);

1569 
p
 =Ö->
√xt
;

1570 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1571 if(
p
){

1572 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1573 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_CONTENT_TYPE
);

1574 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "empty");

1575 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("empty"));

1585 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1586 
	}
}

1588 
	$TEST_∑ckë_puback
()

1590 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_PUBACK
);

1591 
	}
}

1593 
	$TEST_∑ckë_pubªc
()

1595 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_PUBREC
);

1596 
	}
}

1598 
	$TEST_∑ckë_pubªl
()

1600 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_PUBREL
);

1601 
	}
}

1603 
	$TEST_∑ckë_pubcomp
()

1605 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_PUBCOMP
);

1606 
	}
}

1608 
	$TEST_∑ckë_subs¸ibe
()

1610 
uöt8_t
 
∑ylﬂd
[] = {0,

1611 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e',

1612 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0x04};

1614 
mosquôto__∑ckë
 
∑ckë
;

1615 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1616 
rc
;

1618 
∑ylﬂd
[0] = (payload)-1;

1620 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1621 
∑ckë
.
∑ylﬂd
 =Öayload;

1622 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1623 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_SUBSCRIBE
, &
∑ckë
, &
¥›îtõs
);

1625 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1626 
p
 = 
¥›îtõs
;

1628 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1629 if(
p
){

1630 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1631 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1632 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1633 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1634 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1635 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1637 
p
 =Ö->
√xt
;

1638 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1639 if(
p
){

1640 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1641 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
);

1642 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
v¨öt
, 0x00000004);

1646 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1647 
	}
}

1649 
	$TEST_∑ckë_suback
()

1651 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_SUBACK
);

1652 
	}
}

1654 
	$TEST_∑ckë_unsubs¸ibe
()

1656 
uöt8_t
 
∑ylﬂd
[] = {0,

1657 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e'};

1659 
mosquôto__∑ckë
 
∑ckë
;

1660 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1661 
rc
;

1663 
∑ylﬂd
[0] = (payload)-1;

1665 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1666 
∑ckë
.
∑ylﬂd
 =Öayload;

1667 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1668 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_UNSUBSCRIBE
, &
∑ckë
, &
¥›îtõs
);

1670 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1671 
p
 = 
¥›îtõs
;

1673 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1674 if(
p
){

1675 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1676 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1677 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1678 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1679 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1680 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1683 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1684 
	}
}

1686 
	$TEST_∑ckë_unsuback
()

1688 
	`∑ckë_hñ≥r_ªas⁄_°rög_u£r_¥›îty
(
CMD_UNSUBACK
);

1689 
	}
}

1691 
	$TEST_∑ckë_disc⁄√˘
()

1693 
uöt8_t
 
∑ylﬂd
[] = {0,

1694 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 0x12, 0x45, 0x00, 0x00,

1695 
MQTT_PROP_REASON_STRING
, 0, 6, 'r', 'e', 'a', 's', 'o', 'n',

1696 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e'};

1698 
mosquôto__∑ckë
 
∑ckë
;

1699 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1700 
rc
;

1702 
∑ylﬂd
[0] = (payload)-1;

1704 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1705 
∑ckë
.
∑ylﬂd
 =Öayload;

1706 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1707 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_DISCONNECT
, &
∑ckë
, &
¥›îtõs
);

1709 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1710 
p
 = 
¥›îtõs
;

1712 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1713 if(
p
){

1714 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1715 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
);

1716 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
i32
, 0x12450000);

1718 
p
 =Ö->
√xt
;

1719 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1720 if(
p
){

1721 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1722 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REASON_STRING
);

1723 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "reason");

1724 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("reason"));

1726 
p
 =Ö->
√xt
;

1727 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1728 if(
p
){

1729 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1730 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1731 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1732 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1733 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1734 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1739 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1740 
	}
}

1742 
	$TEST_∑ckë_auth
()

1744 
uöt8_t
 
∑ylﬂd
[] = {0,

1745 
MQTT_PROP_AUTHENTICATION_METHOD
, 0x00, 0x04, 'n', 'o', 'n', 'e',

1746 
MQTT_PROP_AUTHENTICATION_DATA
, 0x00, 0x02, 1, 2,

1747 
MQTT_PROP_REASON_STRING
, 0, 6, 'r', 'e', 'a', 's', 'o', 'n',

1748 
MQTT_PROP_USER_PROPERTY
, 0, 4, 'n', 'a', 'm', 'e', 0, 5, 'v', 'a', 'l', 'u', 'e'};

1750 
mosquôto__∑ckë
 
∑ckë
;

1751 
mosquôto_¥›îty
 *
¥›îtõs
, *
p
;

1752 
rc
;

1754 
∑ylﬂd
[0] = (payload)-1;

1756 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

1757 
∑ckë
.
∑ylﬂd
 =Öayload;

1758 
∑ckë
.
ªmaöög_Àngth
 = (
∑ylﬂd
);;

1759 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_AUTH
, &
∑ckë
, &
¥›îtõs
);

1761 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

1762 
p
 = 
¥›îtõs
;

1764 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1765 if(
p
){

1766 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1767 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_METHOD
);

1768 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "none");

1769 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("none"));

1771 
p
 =Ö->
√xt
;

1772 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1773 if(
p
){

1774 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1775 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_AUTHENTICATION_DATA
);

1776 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[0], 1);

1777 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
bö
.
v
[1], 2);

1778 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 2);

1780 
p
 =Ö->
√xt
;

1781 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1782 if(
p
){

1783 
	`CU_ASSERT_PTR_NOT_NULL
(
p
->
√xt
);

1784 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_REASON_STRING
);

1785 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "reason");

1786 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("reason"));

1788 
p
 =Ö->
√xt
;

1789 
	`CU_ASSERT_PTR_NOT_NULL
(
p
);

1790 if(
p
){

1791 
	`CU_ASSERT_PTR_NULL
(
p
->
√xt
);

1792 
	`CU_ASSERT_EQUAL
(
p
->
idítifõr
, 
MQTT_PROP_USER_PROPERTY
);

1793 
	`CU_ASSERT_STRING_EQUAL
(
p
->
vÆue
.
s
.
v
, "value");

1794 
	`CU_ASSERT_EQUAL
(
p
->
vÆue
.
s
.
Àn
, 
	`°æí
("value"));

1795 
	`CU_ASSERT_STRING_EQUAL
(
p
->
«me
.
v
, "name");

1796 
	`CU_ASSERT_EQUAL
(
p
->
«me
.
Àn
, 
	`°æí
("name"));

1802 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

1803 
	}
}

1810 
	$öô_¥›îty_ªad_ã°s
()

1812 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

1814 
ã°_suôe
 = 
	`CU_add_suôe
("Pr›îtyÑód", 
NULL
, NULL);

1815 if(!
ã°_suôe
){

1816 
	`¥ötf
("Errorádding CUnit PropertyÑeadÅest suite.\n");

1821 || !
	`CU_add_ã°
(
ã°_suôe
, "TrunˇãdÖackë", 
TEST_åunˇãd
)

1822 || !
	`CU_add_ã°
(
ã°_suôe
, "InvÆidÖr›îty ID", 
TEST_övÆid_¥›îty_id
)

1823 || !
	`CU_add_ã°
(
ã°_suôe
, "Nÿ¥›îtõs", 
TEST_no_¥›îtõs
)

1824 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Paylﬂd F‹m© Indiˇt‹", 
TEST_sögÀ_∑ylﬂd_f‹m©_ödiˇt‹
)

1825 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Reque° ProbÀm Inf‹m©i⁄", 
TEST_sögÀ_ªque°_¥obÀm_öf‹m©i⁄
)

1826 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Reque° Re•⁄£ Inf‹m©i⁄", 
TEST_sögÀ_ªque°_ª•⁄£_öf‹m©i⁄
)

1827 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Maximum QoS", 
TEST_sögÀ_maximum_qos
)

1828 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Rëaö AvaûabÀ", 
TEST_sögÀ_ªèö_avaûabÀ
)

1829 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Wûdˇrd Subs¸ùti⁄ AvaûabÀ", 
TEST_sögÀ_wûdˇrd_subs¸ùti⁄_avaûabÀ
)

1830 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Subs¸ùti⁄ Idítifõ∏AvaûabÀ", 
TEST_sögÀ_subs¸ùti⁄_idítifõr_avaûabÀ
)

1831 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sh¨ed Subs¸ùti⁄ AvaûabÀ", 
TEST_sögÀ_sh¨ed_subs¸ùti⁄_avaûabÀ
)

1832 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ MesßgêExpúy I¡îvÆ", 
TEST_sögÀ_mesßge_expúy_öãrvÆ
)

1833 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sessi⁄ Expúy I¡îvÆ", 
TEST_sögÀ_£ssi⁄_expúy_öãrvÆ
)

1834 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Wû»Dñay I¡îvÆ", 
TEST_sögÀ_wûl_dñay_öãrvÆ
)

1835 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Maximum Packë Size", 
TEST_sögÀ_maximum_∑ckë_size
)

1836 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sîvî Kì∞Alive", 
TEST_sögÀ_£rvî_kìp_Æive
)

1837 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re˚ivêMaximum", 
TEST_sögÀ_ª˚ive_maximum
)

1838 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ T›i¯Alü†Maximum", 
TEST_sögÀ_t›ic_Æüs_maximum
)

1839 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ T›i¯Alüs", 
TEST_sögÀ_t›ic_Æüs
)

1840 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ C⁄ã¡ Ty≥", 
TEST_sögÀ_c⁄ã¡_ty≥
)

1841 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re•⁄£ T›ic", 
TEST_sögÀ_ª•⁄£_t›ic
)

1842 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Assig√d Clõ¡ Idítifõr", 
TEST_sögÀ_assig√d_˛õ¡_idítifõr
)

1843 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Authítiˇti⁄ Mëhod", 
TEST_sögÀ_authítiˇti⁄_mëhod
)

1844 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re•⁄£ Inf‹m©i⁄", 
TEST_sögÀ_ª•⁄£_öf‹m©i⁄
)

1845 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sîvî Re„ªn˚", 
TEST_sögÀ_£rvî_ª„ªn˚
)

1846 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Rós⁄ Såög", 
TEST_sögÀ_ªas⁄_°rög
)

1847 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ C‹ªœti⁄ D©a", 
TEST_sögÀ_c‹ªœti⁄_d©a
)

1848 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Authítiˇti⁄ D©a", 
TEST_sögÀ_authítiˇti⁄_d©a
)

1849 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ U£∏Pr›îty", 
TEST_sögÀ_u£r_¥›îty
)

1850 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Subs¸ùti⁄ Idítifõr", 
TEST_sögÀ_subs¸ùti⁄_idítifõr
)

1851 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Paylﬂd F‹m© Indiˇt‹", 
TEST_du∂iˇã_∑ylﬂd_f‹m©_ödiˇt‹
)

1852 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Reque° ProbÀm Inf‹m©i⁄", 
TEST_du∂iˇã_ªque°_¥obÀm_öf‹m©i⁄
)

1853 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Reque° Re•⁄£ Inf‹m©i⁄", 
TEST_du∂iˇã_ªque°_ª•⁄£_öf‹m©i⁄
)

1854 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Maximum QoS", 
TEST_du∂iˇã_maximum_qos
)

1855 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Rëaö AvaûabÀ", 
TEST_du∂iˇã_ªèö_avaûabÀ
)

1856 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Wûdˇrd Subs¸ùti⁄ AvaûabÀ", 
TEST_du∂iˇã_wûdˇrd_subs¸ùti⁄_avaûabÀ
)

1857 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Subs¸ùti⁄ Idítifõ∏AvaûabÀ", 
TEST_du∂iˇã_subs¸ùti⁄_idítifõr_avaûabÀ
)

1858 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Sh¨ed Subs¸ùti⁄ AvaûabÀ", 
TEST_du∂iˇã_sh¨ed_subs¸ùti⁄_avaûabÀ
)

1859 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã MesßgêExpúy I¡îvÆ", 
TEST_du∂iˇã_mesßge_expúy_öãrvÆ
)

1860 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Sessi⁄ Expúy I¡îvÆ", 
TEST_du∂iˇã_£ssi⁄_expúy_öãrvÆ
)

1861 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Wû»Dñay I¡îvÆ", 
TEST_du∂iˇã_wûl_dñay_öãrvÆ
)

1862 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Maximum Packë Size", 
TEST_du∂iˇã_maximum_∑ckë_size
)

1863 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Sîvî Kì∞Alive", 
TEST_du∂iˇã_£rvî_kìp_Æive
)

1864 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Re˚ivêMaximum", 
TEST_du∂iˇã_ª˚ive_maximum
)

1865 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã T›i¯Alü†Maximum", 
TEST_du∂iˇã_t›ic_Æüs_maximum
)

1866 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã T›i¯Alüs", 
TEST_du∂iˇã_t›ic_Æüs
)

1867 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã C⁄ã¡ Ty≥", 
TEST_du∂iˇã_c⁄ã¡_ty≥
)

1868 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Re•⁄£ T›ic", 
TEST_du∂iˇã_ª•⁄£_t›ic
)

1869 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Assig√d Clõ¡ ID", 
TEST_du∂iˇã_assig√d_˛õ¡_idítifõr
)

1870 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Authítiˇti⁄ Mëhod", 
TEST_du∂iˇã_authítiˇti⁄_mëhod
)

1871 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Re•⁄£ Inf‹m©i⁄", 
TEST_du∂iˇã_ª•⁄£_öf‹m©i⁄
)

1872 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Sîvî Re„ªn˚", 
TEST_du∂iˇã_£rvî_ª„ªn˚
)

1873 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Rós⁄ Såög", 
TEST_du∂iˇã_ªas⁄_°rög
)

1874 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã C‹ªœti⁄ D©a", 
TEST_du∂iˇã_c‹ªœti⁄_d©a
)

1875 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Authítiˇti⁄ D©a", 
TEST_du∂iˇã_authítiˇti⁄_d©a
)

1876 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã U£∏Pr›îty", 
TEST_du∂iˇã_u£r_¥›îty
)

1877 || !
	`CU_add_ã°
(
ã°_suôe
, "Du∂iˇã Subs¸ùti⁄ Idítifõr", 
TEST_du∂iˇã_subs¸ùti⁄_idítifõr
)

1878 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Reque° ProbÀm Inf‹m©i⁄", 
TEST_bad_ªque°_¥obÀm_öf‹m©i⁄
)

1879 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Reque° Re•⁄£ Inf‹m©i⁄", 
TEST_bad_ªque°_ª•⁄£_öf‹m©i⁄
)

1880 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Maximum QoS", 
TEST_bad_maximum_qos
)

1881 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Rëaö AvaûabÀ", 
TEST_bad_ªèö_avaûabÀ
)

1882 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Wûdˇrd Subs¸ùti⁄ AvaûabÀ", 
TEST_bad_wûdˇrd_sub_avaûabÀ
)

1883 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Subs¸ùti⁄ Idítifõ∏AvaûabÀ", 
TEST_bad_subs¸ùti⁄_id_avaûabÀ
)

1884 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Sh¨ed Subs¸ùti⁄ AvaûabÀ", 
TEST_bad_sh¨ed_sub_avaûabÀ
)

1885 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Maximum Packë Size", 
TEST_bad_maximum_∑ckë_size
)

1886 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Re˚ivêMaximum", 
TEST_bad_ª˚ive_maximum
)

1887 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad T›i¯Alüs", 
TEST_bad_t›ic_Æüs
)

1888 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad C⁄ã¡ Ty≥", 
TEST_bad_c⁄ã¡_ty≥
)

1889 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad Subs¸ùti⁄ Idítifõr", 
TEST_bad_subs¸ùti⁄_idítifõr
)

1890 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë CONNECT", 
TEST_∑ckë_c⁄√˘
)

1891 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë CONNACK", 
TEST_∑ckë_c⁄«ck
)

1892 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë PUBLISH", 
TEST_∑ckë_publish
)

1893 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë PUBACK", 
TEST_∑ckë_puback
)

1894 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë PUBREC", 
TEST_∑ckë_pubªc
)

1895 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë PUBREL", 
TEST_∑ckë_pubªl
)

1896 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë PUBCOMP", 
TEST_∑ckë_pubcomp
)

1897 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë SUBSCRIBE", 
TEST_∑ckë_subs¸ibe
)

1898 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë SUBACK", 
TEST_∑ckë_suback
)

1899 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë UNSUBSCRIBE", 
TEST_∑ckë_unsubs¸ibe
)

1900 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë UNSUBACK", 
TEST_∑ckë_unsuback
)

1901 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë DISCONNECT", 
TEST_∑ckë_disc⁄√˘
)

1902 || !
	`CU_add_ã°
(
ã°_suôe
, "Packë AUTH", 
TEST_∑ckë_auth
)

1905 
	`¥ötf
("Errorádding PropertyÑead CUnitÅests.\n");

1910 
	}
}

	@test/unit/property_user_read.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"mqâ_¥Ÿocﬁ.h
"

5 
	~"¥›îty_mosq.h
"

6 
	~"∑ckë_mosq.h
"

8 
	$gíî©e_fuŒ_¥›li°
(
mosquôto_¥›îty
 **
¥›li°
)

10 
rc
;

14 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

15 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

16 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

17 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 3600);

18 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

19 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

20 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_CONTENT_TYPE
, "application/json");

21 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

22 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

23 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

24 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

25 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

26 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(
¥›li°
, 
MQTT_PROP_CORRELATION_DATA
, "c‹ªœti⁄-d©a", 
	`°æí
("correlation-data"));

27 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

28 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

29 
rc
 = 
	`mosquôto_¥›îty_add_v¨öt
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 63);

30 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

31 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

32 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 86400);

33 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

34 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

35 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "mosquitto-test");

36 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

37 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

38 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 180);

39 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

40 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

41 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

42 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

43 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

44 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

45 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

46 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

47 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

48 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

49 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

50 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 1800);

51 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

52 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

53 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

54 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

55 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

56 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_RESPONSE_INFORMATION
, "response");

57 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

58 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

59 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_SERVER_REFERENCE
, "localhost");

60 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

61 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

62 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_REASON_STRING
, "reason");

63 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

64 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

65 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

66 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

67 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

68 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

69 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

70 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

71 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS
, 15);

72 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

73 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

74 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_MAXIMUM_QOS
, 0);

75 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

76 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

77 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

78 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

79 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

80 
rc
 = 
	`mosquôto_¥›îty_add_°rög_∑ú
(
¥›li°
, 
MQTT_PROP_USER_PROPERTY
, "user-agent", "mosquitto/test");

81 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

82 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

83 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

84 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

85 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

86 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

87 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

88 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

89 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

90 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

91 if(
rc
 !
MOSQ_ERR_SUCCESS
) ;

92 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0);

93 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

94 
	}
}

96 
	$gíî©e_∑πül_¥›li°
(
mosquôto_¥›îty
 **
¥›li°
)

98 
rc
;

101 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 3600);

102 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

104 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

105 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

109 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "mosquitto-test");

110 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

112 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

113 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

114 
rc
 = 
	`mosquôto_¥›îty_add_bö¨y
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

115 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

116 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

117 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

118 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 1800);

119 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

120 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

121 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

122 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_RESPONSE_INFORMATION
, "response");

123 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

124 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_SERVER_REFERENCE
, "localhost");

125 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

126 
rc
 = 
	`mosquôto_¥›îty_add_°rög
(
¥›li°
, 
MQTT_PROP_REASON_STRING
, "reason");

127 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

128 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

129 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

130 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

131 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

132 
rc
 = 
	`mosquôto_¥›îty_add_öt16
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS
, 15);

133 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

134 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_MAXIMUM_QOS
, 0);

135 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

136 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

137 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

139 
rc
 = 
	`mosquôto_¥›îty_add_öt32
(
¥›li°
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

140 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

141 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

142 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

143 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

144 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

145 
rc
 = 
	`mosquôto_¥›îty_add_byã
(
¥›li°
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0);

146 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

147 
	}
}

153 
	$ªad_byã_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt8_t
 
ex≥˘ed_vÆue
)

155 c⁄° 
mosquôto_¥›îty
 *
¥›
;

156 
uöt8_t
 
vÆue
;

158 
¥›
 = 
	`mosquôto_¥›îty_ªad_byã
(
¥›li°
, 
idítifõr
, &
vÆue
, 
Ál£
);

159 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

160 
	`CU_ASSERT_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

161 
	}
}

163 
	$ªad_öt16_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt16_t
 
ex≥˘ed_vÆue
)

165 c⁄° 
mosquôto_¥›îty
 *
¥›
;

166 
uöt16_t
 
vÆue
;

168 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt16
(
¥›li°
, 
idítifõr
, &
vÆue
, 
Ál£
);

169 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

170 
	`CU_ASSERT_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

171 
	}
}

173 
	$ªad_öt32_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt32_t
 
ex≥˘ed_vÆue
)

175 c⁄° 
mosquôto_¥›îty
 *
¥›
;

176 
uöt32_t
 
vÆue
;

178 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt32
(
¥›li°
, 
idítifõr
, &
vÆue
, 
Ál£
);

179 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

180 
	`CU_ASSERT_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

181 
	}
}

183 
	$ªad_v¨öt_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, 
uöt32_t
 
ex≥˘ed_vÆue
)

185 c⁄° 
mosquôto_¥›îty
 *
¥›
;

186 
uöt32_t
 
vÆue
;

188 
¥›
 = 
	`mosquôto_¥›îty_ªad_v¨öt
(
¥›li°
, 
idítifõr
, &
vÆue
, 
Ál£
);

189 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

190 
	`CU_ASSERT_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

191 
	}
}

193 
	$ªad_bö¨y_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, *
ex≥˘ed_vÆue
, 
ex≥˘ed_Àngth
)

195 c⁄° 
mosquôto_¥›îty
 *
¥›
;

196 *
vÆue
 = 
NULL
;

197 
uöt16_t
 
Àngth
;

199 
¥›
 = 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›li°
, 
idítifõr
, &
vÆue
, &
Àngth
, 
Ál£
);

200 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

201 
	`CU_ASSERT_EQUAL
(
Àngth
, 
ex≥˘ed_Àngth
);

202 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

203 if(
vÆue
){

204 
	`CU_ASSERT_NSTRING_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
, 
ex≥˘ed_Àngth
);

206 
	`‰ì
(
vÆue
);

207 
	}
}

209 
	$ªad_°rög_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, *
ex≥˘ed_vÆue
)

211 c⁄° 
mosquôto_¥›îty
 *
¥›
;

212 *
vÆue
 = 
NULL
;

214 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög
(
¥›li°
, 
idítifõr
, &
vÆue
, 
Ál£
);

215 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

216 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

217 if(
vÆue
){

218 
	`CU_ASSERT_STRING_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

220 
	`‰ì
(
vÆue
);

221 
	}
}

223 
	$ªad_°rög_∑ú_hñ≥r
(c⁄° 
mosquôto_¥›îty
 *
¥›li°
, 
idítifõr
, *
ex≥˘ed_key
, *
ex≥˘ed_vÆue
)

225 c⁄° 
mosquôto_¥›îty
 *
¥›
;

226 *
key
 = 
NULL
, *
vÆue
 = NULL;

228 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög_∑ú
(
¥›li°
, 
idítifõr
, &
key
, &
vÆue
, 
Ál£
);

229 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

231 
	`CU_ASSERT_PTR_NOT_NULL
(
key
);

232 if(
key
){

233 
	`CU_ASSERT_STRING_EQUAL
(
key
, 
ex≥˘ed_key
);

236 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

237 if(
vÆue
){

238 
	`CU_ASSERT_STRING_EQUAL
(
vÆue
, 
ex≥˘ed_vÆue
);

240 
	`‰ì
(
key
);

241 
	`‰ì
(
vÆue
);

242 
	}
}

245 
	$TEST_ªad_sögÀ_byã
()

247 
rc
;

248 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

250 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

251 if(!
¥›li°
) ;

253 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

254 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

255 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

256 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_MAXIMUM_QOS
, 0);

257 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

258 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

259 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

260 
	`ªad_byã_hñ≥r
(
¥›li°
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0);

262 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

263 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

264 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

266 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

267 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

268 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

269 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_MAXIMUM_QOS
, 0);

270 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_RETAIN_AVAILABLE
, 0);

271 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

272 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

273 
	`ªad_byã_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 0);

275 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

276 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

277 
	}
}

279 
	$TEST_ªad_sögÀ_öt16
()

281 
rc
;

282 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

284 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

285 if(!
¥›li°
) ;

287 
	`ªad_öt16_hñ≥r
(
¥›li°
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 180);

288 
	`ªad_öt16_hñ≥r
(
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

289 
	`ªad_öt16_hñ≥r
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

290 
	`ªad_öt16_hñ≥r
(
¥›li°
, 
MQTT_PROP_TOPIC_ALIAS
, 15);

292 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

293 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

294 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

296 
	`ªad_öt16_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 180);

297 
	`ªad_öt16_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 1024);

298 
	`ªad_öt16_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 64);

299 
	`ªad_öt16_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_TOPIC_ALIAS
, 15);

301 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

302 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

303 
	}
}

305 
	$TEST_ªad_sögÀ_öt32
()

307 
rc
;

308 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

310 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

311 if(!
¥›li°
) ;

313 
	`ªad_öt32_hñ≥r
(
¥›li°
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 3600);

314 
	`ªad_öt32_hñ≥r
(
¥›li°
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 86400);

315 
	`ªad_öt32_hñ≥r
(
¥›li°
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 1800);

316 
	`ªad_öt32_hñ≥r
(
¥›li°
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

318 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

319 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

320 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

322 
	`ªad_öt32_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 3600);

323 
	`ªad_öt32_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 86400);

324 
	`ªad_öt32_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 1800);

325 
	`ªad_öt32_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 200000000);

327 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

328 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

329 
	}
}

331 
	$TEST_ªad_sögÀ_v¨öt
()

333 
rc
;

334 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

336 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

337 if(!
¥›li°
) ;

339 
	`ªad_v¨öt_hñ≥r
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 63);

341 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

342 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

343 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

345 
	`ªad_v¨öt_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 63);

347 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

348 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

349 
	}
}

351 
	$TEST_ªad_sögÀ_bö¨y
()

353 
rc
;

354 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

356 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

357 if(!
¥›li°
) ;

359 
	`ªad_bö¨y_hñ≥r
(
¥›li°
, 
MQTT_PROP_CORRELATION_DATA
, "c‹ªœti⁄-d©a", 
	`°æí
("correlation-data"));

360 
	`ªad_bö¨y_hñ≥r
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

362 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

363 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

364 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

366 if(
¥›li°_c›y
){

367 
	`ªad_bö¨y_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_CORRELATION_DATA
, "c‹ªœti⁄-d©a", 
	`°æí
("correlation-data"));

368 
	`ªad_bö¨y_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_AUTHENTICATION_DATA
, "∑ssw‹d", 
	`°æí
("password"));

371 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

372 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

373 
	}
}

375 
	$TEST_ªad_sögÀ_°rög
()

377 
rc
;

378 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

380 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

381 if(!
¥›li°
) ;

383 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_CONTENT_TYPE
, "application/json");

384 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

385 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "mosquitto-test");

386 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

387 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_RESPONSE_INFORMATION
, "response");

388 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_SERVER_REFERENCE
, "localhost");

389 
	`ªad_°rög_hñ≥r
(
¥›li°
, 
MQTT_PROP_REASON_STRING
, "reason");

391 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

392 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

393 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

395 if(
¥›li°_c›y
){

396 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_CONTENT_TYPE
, "application/json");

397 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_RESPONSE_TOPIC
, "response/topic");

398 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "mosquitto-test");

399 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "basic");

400 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_RESPONSE_INFORMATION
, "response");

401 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_SERVER_REFERENCE
, "localhost");

402 
	`ªad_°rög_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_REASON_STRING
, "reason");

405 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

406 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

407 
	}
}

409 
	$TEST_ªad_sögÀ_°rög_∑ú
()

411 
rc
;

412 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

414 
	`gíî©e_fuŒ_¥›li°
(&
¥›li°
);

415 if(!
¥›li°
) ;

417 
	`ªad_°rög_∑ú_hñ≥r
(
¥›li°
, 
MQTT_PROP_USER_PROPERTY
, "user-agent", "mosquitto/test");

419 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

420 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

421 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

423 if(
¥›li°_c›y
){

424 
	`ªad_°rög_∑ú_hñ≥r
(
¥›li°_c›y
, 
MQTT_PROP_USER_PROPERTY
, "user-agent", "mosquitto/test");

427 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

428 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

429 
	}
}

435 
	$missög_ªad_hñ≥r
(
mosquôto_¥›îty
 *
¥›li°
)

437 c⁄° 
mosquôto_¥›îty
 *
¥›
;

438 
uöt8_t
 
byã_vÆue
;

439 
uöt16_t
 
öt16_vÆue
;

440 
uöt32_t
 
öt32_vÆue
;

441 *
key
, *
vÆue
;

442 
uöt16_t
 
Àngth
;

445 
¥›
 = 
	`mosquôto_¥›îty_ªad_byã
(
¥›li°
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, &
byã_vÆue
, 
Ál£
);

446 
	`CU_ASSERT_PTR_NULL
(
¥›
);

449 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt32
(
¥›li°
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, &
öt32_vÆue
, 
Ál£
);

450 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

451 
	`CU_ASSERT_EQUAL
(
öt32_vÆue
, 1800);

454 
vÆue
 = 
NULL
;

455 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög
(
¥›li°
, 
MQTT_PROP_CONTENT_TYPE
, &
vÆue
, 
Ál£
);

456 
	`CU_ASSERT_PTR_NULL
(
¥›
);

459 
vÆue
 = 
NULL
;

460 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög
(
¥›li°
, 
MQTT_PROP_RESPONSE_TOPIC
, &
vÆue
, 
Ál£
);

461 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

462 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

463 if(
vÆue
){

464 
	`CU_ASSERT_STRING_EQUAL
(
vÆue
, "response/topic");

465 
	`‰ì
(
vÆue
);

469 
¥›
 = 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›li°
, 
MQTT_PROP_CORRELATION_DATA
, (**)&
vÆue
, &
Àngth
, 
Ál£
);

470 
	`CU_ASSERT_PTR_NULL
(
¥›
);

473 
¥›
 = 
	`mosquôto_¥›îty_ªad_byã
(
¥›li°
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, &
byã_vÆue
, 
Ál£
);

474 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

475 
	`CU_ASSERT_EQUAL
(
byã_vÆue
, 1);

478 
¥›
 = 
	`mosquôto_¥›îty_ªad_v¨öt
(
¥›li°
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, &
öt32_vÆue
, 
Ál£
);

479 
	`CU_ASSERT_PTR_NULL
(
¥›
);

482 
vÆue
 = 
NULL
;

483 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög
(
¥›li°
, 
MQTT_PROP_SERVER_REFERENCE
, &
vÆue
, 
Ál£
);

484 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

485 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

486 if(
vÆue
){

487 
	`CU_ASSERT_STRING_EQUAL
(
vÆue
, "localhost");

488 
	`‰ì
(
vÆue
);

492 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt32
(
¥›li°
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, &
öt32_vÆue
, 
Ál£
);

493 
	`CU_ASSERT_PTR_NULL
(
¥›
);

496 
vÆue
 = 
NULL
;

497 
¥›
 = 
	`mosquôto_¥›îty_ªad_bö¨y
(
¥›li°
, 
MQTT_PROP_AUTHENTICATION_DATA
, (**)&
vÆue
, &
Àngth
, 
Ál£
);

498 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

499 
	`CU_ASSERT_PTR_NOT_NULL
(
vÆue
);

500 if(
vÆue
){

501 
	`CU_ASSERT_NSTRING_EQUAL
(
vÆue
, "∑ssw‹d", 
	`°æí
("password"));

502 
	`CU_ASSERT_EQUAL
(
Àngth
, 
	`°æí
("password"));

503 
	`‰ì
(
vÆue
);

507 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt16
(
¥›li°
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, &
öt16_vÆue
, 
Ál£
);

508 
	`CU_ASSERT_PTR_NULL
(
¥›
);

511 
¥›
 = 
	`mosquôto_¥›îty_ªad_öt16
(
¥›li°
, 
MQTT_PROP_RECEIVE_MAXIMUM
, &
öt16_vÆue
, 
Ál£
);

512 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›
);

513 
	`CU_ASSERT_EQUAL
(
öt16_vÆue
, 1024);

516 
¥›
 = 
	`mosquôto_¥›îty_ªad_°rög_∑ú
(
¥›li°
, 
MQTT_PROP_USER_PROPERTY
, &
key
, &
vÆue
, 
Ál£
);

517 
	`CU_ASSERT_PTR_NULL
(
¥›
);

518 
	}
}

521 
	$TEST_ªad_missög
()

523 
mosquôto_¥›îty
 *
¥›li°
 = 
NULL
, *
¥›li°_c›y
 = NULL;

524 
rc
;

526 
	`gíî©e_∑πül_¥›li°
(&
¥›li°
);

527 if(!
¥›li°
) ;

529 
	`missög_ªad_hñ≥r
(
¥›li°
);

530 
rc
 = 
	`mosquôto_¥›îty_c›y_Æl
(&
¥›li°_c›y
, 
¥›li°
);

531 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

532 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›li°_c›y
);

533 if(
¥›li°_c›y
){

534 
	`missög_ªad_hñ≥r
(
¥›li°_c›y
);

537 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°
);

538 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›li°_c›y
);

539 
	}
}

545 
	$°rög_to_¥›îty_öfo_hñ≥r
(c⁄° *
°r
, 
rc_ex≥˘ed
, 
idítifõr_ex≥˘ed
, 
ty≥_ex≥˘ed
)

547 
rc
;

548 
idítifõr
, 
ty≥
;

550 
rc
 = 
	`mosquôto_°rög_to_¥›îty_öfo
(
°r
, &
idítifõr
, &
ty≥
);

551 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

552 if(
rc
 =
MOSQ_ERR_SUCCESS
){

553 
	`CU_ASSERT_EQUAL
(
idítifõr
, 
idítifõr_ex≥˘ed
);

554 
	`CU_ASSERT_EQUAL
(
ty≥
, 
ty≥_ex≥˘ed
);

556 
	}
}

558 
	$TEST_°rög_to_¥›îty_öfo
()

560 
	`°rög_to_¥›îty_öfo_hñ≥r
("∑ylﬂd-f‹m©-ödiˇt‹", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 
MQTT_PROP_TYPE_BYTE
);

561 
	`°rög_to_¥›îty_öfo_hñ≥r
("mesßge-expúy-öãrvÆ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 
MQTT_PROP_TYPE_INT32
);

562 
	`°rög_to_¥›îty_öfo_hñ≥r
("c⁄ã¡-ty≥", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CONTENT_TYPE
, 
MQTT_PROP_TYPE_STRING
);

563 
	`°rög_to_¥›îty_öfo_hñ≥r
("ª•⁄£-t›ic", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_TOPIC
, 
MQTT_PROP_TYPE_STRING
);

564 
	`°rög_to_¥›îty_öfo_hñ≥r
("c‹ªœti⁄-d©a", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CORRELATION_DATA
, 
MQTT_PROP_TYPE_BINARY
);

565 
	`°rög_to_¥›îty_öfo_hñ≥r
("subs¸ùti⁄-idítifõr", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 
MQTT_PROP_TYPE_VARINT
);

566 
	`°rög_to_¥›îty_öfo_hñ≥r
("£ssi⁄-expúy-öãrvÆ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 
MQTT_PROP_TYPE_INT32
);

567 
	`°rög_to_¥›îty_öfo_hñ≥r
("assig√d-˛õ¡-idítifõr", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, 
MQTT_PROP_TYPE_STRING
);

568 
	`°rög_to_¥›îty_öfo_hñ≥r
("£rvî-kìp-Æive", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 
MQTT_PROP_TYPE_INT16
);

569 
	`°rög_to_¥›îty_öfo_hñ≥r
("authítiˇti⁄-mëhod", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_METHOD
, 
MQTT_PROP_TYPE_STRING
);

570 
	`°rög_to_¥›îty_öfo_hñ≥r
("authítiˇti⁄-d©a", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_DATA
, 
MQTT_PROP_TYPE_BINARY
);

571 
	`°rög_to_¥›îty_öfo_hñ≥r
("ªque°-¥obÀm-öf‹m©i⁄", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 
MQTT_PROP_TYPE_BYTE
);

572 
	`°rög_to_¥›îty_öfo_hñ≥r
("wûl-dñay-öãrvÆ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 
MQTT_PROP_TYPE_INT32
);

573 
	`°rög_to_¥›îty_öfo_hñ≥r
("ªque°-ª•⁄£-öf‹m©i⁄", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 
MQTT_PROP_TYPE_BYTE
);

574 
	`°rög_to_¥›îty_öfo_hñ≥r
("ª•⁄£-öf‹m©i⁄", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_INFORMATION
, 
MQTT_PROP_TYPE_STRING
);

575 
	`°rög_to_¥›îty_öfo_hñ≥r
("£rvî-ª„ªn˚", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_REFERENCE
, 
MQTT_PROP_TYPE_STRING
);

576 
	`°rög_to_¥›îty_öfo_hñ≥r
("ªas⁄-°rög", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REASON_STRING
, 
MQTT_PROP_TYPE_STRING
);

577 
	`°rög_to_¥›îty_öfo_hñ≥r
("ª˚ive-maximum", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 
MQTT_PROP_TYPE_INT16
);

578 
	`°rög_to_¥›îty_öfo_hñ≥r
("t›ic-Æüs-maximum", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 
MQTT_PROP_TYPE_INT16
);

579 
	`°rög_to_¥›îty_öfo_hñ≥r
("t›ic-Æüs", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS
, 
MQTT_PROP_TYPE_INT16
);

580 
	`°rög_to_¥›îty_öfo_hñ≥r
("maximum-qos", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_QOS
, 
MQTT_PROP_TYPE_BYTE
);

581 
	`°rög_to_¥›îty_öfo_hñ≥r
("ªèö-avaûabÀ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RETAIN_AVAILABLE
, 
MQTT_PROP_TYPE_BYTE
);

582 
	`°rög_to_¥›îty_öfo_hñ≥r
("u£r-¥›îty", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_USER_PROPERTY
, 
MQTT_PROP_TYPE_STRING_PAIR
);

583 
	`°rög_to_¥›îty_öfo_hñ≥r
("maximum-∑ckë-size", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 
MQTT_PROP_TYPE_INT32
);

584 
	`°rög_to_¥›îty_öfo_hñ≥r
("wûdˇrd-subs¸ùti⁄-avaûabÀ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 
MQTT_PROP_TYPE_BYTE
);

585 
	`°rög_to_¥›îty_öfo_hñ≥r
("subs¸ùti⁄-idítifõr-avaûabÀ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 
MQTT_PROP_TYPE_BYTE
);

586 
	`°rög_to_¥›îty_öfo_hñ≥r
("sh¨ed-subs¸ùti⁄-avaûabÀ", 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 
MQTT_PROP_TYPE_BYTE
);

588 
	`°rög_to_¥›îty_öfo_hñ≥r
("∑ylﬂd-f‹m©-ödiˇt‹1", 
MOSQ_ERR_INVAL
, 0, 0);

589 
	`°rög_to_¥›îty_öfo_hñ≥r
("∑ylﬂd", 
MOSQ_ERR_INVAL
, 0, 0);

590 
	`°rög_to_¥›îty_öfo_hñ≥r
("", 
MOSQ_ERR_INVAL
, 0, 0);

591 
	`°rög_to_¥›îty_öfo_hñ≥r
(
NULL
, 
MOSQ_ERR_INVAL
, 0, 0);

592 
	}
}

599 
	$öô_¥›îty_u£r_ªad_ã°s
()

601 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

603 
ã°_suôe
 = 
	`CU_add_suôe
("Pr›îty u£∏ªad", 
NULL
, NULL);

604 if(!
ã°_suôe
){

605 
	`¥ötf
("Errorádding CUnit Property userÑeadÅest suite.\n");

610 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ byã", 
TEST_ªad_sögÀ_byã
)

611 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ i¡16", 
TEST_ªad_sögÀ_öt16
)

612 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ i¡32", 
TEST_ªad_sögÀ_öt32
)

613 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ v¨öt", 
TEST_ªad_sögÀ_v¨öt
)

614 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ bö¨y", 
TEST_ªad_sögÀ_bö¨y
)

615 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ såög", 
TEST_ªad_sögÀ_°rög
)

616 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród sögÀ såögÖaú", 
TEST_ªad_sögÀ_°rög_∑ú
)

617 || !
	`CU_add_ã°
(
ã°_suôe
, "Ród missög", 
TEST_ªad_missög
)

618 || !
	`CU_add_ã°
(
ã°_suôe
, "SåögÅÿ¥›îty info", 
TEST_°rög_to_¥›îty_öfo
)

621 
	`¥ötf
("Errorádding Property Add CUnitÅests.\n");

626 
	}
}

	@test/unit/property_write.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"mqâ_¥Ÿocﬁ.h
"

5 
	~"¥›îty_mosq.h
"

6 
	~"∑ckë_mosq.h
"

8 
	$byã_¥›_wrôe_hñ≥r
(

9 
comm™d
,

10 
ªmaöög_Àngth
,

11 
rc_ex≥˘ed
,

12 
idítifõr
,

13 
uöt8_t
 
vÆue_ex≥˘ed
)

15 
mosquôto_¥›îty
 
¥›îty
;

16 
mosquôto__∑ckë
 
∑ckë
;

17 
mosquôto_¥›îty
 *
¥›îtõs
;

18 
rc
;

20 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

22 
¥›îty
.
idítifõr
 = identifier;

23 
¥›îty
.
vÆue
.
i8
 = 
vÆue_ex≥˘ed
;

25 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

26 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

27 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

28 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

30 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

31 if(!
∑ckë
.
∑ylﬂd
) ;

33 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

34 
∑ckë
.
pos
 = 0;

36 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

38 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

39 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

40 if(
¥›îtõs
){

41 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

42 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i8
, 
vÆue_ex≥˘ed
);

43 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

44 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 2);

45 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

47 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

48 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

49 
	}
}

52 
	$öt32_¥›_wrôe_hñ≥r
(

53 
comm™d
,

54 
ªmaöög_Àngth
,

55 
rc_ex≥˘ed
,

56 
idítifõr
,

57 
uöt32_t
 
vÆue_ex≥˘ed
)

59 
mosquôto_¥›îty
 
¥›îty
;

60 
mosquôto__∑ckë
 
∑ckë
;

61 
mosquôto_¥›îty
 *
¥›îtõs
;

62 
rc
;

64 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

66 
¥›îty
.
idítifõr
 = identifier;

67 
¥›îty
.
vÆue
.
i32
 = 
vÆue_ex≥˘ed
;

69 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

70 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

71 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

72 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

74 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

75 if(!
∑ckë
.
∑ylﬂd
) ;

77 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

78 
∑ckë
.
pos
 = 0;

80 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

82 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

83 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

84 if(
¥›îtõs
){

85 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

86 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i32
, 
vÆue_ex≥˘ed
);

87 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

88 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 5);

89 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

91 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

92 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

93 
	}
}

96 
	$öt16_¥›_wrôe_hñ≥r
(

97 
comm™d
,

98 
ªmaöög_Àngth
,

99 
rc_ex≥˘ed
,

100 
idítifõr
,

101 
uöt16_t
 
vÆue_ex≥˘ed
)

103 
mosquôto_¥›îty
 
¥›îty
;

104 
mosquôto__∑ckë
 
∑ckë
;

105 
mosquôto_¥›îty
 *
¥›îtõs
;

106 
rc
;

108 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

110 
¥›îty
.
idítifõr
 = identifier;

111 
¥›îty
.
vÆue
.
i16
 = 
vÆue_ex≥˘ed
;

113 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

114 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

115 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

116 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

118 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

119 if(!
∑ckë
.
∑ylﬂd
) ;

121 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

122 
∑ckë
.
pos
 = 0;

124 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

126 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

127 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

128 if(
¥›îtõs
){

129 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

130 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
i16
, 
vÆue_ex≥˘ed
);

131 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

132 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 3);

133 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

135 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

136 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

137 
	}
}

139 
	$°rög_¥›_wrôe_hñ≥r
(

140 
comm™d
,

141 
ªmaöög_Àngth
,

142 
rc_ex≥˘ed
,

143 
idítifõr
,

144 c⁄° *
vÆue_ex≥˘ed
)

146 
mosquôto_¥›îty
 
¥›îty
;

147 
mosquôto__∑ckë
 
∑ckë
;

148 
mosquôto_¥›îty
 *
¥›îtõs
;

149 
rc
;

151 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

153 
¥›îty
.
idítifõr
 = identifier;

154 
¥›îty
.
vÆue
.
s
.
v
 = 
	`°rdup
(
vÆue_ex≥˘ed
);

155 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îty
.
vÆue
.
s
.
v
);

156 if(!
¥›îty
.
vÆue
.
s
.
v
) ;

158 
¥›îty
.
vÆue
.
s
.
Àn
 = 
	`°æí
(
vÆue_ex≥˘ed
);

160 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

161 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

162 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

163 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

165 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

166 if(!
∑ckë
.
∑ylﬂd
) ;

168 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

169 
∑ckë
.
pos
 = 0;

171 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

173 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

174 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

175 if(
¥›îtõs
){

176 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

177 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
Àn
, 
	`°æí
(
vÆue_ex≥˘ed
));

178 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
v
, 
vÆue_ex≥˘ed
);

179 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

180 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
	`°æí
(
vÆue_ex≥˘ed
));

181 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

183 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

184 
	`‰ì
(
¥›îty
.
vÆue
.
s
.
v
);

185 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

186 
	}
}

189 
	$bö¨y_¥›_wrôe_hñ≥r
(

190 
comm™d
,

191 
ªmaöög_Àngth
,

192 
rc_ex≥˘ed
,

193 
idítifõr
,

194 c⁄° 
uöt8_t
 *
vÆue_ex≥˘ed
,

195 
Àn_ex≥˘ed
)

197 
mosquôto_¥›îty
 
¥›îty
;

198 
mosquôto__∑ckë
 
∑ckë
;

199 
mosquôto_¥›îty
 *
¥›îtõs
;

200 
rc
;

202 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

204 
¥›îty
.
idítifõr
 = identifier;

205 
¥›îty
.
vÆue
.
bö
.
v
 = 
	`mÆloc
(
Àn_ex≥˘ed
);

206 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îty
.
vÆue
.
bö
.
v
);

207 if(!
¥›îty
.
vÆue
.
bö
.
v
) ;

209 
	`mem˝y
(
¥›îty
.
vÆue
.
bö
.
v
, 
vÆue_ex≥˘ed
, 
Àn_ex≥˘ed
);

210 
¥›îty
.
vÆue
.
bö
.
Àn
 = 
Àn_ex≥˘ed
;

212 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

213 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

214 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

215 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

217 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

218 if(!
∑ckë
.
∑ylﬂd
) ;

220 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

221 
∑ckë
.
pos
 = 0;

223 
rc
 = 
	`¥›îty__ªad_Æl
(
comm™d
, &
∑ckë
, &
¥›îtõs
);

225 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

226 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

227 if(
¥›îtõs
){

228 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

229 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
bö
.
Àn
, 
Àn_ex≥˘ed
);

230 
	`CU_ASSERT_EQUAL
(
	`memcmp
(
¥›îtõs
->
vÆue
.
bö
.
v
, 
vÆue_ex≥˘ed
, 
Àn_ex≥˘ed
), 0);

231 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
->
√xt
, 
NULL
);

232 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
Àn_ex≥˘ed
);

233 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

235 
	`CU_ASSERT_PTR_EQUAL
(
¥›îtõs
, 
NULL
);

236 
	`‰ì
(
¥›îty
.
vÆue
.
bö
.
v
);

237 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

238 
	}
}

240 
	$°rög_∑ú_¥›_wrôe_hñ≥r
(

241 
ªmaöög_Àngth
,

242 
rc_ex≥˘ed
,

243 
idítifõr
,

244 c⁄° *
«me_ex≥˘ed
,

245 c⁄° *
vÆue_ex≥˘ed
,

246 
boﬁ
 
ex≥˘_mu…ùÀ
)

248 
mosquôto_¥›îty
 
¥›îty
;

249 
mosquôto__∑ckë
 
∑ckë
;

250 
mosquôto_¥›îty
 *
¥›îtõs
;

251 
rc
;

253 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

255 
¥›îty
.
idítifõr
 = identifier;

256 
¥›îty
.
vÆue
.
s
.
v
 = 
	`°rdup
(
vÆue_ex≥˘ed
);

257 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îty
.
vÆue
.
s
.
v
);

258 if(!
¥›îty
.
vÆue
.
s
.
v
) ;

259 
¥›îty
.
vÆue
.
s
.
Àn
 = 
	`°æí
(
vÆue_ex≥˘ed
);

261 
¥›îty
.
«me
.
v
 = 
	`°rdup
(
«me_ex≥˘ed
);

262 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îty
.
«me
.
v
);

263 if(!
¥›îty
.
«me
.
v
) ;

265 
¥›îty
.
«me
.
Àn
 = 
	`°æí
(
«me_ex≥˘ed
);

267 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

268 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

269 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

270 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

272 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

273 if(!
∑ckë
.
∑ylﬂd
) ;

275 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

276 
∑ckë
.
pos
 = 0;

278 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_CONNECT
, &
∑ckë
, &
¥›îtõs
);

280 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

281 
	`CU_ASSERT_EQUAL
(
∑ckë
.
pos
, 
ªmaöög_Àngth
);

282 if(
¥›îtõs
){

283 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

284 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
«me
.
Àn
, 
	`°æí
(
«me_ex≥˘ed
));

285 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
Àn
, 
	`°æí
(
vÆue_ex≥˘ed
));

286 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
«me
.
v
, 
«me_ex≥˘ed
);

287 
	`CU_ASSERT_STRING_EQUAL
(
¥›îtõs
->
vÆue
.
s
.
v
, 
vÆue_ex≥˘ed
);

288 if(
ex≥˘_mu…ùÀ
){

289 
	`CU_ASSERT_PTR_NOT_NULL
(
¥›îtõs
->
√xt
);

291 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
->
√xt
);

292 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 1+2+
	`°æí
(
«me_ex≥˘ed
)+2+°æí(
vÆue_ex≥˘ed
));

294 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

296 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
);

297 
	`‰ì
(
¥›îty
.
vÆue
.
s
.
v
);

298 
	`‰ì
(
¥›îty
.
«me
.
v
);

299 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

300 
	}
}

302 
	$v¨öt_¥›_wrôe_hñ≥r
(

303 
ªmaöög_Àngth
,

304 
rc_ex≥˘ed
,

305 
idítifõr
,

306 
uöt32_t
 
vÆue_ex≥˘ed
)

308 
mosquôto_¥›îty
 
¥›îty
;

309 
mosquôto__∑ckë
 
∑ckë
;

310 
mosquôto_¥›îty
 *
¥›îtõs
;

311 
rc
;

313 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

315 
¥›îty
.
idítifõr
 = identifier;

316 
¥›îty
.
vÆue
.
v¨öt
 = 
vÆue_ex≥˘ed
;

318 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

319 
∑ckë
.
ªmaöög_Àngth
 = 
	`¥›îty__gë_Àngth_Æl
(&
¥›îty
)+1;

320 
∑ckë
.
∑ckë_Àngth
 =Öackë.
ªmaöög_Àngth
+10;

321 
∑ckë
.
∑ylﬂd
 = 
	`ˇŒoc
’ackë.
ªmaöög_Àngth
+10, 1);

323 
	`CU_ASSERT_PTR_NOT_NULL
(
∑ckë
.
∑ylﬂd
);

324 if(!
∑ckë
.
∑ylﬂd
) ;

326 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

327 
∑ckë
.
pos
 = 0;

329 
rc
 = 
	`¥›îty__ªad_Æl
(
CMD_PUBLISH
, &
∑ckë
, &
¥›îtõs
);

331 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

332 if(
¥›îtõs
){

333 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
idítifõr
, identifier);

334 
	`CU_ASSERT_EQUAL
(
¥›îtõs
->
vÆue
.
v¨öt
, 
vÆue_ex≥˘ed
);

335 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
->
√xt
);

336 if(
vÆue_ex≥˘ed
 < 128){

337 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 2);

338 }if(
vÆue_ex≥˘ed
 < 16384){

339 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 3);

340 }if(
vÆue_ex≥˘ed
 < 2097152){

341 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 4);

342 }if(
vÆue_ex≥˘ed
 < 268435456){

343 
	`CU_ASSERT_EQUAL
(
	`¥›îty__gë_Àngth_Æl
(
¥›îtõs
), 5);

345 
	`CU_FAIL
("Incorrect varint value.");

347 
	`mosquôto_¥›îty_‰ì_Æl
(&
¥›îtõs
);

349 
	`CU_ASSERT_PTR_NULL
(
¥›îtõs
);

350 
	`‰ì
(
∑ckë
.
∑ylﬂd
);

351 
	}
}

357 
	$TEST_bad_idítifõr
()

359 
mosquôto_¥›îty
 
¥›îty
;

360 
mosquôto__∑ckë
 
∑ckë
;

361 
uöt8_t
 
∑ylﬂd
[10];

362 
rc
;

364 
	`mem£t
(&
¥›îty
, 0, (
mosquôto_¥›îty
));

365 
	`mem£t
(&
∑ckë
, 0, (
mosquôto__∑ckë
));

366 
¥›îty
.
idítifõr
 = 0xFFFF;

367 
∑ckë
.
∑ckë_Àngth
 = 10;

368 
∑ckë
.
ªmaöög_Àngth
 = 8;

369 
∑ckë
.
∑ylﬂd
 =Öayload;

370 
rc
 = 
	`¥›îty__wrôe_Æl
(&
∑ckë
, &
¥›îty
, 
åue
);

371 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

372 
	}
}

379 
	$TEST_sögÀ_∑ylﬂd_f‹m©_ödiˇt‹
()

381 
	`byã_¥›_wrôe_hñ≥r
(
CMD_PUBLISH
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_PAYLOAD_FORMAT_INDICATOR
, 1);

382 
	}
}

384 
	$TEST_sögÀ_ªque°_¥obÀm_öf‹m©i⁄
()

386 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_PROBLEM_INFORMATION
, 1);

387 
	}
}

389 
	$TEST_sögÀ_ªque°_ª•⁄£_öf‹m©i⁄
()

391 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REQUEST_RESPONSE_INFORMATION
, 1);

392 
	}
}

394 
	$TEST_sögÀ_maximum_qos
()

396 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_QOS
, 1);

397 
	}
}

399 
	$TEST_sögÀ_ªèö_avaûabÀ
()

401 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RETAIN_AVAILABLE
, 1);

402 
	}
}

404 
	$TEST_sögÀ_wûdˇrd_subs¸ùti⁄_avaûabÀ
()

406 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILDCARD_SUB_AVAILABLE
, 0);

407 
	}
}

409 
	$TEST_sögÀ_subs¸ùti⁄_idítifõr_avaûabÀ
()

411 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_ID_AVAILABLE
, 0);

412 
	}
}

414 
	$TEST_sögÀ_sh¨ed_subs¸ùti⁄_avaûabÀ
()

416 
	`byã_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SHARED_SUB_AVAILABLE
, 1);

417 
	}
}

419 
	$TEST_sögÀ_mesßge_expúy_öãrvÆ
()

421 
	`öt32_¥›_wrôe_hñ≥r
(
CMD_PUBLISH
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MESSAGE_EXPIRY_INTERVAL
, 0x12233445);

422 
	}
}

424 
	$TEST_sögÀ_£ssi⁄_expúy_öãrvÆ
()

426 
	`öt32_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SESSION_EXPIRY_INTERVAL
, 0x45342312);

427 
	}
}

429 
	$TEST_sögÀ_wûl_dñay_öãrvÆ
()

431 
	`öt32_¥›_wrôe_hñ≥r
(
CMD_WILL
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_WILL_DELAY_INTERVAL
, 0x45342312);

432 
	}
}

434 
	$TEST_sögÀ_maximum_∑ckë_size
()

436 
	`öt32_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_MAXIMUM_PACKET_SIZE
, 0x45342312);

437 
	}
}

439 
	$TEST_sögÀ_£rvî_kìp_Æive
()

441 
	`öt16_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_KEEP_ALIVE
, 0x4534);

442 
	}
}

444 
	$TEST_sögÀ_ª˚ive_maximum
()

446 
	`öt16_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RECEIVE_MAXIMUM
, 0x6842);

447 
	}
}

449 
	$TEST_sögÀ_t›ic_Æüs_maximum
()

451 
	`öt16_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS_MAXIMUM
, 0x6842);

452 
	}
}

454 
	$TEST_sögÀ_t›ic_Æüs
()

456 
	`öt16_¥›_wrôe_hñ≥r
(
CMD_PUBLISH
, 4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_TOPIC_ALIAS
, 0x6842);

457 
	}
}

459 
	$TEST_sögÀ_c⁄ã¡_ty≥
()

461 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_PUBLISH
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CONTENT_TYPE
, "hello");

462 
	}
}

464 
	$TEST_sögÀ_ª•⁄£_t›ic
()

466 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_WILL
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_TOPIC
, "hello");

467 
	}
}

469 
	$TEST_sögÀ_assig√d_˛õ¡_idítifõr
()

471 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_ASSIGNED_CLIENT_IDENTIFIER
, "hello");

472 
	}
}

474 
	$TEST_sögÀ_authítiˇti⁄_mëhod
()

476 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_METHOD
, "hello");

477 
	}
}

479 
	$TEST_sögÀ_ª•⁄£_öf‹m©i⁄
()

481 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_RESPONSE_INFORMATION
, "hello");

482 
	}
}

484 
	$TEST_sögÀ_£rvî_ª„ªn˚
()

486 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_CONNACK
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SERVER_REFERENCE
, "hello");

487 
	}
}

489 
	$TEST_sögÀ_ªas⁄_°rög
()

491 
	`°rög_¥›_wrôe_hñ≥r
(
CMD_PUBREC
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_REASON_STRING
, "hello");

492 
	}
}

494 
	$TEST_sögÀ_c‹ªœti⁄_d©a
()

496 
uöt8_t
 
∑ylﬂd
[5] = {1, 'e', 0, 'l', 9};

498 
	`bö¨y_¥›_wrôe_hñ≥r
(
CMD_PUBLISH
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_CORRELATION_DATA
, 
∑ylﬂd
, 5);

499 
	}
}

501 
	$TEST_sögÀ_authítiˇti⁄_d©a
()

503 
uöt8_t
 
∑ylﬂd
[5] = {1, 'e', 0, 'l', 9};

505 
	`bö¨y_¥›_wrôe_hñ≥r
(
CMD_CONNECT
, 9, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_AUTHENTICATION_DATA
, 
∑ylﬂd
, 5);

506 
	}
}

508 
	$TEST_sögÀ_u£r_¥›îty
()

510 
	`°rög_∑ú_¥›_wrôe_hñ≥r
(10, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_USER_PROPERTY
, "za", "bc", 
Ál£
);

511 
	}
}

513 
	$TEST_sögÀ_subs¸ùti⁄_idítifõr
()

515 
	`v¨öt_¥›_wrôe_hñ≥r
(3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 0);

516 
	`v¨öt_¥›_wrôe_hñ≥r
(3, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 127);

517 
	`v¨öt_¥›_wrôe_hñ≥r
(4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 128);

518 
	`v¨öt_¥›_wrôe_hñ≥r
(4, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 16383);

519 
	`v¨öt_¥›_wrôe_hñ≥r
(5, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 16384);

520 
	`v¨öt_¥›_wrôe_hñ≥r
(5, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 2097151);

521 
	`v¨öt_¥›_wrôe_hñ≥r
(6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 2097152);

522 
	`v¨öt_¥›_wrôe_hñ≥r
(6, 
MOSQ_ERR_SUCCESS
, 
MQTT_PROP_SUBSCRIPTION_IDENTIFIER
, 268435455);

523 
	}
}

530 
	$öô_¥›îty_wrôe_ã°s
()

532 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

534 
ã°_suôe
 = 
	`CU_add_suôe
("Pr›îty wrôe", 
NULL
, NULL);

535 if(!
ã°_suôe
){

536 
	`¥ötf
("Errorádding CUnit Property writeÅest suite.\n");

541 || !
	`CU_add_ã°
(
ã°_suôe
, "Bad idítifõr", 
TEST_bad_idítifõr
)

542 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Paylﬂd F‹m© Indiˇt‹", 
TEST_sögÀ_∑ylﬂd_f‹m©_ödiˇt‹
)

543 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Reque° ProbÀm Inf‹m©i⁄", 
TEST_sögÀ_ªque°_¥obÀm_öf‹m©i⁄
)

544 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Reque° Re•⁄£ Inf‹m©i⁄", 
TEST_sögÀ_ªque°_ª•⁄£_öf‹m©i⁄
)

545 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Maximum QoS", 
TEST_sögÀ_maximum_qos
)

546 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Rëaö AvaûabÀ", 
TEST_sögÀ_ªèö_avaûabÀ
)

547 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Wûdˇrd Subs¸ùti⁄ AvaûabÀ", 
TEST_sögÀ_wûdˇrd_subs¸ùti⁄_avaûabÀ
)

548 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Subs¸ùti⁄ Idítifõ∏AvaûabÀ", 
TEST_sögÀ_subs¸ùti⁄_idítifõr_avaûabÀ
)

549 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sh¨ed Subs¸ùti⁄ AvaûabÀ", 
TEST_sögÀ_sh¨ed_subs¸ùti⁄_avaûabÀ
)

550 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ MesßgêExpúy I¡îvÆ", 
TEST_sögÀ_mesßge_expúy_öãrvÆ
)

551 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sessi⁄ Expúy I¡îvÆ", 
TEST_sögÀ_£ssi⁄_expúy_öãrvÆ
)

552 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Wû»Dñay I¡îvÆ", 
TEST_sögÀ_wûl_dñay_öãrvÆ
)

553 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Maximum Packë Size", 
TEST_sögÀ_maximum_∑ckë_size
)

554 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sîvî Kì∞Alive", 
TEST_sögÀ_£rvî_kìp_Æive
)

555 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re˚ivêMaximum", 
TEST_sögÀ_ª˚ive_maximum
)

556 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ T›i¯Alü†Maximum", 
TEST_sögÀ_t›ic_Æüs_maximum
)

557 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ T›i¯Alüs", 
TEST_sögÀ_t›ic_Æüs
)

558 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ C⁄ã¡ Ty≥", 
TEST_sögÀ_c⁄ã¡_ty≥
)

559 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re•⁄£ T›ic", 
TEST_sögÀ_ª•⁄£_t›ic
)

560 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Assig√d Clõ¡ Idítifõr", 
TEST_sögÀ_assig√d_˛õ¡_idítifõr
)

561 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Authítiˇti⁄ Mëhod", 
TEST_sögÀ_authítiˇti⁄_mëhod
)

562 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Re•⁄£ Inf‹m©i⁄", 
TEST_sögÀ_ª•⁄£_öf‹m©i⁄
)

563 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Sîvî Re„ªn˚", 
TEST_sögÀ_£rvî_ª„ªn˚
)

564 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Rós⁄ Såög", 
TEST_sögÀ_ªas⁄_°rög
)

565 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ C‹ªœti⁄ D©a", 
TEST_sögÀ_c‹ªœti⁄_d©a
)

566 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Authítiˇti⁄ D©a", 
TEST_sögÀ_authítiˇti⁄_d©a
)

567 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ U£∏Pr›îty", 
TEST_sögÀ_u£r_¥›îty
)

568 || !
	`CU_add_ã°
(
ã°_suôe
, "SögÀ Subs¸ùti⁄ Idítifõr", 
TEST_sögÀ_subs¸ùti⁄_idítifõr
)

571 
	`¥ötf
("Errorádding PropertyÑead CUnitÅests.\n");

576 
	}
}

	@test/unit/publish_test.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~<mosquôto_öã∫Æ.h
>

5 
	~<utû_mosq.h
>

8 
	$TEST_maximum_∑ckë_size
()

10 
mosquôto
 
mosq
;

11 
rc
;

13 
	`mem£t
(&
mosq
, 0, (
mosquôto
));

15 
mosq
.
maximum_∑ckë_size
 = 5;

16 
rc
 = 
	`mosquôto_publish
(&
mosq
, 
NULL
, "t›ic/ovîsize", 
	`°æí
("payload"), "payload", 0, 0);

17 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_OVERSIZE_PACKET
);

18 
	}
}

24 
	$öô_publish_ã°s
()

26 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

28 
ã°_suôe
 = 
	`CU_add_suôe
("Publish", 
NULL
, NULL);

29 if(!
ã°_suôe
){

30 
	`¥ötf
("Errorádding CUnit PublishÅest suite.\n");

35 || !
	`CU_add_ã°
(
ã°_suôe
, "v5: MaximumÖackë size", 
TEST_maximum_∑ckë_size
)

38 
	`¥ötf
("Errorádding Publish CUnitÅests.\n");

43 
	}
}

	@test/unit/stubs.c

1 
	~<loggög_mosq.h
>

3 
	$log__¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

6 
	}
}

	@test/unit/test.c

1 
	~"c⁄fig.h
"

2 
	~<°dio.h
>

4 
	~<CUnô/CUnô.h
>

5 
	~<CUnô/Basic.h
>

7 
öô_d©©y≥_ªad_ã°s
();

8 
öô_d©©y≥_wrôe_ã°s
();

9 
öô_¥›îty_add_ã°s
();

10 
öô_¥›îty_ªad_ã°s
();

11 
öô_¥›îty_u£r_ªad_ã°s
();

12 
öô_¥›îty_wrôe_ã°s
();

13 
öô_utf8_ã°s
();

14 
öô_utû_t›ic_ã°s
();

16 
	$maö
(
¨gc
, *
¨gv
[])

18 
Áûs
;

20 if(
	`CU_öôülize_ªgi°ry
(Ë!
CUE_SUCCESS
){

21 
	`¥ötf
("Error initializing CUnitÑegistry.\n");

26 || 
	`öô_utf8_ã°s
()

27 || 
	`öô_d©©y≥_ªad_ã°s
()

28 || 
	`öô_d©©y≥_wrôe_ã°s
()

29 || 
	`öô_¥›îty_add_ã°s
()

30 || 
	`öô_¥›îty_ªad_ã°s
()

31 || 
	`öô_¥›îty_u£r_ªad_ã°s
()

32 || 
	`öô_¥›îty_wrôe_ã°s
()

33 || 
	`öô_utû_t›ic_ã°s
()

36 
	`CU_˛ónup_ªgi°ry
();

40 
	`CU_basic_£t_mode
(
CU_BRM_VERBOSE
);

41 
	`CU_basic_run_ã°s
();

42 
Áûs
 = 
	`CU_gë_numbî_of_Áûuªs
();

43 
	`CU_˛ónup_ªgi°ry
();

45  ()
Áûs
;

46 
	}
}

	@test/unit/utf8.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~"mosquôto.h
"

10 
	$utf8_hñ≥r_Àn
(c⁄° *
ãxt
, 
Àn
, 
ex≥˘ed
)

12 
ªsu…
;

14 
ªsu…
 = 
	`mosquôto_vÆid©e_utf8
(
ãxt
, 
Àn
);

15 
	`CU_ASSERT_EQUAL
(
ªsu…
, 
ex≥˘ed
);

16 
	}
}

18 
	$utf8_hñ≥r
(c⁄° *
ãxt
, 
ex≥˘ed
)

20 
	`utf8_hñ≥r_Àn
(
ãxt
, 
	`°æí
—ext), 
ex≥˘ed
);

21 
	}
}

24 
	$TEST_utf8_em±y
()

26 
	`utf8_hñ≥r_Àn
(
NULL
, 0, 
MOSQ_ERR_INVAL
);

27 
	}
}

30 
	$TEST_utf8_vÆid
()

33 
	`utf8_hñ≥r
("", 
MOSQ_ERR_SUCCESS
);

34 
	`utf8_hñ≥r
("You should sìÅhêGªek w‹d 'kosme': \"Œ∫·ΩπœÉŒºŒµ\"", 
MOSQ_ERR_SUCCESS
);

35 
	}
}

38 
	$TEST_utf8_åunˇãd
()

40 
buf
[4];

43 
buf
[0] = 0xC2; buf[1] = 0;

44 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

46 
buf
[0] = 0xE0; buf[1] = 0xA0; buf[2] = 0;

47 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

49 
buf
[0] = 0xF0; buf[1] = 0x90; buf[2] = 0x80; buf[3] = 0;

50 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

51 
	}
}

54 
	$TEST_utf8_bound¨y_c⁄dôi⁄s
()

58 
	`utf8_hñ≥r_Àn
("2.1.1 1 byã (U-00000000): \"\0\"", 39, 
MOSQ_ERR_MALFORMED_UTF8
);

59 
	`utf8_hñ≥r
("2.1.2 2 byã†(U-00000080): \"¬Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

60 
	`utf8_hñ≥r
("2.1.3 3 byã†(U-00000800): \"‡†Ä\"", 
MOSQ_ERR_SUCCESS
);

61 
	`utf8_hñ≥r
("2.1.4 4 byã†(U-00010000): \"êÄÄ\"", 
MOSQ_ERR_SUCCESS
);

65 
	`utf8_hñ≥r
("2.2.1 1 byã (U-0000007F): \"\"", 
MOSQ_ERR_MALFORMED_UTF8
);

66 
	`utf8_hñ≥r
("2.2.2 2 byã†(U-000007FF): \"ﬂø\"", 
MOSQ_ERR_SUCCESS
);

68 
	`utf8_hñ≥r
("2.2.3 3 byã†(U-0000FFFF): \"Ôøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

70 
	`utf8_hñ≥r
("2.2.4 4 byã†(U-0010FFFF): \"˜øøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

74 
	`utf8_hñ≥r
("2.3.1 U-0000D7FF =Éd 9‡b‡\"Ìüø\"", 
MOSQ_ERR_SUCCESS
);

75 
	`utf8_hñ≥r
("2.3.2 U-0000E000 =Éê80 80 = \"ÓÄÄ\"", 
MOSQ_ERR_SUCCESS
);

76 
	`utf8_hñ≥r
("2.3.3 U-0000FFFD =É‡b‡bd = \"ÔøΩ\"", 
MOSQ_ERR_SUCCESS
);

78 
	`utf8_hñ≥r
("2.3.4 U-0010FFFF = f4 8‡b‡b‡\"Ùèøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

80 
	`utf8_hñ≥r
("2.3.5 U-00110000 = f4 90 80 80 = \"ÙêÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

81 
	}
}

84 
	$TEST_utf8_mÆf‹med_£quí˚s
()

86 
buf
[100];

87 
i
;

90 
	`utf8_hñ≥r
("3.1.1 Fú° c⁄töu©i⁄ byã 0x80: \"Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

91 
	`utf8_hñ≥r
("3.1.2 La° c⁄töu©i⁄ byã 0xbf: \"ø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

92 
	`utf8_hñ≥r
("3.1.3 2 c⁄töu©i⁄ byãs: \"Äø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

93 
	`utf8_hñ≥r
("3.1.4 3 c⁄töu©i⁄ byãs: \"ÄøÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

94 
	`utf8_hñ≥r
("3.1.5 4 c⁄töu©i⁄ byãs: \"ÄøÄø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

95 
	`utf8_hñ≥r
("3.1.6 5 c⁄töu©i⁄ byãs: \"ÄøÄøÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

96 
	`utf8_hñ≥r
("3.1.7 6 c⁄töu©i⁄ byãs: \"ÄøÄøÄø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

97 
	`utf8_hñ≥r
("3.1.8 7 c⁄töu©i⁄ byãs: \"ÄøÄøÄøÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

100 
	`mem£t
(
buf
, 0, (buf));

101 
i
=0x80; i<0x90; i++){

102 
buf
[
i
-0x80] = i;

104 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

105 
	`mem£t
(
buf
, 0, (buf));

106 
i
=0x90; i<0xa0; i++){

107 
buf
[
i
-0x90] = i;

109 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

111 
i
=0x80; i<0xA0; i++){

112 
buf
[0] = 
i
;

113 
buf
[1] = 0;

114 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

117 
i
=0xA0; i<0xC0; i++){

118 
buf
[0] = 
i
;

119 
buf
[1] = 0;

120 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

127 
	`utf8_hñ≥r
("¿ ¡ ¬ √ ƒ ≈ ∆ « » …   À Ã Õ Œ œ – — “ ” ‘ ’ ÷ ◊ ÿ Ÿ ⁄ € ‹ › ﬁ ﬂ ", 
MOSQ_ERR_MALFORMED_UTF8
);

128 
i
=0xC0; i<0xE0; i++){

129 
buf
[0] = 
i
;

130 
buf
[1] = ' ';

131 
buf
[2] = 0;

132 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

137 
	`utf8_hñ≥r
("\"‡ · ‚ „ ‰ Â Ê Á Ë È Í Î Ï Ì Ó Ô \"", 
MOSQ_ERR_MALFORMED_UTF8
);

138 
i
=0xe0; i<0xf0; i++){

139 
buf
[0] = 
i
;

140 
buf
[1] = ' ';

141 
buf
[2] = 0;

142 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

147 
	`utf8_hñ≥r
("\" Ò Ú Û Ù ı ˆ ˜ \"", 
MOSQ_ERR_MALFORMED_UTF8
);

148 
i
=0xF0; i<0xF8; i++){

149 
buf
[0] = 
i
;

150 
buf
[1] = ' ';

151 
buf
[2] = 0;

152 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

157 
	`utf8_hñ≥r
("\"¯ ˘ ˙ ˚ \"", 
MOSQ_ERR_MALFORMED_UTF8
);

158 
i
=0xF8; i<0xFC; i++){

159 
buf
[0] = 
i
;

160 
buf
[1] = ' ';

161 
buf
[2] = 0;

162 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

167 
	`utf8_hñ≥r
("\"¸ ˝ \"", 
MOSQ_ERR_MALFORMED_UTF8
);

168 
	`utf8_hñ≥r
("¸ ", 
MOSQ_ERR_MALFORMED_UTF8
);

169 
	`utf8_hñ≥r
("˝ ", 
MOSQ_ERR_MALFORMED_UTF8
);

170 
i
=0xFC; i<0xFE; i++){

171 
buf
[0] = 
i
;

172 
buf
[1] = ' ';

173 
buf
[2] = 0;

174 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

183 
	`utf8_hñ≥r
("3.3.1 2-byã sequí˚ wôhÜa° byã missög (U+0000): \"¿\"", 
MOSQ_ERR_MALFORMED_UTF8
);

184 
	`utf8_hñ≥r
("3.3.2 3-byã sequí˚ wôhÜa° byã missög (U+0000): \"‡Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

185 
	`utf8_hñ≥r
("3.3.3 4-byã sequí˚ wôhÜa° byã missög (U+0000): \"ÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

186 
	`utf8_hñ≥r
("3.3.4 5-byã sequí˚ wôhÜa° byã missög (U+0000): \"¯ÄÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

187 
	`utf8_hñ≥r
("3.3.5 6-byã sequí˚ wôhÜa° byã missög (U+0000): \"¸ÄÄÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

188 
	`utf8_hñ≥r
("3.3.6 2-byã sequí˚ wôhÜa° byã missög (U-000007FF): \"ﬂ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

189 
	`utf8_hñ≥r
("3.3.7 3-byã sequí˚ wôhÜa° byã missög (U-0000FFFF): \"Ôø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

190 
	`utf8_hñ≥r
("3.3.8 4-byã sequí˚ wôhÜa° byã missög (U-001FFFFF): \"˜øø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

191 
	`utf8_hñ≥r
("3.3.9 5-byã sequí˚ wôhÜa° byã missög (U-03FFFFFF): \"˚øøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

192 
	`utf8_hñ≥r
("3.3.10 6-byã sequí˚ wôhÜa° byã missög (U-7FFFFFFF): \"˝øøøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

199 
	`utf8_hñ≥r
("\"¿‡ÄÄÄ¯ÄÄÄ¸ÄÄÄÄﬂÔø˜øø˚øøø˝øøøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

205 
	`utf8_hñ≥r
("3.5.1 fê\"˛\"", 
MOSQ_ERR_MALFORMED_UTF8
);

206 
	`utf8_hñ≥r
("3.5.2 f‡\"ˇ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

207 
	`utf8_hñ≥r
("3.5.3 fê„ f‡f‡\"˛˛ˇˇ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

208 
	}
}

210 
	$TEST_utf8_ovîl⁄g_ícodög
()

240 
	`utf8_hñ≥r
("4.1.1 U+002F = c0á‡ = \"¿Ø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

241 
	`utf8_hñ≥r
("4.1.2 U+002F =É0 80á‡ = \"‡ÄØ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

242 
	`utf8_hñ≥r
("4.1.3 U+002F = f0 80 80á‡ = \"ÄÄØ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

243 
	`utf8_hñ≥r
("4.1.4 U+002F = f8 80 80 80á‡ = \"¯ÄÄÄØ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

244 
	`utf8_hñ≥r
("4.1.5 U+002F = f¯80 80 80 80á‡\"¸ÄÄÄÄØ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

253 
	`utf8_hñ≥r
("4.2.1 U-0000007F = c1 b‡ = \"¡ø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

254 
	`utf8_hñ≥r
("4.2.2 U-000007FF =É0 9‡b‡ = \"‡üø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

255 
	`utf8_hñ≥r
("4.2.3 U-0000FFFF = f0 8‡b‡b‡ = \"èøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

256 
	`utf8_hñ≥r
("4.2.4 U-001FFFFF = f8 87 b‡b‡b‡ = \"¯áøøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

257 
	`utf8_hñ≥r
("4.2.5 U-03FFFFFF = f¯83 b‡b‡b‡b‡\"¸Éøøøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

265 
	`utf8_hñ≥r
("4.3.1 U+0000 = c0 80 = \"¿Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

266 
	`utf8_hñ≥r
("4.3.2 U+0000 =É0 80 80 = \"‡ÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

267 
	`utf8_hñ≥r
("4.3.3 U+0000 = f0 80 80 80 = \"ÄÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

268 
	`utf8_hñ≥r
("4.3.4 U+0000 = f8 80 80 80 80 = \"¯ÄÄÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

269 
	`utf8_hñ≥r
("4.3.5 U+0000 = f¯80 80 80 80 80 = \"¸ÄÄÄÄÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

270 
	}
}

273 
	$TEST_utf8_ûÀgÆ_code_posôi⁄s
()

284 
	`utf8_hñ≥r
("5.1.1 U+D800 =Édá0 80 = \"Ì†Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

285 
	`utf8_hñ≥r
("5.1.2 U+DB7F =Édád b‡\"Ì≠ø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

286 
	`utf8_hñ≥r
("5.1.3 U+DB80 =Édáê80 = \"ÌÆÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

287 
	`utf8_hñ≥r
("5.1.4 U+DBFF =Édá‡b‡\"ÌØø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

288 
	`utf8_hñ≥r
("5.1.5 U+DC00 =Éd b0 80 = \"Ì∞Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

289 
	`utf8_hñ≥r
("5.1.6 U+DF80 =Éd bê80 = \"ÌæÄ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

290 
	`utf8_hñ≥r
("5.1.7 U+DFFF =Éd b‡b‡\"Ìøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

294 
	`utf8_hñ≥r
("5.2.1 U+D800 U+DC00 =Édá0 80Éd b0 80 = \"Ì†ÄÌ∞Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

295 
	`utf8_hñ≥r
("5.2.2 U+D800 U+DFFF =Édá0 80Éd b‡b‡\"Ì†ÄÌøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

296 
	`utf8_hñ≥r
("5.2.3 U+DB7F U+DC00 =Édád b‡ed b0 80 = \"Ì≠øÌ∞Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

297 
	`utf8_hñ≥r
("5.2.4 U+DB7F U+DFFF =Édád b‡ed b‡b‡\"Ì≠øÌøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

298 
	`utf8_hñ≥r
("5.2.5 U+DB80 U+DC00 =Édáê80Éd b0 80 = \"ÌÆÄÌ∞Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

299 
	`utf8_hñ≥r
("5.2.6 U+DB80 U+DFFF =Édáê80Éd b‡b‡\"ÌÆÄÌøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

300 
	`utf8_hñ≥r
("5.2.7 U+DBFF U+DC00 =Édá‡b‡ed b0 80 = \"ÌØøÌ∞Ä\"", 
MOSQ_ERR_MALFORMED_UTF8
);

301 
	`utf8_hñ≥r
("5.2.8 U+DBFF U+DFFF =Édá‡b‡ed b‡b‡\"ÌØøÌøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

324 
	`utf8_hñ≥r
("5.3.1 U+FFFE =É‡b‡bê\"Ôøæ\"", 
MOSQ_ERR_MALFORMED_UTF8
);

325 
	`utf8_hñ≥r
("5.3.2 U+FFFF =É‡b‡b‡\"Ôøø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

330 
	`utf8_hñ≥r
("5.3.3 U+FDD0 .. U+FDEF = \"Ô∑êÔ∑ëÔ∑íÔ∑ìÔ∑îÔ∑ïÔ∑ñÔ∑óÔ∑òÔ∑ôÔ∑öÔ∑õÔ∑úÔ∑ùÔ∑ûÔ∑üÔ∑†Ô∑°Ô∑¢Ô∑£Ô∑§Ô∑•Ô∑¶Ô∑ßÔ∑®Ô∑©Ô∑™Ô∑´Ô∑¨Ô∑≠Ô∑ÆÔ∑Ø\"", 
MOSQ_ERR_MALFORMED_UTF8
);

331 
	`utf8_hñ≥r
("Ô∑ê", 
MOSQ_ERR_MALFORMED_UTF8
);

332 
	`utf8_hñ≥r
("Ô∑ë", 
MOSQ_ERR_MALFORMED_UTF8
);

333 
	`utf8_hñ≥r
("Ô∑í", 
MOSQ_ERR_MALFORMED_UTF8
);

334 
	`utf8_hñ≥r
("Ô∑ì", 
MOSQ_ERR_MALFORMED_UTF8
);

335 
	`utf8_hñ≥r
("Ô∑î", 
MOSQ_ERR_MALFORMED_UTF8
);

336 
	`utf8_hñ≥r
("Ô∑ï", 
MOSQ_ERR_MALFORMED_UTF8
);

337 
	`utf8_hñ≥r
("Ô∑ñ", 
MOSQ_ERR_MALFORMED_UTF8
);

338 
	`utf8_hñ≥r
("Ô∑ó", 
MOSQ_ERR_MALFORMED_UTF8
);

339 
	`utf8_hñ≥r
("Ô∑ò", 
MOSQ_ERR_MALFORMED_UTF8
);

340 
	`utf8_hñ≥r
("Ô∑ô", 
MOSQ_ERR_MALFORMED_UTF8
);

341 
	`utf8_hñ≥r
("Ô∑ö", 
MOSQ_ERR_MALFORMED_UTF8
);

342 
	`utf8_hñ≥r
("Ô∑õ", 
MOSQ_ERR_MALFORMED_UTF8
);

343 
	`utf8_hñ≥r
("Ô∑ú", 
MOSQ_ERR_MALFORMED_UTF8
);

344 
	`utf8_hñ≥r
("Ô∑ù", 
MOSQ_ERR_MALFORMED_UTF8
);

345 
	`utf8_hñ≥r
("Ô∑û", 
MOSQ_ERR_MALFORMED_UTF8
);

346 
	`utf8_hñ≥r
("Ô∑ü", 
MOSQ_ERR_MALFORMED_UTF8
);

347 
	`utf8_hñ≥r
("Ô∑†", 
MOSQ_ERR_MALFORMED_UTF8
);

348 
	`utf8_hñ≥r
("Ô∑°", 
MOSQ_ERR_MALFORMED_UTF8
);

349 
	`utf8_hñ≥r
("Ô∑¢", 
MOSQ_ERR_MALFORMED_UTF8
);

350 
	`utf8_hñ≥r
("Ô∑£", 
MOSQ_ERR_MALFORMED_UTF8
);

351 
	`utf8_hñ≥r
("Ô∑§", 
MOSQ_ERR_MALFORMED_UTF8
);

352 
	`utf8_hñ≥r
("Ô∑•", 
MOSQ_ERR_MALFORMED_UTF8
);

353 
	`utf8_hñ≥r
("Ô∑¶", 
MOSQ_ERR_MALFORMED_UTF8
);

354 
	`utf8_hñ≥r
("Ô∑ß", 
MOSQ_ERR_MALFORMED_UTF8
);

355 
	`utf8_hñ≥r
("Ô∑®", 
MOSQ_ERR_MALFORMED_UTF8
);

356 
	`utf8_hñ≥r
("Ô∑©", 
MOSQ_ERR_MALFORMED_UTF8
);

357 
	`utf8_hñ≥r
("Ô∑™", 
MOSQ_ERR_MALFORMED_UTF8
);

358 
	`utf8_hñ≥r
("Ô∑´", 
MOSQ_ERR_MALFORMED_UTF8
);

359 
	`utf8_hñ≥r
("Ô∑¨", 
MOSQ_ERR_MALFORMED_UTF8
);

360 
	`utf8_hñ≥r
("Ô∑≠", 
MOSQ_ERR_MALFORMED_UTF8
);

361 
	`utf8_hñ≥r
("Ô∑Æ", 
MOSQ_ERR_MALFORMED_UTF8
);

362 
	`utf8_hñ≥r
("Ô∑Ø", 
MOSQ_ERR_MALFORMED_UTF8
);

366 
	`utf8_hñ≥r
("üøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

367 
	`utf8_hñ≥r
("üøø", 
MOSQ_ERR_MALFORMED_UTF8
);

368 
	`utf8_hñ≥r
("Øøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

369 
	`utf8_hñ≥r
("Øøø", 
MOSQ_ERR_MALFORMED_UTF8
);

370 
	`utf8_hñ≥r
("øøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

371 
	`utf8_hñ≥r
("øøø", 
MOSQ_ERR_MALFORMED_UTF8
);

372 
	`utf8_hñ≥r
("Òèøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

373 
	`utf8_hñ≥r
("Òèøø", 
MOSQ_ERR_MALFORMED_UTF8
);

374 
	`utf8_hñ≥r
("Òüøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

375 
	`utf8_hñ≥r
("Òüøø", 
MOSQ_ERR_MALFORMED_UTF8
);

376 
	`utf8_hñ≥r
("ÒØøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

377 
	`utf8_hñ≥r
("ÒØøø", 
MOSQ_ERR_MALFORMED_UTF8
);

378 
	`utf8_hñ≥r
("Òøøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

379 
	`utf8_hñ≥r
("Òøøø", 
MOSQ_ERR_MALFORMED_UTF8
);

380 
	`utf8_hñ≥r
("Úèøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

381 
	`utf8_hñ≥r
("Úèøø", 
MOSQ_ERR_MALFORMED_UTF8
);

382 
	`utf8_hñ≥r
("Úüøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

383 
	`utf8_hñ≥r
("Úüøø", 
MOSQ_ERR_MALFORMED_UTF8
);

384 
	`utf8_hñ≥r
("ÚØøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

385 
	`utf8_hñ≥r
("ÚØøø", 
MOSQ_ERR_MALFORMED_UTF8
);

386 
	`utf8_hñ≥r
("Úøøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

387 
	`utf8_hñ≥r
("Úøøø", 
MOSQ_ERR_MALFORMED_UTF8
);

388 
	`utf8_hñ≥r
("Ûèøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

389 
	`utf8_hñ≥r
("Ûèøø", 
MOSQ_ERR_MALFORMED_UTF8
);

390 
	`utf8_hñ≥r
("Ûüøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

391 
	`utf8_hñ≥r
("Ûüøø", 
MOSQ_ERR_MALFORMED_UTF8
);

392 
	`utf8_hñ≥r
("ÛØøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

393 
	`utf8_hñ≥r
("ÛØøø", 
MOSQ_ERR_MALFORMED_UTF8
);

394 
	`utf8_hñ≥r
("Ûøøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

395 
	`utf8_hñ≥r
("Ûøøø", 
MOSQ_ERR_MALFORMED_UTF8
);

396 
	`utf8_hñ≥r
("Ùèøæ", 
MOSQ_ERR_MALFORMED_UTF8
);

397 
	`utf8_hñ≥r
("Ùèøø", 
MOSQ_ERR_MALFORMED_UTF8
);

398 
	}
}

401 
	$TEST_utf8_c⁄åﬁ_ch¨a˘îs
()

403 
buf
[10];

404 
i
;

407 
i
=0x01; i<0x20; i++){

408 
buf
[0] = 
i
;

409 
buf
[1] = '\0';

410 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

414 
buf
[0] = 0x7F;

415 
buf
[1] = '\0';

416 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

419 
i
=0x80; i<0xA0; i++){

420 
buf
[0] = 0xC2;

421 
buf
[1] = 
i
-0x80;

422 
buf
[2] = '\0';

423 
	`utf8_hñ≥r
(
buf
, 
MOSQ_ERR_MALFORMED_UTF8
);

426 
	}
}

429 
	$TEST_utf8_mqâ_1_5_4_2
()

431 
buf
[10] = {'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', '\0'};

433 
	`utf8_hñ≥r_Àn
(
buf
, 9, 
MOSQ_ERR_SUCCESS
);

435 
buf
[3] = '\0';

436 
	`utf8_hñ≥r_Àn
(
buf
, 9, 
MOSQ_ERR_MALFORMED_UTF8
);

437 
	}
}

440 
	$TEST_utf8_mqâ_1_5_4_3
()

442 
buf
[10] = {'a', 'b', 0xEF, 0xBB, 0xBF, 'f', 'g', 'h', 'i', '\0'};

444 
	`utf8_hñ≥r_Àn
(
buf
, 9, 
MOSQ_ERR_SUCCESS
);

445 
	}
}

452 
	$öô_utf8_ã°s
()

454 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

456 
ã°_suôe
 = 
	`CU_add_suôe
("UTF-8", 
NULL
, NULL);

457 if(!
ã°_suôe
){

458 
	`¥ötf
("Errorádding CUnitÅest suite.\n");

463 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8Ém±y", 
TEST_utf8_em±y
)

464 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 vÆid", 
TEST_utf8_vÆid
)

465 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8Årunˇãd", 
TEST_utf8_åunˇãd
)

466 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 bound¨y c⁄dôi⁄s", 
TEST_utf8_bound¨y_c⁄dôi⁄s
)

467 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 mÆf‹med sequí˚s", 
TEST_utf8_mÆf‹med_£quí˚s
)

468 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 ovîl⁄gÉncodög", 
TEST_utf8_ovîl⁄g_ícodög
)

469 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 iŒegÆ codêposôi⁄s", 
TEST_utf8_ûÀgÆ_code_posôi⁄s
)

470 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 c⁄åﬁ ch¨a˘îs", 
TEST_utf8_c⁄åﬁ_ch¨a˘îs
)

471 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 MQTT-1.5.4-2", 
TEST_utf8_mqâ_1_5_4_2
)

472 || !
	`CU_add_ã°
(
ã°_suôe
, "UTF-8 MQTT-1.5.4-3", 
TEST_utf8_mqâ_1_5_4_3
)

475 
	`¥ötf
("Errorádding UTF-8 CUnitÅests.\n");

480 
	}
}

	@test/unit/util_topic_test.c

1 
	~<CUnô/CUnô.h
>

2 
	~<CUnô/Basic.h
>

4 
	~<utû_mosq.h
>

6 
	$m©ch_hñ≥r
(c⁄° *
sub
, c⁄° *
t›ic
)

8 
rc
;

9 
boﬁ
 
m©ch
;

11 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
sub
, 
t›ic
, &
m©ch
);

12 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_SUCCESS
);

13 
	`CU_ASSERT_EQUAL
(
m©ch
, 
åue
);

14 
	}
}

16 
	$no_m©ch_hñ≥r
(
rc_ex≥˘ed
, c⁄° *
sub
, c⁄° *
t›ic
)

18 
rc
;

19 
boﬁ
 
m©ch
;

21 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
sub
, 
t›ic
, &
m©ch
);

22 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

23 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

24 
	}
}

30 
	$TEST_em±y_öput
()

32 
rc
;

33 
boﬁ
 
m©ch
;

35 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
("sub", 
NULL
, &
m©ch
);

36 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

37 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

39 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
NULL
, "t›ic", &
m©ch
);

40 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

41 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

43 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
NULL
, NULL, &
m©ch
);

44 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

45 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

47 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
("sub", "", &
m©ch
);

48 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

49 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

51 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
("", "t›ic", &
m©ch
);

52 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

53 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

55 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
("", "", &
m©ch
);

56 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

57 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

59 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
("sub", 3, 
NULL
, 0, &
m©ch
);

60 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

61 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

63 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
(
NULL
, 0, "t›ic", 5, &
m©ch
);

64 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

65 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

67 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
(
NULL
, 0, NULL, 0, &
m©ch
);

68 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

69 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

71 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
("sub", 3, "", 0, &
m©ch
);

72 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

73 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

75 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
("", 0, "t›ic", 5, &
m©ch
);

76 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

77 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

79 
rc
 = 
	`mosquôto_t›ic_m©ches_sub2
("", 0, "", 0, &
m©ch
);

80 
	`CU_ASSERT_EQUAL
(
rc
, 
MOSQ_ERR_INVAL
);

81 
	`CU_ASSERT_EQUAL
(
m©ch
, 
Ál£
);

82 
	}
}

88 
	$TEST_vÆid_m©chög
()

90 
	`m©ch_hñ≥r
("foo/#", "foo/");

91 
	`m©ch_hñ≥r
("foo/#", "foo");

92 
	`m©ch_hñ≥r
("foo//bar", "foo//bar");

93 
	`m©ch_hñ≥r
("foo//+", "foo//bar");

94 
	`m©ch_hñ≥r
("foo/+/+/baz", "foo///baz");

95 
	`m©ch_hñ≥r
("foo/bar/+", "foo/bar/");

96 
	`m©ch_hñ≥r
("foo/bar", "foo/bar");

97 
	`m©ch_hñ≥r
("foo/+", "foo/bar");

98 
	`m©ch_hñ≥r
("foo/+/baz", "foo/bar/baz");

99 
	`m©ch_hñ≥r
("A/B/+/#", "A/B/B/C");

100 
	`m©ch_hñ≥r
("foo/+/#", "foo/bar/baz");

101 
	`m©ch_hñ≥r
("foo/+/#", "foo/bar");

102 
	`m©ch_hñ≥r
("#", "foo/bar/baz");

103 
	`m©ch_hñ≥r
("#", "foo/bar/baz");

104 
	`m©ch_hñ≥r
("#", "/foo/bar");

105 
	`m©ch_hñ≥r
("/#", "/foo/bar");

106 
	}
}

109 
	$TEST_övÆid_but_m©chög
()

113 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "+foo", "+foo");

114 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "fo+o", "fo+o");

115 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+", "foo+");

116 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "+foo/bar", "+foo/bar");

117 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+/bar", "foo+/bar");

118 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/+bar", "foo/+bar");

119 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/bar+", "foo/bar+");

121 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "+foo", "afoo");

122 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "fo+o", "foao");

123 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+", "fooa");

124 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "+foo/bar", "afoo/bar");

125 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+/bar", "fooa/bar");

126 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/+bar", "foo/abar");

127 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/bar+", "foo/bara");

129 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "#foo", "#foo");

130 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "fo#o", "fo#o");

131 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo#", "foo#");

132 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "#foo/bar", "#foo/bar");

133 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo#/bar", "foo#/bar");

134 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/#bar", "foo/#bar");

135 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/bar#", "foo/bar#");

137 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+", "fooa");

138 
	}
}

141 
	$TEST_vÆid_no_m©chög
()

143 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "test/6/#", "test/3");

145 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "foo/bar", "foo");

146 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "foo/+", "foo/bar/baz");

147 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "foo/+/baz", "foo/bar/bar");

149 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "foo/+/#", "fo2/bar/baz");

151 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "/#", "foo/bar");

153 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "#", "$SYS/bar");

154 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_SUCCESS
, "$BOB/bar", "$SYS/bar");

155 
	}
}

158 
	$TEST_övÆid
()

160 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo#", "foo");

161 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "fo#o/", "foo");

162 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo#", "fooa");

163 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo+", "foo");

164 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/#a", "foo");

165 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "#a", "foo");

166 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "foo/#abc", "foo");

167 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "#abc", "foo");

168 
	`no_m©ch_hñ≥r
(
MOSQ_ERR_INVAL
, "/#a", "foo/bar");

169 
	}
}

175 
	$pub_t›ic_hñ≥r
(c⁄° *
t›ic
, 
rc_ex≥˘ed
)

177 
rc
;

179 
rc
 = 
	`mosquôto_pub_t›ic_check
(
t›ic
);

180 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

182 
rc
 = 
	`mosquôto_pub_t›ic_check2
(
t›ic
, 
	`°æí
(topic));

183 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

184 
	}
}

186 
	$TEST_pub_t›ic_vÆid
()

188 
	`pub_t›ic_hñ≥r
("pub/t›ic", 
MOSQ_ERR_SUCCESS
);

189 
	`pub_t›ic_hñ≥r
("pub//t›ic", 
MOSQ_ERR_SUCCESS
);

190 
	`pub_t›ic_hñ≥r
("pub/ /t›ic", 
MOSQ_ERR_SUCCESS
);

191 
	}
}

193 
	$TEST_pub_t›ic_övÆid
()

195 
	`pub_t›ic_hñ≥r
("+pub/t›ic", 
MOSQ_ERR_INVAL
);

196 
	`pub_t›ic_hñ≥r
("pub+/t›ic", 
MOSQ_ERR_INVAL
);

197 
	`pub_t›ic_hñ≥r
("pub/+t›ic", 
MOSQ_ERR_INVAL
);

198 
	`pub_t›ic_hñ≥r
("pub/t›ic+", 
MOSQ_ERR_INVAL
);

199 
	`pub_t›ic_hñ≥r
("pub/t›ic/+", 
MOSQ_ERR_INVAL
);

200 
	`pub_t›ic_hñ≥r
("#pub/t›ic", 
MOSQ_ERR_INVAL
);

201 
	`pub_t›ic_hñ≥r
("pub#/t›ic", 
MOSQ_ERR_INVAL
);

202 
	`pub_t›ic_hñ≥r
("pub/#t›ic", 
MOSQ_ERR_INVAL
);

203 
	`pub_t›ic_hñ≥r
("pub/t›ic#", 
MOSQ_ERR_INVAL
);

204 
	`pub_t›ic_hñ≥r
("pub/t›ic/#", 
MOSQ_ERR_INVAL
);

205 
	`pub_t›ic_hñ≥r
("+/pub/t›ic", 
MOSQ_ERR_INVAL
);

206 
	}
}

213 
	$sub_t›ic_hñ≥r
(c⁄° *
t›ic
, 
rc_ex≥˘ed
)

215 
rc
;

217 
rc
 = 
	`mosquôto_sub_t›ic_check
(
t›ic
);

218 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

220 
rc
 = 
	`mosquôto_sub_t›ic_check2
(
t›ic
, 
	`°æí
(topic));

221 
	`CU_ASSERT_EQUAL
(
rc
, 
rc_ex≥˘ed
);

222 
	}
}

224 
	$TEST_sub_t›ic_vÆid
()

226 
	`sub_t›ic_hñ≥r
("sub/t›ic", 
MOSQ_ERR_SUCCESS
);

227 
	`sub_t›ic_hñ≥r
("sub//t›ic", 
MOSQ_ERR_SUCCESS
);

228 
	`sub_t›ic_hñ≥r
("sub/ /t›ic", 
MOSQ_ERR_SUCCESS
);

229 
	`sub_t›ic_hñ≥r
("sub/+/t›ic", 
MOSQ_ERR_SUCCESS
);

230 
	`sub_t›ic_hñ≥r
("+/+/+", 
MOSQ_ERR_SUCCESS
);

231 
	`sub_t›ic_hñ≥r
("+", 
MOSQ_ERR_SUCCESS
);

232 
	`sub_t›ic_hñ≥r
("sub/t›ic/#", 
MOSQ_ERR_SUCCESS
);

233 
	`sub_t›ic_hñ≥r
("sub//t›ic/#", 
MOSQ_ERR_SUCCESS
);

234 
	`sub_t›ic_hñ≥r
("sub/ /t›ic/#", 
MOSQ_ERR_SUCCESS
);

235 
	`sub_t›ic_hñ≥r
("sub/+/t›ic/#", 
MOSQ_ERR_SUCCESS
);

236 
	`sub_t›ic_hñ≥r
("+/+/+/#", 
MOSQ_ERR_SUCCESS
);

237 
	`sub_t›ic_hñ≥r
("#", 
MOSQ_ERR_SUCCESS
);

238 
	}
}

240 
	$TEST_sub_t›ic_övÆid
()

242 
	`sub_t›ic_hñ≥r
("+sub/t›ic", 
MOSQ_ERR_INVAL
);

243 
	`sub_t›ic_hñ≥r
("sub+/t›ic", 
MOSQ_ERR_INVAL
);

244 
	`sub_t›ic_hñ≥r
("sub/+t›ic", 
MOSQ_ERR_INVAL
);

245 
	`sub_t›ic_hñ≥r
("sub/t›ic+", 
MOSQ_ERR_INVAL
);

246 
	`sub_t›ic_hñ≥r
("#sub/t›ic", 
MOSQ_ERR_INVAL
);

247 
	`sub_t›ic_hñ≥r
("sub#/t›ic", 
MOSQ_ERR_INVAL
);

248 
	`sub_t›ic_hñ≥r
("sub/#t›ic", 
MOSQ_ERR_INVAL
);

249 
	`sub_t›ic_hñ≥r
("sub/t›ic#", 
MOSQ_ERR_INVAL
);

250 
	`sub_t›ic_hñ≥r
("#/sub/t›ic", 
MOSQ_ERR_INVAL
);

251 
	}
}

257 
	$öô_utû_t›ic_ã°s
()

259 
CU_pSuôe
 
ã°_suôe
 = 
NULL
;

261 
ã°_suôe
 = 
	`CU_add_suôe
("UtûÅ›ic", 
NULL
, NULL);

262 if(!
ã°_suôe
){

263 
	`¥ötf
("Errorádding CUnit utilÅopicÅest suite.\n");

268 || !
	`CU_add_ã°
(
ã°_suôe
, "M©chög: Em±y i≈ut", 
TEST_em±y_öput
)

269 || !
	`CU_add_ã°
(
ã°_suôe
, "M©chög: VÆid m©chög", 
TEST_vÆid_m©chög
)

270 || !
	`CU_add_ã°
(
ã°_suôe
, "M©chög: VÆidÇÿm©chög", 
TEST_vÆid_no_m©chög
)

271 || !
	`CU_add_ã°
(
ã°_suôe
, "M©chög: InvÆid buàm©chög", 
TEST_övÆid_but_m©chög
)

272 || !
	`CU_add_ã°
(
ã°_suôe
, "M©chög: InvÆid", 
TEST_övÆid
)

273 || !
	`CU_add_ã°
(
ã°_suôe
, "PubÅ›ic: VÆid", 
TEST_pub_t›ic_vÆid
)

274 || !
	`CU_add_ã°
(
ã°_suôe
, "PubÅ›ic: InvÆid", 
TEST_pub_t›ic_övÆid
)

275 || !
	`CU_add_ã°
(
ã°_suôe
, "SubÅ›ic: VÆid", 
TEST_sub_t›ic_vÆid
)

276 || !
	`CU_add_ã°
(
ã°_suôe
, "SubÅ›ic: InvÆid", 
TEST_sub_t›ic_övÆid
)

279 
	`¥ötf
("Errorádding utilÅopic CUnitÅests.\n");

284 
	}
}

	@
1
.
0
228
6019
client/client_props.c
client/client_shared.c
client/client_shared.h
client/pub_client.c
client/pub_shared.c
client/pub_shared.h
client/rr_client.c
client/sub_client.c
client/sub_client_output.c
config.h
examples/mysql_log/mysql_log.c
examples/subscribe_simple/callback.c
examples/subscribe_simple/multiple.c
examples/subscribe_simple/single.c
examples/temperature_conversion/main.cpp
examples/temperature_conversion/temperature_conversion.cpp
examples/temperature_conversion/temperature_conversion.h
lib/actions.c
lib/alias_mosq.c
lib/alias_mosq.h
lib/callbacks.c
lib/connect.c
lib/cpp/mosquittopp.cpp
lib/cpp/mosquittopp.h
lib/dummypthread.h
lib/handle_auth.c
lib/handle_connack.c
lib/handle_disconnect.c
lib/handle_ping.c
lib/handle_pubackcomp.c
lib/handle_publish.c
lib/handle_pubrec.c
lib/handle_pubrel.c
lib/handle_suback.c
lib/handle_unsuback.c
lib/helpers.c
lib/logging_mosq.c
lib/logging_mosq.h
lib/loop.c
lib/memory_mosq.c
lib/memory_mosq.h
lib/messages_mosq.c
lib/messages_mosq.h
lib/mosquitto.c
lib/mosquitto.h
lib/mosquitto_internal.h
lib/mqtt_protocol.h
lib/net_mosq.c
lib/net_mosq.h
lib/net_mosq_ocsp.c
lib/options.c
lib/packet_datatypes.c
lib/packet_mosq.c
lib/packet_mosq.h
lib/property_mosq.c
lib/property_mosq.h
lib/read_handle.c
lib/read_handle.h
lib/send_connect.c
lib/send_disconnect.c
lib/send_mosq.c
lib/send_mosq.h
lib/send_publish.c
lib/send_subscribe.c
lib/send_unsubscribe.c
lib/socks_mosq.c
lib/socks_mosq.h
lib/srv_mosq.c
lib/thread_mosq.c
lib/time_mosq.c
lib/time_mosq.h
lib/tls_mosq.c
lib/tls_mosq.h
lib/utf8_mosq.c
lib/util_mosq.c
lib/util_mosq.h
lib/util_topic.c
lib/will_mosq.c
lib/will_mosq.h
src/bridge.c
src/conf.c
src/conf_includedir.c
src/context.c
src/database.c
src/db_dump/db_dump.c
src/deps/uthash.h
src/deps/utlist.h
src/handle_auth.c
src/handle_connack.c
src/handle_connect.c
src/handle_disconnect.c
src/handle_publish.c
src/handle_subscribe.c
src/handle_unsubscribe.c
src/lib_load.h
src/logging.c
src/loop.c
src/mosquitto.c
src/mosquitto_broker.h
src/mosquitto_broker_internal.h
src/mosquitto_passwd.c
src/mosquitto_plugin.h
src/net.c
src/persist.h
src/persist_read.c
src/persist_read_v234.c
src/persist_read_v5.c
src/persist_write.c
src/persist_write_v5.c
src/plugin.c
src/plugin_defer.c
src/property_broker.c
src/read_handle.c
src/security.c
src/security_default.c
src/send_auth.c
src/send_connack.c
src/send_suback.c
src/send_unsuback.c
src/service.c
src/session_expiry.c
src/signals.c
src/subs.c
src/sys_tree.c
src/sys_tree.h
src/uhpa.h
src/websockets.c
src/will_delay.c
test/broker/c/08-tls-psk-bridge.c
test/broker/c/08-tls-psk-pub.c
test/broker/c/auth_plugin.c
test/broker/c/auth_plugin_acl.c
test/broker/c/auth_plugin_acl_sub_denied.c
test/broker/c/auth_plugin_context_params.c
test/broker/c/auth_plugin_extended_multiple.c
test/broker/c/auth_plugin_extended_single.c
test/broker/c/auth_plugin_extended_single2.c
test/broker/c/auth_plugin_msg_params.c
test/broker/c/auth_plugin_pwd.c
test/broker/c/auth_plugin_v2.c
test/broker/c/mosquitto_plugin_v2.h
test/lib/c/01-con-discon-success.c
test/lib/c/01-keepalive-pingreq.c
test/lib/c/01-no-clean-session.c
test/lib/c/01-server-keepalive-pingreq.c
test/lib/c/01-unpwd-set.c
test/lib/c/01-will-set.c
test/lib/c/01-will-unpwd-set.c
test/lib/c/02-subscribe-qos0.c
test/lib/c/02-subscribe-qos1-async1.c
test/lib/c/02-subscribe-qos1-async2.c
test/lib/c/02-subscribe-qos1.c
test/lib/c/02-subscribe-qos2.c
test/lib/c/02-unsubscribe-multiple-v5.c
test/lib/c/02-unsubscribe-v5.c
test/lib/c/02-unsubscribe.c
test/lib/c/03-publish-b2c-qos1.c
test/lib/c/03-publish-b2c-qos2-len.c
test/lib/c/03-publish-b2c-qos2.c
test/lib/c/03-publish-c2b-qos1-disconnect.c
test/lib/c/03-publish-c2b-qos1-len.c
test/lib/c/03-publish-c2b-qos1-receive-maximum.c
test/lib/c/03-publish-c2b-qos2-disconnect.c
test/lib/c/03-publish-c2b-qos2-len.c
test/lib/c/03-publish-c2b-qos2-maximum-qos-0.c
test/lib/c/03-publish-c2b-qos2-maximum-qos-1.c
test/lib/c/03-publish-c2b-qos2-pubrec-error.c
test/lib/c/03-publish-c2b-qos2-receive-maximum-1.c
test/lib/c/03-publish-c2b-qos2-receive-maximum-2.c
test/lib/c/03-publish-c2b-qos2.c
test/lib/c/03-publish-qos0-no-payload.c
test/lib/c/03-publish-qos0.c
test/lib/c/03-request-response-1.c
test/lib/c/03-request-response-2.c
test/lib/c/03-request-response-correlation-1.c
test/lib/c/04-retain-qos0.c
test/lib/c/08-ssl-bad-cacert.c
test/lib/c/08-ssl-connect-cert-auth-enc.c
test/lib/c/08-ssl-connect-cert-auth.c
test/lib/c/08-ssl-connect-no-auth.c
test/lib/c/08-ssl-fake-cacert.c
test/lib/c/09-util-topic-tokenise.c
test/lib/c/11-prop-oversize-packet.c
test/lib/c/11-prop-send-content-type.c
test/lib/c/11-prop-send-payload-format.c
test/lib/cpp/01-con-discon-success.cpp
test/lib/cpp/01-keepalive-pingreq.cpp
test/lib/cpp/01-no-clean-session.cpp
test/lib/cpp/01-unpwd-set.cpp
test/lib/cpp/01-will-set.cpp
test/lib/cpp/01-will-unpwd-set.cpp
test/lib/cpp/02-subscribe-qos0.cpp
test/lib/cpp/02-subscribe-qos1.cpp
test/lib/cpp/02-subscribe-qos2.cpp
test/lib/cpp/02-unsubscribe.cpp
test/lib/cpp/03-publish-b2c-qos1.cpp
test/lib/cpp/03-publish-b2c-qos2.cpp
test/lib/cpp/03-publish-c2b-qos1-disconnect.cpp
test/lib/cpp/03-publish-c2b-qos2-disconnect.cpp
test/lib/cpp/03-publish-c2b-qos2.cpp
test/lib/cpp/03-publish-qos0-no-payload.cpp
test/lib/cpp/03-publish-qos0.cpp
test/lib/cpp/04-retain-qos0.cpp
test/lib/cpp/08-ssl-bad-cacert.cpp
test/lib/cpp/08-ssl-connect-cert-auth-enc.cpp
test/lib/cpp/08-ssl-connect-cert-auth.cpp
test/lib/cpp/08-ssl-connect-no-auth.cpp
test/lib/cpp/08-ssl-fake-cacert.cpp
test/lib/cpp/09-util-topic-tokenise.cpp
test/old/msgsps_common.h
test/old/msgsps_pub.c
test/old/msgsps_sub.c
test/random/auth_plugin.c
test/unit/datatype_read.c
test/unit/datatype_write.c
test/unit/persist_read_stubs.c
test/unit/persist_read_test.c
test/unit/persist_write_stubs.c
test/unit/persist_write_test.c
test/unit/property_add.c
test/unit/property_read.c
test/unit/property_user_read.c
test/unit/property_write.c
test/unit/publish_test.c
test/unit/stubs.c
test/unit/test.c
test/unit/utf8.c
test/unit/util_topic_test.c
